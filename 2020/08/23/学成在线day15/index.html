<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>学成在线day15：媒资管理系统集成 - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>私人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-23 10:53">
      2020-08-23
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      8.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      111
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="😎知识点概览"><a href="#😎知识点概览" class="headerlink" title="😎知识点概览"></a>😎知识点概览</h1><blockquote>
<p>为了方便后续回顾该项目时能够清晰的知道本章节讲了哪些内容，并且能够从该章节的笔记中得到一些帮助，所以在完成本章节的学习后在此对本章节所涉及到的知识点进行总结概述。</p>
</blockquote>
<p>本章节为【学成在线】项目的 <code>day15</code> 的内容</p>
<ul>
<li>根据 <code>课程ID</code> 搜索该课程已发布的课程信息，并返回该课程的所有课程计划信息。</li>
<li>将指定课程 <code>发布时</code> 所的课程计划的媒资信息保存到 <code>teachplan_media_publish</code> 表中，</li>
<li>根据 <code>课程计划id</code> 搜索该课程计划所对应的媒资信息，需要用到的是该课程计划对应的 <code>m3u8</code> 地址，用于在线播放视频，该接口在课程管理服务中开发，供学习服务进行远程调用。</li>
<li>在学习服务中远程调用 课程计划媒资信息查询接口，获取该课程计划的视频播放的 <code>m3u8</code> url地址，并返回给前端，前端使用该 <code>url</code> 进行视频的在线播放。</li>
<li>在线学习完整的测试流程：媒资信息的上传、选择、发布到前端门户、搜索门户测试，在线学习的播放视频。</li>
</ul>
<h1 id="一、学习页面：查询课程计划"><a href="#一、学习页面：查询课程计划" class="headerlink" title="一、学习页面：查询课程计划"></a>一、学习页面：查询课程计划</h1><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>到目前为止，我们已可以编辑课程计划信息并上传课程视频，下一步我们要实现在线学习页面动态读取章节对应的视频并进行播放。在线学习页面所需要的信息有两类：</p>
<ul>
<li>课程计划信息</li>
<li>课程学习信息（视频地址、学习进度等）</li>
</ul>
<p>如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image1" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image1.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>在线学习集成媒资管理的需求如下：</p>
<p>1、在线学习页面显示课程计划</p>
<p>2、点击课程计划播放该课程计划对应的视频</p>
<p>本章节实现学习页面动态显示课程计划，进入不同课程的学习页面右侧动态显示当前课程的课程计划。</p>
<h2 id="2-Api接口"><a href="#2-Api接口" class="headerlink" title="2. Api接口"></a>2. Api接口</h2><p>课程计划信息从哪里获取？</p>
<p>在课程发布完成后会自动发布到一个 <code>course_pub</code> 的表中，<code>logstash</code> 会自动将课程发布后的信息自动采集到 <code>ES</code> 索引库中，这些信息也包含课程计划信息。</p>
<p>所以考虑性能要求，课程发布后对课程的查询统一从 <code>ES</code> 索引库中查询。</p>
<p>前端通过请求 <code>搜索服务</code> 获取课程信息，需要单独在 <code>搜索服务</code> 中定义课程信息查询接口。<br>本接口接收课程id，查询课程所有信息返回给前端。</p>
<p>我们在搜素服务 <code>API</code> 下添加以下方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"根据id搜索课程发布信息"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String,CoursePub&gt; <span class="hljs-title">getdetail</span><span class="hljs-params">(String id)</span></span>;</code></pre></div>

<p>返回的课程信息为 <code>json</code> 结构：<code>key</code> 为课程id，<code>value</code> 为课程内容。</p>
<h2 id="3-服务端开发"><a href="#3-服务端开发" class="headerlink" title="3. 服务端开发"></a>3. 服务端开发</h2><p>在搜索服务中开发查询课程信息接口。</p>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>在搜素服务下添加以下方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据id搜索课程发布信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 课程id</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JSON数据</span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/getdetail/&#123;id&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, CoursePub&gt; <span class="hljs-title">getdetail</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span>String id) </span>&#123;
    <span class="hljs-keyword">return</span> esCourseService.getdetail(id);
&#125;</code></pre></div>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据id搜索课程发布信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id 课程id</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> JSON数据</span>
<span class="hljs-comment">     */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String, CoursePub&gt; <span class="hljs-title">getdetail</span><span class="hljs-params">(String id)</span> </span>&#123;
    <span class="hljs-comment">//设置索引</span>
    SearchRequest searchRequest = <span class="hljs-keyword">new</span> SearchRequest(es_index);
    <span class="hljs-comment">//设置类型</span>
    searchRequest.types(es_type);
    <span class="hljs-comment">//创建搜索源对象</span>
    SearchSourceBuilder searchSourceBuilder = <span class="hljs-keyword">new</span> SearchSourceBuilder();

    <span class="hljs-comment">//设置查询条件,根据id进行查询</span>
    searchSourceBuilder.query(QueryBuilders.termQuery(<span class="hljs-string">"id"</span>,id));
    <span class="hljs-comment">//这里不使用source的原字段过滤,查询所有字段</span>
    <span class="hljs-comment">// searchSourceBuilder.fetchSource(new String[]&#123;"name", "grade", "charge","pic"&#125;, newString[]&#123;&#125;);</span>

    <span class="hljs-comment">//设置搜索源对象</span>
    searchRequest.source(searchSourceBuilder);

    <span class="hljs-comment">//执行搜索</span>
    SearchResponse searchResponse = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">try</span> &#123;
        searchResponse = restHighLevelClient.search(searchRequest);
    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
        e.printStackTrace();
    &#125;
    <span class="hljs-comment">//获取搜索结果</span>
    SearchHits hits = searchResponse.getHits();
    SearchHit[] searchHits = hits.getHits(); <span class="hljs-comment">//获取最优结果</span>
    Map&lt;String,CoursePub&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    <span class="hljs-keyword">for</span> (SearchHit hit: searchHits) &#123;
        <span class="hljs-comment">//从搜索结果中取值并添加到coursePub对象</span>
        Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();
        String courseId = (String) sourceAsMap.get(<span class="hljs-string">"id"</span>);
        String name = (String) sourceAsMap.get(<span class="hljs-string">"name"</span>);
        String grade = (String) sourceAsMap.get(<span class="hljs-string">"grade"</span>);
        String charge = (String) sourceAsMap.get(<span class="hljs-string">"charge"</span>);
        String pic = (String) sourceAsMap.get(<span class="hljs-string">"pic"</span>);
        String description = (String) sourceAsMap.get(<span class="hljs-string">"description"</span>);
        String teachplan = (String) sourceAsMap.get(<span class="hljs-string">"teachplan"</span>);
        CoursePub coursePub = <span class="hljs-keyword">new</span> CoursePub();
        coursePub.setId(courseId);
        coursePub.setName(name);
        coursePub.setPic(pic);
        coursePub.setGrade(grade);
        coursePub.setTeachplan(teachplan);
        coursePub.setDescription(description);
        <span class="hljs-comment">//设置map对象</span>
        map.put(courseId,coursePub);
    &#125;
    <span class="hljs-keyword">return</span> map;
&#125;</code></pre></div>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>使用 <code>swagger-ui</code> 或 <code>postman</code> 测试查询课程信息接口。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image2" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image2.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="4-前端开发"><a href="#4-前端开发" class="headerlink" title="4. 前端开发"></a>4. 前端开发</h2><h3 id="配置NGINX虚拟主机"><a href="#配置NGINX虚拟主机" class="headerlink" title="配置NGINX虚拟主机"></a>配置NGINX虚拟主机</h3><p>学习中心的二级域名为 <code>ucenter.xuecheng.com</code> ，我们在 <code>nginx</code> 中配置 <code>ucenter</code> 虚拟主机。</p>
<div class="hljs"><pre><code class="hljs c">#学成网用户中心
server &#123;
    <span class="hljs-built_in">listen</span> <span class="hljs-number">80</span>;
    server_name ucenter.xuecheng.com;
    #个人中心
    location / &#123;
        proxy_pass http:<span class="hljs-comment">//ucenter_server_pool;</span>
    &#125;
&#125; 
#前端ucenter
upstream ucenter_server_pool&#123;
    <span class="hljs-meta">#server 127.0.0.1:7081 weight=10;</span>
    server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">13000</span> weight=<span class="hljs-number">10</span>;
&#125;</code></pre></div>

<p>在学习中心要调用搜索的 <code>API</code>，使用 <code>Nginx</code> 解决代理，如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image3" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image3.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>在 <code>ucenter</code> 虚拟主机下配置搜索 <code>Api</code> 代理路径</p>
<div class="hljs"><pre><code class="hljs java">#后台搜索（公开api）
upstream search_server_pool&#123;
    server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">40100</span> weight=<span class="hljs-number">10</span>;
&#125; 
#学成网用户中心
server &#123;
    listen <span class="hljs-number">80</span>;
    server_name ucenter.xuecheng.com;
    #个人中心
        location / &#123;
        proxy_pass http:<span class="hljs-comment">//ucenter_server_pool;</span>
    &#125;
    #后端搜索服务
        location /openapi/search/ &#123;
        proxy_pass http:<span class="hljs-comment">//search_server_pool/search/;</span>
    &#125;
&#125;</code></pre></div>

<h3 id="前端-API-方法"><a href="#前端-API-方法" class="headerlink" title="前端 API 方法"></a>前端 API 方法</h3><p>在学习中心 <code>xc-ui-pc-leanring</code> 对课程信息的查询属于基础常用功能，所以我们将课程查询的 <code>api</code> 方法定义在<code>base</code> 模块下，如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image4" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image4.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>在<code>system.js</code> 中定义课程查询方法：</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'./public'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> course_view = <span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> &#123;
	<span class="hljs-keyword">return</span> http.requestGet(<span class="hljs-string">'/openapi/search/course/getdetail/'</span>+id);
&#125;</code></pre></div>

<h3 id="前端-API-方法调用"><a href="#前端-API-方法调用" class="headerlink" title="前端 API 方法调用"></a>前端 API 方法调用</h3><p>在 <code>learning_video.vue</code> 页面中调用课程信息查询接口得到课程计划，将课程计划<code>json</code> 串转成对象。</p>
<blockquote>
<p>xc-ui-pc-leanring/src/module/course/page/learning_video.vue</p>
</blockquote>
<p>1、定义视图</p>
<p>课程计划</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--课程计划部分代码--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navCont"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"course-weeklist"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav nav-stacked"</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(teachplan_first, index) in teachplanList"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tit nav-justified text-center"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pull-left glyphicon glyphicon-th-list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>&#123;&#123;teachplan_first.pname&#125;&#125;<span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pull-right"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>   <span class="hljs-attr">v-if</span>=<span class="hljs-string">"teachplan_first.children!=null"</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(teachplan_second, index) in teachplan_first.children"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"glyphicon glyphicon-check"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"url"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"study(teachplan_second.id)"</span>&gt;</span>
                    &#123;&#123;teachplan_second.pname&#125;&#125;
                <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>

            <span class="hljs-comment">&lt;!-- &lt;div class="tit nav-justified text-center"&gt;&lt;i class="pull-left glyphicon glyphicon-th-list"&gt;&lt;/i&gt;第一章&lt;i class="pull-right"&gt;&lt;/i&gt;&lt;/div&gt;</span>
<span class="hljs-comment">&lt;li  &gt;&lt;i class="glyphicon glyphicon-check"&gt;&lt;/i&gt;</span>
<span class="hljs-comment">&lt;a :href="url" &gt;</span>
<span class="hljs-comment">第一节</span>
<span class="hljs-comment">&lt;/a&gt;</span>
<span class="hljs-comment">&lt;/li&gt;--&gt;</span>
            <span class="hljs-comment">&lt;!--&lt;li&gt;&lt;i class="glyphicon glyphicon-unchecked"&gt;&lt;/i&gt;为什么分为A、B、C部分&lt;/li&gt;--&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre></div>

<p>课程名称</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"top text-center"</span>&gt;</span>
&#123;&#123;coursename&#125;&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre></div>

<p>定义数据对象</p>
<div class="hljs"><pre><code class="hljs js">data() &#123;
    <span class="hljs-keyword">return</span> &#123;
        url:<span class="hljs-string">''</span>,<span class="hljs-comment">//当前url</span>
        courseId:<span class="hljs-string">''</span>,<span class="hljs-comment">//课程id</span>
        chapter:<span class="hljs-string">''</span>,<span class="hljs-comment">//章节Id</span>
        coursename:<span class="hljs-string">''</span>,<span class="hljs-comment">//课程名称</span>
        coursepic:<span class="hljs-string">''</span>,<span class="hljs-comment">//课程图片</span>
        teachplanList:[],<span class="hljs-comment">//课程计划</span>
        playerOptions: &#123;<span class="hljs-comment">//播放参数</span>
            autoplay: <span class="hljs-literal">false</span>,
            controls: <span class="hljs-literal">true</span>,
            sources: [&#123;
                type: <span class="hljs-string">"application/x-mpegURL"</span>,
                src: <span class="hljs-string">''</span>
            &#125;]
        &#125;,
    &#125;
&#125;</code></pre></div>

<p>在 <code>created</code> 钩子方法中获取课程信息</p>
<div class="hljs"><pre><code class="hljs js">created()&#123;
    <span class="hljs-comment">//当前请求的url</span>
    <span class="hljs-keyword">this</span>.url = <span class="hljs-built_in">window</span>.location
    <span class="hljs-comment">//课程id</span>
    <span class="hljs-keyword">this</span>.courseId = <span class="hljs-keyword">this</span>.$route.params.courseId
    <span class="hljs-comment">//章节id</span>
    <span class="hljs-keyword">this</span>.chapter = <span class="hljs-keyword">this</span>.$route.params.chapter
    <span class="hljs-comment">//查询课程信息</span>
    systemApi.course_view(<span class="hljs-keyword">this</span>.courseId).then(<span class="hljs-function">(<span class="hljs-params">view_course</span>)=&gt;</span>&#123;
        <span class="hljs-keyword">if</span>(!view_course || !view_course[<span class="hljs-keyword">this</span>.courseId])&#123;
            <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"获取课程信息失败，请重新进入此页面！"</span>)
            <span class="hljs-keyword">return</span> ;
        &#125; 
        <span class="hljs-keyword">let</span> courseInfo = view_course[<span class="hljs-keyword">this</span>.courseId]
        <span class="hljs-built_in">console</span>.log(courseInfo)
        <span class="hljs-keyword">this</span>.coursename = courseInfo.name
        <span class="hljs-keyword">if</span>(courseInfo.teachplan)&#123;
            <span class="hljs-keyword">let</span> teachplan = <span class="hljs-built_in">JSON</span>.parse(courseInfo.teachplan);
            <span class="hljs-keyword">this</span>.teachplanList = teachplan.children;
        &#125;
    &#125;)
&#125;,</code></pre></div>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>在浏览器请求：<a href="http://ucenter.xuecheng.com/#/learning/4028e581617f945f01617f9dabc40000/0" target="_blank" rel="noopener">http://ucenter.xuecheng.com/#/learning/4028e581617f945f01617f9dabc40000/0</a></p>
<ul>
<li><code>4028e581617f945f01617f9dabc40000</code>：第一个参数为课程 <code>id</code>，测试时从 <code>ES</code>索引库找一个课程 <code>id</code></li>
<li>0：第二个参数为课程计划 <code>id</code>，此参数用于点击课程计划播放视频。</li>
</ul>
<p><a href="https://qnoss.codeyee.com/20200704_15/image5" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image5.png" srcset="/img/loading.gif" alt="img"></a></p>
<blockquote>
<p>如果出现跨域问题，但是确定已经配置了跨域，请尝试结束所以 nginx.exe 的进程 和 清空浏览器缓存。</p>
<p>如果还没有解决？重启电脑试试。</p>
</blockquote>
<h1 id="二、学习页面：获取视频播放地址"><a href="#二、学习页面：获取视频播放地址" class="headerlink" title="二、学习页面：获取视频播放地址"></a>二、学习页面：获取视频播放地址</h1><h2 id="1-需求分析-1"><a href="#1-需求分析-1" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>用户进入在线学习页面，点击课程计划将播放该课程计划对应的教学视频。</p>
<p>业务流程如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image6" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image6.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>业务流程说明：</p>
<p>1、用户进入在线学习页面，页面请求搜索服务获取课程信息（包括课程计划信息）并且在页面展示。</p>
<p>2、在线学习请求学习服务获取视频播放地址。</p>
<p>3、学习服务校验当前用户是否有权限学习，如果没有权限学习则提示用户。</p>
<p>4、学习服务校验通过，请求搜索服务获取课程媒资信息。</p>
<p>5、搜索服务请求ElasticSearch获取课程媒资信息。</p>
<p>为什么要请求 <code>ElasticSearch</code> 查询课程媒资信息？</p>
<p>出于性能的考虑，公开查询课程信息从搜索服务查询，分摊 <code>mysql</code> 数据库的访问压力。</p>
<p>什么时候将课程媒资信息存储到 <code>ElasticSearch</code> 中？</p>
<p>课程媒资信息是在课程发布的时候存入 <code>ElasticSearch</code>，因为课程发布后课程信息将基本不再修改。</p>
<h2 id="2-课程发布：储存媒资信息"><a href="#2-课程发布：储存媒资信息" class="headerlink" title="2. 课程发布：储存媒资信息"></a>2. 课程发布：储存媒资信息</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>课程媒资信息是在课程发布的时候存入 <code>ElasticSearch</code> 索引库，因为课程发布后课程信息将基本不再修改，具体的业务流程如下。</p>
<p><strong>1、课程发布，向课程媒资信息表写入数据。</strong></p>
<p>1）根据课程 <code>id</code> 删除 <code>teachplanMediaPub</code> 中的数据</p>
<p>2）根据课程 <code>id</code> 查询 <code>teachplanMedia</code> 数据</p>
<p>3）将查询到的 <code>teachplanMedia</code> 数据插入到 <code>teachplanMediaPub</code> 中</p>
<p><strong>2、Logstash 定时扫描课程媒资信息表，并将课程媒资信息写入索引库。</strong></p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>在 <code>xc_course</code> 数据库创建课程计划媒资发布表：</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-string">`teachplan_media_pub`</span> (
    <span class="hljs-string">`teachplan_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'课程计划id'</span>,
    <span class="hljs-string">`media_id`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'媒资文件id'</span>,
    <span class="hljs-string">`media_fileoriginalname`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'媒资文件的原始名称'</span>,
    <span class="hljs-string">`media_url`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'媒资文件访问地址'</span>,
    <span class="hljs-string">`courseid`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">COMMENT</span> <span class="hljs-string">'课程Id'</span>,
    <span class="hljs-string">`timestamp`</span> <span class="hljs-built_in">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-literal">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">COMMENT</span>
    <span class="hljs-string">'logstash使用'</span>,
    PRIMARY <span class="hljs-keyword">KEY</span> (<span class="hljs-string">`teachplan_id`</span>)
) <span class="hljs-keyword">ENGINE</span>=<span class="hljs-keyword">InnoDB</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">CHARSET</span>=utf8</code></pre></div>

<p>数据模型类如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.course;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;
<span class="hljs-keyword">import</span> org.hibernate.annotations.GenericGenerator;

<span class="hljs-keyword">import</span> javax.persistence.*;
<span class="hljs-keyword">import</span> java.io.Serializable;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table</span>(name=<span class="hljs-string">"teachplan_media_pub"</span>)
<span class="hljs-meta">@GenericGenerator</span>(name = <span class="hljs-string">"jpa-assigned"</span>, strategy = <span class="hljs-string">"assigned"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TeachplanMediaPub</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">916357110051689485L</span>;
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue</span>(generator = <span class="hljs-string">"jpa-assigned"</span>)
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"teachplan_id"</span>)
    <span class="hljs-keyword">private</span> String teachplanId;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_id"</span>)
    <span class="hljs-keyword">private</span> String mediaId;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_fileoriginalname"</span>)
    <span class="hljs-keyword">private</span> String mediaFileOriginalName;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_url"</span>)
    <span class="hljs-keyword">private</span> String mediaUrl;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"courseid"</span>)
    <span class="hljs-keyword">private</span> String courseId;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"timestamp"</span>)
    <span class="hljs-keyword">private</span> Date timestamp;<span class="hljs-comment">//时间戳</span>
&#125;</code></pre></div>

<h3 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h3><p>创建 <code>TeachplanMediaPub</code> 表的 <code>Dao</code>，向 <code>TeachplanMediaPub</code> 存储信息采用先删除该课程的媒资信息，再添加该课程的媒资信息，所以这里定义根据课程 <code>id</code> 删除课程计划媒资方法：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TeachplanMediaPubRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">TeachplanMediaPub</span>, <span class="hljs-title">String</span>&gt; </span>&#123;
    <span class="hljs-comment">//根据课程id删除课程计划媒资信息</span>
    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">deleteByCourseId</span><span class="hljs-params">(String courseId)</span></span>;
&#125;</code></pre></div>

<p>从TeachplanMedia查询课程计划媒资信息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//从TeachplanMedia查询课程计划媒资信息</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TeachplanMediaRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">TeachplanMedia</span>, <span class="hljs-title">String</span>&gt; </span>&#123;
    <span class="hljs-function">List&lt;TeachplanMedia&gt; <span class="hljs-title">findByCourseId</span><span class="hljs-params">(String courseId)</span></span>;
&#125;</code></pre></div>

<h3 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h3><p>编写保存课程计划媒资信息方法，并在课程发布时调用此方法。</p>
<p>1、保存课程计划媒资信息方法</p>
<p>本方法采用先删除该课程的媒资信息，再添加该课程的媒资信息，在 <code>CourseService</code> 下定义该方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//保存课程计划媒资信息</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveTeachplanMediaPub</span><span class="hljs-params">(String courseId)</span></span>&#123;
    <span class="hljs-comment">//查询课程媒资信息</span>
    List&lt;TeachplanMedia&gt; byCourseId = teachplanMediaRepository.findByCourseId(courseId);
    <span class="hljs-keyword">if</span>(byCourseId == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">//没有查询到媒资数据则直接结束该方法</span>

    <span class="hljs-comment">//将课程计划媒资信息储存到待索引表</span>

    <span class="hljs-comment">//删除原有的索引信息</span>
    teachplanMediaPubRepository.deleteByCourseId(courseId);
    <span class="hljs-comment">//一个课程可能会有多个媒资信息,遍历并使用list进行储存</span>
    List&lt;TeachplanMediaPub&gt; teachplanMediaPubList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">for</span> (TeachplanMedia teachplanMedia: byCourseId) &#123;
        TeachplanMediaPub teachplanMediaPub = <span class="hljs-keyword">new</span> TeachplanMediaPub();
        BeanUtils.copyProperties(teachplanMedia, teachplanMediaPub);
        teachplanMediaPubList.add(teachplanMediaPub);
    &#125;
    <span class="hljs-comment">//保存所有信息</span>
    teachplanMediaPubRepository.saveAll(teachplanMediaPubList);
&#125;</code></pre></div>

<p>2、课程发布时调用此方法</p>
<p>修改课程发布的 <code>coursePublish</code> 方法：</p>
<div class="hljs"><pre><code class="hljs java">....
<span class="hljs-comment">//保存课程计划媒资信息到待索引表</span>
saveTeachplanMediaPub(courseId);
<span class="hljs-comment">//页面url</span>
String pageUrl = cmsPostPageResult.getPageUrl();
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CoursePublishResult(CommonCode.SUCCESS,pageUrl);
.....</code></pre></div>

<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>测试课程发布后是否成功将课程媒资信息存储到 <code>teachplan_media_pub</code> 中，测试流程如下：</p>
<p>1、指定一个课程</p>
<p>2、为课程计划添加课程媒资</p>
<p>3、执行课程发布</p>
<p>4、观察课程计划媒资信息是否存储至 <code>teachplan_media_pub</code> 中</p>
<p>注意：由于此测试仅用于测试发布课程计划媒资信息的功能，可暂时将 <code>cms</code>页面发布的功能暂时屏蔽，提高测试效率。</p>
<p>测试结果如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image7" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image7.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-Logstash：扫描课程计划媒资"><a href="#3-Logstash：扫描课程计划媒资" class="headerlink" title="3. Logstash：扫描课程计划媒资"></a>3. Logstash：扫描课程计划媒资</h2><p><code>Logstash</code> 定时扫描课程媒资信息表，并将课程媒资信息写入索引库。</p>
<h3 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h3><p>1、创建 <code>xc_course_media</code> 索引</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image8" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image8.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2、并向此索引创建如下映射</p>
<p>POST: <a href="http://localhost:9200/xc_course_media/doc/_mapping" target="_blank" rel="noopener">http://localhost:9200/xc_course_media/doc/_mapping</a></p>
<div class="hljs"><pre><code class="hljs json">&#123;
    <span class="hljs-attr">"properties"</span> : &#123;
        <span class="hljs-attr">"courseid"</span> : &#123;
            <span class="hljs-attr">"type"</span> : <span class="hljs-string">"keyword"</span>
        &#125;,
        <span class="hljs-attr">"teachplan_id"</span> : &#123;
            <span class="hljs-attr">"type"</span> : <span class="hljs-string">"keyword"</span>
        &#125;,
        <span class="hljs-attr">"media_id"</span> : &#123;
            <span class="hljs-attr">"type"</span> : <span class="hljs-string">"keyword"</span>
        &#125;,
        <span class="hljs-attr">"media_url"</span> : &#123;
            <span class="hljs-attr">"index"</span> : <span class="hljs-literal">false</span>,
            <span class="hljs-attr">"type"</span> : <span class="hljs-string">"text"</span>
        &#125;,
        <span class="hljs-attr">"media_fileoriginalname"</span> : &#123;
            <span class="hljs-attr">"index"</span> : <span class="hljs-literal">false</span>,
            <span class="hljs-attr">"type"</span> : <span class="hljs-string">"text"</span>
        &#125;
    &#125;
&#125;</code></pre></div>

<p>索引创建成功</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image9" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image9.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="创建模板文件"><a href="#创建模板文件" class="headerlink" title="创建模板文件"></a>创建模板文件</h3><p>在 <code>logstach</code> 的 <code>config</code> 目录文件 <code>xc_course_media_template.json</code></p>
<p>文件路径为 <code>%ES_ROOT_DIR%/logstash6.8.8/config/xc_course_media_template.json</code></p>
<blockquote>
<p>%ES_ROOT_DIR% 为 ElasticSearch 和 logstash 的安装目录</p>
</blockquote>
<p>内容如下：</p>
<div class="hljs"><pre><code class="hljs json">&#123;
    <span class="hljs-attr">"mappings"</span> : &#123;
        <span class="hljs-attr">"doc"</span> : &#123;
            <span class="hljs-attr">"properties"</span> : &#123;
                <span class="hljs-attr">"courseid"</span> : &#123;
                    <span class="hljs-attr">"type"</span> : <span class="hljs-string">"keyword"</span>
                &#125;,
                <span class="hljs-attr">"teachplan_id"</span> : &#123;
                    <span class="hljs-attr">"type"</span> : <span class="hljs-string">"keyword"</span>
                &#125;,
                <span class="hljs-attr">"media_id"</span> : &#123;
                    <span class="hljs-attr">"type"</span> : <span class="hljs-string">"keyword"</span>
                &#125;,
                <span class="hljs-attr">"media_url"</span> : &#123;
                    <span class="hljs-attr">"index"</span> : <span class="hljs-literal">false</span>,
                    <span class="hljs-attr">"type"</span> : <span class="hljs-string">"text"</span>
                &#125;,
                <span class="hljs-attr">"media_fileoriginalname"</span> : &#123;
                    <span class="hljs-attr">"index"</span> : <span class="hljs-literal">false</span>,
                    <span class="hljs-attr">"type"</span> : <span class="hljs-string">"text"</span>
                &#125;
            &#125;
        &#125;,
        <span class="hljs-attr">"template"</span> : <span class="hljs-string">"xc_course_media"</span>
    &#125;
&#125;</code></pre></div>

<h3 id="配置-mysql-conf"><a href="#配置-mysql-conf" class="headerlink" title="配置 mysql.conf"></a>配置 mysql.conf</h3><p>在logstash的 <code>config</code> 目录下配置 <code>mysql_course_media.conf</code> 文件供 <code>logstash</code> 使用，<code>logstash</code> 会根据<br><code>mysql_course_media.conf</code> 文件的配置的地址从 <code>MySQL</code> 中读取数据向 <code>ES</code> 中写入索引。</p>
<p>参考<a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-inputs-jdbc.html</a></p>
<p>配置输入数据源和输出数据源。</p>
<div class="hljs"><pre><code class="hljs json">input &#123;
    stdin &#123;&#125; 
	jdbc &#123;
		jdbc_connection_string =&gt; "jdbc:mysql://localhost:3306/xc_course?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true&amp;serverTimezone=UTC"
        # 数据库信息
        jdbc_user =&gt; "root"
        jdbc_password =&gt; "123123"
        # MYSQL 驱动地址,修改为maven仓库对应的位置
        jdbc_driver_library =&gt; "D:/soft/apache-maven-3.5.4/repository/mysql/mysql-connector-java/5.1.40/mysql-connector-java-5.1.40.jar"
		# the name of the driver class for mysql
		jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"
		jdbc_paging_enabled =&gt; "true"
		jdbc_page_size =&gt; "50000"
		#要执行的sql文件
		#statement_filepath =&gt; "/conf/course.sql"
		statement =&gt; "select * from teachplan_media_pub where timestamp &gt; date_add(:sql_last_value,INTERVAL 8 HOUR)"
		#定时配置
		schedule =&gt; "* * * * *"
		record_last_run =&gt; true
		last_run_metadata_path =&gt; "D:/soft/elasticsearch/logstash-6.8.8/config/xc_course_media_metadata"
	&#125;
&#125; 
output &#123;
    elasticsearch &#123;
		#ES的ip地址和端口
		hosts =&gt; "localhost:9200"
		#hosts =&gt; ["localhost:9200","localhost:9202","localhost:9203"]
		#ES索引库名称
		index =&gt; "xc_course_media"
		document_id =&gt; "%&#123;teachplan_id&#125;"
		document_type =&gt; "doc"
		template =&gt; "D:/soft/elasticsearch/logstash-6.8.8/config/xc_course_media_template.json"
		template_name =&gt;"xc_course_media"
		template_overwrite =&gt;"true"
	&#125; 
	stdout &#123;
		#日志输出
		codec =&gt; json_lines
	&#125;
&#125;</code></pre></div>

<h3 id="启动-logstash-bat"><a href="#启动-logstash-bat" class="headerlink" title="启动 logstash.bat"></a>启动 logstash.bat</h3><p>启动 <code>logstash.bat</code> 采集 <code>teachplan_media_pub</code> 中的数据，向 <code>ES</code> 写入索引。</p>
<div class="hljs"><pre><code class="hljs c">logstash.bat -f ../<span class="hljs-built_in">config</span>/mysql_course_media.conf</code></pre></div>

<p>课程发布成功后，Logstash 会自动参加 <code>teachplan_media_pub</code> 表中新增的数据，效果如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image10" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image10.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image11" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image11.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="Logstash多实例运行"><a href="#Logstash多实例运行" class="headerlink" title="Logstash多实例运行"></a>Logstash多实例运行</h3><p>由于之前我们还启动了一个 <code>Logstash</code> 对课程的发布信息进行采集，所以如果想两个 <code>logstash</code> 实例同时运行，因为每个实例都有一个.lock文件，所以不能使用同一个目录来存放数据，所以我们需要使用 <code>--path.data=</code> 为每个实例指定单独的数据目录，具体的代码如下：</p>
<blockquote>
<p>该配置是在windows下进行的</p>
</blockquote>
<p><strong>课程发布实例</strong></p>
<p><code>logstash_start_course_pub.bat</code></p>
<div class="hljs"><pre><code class="hljs cmd">@<span class="hljs-built_in">title</span> logstash <span class="hljs-keyword">in</span> course_pub
logstash.bat -f ..\config\mysql.conf --<span class="hljs-built_in">path</span>.data=../data/course_pub</code></pre></div>

<p><strong>课程计划媒体发布实例</strong></p>
<p><code>logstash_start_teachplan_media.bat</code></p>
<div class="hljs"><pre><code class="hljs cmd">@<span class="hljs-built_in">title</span> logstash i n teachplan_media_pub
logstash.bat -f ../config/mysql_course_media.conf --<span class="hljs-built_in">path</span>.data=../data/teachplan_media/</code></pre></div>

<p>同时运行效果如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image12" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image12.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="4-搜素服务：查询课程媒资接口"><a href="#4-搜素服务：查询课程媒资接口" class="headerlink" title="4. 搜素服务：查询课程媒资接口"></a>4. 搜素服务：查询课程媒资接口</h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p><code>搜索服务</code> 提供查询课程媒资接口，此接口供学习服务调用。</p>
<h3 id="Api接口定义"><a href="#Api接口定义" class="headerlink" title="Api接口定义"></a>Api接口定义</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"根据课程计划查询媒资信息"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanMediaPub <span class="hljs-title">getmedia</span><span class="hljs-params">(String teachplanId)</span></span>;</code></pre></div>

<h3 id="Service-2"><a href="#Service-2" class="headerlink" title="Service"></a>Service</h3><p>1、配置课程计划媒资索引库等信息</p>
<p>在 <code>application.yml</code> 中配置</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">xuecheng:</span>
  <span class="hljs-attr">elasticsearch:</span>
    <span class="hljs-attr">hostlist:</span> <span class="hljs-string">$&#123;eshostlist:127.0.0.1:9200&#125;</span> <span class="hljs-comment">#多个结点中间用逗号分隔</span>
    <span class="hljs-attr">course:</span>
      <span class="hljs-attr">index:</span> <span class="hljs-string">xc_course</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">doc</span>
      <span class="hljs-attr">source_field:</span> <span class="hljs-string">id,name,grade,mt,st,charge,valid,pic,qq,price,price_old,status,studymodel,teachmode,expires,pub_time,start_time,end_time</span>
    <span class="hljs-attr">media:</span>
      <span class="hljs-attr">index:</span> <span class="hljs-string">xc_course_media</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">doc</span>
      <span class="hljs-attr">source_field:</span> <span class="hljs-string">courseid,media_id,media_url,teachplan_id,media_fileoriginalname</span></code></pre></div>

<p>2、service 方法开发</p>
<p>在 <code>课程搜索服务</code> 中定义课程媒资查询接口，为了适应后续需求，<code>service</code> 参数定义为数组，可一次查询多个课程计划的媒资信息。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 根据一个或者多个课程计划id查询媒资信息</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> teachplanIds 课程id</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">    */</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult&lt;TeachplanMediaPub&gt; <span class="hljs-title">getmedia</span><span class="hljs-params">(String [] teachplanIds)</span></span>&#123;
       <span class="hljs-comment">//设置索引</span>
       SearchRequest searchRequest = <span class="hljs-keyword">new</span> SearchRequest(media_index);

       <span class="hljs-comment">//设置类型</span>
       searchRequest.types(media_type);

       <span class="hljs-comment">//创建搜索源对象</span>
       SearchSourceBuilder searchSourceBuilder = <span class="hljs-keyword">new</span> SearchSourceBuilder();

       <span class="hljs-comment">//源字段过滤</span>
       String[] media_index_arr = media_field.split(<span class="hljs-string">","</span>);
       searchSourceBuilder.fetchSource(media_index_arr, <span class="hljs-keyword">new</span> String[]&#123;&#125;);

       <span class="hljs-comment">//查询条件,根据课程计划id查询(可以传入多个课程计划id)</span>
       searchSourceBuilder.query(QueryBuilders.termsQuery(<span class="hljs-string">"teachplan_id"</span>, teachplanIds));

       searchRequest.source(searchSourceBuilder);
       SearchResponse searchResponse = <span class="hljs-keyword">null</span>;
       <span class="hljs-keyword">try</span> &#123;
           searchResponse = restHighLevelClient.search(searchRequest);
       &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
           e.printStackTrace();
       &#125;
       <span class="hljs-comment">//获取结果</span>
       SearchHits hits = searchResponse.getHits();
       <span class="hljs-keyword">long</span> totalHits = hits.getTotalHits();
       SearchHit[] searchHits = hits.getHits();

       <span class="hljs-comment">//数据列表</span>
       List&lt;TeachplanMediaPub&gt; teachplanMediaPubList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

       <span class="hljs-keyword">for</span>(SearchHit hit:searchHits)&#123;
           TeachplanMediaPub teachplanMediaPub =<span class="hljs-keyword">new</span> TeachplanMediaPub();
           Map&lt;String, Object&gt; sourceAsMap = hit.getSourceAsMap();
           <span class="hljs-comment">//取出课程计划媒资信息</span>
           String courseid = (String) sourceAsMap.get(<span class="hljs-string">"courseid"</span>);
           String media_id = (String) sourceAsMap.get(<span class="hljs-string">"media_id"</span>);
           String media_url = (String) sourceAsMap.get(<span class="hljs-string">"media_url"</span>);
           String teachplan_id = (String) sourceAsMap.get(<span class="hljs-string">"teachplan_id"</span>);
           String media_fileoriginalname = (String) sourceAsMap.get(<span class="hljs-string">"media_fileoriginalname"</span>);
           teachplanMediaPub.setCourseId(courseid);
           teachplanMediaPub.setMediaUrl(media_url);
           teachplanMediaPub.setMediaFileOriginalName(media_fileoriginalname);
           teachplanMediaPub.setMediaId(media_id);
           teachplanMediaPub.setTeachplanId(teachplan_id);
           <span class="hljs-comment">//将对象加入到列表中</span>
           teachplanMediaPubList.add(teachplanMediaPub);
       &#125;

       <span class="hljs-comment">//构建返回课程媒资信息对象</span>
       QueryResult&lt;TeachplanMediaPub&gt; queryResult = <span class="hljs-keyword">new</span> QueryResult&lt;&gt;();
       queryResult.setList(teachplanMediaPubList);
       queryResult.setTotal(totalHits);
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResponseResult&lt;TeachplanMediaPub&gt;(CommonCode.SUCCESS,queryResult);
   &#125;</code></pre></div>

<h3 id="Controller-1"><a href="#Controller-1" class="headerlink" title="Controller"></a>Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据课程计划id搜索发布后的媒资信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> teachplanId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@GetMapping</span>(value=<span class="hljs-string">"/getmedia/&#123;teachplanId&#125;"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanMediaPub <span class="hljs-title">getmedia</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"teachplanId"</span>)</span> String teachplanId) </span>&#123;
    <span class="hljs-comment">//为了service的拓展性,所以我们service接收的是数组作为参数,以便后续开发查询多个ID的接口</span>
    String[] teachplanIds = <span class="hljs-keyword">new</span> String[]&#123;teachplanId&#125;;
    <span class="hljs-comment">//通过service查询ES获取课程媒资信息</span>
    QueryResponseResult&lt;TeachplanMediaPub&gt; mediaPubQueryResponseResult = esCourseService.getmedia(teachplanIds);
    QueryResult&lt;TeachplanMediaPub&gt; queryResult = mediaPubQueryResponseResult.getQueryResult();
    <span class="hljs-keyword">if</span>(queryResult!=<span class="hljs-keyword">null</span>&amp;&amp; queryResult.getList()!=<span class="hljs-keyword">null</span>
       &amp;&amp; queryResult.getList().size()&gt;<span class="hljs-number">0</span>)&#123;
        <span class="hljs-comment">//返回课程计划对应课程媒资</span>
        <span class="hljs-keyword">return</span> queryResult.getList().get(<span class="hljs-number">0</span>);
    &#125; <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TeachplanMediaPub();
&#125;</code></pre></div>

<h3 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h3><p>使用 <code>swagger-ui</code> 和 <code>postman</code> 测试课程媒资查询接口。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image13" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image13.png" srcset="/img/loading.gif" alt="img"></a></p>
<h1 id="三、在线学习：接口开发"><a href="#三、在线学习：接口开发" class="headerlink" title="三、在线学习：接口开发"></a>三、在线学习：接口开发</h1><h2 id="1-需求分析-2"><a href="#1-需求分析-2" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>根据下边的业务流程，本章节完成前端学习页面请求学习服务获取课程视频地址，并自动播放视频。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image14" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image14.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="2-搭建开发环境"><a href="#2-搭建开发环境" class="headerlink" title="2. 搭建开发环境"></a>2. 搭建开发环境</h2><p>1、创建数据库</p>
<p>创建 <code>xc_learning</code> 数据库，学习数据库将记录学生的选课信息、学习信息。</p>
<p>导入：<code>资料/xc_learning.sql</code></p>
<p>2、创建学习服务工程</p>
<p>参考课程管理服务工程结构，创建学习服务工程：</p>
<p>导入：<code>资料/xc-service-learning.zip</code></p>
<p>项目工程结构如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image15" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image15.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-Api接口"><a href="#3-Api接口" class="headerlink" title="3. Api接口"></a>3. Api接口</h2><p>此 <code>api</code> 接口是课程学习页面请求学习服务获取课程学习地址。</p>
<p>定义返回值类型：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.learning.response;

<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.ResponseResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.ResultCode;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;
<span class="hljs-keyword">import</span> lombok.ToString;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetMediaResult</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResponseResult</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GetMediaResult</span><span class="hljs-params">(ResultCode resultCode, String fileUrl)</span> </span>&#123;
        <span class="hljs-keyword">super</span>(resultCode);
        <span class="hljs-keyword">this</span>.fileUrl = fileUrl;
    &#125;
    <span class="hljs-comment">//媒资文件播放地址</span>
    <span class="hljs-keyword">private</span> String fileUrl;
&#125;</code></pre></div>

<p>定义接口，学习服务根据传入课程 <code>ID</code>、章节 <code>Id</code>(课程计划 <code>ID</code>)来取学习地址。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(value = <span class="hljs-string">"录播课程学习管理"</span>,description = <span class="hljs-string">"录播课程学习管理"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseLearningControllerApi</span> </span>&#123;
    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"获取课程学习地址"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> GetMediaResult <span class="hljs-title">getMediaPlayUrl</span><span class="hljs-params">(String courseId,String teachplanId)</span></span>;
&#125;</code></pre></div>

<h2 id="4-服务端开发"><a href="#4-服务端开发" class="headerlink" title="4. 服务端开发"></a>4. 服务端开发</h2><h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h3><p>学习服务根据传入课程ID、章节Id(课程计划ID)请求搜索服务获取学习地址。</p>
<h3 id="搜索服务注册Eureka"><a href="#搜索服务注册Eureka" class="headerlink" title="搜索服务注册Eureka"></a>搜索服务注册Eureka</h3><p>学习服务要调用搜索服务查询课程媒资信息，所以需要将搜索服务注册到 <code>eureka</code> 中。</p>
<p>1、查看服务名称是否为 <code>xc-service-search</code></p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-comment"># 注意修改application.xml中的服务名称：</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
	<span class="hljs-attr">name:</span> <span class="hljs-string">xc‐service‐search</span></code></pre></div>

<p>2、配置搜索服务的配置文件 <code>application.yml</code>，加入 <code>Eureka</code> 配置 如下：</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
    <span class="hljs-attr">registerWithEureka:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务注册开关</span>
    <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务发现开关</span>
    <span class="hljs-attr">serviceUrl:</span> <span class="hljs-comment">#Eureka客户端与Eureka服务端进行交互的地址，多个中间用逗号分隔</span>
      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">$&#123;EUREKA_SERVER:http://localhost:50101/eureka/,http://localhost:50102/eureka/&#125;</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">prefer-ip-address:</span>  <span class="hljs-literal">true</span>  <span class="hljs-comment">#将自己的ip地址注册到Eureka服务中</span>
    <span class="hljs-attr">ip-address:</span> <span class="hljs-string">$&#123;IP_ADDRESS:127.0.0.1&#125;</span>
    <span class="hljs-attr">instance-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;:$&#123;server.port&#125;</span> <span class="hljs-comment">#指定实例id</span>
<span class="hljs-attr">ribbon:</span>
  <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">2</span> <span class="hljs-comment">#最大重试次数，当Eureka中可以找到服务，但是服务连不上时将会重试，如果eureka中找不到服务则直接走断路器</span>
  <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">3</span> <span class="hljs-comment">#切换实例的重试次数</span>
  <span class="hljs-attr">OkToRetryOnAllOperations:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">#对所有操作请求都进行重试，如果是get则可以，如果是post，put等操作没有实现幂等的情况下是很危险的,所以设置为false</span>
  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">5000</span>  <span class="hljs-comment">#请求连接的超时时间</span>
  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">6000</span> <span class="hljs-comment">#请求处理的超时时间</span></code></pre></div>

<p>3、添加 <code>eureka</code> 依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring‐cloud‐starter‐netflix‐eureka‐client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p>4、修改启动类，在class上添加如下注解：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span></code></pre></div>

<h3 id="搜索服务客户端"><a href="#搜索服务客户端" class="headerlink" title="搜索服务客户端"></a>搜索服务客户端</h3><p>在 <code>学习服务</code> 创建搜索服务的客户端接口，此接口会生成代理对象，调用搜索服务：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.learning.client;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.TeachplanMediaPub;
<span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;

<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"xc‐service‐search"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseSearchClient</span> </span>&#123;
    <span class="hljs-meta">@GetMapping</span>(value=<span class="hljs-string">"/getmedia/&#123;teachplanId&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanMediaPub <span class="hljs-title">getmedia</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"teachplanId"</span>)</span> String teachplanId)</span>;
&#125;</code></pre></div>

<h3 id="自定义错误代码"><a href="#自定义错误代码" class="headerlink" title="自定义错误代码"></a>自定义错误代码</h3><p>我们在 <code>com.xuecheng.framework.domain.learning.response</code> 包下自定义一个错误消息模型</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.learning.response;

<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.ResultCode;
<span class="hljs-keyword">import</span> lombok.ToString;

<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> LearningCode implements ResultCode &#123;
    LEARNING_GET_MEDIA_ERROR(<span class="hljs-keyword">false</span>,<span class="hljs-number">23001</span>,<span class="hljs-string">"学习中心获取媒资信息错误！"</span>);

    <span class="hljs-comment">//操作代码</span>
    <span class="hljs-keyword">boolean</span> success;
    <span class="hljs-comment">//操作代码</span>
    <span class="hljs-keyword">int</span> code;
    <span class="hljs-comment">//提示信息</span>
    String message;
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">LearningCode</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> success, <span class="hljs-keyword">int</span> code, String message)</span></span>&#123;
        <span class="hljs-keyword">this</span>.success = success;
        <span class="hljs-keyword">this</span>.code = code;
        <span class="hljs-keyword">this</span>.message = message;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">success</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> success;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> code;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">message</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> message;
    &#125;
&#125;</code></pre></div>

<p>该消息模型基于 <code>ResultCode</code> 来实现，代码如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.model.response;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * Created by mrt on 2018/3/5.</span>
<span class="hljs-comment"> * 10000-- 通用错误代码</span>
<span class="hljs-comment"> * 22000-- 媒资错误代码</span>
<span class="hljs-comment"> * 23000-- 用户中心错误代码</span>
<span class="hljs-comment"> * 24000-- cms错误代码</span>
<span class="hljs-comment"> * 25000-- 文件系统</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ResultCode</span> </span>&#123;
    <span class="hljs-comment">//操作是否成功,true为成功，false操作失败</span>
    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">success</span><span class="hljs-params">()</span></span>;
    <span class="hljs-comment">//操作代码</span>
    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">code</span><span class="hljs-params">()</span></span>;
    <span class="hljs-comment">//提示信息</span>
    <span class="hljs-function">String <span class="hljs-title">message</span><span class="hljs-params">()</span></span>;</code></pre></div>

<p>从 <code>ResultCode</code> 中我们可以看出，我们约定了用户中心的错误代码使用 <code>23000</code>，所以我们定义的一些错误信息的代码就从 23000 开始计数。</p>
<h3 id="Service-3"><a href="#Service-3" class="headerlink" title="Service"></a>Service</h3><p>在学习服务中定义 <code>service</code> 方法，此方法远程请求课程管理服务、媒资管理服务获取课程学习地址。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.learning.service.impl;

<span class="hljs-keyword">import</span> com.netflix.discovery.converters.Auto;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.TeachplanMediaPub;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.learning.response.GetMediaResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> com.xuecheng.learning.client.CourseSearchClient;
<span class="hljs-keyword">import</span> com.xuecheng.learning.service.LearningService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;


<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LearningServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LearningService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    CourseSearchClient courseSearchClient;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 远程调用搜索服务获取已发布媒体信息中的url</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId 课程id</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> teachplanId  媒体信息id</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> GetMediaResult <span class="hljs-title">getMediaPlayUrl</span><span class="hljs-params">(String courseId, String teachplanId)</span> </span>&#123;
        <span class="hljs-comment">//校验学生权限,是否已付费等</span>


        <span class="hljs-comment">//远程调用搜索服务进行查询媒体信息</span>
        TeachplanMediaPub mediaPub = courseSearchClient.getmedia(teachplanId);
        <span class="hljs-keyword">if</span>(mediaPub == <span class="hljs-keyword">null</span>) ExceptionCast.cast(CommonCode.FAIL);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> GetMediaResult(CommonCode.SUCCESS, mediaPub.getMediaUrl());
    &#125;
&#125;</code></pre></div>

<h3 id="Controller-2"><a href="#Controller-2" class="headerlink" title="Controller"></a>Controller</h3><p>调用 <code>service</code> 根据课程计划 <code>id</code> 查询视频播放地址：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/learning/course"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseLearningController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseLearningControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    LearningService learningService;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/getmedia/&#123;courseId&#125;/&#123;teachplanId&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> GetMediaResult <span class="hljs-title">getMediaPlayUrl</span><span class="hljs-params">(@PathVariable String courseId, @PathVariable String teachplanId)</span> </span>&#123;
        <span class="hljs-comment">//获取课程学习地址</span>
        <span class="hljs-keyword">return</span> learningService.getMedia(courseId, teachplanId);
    &#125;
&#125;</code></pre></div>

<h3 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h3><p>使用 <code>swagger-ui</code> 或<code>postman</code> 测试学习服务查询课程视频地址接口。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image16" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image16.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="5-前端开发"><a href="#5-前端开发" class="headerlink" title="5. 前端开发"></a>5. 前端开发</h2><h3 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a>需求分析</h3><p>需要在学习中心前端页面需要完成如下功能：</p>
<p>1、进入课程学习页面需要带上 <code>课程 Id</code>参数及课程计划Id的参数，其中 <code>课程 Id</code> 参数必带，<code>课程计划 Id</code> 可以为空。</p>
<p>2、进入页面根据 <code>课程 Id</code> 取出该课程的课程计划显示在右侧。</p>
<p>3、进入页面后判断如果请求参数中有<code>课程计划 Id</code> 则播放该章节的视频。</p>
<p>4、进入页面后判断如果 <code>课程计划id</code> 为0则需要取出本课程第一个 <code>课程计划的Id</code>，并播放第一个课程计划的视频。</p>
<p>进入到模块 <code>xc-ui-pc-leanring/src/module/course</code></p>
<h3 id="api方法"><a href="#api方法" class="headerlink" title="api方法"></a>api方法</h3><div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">let</span> sysConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@/../config/sysConfig'</span>)
<span class="hljs-keyword">let</span> apiUrl = sysConfig.xcApiUrlPre;
<span class="hljs-comment">/*获取播放地址*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> get_media = <span class="hljs-function">(<span class="hljs-params">courseId,chapter</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestGet(apiUrl+<span class="hljs-string">'/api/learning/course/getmedia/'</span>+courseId+<span class="hljs-string">'/'</span>+chapter);
&#125;</code></pre></div>

<h3 id="配置代理"><a href="#配置代理" class="headerlink" title="配置代理"></a>配置代理</h3><p>在 <code>Nginx</code> 中的 <code>ucenter.xuecheng.com</code> 虚拟主机中配置 <code>/api/learning/</code> 的路径转发，此<code>url</code> 请转发到学习服务。</p>
<div class="hljs"><pre><code class="hljs conf">#学习服务
upstream learning_server_pool&#123;
    server 127.0.0.1:40600 weight&#x3D;10;
&#125;

#学成网用户中心
server &#123;
    listen 80;
    server_name ucenter.xuecheng.com;
    #个人中心
    location &#x2F; &#123;
        proxy_pass http:&#x2F;&#x2F;ucenter_server_pool;
    &#125;
    #后端搜索服务
    location &#x2F;openapi&#x2F;search&#x2F; &#123;
        proxy_pass http:&#x2F;&#x2F;search_server_pool&#x2F;search&#x2F;; 
    &#125;
    #学习服务
    location ^~ &#x2F;api&#x2F;learning&#x2F; &#123;
        proxy_pass http:&#x2F;&#x2F;learning_server_pool&#x2F;learning&#x2F;;
    &#125;
&#125;</code></pre></div>

<h3 id="视频播放页面"><a href="#视频播放页面" class="headerlink" title="视频播放页面"></a>视频播放页面</h3><p>1、如果传入的课程计划id为0则取出第一个课程计划id</p>
<p>在 <code>created</code> 钩子方法中完成</p>
<div class="hljs"><pre><code class="hljs js">created()&#123;
    <span class="hljs-comment">//当前请求的url</span>
    <span class="hljs-keyword">this</span>.url = <span class="hljs-built_in">window</span>.location
    <span class="hljs-comment">//课程id</span>
    <span class="hljs-keyword">this</span>.courseId = <span class="hljs-keyword">this</span>.$route.params.courseId
    <span class="hljs-comment">//章节id</span>
    <span class="hljs-keyword">this</span>.chapter = <span class="hljs-keyword">this</span>.$route.params.chapter
    <span class="hljs-comment">//查询课程信息</span>
    systemApi.course_view(<span class="hljs-keyword">this</span>.courseId).then(<span class="hljs-function">(<span class="hljs-params">view_course</span>)=&gt;</span>&#123;
        <span class="hljs-keyword">if</span>(!view_course || !view_course[<span class="hljs-keyword">this</span>.courseId])&#123;
            <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"获取课程信息失败，请重新进入此页面！"</span>)
            <span class="hljs-keyword">return</span> ;
        &#125;
        <span class="hljs-keyword">let</span> courseInfo = view_course[<span class="hljs-keyword">this</span>.courseId]
        <span class="hljs-built_in">console</span>.log(courseInfo)
        <span class="hljs-keyword">this</span>.coursename = courseInfo.name
        <span class="hljs-keyword">if</span>(courseInfo.teachplan)&#123;
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"准备开始播放视频"</span>)
            <span class="hljs-keyword">let</span> teachplan = <span class="hljs-built_in">JSON</span>.parse(courseInfo.teachplan);
            <span class="hljs-keyword">this</span>.teachplanList = teachplan.children;
            <span class="hljs-comment">//开始学习</span>
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.chapter == <span class="hljs-string">"0"</span> || !<span class="hljs-keyword">this</span>.chapter)&#123;
                <span class="hljs-comment">//取出第一个教学计划</span>
                <span class="hljs-keyword">this</span>.chapter = <span class="hljs-keyword">this</span>.getFirstTeachplan();
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"第一个教学计划id为 "</span>,<span class="hljs-keyword">this</span>.chapter);
                <span class="hljs-keyword">this</span>.study(<span class="hljs-keyword">this</span>.chapter);
            &#125;<span class="hljs-keyword">else</span>&#123;
                <span class="hljs-keyword">this</span>.study(<span class="hljs-keyword">this</span>.chapter);
            &#125;

        &#125;
    &#125;)
&#125;,</code></pre></div>

<p>取出第一个章节 <code>id</code>，用户未输入课程计划 <code>id</code> 或者输入为 <code>0</code> 时，播放第一个。</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//取出第一个章节</span>
getFirstTeachplan()&#123;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-keyword">this</span>.teachplanList.length;i++)&#123;
        <span class="hljs-keyword">let</span> firstTeachplan = <span class="hljs-keyword">this</span>.teachplanList[i];
		<span class="hljs-comment">//如果当前children存在，则取出第一个返回</span>
        <span class="hljs-keyword">if</span>(firstTeachplan.children &amp;&amp; firstTeachplan.children.length&gt;<span class="hljs-number">0</span>)&#123;
            <span class="hljs-keyword">let</span> secondTeachplan = firstTeachplan.children[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">return</span> secondTeachplan.id;
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> ;
&#125;,</code></pre></div>

<p>开始学习：</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//开始学习</span>
study(chapter)&#123;
    <span class="hljs-comment">// 获取播放地址</span>
    courseApi.get_media(<span class="hljs-keyword">this</span>.courseId,chapter).then(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>&#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            <span class="hljs-keyword">let</span> fileUrl = sysConfig.videoUrl + res.fileUrl
            <span class="hljs-comment">//播放视频</span>
            <span class="hljs-keyword">this</span>.playvideo(fileUrl)
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(res.message)&#123;
            <span class="hljs-keyword">this</span>.$message.error(res.message)
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"播放视频失败，请刷新页面重试"</span>)
        &#125;
    &#125;).catch(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"播放视频失败，请刷新页面重试"</span>)
    &#125;);
&#125;,</code></pre></div>

<p>2、点击右侧课程章节切换播放</p>
<p>在原有代码基础上添加 <code>click</code> 事件，点击调用开始学习方法（<code>study</code>）。</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">if</span>=<span class="hljs-string">"teachplan_first.children!=null"</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">for</span>=<span class="hljs-string">"(teachplan_second, index) in</span></span>
<span class="hljs-tag"><span class="hljs-string">teachplan_first.children"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"glyphicon glyphicon‐check"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"url"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"study(teachplan_second.id)"</span>&gt;</span>
&#123;&#123;teachplan_second.pname&#125;&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></code></pre></div>

<p>3、地址栏路由url变更</p>
<p>这里需要注意一个问题，在用户点击课程章节切换播放时，地址栏的 <code>url</code> 也应该同步改变为当前所选择的课程计划 <code>id</code></p>
<p>4、在线学习按钮</p>
<p>将 <code>learnstatus</code> 默认更改为 <code>1</code>，这样就能显示出马上学习的按钮，方便我们后续的集成测试。</p>
<p>文件路径为 <code>xc-ui-pc-static-portal/include/course_detail_dynamic.html</code> 部分代码块如下</p>
<div class="hljs"><pre><code class="hljs js">&lt;script&gt;

   <span class="hljs-keyword">var</span> body= <span class="hljs-keyword">new</span> Vue(&#123;   <span class="hljs-comment">//创建一个Vue的实例</span>
        el: <span class="hljs-string">"#body"</span>, <span class="hljs-comment">//挂载点是id="app"的地方</span>

        data: &#123;
            editLoading: <span class="hljs-literal">false</span>,
            title:<span class="hljs-string">'测试'</span>,
            courseId:<span class="hljs-string">''</span>,
            charge:<span class="hljs-string">''</span>,<span class="hljs-comment">//203001免费,203002收费</span>
            learnstatus: <span class="hljs-number">1</span> ,<span class="hljs-comment">//课程状态，1：马上学习，2：立即报名、3：立即购买</span>
            course:&#123;&#125;,
            companyId:<span class="hljs-string">'template'</span>,
            company_stat:[],
            course_stat:&#123;<span class="hljs-string">"s601001"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"s601002"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"s601003"</span>:<span class="hljs-string">""</span>&#125;


        &#125;,</code></pre></div>

<h3 id="简单的测试"><a href="#简单的测试" class="headerlink" title="简单的测试"></a>简单的测试</h3><p>访问在线学习页面：<code>http://ucenter.xuecheng.com/#/learning/课程id/课程计划id</code></p>
<p>通过 <code>url</code> 传入两个参数：<code>课程id</code> 和 <code>课程计划id</code></p>
<p>如果没有课程计划则传入0</p>
<p>测试项目如下：</p>
<p>1、传入正确的课程id、课程计划id，自动播放本章节的视频</p>
<p>2、传入正确的课程id、课程计划id传入0，自动播放第一个视频</p>
<p>3、传入错误的课程id 或 课程计划id，提示错误信息。</p>
<p>4、通过右侧章节目录切换章节及播放视频。</p>
<p>访问： <a href="http://ucenter.xuecheng.com/#/learning/4028e58161bcf7f40161bcf8b77c0000/4028e58161bd18ea0161bd1f73190008" target="_blank" rel="noopener">http://ucenter.xuecheng.com/#/learning/4028e58161bcf7f40161bcf8b77c0000/4028e58161bd18ea0161bd1f73190008</a></p>
<p>传入正确的课程id、课程计划id，自动播放本章节的视频</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image17" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image17.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>传入正确的课程id、课程计划id传入0，自动播放第一个视频</p>
<p>访问 <a href="http://ucenter.xuecheng.com/#/learning/4028e58161bcf7f40161bcf8b77c0000/0" target="_blank" rel="noopener">http://ucenter.xuecheng.com/#/learning/4028e58161bcf7f40161bcf8b77c0000/0</a></p>
<p>识别出第一个课程计划的 <code>id</code></p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image18" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image18.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>需要注意的是这里的 <code>chapter</code> 参数是我自己在 <code>study</code> 函数里加上去的，可以忽略。</p>
<p>传入错误的课程id或课程计划id，提示错误信息。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image19" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image19.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>通过右侧章节目录切换章节及播放视频。</p>
<p>点击章节即可播放，但是点击制定章节后 <code>url</code> 没有发生改变，这个问题暂时还没有解决，关注笔记后面的内容。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image20" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image20.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="完整的测试"><a href="#完整的测试" class="headerlink" title="完整的测试"></a>完整的测试</h3><p>准备工作</p>
<ul>
<li>启动 <code>RabbitMQ</code>，启动 <code>Logstash</code>、<code>ElasticSearch</code></li>
<li>建议把所有后端服务都开起来</li>
<li>启动 前端静态门户、启动 <code>nginx</code> 、启动课程管理前端</li>
</ul>
<p>我们整理一下测试的流程</p>
<ol>
<li>上传两个媒资视频文件，用于测试</li>
<li>进入到课程管理，为课程计划选择媒资信息</li>
<li>发布课程，等待 <code>logstash</code> 将数据采集到 <code>ElasticSearch</code> 的索引库中</li>
<li>进入学成网主页，点击课程，进入到搜索门户页面</li>
<li>搜索课程，进入到课程详情页面</li>
<li>点击开始学习，进入到课程学习页面，选择课程计划中的一个章节进行学习。</li>
</ol>
<h4 id="1、上传文件"><a href="#1、上传文件" class="headerlink" title="1、上传文件"></a>1、上传文件</h4><p>首先我们使用之前开发的媒资管理模块，上传两个视频文件用于测试。</p>
<p>第一个文件上传成功</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image21" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image21.png" srcset="/img/loading.gif" alt="img"></a></p>
<h5 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h5><p>在上传第二个文件时，发生了错误，我们来检查一下问题出在了哪里</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image22" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image22.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>在媒体服务的控制台中可以看到，在 <code>mergeChunks</code> 方法在校验文件 <code>md5</code> 时候抛出了异常</p>
<p>我们在 <code>MD5</code> 校验这里打个断点，重新上传文件，分析一下问题所在。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image23" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image23.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>单步调试后发现，合并文件后的MD5值与用户上传的源文件值不相等</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image24" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image24.png" srcset="/img/loading.gif" alt="img"></a></p>
<h5 id="方案1：删除本地分块文件重新尝试上传"><a href="#方案1：删除本地分块文件重新尝试上传" class="headerlink" title="方案1：删除本地分块文件重新尝试上传"></a><del>方案1：删除本地分块文件重新尝试上传</del></h5><p>考虑到可能是在用户上传完 视频的分块文件时发生了一些问题，导致合并文件后与源文件的大小不等，导致MD5也不相同，这里我们把这个视频上传到本地的文件全部删除，在媒资上传页面重新上传文件。</p>
<p>对比所有分块文件的字节大小和本地源文件的大小，完全是相等的</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image25" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image25.png" srcset="/img/loading.gif" alt="img"></a></p>
<blockquote>
<p>删除所有文件后重新上传，md5值还是不等，考虑从调试一下文件合并的代码。</p>
</blockquote>
<h5 id="方案2：检查前端提交的MD5值是否正确"><a href="#方案2：检查前端提交的MD5值是否正确" class="headerlink" title="方案2：检查前端提交的MD5值是否正确"></a>方案2：检查前端提交的MD5值是否正确</h5><p>在查阅是否有其他的MD5值获取方案时，发现了一个使用 <code>windows</code> 本地命令获取文件MD5值的方法</p>
<div class="hljs"><pre><code class="hljs angelscript">certutil -hashfile .\<span class="hljs-number">19</span>-在线学习接口-集成测试.avi md5</code></pre></div>

<p>惊奇的发现，TM的原来是前端那边转换的MD5值不正确，后端这边是没有问题的。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image26" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image26.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>从前面的图可以看出，本地和后端转换的都是以一个 <code>f6f0</code> 开头的MD5值</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image27" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image27.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>那么问题就出现在前端了，还需要花一些时间去分析一下，这里暂时就先告一段落，因为上传了几个文件测试中只有这一个文件出现了问题。</p>
<h4 id="2、为课程计划选择媒资信息"><a href="#2、为课程计划选择媒资信息" class="headerlink" title="2、为课程计划选择媒资信息"></a>2、为课程计划选择媒资信息</h4><p>进入到一个课程的管理页面</p>
<p><a href="http://localhost:12000/#/course/manage/baseinfo/4028e58161bcf7f40161bcf8b77c0000" target="_blank" rel="noopener">http://localhost:12000/#/course/manage/baseinfo/4028e58161bcf7f40161bcf8b77c0000</a></p>
<p>将刚才我们上传的媒资文件的信息和课程计划绑定</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image28" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image28.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>选择效果如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image29" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image29.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2、发布课程，等待 <code>logstash</code> 从 <code>course_pub</code> 以及 <code>teachplan_media_pub</code> 表中采集数据到 <code>ElasticSearch</code> 当中</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image30" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image30.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>发布成功后，我们可以从 <code>teachplan_media_pub</code> 表中看到刚才我们发布的媒资信息</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image31" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image31.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>再观察 Logstash 的控制台，发现两个 Logstash 的实例都对更新的课程发布信息进行了采集</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image32" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image32.png" srcset="/img/loading.gif" alt="img"></a></p>
<h4 id="3、前端门户测试"><a href="#3、前端门户测试" class="headerlink" title="3、前端门户测试"></a>3、前端门户测试</h4><p>打开我们的门户主站 <code>http://www.xuecheng.com/</code></p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image33" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image33.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>点击导航栏的课程，进入到我们的搜索门户页面</p>
<blockquote>
<p>如果无法进入到搜索门户，请检查你的 xc-ui-pc-portal 前端工程是否已经启动</p>
</blockquote>
<p>进入到搜索门户后，可以看到一些初始化时搜索的课程数据，默认是搜索第一页的数据，每页2个课程。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image34" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image34.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>我们可以测试搜索一下前面我们选择媒资信息时所用的课程</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image35" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image35.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>点击课程，进入到课程详情页面，然后再点击开始学习。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image36" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image36.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>点击马上学习后，会进入到该课程的在线学习页面，默认自动播放我们第一个课程计划中的视频。</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image37" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image37.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>我们可以在右侧的目录中选择第二个课程计划，会自动播放所选的课程计划所对应的媒资视频播放地址，该 播放地址正是我们刚才通过 <code>Logstash</code> 自动采集到 <code>ElasticSearch</code> 的索引信息，效果图如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_15/image38" target="_blank" rel="noopener"><img src="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/image38.png" srcset="/img/loading.gif" alt="img"></a></p>
<h1 id="四、待完善的一些功能"><a href="#四、待完善的一些功能" class="headerlink" title="四、待完善的一些功能"></a>四、待完善的一些功能</h1><ul>
<li>课程发布前，校验课程计划里面是否包含二级课程计划</li>
<li>课程发布前，校验课程计划信息里面是否全部包含媒资信息</li>
<li>删除媒资信息，并且同步删除ES中的索引</li>
<li>在获取该课程的播放地址时校验用户的合法、</li>
<li>在线学习页面，点击右侧目录中的课程计划同时改变url中的课程计划地址</li>
<li>视频文件 <code>19-在线学习接口-集成测试.avi</code> 前端上传时提交的MD5值不正确</li>
</ul>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday16/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线day16：基于Spring Security Oauth2开发认证服务</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/">
                        <span class="hidden-mobile">学成在线day14：媒资管理</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

代码块js 用不到，fulid自带有，添加css样式即可实现
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键字</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "本站勉强运行&nbsp"+dnum+"&nbsp天";
      document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证123456号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备12345678号</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "学成在线day15：媒资管理系统集成&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
