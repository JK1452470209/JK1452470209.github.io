<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>学成在线day06 - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>私人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-12 15:31">
      2020-08-12
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      8.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      124
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="😎知识点概览"><a href="#😎知识点概览" class="headerlink" title="😎知识点概览"></a>😎知识点概览</h1><blockquote>
<p>为了方便后续回顾该项目时能够清晰的知道本章节讲了哪些内容，并且能够从该章节的笔记中得到一些帮助，所以在完成本章节的学习后在此对本章节所涉及到的知识点进行总结概述。</p>
</blockquote>
<p>本章节为【学成在线】项目的 <code>day06</code> 的内容</p>
<ul>
<li><p>使用 <code>Spring boot</code> 集成 <code>RabbitMQ</code> 和 <code>GridFS</code> 实现基于生产者和消费者模型的页面静态化发布的流程。</p>
<p>在本章节的知识点中，再次复习了基于 <code>GridFS</code> 和 <code>RabbitMQ</code> 的分布式静态页面发布的知识点，深化了记忆。</p>
<p>​</p>
</li>
<li><p>使用三级菜单实现课程计划的查询和添加</p>
<p>这里的技术点不是很多，用到了 <code>Mysql</code> 的表内自连接查询，以及在添加课程的时候，需要考虑一些意外情况的发生，例如再添加课程时，如果该课程的根节点（一级菜单）不存在，则需要为该课程添加一个根节点后再进行该二级节点的添加。</p>
</li>
</ul>
<h1 id="一、页面发布"><a href="#一、页面发布" class="headerlink" title="一、页面发布"></a>一、页面发布</h1><h2 id="1-技术方案"><a href="#1-技术方案" class="headerlink" title="1. 技术方案"></a>1. 技术方案</h2><p>本项目使用MQ实现页面发布的技术方案如下:</p>
<p><img src="https://qnoss.codeyee.com/20200706_Ng==/image1.png" srcset="/img/loading.gif" alt="学成在线day06/image1.png)"></p>
<p>*<em>技术方案说明 *</em></p>
<p>1、平台包括多个站点，页面归属不同的站点。</p>
<p>2、发布一个页面应将该页面发布到所属站点的服务器上。</p>
<p>3、每个站点服务部署 <code>cms client</code> 程序，并与交换机绑定，绑定时指定站点Id为routingKey。</p>
<p>指定站点id为 <code>routingKey</code> 就可以实现 <code>cms client</code> 只能接收到所属站点的页面发布消息。</p>
<p>4、页面发布程序向MQ发布消息时指定页面所属站点 <code>Id</code> 为 <code>routingKey</code>，将该页面发布到它所在服务器上的<code>cms client</code>。</p>
<p><strong>路由模式分析如下</strong></p>
<p>发布一个页面，需发布到该页面所属的每个站点服务器，其它站点服务器不发布。</p>
<p>比如 发布一个门户的页面，需要发布到每个门户服务器上，而用户中心服务器则不需要发布。</p>
<p>所以本项目采用 <code>routing</code> 模式，用站点 <code>id</code> 作为 <code>routingKey</code>，这样就可以匹配页面只发布到所属的站点服务器上。</p>
<p><strong>页面发布流程图如下</strong></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image2.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image2.png" srcset="/img/loading.gif" alt="image-20200401211714847"></a></p>
<p>1、前端请求 <code>cms</code> 执行页面发布。</p>
<p>2、<code>cms</code> 执行静态化程序生成 <code>html</code>文件。</p>
<p>3、<code>cms</code> 将 <code>html</code> 文件存储到 <code>GridFS</code> 中。</p>
<p>4、<code>cms</code> 向 <code>MQ</code> 发送页面发布消息</p>
<p>5、<code>MQ</code> 将页面发布消息通知给 <code>Cms Client</code></p>
<p>6、<code>Cms Client</code> 从 <code>GridFS</code> 中下载 <code>html</code> 文件</p>
<p>7、<code>Cms Client</code> 将 <code>html</code> 保存到所在服务器指定目录</p>
<h2 id="2-页面发布消费方"><a href="#2-页面发布消费方" class="headerlink" title="2. 页面发布消费方"></a>2. 页面发布消费方</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>功能分析</p>
<p>创建 <code>Cms Client</code> 工程作为页面发布消费方，将 <code>Cms Client</code> 部署在多个服务器上，它负责接收到页面发布 的消息后从 <code>GridFS</code> 中下载文件在本地保存。</p>
<p>需求如下</p>
<p>1、将 <code>cms Client</code> 部署在服务器，配置队列名称和站点 <code>ID</code>。</p>
<p>2、<code>cms Client</code> 连接 <code>RabbitMQ</code> 并监听各自的“页面发布队列”</p>
<p>3、<code>cms Client</code> 接收页面发布队列的消息</p>
<p>4、根据消息中的页面 <code>id</code> 从 <code>mongodb</code> 数据库下载页面到本地</p>
<h3 id="创建Cms-Client工程"><a href="#创建Cms-Client工程" class="headerlink" title="创建Cms Client工程"></a>创建Cms Client工程</h3><h4 id="1、POM配置"><a href="#1、POM配置" class="headerlink" title="1、POM配置"></a>1、POM配置</h4><div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-framework-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../xc-framework-parent/pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-service-manage-cms-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

    <span class="hljs-comment">&lt;!--项目依赖--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-framework-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre></div>

<h4 id="2、配置文件"><a href="#2、配置文件" class="headerlink" title="2、配置文件"></a>2、配置文件</h4><p>在<code>resources</code>下配置 <code>application.yml</code>。</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">31000</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">xc-service-manage-cms-client</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">mongodb:</span>
      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://root:123123@localhost:27017</span>
      <span class="hljs-attr">database:</span> <span class="hljs-string">xc_cms</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span>
  <span class="hljs-attr">freemarker:</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#关闭模板缓存，方便测试</span>
    <span class="hljs-attr">settings:</span>
      <span class="hljs-attr">template_update_delay:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">xuecheng:</span>
  <span class="hljs-attr">mq:</span>
  <span class="hljs-comment">#cms客户端监控的队列名称（不同的客户端监控的队列不能重复）</span>
    <span class="hljs-attr">queue:</span> <span class="hljs-string">queue_cms_postpage_01</span>
    <span class="hljs-attr">routingKey:</span> <span class="hljs-string">5a751fab6abb5044e0d19ea1</span> <span class="hljs-comment">#此routingKey为门户站点ID3</span></code></pre></div>

<p>说明 在配置文件中配置队列的名称，每个 cms client在部署时注意队列名称不要重复</p>
<h4 id="3、启动类"><a href="#3、启动类" class="headerlink" title="3、启动类"></a>3、启动类</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms_client;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.framework"</span>&#125;)<span class="hljs-comment">//扫描common下的所有类</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.manage_cms_client"</span>&#125;)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ManageCmsClientApplication</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        SpringApplication.run(ManageCmsClientApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;
&#125;</code></pre></div>

<h3 id="RabbitmqConfig-配置类"><a href="#RabbitmqConfig-配置类" class="headerlink" title="RabbitmqConfig 配置类"></a>RabbitmqConfig 配置类</h3><p>消息队列设置如下</p>
<p>1、创建 <code>ex_cms_postpage</code> 交换机</p>
<p>2、每个 <code>Cms Client</code> 创建一个队列与交换机绑定</p>
<p>3、每个 <code>Cms Client</code> 程序配置队列名称和 <code>routingKey</code>，将站点ID作为<code>routingKey</code>。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms_client.config;

<span class="hljs-keyword">import</span> org.springframework.amqp.core.*;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitmqConfig</span> </span>&#123;
    <span class="hljs-comment">//队列bean的名称</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_CMS_POSTPAGE = <span class="hljs-string">"queue_cms_postpage"</span>;
    <span class="hljs-comment">//交换机的名称</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_ROUTING_CMS_POSTPAGE = <span class="hljs-string">"ex_routing_cms_postpage"</span>;

    <span class="hljs-comment">//队列的名称</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xuecheng.mq.queue&#125;"</span>)
    <span class="hljs-keyword">public</span> String queue_cms_postpage_name;
    <span class="hljs-comment">//站点id作为routing key</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xuecheng.mq.routingKey&#125;"</span>)
    <span class="hljs-keyword">public</span> String routingKey;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 配置direct交换机</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(EX_ROUTING_CMS_POSTPAGE)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EXCHANGE_DIRECT_INFORM</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_ROUTING_CMS_POSTPAGE).durable(<span class="hljs-keyword">true</span>).build();
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 声明队列</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(QUEUE_CMS_POSTPAGE)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">QUEUE_CMS_POSTPAGE</span><span class="hljs-params">()</span></span>&#123;
        Queue queue = <span class="hljs-keyword">new</span> Queue(queue_cms_postpage_name);
        <span class="hljs-keyword">return</span> queue;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 绑定队列到交换机</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queue</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exchange</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">BINDING_QUEUE_INFORM_SMS</span><span class="hljs-params">(@Qualifier(QUEUE_CMS_POSTPAGE)</span> Queue queue,</span>
<span class="hljs-function">                                            @<span class="hljs-title">Qualifier</span><span class="hljs-params">(EX_ROUTING_CMS_POSTPAGE)</span> Exchange exchange)</span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(routingKey).noargs();
    &#125;


&#125;</code></pre></div>

<p>配置 MongoConfig</p>
<blockquote>
<p>后续的代码中需要将GridFSBucket注入成bean</p>
</blockquote>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms_client.config;


<span class="hljs-keyword">import</span> com.mongodb.MongoClient;
<span class="hljs-keyword">import</span> com.mongodb.client.MongoDatabase;
<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.GridFSBucket;
<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.GridFSBuckets;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoConfig</span> </span>&#123;
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.data.mongodb.database&#125;"</span>)
    String db;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> GridFSBucket <span class="hljs-title">getGridFSBucket</span><span class="hljs-params">(MongoClient mongoClient)</span></span>&#123;
        MongoDatabase database = mongoClient.getDatabase(db);
        GridFSBucket gridFSBucket = GridFSBuckets.create(database);
        <span class="hljs-keyword">return</span> gridFSBucket;
    &#125;
&#125;</code></pre></div>

<h3 id="定义消息格式"><a href="#定义消息格式" class="headerlink" title="定义消息格式"></a>定义消息格式</h3><p>消息内容采用 <code>json</code> 格式存储数据，如下</p>
<p>页面id 发布页面的id</p>
<div class="hljs"><pre><code class="hljs json">&#123;
    <span class="hljs-attr">"pageId"</span>:<span class="hljs-string">""</span>
&#125;</code></pre></div>

<h3 id="PageDao"><a href="#PageDao" class="headerlink" title="PageDao"></a>PageDao</h3><p>1、使用 <code>CmsPageRepository</code> 查询页面信息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CmsPageRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">CmsPage</span>,<span class="hljs-title">String</span>&gt; </span>&#123;&#125;</code></pre></div>

<p>2、使用 <code>CmsSiteRepository</code> 查询站点信息，主要获取站点物理路径</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CmsSiteRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">CmsSite</span>,<span class="hljs-title">String</span>&gt; </span>&#123;&#125;</code></pre></div>

<h3 id="PageService"><a href="#PageService" class="headerlink" title="PageService"></a>PageService</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms_client.service;

<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.GridFSBucket;

<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.GridFSDownloadStream;
<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.model.GridFSFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsPage;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsSite;
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CmsCode;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms_client.dao.CmsPageRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms_client.dao.CmsSiteRepository;
<span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Query;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.gridfs.GridFsResource;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.gridfs.GridFsTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.io.File;
<span class="hljs-keyword">import</span> java.io.FileOutputStream;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageService</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    CmsPageRepository cmsPageRepository;

    <span class="hljs-meta">@Autowired</span>
    CmsSiteRepository cmsSiteRepository;

    <span class="hljs-meta">@Autowired</span>
    GridFsTemplate gridFsTemplate;

    <span class="hljs-meta">@Autowired</span>
    GridFSBucket gridFSBucket;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 将页面html保存到页面物理路径</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageId</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">savePageToServerPath</span><span class="hljs-params">(String pageId)</span></span>&#123;
        Optional&lt;CmsPage&gt; optional = cmsPageRepository.findById(pageId);
        <span class="hljs-comment">//页面不存在则抛出异常</span>
        <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
            ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
        &#125;

        CmsPage cmsPage = optional.get();
        CmsSite cmsSite = <span class="hljs-keyword">this</span>.getCmsSiteById(cmsPage.getSiteId());
        <span class="hljs-keyword">if</span>(cmsSite == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(CmsCode.CMS_SIZE_NOT_EXISTS);
        &#125;

        <span class="hljs-comment">//原讲义和视频中使用的是sizePathysicaiPath,但是SizePage中没有这个字段，使用PageCms中的PathysicaiPath代替</span>
        String pagePath = cmsPage.getPagePhysicalPath() + cmsPage.getPageWebPath() + cmsPage.getPageName();

        <span class="hljs-comment">//获取页面文件id</span>
        String htmlFileId = cmsPage.getHtmlFileId();
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(htmlFileId))&#123;
            ExceptionCast.cast(CmsCode.CMS_PAGE_FILEID_NOT_EXISTS);
        &#125;
        <span class="hljs-comment">//获取文件流</span>
        InputStream inputStream = <span class="hljs-keyword">this</span>.getFileInputStreamFileById(htmlFileId);
        <span class="hljs-keyword">if</span>(inputStream == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_HTML_IS_NULL);
        &#125;

        FileOutputStream fileOutputStream = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(pagePath));
            <span class="hljs-comment">//将文件保存至物理路径</span>
            IOUtils.copy(inputStream,fileOutputStream);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            e.printStackTrace();
        &#125;<span class="hljs-keyword">finally</span> &#123;
            <span class="hljs-comment">//关闭流</span>
            <span class="hljs-keyword">try</span> &#123;
                inputStream.close();
            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
                e.printStackTrace();
            &#125; <span class="hljs-keyword">try</span> &#123;
                fileOutputStream.close();
            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;

    <span class="hljs-comment">//根据文件id获取文件的gridFS输入流</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> InputStream <span class="hljs-title">getFileInputStreamFileById</span><span class="hljs-params">(String fileId)</span></span>&#123;
        GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where(<span class="hljs-string">"_id"</span>).is(fileId)));
        <span class="hljs-comment">//获取gridFs下载流</span>
        GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//获取文件输入流</span>
            GridFsResource gridFsResource = <span class="hljs-keyword">new</span> GridFsResource(gridFSFile, gridFSDownloadStream);
            <span class="hljs-keyword">return</span> gridFsResource.getInputStream();
        &#125;<span class="hljs-keyword">catch</span> (IOException e)&#123;
            e.printStackTrace();
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-comment">//根据站点id得到站点信息</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> CmsSite <span class="hljs-title">getCmsSiteById</span><span class="hljs-params">(String siteId)</span></span>&#123;
        Optional&lt;CmsSite&gt; optional = cmsSiteRepository.findById(siteId);
        <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        CmsSite cmsSite = optional.get();
        <span class="hljs-keyword">return</span> cmsSite;
    &#125;
&#125;</code></pre></div>

<h3 id="ConsumerPostPage"><a href="#ConsumerPostPage" class="headerlink" title="ConsumerPostPage"></a>ConsumerPostPage</h3><p>在 <code>cms client</code> 工程的 <code>mq</code> 包下创建 <code>ConsumerPostPage</code> 类，<code>ConsumerPostPage</code> 作为发布页面的消费客户端，监听页面发布队列的消息，收到消息后从 <code>mongodb</code> 下载文件，保存在本地。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms_client.mq;


<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsPage;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms_client.dao.CmsPageRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms_client.service.PageService;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerPostPage</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ConsumerPostPage<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@Autowired</span>
    CmsPageRepository cmsPageRepository;
    <span class="hljs-meta">@Autowired</span>
    PageService pageService;

    <span class="hljs-meta">@RabbitListener</span>(queues = &#123;<span class="hljs-string">"$&#123;xuecheng.mq.queue&#125;"</span>&#125;) <span class="hljs-comment">//监听队列</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postPage</span><span class="hljs-params">(String msg)</span></span>&#123;
        <span class="hljs-comment">//解析消息</span>
        Map map = JSON.parseObject(msg, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        LOGGER.info(<span class="hljs-string">"receive cms post page:&#123;&#125;"</span>, msg.toString());
        <span class="hljs-comment">//取出页面id</span>
        String pageId = (String) map.get(<span class="hljs-string">"pageId"</span>);

        <span class="hljs-comment">//查询页面信息</span>
        Optional&lt;CmsPage&gt; optional = cmsPageRepository.findById(pageId);
        <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
            LOGGER.error(<span class="hljs-string">"receive cms post page,cmsPage is null: &#123;&#125;"</span>,msg.toString());
        &#125;

        <span class="hljs-comment">//将页面保存到服务器物理路径</span>
        pageService.savePageToServerPath(pageId);
    &#125;
&#125;</code></pre></div>

<h2 id="3-页面发布生产方"><a href="#3-页面发布生产方" class="headerlink" title="3. 页面发布生产方"></a>3. 页面发布生产方</h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p>管理员通过 <code>cms</code> 系统发布 “<strong>页面发布</strong>” 的消费，<code>cms</code> 系统作为页面发布的生产方。<br>需求如下</p>
<p>1、管理员进入管理界面点击“页面发布”，前端请求cms页面发布接口。</p>
<p>2、cms页面发布接口执行页面静态化，并将静态化页面存储至GridFS中。</p>
<p>3、静态化成功后，向消息队列发送页面发布的消息。</p>
<p> 1） 获取页面的信息及页面所属站点ID。</p>
<p> 2） 设置消息内容为页面ID。（采用json格式，方便日后扩展）</p>
<p> 3） 发送消息给 <code>ex_cms_postpage</code> 交换机，并将站点ID作为 <code>routingKey</code>。</p>
<h3 id="RabbitMQ配置"><a href="#RabbitMQ配置" class="headerlink" title="RabbitMQ配置"></a>RabbitMQ配置</h3><p>1、配置 <code>Rabbitmq</code> 的连接参数</p>
<p>在 <code>application.yml</code> 添加如下配置</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">virtualHost:</span> <span class="hljs-string">/</span></code></pre></div>

<p>2、在 <code>pom.xml</code> 添加依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring‐boot‐starter‐amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p>3、<code>RabbitMQConfig</code> 配置</p>
<p>由于 <code>cms</code> 作为页面发布方要面对很多不同站点的服务器，面对很多页面发布队列，所以这里不再配置队列，只需要配置交换机名称即可。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms.config;

<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> org.springframework.amqp.core.Exchange;
<span class="hljs-keyword">import</span> org.springframework.amqp.core.ExchangeBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitmqConfig</span> </span>&#123;
    <span class="hljs-comment">//交换机的名称</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_ROUTING_CMS_POSTPAGE=<span class="hljs-string">"ex_routing_cms_postpage"</span>;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 交换配置使用direct类型</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(EX_ROUTING_CMS_POSTPAGE)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EXCHANGE_TOPICS_INFORM</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_ROUTING_CMS_POSTPAGE).durable(<span class="hljs-keyword">true</span>).build();
    &#125;
&#125;</code></pre></div>

<h3 id="Api-接口"><a href="#Api-接口" class="headerlink" title="Api 接口"></a>Api 接口</h3><p>在api工程定义页面发布接口</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"发布页面"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">post</span><span class="hljs-params">(String pageId)</span></span>;</code></pre></div>

<h3 id="PageService-1"><a href="#PageService-1" class="headerlink" title="PageService"></a>PageService</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms.service;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.GridFSBucket;
<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.GridFSDownloadStream;
<span class="hljs-keyword">import</span> com.mongodb.client.gridfs.model.GridFSFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsPage;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsTemplate;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.request.QueryPageRequest;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.response.CmsPageResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.*;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms.config.RabbitmqConfig;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms.dao.CmsPageRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms.dao.CmsTemplateRepository;
<span class="hljs-keyword">import</span> freemarker.cache.StringTemplateLoader;
<span class="hljs-keyword">import</span> freemarker.template.Configuration;
<span class="hljs-keyword">import</span> freemarker.template.Template;
<span class="hljs-keyword">import</span> freemarker.template.TemplateException;
<span class="hljs-keyword">import</span> io.netty.util.internal.StringUtil;
<span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.bson.types.ObjectId;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.domain.*;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Criteria;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.query.Query;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.gridfs.GridFsResource;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.gridfs.GridFsTemplate;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.ui.freemarker.FreeMarkerTemplateUtils;
<span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageService</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    CmsPageRepository cmsPageRepository;

    <span class="hljs-meta">@Autowired</span>
    RestTemplate restTemplate;

    <span class="hljs-meta">@Autowired</span>
    CmsTemplateRepository templateRepository;

    <span class="hljs-meta">@Autowired</span>
    GridFsTemplate gridFsTemplate;

    <span class="hljs-meta">@Autowired</span>
    GridFSBucket gridFSBucket;

    <span class="hljs-meta">@Autowired</span>
    RabbitTemplate rabbitTemplate;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 页面发布</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">postPage</span><span class="hljs-params">(String pageId)</span> </span>&#123;
        <span class="hljs-comment">//执行静态化</span>
        String pageHtml = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            pageHtml = <span class="hljs-keyword">this</span>.getPageHtml(pageId);
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
        &#125; <span class="hljs-keyword">catch</span> (TemplateException e) &#123;
            e.printStackTrace();
        &#125;
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(pageHtml))&#123;
            ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_HTML_IS_NULL);
        &#125;

        <span class="hljs-comment">//保存静态化文件</span>
        CmsPage cmsPage = <span class="hljs-keyword">this</span>.saveHtml(pageId, pageHtml);
        <span class="hljs-comment">//发送消息</span>
        <span class="hljs-keyword">this</span>.sendPostPage(pageId);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">//发送页面发布消息</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendPostPage</span><span class="hljs-params">(String pageId)</span></span>&#123;
        CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
        CmsPage cmsPage = cmsPageResult.getCmsPage();
        <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
        &#125;
        Map&lt;String, String&gt; msgMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        msgMap.put(<span class="hljs-string">"pageId"</span>,pageId);
        <span class="hljs-comment">//消息内容</span>
        String msg = JSON.toJSONString(msgMap);
        <span class="hljs-comment">//获取站点id作为routing key</span>
        String siteId = cmsPage.getSiteId();
        <span class="hljs-comment">//发送消息到指定交换机、routingKey、以及要发送的消息</span>
        rabbitTemplate.convertAndSend(RabbitmqConfig.EX_ROUTING_CMS_POSTPAGE,siteId,msg);
    &#125;

    <span class="hljs-comment">//保存静态化页面内容</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> CmsPage <span class="hljs-title">saveHtml</span><span class="hljs-params">(String pageId,String content)</span></span>&#123;
        <span class="hljs-comment">//查询页面是否存在</span>
        Optional&lt;CmsPage&gt; optional = cmsPageRepository.findById(pageId);
        <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
            ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
        &#125;

        CmsPage cmsPage = optional.get();
        <span class="hljs-comment">//储存之前先删除</span>
        String htmlFileId = cmsPage.getHtmlFileId();
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(htmlFileId))&#123;
            gridFsTemplate.delete(Query.query(Criteria.where(<span class="hljs-string">"_id"</span>).is(htmlFileId)));
        &#125;
        <span class="hljs-comment">//保存html文件到GridFS</span>
        <span class="hljs-keyword">try</span> &#123;
            InputStream inputStream = IOUtils.toInputStream(content,<span class="hljs-string">"utf-8"</span>);
            ObjectId objectId = gridFsTemplate.store(inputStream, cmsPage.getPageName());
            <span class="hljs-comment">//文件id</span>
            String fileId = objectId.toString();
            <span class="hljs-comment">//将文件id储存到cmspage中</span>
            cmsPage.setHtmlFileId(fileId);
            cmsPageRepository.save(cmsPage);
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
        &#125;

        <span class="hljs-keyword">return</span> cmsPage;
    &#125;


    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 页面静态化</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> TemplateException</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPageHtml</span><span class="hljs-params">(String pageId)</span> <span class="hljs-keyword">throws</span> IOException, TemplateException </span>&#123;
        <span class="hljs-comment">//获取页面模型数据</span>
        Map modelByPageId = <span class="hljs-keyword">this</span>.getModelByPageId(pageId);
        <span class="hljs-keyword">if</span>(modelByPageId == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">//获取页面模型数据为空</span>
            ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_DATA_IS_NULL);
        &#125;
        <span class="hljs-comment">//获取页面模板</span>
        String templateContent = getTemplateByPageId(pageId);
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(templateContent))&#123;
            <span class="hljs-comment">//页面模板为空</span>
            ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_TEMPLATE_IS_NULL);
        &#125;
        <span class="hljs-comment">//构建页面静态化数据</span>
        String html = generateHtml(templateContent, modelByPageId);
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(html))&#123;
            ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_HTML_IS_NULL);
        &#125;
        <span class="hljs-keyword">return</span> html;
    &#125;

    <span class="hljs-comment">//构建静态化页面数据</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">generateHtml</span><span class="hljs-params">(String template,Map model)</span> <span class="hljs-keyword">throws</span> IOException, TemplateException </span>&#123;
        <span class="hljs-comment">//生成配置类</span>
        Configuration configuration = <span class="hljs-keyword">new</span> Configuration(Configuration.getVersion());
        <span class="hljs-comment">//模板加载器</span>
        StringTemplateLoader stringTemplateLoader = <span class="hljs-keyword">new</span> StringTemplateLoader();
        stringTemplateLoader.putTemplate(<span class="hljs-string">"template"</span>,template);
        <span class="hljs-comment">//配置模板加载器</span>
        configuration.setTemplateLoader(stringTemplateLoader);

        <span class="hljs-comment">//获取模板</span>
        Template template1 = configuration.getTemplate(<span class="hljs-string">"template"</span>);
        String html = FreeMarkerTemplateUtils.processTemplateIntoString(template1, model);
        <span class="hljs-keyword">return</span> html;
    &#125;

    <span class="hljs-comment">//获取页面模板文件数据</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getTemplateByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
        <span class="hljs-comment">//查询页面信息</span>
        CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
        CmsPage cmsPage = cmsPageResult.getCmsPage();
        <span class="hljs-comment">//页面不存在</span>
        <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
        &#125;
        <span class="hljs-comment">//获取页面模板数据</span>
        String templateId = cmsPage.getTemplateId();
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(templateId))&#123;
            ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_TEMPLATE_IS_NULL);
        &#125;
        Optional&lt;CmsTemplate&gt; optional = templateRepository.findById(templateId);
        <span class="hljs-keyword">if</span>(optional.isPresent())&#123;
            CmsTemplate cmsTemplate = optional.get();
            <span class="hljs-comment">//获取模板文件id</span>
            String templateFileId = cmsTemplate.getTemplateFileId();
            <span class="hljs-comment">//取出模板文件内容</span>
            GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where(<span class="hljs-string">"_id"</span>).is(templateFileId)));
            <span class="hljs-comment">//打开下载流对象</span>
            GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
            <span class="hljs-comment">//创建GridResource</span>
            GridFsResource gridFsResource = <span class="hljs-keyword">new</span> GridFsResource(gridFSFile, gridFSDownloadStream);

            <span class="hljs-keyword">try</span> &#123;
                String content = IOUtils.toString(gridFsResource.getInputStream(), <span class="hljs-string">"utf-8"</span>);
                <span class="hljs-keyword">return</span> content;
            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-comment">//从dataUrl中获取页面模型数据</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> Map <span class="hljs-title">getModelByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
        <span class="hljs-comment">//查询页面信息</span>
        CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
        CmsPage cmsPage = cmsPageResult.getCmsPage();
        <span class="hljs-comment">//页面不存在</span>
        <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
        &#125;
        <span class="hljs-comment">//取出dataUrl</span>
        String dataUrl = cmsPage.getDataUrl();
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(dataUrl))&#123;
            ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_DATAURL_IS_NULL);
        &#125;
        <span class="hljs-comment">//发送请求获取模型数据</span>
        ResponseEntity&lt;Map&gt; forEntity = restTemplate.getForEntity(dataUrl,Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        Map body = forEntity.getBody();
        <span class="hljs-keyword">return</span> body;
    &#125;


    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 分页查询、页面CURL 部分代码略过，需要请参考前面的章节</span>
<span class="hljs-comment">     */</span>

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据id获取页面数据</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CmsPageResult <span class="hljs-title">cmsPageQueryById</span><span class="hljs-params">(String id)</span> </span>&#123;
        Optional&lt;CmsPage&gt; optional = cmsPageRepository.findById(id);
        <span class="hljs-keyword">if</span> (optional.isPresent()) &#123;
            CmsPage cmsPage = optional.get();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CmsPageResult(CommonCode.SUCCESS, cmsPage);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CmsPageResult(CommonCode.FAIL, <span class="hljs-keyword">null</span>);
    &#125;

&#125;</code></pre></div>

<h2 id="4-页面发布前端"><a href="#4-页面发布前端" class="headerlink" title="4. 页面发布前端"></a>4. 页面发布前端</h2><p>用户操作流程</p>
<p>1、用户进入 <code>cms</code> 页面列表。</p>
<p>2、点击 “<strong>发布</strong>” 请求服务端接口，发布页面。</p>
<p>3、提示 “<strong>发布成功</strong>”，或发布失败。</p>
<h3 id="API方法"><a href="#API方法" class="headerlink" title="API方法"></a>API方法</h3><p>在 cms前端添加 api方法。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/*发布页面*/</span>
export <span class="hljs-keyword">const</span> page_postPage= id =&gt; &#123;
  <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/cms/page/postPage/'</span>+id)
&#125;</code></pre></div>

<h3 id="页面开发"><a href="#页面开发" class="headerlink" title="页面开发"></a>页面开发</h3><p>修改 page_list.vue，添加发布按钮</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐table‐column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"发布"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"80"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot</span>‐<span class="hljs-attr">scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span></span>
<span class="hljs-tag">      <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"postPage(scope.row.pageId)"</span>&gt;</span>发布
    <span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el‐table‐column</span>&gt;</span></code></pre></div>

<p>添加页面发布事件</p>
<div class="hljs"><pre><code class="hljs js">postPage (id) &#123;
  <span class="hljs-keyword">this</span>.$confirm(<span class="hljs-string">'确认发布该页面吗?'</span>, <span class="hljs-string">'提示'</span>, &#123;
  &#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
    cmsApi.page_postPage(id).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
      <span class="hljs-keyword">if</span>(res.success)&#123;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'发布页面id='</span>+id);
        <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">'发布成功，请稍后查看结果'</span>);
      &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'发布失败'</span>);
      &#125;
    &#125;);
  &#125;).catch(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
  &#125;);
&#125;,</code></pre></div>

<h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h2><p>这里测试轮播图页面修改、发布的流程</p>
<p>1、修改轮播图页面模板或修改轮播图地址</p>
<p>注意 先修改页面原型，页面原型调试正常后再修改页面模板。</p>
<p>2、执行页面预览</p>
<p>3、执行页面发布，查看页面是否写到网站目录</p>
<p>4、刷新门户首页并观察轮播图是否变化。</p>
<h2 id="6-思考"><a href="#6-思考" class="headerlink" title="6. 思考"></a>6. 思考</h2><p>1、如果发布到服务器的页面内容不正确怎么办？</p>
<p>2、一个页面需要发布很多服务器，点击“发布”后如何知道详细的发布结果？</p>
<p>3、一个页面发布到多个服务器，其中有一个服务器发布失败时怎么办？</p>
<h1 id="二、课程管理"><a href="#二、课程管理" class="headerlink" title="二、课程管理"></a>二、课程管理</h1><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>在线教育平台的课程信息相当于电商平台的商品。课程管理是后台管理功能中最重要的模块。本项目为教学机构提供课程管理功能，教学机构可以添加属于自己的课程，供学生在线学习。</p>
<p><strong>课程管理包括如下功能需求</strong></p>
<p>1、分类管理<br>2、新增课程<br>3、修改课程<br>4、预览课程<br>5、发布课程</p>
<p><strong>用户的操作流程如下</strong></p>
<p><strong>1、进入我的课程</strong></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image3.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image3.png" srcset="/img/loading.gif" alt="image-20200401214528987"></a></p>
<p><strong>2、点击“添加课程”，进入添加课程界面</strong></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image4.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image4.png" srcset="/img/loading.gif" alt="image-20200401214540896"></a></p>
<p><strong>3、输入课程基本信息，点击提交</strong></p>
<p><strong>4、课程基本信息提交成功，自动进入“管理课程”界面，点击“管理课程”也可以进入“管理课程”界面</strong></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image5.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image5.png" srcset="/img/loading.gif" alt="image-20200401214605318"></a></p>
<p><strong>5、编辑图片上传课程图片。</strong></p>
<p><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image6.png" srcset="/img/loading.gif" alt="image-20200401214657046"></p>
<p><strong>6、编辑课程营销信息</strong></p>
<p>营销信息主要是设置课程的收费方式及价格。</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image7.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image7.png" srcset="/img/loading.gif" alt="image-20200401214707765"></a></p>
<p><strong>7、编辑课程计划</strong></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image8.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image8.png" srcset="/img/loading.gif" alt="image-20200401214718496"></a></p>
<h2 id="2-教学方法"><a href="#2-教学方法" class="headerlink" title="2. 教学方法"></a>2. 教学方法</h2><p>本模块对课程信息管理功能的教学方法采用实战教学方法，旨在通过实战提高接口编写的能力，具体教学方法如下：</p>
<p>1、前后端工程导入</p>
<p>教学管理前端工程采用与系统管理工程相同的技术，直接导入后在此基础上开发。<br>课程管理服务端工程采用Spring Boot技术构建，技术层技术使用Spring data Jpa（与Spring data Mongodb类<br>似）、Mybatis，直接导入后在此基础上开发。</p>
<p>2、课程计划功能</p>
<p>课程计划功能采用全程教学。</p>
<p>3、我的课程、新增课程、修改课程、课程营销</p>
<p>我的课程、新增课程、修改课程、课程营销四个功能采用实战方式，课堂上会讲解每个功能的需求及技术点，讲解完成学生开始实战，由导师进行技术指导。</p>
<p>4、参考文档</p>
<p>实战结束提供每个功能的开发文档，学生参考文档并修正功能缺陷。</p>
<h2 id="3-环境搭建"><a href="#3-环境搭建" class="headerlink" title="3. 环境搭建"></a>3. 环境搭建</h2><h3 id="1、搭建数据库环境"><a href="#1、搭建数据库环境" class="headerlink" title="1、搭建数据库环境"></a>1、搭建数据库环境</h3><ol>
<li><strong>创建数据库</strong></li>
</ol>
<p>课程管理使用 <code>MySQL</code> 数据库，创建课程管理数据库：<code>xc_course</code>。</p>
<p>导入 <code>xc_course.sql</code> 脚本</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image9.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image9.png" srcset="/img/loading.gif" alt="image-20200401215113957"></a></p>
<ol>
<li><strong>数据表介绍</strong></li>
</ol>
<p>课程信息内容繁多，将课程信息分类保存在如下表中：</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image10.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image10.png" srcset="/img/loading.gif" alt="image-20200401215204860"></a></p>
<p>分类储存既可以提高解耦合度，也可以保证数据的完整性。</p>
<p>数据表结构如下：</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image11.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image11.png" srcset="/img/loading.gif" alt="image-20200401215300618"></a></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image12.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image12.png" srcset="/img/loading.gif" alt="image-20200401215305777"></a></p>
<p><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image13.png" srcset="/img/loading.gif" alt="image-20200401215310490"></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image14.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image14.png" srcset="/img/loading.gif" alt="image-20200401215313716"></a></p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image15.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image15.png" srcset="/img/loading.gif" alt="image-20200401215316397"></a></p>
<h3 id="2、导入课程管理服务工程"><a href="#2、导入课程管理服务工程" class="headerlink" title="2、导入课程管理服务工程"></a>2、导入课程管理服务工程</h3><p>1）持久层技术介绍：</p>
<p>课程管理服务使用MySQL数据库存储课程信息，持久层技术如下：</p>
<p>1、spring data jpa：用于表的基本CRUD。</p>
<p>2、mybatis：用于复杂的查询操作。</p>
<p>3、druid：使用阿里巴巴提供的spring boot 整合druid包druid-spring-boot-starter管理连接池。</p>
<blockquote>
<p>druid-spring-boot-starter地址：<a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter" target="_blank" rel="noopener">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a></p>
</blockquote>
<p><strong>为什么持久层用到了 JPA 还要用 Mybatis ？</strong></p>
<p>因为 JPA 是面向对象进行开发的，对于一些复杂的sql操作，优化起来会比较麻烦：</p>
<p>而 Mybatis 是面向sql的，对一些复杂的多表操作比较友好。</p>
<p>导入资料下的 “xc-service-manage-course.zip”。</p>
<h3 id="3、导入课程管理前端工程"><a href="#3、导入课程管理前端工程" class="headerlink" title="3、导入课程管理前端工程"></a>3、导入课程管理前端工程</h3><p>课程管理属于教学管理子系统的功能，使用用户为教学机构的管理人员和老师，为保证系统的可维护性，单独创建一个教学管理前端工程。 教学管理前端工程与系统管理前端的工程结构一样，也采用 <code>vue.js</code> 框架来实现。</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image16.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image16.png" srcset="/img/loading.gif" alt="image-20200401215549740"></a></p>
<p>从课程资料目录拷贝 <code>xc-ui-pc-teach.zip</code> 到工程，使用 <code>webstorm</code> 打开，启动工程</p>
<p>效果图如下：</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image17.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image17.png" srcset="/img/loading.gif" alt="image-20200401215618671"></a></p>
<h1 id="三、课程计划"><a href="#三、课程计划" class="headerlink" title="三、课程计划"></a>三、课程计划</h1><h2 id="1-需求分析-1"><a href="#1-需求分析-1" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>什么是课程计划？</p>
<p>课程计划定义了课程的章节内容，学生通过课程计划进行在线学习，下图中右侧显示的就是课程计划。</p>
<p>课程计划包括两级，第一级是课程的大章节、第二级是大章节下属的小章节，每个小章节通常是一段视频，学生点击小章节在线学习。</p>
<p>教学管理人员对课程计划如何管理？</p>
<p>功能包括：添加课程计划、删除课程计划、修改课程计划等。例如：</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image18.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image18.png" srcset="/img/loading.gif" alt="image-20200401215716660"></a></p>
<h2 id="2-课程计划查询"><a href="#2-课程计划查询" class="headerlink" title="2. 课程计划查询"></a>2. 课程计划查询</h2><p>课程计划查询是将某个课程的课程计划内容完整的显示出来，如下图所示：</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image19.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image19.png" srcset="/img/loading.gif" alt="image-20200401215738194"></a></p>
<p>左侧显示的就是课程计划，课程计划是一个树型结构，方便扩展课程计划的级别。</p>
<p>在上边页面中，点击“添加课程计划”即可对课程计划进行添加操作。</p>
<p>点击修改可对某个章节内容进行修改。</p>
<p>点击删除可删除某个章节。</p>
<h3 id="页面原型"><a href="#页面原型" class="headerlink" title="页面原型"></a>页面原型</h3><h4 id="tree组件介绍"><a href="#tree组件介绍" class="headerlink" title="tree组件介绍"></a>tree组件介绍</h4><p>本功能使用 <code>element-ui</code> 的 <code>tree</code> 组件来完成</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image20.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image20.png" srcset="/img/loading.gif" alt="image-20200401215821019"></a></p>
<p>在 <code>course_plan.vue</code> 文件中添加 <code>tree</code> 组件的代码，进行测试：</p>
<p>1、组件标签</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐tree</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:data</span>=<span class="hljs-string">"data"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">show</span>‐<span class="hljs-attr">checkbox</span></span>
<span class="hljs-tag">      <span class="hljs-attr">node</span>‐<span class="hljs-attr">key</span>=<span class="hljs-string">"id"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">default</span>‐<span class="hljs-attr">expand</span>‐<span class="hljs-attr">all</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:expand</span>‐<span class="hljs-attr">on</span>‐<span class="hljs-attr">click</span>‐<span class="hljs-attr">node</span>=<span class="hljs-string">"false"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:render</span>‐<span class="hljs-attr">content</span>=<span class="hljs-string">"renderContent"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el‐tree</span>&gt;</span></code></pre></div>

<p>2、数据对象</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">let</span> id = <span class="hljs-number">1000</span>;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
    data() &#123;
      <span class="hljs-keyword">return</span> &#123;
        data : [&#123;
          id: <span class="hljs-number">1</span>,
          label: <span class="hljs-string">'一级 1'</span>,
          children: [&#123;
            id: <span class="hljs-number">4</span>,
            label: <span class="hljs-string">'二级 1‐1'</span>,
            children: [&#123;
              id: <span class="hljs-number">9</span>,
              label: <span class="hljs-string">'三级 1‐1‐1'</span>
            &#125;, &#123;
              id: <span class="hljs-number">10</span>,
              label: <span class="hljs-string">'三级 1‐1‐2'</span>
            &#125;]
          &#125;]
        &#125;]
      &#125;
     &#125;
 &#125;</code></pre></div>

<h4 id="webstorm-配置JSX"><a href="#webstorm-配置JSX" class="headerlink" title="webstorm 配置JSX"></a>webstorm 配置JSX</h4><p>本组件用到了JSX语法，如下所示：</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image21.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image21.png" srcset="/img/loading.gif" alt="image-20200401215955630"></a></p>
<p><code>JSX</code> 是 <code>Javascript</code> 和 <code>XML</code> 结合的一种格式，它是 <code>React</code> 的核心组成部分，<code>JSX</code>和<code>XML</code> 语法类似，可以定义属性以及子元素。唯一特殊的是可以用大括号来加入<code>JavaScript</code> 表达式。遇到 <code>HTML</code> 标签（以 &lt; 开头），就用 <code>HTML</code> 规则解析；<br>遇到代码块（以 { 开头），就用 <code>JavaScript</code> 规则解析。</p>
<p>下面是官方的一个例子：</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image22.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/C:%5CUsers%5CMI%5CDesktop%5CHexo%5Csource_posts%5C%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06%5Cimage22.png" srcset="/img/loading.gif" alt="image-20200401220038034"></a></p>
<p>设置方法 如下：</p>
<p>1 、Javascript version 选择 React JSX （如果没有就选择JSX Harmony）</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image23.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image23.png" srcset="/img/loading.gif" alt="image-20200401220056325"></a></p>
<p>2、HTML 类型文件中增加vue</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image24.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image24.png" srcset="/img/loading.gif" alt="image-20200401220104955"></a></p>
<p>preferences -&gt; Editor -&gt; File Types 中找到上边框中HTML 在下边加一个 *.vue</p>
<p>如果已经在 vue template 中已存在.vue 则把它改为.vue2(因为要在Html中添加.vue)</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image25.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image25.png" srcset="/img/loading.gif" alt="image-20200401220120452"></a></p>
<h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p>1、表结构</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image26.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image26.png" srcset="/img/loading.gif" alt="image-20200401220143626"></a></p>
<p>2、模型类</p>
<p>课程计划为树型结构，由树根（课程）和树枝（章节）组成，为了保证系统的可扩展性，在系统设计时将课程计划设置为树型结构。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table</span>(name=<span class="hljs-string">"teachplan"</span>)
<span class="hljs-meta">@GenericGenerator</span>(name = <span class="hljs-string">"jpa‐uuid"</span>, strategy = <span class="hljs-string">"uuid"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Teachplan</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = ‐<span class="hljs-number">916357110051689485L</span>;
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue</span>(generator = <span class="hljs-string">"jpa‐uuid"</span>)
    <span class="hljs-meta">@Column</span>(length = <span class="hljs-number">32</span>)
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String pname;
    <span class="hljs-keyword">private</span> String parentid;
    <span class="hljs-keyword">private</span> String grade;
    <span class="hljs-keyword">private</span> String ptype;
    <span class="hljs-keyword">private</span> String description;
    <span class="hljs-keyword">private</span> String courseid;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> Integer orderby;
    <span class="hljs-keyword">private</span> Double timelength;
    <span class="hljs-keyword">private</span> String trylearn;
&#125;</code></pre></div>

<h4 id="自定义模型类"><a href="#自定义模型类" class="headerlink" title="自定义模型类"></a>自定义模型类</h4><p>前端页面需要树型结构的数据来展示Tree组件，如下：</p>
<div class="hljs"><pre><code class="hljs js">[&#123;
      id: <span class="hljs-number">1</span>,
      label: <span class="hljs-string">'一级 1'</span>,
      children: [&#123;
        id: <span class="hljs-number">4</span>,
        label: <span class="hljs-string">'二级 1‐1'</span>
       &#125;]
     &#125;]</code></pre></div>

<p>自定义课程计划结点类如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TeachplanNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Teachplan</span> </span>&#123;
    List&lt;TeachplanNode&gt; children;
&#125;</code></pre></div>

<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><p>根据课程id查询课程的计划接口如下，在api工程创建 <code>course</code> 包，创建<code>CourseControllerApi</code> 接口类并定义接口方法如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseControllerApi</span> </span>&#123;
    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"课程计划查询"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">findTeachplanList</span><span class="hljs-params">(String courseId)</span></span>;
&#125;</code></pre></div>

<h3 id="课程管理服务"><a href="#课程管理服务" class="headerlink" title="课程管理服务"></a>课程管理服务</h3><h4 id="SQL语句"><a href="#SQL语句" class="headerlink" title="SQL语句"></a>SQL语句</h4><div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>
  a.id one_id,
  a.pname one_pname,
  b.id two_id,
  b.pname two_pname,
  c.id three_id,
  c.pname three_pname
<span class="hljs-keyword">FROM</span>
  teachplan a
  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> teachplan b
    <span class="hljs-keyword">ON</span> a.id = b.parentid
  <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> teachplan c
    <span class="hljs-keyword">ON</span> b.id = c.parentid
<span class="hljs-keyword">WHERE</span> a.parentid = <span class="hljs-string">'0'</span>
  <span class="hljs-keyword">AND</span> a.courseid = <span class="hljs-string">'402885816243d2dd016243f24c030002'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> a.orderby,
  b.orderby,
  c.orderby</code></pre></div>

<h4 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h4><ol>
<li>mapper接口</li>
</ol>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TeachplanMapper</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">selectList</span><span class="hljs-params">(String courseId)</span></span>;
&#125;</code></pre></div>

<p>2）mapper映射文件</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.xuecheng.manage_course.dao.TeachplanMapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"teachplanMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
        <span class="hljs-comment">&lt;!--一级节点--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"one_id"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"one_pname"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"children"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
            <span class="hljs-comment">&lt;!--二级节点--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"two_id"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"two_pname"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"children"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
                <span class="hljs-comment">&lt;!--三级节点--&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_id"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_pname"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-comment">&lt;!--三级菜单查询--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectList"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"teachplanMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.String"</span>&gt;</span>
        SELECT
            a.id one_id,
            a.pname one_pname,
            a.courseid one_course,
            b.id two_id,
            b.pname two_pname,
            c.id three_id,
            c.pname three_pname
        FROM
            teachplan a
        LEFT JOIN teachplan b
            ON b.parentid = a.id
        LEFT JOIN teachplan c
            ON c.parentid = b.id
        WHERE
            a.parentid = '0'
        <span class="hljs-comment">&lt;!--判断参数不为空时才进行参数的匹配--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"_parameter!=null and _parameter!=''"</span>&gt;</span>
            and a.courseid = #&#123;courseId&#125;
        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        ORDER BY a.orderby,
            b.orderby,
            c.orderby
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>

<p>说明：针对输入参数为简单类型 #{}中可以是任意类型，判断参数是否为空要用 _parameter（它属于<code>mybatis</code>的内置参数）</p>
<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseService</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    TeachplanMapper teachplanMapper;
    <span class="hljs-comment">//查询课程计划</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">findTeachplanList</span><span class="hljs-params">(String courseId)</span></span>&#123;
        TeachplanNode teachplanNode = teachplanMapper.selectList(courseId);
        <span class="hljs-keyword">return</span> teachplanNode;
    &#125;
&#125;</code></pre></div>

<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/course"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    CourseService courseService;
    <span class="hljs-comment">//查询课程计划</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/teachplan/list/&#123;courseId&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">findTeachplanList</span><span class="hljs-params">(String courseId)</span> </span>&#123;
        <span class="hljs-keyword">return</span> courseService.findTeachplanList(courseId);
    &#125;
&#125;</code></pre></div>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>使用postman或swagger-ui测试查询接口。</p>
<p>Get 请求：<a href="http://localhost:31200/course/teachplan/list/402885816243d2dd016243f24c030002" target="_blank" rel="noopener">http://localhost:31200/course/teachplan/list/402885816243d2dd016243f24c030002</a></p>
<h3 id="前端页面"><a href="#前端页面" class="headerlink" title="前端页面"></a>前端页面</h3><h4 id="API方法-1"><a href="#API方法-1" class="headerlink" title="API方法"></a>API方法</h4><p>定义课程计划查询的api方法：</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/*查询课程计划*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> findTeachplanList = <span class="hljs-function"><span class="hljs-params">courseid</span> =&gt;</span> &#123;
  <span class="hljs-keyword">return</span> http.requestQuickGet(apiUrl+<span class="hljs-string">'/course/teachplan/list/'</span>+courseid)
&#125;</code></pre></div>

<h4 id="Api调用"><a href="#Api调用" class="headerlink" title="Api调用"></a>Api调用</h4><ol>
<li>在 <code>mounted</code> 钩子方法 中查询 课程计划<br>定义查询课程计划的方法，赋值给数据对象 <code>teachplanList</code></li>
</ol>
<div class="hljs"><pre><code class="hljs js">findTeachplan()&#123;
    courseApi.findTeachplanList(<span class="hljs-keyword">this</span>.courseid).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span>&#123;
    <span class="hljs-keyword">this</span>.teachplanList = [];<span class="hljs-comment">//清空树</span>
    <span class="hljs-keyword">if</span>(res.children)&#123;
    <span class="hljs-keyword">this</span>.teachplanList = res.children;
    &#125;
&#125;);
&#125;</code></pre></div>

<p>2）在mounted钩子中查询课程计划</p>
<div class="hljs"><pre><code class="hljs js">mounted()&#123; 
  <span class="hljs-comment">//课程id</span>
  <span class="hljs-keyword">this</span>.courseid = <span class="hljs-keyword">this</span>.$route.params.courseid;
  <span class="hljs-comment">//课程计划</span>
  <span class="hljs-keyword">this</span>.findTeachplan();
&#125;</code></pre></div>

<p>3）修改树结点的标签属性</p>
<p>课程计划信息中 <code>pname</code> 为结点的名称，需要修改树结点的标签属性方可正常显示课程计划名称，如下：</p>
<div class="hljs"><pre><code class="hljs js">defaultProps: &#123; 
  children: <span class="hljs-string">'children'</span>,
  label: <span class="hljs-string">'pname'</span>
&#125;</code></pre></div>

<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><p><a href="https://qnoss.codeyee.com/20200706_Ng==/image27.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image27.png" srcset="/img/loading.gif" alt="image-20200401221133565"></a></p>
<h2 id="3-添加课程计划"><a href="#3-添加课程计划" class="headerlink" title="3. 添加课程计划"></a>3. 添加课程计划</h2><h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a>需求分析</h3><p>用户操作流程</p>
<p>1 、进入课程计划页面，点击“添加课程计划”</p>
<p>2、打开添加课程计划页面，输入课程计划信息</p>
<p><a href="https://qnoss.codeyee.com/20200706_Ng==/image28.png" target="_blank" rel="noopener"><img src="/2020/08/12/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday06/image28.png" srcset="/img/loading.gif" alt="image-20200401221202889"></a></p>
<p><strong>上级结点说明</strong>：</p>
<p>如果不选择上级节点的话，表示当前添加的课程计划的父节点作为该课程的根节点，也就是说，添加的是二级菜单，如果选择了上级节点，表示添加的是三级菜单，如果添加该课程时，在课程计划中没有该课程的根节点时，要自动将该课程设置为根节点。</p>
<h4 id="页面原型说明"><a href="#页面原型说明" class="headerlink" title="页面原型说明"></a>页面原型说明</h4><p>添加课程计划采用弹出窗口组件Dialog。</p>
<p>1、视图部分</p>
<p>在course_plan.vue页面添加添加课程计划的弹出窗口代码：</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐dialog</span> <span class="hljs-attr">title</span>=<span class="hljs-string">" 添加课程计划"</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"teachplayFormVisible"</span> &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el‐form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"teachplayForm"</span>  <span class="hljs-attr">:model</span>=<span class="hljs-string">"teachplanActive"</span> <span class="hljs-attr">label</span>‐<span class="hljs-attr">width</span>=<span class="hljs-string">"140px"</span></span>
<span class="hljs-tag"><span class="hljs-attr">style</span>=<span class="hljs-string">"width:600px;"</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">"teachplanRules"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"上级结点"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐select</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">model</span>=<span class="hljs-string">"teachplanActive.parentid"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"不填表示根结点"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el‐option</span></span>
<span class="hljs-tag">              <span class="hljs-attr">v</span>‐<span class="hljs-attr">for</span>=<span class="hljs-string">"item in teachplanList"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:label</span>=<span class="hljs-string">"item.pname"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:value</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el‐option</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el‐select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"章节/课时名称"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"pname"</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">el‐input</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">model</span>=<span class="hljs-string">"teachplanActive.pname"</span> <span class="hljs-attr">auto</span>‐<span class="hljs-attr">complete</span>=<span class="hljs-string">"off"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el‐input</span>&gt;</span> 
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"课程类型"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐radio‐group</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">model</span>=<span class="hljs-string">"teachplanActive.ptype"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el‐radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'1'</span>&gt;</span>视频<span class="hljs-tag">&lt;/<span class="hljs-name">el‐radio</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el‐radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'2'</span>&gt;</span>文档<span class="hljs-tag">&lt;/<span class="hljs-name">el‐radio</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el‐radio‐group</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"学习时长（分钟）  请输入数字"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">model</span>=<span class="hljs-string">"teachplanActive.timelength"</span> <span class="hljs-attr">auto</span>‐<span class="hljs-attr">complete</span>=<span class="hljs-string">"off"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el‐</span></span>
<span class="hljs-tag"><span class="hljs-attr">input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"排序字段"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐input</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">model</span>=<span class="hljs-string">"teachplanActive.orderby"</span> <span class="hljs-attr">auto</span>‐<span class="hljs-attr">complete</span>=<span class="hljs-string">"off"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el‐input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"章节/课时介绍"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"description"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"textarea"</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">model</span>=<span class="hljs-string">"teachplanActive.description"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el‐input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"状态"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"status"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐radio‐group</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">model</span>=<span class="hljs-string">"teachplanActive.status"</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el‐radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"0"</span> &gt;</span>未发布<span class="hljs-tag">&lt;/<span class="hljs-name">el‐radio</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el‐radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'1'</span>&gt;</span>已发布<span class="hljs-tag">&lt;/<span class="hljs-name">el‐radio</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el‐radio‐group</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐form‐item</span>  &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">on:click</span>=<span class="hljs-string">"addTeachplan"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">on:click</span>=<span class="hljs-string">"resetForm"</span>&gt;</span>重置<span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form‐item</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el‐form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el‐dialog</span>&gt;</span></code></pre></div>

<p>2、数据模型</p>
<p>在数据模型中添加如下变量：</p>
<div class="hljs"><pre><code class="hljs js">teachplayFormVisible:<span class="hljs-literal">false</span>,
teachplanRules: &#123;
        pname: [
            &#123;<span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入课程计划名称'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>&#125;
        ],
            status: [
                &#123;<span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请选择状态'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span>&#125;
            ]
&#125;,
teachplanActive:&#123;&#125;,</code></pre></div>

<p>3、 添加按钮</p>
<p>通过变量 <code>teachplayFormVisible</code> 控制弹出窗口是否显示。</p>
<div class="hljs"><pre><code class="hljs vue">&lt;el‐button type&#x3D;&quot;primary&quot; @click&#x3D;&quot;teachplayFormVisible &#x3D; true&quot;&gt; 添加课程计划&lt;&#x2F;el‐button&gt;</code></pre></div>

<p>4、定义表单提交方法和重置方法</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">// 提交课程计划</span>
addTeachplan()&#123;
    alert()
&#125;,
<span class="hljs-comment">//重置表单</span>
resetForm()&#123;
  <span class="hljs-keyword">this</span>.teachplanActive = &#123;&#125;
&#125;,</code></pre></div>

<h3 id="API接口-1"><a href="#API接口-1" class="headerlink" title="API接口"></a>API接口</h3><p>1）添加课程计划</p>
<div class="hljs"><pre><code class="hljs java">ApiOperation(<span class="hljs-string">"添加课程计划"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">addTeachplan</span><span class="hljs-params">(Teachplan teachplan)</span></span>;</code></pre></div>

<h3 id="课程管理服务-1"><a href="#课程管理服务-1" class="headerlink" title="课程管理服务"></a>课程管理服务</h3><h4 id="DAO层"><a href="#DAO层" class="headerlink" title="DAO层"></a>DAO层</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TeachplanRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">Teachplan</span>, <span class="hljs-title">String</span>&gt; </span>&#123; 
   <span class="hljs-comment">//定义方法根据课程id和父结点id查询出结点列表，可以使用此方法实现查询根结点</span>
   <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Teachplan&gt; <span class="hljs-title">findByCourseidAndParentid</span><span class="hljs-params">(String courseId,String parentId)</span></span>;
&#125;</code></pre></div>

<h4 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_course.service;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CourseBase;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.Teachplan;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.ext.TeachplanNode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.ResponseResult;
<span class="hljs-keyword">import</span> com.xuecheng.manage_course.dao.CourseBaseRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_course.dao.TeachplanMapper;
<span class="hljs-keyword">import</span> com.xuecheng.manage_course.dao.TeachplanRepository;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.springframework.beans.BeanUtils;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseService</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    TeachplanMapper teachplanMapper;
    <span class="hljs-meta">@Autowired</span>
    CourseBaseRepository courseBaseRepository;
    <span class="hljs-meta">@Autowired</span>
    TeachplanRepository teachplanRepository;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 添加课程计划</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> teachplan</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">//增删改操作都需要加spring事务</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">addTeachplan</span><span class="hljs-params">(Teachplan teachplan)</span> </span>&#123;
        <span class="hljs-comment">//校验课程id和课程计划名称</span>
        <span class="hljs-keyword">if</span>(teachplan == <span class="hljs-keyword">null</span>|| StringUtils.isEmpty(teachplan.getCourseid()) || StringUtils.isEmpty(teachplan.getPname()))&#123;
            ExceptionCast.cast(CommonCode.INVALID_PARAM);
        &#125;

        <span class="hljs-comment">//取出课程id</span>
        String courseId = teachplan.getCourseid();
        <span class="hljs-comment">//取出父节点id</span>
        String parentId = teachplan.getParentid();
        String newTeachplanGrade = <span class="hljs-string">"3"</span>;  <span class="hljs-comment">//设置新节点的菜单等级</span>

        <span class="hljs-comment">// 如果用户未在添加时候未选择根节点,表示需要添加的是一个二级菜单，并且默认添加到当前课程的根节点下</span>
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(parentId))&#123;
            newTeachplanGrade = <span class="hljs-string">"2"</span>;
            <span class="hljs-comment">//根据课程id取根节点的id</span>
            parentId = <span class="hljs-keyword">this</span>.getTeachplanRoot(courseId);
            <span class="hljs-keyword">if</span>(StringUtils.isEmpty(parentId))&#123;
                ExceptionCast.cast(CommonCode.INVALID_PARAM);
            &#125;
        &#125;

        <span class="hljs-comment">//创建新节点</span>
        Teachplan teachplanNew = <span class="hljs-keyword">new</span> Teachplan();
        <span class="hljs-comment">//将传入的节点信息赋值到新节点内</span>
        BeanUtils.copyProperties(teachplan,teachplanNew);
        teachplanNew.setParentid(parentId);
        teachplanNew.setCourseid(courseId);

        <span class="hljs-comment">/* 设置新节点的级别</span>
<span class="hljs-comment">            方法1：根据父节点的级别进行设置，父节点级别为1，当前则为2，为2则当前为3</span>
<span class="hljs-comment">            方法2：在判断前端传入的父节点是否为空时进行设置，如果为空，表示需求为添加二级节点，设置2</span>
<span class="hljs-comment">                  如果不为空，则表示要添加的是三级节点，设置为3，与方法1相比可以减少一次查询。</span>
<span class="hljs-comment">         */</span>
        teachplanNew.setGrade(newTeachplanGrade); <span class="hljs-comment">//节点级别，根据父节点的级别进行设置</span>
        teachplanRepository.save(teachplanNew);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">//根据课程id获取课程根节点id，如果根节点不存在 则创建一个根节点，并作为该课程的根节点</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getTeachplanRoot</span><span class="hljs-params">(String courseId)</span></span>&#123;
        <span class="hljs-comment">//校验课程id</span>
        Optional&lt;CourseBase&gt; optional = courseBaseRepository.findById(courseId);
        <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        CourseBase courseBase = optional.get();
        <span class="hljs-comment">//取出一级根节点菜单</span>
        List&lt;Teachplan&gt; teachplanList = teachplanRepository.findByCourseidAndParentid(courseId, <span class="hljs-string">"0"</span>);

        <span class="hljs-comment">//如果根节点不存在，则新增一个节点，并且作为该课程的根节点</span>
        <span class="hljs-keyword">if</span>(teachplanList == <span class="hljs-keyword">null</span> || teachplanList.size() == <span class="hljs-number">0</span>)&#123;
            <span class="hljs-comment">//新增一个节点</span>
            Teachplan teachplanNewRoot = <span class="hljs-keyword">new</span> Teachplan();
            teachplanNewRoot.setCourseid(courseId);
            teachplanNewRoot.setPname(courseBase.getName());
            teachplanNewRoot.setCourseid(courseId);
            teachplanNewRoot.setGrade(<span class="hljs-string">"1"</span>); <span class="hljs-comment">//1级菜单</span>
            teachplanNewRoot.setStatus(<span class="hljs-string">"0"</span>); <span class="hljs-comment">//未发布</span>
            teachplanRepository.save(teachplanNewRoot);
            <span class="hljs-keyword">return</span> teachplanNewRoot.getId();
        &#125;
        Teachplan teachplan = teachplanList.get(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> teachplan.getId();
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询课程计划</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">findTeachplanList</span><span class="hljs-params">(String courseId)</span></span>&#123;
        TeachplanNode teachplanNode = teachplanMapper.selectList(courseId);
        <span class="hljs-keyword">return</span> teachplanNode;
    &#125;
&#125;</code></pre></div>

<h4 id="Controller层"><a href="#Controller层" class="headerlink" title="Controller层"></a>Controller层</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_course.controller;

<span class="hljs-keyword">import</span> com.xuecheng.api.course.CourseControllerApi;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.Teachplan;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.ext.TeachplanNode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.ResponseResult;
<span class="hljs-keyword">import</span> com.xuecheng.manage_course.service.CourseService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/course"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    CourseService courseService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/teachplan/list/&#123;courseId&#125;"</span>)
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">findTeachplanList</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
        <span class="hljs-keyword">return</span> courseService.findTeachplanList(courseId);
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/teachplan/add"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">addTeachplan</span><span class="hljs-params">(@RequestBody Teachplan teachplan)</span> </span>&#123;
        <span class="hljs-keyword">return</span> courseService.addTeachplan(teachplan);
    &#125;
&#125;</code></pre></div>

<h4 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h4><p>复杂一些的业务逻辑建议写完服务端代码就进行单元测试。</p>
<p>使用<code>swagger-ui</code> 或<code>postman</code>测试上边的课程计划添加接口。</p>
<h3 id="前端Api调用"><a href="#前端Api调用" class="headerlink" title="前端Api调用"></a>前端Api调用</h3><p>1、定义 api方法</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/* 添加课程计划*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> addTeachplan = <span class="hljs-function"><span class="hljs-params">teachplah</span> =&gt;</span> &#123;
  <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/course/teachplan/add'</span>,teachplah)
&#125;</code></pre></div>

<p>2、调用 api</p>
<div class="hljs"><pre><code class="hljs js">addTeachplan()&#123;
  <span class="hljs-keyword">this</span>.$refs.teachplayForm.validate(<span class="hljs-function">(<span class="hljs-params">valid</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">if</span> (valid) &#123;
      <span class="hljs-comment">//添加课程计划时带上课程id</span>
      <span class="hljs-keyword">this</span>.teachplanActive.courseid = <span class="hljs-keyword">this</span>.courseid;
      courseApi.addTeachplan(<span class="hljs-keyword">this</span>.teachplanActive).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
          <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">'提交成功'</span>);
          <span class="hljs-comment">//清空表单</span>
          <span class="hljs-keyword">this</span>.teachplanActive = &#123;&#125;
          <span class="hljs-comment">//刷新整个树</span>
          <span class="hljs-keyword">this</span>.findTeachplan();
          &#125;<span class="hljs-keyword">else</span>&#123;
          <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'提交失败'</span>);
        &#125;
      &#125;);
    &#125;
  &#125;)
&#125;,</code></pre></div>

<h3 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h3><p>测试流程：</p>
<p>1、新建一个课程</p>
<p>2、向新建课程中添加课程计划</p>
<p> 添加一级结点</p>
<p> 添加二级结点</p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/GridFS/">GridFS</a>
                    
                      <a class="hover-with-bg" href="/tags/RabbitMQ/">RabbitMQ</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/13/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday07/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线day07</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/11/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday05/">
                        <span class="hidden-mobile">学成在线day05</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

代码块js 用不到，fulid自带有，添加css样式即可实现
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键字</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "本站勉强运行&nbsp"+dnum+"&nbsp天";
      document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证123456号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备12345678号</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "学成在线day06&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
