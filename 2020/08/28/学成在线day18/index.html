<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>学成在线day18：基于oauth2实现RBAC认证授权、微服务间认证实现 - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>私人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-28 15:56">
      2020-08-28
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      118
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="😎知识点概览"><a href="#😎知识点概览" class="headerlink" title="😎知识点概览"></a>😎知识点概览</h1><blockquote>
<p>为了方便后续回顾该项目时能够清晰的知道本章节讲了哪些内容，并且能够从该章节的笔记中得到一些帮助，所以在完成本章节的学习后在此对本章节所涉及到的知识点进行总结概述。</p>
</blockquote>
<p>本章节为【学成在线】项目的 <code>day18</code> 的内容</p>
<ul>
<li>基于方法的权限校验</li>
<li>基于 <code>RBAC</code> 进行用户权限配置以及动态查询。</li>
<li>根据教师所属的公司来实现课程信息查询的细粒度授权。也就是 <code>A</code> 公司的老师只能查询到 <code>A</code> 公司下的课程。</li>
<li>使用 <code>Feign</code> 拦截器实现获取前端请求中的 header 信息，并将 <code>header</code> 中带有的 jwt 令牌向下传递，实现微服务间的远程调用的认证授权。</li>
</ul>
<h1 id="一、用户授权业务流程"><a href="#一、用户授权业务流程" class="headerlink" title="一、用户授权业务流程"></a>一、用户授权业务流程</h1><p>用户授权的业务流程如下：</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image1.png" srcset="/img/loading.gif" alt="image-20200601102646580"></p>
<p>业务流程说明如下：</p>
<p>1、用户认证通过，认证服务向浏览器 <code>cookie</code> 写入 <code>token</code>（ 身份令牌）</p>
<p>2、前端携带 <code>token</code> 请求用户中心服务获取jwt令牌，前端获取到jwt令牌解析，并存储在<code>sessionStorage</code></p>
<p>3、前端携带 <code>cookie</code> 中的身份令牌及jwt令牌访问资源服务</p>
<p>前端请求资源服务需要携带两个 <code>token</code>，一个是 <code>cookie</code> 中的身份令牌，一个是 <code>http header</code>中的 <code>jwt</code>，前端请求资源服务前在 <code>http header</code>上添加 <code>jwt</code> 请求资源</p>
<p>4、网关校验 <code>token</code> 的合法性</p>
<p>用户请求必须携带身份令牌和jwt令牌。</p>
<p>网关校验 <code>redis</code> 中 <code>user_token</code> 的有效期，已过期则要求用户重新登录。</p>
<p>5、资源服务校验 <code>jwt</code> 的合法性并进行授权</p>
<p>资源服务校验 <code>jwt</code> 令牌，完成授权，拥有权限的方法正常执行，没有权限的方法将拒绝访问。</p>
<h1 id="二、基于方法授权"><a href="#二、基于方法授权" class="headerlink" title="二、基于方法授权"></a>二、基于方法授权</h1><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>方法授权要完成的是 <code>资源服务</code> 根据 jwt 令牌完成对方法的授权，具体流程如下：</p>
<p>1、生成 <code>Jwt</code> 令牌时在令牌中写入用户所拥有的权限</p>
<p>我们给每个权限起个名字，例如某个用户拥有如下权限：</p>
<p>course_find_list：课程查询</p>
<p>course_pic_list：课程图片查询</p>
<p>2、在资源服务方法上添加注解 <code>@PreAuthorize</code>，并指定此方法所需要的权限</p>
<blockquote>
<p>@PreAuthorize 注解是由Spring Security 提供的一个权限校验注解</p>
</blockquote>
<p>例如下边是课程管理接口方法的授权配置，它就表示要执行这个方法需要拥有 <code>course_find_list</code> 权限。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_find_list')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResult&lt;CourseInfo&gt; <span class="hljs-title">findCourseList</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,</span>
<span class="hljs-function">                                              @<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size,</span>
<span class="hljs-function">                                              CourseListRequest courseListRequest)</span></code></pre></div>

<p>3、当请求有权限的方法时正常访问</p>
<p>4、当请求没有权限的方法时则拒绝访问</p>
<h2 id="2-jwt令牌包含权限"><a href="#2-jwt令牌包含权限" class="headerlink" title="2. jwt令牌包含权限"></a>2. jwt令牌包含权限</h2><p>修改认证服务的 <code>UserDetailServiceImpl</code> 类，下边的代码中 <code>permissionList</code> 列表中存放了用户的权限，并且将权限标识按照中间使用逗号分隔的语法组成一个字符串，最终提供给 <code>Spring security</code></p>
<p>核心的代码如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//指定用户的权限，这里暂时硬编码</span>
List&lt;String&gt; permissionList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
permissionList.add(<span class="hljs-string">"course_base_list"</span>);
permissionList.add(<span class="hljs-string">"course_pic_list"</span>);
 
<span class="hljs-comment">//将权限串中间以逗号分隔</span>
String user_permission_string = StringUtils.join(permissionList.toArray(), <span class="hljs-string">","</span>);
<span class="hljs-comment">//设置用户信息到userDetails对象</span>
UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(
    username,
    password,
    AuthorityUtils.commaSeparatedStringToAuthorityList(user_permission_string));</code></pre></div>

<p>在上述的代码当中，通过向 <code>permissionList</code> 添加标识来对用户的进行授权，这里我们暂时对用户的权限的内容进行硬编码，后面的章节中用户的权限信息会从数据库中获取。</p>
<p>全部代码如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;
    <span class="hljs-comment">//取出身份，如果身份为空说明没有认证</span>
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    <span class="hljs-comment">//没有认证统一采用httpbasic认证，httpbasic中存储了client_id和client_secret</span>
    <span class="hljs-comment">//开始认证client_id和client_secret</span>
    <span class="hljs-keyword">if</span>(authentication==<span class="hljs-keyword">null</span>)&#123;
        ClientDetails clientDetails = clientDetailsService.loadClientByClientId(username);
        <span class="hljs-keyword">if</span>(clientDetails!=<span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">//密码</span>
            String clientSecret = clientDetails.getClientSecret();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username,clientSecret,AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">""</span>));
        &#125;
    &#125;
    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(username)) &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
 
    <span class="hljs-comment">//请求ucenter查询用户</span>
    XcUserExt userext = userClient.getUserext(username);
    <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>; <span class="hljs-comment">//如果获取到的用信息为空,则返回null,spring security则会抛出异常</span>
 
    <span class="hljs-comment">//设置用户的认证和权限信息</span>
    userext.setUsername(<span class="hljs-string">"itcast"</span>);
    userext.setPassword(<span class="hljs-keyword">new</span> BCryptPasswordEncoder().encode(<span class="hljs-string">"123"</span>));
    userext.setPermissions(<span class="hljs-keyword">new</span> ArrayList&lt;XcMenu&gt;());  <span class="hljs-comment">//这里授权部分还没完成,所以先填写静态的</span>
 
    <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
 
    <span class="hljs-comment">//从数据库查询用户正确的密码，Spring Security会去比对输入密码的正确性</span>
    String password = userext.getPassword();
 
    <span class="hljs-comment">//指定用户的权限，这里暂时硬编码</span>
    List&lt;String&gt; permissionList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    permissionList.add(<span class="hljs-string">"course_base_list"</span>);
    permissionList.add(<span class="hljs-string">"course_pic_list"</span>);
 
    <span class="hljs-comment">//将权限串中间以逗号分隔</span>
    String user_permission_string = StringUtils.join(permissionList.toArray(), <span class="hljs-string">","</span>);
    <span class="hljs-comment">//设置用户信息到userDetails对象</span>
    UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(
        username,
        password,
        AuthorityUtils.commaSeparatedStringToAuthorityList(user_permission_string));
    <span class="hljs-comment">//用户id</span>
    userDetails.setId(userext.getId());
    <span class="hljs-comment">//用户名称</span>
    userDetails.setName(userext.getName());
    <span class="hljs-comment">//用户头像</span>
    userDetails.setUserpic(userext.getUserpic());
    <span class="hljs-comment">//用户所属企业id</span>
    userDetails.setCompanyId(userext.getCompanyId());
 
    <span class="hljs-comment">//返回用信息给到Spring Security进行处理</span>
    <span class="hljs-keyword">return</span> userDetails;
&#125;</code></pre></div>

<p>重启认证服务工程，使用 <code>postman</code> 完成登录，获取到用户令牌</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image2.png" srcset="/img/loading.gif" alt="image-20200601114112301"></p>
<p>从 <code>redis</code> 中找到该用户令牌对应的 <code>jwt</code> 令牌。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image3.png" srcset="/img/loading.gif" alt="image-20200601114257044"></p>
<p>使用 <code>jwt</code> 的测试程序查看 此令牌的内容。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image4.png" srcset="/img/loading.gif" alt="image-20200601114334352"></p>
<p>可以看到 <code>authorities</code> 属性中为用户的权限。</p>
<h2 id="3-方法授权实现"><a href="#3-方法授权实现" class="headerlink" title="3. 方法授权实现"></a>3. 方法授权实现</h2><p><strong>1、资源服务添加权限控制</strong></p>
<p>要想在资源服务使用方法授权，首先在 <code>资源服务</code> 配置授权控制，流程如下</p>
<p>1）添加 <code>spring-cloud-starter-oauth2</code> 依赖。</p>
<p>2）拷贝授权配置类 <code>ResourceServerConfig</code>。</p>
<p>3）拷贝公钥。</p>
<p><strong>2、方法上添加注解</strong></p>
<p>通常情况下，程序员编写在资源服务的 <code>controller</code> 方法时会使用注解指定此方法的权限标识。</p>
<p>为什么不在 <code>Service</code> 或者 <code>Dao</code>上定义？因为 Service 和 Dao的方法有可能是公用的，而 <code>Controller</code> 通常都是最外层的，所以不会涉及到被其他服务依赖的情况。</p>
<p>下面我们在 <code>获取课程的图片</code> 和 <code>删除课程图</code> 的接口中使用 <code>@PreAuthorize</code> 注解进行权限的设置，试下以下功能</p>
<ul>
<li>访问 getCoursePic 需要授权 course_pic_list 权限</li>
<li>访问 deleteCoursePic 需要授权 course_pic_delete 权限</li>
</ul>
<p>而我们要注意的是，我们在前面的认证当中，只为用分配了 course_pic_list 的权限，配置完后我们来进行测试。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据课程id获取该课程的课程图片信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 由于这里每个课程只有一个图片，所以只返回一个 CoursePic 对象</span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_pic_list')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coursepic/get/&#123;courseId&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CoursePic <span class="hljs-title">getCoursePic</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.getCoursePic(courseId);
&#125;
 
<span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 删除课程图片信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
 
<span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_pic_delete')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@DeleteMapping</span>(<span class="hljs-string">"/coursepic/delete"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">deleteCoursePic</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.deleteCoursePic(courseId);
&#125;</code></pre></div>

<p>3、在资源服务（这里是课程管理）的 <code>ResourceServerConfig</code> 类上添加注解，激活方法上添加授权注解</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//激活方法上的PreAuthorize注解</span>
<span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>, securedEnabled = <span class="hljs-keyword">true</span>)</code></pre></div>

<h2 id="4-方法授权测试"><a href="#4-方法授权测试" class="headerlink" title="4. 方法授权测试"></a>4. 方法授权测试</h2><p>重启课程管理服务，测试上边两个方法。</p>
<p>使用 <code>postman</code> 测试，测试前执行登录，并且将 <code>jwt</code> 令牌（access_token）添加到 <code>header</code>。</p>
<p>发送GET请求到以下链接</p>
<p><a href="http://www.xuecheng.com/api/course/coursepic/get/4028e58161bd22e60161bd23672a0001" target="_blank" rel="noopener">http://www.xuecheng.com/api/course/coursepic/get/4028e58161bd22e60161bd23672a0001</a></p>
<p>1、用户拥有 <code>course_pic_list</code> 权限，可以正常访问获取课程图片的接口 。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image5.png" srcset="/img/loading.gif" alt="image-20200601115936697"></p>
<p>2、下面我们来测试删除课程图片的接口</p>
<p>发送给 <code>DELETE</code> 请求到 <a href="http://www.xuecheng.com/api/course/coursepic/delete?courseId=4028e58161bd22e60161bd23672a0001" target="_blank" rel="noopener">http://www.xuecheng.com/api/course/coursepic/delete?courseId=4028e58161bd22e60161bd23672a0001</a></p>
<p>由于用户没有查询课程列表方法的权限，所以无法正常访问，其它方法可以正常访问。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image6.png" srcset="/img/loading.gif" alt="image-20200601133025369"></p>
<p>控制台报错：</p>
<p><code>org.springframework.security.access.AccessDeniedException: 不允许访问</code></p>
<p>说明：如果方法上没有添加授权注解 <code>spring security</code> 将不进行授权控制，只要 <code>jwt</code> 令牌合法则可以正常访问</p>
<p>3、异常处理</p>
<p>上边当没有权限访问时资源服务，应该返回下边的错误代码：</p>
<div class="hljs"><pre><code class="hljs java">UNAUTHORISE(<span class="hljs-keyword">false</span>,<span class="hljs-number">10002</span>,<span class="hljs-string">"权限不足，无权操作！"</span>)</code></pre></div>

<p>进入资源服务（我们测试的是课程管理），新建一个 <code>exception</code> 包，在包下创建一个 CustomExceptionCatch ，并继承 <code>common</code> 工程中的 ExceptionCatch 。</p>
<p>添加异常类 <code>AccessDeniedException.class</code> 与错误代码 10002 的 对应关系，使用 <code>@ControllerAdvice</code> 注解添加一个全局的异常处理，并继承我们在 <code>common</code> 工程中定义的 <code>ExceptionCatch</code> ，使用 static {} 向 <code>builder</code> 里面添加自定义的异常处理代码。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_course.exception;
 
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCatch;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> org.springframework.security.access.AccessDeniedException;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;
 
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomExceptionCatch</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ExceptionCatch</span> </span>&#123;
    <span class="hljs-keyword">static</span> &#123;
        <span class="hljs-comment">//除了CustomException以外的异常类型及对应的错误代码在这里定义,，如果不定义则统一返回固定的错误信息</span>
        builder.put(AccessDeniedException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">CommonCode</span>.<span class="hljs-title">UNAUTHORISE</span>)</span>;
    &#125;
&#125;</code></pre></div>

<p>再次测试，结果如下：</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image7.png" srcset="/img/loading.gif" alt="image-20200601134010887"></p>
<h2 id="5-小结"><a href="#5-小结" class="headerlink" title="5. 小结"></a>5. 小结</h2><p>基于方法授权步骤：</p>
<p>1、<code>ResourceServerConfig</code> 类上添加注解，如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//激活方法上的PreAuthorize注解</span>
<span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>, securedEnabled = <span class="hljs-keyword">true</span>)</code></pre></div>

<p>2、在 <code>Controller</code> 为需要校验权限的方法上添加授权注解</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('权限名称')"</span>)</code></pre></div>

<p>3、如果方法上不添加授权注解则表示此方法不需要权限即可访问。</p>
<h1 id="三、动态查询用户权限"><a href="#三、动态查询用户权限" class="headerlink" title="三、动态查询用户权限"></a>三、动态查询用户权限</h1><h2 id="1-需求分析-1"><a href="#1-需求分析-1" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>截至目前在测试授权时使用的权限数据是静态数据，正常情况的流程是：</p>
<p>1、管理员给用户分配权限，权限数据写到数据库中。</p>
<p>2、认证服务在进行用户认证时从数据库读取用户的权限数据（动态数据）<br>本节实现动态权限数据。</p>
<h2 id="2-权限数据模型"><a href="#2-权限数据模型" class="headerlink" title="2. 权限数据模型"></a>2. 权限数据模型</h2><h3 id="数据模型结构"><a href="#数据模型结构" class="headerlink" title="数据模型结构"></a>数据模型结构</h3><p>打开 <code>xc_user</code> 数据库，找到下边的表：</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image8.png" srcset="/img/loading.gif" alt="image-20200601141058705"></p>
<p>xc_user：用户表，存储了系统用户信息，用户类型包括：学生、老师、管理员等</p>
<p>xc_role：角色表，存储了系统的角色信息，学生、老师、教学管理员、系统管理员等。</p>
<p>xc_user_role：用户角色表，一个用户可拥有多个角色，一个角色可被多个用户所拥有</p>
<p>xc_menu: 模块表，记录了菜单及菜单下的权限</p>
<p>xc_permission: 角色权限表，一个角色可拥有多个权限，一个权限可被多个角色所拥有</p>
<blockquote>
<p>xc_permission 表可以更名为 xc_permission_role 或者 xc_menu_role 会容易理解</p>
</blockquote>
<h3 id="数据模型的使用"><a href="#数据模型的使用" class="headerlink" title="数据模型的使用"></a>数据模型的使用</h3><p>本项目教学阶段不再实现权限定义及用户权限分配的功能，但是基于权限数据模型（5张数据表）及现有数据，要求学生在数据库中操作完成给用户分配权限、查询用户权限等需求。</p>
<p>1、查询用户所拥有的权限</p>
<p>步骤：</p>
<ul>
<li>确定用户的id</li>
<li>查询用户所拥有的角色</li>
<li>查询用户所属的 <strong>角色</strong> 所拥有的权限</li>
</ul>
<p>例子：</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-comment"># 根据查到的权限ID(menu_id)查询所对应的权限的详细信息</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> xc_menu <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">IN</span>(
	<span class="hljs-comment"># 根据用户角色ID取出该角色所拥有的权限</span>
	<span class="hljs-keyword">SELECT</span> menu_id <span class="hljs-keyword">FROM</span> xc_permission <span class="hljs-keyword">WHERE</span> role_id <span class="hljs-keyword">IN</span>(
        	<span class="hljs-comment"># 获取指定用户所拥有角色的id</span>
			<span class="hljs-keyword">SELECT</span> role_id <span class="hljs-keyword">FROM</span> xc_user_role <span class="hljs-keyword">where</span> user_id = <span class="hljs-number">49</span>
	)
)</code></pre></div>

<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image9.png" srcset="/img/loading.gif" alt="image-20200601144244164"></p>
<p>2、向已拥有角色分配权限</p>
<p>1）新增一个 权限 <code>A</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function">INSERT INTO <span class="hljs-title">xc_menu</span> <span class="hljs-params">(id,code,p_id,menu_name)</span> <span class="hljs-title">VALUES</span> <span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"903459378655395851"</span>, # 权限A的ID</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"course_pic_list"</span>,</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"903459378655395841"</span>,</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"课程图片查询"</span></span></span>
<span class="hljs-function"><span class="hljs-params">)</span></span>;</code></pre></div>

<p>2）将该用户所属的某个角色与权限 <code>A</code> 关联起来</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> xc_permission (<span class="hljs-keyword">id</span>,role_id,menu_id) <span class="hljs-keyword">VALUES</span>(
	<span class="hljs-string">"8947692177635409931"</span>,
	<span class="hljs-number">20</span>,
	<span class="hljs-string">"903459378655395851"</span> <span class="hljs-comment"># 权限A的ID</span>
)</code></pre></div>

<p>3）再次查询该用户对有的权限</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image10.png" srcset="/img/loading.gif" alt="image-20200601144328736"></p>
<p>从上图中可以看到，我们为用户所属的角色下添加了一个课程图片查询的权限，那么用户也会同时拥有了该权限。</p>
<h2 id="3-用户中心查询用户权限"><a href="#3-用户中心查询用户权限" class="headerlink" title="3. 用户中心查询用户权限"></a>3. 用户中心查询用户权限</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>认证服务请求用户中心查询用户信息，用户需要将用户基本信息和用户权限一同返回给认证服务。</p>
<p>本小节实现查询用户所拥有的权限，并将用户权限信息添加到的指定对象中返回给认证服务。</p>
<p>以上需求需要修改如下接口：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/getuserext"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserext</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"username"</span>)</span> String username)</span>;</code></pre></div>

<h3 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h3><p>在用户中心服务中编写 <code>dao</code>，实现根据用户id查询权限。</p>
<p>1、定义 XcMenuMapper.java</p>
<p>在 <code>com.xuecheng.ucenter.dao</code> 包下定义：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">XcMenuMapper</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;XcMenu&gt; <span class="hljs-title">selectPermissionByUserId</span><span class="hljs-params">(String userid)</span></span>;
&#125;</code></pre></div>

<p>2、XcMenuMapper.xml</p>
<p>在 <code>resources</code> 下创建 <code>com.xuecheng.ucenter.dao</code> 然后定义 <code>XcMenuMapper.xml</code></p>
<p>这里要注意的一个点就是，在r esources 创建 com.xuecheng.ucenter.dao 时需要逐个包来创建，如果直接复制整串来创建，idea会将他识别为同一个目录，导致mapperxml文件无法被扫描到，例如下图</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image11.png" srcset="/img/loading.gif" alt="image-20200602103546011"></p>
<blockquote>
<p>这里mapper.xml文件也可以存放的位置也可以是自定义的包名，但是要在启动类配置mapperscan</p>
</blockquote>
<div class="hljs"><pre><code class="hljs sql">&lt;?xml version="1.0" encoding="UTF‐8" ?&gt;
&lt;!DOCTYPE mapper PUBLIC "‐//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis‐3‐
mapper.dtd" &gt;
&lt;mapper namespace="com.xuecheng.ucenter.dao.XcMenuMapper" &gt;
    &lt;select id="selectPermissionByUserId"
            resultType="com.xuecheng.framework.domain.ucenter.XcMenu" parameterType="java.lang.String" &gt;
        <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">id</span>,
        CODE,
        p_id pId,
        menu_name menuName,
        <span class="hljs-keyword">url</span>,
        is_menu isMenu,
        <span class="hljs-keyword">LEVEL</span>,
        <span class="hljs-keyword">sort</span>,
        <span class="hljs-keyword">STATUS</span>,
        icon,
        create_time createTime,
        update_time updateTiem
        <span class="hljs-keyword">FROM</span>
        xc_menu
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">IN</span>(
        <span class="hljs-keyword">SELECT</span> menu_id <span class="hljs-keyword">FROM</span> xc_permission <span class="hljs-keyword">WHERE</span> role_id <span class="hljs-keyword">IN</span>(
        <span class="hljs-keyword">SELECT</span> role_id <span class="hljs-keyword">FROM</span> xc_user_role <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-comment">#&#123;id&#125;</span>
        )
        )
    &lt;/<span class="hljs-keyword">select</span>&gt;
&lt;/mapper&gt;</code></pre></div>

<p>其它 Dao 采用 <code>spring data jpa</code> 编写如下：</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image12.png" srcset="/img/loading.gif" alt="image-20200601144613066"></p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>修改 <code>UserService</code> 的 <code>getUserExt</code> 方法，查询用户权限。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//根据账号查询用户的信息，返回用户扩展信息</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserExt</span><span class="hljs-params">(String username)</span></span>&#123;
    XcUser xcUser = <span class="hljs-keyword">this</span>.findXcUserByUsername(username);
    <span class="hljs-keyword">if</span>(xcUser == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125; 
    <span class="hljs-comment">//根据用户id查询用户权限</span>
    String userId = xcUser.getId();
    List&lt;XcMenu&gt; xcMenus = xcMenuMapper.selectPermissionByUserId(userId);
    XcUserExt xcUserExt = <span class="hljs-keyword">new</span> XcUserExt();
    BeanUtils.copyProperties(xcUser,xcUserExt);
    <span class="hljs-comment">//用户的权限</span>
    xcUserExt.setPermissions(xcMenus);
    <span class="hljs-keyword">return</span> xcUserExt;
&#125;</code></pre></div>

<h2 id="4-认证服务查询用户权限"><a href="#4-认证服务查询用户权限" class="headerlink" title="4. 认证服务查询用户权限"></a>4. 认证服务查询用户权限</h2><p>修改认证服务的 <code>UserDetailServiceImpl</code> ，查询用户的权限，并拼接权限串，将原来硬编码权限代码删除，代码如<br>下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDetailsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;
    
    <span class="hljs-meta">@Autowired</span>
    ClientDetailsService clientDetailsService;
 
    <span class="hljs-comment">//用户中心服务客户端</span>
    <span class="hljs-meta">@Autowired</span>
    UserClient userClient;
 
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;
        <span class="hljs-comment">//取出身份，如果身份为空说明没有认证</span>
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        <span class="hljs-comment">//没有认证统一采用httpbasic认证，httpbasic中存储了client_id和client_secret</span>
        <span class="hljs-comment">//开始认证client_id和client_secret</span>
        <span class="hljs-keyword">if</span>(authentication==<span class="hljs-keyword">null</span>)&#123;
            ClientDetails clientDetails = clientDetailsService.loadClientByClientId(username);
            <span class="hljs-keyword">if</span>(clientDetails!=<span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//密码</span>
                String clientSecret = clientDetails.getClientSecret();
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username,clientSecret,AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">""</span>));
            &#125;
        &#125;
        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(username)) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
 
        <span class="hljs-comment">//请求ucenter查询用户</span>
        XcUserExt userext = userClient.getUserext(username);
        <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>; <span class="hljs-comment">//如果获取到的用信息为空,则返回null,spring security则会抛出异常</span>
 
        <span class="hljs-comment">//从数据库查询用户正确的密码，Spring Security会去比对输入密码的正确性</span>
        String password = userext.getPassword();
        <span class="hljs-comment">//指定用户的权限,从数据库中获取</span>
        List&lt;XcMenu&gt; permissions = userext.getPermissions();
        <span class="hljs-keyword">if</span>(permissions == <span class="hljs-keyword">null</span>) &#123;
            permissions = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        &#125;
 
        List&lt;String&gt; permissionsCode = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-comment">//遍历权限对象中的code字段</span>
        permissions.forEach(item -&gt; permissionsCode.add(item.getCode()));
        <span class="hljs-comment">//将权限串中间以逗号分隔</span>
        String user_permission_string = StringUtils.join(permissionsCode.toArray(), <span class="hljs-string">","</span>);
 
        <span class="hljs-comment">//设置用户信息到userDetails对象</span>
        UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(
            username,
            password,
            AuthorityUtils.commaSeparatedStringToAuthorityList(user_permission_string));
 
        <span class="hljs-comment">//用户id</span>
        userDetails.setId(userext.getId());
        <span class="hljs-comment">//用户名称</span>
        userDetails.setName(userext.getName());
        <span class="hljs-comment">//用户头像</span>
        userDetails.setUserpic(userext.getUserpic());
        <span class="hljs-comment">//用户所属企业id</span>
        userDetails.setCompanyId(userext.getCompanyId());
 
        <span class="hljs-comment">//返回用信息给到Spring Security进行处理</span>
        <span class="hljs-keyword">return</span> userDetails;
    &#125;
&#125;</code></pre></div>

<p>这里要注意的是，设置到 <code>userDetails</code> 对象的权限信息为权限的代码标识，也就是 <code>UserJwt</code> 对象的 <code>code</code>字段，需要将所有的权限代码遍历出来然后拼接成字符串，如下代码</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//指定用户的权限,从数据库中获取</span>
List&lt;XcMenu&gt; permissions = userext.getPermissions();
List&lt;String&gt; permissionsCode = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
<span class="hljs-keyword">for</span> (XcMenu xcMenu : permissions )&#123;
    String code = xcMenu.getCode();
    permissionsCode.add(code);
&#125;
<span class="hljs-comment">//将权限串中间以逗号分隔</span>
String user_permission_string = StringUtils.join(permissionsCode.toArray(), <span class="hljs-string">","</span>);</code></pre></div>

<h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h2><p>1、执行登录，在 <code>redis</code> 中查看 <code>jwt</code> 令牌，使用 <code>jwt</code> 测试程序解析 <code>jwt</code> 令牌中是否包括用户的权限 。</p>
<p>测试登录，拿到令牌</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image13.png" srcset="/img/loading.gif" alt="image-20200602114307895"></p>
<p>根据令牌，我们到redis里找到该令牌对应的 <code>access_token</code></p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image14.png" srcset="/img/loading.gif" alt="image-20200602114407430"></p>
<p>2、使用新的jwt令牌测试方法授权</p>
<p>成功的访问课程图片的接口</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image15.png" srcset="/img/loading.gif" alt="image-20200602121703349"></p>
<h1 id="四、前端集成认证授权"><a href="#四、前端集成认证授权" class="headerlink" title="四、前端集成认证授权"></a>四、前端集成认证授权</h1><h2 id="1-需求分析-2"><a href="#1-需求分析-2" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>截至目前认证授权服务端的功能已基本完成，本章实现前端集成认证授权功能。</p>
<p>前端集成认证授权功能需要作如下工作：</p>
<p>1、前端页面校验用户的身份，如果用户没有登录则跳转到登录页面</p>
<p>2、前端请求资源服务需要在 <code>http header</code> 中添加 <code>jwt</code> 令牌，资源服务根据 <code>jwt</code> 令牌完成授权。</p>
<p>哪些功能需要前端请求时携带 <code>JWT</code> ？</p>
<p>用户登录成功请求资源服务都需要携带 <code>jwt</code> 令牌，因为资源服务已经实现了 <code>jwt</code> 认证，如果校验头部没有 <code>jwt</code> 则会认为身份不合法。</p>
<h2 id="2-教学管理中心"><a href="#2-教学管理中心" class="headerlink" title="2. 教学管理中心"></a>2. 教学管理中心</h2><p>本节实现教学管理中心（xc-ui-pc-teach）实现身份校验，其它前端参考教学管理中心实现</p>
<h3 id="配置虚拟主机"><a href="#配置虚拟主机" class="headerlink" title="配置虚拟主机"></a>配置虚拟主机</h3><p>教学管理前端访问微服务统一在访问地址前添加 <code>/api</code> 前缀并经过网关转发到微服务。</p>
<p>配置 teacher.xuecheng.com 虚拟主机。</p>
<div class="hljs"><pre><code class="hljs java">#前端教学管理
upstream teacher_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">12000</span> weight=<span class="hljs-number">10</span>;
&#125; 
#文件服务
upstream filesystem_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">22100</span> weight=<span class="hljs-number">10</span>;
&#125; 
#媒资服务
upstream media_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">31400</span> weight=<span class="hljs-number">10</span>;
&#125;
# 学成网教学管理中心
server &#123;
    listen <span class="hljs-number">80</span>;
    server_name teacher.xuecheng.com;
    #个人中心
    location / &#123;
        proxy_pass http:<span class="hljs-comment">//teacher_server_pool;</span>
    &#125; 
    location /api &#123;
        proxy_pass http:<span class="hljs-comment">//api_server_pool;</span>
    &#125; 
    location /filesystem &#123;
        proxy_pass http:<span class="hljs-comment">//filesystem_server_pool;</span>
    &#125;
    #媒资管理
    location ^~ /api/media/ &#123;
        proxy_pass http:<span class="hljs-comment">//media_server_pool/media/;</span>
    &#125; 
    #认证
    location ^~ /openapi/auth/ &#123;
        proxy_pass http:<span class="hljs-comment">//auth_server_pool/auth/;</span>
    &#125;
&#125;</code></pre></div>

<p>修改 <code>hosts</code> 文件 C:\Windows\System32\drivers\etc\hosts</p>
<div class="hljs"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span> teacher.xuecheng.com</code></pre></div>

<h3 id="身份校验"><a href="#身份校验" class="headerlink" title="身份校验"></a>身份校验</h3><p>教学管理中心（xc-ui-pc-teach）是单页面应用，我们在路由变化时校验用户的身份，校验失败将跳转到登录页面。</p>
<p>校验方法如下：</p>
<ul>
<li>如果成功从 sessionStorage 和 <code>cookie</code> 获取当前用户则继续访问</li>
<li>如果 sessionStorage 中无当前用户，cookie 中有当前用户则请求服务端获取 <code>jwt</code>，如果成功则继续访问。</li>
<li>以上两种情况都不满足则跳转到登录页面。</li>
</ul>
<p>1、在 <code>main.js</code> 中添加路由监控代码，如下</p>
<div class="hljs"><pre><code class="hljs java">router.beforeEach((to, from, next) =&gt; &#123;
    <span class="hljs-keyword">if</span>(openAuthenticate)&#123;
        <span class="hljs-comment">// console.log(to)</span>
        <span class="hljs-comment">// console.log(from)</span>
        <span class="hljs-comment">//***********身份校验***************</span>
        let activeUser
        let uid
        <span class="hljs-keyword">try</span>&#123;
            activeUser = utilApi.getActiveUser()
            uid = utilApi.getCookie(<span class="hljs-string">"uid"</span>)
        &#125;<span class="hljs-keyword">catch</span>(e)&#123;
            <span class="hljs-comment">//alert(e)</span>
        &#125; 
        <span class="hljs-keyword">if</span>(activeUser &amp;&amp; uid &amp;&amp; uid == activeUser.uid) &#123;
            next();
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(to.path ==<span class="hljs-string">'/login'</span> || to.path ==<span class="hljs-string">'/logout'</span>)&#123;
            next();
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(uid)&#123;
            <span class="hljs-comment">//请求获取jwt</span>
            systemApi.getjwt().then((res)=&gt;&#123;
                <span class="hljs-keyword">if</span>(res.success)&#123;
                    let jwt = res.jwt;
                    let activeUser = utilApi.getUserInfoFromJwt(jwt)
                    <span class="hljs-keyword">if</span>(activeUser)&#123;
                        utilApi.setUserSession(<span class="hljs-string">"activeUser"</span>,JSON.stringify(activeUser))
                    &#125; 
                    next();
                &#125;<span class="hljs-keyword">else</span>&#123;
                    <span class="hljs-comment">//跳转到统一登陆</span>
                    window.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/login?returnUrl="</span>+Base64.encode(window.location)
                &#125;
            &#125;)
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-comment">//跳转到统一登陆</span>
            window.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/login?returnUrl="</span>+Base64.encode(window.location)
        &#125;
    &#125;<span class="hljs-keyword">else</span>&#123;
        next();
    &#125;
&#125;);</code></pre></div>

<p>配置 xc-ui-pc-teach/config/sysConfig.js 开启认证授权的配置</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">var</span> sysConfig = &#123;
    openAuthenticate: <span class="hljs-literal">true</span>,
    openAuthorize: <span class="hljs-literal">true</span>
&#125;
 
<span class="hljs-built_in">module</span>.exports = sysConfig</code></pre></div>

<p>2、在 base/api/system.js 中添加 <code>getjwt</code> 方法</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/*获取jwt令牌*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getjwt= <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestQuickGet(<span class="hljs-string">'/openapi/auth/userjwt'</span>)
&#125;</code></pre></div>

<p>3、在utils.js中添加 如下方法</p>
<div class="hljs"><pre><code class="hljs js">getActiveUser: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-keyword">let</span> uid = <span class="hljs-keyword">this</span>.getCookie(<span class="hljs-string">"uid"</span>)
    <span class="hljs-keyword">if</span>(uid)&#123;
        <span class="hljs-keyword">let</span> activeUserStr = <span class="hljs-keyword">this</span>.getUserSession(<span class="hljs-string">"activeUser"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(activeUserStr);
    &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">this</span>.delUserSession(<span class="hljs-string">"activeUser"</span>)
    &#125;
&#125;,
    <span class="hljs-comment">//获取jwt令牌</span>
    getJwt : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">let</span> activeUser = <span class="hljs-keyword">this</span>.getActiveUser()
        <span class="hljs-keyword">if</span>(activeUser)&#123;
            <span class="hljs-keyword">return</span> activeUser.jwt
        &#125;
    &#125;,
        <span class="hljs-comment">//解析jwt令牌，获取用户信息</span>
        getUserInfoFromJwt : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">jwt</span>) </span>&#123;
            <span class="hljs-keyword">if</span>(!jwt)&#123;
                <span class="hljs-keyword">return</span> ;
            &#125; 
            <span class="hljs-keyword">var</span> jwtDecodeVal = jwtDecode(jwt);
            <span class="hljs-keyword">if</span> (!jwtDecodeVal) &#123;
                <span class="hljs-keyword">return</span> ;
            &#125; 
            <span class="hljs-keyword">let</span> activeUser=&#123;&#125;
            <span class="hljs-comment">//console.log(jwtDecodeVal)</span>
            activeUser.utype = jwtDecodeVal.utype || <span class="hljs-string">''</span>;
            activeUser.username = jwtDecodeVal.name || <span class="hljs-string">''</span>;
            activeUser.userpic = jwtDecodeVal.userpic || <span class="hljs-string">''</span>;
            activeUser.userid = jwtDecodeVal.userid || <span class="hljs-string">''</span>;
            activeUser.authorities = jwtDecodeVal.authorities || <span class="hljs-string">''</span>;
            activeUser.uid = jwtDecodeVal.jti || <span class="hljs-string">''</span>;
            activeUser.jwt = jwt;
            <span class="hljs-keyword">return</span> activeUser;
        &#125;,</code></pre></div>

<p>4、测试</p>
<p>1）启动学习中心前端、教学管理前端、认证服务、用户中心服务、网关、<code>Eureka</code></p>
<ul>
<li>进入首页</li>
<li>点击“教学提供方”，此时由于没有登录自动跳转到登录页面</li>
</ul>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image16.png" srcset="/img/loading.gif" alt="image-20200603075015366"></p>
<p>2）输入账号和密码登录</p>
<p>登录成功，跳转到教学管理页面</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image17.png" srcset="/img/loading.gif" alt="image-20200603075038706"></p>
<h3 id="携带JWT授权"><a href="#携带JWT授权" class="headerlink" title="携带JWT授权"></a>携带JWT授权</h3><p>1、前端携带JWT请求</p>
<p>根据需求，在使用 <code>axios</code> 进行 http 请求前向 <code>header</code> 中加入 <code>jwt</code> 令牌</p>
<p>在 <code>main.js</code> 中添加</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>
<span class="hljs-comment">// 添加请求拦截器</span>
axios.interceptors.request.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>) </span>&#123;
    <span class="hljs-comment">// 在发送请求向header添加jwt</span>
    <span class="hljs-keyword">let</span> jwt = utilApi.getJwt()
    <span class="hljs-keyword">if</span>(jwt)&#123;
        config.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer '</span>+jwt
    &#125; 
    <span class="hljs-keyword">return</span> config;
&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);
&#125;);</code></pre></div>

<p>2、测试 <code>http</code> 请求是否携带jwt</p>
<p>进入教学管理中心，点击我的课程，观察 <code>request header</code> 中是否有 <code>Authorization</code> 信息</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image18.png" srcset="/img/loading.gif" alt="image-20200603075158919"></p>
<p>3、测试授权效果</p>
<p>当访问一个没有权限的方法时是否报错？</p>
<p>测试方法：</p>
<p>在课程计划查询方法上添加授权注解，表示当前用户需要拥有course_teachplan_list权限方可正常访问。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_teachplan_list')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">findTeachplanList</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.findTeachplanList(courseId);
&#125;</code></pre></div>

<p>进入我的课程，点击课程计划，观察响应结果为 10002错误。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image19.png" srcset="/img/loading.gif" alt="image-20200603075236015"></p>
<p>4、提示权限不足</p>
<p>当权限不足首页要给出提示，实现思路是使用axios的拦截，在执行后校验响应结果，如果是<code>10002</code> 代码的错误则提示用户 ```“权限不足”<code>，如果是</code>10001` 代码则强制登录。</p>
<p>在 <code>main.js</code> 中添加</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">// 响应拦截</span>
axios.interceptors.response.use(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"data="</span>,data)
  <span class="hljs-keyword">if</span>(data &amp;&amp; data.data)&#123;
    <span class="hljs-keyword">if</span>(data.data.code &amp;&amp; data.data.code ==<span class="hljs-string">'10001'</span>)&#123;
      <span class="hljs-comment">//需要登录</span>
      <span class="hljs-comment">// router.push(&#123;</span>
      <span class="hljs-comment">//   path: '/login',</span>
      <span class="hljs-comment">//   query: &#123;returnUrl: Base64.encode(window.location)&#125;</span>
      <span class="hljs-comment">// &#125;)</span>
      <span class="hljs-built_in">window</span>.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/login?returnUrl="</span>+ Base64.encode(<span class="hljs-built_in">window</span>.location)
    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(data.data.code &amp;&amp; data.data.code ==<span class="hljs-string">'10002'</span>)&#123;
      Message.error(<span class="hljs-string">'您没有权限操作该选项'</span>);
      <span class="hljs-keyword">return</span>
    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(data.data.code &amp;&amp; data.data.code ==<span class="hljs-string">'10003'</span>)&#123;
      Message.error(<span class="hljs-string">'认证被拒绝，请重新登录重试！'</span>);
      <span class="hljs-keyword">return</span>
    &#125;
  &#125;
  <span class="hljs-keyword">return</span> data
&#125;)</code></pre></div>

<p>测试：</p>
<p>执行一个没有权限的操作，提示如下</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image20.png" srcset="/img/loading.gif" alt="image-20200603101409637"></p>
<h2 id="3-一些问题"><a href="#3-一些问题" class="headerlink" title="3. 一些问题"></a>3. 一些问题</h2><p>用户前端是如何解密JWT令牌的？ 公钥是否会暴露在前端？</p>
<h1 id="五、细粒度授权"><a href="#五、细粒度授权" class="headerlink" title="五、细粒度授权"></a>五、细粒度授权</h1><h2 id="1-需求分析-3"><a href="#1-需求分析-3" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p><strong>什么是细粒度授权？</strong></p>
<p>细粒度授权也叫数据范围授权，即不同的用户所拥有的操作权限相同，但是能够操作的数据范围是不一样的。</p>
<p>一个例子：</p>
<p>用户 <code>A</code> 和 用户 <code>B</code> 都是教学机构，他们都拥有 “我的课程” 权限，但是两个用户所查询到的数据是不一样的。<br>本项目有哪些细粒度授权？</p>
<p>比如：</p>
<p>我的课程，教学机构只允许查询本教学机构下的课程信息。</p>
<p>我的选课，学生只允许查询自己所选课。</p>
<p><strong>如何实现细粒度授权？</strong></p>
<p>细粒度授权涉及到不同的业务逻辑，通常在service层实现，根据不同的用户进行校验，根据不同的参数查询不同的数据或操作不同的数据。</p>
<h2 id="2-我的课程细粒度授权"><a href="#2-我的课程细粒度授权" class="headerlink" title="2. 我的课程细粒度授权"></a>2. 我的课程细粒度授权</h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p>1、我的课程查询，细粒度授权过程如下：</p>
<ul>
<li>获取当前登录的用户Id</li>
<li>得到用户所属教育机构的Id</li>
<li>查询该教学机构下的课程信息</li>
</ul>
<p>最终实现了用户只允许查询自己机构的课程信息。</p>
<p>2、修改课程管理服务 “<code>我的课程</code>” 的功能，根据 公司 <code>Id</code> 查询课程，思路如下：</p>
<ul>
<li>修改Dao，支持根据公司Id 查询课程。</li>
<li>修改Service，将公司Id传入Dao。</li>
<li>修改Controller，获取当前用户的公司Id，传给Service。</li>
</ul>
<p>3、数据模型分析如下：</p>
<p>1）课程表</p>
<p>在 <code>xc_course</code> 数据库的 <code>course_base</code> 表中添加 <code>company_id</code> 字段，来表示此课程的归属</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image21.png" srcset="/img/loading.gif" alt="image-20200603102939596"></p>
<p>2）用户企业表</p>
<p>在 <code>xc_user</code> 数据库的 <code>xc_company_user</code> 表中记录了用户的归属公司信息</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image22.png" srcset="/img/loading.gif" alt="image-20200603102958164"></p>
<p>通过 xc_company_user 表可得到 用户 的所属公司 Id。</p>
<p>如何查询某个用户的课程？</p>
<p>1、确定用户的 Id</p>
<p>2、根据用户的 <code>Id</code> 查询用户归属的公司。</p>
<p>3、根据 <code>公司Id</code> 查询该公司下的课程信息</p>
<p>一个例子：</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-comment">/*确定用户的id：49*/</span>
<span class="hljs-comment">/*根据用户Id查找所属公司*/</span>
<span class="hljs-comment">/*根据公司查询所拥有的课程*/</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> xc_course.course_base <span class="hljs-keyword">WHERE</span> company_id <span class="hljs-keyword">IN</span> (
	<span class="hljs-keyword">SELECT</span> company_id <span class="hljs-keyword">FROM</span> xc_user.xc_company_user <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-string">'49'</span>
)</code></pre></div>

<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>定义我的课程查询接口如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"查询指定公司下的所有课程"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult&lt;CourseInfo&gt; <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> page,</span></span>
<span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> size,</span></span>
<span class="hljs-function"><span class="hljs-params">    CourseListRequest courseListRequest</span></span>
<span class="hljs-function"><span class="hljs-params">)</span></span>;</code></pre></div>

<h3 id="DAO-1"><a href="#DAO-1" class="headerlink" title="DAO"></a>DAO</h3><p>在 CourseMapper 下新增一个 <code>findCourseListByCompany</code> 方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseMapper</span> </span>&#123;
   <span class="hljs-comment">//根据课程id查询课程信息</span>
   <span class="hljs-function">CourseBase <span class="hljs-title">findCourseBaseById</span><span class="hljs-params">(String id)</span></span>;
 
   <span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 分页查询课程数据</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> courseListRequest 查询条件</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">    */</span>
   <span class="hljs-function">Page&lt;CourseBase&gt; <span class="hljs-title">findCourseList</span><span class="hljs-params">(CourseListRequest courseListRequest)</span></span>;
 
   <span class="hljs-comment">/**</span>
<span class="hljs-comment">    * 分页查询指定公司下的课程数据</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> courseListRequest 查询条件</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">    */</span>
   <span class="hljs-function">Page&lt;CourseInfo&gt; <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(CourseListRequest courseListRequest)</span></span>;
 
&#125;</code></pre></div>

<p>修改 <code>CourseMapper.xml</code> 的查询课程列表，添加 <code>companyId</code> 条件。</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findCourseListByCompany"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.CourseInfo"</span></span>
<span class="hljs-tag">        <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.request.CourseListRequest"</span>&gt;</span>
    SELECT
    course_base.*,
    (SELECT pic FROM course_pic WHERE courseid = course_base.id) pic
    FROM
    course_base
    where 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"companyId!=null and companyId!=''"</span>&gt;</span>
        and course_base.company_id = #&#123;companyId&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></code></pre></div>

<h3 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h3><p>修改 CourseService 的 <code>findCourseList</code> 方法，添加 <code>companyId</code> 参数，并且传给 dao.</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 分页查询指定公司下的课程信息</span>
<span class="hljs-comment">     */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(String companyId ,<span class="hljs-keyword">int</span> pageNum, <span class="hljs-keyword">int</span> size, CourseListRequest courseListRequest)</span></span>&#123;
    <span class="hljs-keyword">if</span>(pageNum&lt;=<span class="hljs-number">0</span>)&#123;
        pageNum = <span class="hljs-number">0</span>;
    &#125;
    <span class="hljs-keyword">if</span>(size&lt;=<span class="hljs-number">0</span>)&#123;
        size = <span class="hljs-number">20</span>;
    &#125;
    PageHelper.startPage(pageNum,size);  <span class="hljs-comment">//设置分页参数</span>
 
    <span class="hljs-comment">//设置公司信息到查询条件内</span>
    courseListRequest.setCompanyId(companyId);
    Page&lt;CourseInfo&gt; courseList = courseMapper.findCourseListByCompany(courseListRequest);
    QueryResult queryResult = <span class="hljs-keyword">new</span> QueryResult();
    queryResult.setList(courseList.getResult());
    queryResult.setTotal(courseList.getTotal());
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResponseResult(CommonCode.SUCCESS,queryResult);
&#125;</code></pre></div>

<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>修改 CourseController 的 <code>findCourseList</code>，向 service 传入 <code>companyId</code></p>
<p>这里先使用静态数据测试使用。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询指定公司下的所有课程</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page 页码</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size 数量</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseListRequest 查询参数</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coursebase/company/list/&#123;page&#125;/&#123;size&#125;"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    @PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,</span>
<span class="hljs-function">    @<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size,</span>
<span class="hljs-function">    CourseListRequest courseListRequest</span>
<span class="hljs-function">)</span>&#123;
    String companyId = <span class="hljs-string">"1"</span>;
    <span class="hljs-keyword">return</span> courseService.findCourseListByCompany(companyId, page, size, courseListRequest);
&#125;</code></pre></div>

<h3 id="课程查询前端修改"><a href="#课程查询前端修改" class="headerlink" title="课程查询前端修改"></a>课程查询前端修改</h3><p>修改 <code>xc-ui-pc-teach/src/module/course/api/course.js</code> 中查询课程的API 与我们前面构建的 controller 对应</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//我的课程列表</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> findCourseList = <span class="hljs-function">(<span class="hljs-params">page,size,params</span>) =&gt;</span> &#123;
<span class="hljs-comment">//使用工具类将json对象转成key/value</span>
  <span class="hljs-keyword">let</span> queries = querystring.stringify(params)
  <span class="hljs-keyword">return</span> http.requestQuickGet(apiUrl+<span class="hljs-string">"/course/coursebase/company/list/"</span>+page+<span class="hljs-string">"/"</span>+size+<span class="hljs-string">"?"</span>+queries)
&#125;</code></pre></div>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>进入我的课程，查看数据是否正确。</p>
<p>由于我们在 <code>controller</code> 中暂时将 <code>company</code> 的固定的写为了1，所以预期的结果应该是查询到 company 为1的所有课程，测试结果如下。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image23.png" srcset="/img/loading.gif" alt="image-20200603141305638"></p>
<p>测试结果如下，得到了预期的结果</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image24.png" srcset="/img/loading.gif" alt="image-20200603141347386"></p>
<h2 id="3-获取当前信息"><a href="#3-获取当前信息" class="headerlink" title="3. 获取当前信息"></a>3. 获取当前信息</h2><p>要想实现只查询自己的课程信息，则需要获取当前用户所属的企业id。</p>
<p>1、认证服务在用户认证通过将用户所属公司id等信息存储到jwt令牌中。</p>
<p>2、用户请求到达资源服务后，资源服务需要取出header中的jwt令牌，并解析出用户信息。</p>
<h3 id="JWT令牌包括企业Id"><a href="#JWT令牌包括企业Id" class="headerlink" title="JWT令牌包括企业Id"></a>JWT令牌包括企业Id</h3><p>资源服务在授权时需要用到用户所属企业 <code>ID</code>，需要实现认证服务生成的JWT令牌中包括用户所属公司 <code>id</code> 信息。</p>
<p>查看认证服务 <code>UserDetailServiceImpl</code> 代码如下：</p>
<div class="hljs"><pre><code class="hljs java">......
<span class="hljs-comment">//用户id</span>
userDetails.setId(userext.getId());
<span class="hljs-comment">//用户名称</span>
userDetails.setName(userext.getName());
<span class="hljs-comment">//用户头像</span>
userDetails.setUserpic(userext.getUserpic());
<span class="hljs-comment">//用户类型</span>
userDetails.setUtype(userext.getUtype());
<span class="hljs-comment">//用户所属企业id</span>
userDetails.setCompanyId(userext.getCompanyId());
<span class="hljs-keyword">return</span> userDetails;
......</code></pre></div>

<p>通过上边代码的分析得知，认证服务调用远程调用 ucenter 服务的 <code>getUserext</code> 接口获取用户信息，并将 <code>userext</code> 中的信息存储到jwt令牌中，所以在在 getUserext 接口中返回的 <code>userext</code> 对象中需要包括了 <code>companyId</code> 公司ID等信息 。</p>
<p>getUserExt 的代码如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据用户名获取用户权限的实现</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username 用户名</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserExt</span><span class="hljs-params">(String username)</span> </span>&#123;
    <span class="hljs-comment">//查询用户信息</span>
    XcUser xcUser = <span class="hljs-keyword">this</span>.findXcUserByUsername(username);
    <span class="hljs-keyword">if</span>(xcUser ==<span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
 
    XcUserExt xcUserExt = <span class="hljs-keyword">new</span> XcUserExt();
    BeanUtils.copyProperties(xcUser,xcUserExt);
 
    <span class="hljs-comment">//根据用户id查询用所属公司</span>
    String xcUserId = xcUser.getId();
    XcCompanyUser xcCompanyUser = xcCompanyUserRepository.findByUserId(xcUserId);
    <span class="hljs-keyword">if</span>(xcCompanyUser!=<span class="hljs-keyword">null</span>)&#123;
        String companyId = xcCompanyUser.getCompanyId();
        xcUserExt.setCompanyId(companyId);
    &#125;
 
    <span class="hljs-comment">//获取用户的所有权限</span>
    List&lt;XcMenu&gt; xcMenus = xcMenuMapper.selectPermissionByUserId(xcUserId);
    xcUserExt.setPermissions(xcMenus);
 
    <span class="hljs-comment">//返回XcUserExt对象</span>
    <span class="hljs-keyword">return</span> xcUserExt;
&#125;</code></pre></div>

<p><code>getUserExt</code> 是在用户进行认证时被调用的，由 <code>ucenter-auth</code> 服务向 <code>ucenter</code> 服务调用该接口，获取用户的信息，然后将得到的这些信息 打包为 <code>UserJwt</code> 对象交由 Spring Security 进行校验，校验通过后会将该JWT令牌到认证服务中，校验 Spring Security 返回的 <code>JWT</code>令牌完整性后写入到 redis。</p>
<h3 id="解析令牌中的信息"><a href="#解析令牌中的信息" class="headerlink" title="解析令牌中的信息"></a>解析令牌中的信息</h3><h4 id="1、JWT解析工具类"><a href="#1、JWT解析工具类" class="headerlink" title="1、JWT解析工具类"></a>1、JWT解析工具类</h4><p>1、在 <code>Oauth2Util</code> 工具类中，从 header 中取出JWT令牌，并解析 <code>JWT</code> 令牌的内容。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Oauth2Util</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String,String&gt; <span class="hljs-title">getJwtClaimsFromHeader</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;
        <span class="hljs-keyword">if</span> (request == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        
        <span class="hljs-comment">//取出头信息</span>
        String authorization = request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(authorization) || authorization.indexOf(<span class="hljs-string">"Bearer"</span>) &lt; <span class="hljs-number">0</span>) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        
        <span class="hljs-comment">//从Bearer后边开始取出token</span>
        String token = authorization.substring(<span class="hljs-number">7</span>);
        Map&lt;String,String&gt; map = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//解析jwt</span>
            Jwt decode = JwtHelper.decode(token);
            <span class="hljs-comment">//得到 jwt中的用户信息</span>
            String claims = decode.getClaims();
            <span class="hljs-comment">//将jwt转为Map</span>
            map = JSON.parseObject(claims, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
        &#125; 
        <span class="hljs-keyword">return</span> map;
    &#125;
&#125;</code></pre></div>

<p>2、在 <code>XcOauth2Util</code> 工具类中，将解析的 <code>JWT</code> 内容封装成 <code>UserJwt</code> 对象返回。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XcOauth2Util</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserJwt <span class="hljs-title">getUserJwtFromHeader</span><span class="hljs-params">(HttpServletRequest request)</span></span>&#123;
        Map&lt;String, String&gt; jwtClaims = Oauth2Util.getJwtClaimsFromHeader(request);
        <span class="hljs-keyword">if</span>(jwtClaims == <span class="hljs-keyword">null</span> || StringUtils.isEmpty(jwtClaims.get(<span class="hljs-string">"id"</span>)))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125; 
        UserJwt userJwt = <span class="hljs-keyword">new</span> UserJwt();
        userJwt.setId(jwtClaims.get(<span class="hljs-string">"id"</span>));
        userJwt.setName(jwtClaims.get(<span class="hljs-string">"name"</span>));
        userJwt.setCompanyId(jwtClaims.get(<span class="hljs-string">"companyId"</span>));
        userJwt.setUtype(jwtClaims.get(<span class="hljs-string">"utype"</span>));
        userJwt.setUserpic(jwtClaims.get(<span class="hljs-string">"userpic"</span>));
        <span class="hljs-keyword">return</span> userJwt;
    &#125; 
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserJwt</span></span>&#123;
        <span class="hljs-keyword">private</span> String id;
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String userpic;
        <span class="hljs-keyword">private</span> String utype;
        <span class="hljs-keyword">private</span> String companyId;
    &#125;
&#125;</code></pre></div>

<h4 id="2、获取当前用户"><a href="#2、获取当前用户" class="headerlink" title="2、获取当前用户"></a>2、获取当前用户</h4><p>修改课程管理的 CourseController 类，将 <code>companyId</code> 的静态数据改为动态获取：</p>
<p>配置 <code>CourseController</code> 继承 <code>BaseController</code> ，这样我们就可以拿到一个用户请求时的 request 对象</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseContorller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseControllerApi</span> </span>&#123;
	...
&#125;</code></pre></div>

<p>在 <code>findCourseListByCompany</code> 中调用前面我们定义的工具类，从用户的 <code>header</code> 信息中取出 JWT 令牌并且解析出用户的信息，拿到用户所属的公司 <code>ID</code>，实现细粒度的课程信息获取。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询指定公司下的所有课程</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page 页码</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size 数量</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseListRequest 查询参数</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coursebase/company/list/&#123;page&#125;/&#123;size&#125;"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    @PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,</span>
<span class="hljs-function">    @<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size,</span>
<span class="hljs-function">    CourseListRequest courseListRequest</span>
<span class="hljs-function">)</span>&#123;
    <span class="hljs-comment">//调用工具类取出用户信息</span>
    XcOauth2Util xcOauth2Util = <span class="hljs-keyword">new</span> XcOauth2Util();
    <span class="hljs-comment">//从用户header中附带的jwt令牌取出用户信息</span>
    XcOauth2Util.UserJwt userJwt = xcOauth2Util.getUserJwtFromHeader(request);
    <span class="hljs-comment">//从用户信息获取该用户所属的公司id，根据该公司id查询该公司下的所有课程</span>
    String companyId = userJwt.getCompanyId();
    <span class="hljs-keyword">return</span> courseService.findCourseListByCompany(companyId, page, size, courseListRequest);
&#125;</code></pre></div>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>使用不同的用户登录系统，测试细粒度权限控制效果。</p>
<p>预期结果：每个用户只查询自己所拥有的课程。</p>
<p>公司1的用户</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image25.png" srcset="/img/loading.gif" alt="image-20200603150544501"></p>
<p>公司2的用户</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image26.png" srcset="/img/loading.gif" alt="image-20200603150423751"></p>
<h1 id="六、微服务间认证"><a href="#六、微服务间认证" class="headerlink" title="六、微服务间认证"></a>六、微服务间认证</h1><h2 id="1-需求分析-4"><a href="#1-需求分析-4" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>前边章节已经实现了用户携带身份令牌（JTI） 和 <code>JWT</code>（access_token） 令牌访问微服务，微服务获取 <code>jwt</code> 并完成授权。当微服务访问微服务，此时如果没有携带 <code>JWT</code> 则微服务会在授权时报错。</p>
<p>测试课程预览：</p>
<p>1、将课程管理服务和CMS全部添加授权配置</p>
<p>2、用户登录教学管理前端，进入课程发布界面，点击课程发布，观察课程管理服务端报错如下：</p>
<div class="hljs"><pre><code class="hljs json">feign.FeignException: status 401 reading CmsPageClient#save(CmsPage); content:
&#123;<span class="hljs-attr">"error"</span>:<span class="hljs-string">"unauthorized"</span>,<span class="hljs-attr">"error_description"</span>:<span class="hljs-string">"Full authentication is required to access thisresource"</span>&#125;</code></pre></div>

<p>分析原因：</p>
<p>由于课程管理访问 <code>CMS</code> 时没有携带 <code>JWT</code> 令牌导致。</p>
<p>解决方案：</p>
<p>微服务之间进行调用时需携带 <code>JWT</code>。</p>
<h2 id="2-Feign-拦截器"><a href="#2-Feign-拦截器" class="headerlink" title="2. Feign 拦截器"></a>2. Feign 拦截器</h2><p>微服务之间使用 <code>feign</code> 进行远程调用，采用 <code>feign</code> 拦截器实现远程调用携带 JWT。</p>
<p>在 common 工程添加依赖：</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring‐cloud‐starter‐openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<h3 id="定于Feign拦截器"><a href="#定于Feign拦截器" class="headerlink" title="定于Feign拦截器"></a>定于Feign拦截器</h3><p>在 <code>Common</code> 工程定义拦截器如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.interceptor;
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignClientInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RequestInterceptor</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//使用RequestContextHolder工具获取request相关变量</span>
            ServletRequestAttributes attributes = (ServletRequestAttributes)
                RequestContextHolder.getRequestAttributes();
            <span class="hljs-keyword">if</span>(attributes!=<span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//取出request</span>
                HttpServletRequest request = attributes.getRequest();
                Enumeration&lt;String&gt; headerNames = request.getHeaderNames();
                <span class="hljs-keyword">if</span> (headerNames != <span class="hljs-keyword">null</span>) &#123;
                    <span class="hljs-keyword">while</span> (headerNames.hasMoreElements()) &#123;
                        String name = headerNames.nextElement();
                        String values = request.getHeader(name);
                        <span class="hljs-keyword">if</span>(name.equals(<span class="hljs-string">"authorization"</span>))&#123;
                            <span class="hljs-comment">//System.out.println("name="+name+"values="+values);</span>
                            requestTemplate.header(name, values);
                        &#125;
                    &#125;
                &#125;
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTace();
        &#125;
    &#125;
&#125;</code></pre></div>

<h3 id="使用Feign拦截器"><a href="#使用Feign拦截器" class="headerlink" title="使用Feign拦截器"></a>使用Feign拦截器</h3><p>本例子中课程管理调用 <code>cms</code> 需要携带 <code>jwt</code>，所以需要在课程管理中定义 <code>Feign</code> 拦截器 <code>bean</code>，在启动类中定义 <code>bean</code> 如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> FeignClientInterceptor <span class="hljs-title">feignClientInterceptor</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FeignClientInterceptor();
&#125;</code></pre></div>

<h3 id="使用restTemplate访问其他服务接口被拦截的解决方案"><a href="#使用restTemplate访问其他服务接口被拦截的解决方案" class="headerlink" title="使用restTemplate访问其他服务接口被拦截的解决方案"></a>使用restTemplate访问其他服务接口被拦截的解决方案</h3><p>在发布课程时，cms服务使用 restTeamlate 向数据模型URL发送请求获取数据，该操作涉及到调用课程管理服务的接口，由于课程管理服务开启了接口认证，所有没附带 JWT 令牌的请求都会被拒绝，如下图所示</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image27.png" srcset="/img/loading.gif" alt="image-20200603171728929"></p>
<h4 id="方案1"><a href="#方案1" class="headerlink" title="方案1"></a>方案1</h4><p>在课程管理服务中放行该URL的认证拦截，通常该接口是可以不需要认证的。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image28.png" srcset="/img/loading.gif" alt="image-20200603172432245"></p>
<p>在课程管理服务的 <code>ResourceServerConfig</code> 中配置 <code>configure</code> 方法，放行 <code>/course/preview/model</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oauth2.urlMatchers&#125;"</span>)
String urlMatchers;
 
<span class="hljs-comment">//Http安全配置，对每个到达系统的http请求链接进行校验</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-keyword">if</span>(urlMatchers.equals(<span class="hljs-string">""</span>))&#123;
        <span class="hljs-comment">//如果urlMatchers未指定,则所有url都需要授权后才能被访问</span>
        http.authorizeRequests().anyRequest().authenticated();
    &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-comment">//放行 urlMatchers 中指定的url条目, 未指定的url仍需授权后才能访问</span>
        <span class="hljs-keyword">if</span>(urlMatchers != <span class="hljs-keyword">null</span>)&#123;
            String[] split = urlMatchers.split(<span class="hljs-string">","</span>);
            http.authorizeRequests()
                <span class="hljs-comment">//下边的路径放行</span>
                .antMatchers(split).permitAll()
                .anyRequest().authenticated();
        &#125;
    &#125;
&#125;</code></pre></div>

<p>我这里需要放行的URL是从 appliaction.yml 中将 <code>oauth2.urlMatchers</code> 注入到变量 <code>urlMatchers</code> 内，内容如下</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">oauth2:</span>
  <span class="hljs-attr">urlMatchers:</span> <span class="hljs-string">/v2/api-docs,/swagger-resources/configuration/ui,/swagger-resources,/swagger-resources/configuration/security,/swagger-ui.html,/webjars/**,/course/coursepic/get/*</span></code></pre></div>

<h4 id="方案2"><a href="#方案2" class="headerlink" title="方案2"></a>方案2</h4><p>获取当前请求的 <code>request</code> 对象，从该对象中取出当前请求中 <code>header</code> 信息里面包含的 <code>authorization</code> 字段，该字段内带有了我们认证需要的 <code>JWT</code> 令牌信息。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//从dataUrl中获取页面模型数据</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> Map <span class="hljs-title">getModelByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
    <span class="hljs-comment">//查询页面信息</span>
    CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
    CmsPage cmsPage = cmsPageResult.getCmsPage();
    <span class="hljs-comment">//页面不存在</span>
    <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
    &#125;
    <span class="hljs-comment">//取出dataUrl</span>
    String dataUrl = cmsPage.getDataUrl();
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(dataUrl))&#123;
        ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_DATAURL_IS_NULL);
    &#125;
    
    <span class="hljs-comment">//通过获取当前请求的request对象来取出jwt认证信息,并且传递到下一个请求中</span>
    ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
    HttpServletRequest request = attributes.getRequest();
    String jwt = request.getHeader(<span class="hljs-string">"authorization"</span>);
    <span class="hljs-comment">//使用LinkedMultiValueMap储存多个header信息</span>
    LinkedMultiValueMap&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();
    headers.add(<span class="hljs-string">"authorization"</span>,jwt);
    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(headers);
    
    <span class="hljs-comment">//发送请求获取模型数据</span>
    ResponseEntity&lt;Map&gt; forEntity = restTemplate.exchange(dataUrl, HttpMethod.GET,httpEntity,Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Map body = forEntity.getBody();
    <span class="hljs-keyword">return</span> body;
&#125;</code></pre></div>

<h4 id="方案3"><a href="#方案3" class="headerlink" title="方案3"></a>方案3</h4><p>将 <code>CMS</code> 服务中调用 <code>课程管理服务</code> 的数据模型接口更改为使用 <code>Feign</code> 来进行远程调用，再结合前面配置的 <code>Feign</code> 拦截器实现 Header 信息的向下传递。</p>
<p>由于数据模型接口需要的参数是课程ID，但CmsPage对象中没有明确的给出该页面对应的课程ID，但是我们可以看到，页面的名称其实就是以课程ID所命名的，如下图</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image29.png" srcset="/img/loading.gif" alt="image-20200603182403327"></p>
<p>所以我们可以从 <code>pageName</code> 中取出课程ID进行远程调用，代码如下</p>
<div class="hljs"><pre><code class="hljs java">String[] pageNameSplit = cmsPageName.split(<span class="hljs-string">"\\."</span>);
String courseId = pageNameSplit[<span class="hljs-number">0</span>];</code></pre></div>

<blockquote>
<p>这里要注意如果以 <code>.</code> 对字符串进行分割，需要在点号前面加两个斜杠，如 <code>\\.</code></p>
</blockquote>
<p>在之前的代码中，使用 <code>RestTemplate</code> 访问的数据模型接口返回的是一个 <code>map</code> 类型的数据，而如果采用远程调用的方式，拿到的是一个 <code>CourseView</code> 对象，这里我们可以使用 <code>JSONObject.toJSONString</code> 将对象转为字符串，再使用 <code>parseObject</code> 将JSON形式的字符串转换为 <code>Map</code> 对象，代码如下</p>
<div class="hljs"><pre><code class="hljs java">JSONObject.parseObject(JSONObject.toJSONString(courseView), Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span></code></pre></div>

<p>修改后的全部代码如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//从dataUrl中获取页面模型数据</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> Map <span class="hljs-title">getModelByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
    <span class="hljs-comment">//查询页面信息</span>
    CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
    CmsPage cmsPage = cmsPageResult.getCmsPage();
 
    <span class="hljs-comment">//页面不存在</span>
    <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
    &#125;
    String cmsPageName = cmsPage.getPageName();
    <span class="hljs-keyword">if</span>(cmsPageName == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NAME_NOT_EXISTS);
    &#125;
    String[] pageNameSplit = cmsPageName.split(<span class="hljs-string">"\\."</span>);
    String courseId = pageNameSplit[<span class="hljs-number">0</span>];
    CourseView courseView = courseManageClient.courseView(courseId);
    Map body = JSONObject.parseObject(JSONObject.toJSONString(courseView), Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">//        ResponseEntity&lt;Map&gt; forEntity = restTemplate.getForEntity(dataUrl,Map.class);</span>
    <span class="hljs-comment">//        Map body = forEntity.getBody();</span>
    <span class="hljs-comment">//        courseManageClient.courseView(cmsPage.)</span>
    <span class="hljs-keyword">return</span> body;
&#125;</code></pre></div>

<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><p>执行课程发布，提示发布成功。</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image30.png" srcset="/img/loading.gif" alt="image-20200603191048332"></p>
<h1 id="七、提出一些问题"><a href="#七、提出一些问题" class="headerlink" title="七、提出一些问题"></a>七、提出一些问题</h1><p>1、JWT时间目前是由 <code>redis</code> 来进行控制，那么 <code>jwt</code>令牌的实际过期时间是多久？ 如何获取或者设置？</p>
<p>2、生成JWT的公钥和私钥都有哪些作用？</p>
<p>公钥：用于校验JWT令牌是否完整，以及解密JWT令牌中的用户信息</p>
<p>私钥：生成加密后的JWT令牌</p>
<h1 id="八、待完善的一些功能"><a href="#八、待完善的一些功能" class="headerlink" title="八、待完善的一些功能"></a>八、待完善的一些功能</h1><ul>
<li>为 swagger-ui 配置认证授权，使接口文档暴露在外部时需要进行登录认证，提高安全性。</li>
</ul>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Feign/">Feign</a>
                    
                      <a class="hover-with-bg" href="/tags/Spring-Security/">Spring Security</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/">
                        <span class="hidden-mobile">学成在线day17：基于Zuul网关实现路由转发、过滤器</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

代码块js 用不到，fulid自带有，添加css样式即可实现
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键字</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "本站勉强运行&nbsp"+dnum+"&nbsp天";
      document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证123456号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备12345678号</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "学成在线day18：基于oauth2实现RBAC认证授权、微服务间认证实现&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
