<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>学成在线day04：页面静态化 - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>私人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-10 11:09">
      2020-08-10
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9.3k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      110
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="😎知识点概览"><a href="#😎知识点概览" class="headerlink" title="😎知识点概览"></a>😎知识点概览</h1><blockquote>
<p>为了方便后续回顾该项目时能够清晰的知道本章节讲了哪些内容，并且能够从该章节的笔记中得到一些帮助，所以在完成本章节的学习后在此对本章节所涉及到的知识点进行总结概述。</p>
</blockquote>
<p>本章节为【学成在线】项目的 <code>day04</code> 的内容</p>
<ul>
<li>页面静态化的基本概念</li>
<li><code>Freemarker</code> 框架基础入门</li>
<li>使用 <code>MongoDB</code> 提供的 <code>GridFS</code> 来实现页面数据的分布式储存</li>
<li>使用 <code>freemarker</code> 框架实现页面静态化以及发布</li>
</ul>
<h1 id="一、页面静态化需求"><a href="#一、页面静态化需求" class="headerlink" title="一、页面静态化需求"></a>一、页面静态化需求</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ol>
<li><p><strong>为什么要进行页面管理？</strong></p>
<p>本项目的 <code>cms</code> 系统的功能就是根据运营的需要，对门户等子系统的部分页面进行管理，从而实现快速的根据用户需求修改页面的内容并上线需求。</p>
</li>
<li><p><strong>如何修改页面的内容？</strong></p>
<p>在开发中修改页面的内容是需要人工编写 <code>html</code> 以及 <code>js</code> 文件， <code>cms</code> 系统是通过程序自动化的对页面的内容进行修改，通过页面静态化技术生成 <code>html</code> 页面。</p>
</li>
<li><p><strong>如何对页面进行静态化？</strong></p>
<p>一个页面等于 <code>模板</code> + <code>数据</code>，在添加页面的时候我们选择了页面的模板。</p>
</li>
<li><p><strong>页面静态化以及页面发布的流程</strong></p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image1" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image1.png" srcset="/img/loading.gif" alt="发布流程图"></a></p>
<p>​</p>
<p>​</p>
</li>
</ol>
<h2 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h2><p>业务流程如下</p>
<ol>
<li>获取模型数据</li>
<li>制作模板</li>
<li>对页面进行静态化</li>
<li>将静态化生成的 <code>html</code> 页面存放在文件系统中</li>
<li>将存放在文件系统的 <code>html</code> 页面发布到服务器</li>
</ol>
<h1 id="二、FreeMarker研究"><a href="#二、FreeMarker研究" class="headerlink" title="二、FreeMarker研究"></a>二、FreeMarker研究</h1><h2 id="1-FreeMarker介绍"><a href="#1-FreeMarker介绍" class="headerlink" title="1. FreeMarker介绍"></a>1. FreeMarker介绍</h2><ol>
<li><p><code>freemarker</code> 是一个用 <code>Java</code> 开发的模板引擎</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image2" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image2.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>常用的 <code>java</code> 模板引擎还有哪些?</p>
<p>Jsp、Freemarker、Thymeleaf、Velocity 等</p>
</li>
<li><p>模板+数据模型 = 输出</p>
<p><code>freemarker</code> 并不关心数据的来源，只是根据模板的内容，将数据模型在模板中显示并输出具体的（通常为 <code>html</code> ，也可以生成其他格式的文件）</p>
<ol>
<li><p><strong>数据模型</strong></p>
<p>数据模型在 <code>java</code> 中可以是基本类型也可以是 List、Map、Pojo 等复杂类型</p>
</li>
<li><p><strong>来自官方的例子</strong>：（<a href="https://freemarker.apache.org/docs/dgui_quickstart_basics.html%EF%BC%89" target="_blank" rel="noopener">https://freemarker.apache.org/docs/dgui_quickstart_basics.html）</a></p>
<p>数据模型：</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image3" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image3.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>模板：</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image4" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image4.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>输出：</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image5" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image5.png" srcset="/img/loading.gif" alt="img"></a></p>
</li>
</ol>
</li>
</ol>
<h2 id="2-FreeMark-快速入门"><a href="#2-FreeMark-快速入门" class="headerlink" title="2. FreeMark 快速入门"></a>2. FreeMark 快速入门</h2><p>freemarker 作为 <code>Springmvc</code> 一种视图的格式，默认情况下， <code>SpringMvc</code> 支持 <code>freemarker</code> 视图格式。</p>
<p>需要创建 <code>Spring boot</code> + <code>Freemarker</code>工程用于测试的模板。</p>
<h3 id="1、创建测试工程"><a href="#1、创建测试工程" class="headerlink" title="1、创建测试工程"></a>1、创建测试工程</h3><p>我们在原有的工程下，创建一个<code>test-freemarker</code> 的 <code>maven</code> 模块，测试工程专门用于freemarker的功能测试与模板的测试。</p>
<p>pom如下</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0</span></span>
<span class="hljs-tag"><span class="hljs-string">http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-framework-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../xc-framework-parent/pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>test-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre></div>

<h3 id="2、配置文件"><a href="#2、配置文件" class="headerlink" title="2、配置文件"></a>2、配置文件</h3><p>配置 <code>application.yml</code> 和 <code>logback-spring.xml</code>，从 <code>cms</code> 工程拷贝这两个文件，进行更改， <code>logback-spring.xml</code> 无需更改，<code>application.yml</code> 内容如下：</p>
<div class="hljs"><pre><code class="hljs yml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8088</span> <span class="hljs-comment">#服务端口</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">test‐freemarker</span> <span class="hljs-comment">#指定服务名</span>
  <span class="hljs-attr">freemarker:</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#关闭模板缓存，方便测试</span>
    <span class="hljs-attr">settings:</span>
      <span class="hljs-attr">template_update_delay:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#检查模板更新延迟时间，设置为0表示立即检查，如果时间大于0会有缓存不方便</span></code></pre></div>

<h3 id="3、创建模型类"><a href="#3、创建模型类" class="headerlink" title="3、创建模型类"></a>3、创建模型类</h3><p>在 <code>freemarker</code> 的测试工程下创建模型类型用于测试；</p>
<p>创建 <code>com.xuecheng.test.freemarker.model</code> 包，并构建一个 <code>Student</code> 模型类用于后面的测试</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.test.freemarker.model;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> </span>&#123;
    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">//姓名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<span class="hljs-comment">//年龄</span>
    <span class="hljs-keyword">private</span> Date birthday;<span class="hljs-comment">//生日</span>
    <span class="hljs-keyword">private</span> Float money;<span class="hljs-comment">//钱包</span>
    <span class="hljs-keyword">private</span> List&lt;Student&gt; friends;<span class="hljs-comment">//朋友列表</span>
    <span class="hljs-keyword">private</span> Student bestFriend;<span class="hljs-comment">//最好的朋友</span>
&#125;</code></pre></div>

<h3 id="4、创建模板"><a href="#4、创建模板" class="headerlink" title="4、创建模板"></a>4、创建模板</h3><p>在 <code>src/main/resources</code> 下创建 <code>templates</code>，此目录为 <code>freemarker</code> 的默认模板存放目录；</p>
<p>在 <code>templates</code> 下创建模板文件 <code>test1.ftl</code>，模板中的 <code>${name}</code> 最终会被<code>freemarker</code> 替换成具体的数据。</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf‐8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
Hello $&#123;name&#125;!
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre></div>

<h3 id="5、-创建-controller"><a href="#5、-创建-controller" class="headerlink" title="5、 创建 controller"></a>5、 创建 controller</h3><p>创建 <code>Controller</code> 类，向 <code>Map</code> 中添加 <code>name</code>，最后返回模板文件。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/freemarker"</span>)
<span class="hljs-meta">@Controller</span>  <span class="hljs-comment">//这里主要不要使用RestController,RestController默认返回json数据,使模板引擎失效</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreemarkerController</span> </span>&#123;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 测试1</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> map freemarker引擎会自动从Map形参中读取变量进行渲染</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/test1"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">freemarker</span><span class="hljs-params">(Map&lt;String,Object&gt; map)</span></span>&#123;
        map.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"黑马程序员"</span>);
        <span class="hljs-comment">//返回模板文件名称</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"test1"</span>;
    &#125;
&#125;</code></pre></div>

<h3 id="6、创建启动类"><a href="#6、创建启动类" class="headerlink" title="6、创建启动类"></a>6、创建启动类</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.test.freemarker;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreemarkerTestApplication</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        SpringApplication.run(FreemarkerTestApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;
&#125;</code></pre></div>

<h3 id="7、测试"><a href="#7、测试" class="headerlink" title="7、测试"></a>7、测试</h3><p>访问 <a href="http://localhost:8088/freemarker/test1" target="_blank" rel="noopener">http://localhost:8088/freemarker/test1</a> 测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image6" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image6.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-Freemarker-基础语法"><a href="#3-Freemarker-基础语法" class="headerlink" title="3.Freemarker 基础语法"></a>3.Freemarker 基础语法</h2><h3 id="1、核心指令"><a href="#1、核心指令" class="headerlink" title="1、核心指令"></a>1、核心指令</h3><h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h4><p><code>Freemarker</code> 静态化依赖数据模型和模板，下边定义数据模型；</p>
<p>下边方法形参 <code>map</code> 即为 <code>freemarker</code> 静态化所需要的数据模型，在 <code>map</code> 中填充数据：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.test.freemarker.controller;
<span class="hljs-keyword">import</span> com.xuecheng.test.freemarker.model.Student;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Date;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/freemarker"</span>)
<span class="hljs-meta">@Controller</span>  <span class="hljs-comment">//这里主要不要使用RestController,RestController默认返回json数据,使模板引擎失效</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreemarkerController</span> </span>&#123;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 测试1</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> map freemarker引擎会自动从Map形参中读取变量进行渲染</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/test1"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">freemarker</span><span class="hljs-params">(Map&lt;String,Object&gt; map)</span></span>&#123;
        map.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"黑马程序员"</span>);
        <span class="hljs-comment">//学生对象1</span>
        Student stu1 = <span class="hljs-keyword">new</span> Student();
        stu1.setName(<span class="hljs-string">"小明"</span>);
        stu1.setAge(<span class="hljs-number">18</span>);
        stu1.setMoney(<span class="hljs-number">1888.123f</span>);
        stu1.setBirthday(<span class="hljs-keyword">new</span> Date());
        <span class="hljs-comment">//学生对象2</span>
        Student stu2 = <span class="hljs-keyword">new</span> Student();
        stu2.setName(<span class="hljs-string">"小红"</span>);
        stu2.setAge(<span class="hljs-number">22</span>);
        stu2.setMoney(<span class="hljs-number">1888.123f</span>);
        stu2.setBirthday(<span class="hljs-keyword">new</span> Date());
        <span class="hljs-comment">//创建一个List对象，用于储存上面这两个学生对象</span>
        ArrayList&lt;Object&gt; stus = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        stus.add(stu1);
        stus.add(stu2);
        <span class="hljs-comment">//向数据模型中放入List</span>
        map.put(<span class="hljs-string">"stus"</span>,stus);
        <span class="hljs-comment">//返回模板文件名称</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"test1"</span>;
    &#125;
&#125;</code></pre></div>

<h4 id="List指令"><a href="#List指令" class="headerlink" title="List指令"></a>List指令</h4><p>本节定义freemarker模板，模板中使用freemarker的指令，关于freemarker的指令需要知道：</p>
<div class="hljs"><pre><code class="hljs html">1、注释，即<span class="hljs-tag">&lt;<span class="hljs-name">#‐‐和‐‐</span>&gt;</span>，介于其之间的内容会被freemarker忽略

2、插值（Interpolation）：即$&#123;..&#125;部分,freemarker会用真实的值代替$&#123;..&#125;

3、FTL指令：和HTML标记类似，名字前加#予以区分，Freemarker会解析标签中的表达式或逻辑。

4、文本，仅文本信息，这些不是freemarker的注释、插值、FTL指令的内容会被freemarker忽略解析，直接输出内容</code></pre></div>

<p>在 <code>test1.ftl</code> 模板中使用list指令遍历数据模型中的数据：</p>
<div class="hljs"><pre><code class="hljs jsp">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=<span class="hljs-string">"utf‐8"</span>&gt;
    &lt;title&gt;Hello World!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
Hello $&#123;name&#125;!

&lt;p&gt;在test1.ftl模板中使用list指令遍历数据模型中的数据：&lt;/p&gt;
&lt;table&gt;
    &lt;thead&gt;
        &lt;td&gt;序号&lt;/td&gt;
        &lt;td&gt;姓名&lt;/td&gt;
        &lt;td&gt;年龄&lt;/td&gt;
        &lt;td&gt;钱包&lt;/td&gt;
    &lt;/thead&gt;
    &lt;#list stus as stu&gt;
        &lt;tr&gt;
            &lt;#--使用 _index 来遍历的序号--&gt;
            &lt;td&gt;$&#123;stu_index + 1&#125;&lt;/td&gt;
            &lt;td&gt;$&#123;stu.name&#125;&lt;/td&gt;
            &lt;td&gt;$&#123;stu.age&#125;&lt;/td&gt;
            &lt;td&gt;$&#123;stu.money&#125;&lt;/td&gt;
        &lt;/tr&gt;
    &lt;/#list&gt;
&lt;/table&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre></div>

<p>效果</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image7" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image7.png" srcset="/img/loading.gif" alt="LIST输出效果"></a></p>
<h4 id="遍历Map数据"><a href="#遍历Map数据" class="headerlink" title="遍历Map数据"></a>遍历Map数据</h4><p>1、数据模型</p>
<p>在<code>controller</code> 内使用<code>map</code>指令遍历数据模型中的 <code>stuMap</code>。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//准备map数据</span>
HashMap&lt;Object, Object&gt; stuMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
stuMap.put(<span class="hljs-string">"stu1"</span>,stu1);
stuMap.put(<span class="hljs-string">"stu2"</span>,stu2);
<span class="hljs-comment">//像数据模型内放数据</span>
map.put(<span class="hljs-string">"stu1"</span>,stu1);
<span class="hljs-comment">//向数据模型放入stuMap</span>
map.put(<span class="hljs-string">"stuMap"</span>, stuMap);</code></pre></div>

<p>2、模板</p>
<div class="hljs"><pre><code class="hljs html">通过Map输出stu1的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
姓名：$&#123;stuMap['stu1'].name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
年龄：$&#123;stuMap['stu1'].age&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>

通过Map输出stu1的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
姓名：$&#123;stuMap.stu1.name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
年龄：$&#123;stuMap.stu1.age&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>使用map指令遍历数据模型中的stuMap。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">stuMap</span>?<span class="hljs-attr">keys</span> <span class="hljs-attr">as</span> <span class="hljs-attr">k</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;k_index + 1&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[k].name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[k].age&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[k].money&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></code></pre></div>

<p>3、输出</p>
<p><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image8.png" srcset="/img/loading.gif" alt></p>
<h4 id="if指令"><a href="#if指令" class="headerlink" title="if指令"></a>if指令</h4><p>if 指令即判断指令，是常用的FTL指令，freemarker在解析时遇到if会进行判断，条件为真则输出if中间的内容，否则跳过内容不再输出。</p>
<ol>
<li><p><strong>数据模型：</strong></p>
<p>使用list指令中测试数据模型。</p>
</li>
<li><p><strong>模板</strong></p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">stus</span> <span class="hljs-attr">as</span> <span class="hljs-attr">stu</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">#--使用</span> <span class="hljs-attr">_index</span> 来遍历的序号<span class="hljs-attr">--</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu_index + 1&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            &lt;td &lt;#if stu.name == '小明'&gt;style="background: red" &lt;/#if&gt;&gt;$&#123;stu.name&#125;&lt;/td&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.age&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.money&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span></code></pre></div>

<p>通过阅读上边的代码，实现的功能是：如果姓名为 “<code>小明</code>” 则背景色显示为红色。</p>
</li>
<li><p><strong>输出</strong></p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image9" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image9.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>通过测试发现 姓名为小明的背景色为红色。</p>
</li>
</ol>
<h4 id="三元运算"><a href="#三元运算" class="headerlink" title="三元运算"></a>三元运算</h4><div class="hljs"><pre><code class="hljs js">$&#123; (type == <span class="hljs-string">'SPOT'</span>) ?string(<span class="hljs-string">'热点词'</span>,<span class="hljs-string">'热点搜索'</span>)&#125;</code></pre></div>

<h3 id="2、其他指令"><a href="#2、其他指令" class="headerlink" title="2、其他指令"></a>2、其他指令</h3><h4 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h4><ol>
<li>算数运算符 FreeMarker表达式中完全支持算术运算,FreeMarker支持的算术运算符包括:+, - , * , / , %</li>
<li>逻辑运算符 逻辑运算符有如下几个: 逻辑与:&amp;&amp; 逻辑或:|| 逻辑非:! 逻辑运算符只能作用于布尔值,否则将产生错误</li>
<li>比较运算符 表达式中支持的比较运算符有如下几个: 1 =或者==:判断两个值是否相等. 2 !=:判断两个值是否不等. 3 &gt;<br>或者gt:判断左边值是否大于右边值</li>
<li><code>&gt;=</code> 或者 <code>gte:</code> 判断左边值是否大于等于右边值</li>
<li><code>&lt;</code> 或者 <code>lt:</code> 判断左边值是否小于右边值</li>
<li><code>&lt;=</code> 或者 <code>lte:</code> 判断左边值是否小于等于右边值，注意: <code>=</code> 和 <code>!=</code> 可以用于字符</li>
</ol>
<p>串,数值和日期来比较是否相等,但=和!=两边必须是相同类型的值,否则会产生错误</p>
<p>而且 <code>FreeMarker</code> 是精确比较, <code>&quot;x&quot;,&quot;x &quot;,&quot;X&quot;</code> 是不等的.其它的运行符可以作用</p>
<p>于数字和日期,但不能作用于字符串,大部分的时候,使用gt等字母运算符代替 <code>&gt;</code> 会有更好的效果,因为 <code>FreeMarker</code> 会把 <code>&gt;</code> 解释成 <code>FTL</code> 标签的结束字符, 当然,也可以使 <strong>括号</strong> 来避免这种情况, 如:<code>&lt;#if (x&gt;y)&gt;</code></p>
<h4 id="空值处理"><a href="#空值处理" class="headerlink" title="空值处理"></a>空值处理</h4><ol>
<li><p>判断某变量是否存在使用 “??” 用法为:variable??,如果该变量存在,返回true,否则返回false</p>
<p>例：为防止stus为空报错可以加上判断如下：</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">stus</span>??&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">stus</span> <span class="hljs-attr">as</span> <span class="hljs-attr">stu</span>&gt;</span>
......
<span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span></code></pre></div>
</li>
<li><p>缺失变量默认值使用 <code>“!”</code> 使用 <code>!</code> 要以指定一个默认值，当变量为空时显示默认值。例如： <code>${name!&#39;&#39;}</code> 表示如果 <code>name</code> 为空显示空字符串。</p>
<p>如果是嵌套对象则建议使用（）括起来。</p>
<p>例： ${(stu.bestFriend.name)!’’}表示，如果stu或bestFriend或name为空默认显示空字符串。</p>
</li>
</ol>
<h4 id="内建函数"><a href="#内建函数" class="headerlink" title="内建函数"></a>内建函数</h4><p>内建函数语法格式： 变量+?+函数名称</p>
<ol>
<li><p>得到某个集合的大小：<code>${集合名?size}</code></p>
</li>
<li><p>日期格式化</p>
<div class="hljs"><pre><code class="hljs html">显示年月日: $&#123;today?date&#125;
显示时分秒：$&#123;today?time&#125;
显示日期+时间：$&#123;today?datetime&#125; <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
自定义格式化： $&#123;today?string("yyyy年MM月")&#125;</code></pre></div>
</li>
<li><p>内建函数 <code>c</code></p>
<p><code>map.put(&quot;point&quot;, 102920122);</code></p>
<p><code>point</code> 是数字型，使用 <code>${point}</code> 会显示这个数字的值，并且每三位使用逗号分隔。例如：“102,920,122”</p>
<p>如果不想显示为每三位分隔的数字，可以使用 <code>c</code> 函数将数字型转成字符串输出</p>
<p>例如：<code>${point?c}</code></p>
</li>
<li><p>将json字符串转成对象</p>
<p>一个例子：</p>
<p>其中用到了 assign标签，assign的作用是定义一个变量。</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">#assign</span> <span class="hljs-attr">text</span>=<span class="hljs-string">"&#123;'bank':'工商银行','account':'10101920201920212'&#125;"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#assign</span> <span class="hljs-attr">data</span>=<span class="hljs-string">text?eval</span> /&gt;</span>
开户行：$&#123;data.bank&#125; 账号：$&#123;data.account&#125;</code></pre></div>

</li>
</ol>
<h4 id="完整的模板"><a href="#完整的模板" class="headerlink" title="完整的模板"></a>完整的模板</h4><div class="hljs"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf‐8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Hello World!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
Hello $&#123;name&#125;!
<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
    北京市昌平区建材城西路金燕龙办公楼一层 电话：400-618-9090<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">stus</span> <span class="hljs-attr">as</span> <span class="hljs-attr">stu</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu_index + 1&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    &lt;td &lt;#if stu.name =='小明'&gt;style="background:red;"&lt;/#if&gt;&gt;$&#123;stu.name&#125;&lt;/td&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.age&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span> &gt;</span>$&#123;stu.money&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
输出stu1的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
姓名：$&#123;stuMap['stu1'].name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
年龄：$&#123;stuMap['stu1'].age&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
输出stu1的学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
姓名：$&#123;stu1.name&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
年龄：$&#123;stu1.age&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
遍历输出两个学生信息：<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>序号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">stuMap</span>?<span class="hljs-attr">keys</span> <span class="hljs-attr">as</span> <span class="hljs-attr">k</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;k_index + 1&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[k].name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stuMap[k].age&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span> &gt;</span>$&#123;stuMap[k].money&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">br</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>出生日期<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>钱包<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>最好的朋友<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>朋友个数<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>朋友列表<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">stus</span>??&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">stus</span> <span class="hljs-attr">as</span> <span class="hljs-attr">stu</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.name!''&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.age&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;(stu.birthday?date)!''&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;stu.money&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;(stu.bestFriend.name)!''&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>$&#123;(stu.friends?size)!0&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">stu.friends</span>??&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">stu.friends</span> <span class="hljs-attr">as</span> <span class="hljs-attr">firend</span>&gt;</span>
    $&#123;firend.name!''&#125;<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#assign</span> <span class="hljs-attr">text</span>=<span class="hljs-string">"&#123;'bank':'工商银行','account':'10101920201920212'&#125;"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">#assign</span> <span class="hljs-attr">data</span>=<span class="hljs-string">text?eval</span> /&gt;</span>
开户行：$&#123;data.bank&#125; 账号：$&#123;data.account&#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>&gt;</code></pre></div>

<h3 id="3、静态化测试"><a href="#3、静态化测试" class="headerlink" title="3、静态化测试"></a>3、静态化测试</h3><p>在cms中使用freemarker将页面生成html文件，本节测试html文件生成的方法：</p>
<p><strong>1、使用模板文件静态化</strong></p>
<p>定义模板文件，使用freemarker静态化程序生成html文件。</p>
<p><strong>2、使用模板字符串静态化</strong></p>
<p>定义模板字符串，使用freemarker静态化程序生成html文件。</p>
<h4 id="使用模板文件静态化"><a href="#使用模板文件静态化" class="headerlink" title="使用模板文件静态化"></a>使用模板文件静态化</h4><p>在 <code>test</code> 下创建测试类，并且将<code>main</code>下的 <code>resource/templates</code> 拷贝到 <code>test</code> 下，本次测试使用之前我们在 <code>main</code> 下创建的模板文件，并创建测试类。 目录结构如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image10" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image10.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>创建测试类</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//基于模板生成静态文件</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGenerateHtml</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TemplateException </span>&#123;
    <span class="hljs-comment">//创建配置类</span>
    Configuration configuration = <span class="hljs-keyword">new</span> Configuration(Configuration.getVersion());
    <span class="hljs-comment">//设置模板路径</span>
    String classPath = <span class="hljs-keyword">this</span>.getClass().getResource(<span class="hljs-string">"/"</span>).getPath();
    classPath = java.net.URLDecoder.decode(classPath,<span class="hljs-string">"utf-8"</span>); <span class="hljs-comment">//路径包含中文需要进行转码</span>
    configuration.setDirectoryForTemplateLoading(<span class="hljs-keyword">new</span> File(classPath +<span class="hljs-string">"/templates"</span>));
    <span class="hljs-comment">//设置字符集</span>
    configuration.setDefaultEncoding(<span class="hljs-string">"utf-8"</span>);
    <span class="hljs-comment">//加载模板</span>
    Template template = configuration.getTemplate(<span class="hljs-string">"test1.ftl"</span>);
    <span class="hljs-comment">//数据模型</span>
    Map map = getMap();
    <span class="hljs-comment">//静态化</span>
    String content = FreeMarkerTemplateUtils.processTemplateIntoString(template, map);
    <span class="hljs-comment">//静态化内容</span>
    InputStream inputStream = IOUtils.toInputStream(content);
    <span class="hljs-comment">//输出到文件</span>
    FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"d:/test1.html"</span>));
    <span class="hljs-keyword">int</span> copy = IOUtils.copy(inputStream, fileOutputStream);
&#125;

<span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">getMap</span><span class="hljs-params">()</span></span>&#123;
    Map&lt;String,Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    map.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"黑马程序员"</span>);
    <span class="hljs-comment">//学生对象1</span>
    Student stu1 = <span class="hljs-keyword">new</span> Student();
    stu1.setName(<span class="hljs-string">"小明"</span>);
    stu1.setAge(<span class="hljs-number">18</span>);
    stu1.setMoney(<span class="hljs-number">1888.123f</span>);
    stu1.setBirthday(<span class="hljs-keyword">new</span> Date());
    <span class="hljs-comment">//学生对象2</span>
    Student stu2 = <span class="hljs-keyword">new</span> Student();
    stu2.setName(<span class="hljs-string">"小红"</span>);
    stu2.setAge(<span class="hljs-number">22</span>);
    stu2.setMoney(<span class="hljs-number">1888.123f</span>);
    stu2.setBirthday(<span class="hljs-keyword">new</span> Date());
    <span class="hljs-comment">//创建一个List对象，用于储存上面这两个学生对象</span>
    ArrayList&lt;Object&gt; stus = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    stus.add(stu1);
    stus.add(stu2);
    <span class="hljs-comment">//向数据模型中放入List</span>
    map.put(<span class="hljs-string">"stus"</span>,stus);
    <span class="hljs-comment">//准备map数据</span>
    HashMap&lt;Object, Object&gt; stuMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    stuMap.put(<span class="hljs-string">"stu1"</span>,stu1);
    stuMap.put(<span class="hljs-string">"stu2"</span>,stu2);
    <span class="hljs-comment">//像数据模型内放数据</span>
    map.put(<span class="hljs-string">"stu1"</span>,stu1);
    <span class="hljs-comment">//向数据模型放入stuMap</span>
    map.put(<span class="hljs-string">"stuMap"</span>, stuMap);
    <span class="hljs-keyword">return</span> map;
&#125;</code></pre></div>

<p>运行测试，得到html模板</p>
<p><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image11.png" srcset="/img/loading.gif" alt="img"></p>
<h4 id="使用模板字符串静态化"><a href="#使用模板字符串静态化" class="headerlink" title="使用模板字符串静态化"></a>使用模板字符串静态化</h4><p>详细代码省略，使用字符串和使用模板的区别是 这里直接定义一个 <code>HTML</code> 的字符串变量，例如</p>
<div class="hljs"><pre><code class="hljs java">String templateString=<span class="hljs-string">""</span> +
    <span class="hljs-string">"&lt;html&gt;\n"</span> +
    <span class="hljs-string">" &lt;head&gt;&lt;/head&gt;\n"</span> +
    <span class="hljs-string">" &lt;body&gt;\n"</span> +
    <span class="hljs-string">" 名称：$&#123;name&#125;\n"</span> +
    <span class="hljs-string">" &lt;/body&gt;\n"</span> +
    <span class="hljs-string">"&lt;/html&gt;"</span>;</code></pre></div>

<p>而前面的例子是从ftl模板中获取内容</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//加载模板</span>
Template template = configuration.getTemplate(<span class="hljs-string">"test1.ftl"</span>);</code></pre></div>

<h2 id="4-章节总结"><a href="#4-章节总结" class="headerlink" title="4. 章节总结"></a>4. 章节总结</h2><p>本章节主要介绍了 <code>Freemarker</code> 模板引擎的语法介绍和基本的应用，并了解了 <code>Freemarker</code> 在进行模板渲染时的API调用过程。</p>
<h1 id="三、页面静态化实战"><a href="#三、页面静态化实战" class="headerlink" title="三、页面静态化实战"></a>三、页面静态化实战</h1><h2 id="1-页面静态化流程"><a href="#1-页面静态化流程" class="headerlink" title="1.页面静态化流程"></a>1.页面静态化流程</h2><p>通过上边对 <code>FreeMarker</code> 的研究我们得出：<strong>模板 + 数据模型 = 输出</strong>，页面静态化需要准备数据模型和模板，先知道数据模型的结构才可以编写模板，因为在模板中要引用数据模型中的数据，本节将系统讲解 <code>CMS</code> 页面数据模型获取、模板管理及静态化的过程。</p>
<p>下边我们讨论一个问题：<strong>如何获取页面的数据模型？</strong></p>
<p><code>CMS</code> 管理了各种页面，<code>CMS</code> 对页面进行静态化时需要数据模型，但是 <code>CMS</code> 并不知道每个页面的数据模型的具体内容，它只管执行静态化程序便可对页面进行静态化，所以 <code>CMS</code> 静态化程序需要通过一种通用的方法来获取数据模型。</p>
<p>在编辑页面信息时指定一个 <code>DataUrl</code> ，此 <code>DataUrl</code> 便是获取数据模型的 <code>Url</code>，它基于 <code>Http</code>方式，<code>CMS</code> 对页面进行静态化时会从页面信息中读取 <code>DataUrl</code>，通过 <code>Http</code> 远程调用的方法请求 <code>DataUrl</code> 获取数据模型 。</p>
<p>管理员怎么知道 <code>DataUrl</code> 的内容呢？</p>
<p><strong>举例说明</strong>：</p>
<p>此页面是轮播图页面，它的 <code>DataUrl</code> 由开发轮播图管理的程序员提供。</p>
<p>此页面是精品课程推荐页面，它的 <code>DataUrl</code> 由精品课程推荐的程序员提供。</p>
<p>此页面是课程详情页面，它的 <code>DataUrl</code> 由课程管理的程序员提供。</p>
<p>页面静态化流程如下图：</p>
<p>1、静态化程序首先读取页面获取DataUrl。</p>
<p>2、静态化程序远程请求DataUrl得到数据模型。</p>
<p>3、获取页面模板。</p>
<p>4、执行页面静态化</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image12" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image12.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="2-数据模型"><a href="#2-数据模型" class="headerlink" title="2. 数据模型"></a>2. 数据模型</h2><h3 id="1、轮播图DataUrl接口"><a href="#1、轮播图DataUrl接口" class="headerlink" title="1、轮播图DataUrl接口"></a>1、轮播图DataUrl接口</h3><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p><code>CMS</code> 中有轮播图管理、精品课程推荐的功能，以轮播图管理为例说明：轮播图管理是通过可视化的操作界面由管理员指定轮播图图片地址，最后将轮播图图片地址保存在 <code>cms_config</code> 集合中，下边是轮播图数据模型</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image13" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image13.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>针对首页的轮播图信息、精品推荐等信息的获取统一提供一个 <code>Url</code> 供静态化程序调用，这样我们就知道了轮播图页面、精品课程推荐页面的 <code>DataUrl</code>，管理在页面配置中将此 <code>Url</code> 配置在页面信息中。本小节开发一个查询轮播图、精品推荐信息的接口，此接口供静态化程序调用获取数据模型 。</p>
<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a>接口定义</h4><p>轮播图信息、精品推荐等信息存储在MongoDB的cms_config集合中。</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image14" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image14.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>cms_config有固定的数据结构，如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.cms;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;
<span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-meta">@Document</span>(collection = <span class="hljs-string">"cms_config"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CmsConfig</span> </span>&#123;
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String id; <span class="hljs-comment">//主键</span>
    <span class="hljs-keyword">private</span> String name; <span class="hljs-comment">//数据模型名称</span>
    <span class="hljs-keyword">private</span> List&lt;CmsConfigModel&gt; model;  <span class="hljs-comment">//数据模型项目</span>

&#125;</code></pre></div>

<p>数据类型项目的内容如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.cms;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;

<span class="hljs-keyword">import</span> java.util.Map;


<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CmsConfigModel</span> </span>&#123;
    <span class="hljs-keyword">private</span> String key;  <span class="hljs-comment">//主键</span>
    <span class="hljs-keyword">private</span> String name; <span class="hljs-comment">//项目名称</span>
    <span class="hljs-keyword">private</span> String url;  <span class="hljs-comment">//项目url</span>
    <span class="hljs-keyword">private</span> Map mapValue;  <span class="hljs-comment">//项目复杂值</span>
    <span class="hljs-keyword">private</span> String value;  <span class="hljs-comment">//项目简单值</span>
&#125;</code></pre></div>

<p>上边的数据结构可以对照 <code>cms_config</code> 的数据进行分析。</p>
<p>其中，在 <code>mapValue</code> 中可以储存一些复杂的数据的模型内容。</p>
<p>根据配置信息Id查询配置信息，定义接口如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.api.cms;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsConfig;
<span class="hljs-keyword">import</span> io.swagger.annotations.Api;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;

<span class="hljs-meta">@Api</span>(value=<span class="hljs-string">"cms配置管理接口"</span>,description = <span class="hljs-string">"cms配置管理接口，提供数据模型的管理、查询接口"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CmsConfigControllerApi</span> </span>&#123;

    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"根据id查询CMS配置信息"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> CmsConfig <span class="hljs-title">getModel</span><span class="hljs-params">(String id)</span></span>;
&#125;</code></pre></div>

<h4 id="Dao层"><a href="#Dao层" class="headerlink" title="Dao层"></a>Dao层</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms.dao;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsConfig;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CmsConfigRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">CmsConfig</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
&#125;</code></pre></div>

<h4 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h4><p>在原service层添加（此处应新创建一个Service）</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据id查询cmsconfig</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CmsConfig <span class="hljs-title">getConfigById</span><span class="hljs-params">(String id)</span></span>&#123;
        Optional&lt;CmsConfig&gt; optional = cmsConfigRepository.findById(id);
        <span class="hljs-keyword">if</span> (optional.isPresent())&#123;
            CmsConfig cmsConfig = optional.get();
            <span class="hljs-keyword">return</span> cmsConfig;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;</code></pre></div>

<h4 id="Controller层"><a href="#Controller层" class="headerlink" title="Controller层"></a>Controller层</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_cms.controller;

<span class="hljs-keyword">import</span> com.xuecheng.api.cms.CmsConfigControllerApi;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.CmsConfig;
<span class="hljs-keyword">import</span> com.xuecheng.manage_cms.service.CmsConfigService;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;


<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/cms/config"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CmsConfigController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CmsConfigControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    CmsConfigService cmsConfigService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/getmodel/&#123;id&#125;"</span>)
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CmsConfig <span class="hljs-title">getModel</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> String id) </span>&#123;
        CmsConfig configById = cmsConfigService.getConfigById(id);
        <span class="hljs-keyword">return</span> configById;
    &#125;
&#125;</code></pre></div>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>使用postman测试接口：</p>
<p>get请求：<a href="http://localhost:31001/cms/config/getmodel/5a791725dd573c3574ee333f" target="_blank" rel="noopener">http://localhost:31001/cms/config/getmodel/5a791725dd573c3574ee333f</a> （轮播图信息）</p>
<h3 id="2、远程请求接口"><a href="#2、远程请求接口" class="headerlink" title="2、远程请求接口"></a>2、远程请求接口</h3><p><code>SpringMVC</code> 提供 <code>RestTemplate</code> 请求 <code>http</code> 接口，<code>RestTemplate</code> 的底层可以使用第三方的 <code>http</code> 客户端工具实现 <code>http</code> 的请求，常用的 <code>http</code> 客户端工具有 <code>Apache HttpClient</code>、<code>OkHttpClient</code> 等，本项目使用 <code>OkHttpClient</code> 完成 <code>http</code> 请求，原因也是因为它的性能比较出众。</p>
<h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span></span></code></pre></div>

<h4 id="配置-RestTemplate"><a href="#配置-RestTemplate" class="headerlink" title="配置 RestTemplate"></a>配置 RestTemplate</h4><p>在<code>SpringBoot</code>启动类中配置 <code>RestTemplate</code></p>
<div class="hljs"><pre><code class="hljs java">...
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ManageCmsApplication</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        SpringApplication.run(ManageCmsApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate(<span class="hljs-keyword">new</span> OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;</code></pre></div>

<h4 id="3、测试-RestTemplate"><a href="#3、测试-RestTemplate" class="headerlink" title="3、测试 RestTemplate"></a>3、测试 RestTemplate</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@RunWith</span>(SpringRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">RestTemplateTest</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    RestTemplate restTemplate;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRestTemplate</span><span class="hljs-params">()</span></span>&#123;
        ResponseEntity&lt;Map&gt; forEntity = restTemplate.getForEntity(<span class="hljs-string">"http://localhost:31001/cms/config/getmodel/5a791725dd573c3574ee333f"</span>, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        System.out.println(forEntity);
    &#125;
&#125;</code></pre></div>

<p>运行测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image15" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image15.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-模板管理"><a href="#3-模板管理" class="headerlink" title="3.模板管理"></a>3.模板管理</h2><h3 id="1、模板管理业务流程"><a href="#1、模板管理业务流程" class="headerlink" title="1、模板管理业务流程"></a>1、模板管理业务流程</h3><p>CMS提供模板管理功能，业务流程如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image16" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image16.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>1、要增加新模板首先需要制作模板，模板的内容就是 <code>Freemarker ftl</code> 模板内容。</p>
<p>2、通过模板管理模块功能新增模板、修改模板、删除模板。</p>
<p>3、模板信息存储在 <code>MongoDB</code> 数据库，其中模板信息存储在 <code>cms_template</code> 集合中，模板文件存储在 <code>GridFS</code> 文件系统中。</p>
<p>下边是一个模板的例子：</p>
<div class="hljs"><pre><code class="hljs json">&#123;
    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"5a962b52b00ffc514038faf7"</span>),
    <span class="hljs-attr">"_class"</span> : <span class="hljs-string">"com.xuecheng.framework.domain.cms.CmsTemplate"</span>,
    <span class="hljs-attr">"siteId"</span> : <span class="hljs-string">"5a751fab6abb5044e0d19ea1"</span>,
    <span class="hljs-attr">"templateName"</span> : <span class="hljs-string">"首页"</span>,
    <span class="hljs-attr">"templateParameter"</span> : <span class="hljs-string">""</span>,
    <span class="hljs-attr">"templateFileId"</span> : <span class="hljs-string">"5a962b52b00ffc514038faf5"</span>
&#125;</code></pre></div>

<p>上边模板信息中 <code>templateFileId</code> 是模板文件的ID，此ID对应 <code>GridFS</code> 文件系统中文件ID。</p>
<h3 id="2、模板制作"><a href="#2、模板制作" class="headerlink" title="2、模板制作"></a>2、模板制作</h3><h4 id="编写模板文件"><a href="#编写模板文件" class="headerlink" title="编写模板文件"></a>编写模板文件</h4><p>轮播图页面原型</p>
<p>在门户的静态工程目录有轮播图的静态页面，路径是：<code>/include/index_banner.html</code>。</p>
<p>数据模型为：</p>
<p>通过http 获取到数据模型如下：</p>
<p>下图数据模型的图片路径改成可以浏览的正确路径。</p>
<div class="hljs"><pre><code class="hljs json">&#123; 
    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"5a791725dd573c3574ee333f"</span>), 
    <span class="hljs-attr">"_class"</span> : <span class="hljs-string">"com.xuecheng.framework.domain.cms.CmsConfig"</span>, 
    <span class="hljs-attr">"name"</span> : <span class="hljs-string">"轮播图"</span>, 
    <span class="hljs-attr">"model"</span> : [
        &#123;
            <span class="hljs-attr">"key"</span> : <span class="hljs-string">"banner1"</span>, 
            <span class="hljs-attr">"name"</span> : <span class="hljs-string">"轮播图1地址"</span>, 
            <span class="hljs-attr">"value"</span> : <span class="hljs-string">"http://www.xuecheng.com/img/widget-bannerA.jpg"</span>
        &#125;, 
        &#123;
            <span class="hljs-attr">"key"</span> : <span class="hljs-string">"banner2"</span>, 
            <span class="hljs-attr">"name"</span> : <span class="hljs-string">"轮播图2地址"</span>, 
            <span class="hljs-attr">"value"</span> : <span class="hljs-string">"http://www.xuecheng.com/img/widget-bannerB.jpg"</span>
        &#125;
    ]
&#125;</code></pre></div>

<p>编写模板</p>
<p>在freemarker测试工程中新建模板 <code>index_banner.ftl</code>。</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://www.xuecheng.com/plugins/normalize-css/normalize.css"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://www.xuecheng.com/plugins/bootstrap/dist/css/bootstrap.css"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://www.xuecheng.com/css/page-learing-index.css"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://www.xuecheng.com/css/page-header.css"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"banner-roll"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"banner-item"</span>&gt;</span>
        &lt;#--&lt;div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerB.jpg);"&gt;&lt;/div&gt;--&gt;
        &lt;#--&lt;div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerA.jpg);"&gt;&lt;/div&gt;--&gt;
        &lt;#--&lt;div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-banner3.png);"&gt;&lt;/div&gt;--&gt;
        &lt;#--&lt;div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerB.jpg);"&gt;&lt;/div&gt;--&gt;
        &lt;#--&lt;div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-bannerA.jpg);"&gt;&lt;/div&gt;--&gt;
        &lt;#--&lt;div class="item" style="background-image: url(http://www.xuecheng.com/img/widget-banner3.png);"&gt;&lt;/div&gt;--&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">#--渲染轮播图--</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">model</span>??&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">model</span> <span class="hljs-attr">as</span> <span class="hljs-attr">item</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"background-image: url($&#123;item.value&#125;);"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"indicators"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://www.xuecheng.com/plugins/jquery/dist/jquery.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://www.xuecheng.com/plugins/bootstrap/dist/js/bootstrap.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span>
<span class="javascript">    <span class="hljs-keyword">var</span> tg = $(<span class="hljs-string">'.banner-item .item'</span>);</span>
<span class="actionscript">    <span class="hljs-keyword">var</span> num = <span class="hljs-number">0</span>;</span>
    for (i = 0; i &lt; tg.length; i++) &#123;
<span class="javascript">        $(<span class="hljs-string">'.indicators'</span>).append(<span class="hljs-string">'&lt;span&gt;&lt;/span&gt;'</span>);</span>
<span class="javascript">        $(<span class="hljs-string">'.indicators'</span>).find(<span class="hljs-string">'span'</span>).eq(num).addClass(<span class="hljs-string">'active'</span>);</span>
    &#125;

<span class="actionscript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">roll</span><span class="hljs-params">()</span> </span>&#123;</span>
        tg.eq(num).animate(&#123;
<span class="actionscript">            <span class="hljs-string">'opacity'</span>: <span class="hljs-string">'1'</span>,</span>
<span class="actionscript">            <span class="hljs-string">'z-index'</span>: num</span>
        &#125;, 1000).siblings().animate(&#123;
<span class="actionscript">            <span class="hljs-string">'opacity'</span>: <span class="hljs-string">'0'</span>,</span>
<span class="actionscript">            <span class="hljs-string">'z-index'</span>: <span class="hljs-number">0</span></span>
        &#125;, 1000);
<span class="javascript">        $(<span class="hljs-string">'.indicators'</span>).find(<span class="hljs-string">'span'</span>).eq(num).addClass(<span class="hljs-string">'active'</span>).siblings().removeClass(<span class="hljs-string">'active'</span>);</span>
        if (num &gt;= tg.length - 1) &#123;
            num = 0;
<span class="actionscript">        &#125; <span class="hljs-keyword">else</span> &#123;</span>
            num++;
        &#125;
    &#125;
<span class="javascript">    $(<span class="hljs-string">'.indicators'</span>).find(<span class="hljs-string">'span'</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span>
<span class="javascript">        num = $(<span class="hljs-keyword">this</span>).index();</span>
        roll();
    &#125;);
<span class="actionscript">    <span class="hljs-keyword">var</span> timer = setInterval(roll, <span class="hljs-number">3000</span>);</span>
<span class="javascript">    $(<span class="hljs-string">'.banner-item'</span>).mouseover(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span>
        clearInterval(timer)
    &#125;);
<span class="javascript">    $(<span class="hljs-string">'.banner-item'</span>).mouseout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span>
        timer = setInterval(roll, 3000)
    &#125;);
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre></div>

<h4 id="模板测试"><a href="#模板测试" class="headerlink" title="模板测试"></a>模板测试</h4><p>在 <code>freemarker</code> 测试工程的入口文件注册 <code>RestTemplate</code> 的Bean</p>
<blockquote>
<p>原讲义只在 cms工程下注册了bean，记得 <code>freemarker</code> 测试工程下也要注册</p>
</blockquote>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreemarkerTestApplication</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        SpringApplication.run(FreemarkerTestApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate(<span class="hljs-keyword">new</span> OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;</code></pre></div>

<p>在 <code>freemarker</code> 测试工程的 <code>FreemarkerController</code> 下编写一个方法测试轮播图模板，代码如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
RestTemplate restTemplate;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 用于调试banner模板</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/banner"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">indexBanner</span><span class="hljs-params">(Map&lt;String,Object&gt; map)</span></span>&#123;
    String dataUrl = <span class="hljs-string">"http://localhost:31001/cms/config/getmodel/5a791725dd573c3574ee333f"</span>;
    ResponseEntity&lt;Map&gt; forEntity = restTemplate.getForEntity(dataUrl, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Map body = forEntity.getBody();
    map.putAll(body); <span class="hljs-comment">//将获取到的数据赋值给map，并渲染至模板内</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"index-banner"</span>;
&#125;</code></pre></div>

<p>请求：<a href="http://localhost:8088/freemarker/banner" target="_blank" rel="noopener">http://localhost:8088/freemarker/banner</a></p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image17" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image17.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="3、GridFS-研究"><a href="#3、GridFS-研究" class="headerlink" title="3、GridFS 研究"></a>3、GridFS 研究</h3><h4 id="GridFS介绍"><a href="#GridFS介绍" class="headerlink" title="GridFS介绍"></a>GridFS介绍</h4><p><code>GridFS</code> 是 <code>MongoDB</code> 提供的用于持久化存储文件的模块，CMS使用<code>MongoDB</code>存储数据，使用<code>GridFS</code> 可以快速集成开发。</p>
<p>它的工作原理是：</p>
<p>在 <code>GridFS</code> 存储文件是将文件分块存储，文件会按照256KB的大小分割成多个块进行存储，<code>GridFS</code> 使用两个集合（<code>collection</code>）存储文件，一个集合是 <code>chunks</code>, 用于存储文件的二进制数据；一个集合是 <code>files</code>，用于存储文件的元数据信息（文件名称、块大小、上传时间等信息）。</p>
<p>从 <code>GridFS</code> 中读取文件要对文件的各各块进行组装、合并。<br>详细参考：<a href="https://docs.mongodb.com/manual/core/gridfs/" target="_blank" rel="noopener">https://docs.mongodb.com/manual/core/gridfs/</a></p>
<h4 id="GridFS-存取文件测试"><a href="#GridFS-存取文件测试" class="headerlink" title="GridFS 存取文件测试"></a>GridFS 存取文件测试</h4><p>1、存文件</p>
<p>这里我们在cms工程内进行测试</p>
<p>使用 <code>GridFsTemplate</code> 存储文件测试代码：<br>向测试程序注入 <code>GridFsTemplate</code> 。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@RunWith</span>(SpringRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">GridFsTest</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    GridFsTemplate gridFsTemplate;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGridFs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException </span>&#123;
        <span class="hljs-comment">//要储存的文件</span>
        File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"d:/resources/index-banner.ftl"</span>);
        <span class="hljs-comment">//定义输入流</span>
        FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(file);
        <span class="hljs-comment">//向GridFS存储文件</span>
        ObjectId objectId = gridFsTemplate.store(fileInputStream, <span class="hljs-string">"index-banner"</span>);
        <span class="hljs-comment">//得到文件ID</span>
        String fileId = objectId.toString();
        System.out.println(fileId);

    &#125;
&#125;</code></pre></div>

<p>储存结果</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image18" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image18.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><strong>存储原理说明：</strong></p>
<p>文件存储成功得到一个文件 <code>id</code><br>此文件 <code>id</code> 是 <code>fs.files</code> 集合中的主键。<br>可以通过文件 <code>id</code> 查询 <code>fs.chunks</code> 表中的记录，得到文件的内容。</p>
<p>2、读取文件</p>
<p>1）在<code>config</code>包中定义 <code>Mongodb</code> 的配置类，如下：</p>
<p><code>GridFSBucket</code>用于打开下载流对象</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MongoConfig</span> </span>&#123;
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;spring.data.mongodb.database&#125;"</span>)
    String db;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> GridFSBucket <span class="hljs-title">getGridFSBucket</span><span class="hljs-params">(MongoClient mongoClient)</span></span>&#123;
        MongoDatabase database = mongoClient.getDatabase(db);
        GridFSBucket gridFSBucket = GridFSBuckets.create(database);
        <span class="hljs-keyword">return</span> gridFSBucket;
    &#125;
&#125;</code></pre></div>

<p>2）测试代码如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
GridFSBucket gridFSBucket;

<span class="hljs-comment">//取文件</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
    String fileId = <span class="hljs-string">"5e79e4323304a26aecec55cd"</span>;
    <span class="hljs-comment">//根据ID查询文件</span>
    GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where(<span class="hljs-string">"_id"</span>).is(fileId)));
    <span class="hljs-comment">//打开下载流对象</span>
    GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
    <span class="hljs-comment">//创建gridFsResource，用于获取流对象</span>
    GridFsResource gridFsResource = <span class="hljs-keyword">new</span> GridFsResource(gridFSFile, gridFSDownloadStream);
    <span class="hljs-comment">//获取流中的数据</span>
    String s = IOUtils.toString(gridFsResource.getInputStream(), <span class="hljs-string">"utf-8"</span>);
    System.out.println(s);
&#125;</code></pre></div>

<h4 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//删除文件</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDelFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
<span class="hljs-comment">//根据文件id删除fs.files和fs.chunks中的记录</span>
gridFsTemplate.delete(Query.query(Criteria.where(<span class="hljs-string">"_id"</span>).is(<span class="hljs-string">"5b32480ed3a022164c4d2f92"</span>)));
&#125;</code></pre></div>

<h3 id="4、模板储存"><a href="#4、模板储存" class="headerlink" title="4、模板储存"></a>4、模板储存</h3><p>根据模板管理的流程，最终将模板信息存储到 <code>MongoDB</code> 的 <code>cms_template</code> 中，将模板文件存储到 <code>GridFS</code>中。模板管理功能在课堂中不再讲解，教学中手动向 <code>cms_template</code> 及 <code>GridFS</code> 中存储模板，方法如下：</p>
<h4 id="1）添加模板"><a href="#1）添加模板" class="headerlink" title="1）添加模板"></a>1）添加模板</h4><p>使用 <code>GridFS</code> 测试代码存储模板文件到 <code>GridFS</code>，并得到文件模板 <code>id</code>，向 <code>cms_template</code> 添加记录</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image19" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image19.png" srcset="/img/loading.gif" alt="img"></a></p>
<h4 id="2）删除模板"><a href="#2）删除模板" class="headerlink" title="2）删除模板"></a>2）删除模板</h4><p>使用 <code>GridFS</code> 测试代码根据文件id删除模板文件。</p>
<p>根据模板id删除 <code>cms_template</code> 中的记录。</p>
<h4 id="3）修改模板信息"><a href="#3）修改模板信息" class="headerlink" title="3）修改模板信息"></a>3）修改模板信息</h4><p>使用Studio 3T修改 <code>cms_template</code> 中的记录。</p>
<h4 id="4）修改模板文件"><a href="#4）修改模板文件" class="headerlink" title="4）修改模板文件"></a>4）修改模板文件</h4><p>1）通过Studio 3T修改模板文件(此方法限文件小于256K)可以通过Studio 3T修改模板文件，先找到模板文件，再导入进去：</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image20" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image20.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="4-静态化测试"><a href="#4-静态化测试" class="headerlink" title="4. 静态化测试"></a>4. 静态化测试</h2><h3 id="1、填写页面-DataUrl"><a href="#1、填写页面-DataUrl" class="headerlink" title="1、填写页面 DataUrl"></a>1、填写页面 DataUrl</h3><p>修改页面管理模板代码，实现编辑页面DataUrl。<br>注意：此地址由程序员提供给系统管理员，由系统管理员录入到系统中。</p>
<p><strong>修改页面管理前端的 page_edit.vue</strong></p>
<p>在表单中添加 <code>dataUrl</code> 输入框：</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"数据Url"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"dataUrl"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"pageForm.dataUrl"</span> <span class="hljs-attr">auto-complete</span>=<span class="hljs-string">"off"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span></code></pre></div>

<p><code>fromData</code> 表单内添加 <code>dataUrl</code> 字段</p>
<p><strong>修改页面管理服务端 PageService</strong></p>
<p>在 <code>PageService.updateCmsPage</code> 更新 <code>cmsPage</code> 数据代码中添加：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//更新dataUrl</span>
one.setDataUrl(cmsPage.getDataUrl());</code></pre></div>

<p><strong>新增页面也重复上面的操作，新增 dataUrl 的表单</strong></p>
<h3 id="2、静态化程序"><a href="#2、静态化程序" class="headerlink" title="2、静态化程序"></a>2、静态化程序</h3><p>在 <code>model.response.cmscode</code> 下新增一些错误代码</p>
<div class="hljs"><pre><code class="hljs java">CMS_PAGE_NOT_EXISTS(<span class="hljs-keyword">false</span>,<span class="hljs-number">24002</span>,<span class="hljs-string">"页面不存在！"</span>),
CMS_GENRATEHTML_DATAURL_IS_NULL(<span class="hljs-keyword">false</span>,<span class="hljs-number">24003</span>,<span class="hljs-string">"从页面信息中找不到获取数据的url"</span>),
CMS_GENRATEHTML_DATA_IS_NULL(<span class="hljs-keyword">false</span>,<span class="hljs-number">24004</span>,<span class="hljs-string">"根据页面的数据url获取不到数据"</span>),
CMS_GENRATEHTML_TEMPLATE_IS_NULL(<span class="hljs-keyword">false</span>,<span class="hljs-number">24005</span>,<span class="hljs-string">"页面模板为空"</span>),
CMS_GENRATEHTML_HTML_IS_NULL(<span class="hljs-keyword">false</span>,<span class="hljs-number">24006</span>,<span class="hljs-string">"生成的静态html为空"</span>),
CMS_GENRATEHTML_SAVE_HTML_ERROR(<span class="hljs-keyword">false</span>,<span class="hljs-number">24007</span>,<span class="hljs-string">"保存静态html出错"</span>),
CMS_GENRATEHTML_PERVIEW_IS_NULL(<span class="hljs-keyword">false</span>,<span class="hljs-number">24008</span>,<span class="hljs-string">"预览页面为空"</span>);</code></pre></div>

<h4 id="获取数据模型"><a href="#获取数据模型" class="headerlink" title="获取数据模型"></a>获取数据模型</h4><blockquote>
<p>静态化程序远程请求DataUrl得到数据模型</p>
</blockquote>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
RestTemplate restTemplate;

<span class="hljs-comment">//从dataUrl中获取页面模型数据</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> Map <span class="hljs-title">getModelByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
    <span class="hljs-comment">//查询页面信息</span>
    CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
    CmsPage cmsPage = cmsPageResult.getCmsPage();
    <span class="hljs-comment">//页面不存在</span>
    <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
    &#125;
    <span class="hljs-comment">//取出dataUrl</span>
    String dataUrl = cmsPage.getDataUrl();
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(dataUrl))&#123;
        ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_DATAURL_IS_NULL);
    &#125;
    <span class="hljs-comment">//发送请求获取模型数据</span>
    ResponseEntity&lt;Map&gt; forEntity = restTemplate.getForEntity(dataUrl,Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Map body = forEntity.getBody();
    <span class="hljs-keyword">return</span> body;
&#125;</code></pre></div>

<h4 id="获取页面模板"><a href="#获取页面模板" class="headerlink" title="获取页面模板"></a>获取页面模板</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>
CmsTemplateRepository templateRepository;

<span class="hljs-meta">@Autowired</span>
GridFsTemplate gridFsTemplate;

<span class="hljs-meta">@Autowired</span>
GridFSBucket gridFSBucket;

<span class="hljs-comment">//获取页面模板数据</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getTemplateByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
    <span class="hljs-comment">//查询页面信息</span>
    CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
    CmsPage cmsPage = cmsPageResult.getCmsPage();
    <span class="hljs-comment">//页面不存在</span>
    <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
    &#125;
    <span class="hljs-comment">//获取页面模板</span>
    String templateId = cmsPage.getTemplateId();
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(templateId))&#123;
        ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_TEMPLATE_IS_NULL);
    &#125;
    Optional&lt;CmsTemplate&gt; optional = templateRepository.findById(templateId);
    <span class="hljs-keyword">if</span>(optional.isPresent())&#123;
        CmsTemplate cmsTemplate = optional.get();
        <span class="hljs-comment">//获取模板文件id</span>
        String templateFileId = cmsTemplate.getTemplateFileId();
        <span class="hljs-comment">//取出模板文件内容</span>
        GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where(<span class="hljs-string">"_id"</span>).is(templateFileId)));
        <span class="hljs-comment">//打开下载流对象</span>
        GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
        <span class="hljs-comment">//创建GridResource</span>
        GridFsResource gridFsResource = <span class="hljs-keyword">new</span> GridFsResource(gridFSFile, gridFSDownloadStream);

        <span class="hljs-keyword">try</span> &#123;
            String content = IOUtils.toString(gridFsResource.getInputStream(), <span class="hljs-string">"utf‐8"</span>);
            <span class="hljs-keyword">return</span> content;
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
&#125;</code></pre></div>

<h4 id="执行页面静态化"><a href="#执行页面静态化" class="headerlink" title="执行页面静态化"></a>执行页面静态化</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 页面静态化</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> TemplateException</span>
<span class="hljs-comment">     */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPageHtml</span><span class="hljs-params">(String pageId)</span> <span class="hljs-keyword">throws</span> IOException, TemplateException </span>&#123;
    <span class="hljs-comment">//获取页面模型数据</span>
    Map modelByPageId = <span class="hljs-keyword">this</span>.getModelByPageId(pageId);
    <span class="hljs-keyword">if</span>(modelByPageId == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-comment">//获取页面模型数据为空</span>
        ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_DATA_IS_NULL);
    &#125;
    <span class="hljs-comment">//获取页面模板</span>
    String templateContent = getTemplateByPageId(pageId);
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(templateContent))&#123;
        <span class="hljs-comment">//页面模板为空</span>
        ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_TEMPLATE_IS_NULL);
    &#125;
    <span class="hljs-comment">//获取页面静态化数据</span>
    String html = generateHtml(templateContent, modelByPageId);
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(html))&#123;
        ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_HTML_IS_NULL);
    &#125;
    <span class="hljs-keyword">return</span> html;
&#125;

<span class="hljs-comment">//构建静态化页面数据</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">generateHtml</span><span class="hljs-params">(String template,Map model)</span> <span class="hljs-keyword">throws</span> IOException, TemplateException </span>&#123;
    <span class="hljs-comment">//生成配置类</span>
    Configuration configuration = <span class="hljs-keyword">new</span> Configuration(Configuration.getVersion());
    <span class="hljs-comment">//模板加载器</span>
    StringTemplateLoader stringTemplateLoader = <span class="hljs-keyword">new</span> StringTemplateLoader();
    stringTemplateLoader.putTemplate(<span class="hljs-string">"template"</span>,template);
    <span class="hljs-comment">//配置模板加载器</span>
    configuration.setTemplateLoader(stringTemplateLoader);

    <span class="hljs-comment">//获取模板</span>
    Template template1 = configuration.getTemplate(<span class="hljs-string">"template"</span>);
    String html = FreeMarkerTemplateUtils.processTemplateIntoString(template1, model);
    <span class="hljs-keyword">return</span> html;
&#125;</code></pre></div>

<p>调用逻辑</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image21" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image21.png" srcset="/img/loading.gif" alt="img"></a></p>
<h4 id="创建测试的页面"><a href="#创建测试的页面" class="headerlink" title="创建测试的页面"></a>创建测试的页面</h4><blockquote>
<p>原讲义中该步骤是省略的</p>
</blockquote>
<p>为了更清晰的了解页面静态化的逻辑，我们新建一个页面来进行测试；</p>
<p>在<code>GridFS</code> 的章节中，我们在单元测试中将 <code>index-banner.ftl</code> 文件的内容储存到了 <code>GridFS</code> 得到一个 <code>fileId</code> ，我这里的是 <code>5e7a20fc3304a25230861f4c</code> ，我们用这个<code>fileId</code> 在 mongoDB 的 <code>cms_tempalte</code> 集合中手动创建一个页面模板，创建成功后我们得到如下的数据</p>
<div class="hljs"><pre><code class="hljs json">&#123; 
    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"5e7a2212b1afec2187ed89ac"</span>), 
    <span class="hljs-attr">"_class"</span> : <span class="hljs-string">"com.xuecheng.framework.domain.cms.CmsTemplate"</span>, 
    <span class="hljs-attr">"siteId"</span> : <span class="hljs-string">"5a751fab6abb5044e0d19ea1"</span>, 
    <span class="hljs-attr">"templateName"</span> : <span class="hljs-string">"轮播图_测试"</span>, 
    <span class="hljs-attr">"templateParameter"</span> : <span class="hljs-string">""</span>, 
    <span class="hljs-attr">"templateFileId"</span> : <span class="hljs-string">"5e7a20fc3304a25230861f4c"</span>
&#125;</code></pre></div>

<p>然后进入到我们之前构建的新增页面选项，添加一个新的页面；</p>
<p>填入 dataUrl <code>http://localhost:31001/cms/config/getmodel/5a791725dd573c3574ee333f</code></p>
<p><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image22.png" srcset="/img/loading.gif" alt="img"></p>
<p>得到该页面的id为 <code>5e7a251a3304a252280804dc</code></p>
<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@RunWith</span>(SpringRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">TestPageService</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    PageService pageService;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetPageHtml</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TemplateException </span>&#123;
        String pageHtml = pageService.getPageHtml(<span class="hljs-string">"5e7a251a3304a252280804dc"</span>);
        System.out.println(pageHtml);
    &#125;
&#125;</code></pre></div>

<h1 id="四、页面预览"><a href="#四、页面预览" class="headerlink" title="四、页面预览"></a>四、页面预览</h1><h2 id="1、页面预览开发"><a href="#1、页面预览开发" class="headerlink" title="1、页面预览开发"></a>1、页面预览开发</h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p>页面在发布前增加页面预览的步骤，方便用户检查页面内容是否正确。页面预览的流程如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image23" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image23.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>1、用户进入 <code>cms</code> 前端，点击 “<strong>页面预览</strong>” 在浏览器请求 <strong>cms</strong> 页面预览链接。</p>
<p>2、<strong>cms</strong> 根据页面 <code>id</code> 查询<code>DataUrl</code>并远程请求DataUrl获取数据模型。</p>
<p>3、<strong>cms</strong> 根据页面id查询页面模板内容</p>
<p>4、<strong>cms</strong> 执行页面静态化。</p>
<h3 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h3><p>在cms服务需要集成freemarker：</p>
<p>1、在CMS服务中加入freemarker的依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--freemarker--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p>2、在application.yml配置freemarker</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">31001</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">xc-service-manage-cms</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">mongodb:</span>
      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://root:123123@localhost:27017</span>
      <span class="hljs-attr">database:</span> <span class="hljs-string">xc_cms</span>
  <span class="hljs-attr">freemarker:</span>
    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#关闭模板缓存，方便测试</span>
    <span class="hljs-attr">settings:</span>
      <span class="hljs-attr">template_update_delay:</span> <span class="hljs-number">0</span></code></pre></div>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>静态化方法在静态化测试章节已经实现</p>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>调用 <code>service</code> 的静态化方法，将静态化内容通过 <code>response</code> 输出到浏览器显示</p>
<p>创建 <code>CmsPagePreviewController</code> 类，用于页面预览：</p>
<p>请求页面id，查询得到页面的模板信息、数据模型 <code>url</code>，根据模板和数据生成静态化内容，并输出到浏览器。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CmsPagePreviewController</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    PageService pageService;

    <span class="hljs-comment">//接收到页面id</span>
    <span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/cms/preview/&#123;pageId&#125;"</span>, method = RequestMethod.GET)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">preView</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"pageId"</span>)</span> String pageId) <span class="hljs-keyword">throws</span> IOException, TemplateException </span>&#123;
        String pageHtml = pageService.getPageHtml(pageId);
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(pageHtml))&#123;
            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">//通过response对象将页面内容输出</span>
                ServletOutputStream outputStream = response.getOutputStream();
                outputStream.write(pageHtml.getBytes(<span class="hljs-string">"utf-8"</span>));
            &#125; <span class="hljs-keyword">catch</span> (IOException e)&#123;
                e.printStackTrace();
            &#125;
        &#125;
    &#125;
&#125;</code></pre></div>

<h2 id="2、页面预览测试"><a href="#2、页面预览测试" class="headerlink" title="2、页面预览测试"></a>2、页面预览测试</h2><h3 id="配置nginx代理"><a href="#配置nginx代理" class="headerlink" title="配置nginx代理"></a>配置nginx代理</h3><blockquote>
<p>这里说一下我们为什么要通过nginx代理来配置页面预览，因为在实际生产环境中，我们的cms节点可能会有多个，需要从nginx进行反向代理，实现负载均衡的等需求。</p>
</blockquote>
<p>为了通过 <code>nginx</code> 请求静态资源（<code>css</code>、图片等），通过 <code>nginx</code> 代理进行页面预览。</p>
<p>在<a href="http://www.xuecheng.xn--com:-2h5f960ibngim6ct9m7zz/">www.xuecheng.com虚拟主机配置：</a></p>
<div class="hljs"><pre><code class="hljs c">#页面预览
location /cms/preview/ &#123;
	proxy_pass http:<span class="hljs-comment">//cms_server_pool/cms/preview/;</span>
&#125;</code></pre></div>

<p>配置 <code>cms_server_pool</code> 将请求转发到 <code>cms</code>：</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#cms页面预览</span>
upstream cms_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">31001</span> weight=<span class="hljs-number">10</span>;
&#125;</code></pre></div>

<p>全部配置</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-meta">#cms页面预览</span>
upstream cms_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">31001</span> weight=<span class="hljs-number">10</span>;
&#125;
server&#123;
	<span class="hljs-built_in">listen</span>       <span class="hljs-number">80</span>;
	server_name  www.xuecheng.com;
	ssi on;
	ssi_silent_errors on;
	location / &#123;
		alias  C:/Users/root/Desktop/笔记/demos/JavaEE/微服务/Project/XueChengOnline/xcEduUI01/xc-ui-pc-<span class="hljs-keyword">static</span>-portal/;
		index  index.html;
	&#125;
	#页面预览
	location /cms/preview/ &#123;
		proxy_pass http:<span class="hljs-comment">//cms_server_pool/cms/preview/;</span>
	&#125;
&#125;</code></pre></div>

<p>重新加载nginx 配置文件。<br>从cms_page找一个页面进行测试。注意：页面配置一定要正确，需设置正确的模板 <code>id</code> 和<code>dataUrl</code>。</p>
<p>在浏览器打开：<a href="http://www.xuecheng.com/cms/preview/5e7a251a3304a252280804dc" target="_blank" rel="noopener">http://www.xuecheng.com/cms/preview/5e7a251a3304a252280804dc</a></p>
<p>5e7a251a3304a252280804dc：轮播图页面的id （根据自己实际用于测试的页面ID）</p>
<p><a href="https://qnoss.codeyee.com/20200704_xuechengday04/image24" target="_blank" rel="noopener"><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image24.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="添加-“页面预览”-链接"><a href="#添加-“页面预览”-链接" class="headerlink" title="添加 “页面预览” 链接"></a>添加 “页面预览” 链接</h3><p>添加预览按钮</p>
<div class="hljs"><pre><code class="hljs java"> &lt;el-table-column label=<span class="hljs-string">"操作"</span> width=<span class="hljs-string">"230"</span> fixed=<span class="hljs-string">"right"</span>&gt;
    &lt;template slot-scope=<span class="hljs-string">"scope"</span>&gt;
        &lt;el-button
        size=<span class="hljs-string">"mini"</span>
        type=<span class="hljs-string">"success"</span>
        <span class="hljs-meta">@click</span>=<span class="hljs-string">"preview(scope.row.pageId)"</span>&gt;预览
        &lt;/el-button&gt;
    &lt;/template&gt;
&lt;/el-table-column&gt;</code></pre></div>

<p>预览函数</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//页面预览</span>
preview(pageId)&#123;
  <span class="hljs-built_in">window</span>.open(<span class="hljs-string">"http://www.xuecheng.com/cms/preview/"</span>+pageId)
&#125;,</code></pre></div>

<p>测试</p>
<p><img src="/2020/08/10/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday04/image25.gif" srcset="/img/loading.gif" alt="img"></p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Freemarker/">Freemarker</a>
                    
                      <a class="hover-with-bg" href="/tags/GridFS/">GridFS</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/11/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday05/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线day05：消息中间件RabbitMQ</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/09/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday03/">
                        <span class="hidden-mobile">学成在线day03：CMS页面管理开发</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

代码块js 用不到，fulid自带有，添加css样式即可实现
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键字</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "本站已经勉强运行&nbsp"+dnum+"&nbsp天";
      document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证20000725号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20000725"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备20000725号</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "学成在线day04：页面静态化&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
