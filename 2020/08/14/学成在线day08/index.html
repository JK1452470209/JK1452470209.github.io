<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>学成在线day08：FastDFS实现课程图片管理 - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>私人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-14 11:34">
      2020-08-14
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      7.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      98
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="😎知识点概览"><a href="#😎知识点概览" class="headerlink" title="😎知识点概览"></a>😎知识点概览</h1><blockquote>
<p>为了方便后续回顾该项目时能够清晰的知道本章节讲了哪些内容，并且能够从该章节的笔记中得到一些帮助，所以在完成本章节的学习后在此对本章节所涉及到的知识点进行总结概述。</p>
</blockquote>
<p>本章节为【学成在线】项目的 <code>day08</code> 的内容</p>
<ul>
<li><code>FastDFS</code> 的 安装与基本使用流程。</li>
<li>基于 <code>Java Api</code> 来操作 <code>FastDFS</code></li>
<li>结合 <code>FastDFS</code> 实现对课程图片的 <code>CRUD</code></li>
<li>图片删除的场景使用 <code>Promise</code> 解决一些问题</li>
</ul>
<h1 id="一、FastDFS-探究"><a href="#一、FastDFS-探究" class="headerlink" title="一、FastDFS 探究"></a>一、FastDFS 探究</h1><h2 id="1-什么是fastDFS"><a href="#1-什么是fastDFS" class="headerlink" title="1. 什么是fastDFS ?"></a>1. 什么是fastDFS ?</h2><h3 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h3><p>FastDFS是用c语言编写的一款开源的分布式文件系统，它是由淘宝资深架构师余庆编写并开源。FastDFS专为互联网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标，使用FastDFS很容易搭建一套高性能的文件服务器集群提供文件上传、下载等服务。</p>
<p>为什么要使用 <code>fastDFS</code> 呢？</p>
<p>上边介绍的 <code>NFS</code>、<code>GFS</code> 都是通用的分布式文件系统，通用的分布式文件系统的优点的是开发体验好，但是系统复杂性高、性能一般，而专用的分布式文件系统虽然开发体验性差，但是系统复杂性低并且性能高。<code>fastDFS</code> 非常适合存储图片等那些小文件，<code>fastDFS</code> 不对文件进行分块，所以它就没有分块合并的开销，<code>fastDFS</code> 网络通信采用 <code>socket</code>，通信速度很快。</p>
<h3 id="2、工作原理"><a href="#2、工作原理" class="headerlink" title="2、工作原理"></a>2、工作原理</h3><p><code>FastDFS</code> 架构包括 <code>Tracker server</code> 和 <code>Storageserver</code>。客户端请求 <code>Tracker server</code> 进行文件上传、下载，通过 <code>Tracker server</code> 调度最终由 <code>Storage server</code> 完成文件上传和下载。</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image1" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image1.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><strong>1）Tracker</strong></p>
<p>Tracker Server作用是负载均衡和调度，通过Tracker server在文件上传时可以根据一些策略找到Storage server提供文件上传服务。可以将 <code>tracker</code> 称为追踪服务器或调度服务器。</p>
<p><code>FastDFS</code> 集群中的 <code>Tracker server</code> 可以有多台，<code>Tracker server</code> 之间是相互平等关系同时提供服务，<code>Tracker server</code> 不存在单点故障。客户端请求 <code>Tracker server</code> 采用轮询方式，如果请求的 <code>tracker</code> 无法提供服务则换另一个 <code>tracker</code>。</p>
<p><strong>2）Storage</strong></p>
<p><code>Storage Server</code> 作用是文件存储，客户端上传的文件最终存储在 <code>Storage</code> 服务器上，<code>Storage server</code> 没有实现自己的文件系统而是使用操作系统的文件系统来管理文件。可以将 <code>storage</code> 称为存储服务器。</p>
<p><code>Storage</code> 集群采用了分组存储方式。<code>storage</code> 集群由一个或多个组构成，集群存储总容量为集群中所有组的存储容量之和。一个组由一台或多台存储服务器组成，组内的 <code>Storage server</code> 之间是平等关系，不同组的 <code>Storage server</code> 之间不会相互通信，同组内的 <code>Storage server</code> 之间会相互连接进行文件同步，从而保证同组内每个storage上的文件完全一致的。一个组的存储容量为该组内的存储服务器容量最小的那个，由此可见组内存储服务器的软硬件配置最好是一致的。</p>
<p>采用分组存储方式的好处是灵活、可控性较强。比如上传文件时，可以由客户端直接指定上传到的组也可以由 <code>tracker</code> 进行调度选择。一个分组的存储服务器访问压力较大时，可以在该组增加存储服务器来扩充服务能力（纵向扩容）。当系统容量不足时，可以增加组来扩充存储容量（横向扩容）。</p>
<p><strong>3）Storage状态收集</strong></p>
<p><code>Storage server</code> 会连接集群中所有的 <code>Tracker server</code>，定时向他们报告自己的状态，包括磁盘剩余空间、文件同步状况、文件上传下载次数等统计信息。</p>
<h3 id="3、文件上传流程"><a href="#3、文件上传流程" class="headerlink" title="3、文件上传流程"></a>3、文件上传流程</h3><p><a href="https://qnoss.codeyee.com/20200704_8/image2" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image2.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>客户端上传文件后存储服务器将 <code>文件ID</code> 返回给客户端，此 <code>文件ID</code> 用于以后访问该文件的索引信息。文件索引信息，包括：组名，虚拟磁盘路径，数据两级目录，文件名。</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image3" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image3.png" srcset="/img/loading.gif" alt="img"></a></p>
<ul>
<li>组名：文件上传后所在的 storage组名称，在文件上传成功后有 storage服务器返回，需要客户端自行保存。</li>
<li>虚拟磁盘路径： storage配置的虚拟路径，与磁盘选项 store_path* 对应。如果配置了store_path0则是M00，如果配置了store_path1则是M01，以此类推。</li>
<li>数据两级目录： storage服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据文件。</li>
<li>文件名：与文件上传时不同。是由存储服务器根据特定信息生成，文件名包含：源存储服务器 IP地址、文件创建时间戳、文件大小、随机数和文件拓展名等信息。</li>
</ul>
<h3 id="4、文件下载流程"><a href="#4、文件下载流程" class="headerlink" title="4、文件下载流程"></a>4、文件下载流程</h3><p><a href="https://qnoss.codeyee.com/20200704_8/image4" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image4.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><code>tracker</code> 根据请求的文件路径即文件ID 来快速定义文件。</p>
<p>比如请求下边的文件：</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image5" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image5.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>1.通过组名tracker能够很快的定位到客户端需要访问的存储服务器组是group1，并选择合适的存储服务器提供客户端访问。</p>
<p>2.存储服务器根据“文件存储虚拟磁盘路径”和“数据文件两级目录”可以很快定位到文件所在目录，并根据文件名找到客户端需要访问的文件。</p>
<h2 id="2-FastDFS入门"><a href="#2-FastDFS入门" class="headerlink" title="2. FastDFS入门"></a>2. FastDFS入门</h2><h3 id="1、环境搭建"><a href="#1、环境搭建" class="headerlink" title="1、环境搭建"></a>1、环境搭建</h3><p>安装 FastDFS 流程 参考： <a href="https://www.cnblogs.com/yufeng218/p/8111961.html" target="_blank" rel="noopener">https://www.cnblogs.com/yufeng218/p/8111961.html</a></p>
<p>搭建好的Centos7成品:</p>
<p>链接：<a href="https://pan.baidu.com/s/1GgUzfd8CnxzemQzvHXSzmA" target="_blank" rel="noopener">https://pan.baidu.com/s/1GgUzfd8CnxzemQzvHXSzmA</a><br>提取码：jk00<br>复制这段内容后打开百度网盘手机App，操作更方便哦</p>
<p><strong>具体搭建过程完全按照这篇博客完成的</strong>：</p>
<p><a href="https://www.cnblogs.com/yufeng218/p/8111961.html" target="_blank" rel="noopener">https://www.cnblogs.com/yufeng218/p/8111961.html</a></p>
<p>感兴趣的可以试着做做。（良心文章）</p>
<p>另外，使用我搭建好的Centos7有几个地方需要<strong>注意一下</strong>。</p>
<h4 id="配置和启动storage"><a href="#配置和启动storage" class="headerlink" title="配置和启动storage"></a>配置和启动storage</h4><ol>
<li>cd切换目录到： /etc/fdfs/ 目录下</li>
<li>修改storage.conf ;   <strong>vi  storage.conf</strong></li>
</ol>
<div class="hljs"><pre><code class="hljs angelscript">#配置tracker服务器:IP
tracker_server=<span class="hljs-number">192.168</span><span class="hljs-number">.172</span><span class="hljs-number">.20</span>:<span class="hljs-number">22122</span>
#如果有多个则配置多个tracker
#tracker_server=<span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.4</span>:<span class="hljs-number">22122</span>
这里的storage.conf配置文件要成自己虚拟机的ip地址</code></pre></div>

<ol start="3">
<li><strong>vi /etc/fdfs/mod_fastdfs.conf，改成虚拟机ip地址（同上）</strong></li>
</ol>
<div class="hljs"><pre><code class="hljs ini"><span class="hljs-attr">base_path</span>=/home/fastdfs
<span class="hljs-attr">tracker_server</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">172.20</span>:<span class="hljs-number">22122</span> 
<span class="hljs-comment">#tracker_server=192.168.172.20:22122 #(多个tracker配置多行)</span>
<span class="hljs-attr">url_have_group_name</span>=<span class="hljs-literal">true</span>        <span class="hljs-comment">#url中包含group名称</span>
<span class="hljs-attr">store_path0</span>=/home/fdfs_storage  <span class="hljs-comment">#指定文件存储路径（上面配置的store路径）</span></code></pre></div>

<p>　　　　4.修改nginx配置文件，改iP地址（同上）</p>
<div class="hljs"><pre><code class="hljs stata"><span class="hljs-keyword">cd</span> /usr/<span class="hljs-keyword">local</span>/nginx/<span class="hljs-keyword">conf</span>/
vi nginx.<span class="hljs-keyword">conf</span></code></pre></div>

<p><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/20.png" srcset="/img/loading.gif" alt="img"></p>
<p>我的Centos7默认配置<strong>tracker，**</strong>storage和nginx默认开机自动启动了**</p>
<p>可以启动完成后进入 /home/fdfs_storage/data 目录下，可以看到已经启动了。</p>
<p><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/21.png" srcset="/img/loading.gif" alt="img"></p>
<p> nginx可以通过ps -ef | grep nginx查看进程，</p>
<p><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/22.png" srcset="/img/loading.gif" alt="img"></p>
<h4 id="上传图片测试"><a href="#上传图片测试" class="headerlink" title="上传图片测试"></a>上传图片测试</h4><p>拷贝一张图片1.jpg 到Centos服务器上的 root目录下,输入以下指令</p>
<div class="hljs"><pre><code class="hljs awk"><span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/fdfs_test /</span>etc<span class="hljs-regexp">/fdfs/</span>client.conf upload <span class="hljs-regexp">/root/</span><span class="hljs-number">1</span>.jpg</code></pre></div>

<p><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/23.png" srcset="/img/loading.gif" alt="img"></p>
<p> 红色既是url地址，在浏览器上输入，可以看到上传图片成功！！</p>
<p><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/24.png" srcset="/img/loading.gif" alt="img"></p>
<h3 id="2、上传、下载、查询-测试"><a href="#2、上传、下载、查询-测试" class="headerlink" title="2、上传、下载、查询 测试"></a>2、上传、下载、查询 测试</h3><p>在工程下创建 <code>test-fastdfs</code> 模块</p>
<h4 id="1）上传测试"><a href="#1）上传测试" class="headerlink" title="1）上传测试"></a>1）上传测试</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@RunWith</span>(SpringRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">TestFastDFS</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 测试文件上传</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFileUpload</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//加载配置文件</span>
            ClientGlobal.initByProperties(<span class="hljs-string">"config/fastdfs-client.properties"</span>);
            <span class="hljs-comment">//连接 Tracker</span>
            TrackerClient trackerClient = <span class="hljs-keyword">new</span> TrackerClient();
            TrackerServer trackerServer = trackerClient.getConnection();
            <span class="hljs-comment">//获取 Storage</span>
            StorageServer storeStorage = trackerClient.getStoreStorage(trackerServer);
            <span class="hljs-comment">//创建 Storage Client</span>
            StorageClient1 storageClient1 = <span class="hljs-keyword">new</span> StorageClient1(trackerServer, storeStorage);
            <span class="hljs-comment">//向 Storage 服务器上传文件,拿到文件id</span>
            String filePath = <span class="hljs-string">"d:/test1.html"</span>;
            String fileId = storageClient1.upload_file1(filePath, <span class="hljs-string">"html"</span>, <span class="hljs-keyword">null</span>);
            System.out.println(<span class="hljs-string">"上传成功："</span> + fileId);

        &#125; <span class="hljs-keyword">catch</span> (Exception ex)&#123;
            ex.printStackTrace();
        &#125;
    &#125;
&#125;</code></pre></div>

<p>在上述的代码中，我们通过访问 <code>Tracker</code> 将 <code>d:/test1.html</code> 文件上传到了 Storage 服务器中，上传完成后得到了文件的完整的储存路径，如下：</p>
<p><code>group1/M00/00/00/CgEBmF6QKa-Abjv7AAAGqbcDljA60.html</code></p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image6" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image6.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>我们可以在 <code>Storage</code> 中的物理 <code>fdfs_storage/data</code> 路径找到该文件</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image7" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image7.png" srcset="/img/loading.gif" alt="img"></a></p>
<h4 id="2）文件查询"><a href="#2）文件查询" class="headerlink" title="2）文件查询"></a>2）文件查询</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 文件信息查询</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TestFileInfoQuery</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//加载配置文件</span>
        ClientGlobal.initByProperties(<span class="hljs-string">"config/fastdfs-client.properties"</span>);
        <span class="hljs-comment">//连接 Tracker</span>
        TrackerClient trackerClient = <span class="hljs-keyword">new</span> TrackerClient();
        TrackerServer trackerServer = trackerClient.getConnection();
        <span class="hljs-comment">//获取 Storage</span>
        StorageServer storeStorage = trackerClient.getStoreStorage(trackerServer);
        <span class="hljs-comment">//创建 Storage Client</span>
        StorageClient1 storageClient1 = <span class="hljs-keyword">new</span> StorageClient1(trackerServer, storeStorage);

        String fileId = <span class="hljs-string">"group1/M00/00/00/CgEBmF6QKa-Abjv7AAAGqbcDljA60.html"</span>;
        FileInfo fileInfo = storageClient1.query_file_info1(fileId);
        System.out.println(<span class="hljs-string">"文件信息: "</span>+ fileInfo);
    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
        e.printStackTrace();
    &#125;
&#125;</code></pre></div>

<p>运行结果</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image8" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image8.png" srcset="/img/loading.gif" alt="img"></a></p>
<h4 id="3）文件下载"><a href="#3）文件下载" class="headerlink" title="3）文件下载"></a>3）文件下载</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 文件下载</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TestFileDownload</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">//加载配置文件</span>
        ClientGlobal.initByProperties(<span class="hljs-string">"config/fastdfs-client.properties"</span>);
        <span class="hljs-comment">//连接 Tracker</span>
        TrackerClient trackerClient = <span class="hljs-keyword">new</span> TrackerClient();
        TrackerServer trackerServer = trackerClient.getConnection();
        <span class="hljs-comment">//获取 Storage</span>
        StorageServer storeStorage = trackerClient.getStoreStorage(trackerServer);
        <span class="hljs-comment">//创建 Storage Client</span>
        StorageClient1 storageClient1 = <span class="hljs-keyword">new</span> StorageClient1(trackerServer, storeStorage);

        String fileId = <span class="hljs-string">"group1/M00/00/00/CgEBmF6QKa-Abjv7AAAGqbcDljA60.html"</span>;
        String saveToPath = <span class="hljs-string">"d:/test.html"</span>;
        <span class="hljs-comment">//下载文件</span>
        <span class="hljs-keyword">byte</span>[] bytes = storageClient1.download_file1(fileId);
        FileOutputStream fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(saveToPath));
        fileOutputStream.write(bytes);
        System.out.println(<span class="hljs-string">"下载成功! "</span> + saveToPath);
    &#125; <span class="hljs-keyword">catch</span> (Exception ex)&#123;
        ex.printStackTrace();
    &#125;
&#125;</code></pre></div>

<p>运行结果</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image9" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image9.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="3、搭建图片虚拟主机"><a href="#3、搭建图片虚拟主机" class="headerlink" title="3、搭建图片虚拟主机"></a>3、搭建图片虚拟主机</h3><h4 id="1）-在storage上安装Nginx"><a href="#1）-在storage上安装Nginx" class="headerlink" title="1） 在storage上安装Nginx"></a>1） 在storage上安装Nginx</h4><p>在 <code>storage server</code> 上安装 <code>nginx</code> 的目的是对外通过 <code>http</code> 访问 <code>storage server</code> 上的文 件。使用 <code>nginx</code> 的模块 <code>FastDFS-nginx-module</code> 的作用是通过 <code>http</code> 方式访问 <code>storage</code> 中 的文件，当 <code>storage</code> 本机没有要找的文件时向源<code>storage</code> 主机代理请求文件。</p>
<p>在storage上安装nginx（安装 <code>FastDFS-nginx-module</code> 模块）</p>
<p>参考：<code>FastDFS安装教程.pdf</code> 进行安装</p>
<p>安装完成启动 <code>storage</code>上的 <code>nginx</code>：</p>
<div class="hljs"><pre><code class="hljs shell">/usr/local/nginx/sbin/nginx ‐c /usr/local/nginx/conf/nginx‐fdfs.conf</code></pre></div>

<h4 id="2）配置-Nginx-的图片服务的虚拟主机"><a href="#2）配置-Nginx-的图片服务的虚拟主机" class="headerlink" title="2）配置 Nginx 的图片服务的虚拟主机"></a>2）配置 Nginx 的图片服务的虚拟主机</h4><p>图片服务虚拟主机的作用是负载均衡，将图片请求转发到 <code>storage server</code> 上。</p>
<p>1、 通过图片服务虚拟主机请求图片流程图</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image10" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image10.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2、在 <code>nginx</code> 图片代理服务上配置图片服务器虚拟主机</p>
<p>修改本地的 <code>hosts</code> 文件，将 img.xuecheng.com 映射到本地IP <code>127.0.0.1</code></p>
<p>windows 的 hosts 文件路径为：<code>C:\Windows\System32\drivers\etc</code></p>
<div class="hljs"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span> img.xuecheng.com</code></pre></div>

<p>增加 <code>nginx</code> 虚拟机主机</p>
<div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">图片服务</span>
upstream img_server_pool&#123;
<span class="hljs-meta">	#</span><span class="bash">server 192.168.101.64:80 weight=10;</span>
	server 10.1.1.152:80 weight=10;
&#125; 
<span class="hljs-meta">#</span><span class="bash">学成网图片服务</span>
server &#123;
	listen       80;    
	server_name img.xuecheng.com;    

<span class="hljs-meta">	#</span><span class="bash">个人中心    </span>
	location /group1 &#123;      
		proxy_pass http://img_server_pool;          
	&#125;     
	location /group2 &#123;      
		proxy_pass http://img_server_pool;          
	&#125;     
&#125;</code></pre></div>

<p>3、测试访问</p>
<p><a href="http://img.xuecheng.com/group1/M00/00/00/CgEBmF6QKa-Abjv7AAAGqbcDljA60.html" target="_blank" rel="noopener">http://img.xuecheng.com/group1/M00/00/00/CgEBmF6QKa-Abjv7AAAGqbcDljA60.html</a></p>
<p>成功映射到 storage 服务上</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image11" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image11.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h3><p>通过本次课程的学习您要达到以下目标：</p>
<p><strong>1）了解分布式文件系统的概念及应用场景</strong></p>
<p>分布式文件系统是通过网络将单机上的文件系统组成一个网络文件系统。</p>
<p>分布式文件系统主要应用在大型互联网项目中，实现图片存储、音视频存储等服务。</p>
<p>分布式文件系统的优点：可以快速扩容存储，提高文件访问速度。</p>
<p><strong>2）理解fastDFS的工作原理</strong></p>
<p>fastDFS 由 <code>tracker</code> 和 <code>storage</code> 组成，它们都可以部署集群。</p>
<p><code>tracker</code> 负责调度，<code>storage</code> 负责存储。</p>
<p><strong>3）掌握 fastDFS 存取文件方法</strong></p>
<p>客户端与 <code>fastDFS</code> 采用 <code>socket</code> 协议通信，可以采用官方提供的 <code>java</code>版本的 <code>fastDSF-client</code>快速开发。</p>
<p><strong>4）能够动手搭建一个 fastDSF 文件服务器</strong></p>
<h1 id="二、上传课程图片"><a href="#二、上传课程图片" class="headerlink" title="二、上传课程图片"></a>二、上传课程图片</h1><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>在很多系统都有上传图片/上传文件的需求，比如：上传课程图片、上传课程资料、上传用户头像等，为了提供系统的可重用性专门设立文件系统服务承担图片/文件的管理，文件系统服务实现对文件的上传、删除、查询等功能进行管理。</p>
<p>各个子系统不再开发上传文件的请求，各个子系统通过文件系统服务进行文件的上传、删除等操作。文件系统服务最终会将文件存储到 <code>fastDSF</code> 文件系统中。</p>
<p>下图是各各子系统与文件系统服务之间的关系：</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image12" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image12.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>下图是课程管理中上传图片处理流程：</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image13" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image13.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>执行流程如下：</p>
<p>1、管理员进入教学管理前端，点击上传图片</p>
<p>2、图片上传至文件系统服务，文件系统请求 <code>fastDFS</code> 上传文件</p>
<p>3、文件系统将文件入库，存储到文件系统服务数据库中。</p>
<p>4、文件系统服务向前端返回文件上传结果，如果成功则包括文件的 <code>Url</code> 路径。</p>
<p>5、课程管理前端请求 课程管理 进行保存课程图片信息到课程 数据库。</p>
<p>6、课程管理服务将课程图片保存在 课程数据库。</p>
<h2 id="2-创建工程"><a href="#2-创建工程" class="headerlink" title="2. 创建工程"></a>2. 创建工程</h2><p>导入<code>xc-service-base-filesystem.zip</code>工程。</p>
<p>1）工程目录结构如下</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image14" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image14.png" srcset="/img/loading.gif" alt="image-20200410193248194"></a></p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image14" target="_blank" rel="noopener">image-20200410193248194</a></p>
<p>1）pom.xml 文件</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-framework-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../xc-framework-parent/pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-service-base-filesystem<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-service-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-framework-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuecheng<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xc-framework-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.oschina.zcx7878<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastdfs-client-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre></div>

<p>2）配置文件</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">22100</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">xc-service-base-filesystem</span>
<span class="hljs-comment">#mongo配置</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">mongodb:</span>
      <span class="hljs-attr">database:</span> <span class="hljs-string">xc_fs</span>
      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://root:123123@127.0.0.1:27017</span>
<span class="hljs-comment">#SpringMVC上传文件配置</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">multipart:</span>
      <span class="hljs-comment">#默认支持文件上传.</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
      <span class="hljs-comment">#支持文件写入磁盘.</span>
      <span class="hljs-attr">file-size-threshold:</span> <span class="hljs-number">0</span>
      <span class="hljs-comment"># 上传文件的临时目录</span>
      <span class="hljs-attr">location:</span>
      <span class="hljs-comment"># 最大支持文件大小</span>
      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">1MB</span>
      <span class="hljs-comment"># 最大支持请求大小</span>
      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">30MB</span>
<span class="hljs-attr">xuecheng:</span>
  <span class="hljs-attr">fastdfs:</span>
    <span class="hljs-attr">connect_timeout_in_seconds:</span> <span class="hljs-number">5</span>
    <span class="hljs-attr">network_timeout_in_seconds:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">charset:</span> <span class="hljs-string">UTF-8</span>
    <span class="hljs-attr">tracker_servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.101</span><span class="hljs-number">.65</span><span class="hljs-string">:22122</span> <span class="hljs-comment">#多个 trackerServer中间以逗号分隔</span></code></pre></div>

<h2 id="3-构建接口"><a href="#3-构建接口" class="headerlink" title="3. 构建接口"></a>3. 构建接口</h2><p>系统的文件信息（图片、文档等小文件的信息）在mongodb中存储，下边是文件信息的模型类。</p>
<h3 id="1、模型类"><a href="#1、模型类" class="headerlink" title="1、模型类"></a>1、模型类</h3><p><strong>1）模型类如下</strong></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-meta">@Document</span>(collection = <span class="hljs-string">"filesystem"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileSystem</span> </span>&#123;
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String fileId;
    <span class="hljs-comment">//文件请求路径</span>
    <span class="hljs-keyword">private</span> String filePath;
    <span class="hljs-comment">//文件大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> fileSize;
    <span class="hljs-comment">//文件名称</span>
    <span class="hljs-keyword">private</span> String fileName;
    <span class="hljs-comment">//文件类型</span>
    <span class="hljs-keyword">private</span> String fileType;
    <span class="hljs-comment">//图片宽度</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> fileWidth;
    <span class="hljs-comment">//图片高度</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> fileHeight;
    <span class="hljs-comment">//用户id，用于授权暂时不用</span>
    <span class="hljs-keyword">private</span> String userId;
    <span class="hljs-comment">//业务key</span>
    <span class="hljs-keyword">private</span> String businesskey;
    <span class="hljs-comment">//业务标签</span>
    <span class="hljs-keyword">private</span> String filetag;
    <span class="hljs-comment">//文件元信息</span>
    <span class="hljs-keyword">private</span> Map metadata;
&#125;</code></pre></div>

<p>说明：</p>
<ul>
<li>fileId：<code>fastDFS</code> 返回的文件 ID。</li>
<li>filePath：请求<code>fastDFS</code>浏览文件 URL。</li>
<li>filetag：文件标签，由于文件系统服务是公共服务，文件系统服务会为使用文件系统服务的子系统分配文件标签，用于标识此文件来自哪个系统。</li>
<li>businesskey：文件系统服务为其它子系统提供的一个业务标识字段，各子系统根据自己的需求去使用，比如：课程管理会在此字段中存储课程 <code>id</code> 用于标识该图片属于哪个课程。</li>
<li>metadata：文件相关的元信息。</li>
</ul>
<p><strong>2）数据库 collection 集合</strong></p>
<p>在 <code>mongodb</code> 创建数据库xc_fs（文件系统数据库），并创建集合 <code>filesystem</code>。</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image15" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image15.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="2、API-接口"><a href="#2、API-接口" class="headerlink" title="2、API 接口"></a>2、API 接口</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(value = <span class="hljs-string">"文件管理接口"</span>, description = <span class="hljs-string">"文件管理接口，提供对文件的CRUD"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FileSystemControllerApi</span> </span>&#123;

    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"上传文件接口"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> UploadFileResult <span class="hljs-title">uploadFile</span><span class="hljs-params">(MultipartFile multipartFile,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       String fileTage,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       String businessKey,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       String metaData)</span></span>;

&#125;</code></pre></div>

<h3 id="3、Dao-层"><a href="#3、Dao-层" class="headerlink" title="3、Dao 层"></a>3、Dao 层</h3><p>dao 层继承 <code>Spring Data Mongodb</code> 的 API</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.filesystem.dao;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.filesystem.FileSystem;
<span class="hljs-keyword">import</span> org.springframework.data.mongodb.repository.MongoRepository;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FileSystemRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">FileSystem</span>,<span class="hljs-title">String</span>&gt; </span>&#123;

&#125;</code></pre></div>

<h3 id="4、Service-层"><a href="#4、Service-层" class="headerlink" title="4、Service 层"></a>4、Service 层</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.filesystem.service;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.xuecheng.filesystem.dao.FileSystemRepository;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.filesystem.FileSystem;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.filesystem.response.FileSystemCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.filesystem.response.UploadFileResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.csource.common.MyException;
<span class="hljs-keyword">import</span> org.csource.fastdfs.*;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileSystemService</span> </span>&#123;
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xuecheng.fastdfs.tracker_servers&#125;"</span>)
    String tracker_servers;
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xuecheng.fastdfs.connect_timeout_in_seconds&#125;"</span>)
    <span class="hljs-keyword">int</span> connect_timeout_in_seconds;
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xuecheng.fastdfs.network_timeout_in_seconds&#125;"</span>)
    <span class="hljs-keyword">int</span> network_timeout_in_seconds;
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xuecheng.fastdfs.charset&#125;"</span>)
    String charset;

    <span class="hljs-meta">@Autowired</span>
    FileSystemRepository fileSystemRepository;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 上传文件到FastDFS</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> multipartFile 文件数据</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileTag 文件标签</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> businessKey 业务key</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metaData 文件元数据</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UploadFileResult <span class="hljs-title">uploadFile</span><span class="hljs-params">(MultipartFile multipartFile,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       String fileTag,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       String businessKey,</span></span>
<span class="hljs-function"><span class="hljs-params">                                       String metaData)</span></span>&#123;
        <span class="hljs-comment">//验证提交的文件是否为空</span>
        <span class="hljs-keyword">if</span>(multipartFile == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(FileSystemCode.FS_UPLOADFILE_FILEISNULL);
        &#125;

        <span class="hljs-comment">//第一步：将文件上传到 FastDFS中</span>
        String fileId = <span class="hljs-keyword">this</span>.fdfsUpload(multipartFile);
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(fileId))&#123;    <span class="hljs-comment">//上传文件为空时抛出异常</span>
            ExceptionCast.cast(FileSystemCode.FS_UPLOADFILE_SERVERFAIL);
        &#125;

        <span class="hljs-comment">//第二步：将文件储存到mongoDB内</span>

        <span class="hljs-comment">//设置相关的文件信息</span>
        FileSystem fileSystem = <span class="hljs-keyword">new</span> FileSystem();
        fileSystem.setFileId(fileId);
        fileSystem.setFileName(multipartFile.getOriginalFilename());
        fileSystem.setBusinesskey(businessKey);
        fileSystem.setFilePath(fileId); <span class="hljs-comment">//FastDFS的fileId就是实际的物理路径</span>
        fileSystem.setFileSize(multipartFile.getSize());
        fileSystem.setFiletag(fileTag);
        fileSystem.setFileType(multipartFile.getContentType());
        <span class="hljs-comment">//文件元数据需要转换成Map对象</span>
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(metaData))&#123;
            Map metaDataMap = JSON.parseObject(metaData, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            fileSystem.setMetadata(metaDataMap);
        &#125;
        FileSystem save = fileSystemRepository.save(fileSystem);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UploadFileResult(CommonCode.SUCCESS,save);
    &#125;

    <span class="hljs-comment">//上传文件到FastDFS</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">fdfsUpload</span><span class="hljs-params">(MultipartFile multipartFile)</span></span>&#123;
        <span class="hljs-comment">//初始化FastDFS的环境</span>
        <span class="hljs-keyword">try</span> &#123;
            initFdfsConfig();
            TrackerClient trackerClient = <span class="hljs-keyword">new</span> TrackerClient();
            TrackerServer trackerServer = trackerClient.getConnection();
            <span class="hljs-comment">//得到 Storage 连接信息</span>
            StorageServer storeStorage = trackerClient.getStoreStorage(trackerServer);
            <span class="hljs-comment">//获取 Storage 客户端</span>
            StorageClient1 storageClient1 = <span class="hljs-keyword">new</span> StorageClient1(trackerServer, storeStorage);

            <span class="hljs-comment">//上传文件</span>
            <span class="hljs-keyword">byte</span>[] fileBytes = multipartFile.getBytes();   <span class="hljs-comment">// 获取文件信息</span>
            String originalFilename = multipartFile.getOriginalFilename();
            <span class="hljs-comment">// 获取文件拓展名</span>
            String extStr = originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">"."</span>) + <span class="hljs-number">1</span>);
            <span class="hljs-comment">//上传文件</span>
            String fileId = storageClient1.upload_file1(fileBytes, extStr, <span class="hljs-keyword">null</span>);
            <span class="hljs-keyword">return</span> fileId;
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-comment">//初始化FastDFS环境</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initFdfsConfig</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">try</span> &#123;
              ClientGlobal.initByTrackers(tracker_servers);
              ClientGlobal.setG_connect_timeout(connect_timeout_in_seconds);
              ClientGlobal.setG_network_timeout(network_timeout_in_seconds);
              ClientGlobal.setG_charset(charset);
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
            <span class="hljs-comment">//抛出异常</span>
            ExceptionCast.cast(FileSystemCode.FS_INITFDFS_ERROR);
        &#125;
    &#125;
&#125;</code></pre></div>

<h3 id="5、Controller-层"><a href="#5、Controller-层" class="headerlink" title="5、Controller 层"></a>5、Controller 层</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.filesystem.controller;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/filesystem"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileSystemController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FileSystemControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    FileSystemService fileSystemService;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/upload"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> UploadFileResult <span class="hljs-title">uploadFile</span><span class="hljs-params">(MultipartFile multipartFile, String fileTag, String businessKey, String metaData)</span> </span>&#123;
        <span class="hljs-keyword">return</span> fileSystemService.uploadFile(multipartFile,fileTag,businessKey,metaData);
    &#125;
&#125;</code></pre></div>

<h3 id="6、测试"><a href="#6、测试" class="headerlink" title="6、测试"></a>6、测试</h3><p>在 Swagger UI 生成的接口文档内进行测试 <a href="http://localhost:22100/swagger-ui.html" target="_blank" rel="noopener">http://localhost:22100/swagger-ui.html</a></p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image16" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image16.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="4-前端配置"><a href="#4-前端配置" class="headerlink" title="4. 前端配置"></a>4. 前端配置</h2><h3 id="1、需求"><a href="#1、需求" class="headerlink" title="1、需求"></a>1、需求</h3><p>上传图片界面如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image17" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image17.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>点击“加号”上传图片，图片上传成功自动显示；点击“删除”将删除图片。</p>
<h3 id="2、页面"><a href="#2、页面" class="headerlink" title="2、页面"></a>2、页面</h3><p>使用 <code>Element-UI</code> 的<code>Upload</code>上传组件实现上边的效果。</p>
<p><strong>1) template</strong></p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐upload</span></span>
<span class="hljs-tag">  <span class="hljs-attr">action</span>=<span class="hljs-string">"/filesystem/upload"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">list</span>‐<span class="hljs-attr">type</span>=<span class="hljs-string">"picture‐card"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">name</span>=<span class="hljs-string">"multipartFile"</span> </span>
<span class="hljs-tag">  <span class="hljs-attr">:before</span>‐<span class="hljs-attr">upload</span>=<span class="hljs-string">"setbusinesskey"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">:on</span>‐<span class="hljs-attr">success</span>=<span class="hljs-string">"handleSuccess"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">:file</span>‐<span class="hljs-attr">list</span>=<span class="hljs-string">"fileList"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">:limit</span>=<span class="hljs-string">"picmax"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">:on</span>‐<span class="hljs-attr">exceed</span>=<span class="hljs-string">"rejectupload"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">:data</span>=<span class="hljs-string">"uploadval"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el‐icon‐plus"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el‐upload</span>&gt;</span></code></pre></div>

<p>el-upload参数说明：</p>
<ul>
<li>action：必选参数，上传的地址</li>
<li>list-type：文件列表的类型（text/picture/picture-card）</li>
<li>name: 提交的文件参数名称，这里要跟后端接收的对应上</li>
<li>before-upload：上传前执行钩子方法 ，function(file)</li>
<li>on-success：上传成功 执行的钩子方法 ，function(response, file, fileList)</li>
<li>on-error：上传失败的钩子方法，function(err, file, fileList)</li>
<li>on-remove：文件删除的钩子方法，function(file, fileList)</li>
<li>file-list：文件列表，此列表为上传成功 的文件</li>
<li>limit：最大允许上传个数</li>
<li>on-exceed：文件超出个数限制时的钩子，方法为：function(files, fileList)</li>
<li>data：提交上传的额外参数，需要封装为json对象，最终提交给服务端为key/value串</li>
</ul>
<p><strong>2) 数据模型</strong></p>
<div class="hljs"><pre><code class="hljs js">&lt;script&gt;
  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> sysConfig <span class="hljs-keyword">from</span> <span class="hljs-string">'@/../config/sysConfig'</span>;
  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> courseApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../api/course'</span>;
  <span class="hljs-keyword">import</span> utilApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../common/utils'</span>;
  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> systemApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../base/api/system'</span>;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
    data() &#123;
      <span class="hljs-keyword">return</span> &#123;
        picmax:<span class="hljs-number">1</span>,
        courseid:<span class="hljs-string">''</span>,
        dialogImageUrl: <span class="hljs-string">''</span>,
        dialogVisible: <span class="hljs-literal">false</span>,
        fileList:[],
        uploadval:&#123;<span class="hljs-attr">filetag</span>:<span class="hljs-string">"course"</span>&#125;,
        imgUrl:sysConfig.imgUrl
      &#125;
    &#125;,
    methods: &#123;
      <span class="hljs-comment">//超出文件上传个数提示信息</span>
      rejectupload()&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"最多上传"</span>+<span class="hljs-keyword">this</span>.picmax+<span class="hljs-string">"个图片"</span>);
      &#125;,
      <span class="hljs-comment">//在上传前设置上传请求的数据</span>
      setuploaddata()&#123;
      &#125;,
      <span class="hljs-comment">//删除图片</span>
      handleRemove(file, fileList) &#123;
        <span class="hljs-built_in">console</span>.log(file)
        alert(<span class="hljs-string">'删除'</span>)
      &#125;,
      <span class="hljs-comment">//上传成功的钩子方法</span>
      handleSuccess(response, file, fileList)&#123;
        <span class="hljs-built_in">console</span>.log(response)
        alert(<span class="hljs-string">'上传成功'</span>)
      &#125;,
      <span class="hljs-comment">//上传失败执行的钩子方法</span>
      handleError(err, file, fileList)&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'上传失败'</span>);
        <span class="hljs-comment">//清空文件队列</span>
        <span class="hljs-keyword">this</span>.fileList = []
      &#125;
    &#125;,
    mounted()&#123;
      <span class="hljs-comment">//课程id</span>
      <span class="hljs-keyword">this</span>.courseid = <span class="hljs-keyword">this</span>.$route.params.courseid;
    &#125;
  &#125;
&lt;<span class="hljs-regexp">/script&gt;</span></code></pre></div>

<h3 id="3、测试"><a href="#3、测试" class="headerlink" title="3、测试"></a>3、测试</h3><p>1、点击“加号”测试上传图片</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image18" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image18.png" srcset="/img/loading.gif" alt="img"></a></p>
<h1 id="三、保存课程图片"><a href="#三、保存课程图片" class="headerlink" title="三、保存课程图片"></a>三、保存课程图片</h1><h2 id="1-需求分析-1"><a href="#1-需求分析-1" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>图片上传到文件系统后，其它子系统如果想使用图片可以引用图片的地址，课程管理模块使用图片的方式是将图片地址保存到课程数据库中。</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image19" target="_blank" rel="noopener"><img src="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/image19.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>业务流程如下：</p>
<p>1、上传图片到文件系统服务</p>
<p>2、保存图片地址到课程管理服务在课程管理服务创建保存课程与图片对应关系的表 <code>course_pic</code>。</p>
<p>3、在 <code>course_pic</code> 保存图片成功后方可查询课程图片信息。</p>
<p>通过查询 <code>course_pic</code> 表数据则查询到某课程的图片信息。</p>
<h2 id="2-构建接口"><a href="#2-构建接口" class="headerlink" title="2. 构建接口"></a>2. 构建接口</h2><h3 id="1、API-接口"><a href="#1、API-接口" class="headerlink" title="1、API 接口"></a>1、API 接口</h3><p>在 <code>com.xuecheng.api.course</code> 包下创建该接口</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"保存课程图片信息"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveCoursePic</span><span class="hljs-params">(String courseId, String pic)</span></span>;</code></pre></div>

<h3 id="2、Dao-层"><a href="#2、Dao-层" class="headerlink" title="2、Dao 层"></a>2、Dao 层</h3><p>由于是对 <code>mysql</code> 的单表操作，这里我们通过继承 spring data jpa 提供的接口来实现 dao</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_course.dao;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CourseBase;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CoursePic;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * Created by Administrator.</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CoursePicRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">CoursePic</span>,<span class="hljs-title">String</span>&gt; </span>&#123;

&#125;</code></pre></div>

<h3 id="3、Service-层"><a href="#3、Service-层" class="headerlink" title="3、Service 层"></a>3、Service 层</h3><p>在 <code>CourseService</code> 下新增 <code>saveCoursePic</code> 方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 保存课程图片信息到数据库</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId 课程id</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pic 图片id</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>

<span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">//Mysql操作需要添加到Spring事务</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveCoursePic</span><span class="hljs-params">(String courseId, String pic)</span> </span>&#123;
    CoursePic coursePic = <span class="hljs-keyword">null</span>;
    <span class="hljs-comment">//判断该课程id是否已经存在图片</span>
    Optional&lt;CoursePic&gt; byId = coursePicRepository.findById(courseId);
    <span class="hljs-keyword">if</span>(byId.isPresent())&#123;
        coursePic = byId.get();
    &#125;
    <span class="hljs-comment">//不存在则重新创建一个课程图片对象并保存信息</span>
    <span class="hljs-keyword">if</span>(coursePic == <span class="hljs-keyword">null</span>)&#123;
        coursePic = <span class="hljs-keyword">new</span> CoursePic();
    &#125;

    coursePic.setCourseid(courseId);
    coursePic.setPic(pic);
    CoursePic save = coursePicRepository.save(coursePic);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
&#125;</code></pre></div>

<h3 id="4、Controller-层"><a href="#4、Controller-层" class="headerlink" title="4、Controller 层"></a>4、Controller 层</h3><p>在 <code>CourseContorller</code> 下新增 <code>saveCoursePic</code> 方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 保存课程信息与图片的对应关系</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId 课程id</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pic 图片文件id</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/coursepic/add"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveCoursePic</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"courseId"</span>)</span> String courseId, @<span class="hljs-title">RequestParam</span><span class="hljs-params">(<span class="hljs-string">"pic"</span>)</span> String pic) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.saveCoursePic(courseId,pic);
&#125;</code></pre></div>

<h2 id="3-前端配置"><a href="#3-前端配置" class="headerlink" title="3. 前端配置"></a>3. 前端配置</h2><h3 id="1、需求-1"><a href="#1、需求-1" class="headerlink" title="1、需求"></a>1、需求</h3><p>前端需要在上传图片成功后保存课程图片信息。</p>
<h3 id="2、页面-1"><a href="#2、页面-1" class="headerlink" title="2、页面"></a>2、页面</h3><p>在 course.js 下创建 <code>ajax</code> 请求的 api</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//保存课程图片地址到课程数据 库</span>
export <span class="hljs-keyword">const</span> addCoursePic= (courseId,pic) =&gt; &#123;
  <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/course/coursepic/add?courseId='</span>+courseId+<span class="hljs-string">"&amp;pic="</span>+pic)
&#125;</code></pre></div>

<p>el-upload 组件在上传成功后，会调用上传成功的钩子方法，配置如 <code>:on-success=&quot;handleSuccess&quot;</code></p>
<p>钩子方法如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//上传成功的钩子方法</span>
handleSuccess(response, file, fileList)&#123;
    console.log(response)
    <span class="hljs-comment">//调用课程管理的保存图片接口，将图片信息保存到课程管理数据库course_pic中</span>
    <span class="hljs-comment">//从response得到新的图片文件的地址</span>
    <span class="hljs-keyword">if</span>(response.success)&#123;
        let fileId = response.fileSystem.fileId;
        courseApi.addCoursePic(<span class="hljs-keyword">this</span>.courseid,fileId).then(res=&gt;&#123;
            <span class="hljs-keyword">if</span>(res.success)&#123;
                <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"图片上传成功"</span>)
            &#125;<span class="hljs-keyword">else</span>&#123;
                <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"图片保存失败!"</span>)
            &#125;
        &#125;)
    &#125;
&#125;,</code></pre></div>

<h3 id="3、测试-1"><a href="#3、测试-1" class="headerlink" title="3、测试"></a>3、测试</h3><p>上传成功</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image20" target="_blank" rel="noopener"><img src="https://qnoss.codeyee.com/20200704_8/image20" srcset="/img/loading.gif" alt="img"></a></p>
<h1 id="四、图片信息查询"><a href="#四、图片信息查询" class="headerlink" title="四、图片信息查询"></a>四、图片信息查询</h1><h2 id="1-需求分析-2"><a href="#1-需求分析-2" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>在进入到 课程图片 页面之前，根据当前课程的id，找到该课程对应的课程图片。</p>
<h2 id="2-构建接口-1"><a href="#2-构建接口-1" class="headerlink" title="2. 构建接口"></a>2. 构建接口</h2><h3 id="1、API-接口-1"><a href="#1、API-接口-1" class="headerlink" title="1、API 接口"></a>1、API 接口</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"获得课程图片信息"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CoursePic <span class="hljs-title">getCoursePic</span><span class="hljs-params">(String courseId)</span></span>;</code></pre></div>

<h3 id="2、Dao-层-1"><a href="#2、Dao-层-1" class="headerlink" title="2、Dao 层"></a>2、Dao 层</h3><p><code>CoursePicRepository</code> ，在编写保存功能时已构建。</p>
<h3 id="3、Service-层-1"><a href="#3、Service-层-1" class="headerlink" title="3、Service 层"></a>3、Service 层</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 根据课程id获得课程的图片信息</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Transactional</span> <span class="hljs-comment">//Mysql操作需要添加到Spring事务</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> CoursePic <span class="hljs-title">getCoursePic</span><span class="hljs-params">(String courseId)</span> </span>&#123;
    Optional&lt;CoursePic&gt; byId = coursePicRepository.findById(courseId);
    <span class="hljs-keyword">if</span>(byId.isPresent())&#123;
        CoursePic coursePic = byId.get();
        <span class="hljs-keyword">return</span> coursePic;
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
&#125;</code></pre></div>

<h3 id="4、Controller-层-1"><a href="#4、Controller-层-1" class="headerlink" title="4、Controller 层"></a>4、Controller 层</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 根据课程id获取该课程的课程图片信息</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span> 由于这里每个课程只有一个图片，所以只返回一个 CoursePic 对象</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coursepic/get/&#123;courseId&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CoursePic <span class="hljs-title">getCoursePic</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.getCoursePic(courseId);
&#125;</code></pre></div>

<h3 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h3><p><a href="https://qnoss.codeyee.com/20200704_8/image21" target="_blank" rel="noopener"><img src="https://qnoss.codeyee.com/20200704_8/image21" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-前端配置-1"><a href="#3-前端配置-1" class="headerlink" title="3. 前端配置"></a>3. 前端配置</h2><h3 id="1、需求-2"><a href="#1、需求-2" class="headerlink" title="1、需求"></a>1、需求</h3><p>在课程图片页面的 <code>mounted</code> 钩子方法 中查询课程图片信息，并将图片地址赋值给数据对象</p>
<h3 id="2、页面-2"><a href="#2、页面-2" class="headerlink" title="2、页面"></a>2、页面</h3><p>API 接口</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//查询课程图片</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> findCoursePicList = <span class="hljs-function"><span class="hljs-params">courseId</span> =&gt;</span> &#123;
  <span class="hljs-keyword">return</span> http.requestQuickGet(apiUrl+<span class="hljs-string">'/course/coursepic/get/'</span>+courseId)
&#125;</code></pre></div>

<p>钩子函数</p>
<div class="hljs"><pre><code class="hljs js">mounted()&#123;
  <span class="hljs-comment">//课程id</span>
  <span class="hljs-keyword">this</span>.courseid = <span class="hljs-keyword">this</span>.$route.params.courseid;
  <span class="hljs-comment">//查询课程</span>
  courseApi.findCoursePicList(<span class="hljs-keyword">this</span>.courseid).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
      <span class="hljs-keyword">if</span>(res &amp;&amp; res.pic)&#123;
          <span class="hljs-keyword">let</span> imgUrl = <span class="hljs-keyword">this</span>.imgUrl+res.pic;
          <span class="hljs-comment">//将图片地址设置到</span>
        <span class="hljs-keyword">this</span>.fileList.push(&#123;<span class="hljs-attr">name</span>:<span class="hljs-string">'pic'</span>,<span class="hljs-attr">url</span>:imgUrl,<span class="hljs-attr">fileId</span>:res.pic&#125;)
      &#125;
  &#125;)
&#125;</code></pre></div>

<h3 id="3、测试-2"><a href="#3、测试-2" class="headerlink" title="3、测试"></a>3、测试</h3><p>别忘了启动 nginx ，这里是通过 img.xuecheng.com 访问图片。</p>
<p><a href="https://qnoss.codeyee.com/20200704_8/image22" target="_blank" rel="noopener"><img src="https://qnoss.codeyee.com/20200704_8/image22" srcset="/img/loading.gif" alt="img"></a></p>
<h1 id="五、课程图片删除"><a href="#五、课程图片删除" class="headerlink" title="五、课程图片删除"></a>五、课程图片删除</h1><h2 id="1-需求分析-3"><a href="#1-需求分析-3" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><h2 id="2-构建接口-2"><a href="#2-构建接口-2" class="headerlink" title="2. 构建接口"></a>2. 构建接口</h2><h3 id="1、API-接口-2"><a href="#1、API-接口-2" class="headerlink" title="1、API 接口"></a>1、API 接口</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"删除课程图片信息"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">deleteCoursePic</span><span class="hljs-params">(String courseId)</span></span>;</code></pre></div>

<h3 id="2、Dao-层-2"><a href="#2、Dao-层-2" class="headerlink" title="2、Dao 层"></a>2、Dao 层</h3><p><code>JPA</code> 自带的 <code>deleteById</code> 方法没有返回值，所以这里我们需要在 Dao 里面再定义一个 deleteByCourseid 方法，删除后返回影响的行数。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_course.dao;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CourseBase;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CoursePic;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * Created by Administrator.</span>
<span class="hljs-comment"> */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CoursePicRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">CoursePic</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据课程id删除图片信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回删除影响的行,小于1则表示删除失败</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">deleteByCourseid</span><span class="hljs-params">(String courseId)</span></span>;
&#125;</code></pre></div>

<h3 id="3、Service-层-2"><a href="#3、Service-层-2" class="headerlink" title="3、Service 层"></a>3、Service 层</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 删除课程图片信息</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Transactional</span> <span class="hljs-comment">//Mysql操作需要添加到Spring事务</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">deleteCoursePic</span><span class="hljs-params">(String courseId)</span> </span>&#123;
    <span class="hljs-keyword">long</span> byCourseid = coursePicRepository.deleteByCourseid(courseId);
    <span class="hljs-keyword">if</span>(byCourseid &gt; <span class="hljs-number">0</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
&#125;</code></pre></div>

<h3 id="4、Controller-层-2"><a href="#4、Controller-层-2" class="headerlink" title="4、Controller 层"></a>4、Controller 层</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 删除课程图片信息</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@DeleteMapping</span>(<span class="hljs-string">"/coursepic/delete"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">deleteCoursePic</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.deleteCoursePic(courseId);
&#125;</code></pre></div>

<h3 id="5、测试-1"><a href="#5、测试-1" class="headerlink" title="5、测试"></a>5、测试</h3><p><a href="https://qnoss.codeyee.com/20200704_8/image23" target="_blank" rel="noopener"><img src="https://qnoss.codeyee.com/20200704_8/image23" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-前端配置-2"><a href="#3-前端配置-2" class="headerlink" title="3. 前端配置"></a>3. 前端配置</h2><h3 id="1、需求-3"><a href="#1、需求-3" class="headerlink" title="1、需求"></a>1、需求</h3><h3 id="2、页面-3"><a href="#2、页面-3" class="headerlink" title="2、页面"></a>2、页面</h3><p>api 接口</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//删除课程图片</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> deleteCoursePic= <span class="hljs-function"><span class="hljs-params">courseId</span> =&gt;</span> &#123;
  <span class="hljs-keyword">return</span> http.requestDelete(apiUrl+<span class="hljs-string">'/course/coursepic/delete?courseId='</span>+courseId)
&#125;</code></pre></div>

<p>before-remove钩子方法</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐upload</span></span>
<span class="hljs-tag">  <span class="hljs-attr">action</span>=<span class="hljs-string">"/filesystem/upload"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">list</span>‐<span class="hljs-attr">type</span>=<span class="hljs-string">"picture‐card"</span></span>
<span class="hljs-tag">  <span class="hljs-attr">:before</span>‐<span class="hljs-attr">remove</span>=<span class="hljs-string">"handleRemove"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el‐icon‐plus"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el‐upload</span>&gt;</span></code></pre></div>

<p>在upload组件的 <code>before-remove</code>钩子方法 中实现删除动作。</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//删除图片</span>
handleRemove(file, fileList) &#123;
  <span class="hljs-built_in">console</span>.log(file)
  <span class="hljs-comment">//调用服务端去删除课程图片信息，如果返回false，前端停止删除</span>
  <span class="hljs-comment">//异步调用</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,rejct</span>)=&gt;</span>&#123;
    courseApi.deleteCoursePic(<span class="hljs-keyword">this</span>.courseid).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
      <span class="hljs-keyword">if</span>(res.success)&#123;
          <span class="hljs-comment">//成功</span>
        resolve()
      &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"删除失败"</span>);
          <span class="hljs-comment">//失败</span>
        rejct()
      &#125;
    &#125;)
  &#125;)
&#125;,</code></pre></div>

<p><code>before-remove</code> 说明：删除文件之前的钩子，参数为上传的文件和文件列表，若返回 <code>false</code> 或者返回 <code>Promise</code> 且被 <code>reject</code>，则停止删除。</p>
<h3 id="3、为什么要使用-promise？"><a href="#3、为什么要使用-promise？" class="headerlink" title="3、为什么要使用 promise？"></a>3、为什么要使用 promise？</h3><p>在 <code>handleRemove</code> 方法调用删除图片的 <code>api</code> 方法，删除成功时 return true，删除失败时return false;</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">// 删除图片</span>
handleRemove(file, fileList) &#123;
    <span class="hljs-built_in">console</span>.log(file)
    <span class="hljs-comment">//        alert('删除')</span>
    <span class="hljs-comment">//        return true;</span>
    <span class="hljs-comment">//删除图片</span>
    courseApi.deleteCoursePic(<span class="hljs-string">'1'</span>).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">'删除成功'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.$message.error(res.message);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        &#125;
    &#125;);
&#125;,</code></pre></div>

<p>在上边代码中将提交的课程 id 故意写错，按照我们预期应该是删除失败，而测试结果却是图片在页面上删除成功。</p>
<p><strong>问题原因：</strong></p>
<p>通过查询 <code>deleteCoursePic</code> 方法的底层代码，<code>deleteCoursePic</code> 最终返回一个 <code>promise</code> 对象。</p>
<p>Promise 是ES6提供的用于异步处理的对象，因为axios提交是异步提交，这里使用promise作为返回值</p>
<p><strong>Promise的使用方法如下：</strong></p>
<p>Promise对象在处理过程中有三种状态：</p>
<ul>
<li>pending：进行中</li>
<li>resolved：操作成功</li>
<li>rejected: 操作失败</li>
</ul>
<p>Promise的构建方法如下：</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve,reject</span>)</span>&#123;
     <span class="hljs-comment">//...TODO...</span>
    <span class="hljs-keyword">if</span>(操作成功)&#123;
        resolve(value);
    &#125;<span class="hljs-keyword">else</span>&#123;
        reject(error);
    &#125;
&#125;)</code></pre></div>

<p>上边的构造方法function(resolve,reject)执行流程如下：</p>
<p>1）方法执行一些业务逻辑。</p>
<p>2）如果操作成功将 <code>Promise</code> 的状态由 <code>pending</code> 变为 <code>resolved</code>，并将操作结果传出去</p>
<p>3）如果操作失败会将 <code>promise</code> 的状态由 <code>pending</code> 变为 <code>rejected</code>，并将失败结果传出去。<br>上边说的操作成功将操作结果传给谁了呢？操作失败将失败结果传给谁了呢？</p>
<p>我们可以通过 promise 的 <code>then</code>、<code>catch</code> 来指定：</p>
<div class="hljs"><pre><code class="hljs js">promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">result</span>) </span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'操作成功：'</span> + result);
&#125;);
promise.catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">reason</span>) </span>&#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'操作失败：'</span> + reason);
&#125;);</code></pre></div>

<p>例子如下：</p>
<p>1、定义一个方法，返回 <code>promise</code> 对象</p>
<div class="hljs"><pre><code class="hljs js">testpromise(i)&#123;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;
    <span class="hljs-keyword">if</span>(i % <span class="hljs-number">2</span>==<span class="hljs-number">0</span>)&#123;
      resolve(<span class="hljs-string">'成功了'</span>)
    &#125;<span class="hljs-keyword">else</span>&#123;
      reject(<span class="hljs-string">'拒绝了'</span>)
    &#125;
  &#125;)
&#125;</code></pre></div>

<p>2、调用此方法</p>
<p>向方法传入偶数、奇数进行测试。</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">this</span>.testpromise(<span class="hljs-number">3</span>).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;<span class="hljs-comment">// 在then中对成功结果进行处理</span>
    alert(res)
&#125;).catch(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;<span class="hljs-comment">//在catch中对操作失败结果进行处理</span>
    alert(res)
&#125;)</code></pre></div>

<p>3、最终将 <code>handleRemove</code> 方法修改如下</p>
<p><code>handleRemove</code> 方法返回 <code>promise</code> 对象，当删除成功则 <code>resolve</code>，删除失败则 <code>reject</code>。</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">// 删除图片</span>
handleRemove(file, fileList) &#123;
    <span class="hljs-built_in">console</span>.log(file)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;
        <span class="hljs-comment">//删除图片</span>
 courseApi.deleteCoursePic(<span class="hljs-keyword">this</span>.courseid).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
            <span class="hljs-keyword">if</span>(res.success)&#123;
                <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">'删除成功'</span>);
                resolve()<span class="hljs-comment">//通过</span>
            &#125;<span class="hljs-keyword">else</span>&#123;
                <span class="hljs-keyword">this</span>.$message.error(res.message);
                reject()<span class="hljs-comment">//拒绝</span>
            &#125;
        &#125;);
    &#125;)
&#125;</code></pre></div>
            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/FastDFS/">FastDFS</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线day09：Eureka、Feign、课程预览实现</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/13/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday07/">
                        <span class="hidden-mobile">学成在线day07：课程管理实战</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

代码块js 用不到，fulid自带有，添加css样式即可实现
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键字</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "本站勉强运行&nbsp"+dnum+"&nbsp天";
      document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证123456号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备12345678号</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "学成在线day08：FastDFS实现课程图片管理&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
