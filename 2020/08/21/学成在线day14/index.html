<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>学成在线day14：媒资管理 - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>私人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-21 18:08">
      2020-08-21
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      12.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      162
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="😎知识点概览"><a href="#😎知识点概览" class="headerlink" title="😎知识点概览"></a>😎知识点概览</h1><blockquote>
<p>为了方便后续回顾该项目时能够清晰的知道本章节讲了哪些内容，并且能够从该章节的笔记中得到一些帮助，所以在完成本章节的学习后在此对本章节所涉及到的知识点进行总结概述。</p>
</blockquote>
<p>本章节为【学成在线】项目的 <code>day14</code> 的内容</p>
<ul>
<li>视频上传成功后通过 <code>RabbitMQ</code> 进行消息发送，再通过 <code>视频处理服务</code> 对视频进行格式转换，以及 <code>m3u8</code> 视频文件的生成。</li>
<li>实现媒资信息的浏览</li>
<li><code>Vue</code> 跨组件间的通讯实战，实现课程计划与已上传的媒资文件的关联</li>
</ul>
<h1 id="一、视频处理"><a href="#一、视频处理" class="headerlink" title="一、视频处理"></a>一、视频处理</h1><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>原始视频通常需要经过编码处理，生成 <code>m3u8</code> 和 <code>ts</code> 文件方可基于 <code>HLS</code> 协议播放视频。通常用户上传原始视频，系统自动处理成标准格式，系统对用户上传的视频自动编码、转换，最终生成<code>m3u8</code> 文件和 <code>ts</code> 文件，处理流程如下：</p>
<p>1、用户上传视频成功</p>
<p>2、系统对上传成功的视频自动开始编码处理</p>
<p>3、用户查看视频处理结果，没有处理成功的视频用户可在管理界面再次触发处理</p>
<p>4、视频处理完成将视频地址及处理结果保存到数据库</p>
<p>视频处理流程如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image1" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image1.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>视频处理进程的任务是接收视频处理消息进行视频处理，业务流程如下：</p>
<p>1、监听 <code>MQ</code>，接收视频处理消息。</p>
<p>2、进行视频处理。</p>
<p>3、向数据库写入视频处理结果。</p>
<p>视频处理进程属于媒资管理系统的一部分，考虑提高系统的扩展性，将视频处理单独定义视频处理工程。</p>
<h2 id="2-视频处理开发"><a href="#2-视频处理开发" class="headerlink" title="2. 视频处理开发"></a>2. 视频处理开发</h2><h3 id="视频处理工程创建"><a href="#视频处理工程创建" class="headerlink" title="视频处理工程创建"></a>视频处理工程创建</h3><p>1、导入“资料” 下的视频处理工程：<code>xc-service-manage-media-processor</code></p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image2" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image2.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2、<code>RabbitMQ</code> 配置</p>
<p>使用 <code>rabbitMQ</code> 的 <code>routing</code> 交换机模式，视频处理程序监听视频处理队列，如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image3" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image3.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>RabbitMQ配置如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_MEDIA_PROCESSTASK = <span class="hljs-string">"ex_media_processor"</span>;
    <span class="hljs-comment">//视频处理队列</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc‐service‐manage‐media.mq.queue‐media‐video‐processor&#125;"</span>)
    <span class="hljs-keyword">public</span> String queue_media_video_processtask;
    <span class="hljs-comment">//视频处理路由</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc‐service‐manage‐media.mq.routingkey‐media‐video&#125;"</span>)
    <span class="hljs-keyword">public</span> String routingkey_media_video;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">* 交换机配置</span>
<span class="hljs-comment">* <span class="hljs-doctag">@return</span> the exchange</span>
<span class="hljs-comment">*/</span>
    <span class="hljs-meta">@Bean</span>(EX_MEDIA_PROCESSTASK)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EX_MEDIA_VIDEOTASK</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_MEDIA_PROCESSTASK).durable(<span class="hljs-keyword">true</span>).build();
    &#125; 
    <span class="hljs-comment">//声明队列</span>
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"queue_media_video_processtask"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">QUEUE_PROCESSTASK</span><span class="hljs-params">()</span> </span>&#123;
        Queue queue = <span class="hljs-keyword">new</span> Queue(queue_media_video_processtask,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">return</span> queue;
    &#125; 
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">* 绑定队列到交换机 .</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> queue the queue</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> exchange the exchange</span>
<span class="hljs-comment">* <span class="hljs-doctag">@return</span> the binding</span>
<span class="hljs-comment">*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">binding_queue_media_processtask</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"queue_media_video_processtask"</span>)</span>Queue queue, @<span class="hljs-title">Qualifier</span><span class="hljs-params">(EX_MEDIA_PROCESSTASK)</span> Exchange exchange) </span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(routingkey_media_video).noargs();
    &#125;
&#125;</code></pre></div>

<p>在 <code>application.yml</code> 中配置队列名称及 <code>routingkey</code></p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-string">xc‐service‐manage‐media:</span>
  <span class="hljs-attr">mq:</span>
    <span class="hljs-string">queue‐media‐video‐processor:</span> <span class="hljs-string">queue_media_video_processor</span>
    <span class="hljs-string">routingkey‐media‐video:</span> <span class="hljs-string">routingkey_media_video</span></code></pre></div>

<h3 id="视频处理技术方案"><a href="#视频处理技术方案" class="headerlink" title="视频处理技术方案"></a>视频处理技术方案</h3><p>如何通过程序进行视频处理？</p>
<p><code>ffmpeg</code> 是一个可行的视频处理程序，可以通过 <code>Java</code> 调用 <code>ffmpeg.exe</code> 完成视频处理。</p>
<p>在 <code>java</code> 中可以使用 <code>Runtime</code> 类和 <code>Process Builder</code> 类两种方式来执行外部程序，工作中至少掌握一种。</p>
<p>本项目使用 <code>Process Builder</code> 的方式来调用 <code>ffmpeg</code> 完成视频处理。</p>
<p>关于 <code>Process Builder</code> 的测试如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//测试ping命令</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessBuilder</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
    <span class="hljs-comment">//创建ProcessBuilder对象</span>
    ProcessBuilder processBuilder = <span class="hljs-keyword">new</span> ProcessBuilder();
    <span class="hljs-comment">//设置执行的第三方程序(命令)</span>
    List&lt;String&gt; cmds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    cmds.add(<span class="hljs-string">"ping"</span>);
    cmds.add(<span class="hljs-string">"127.0.0.1"</span>);
    processBuilder.command(cmds);
    <span class="hljs-comment">//合并标准输入流和错误输出</span>
    processBuilder.redirectErrorStream(<span class="hljs-keyword">true</span>);
    Process start = processBuilder.start();
    <span class="hljs-comment">//获取输入流</span>
    InputStream inputStream = start.getInputStream();
    <span class="hljs-comment">//将输入流转换为字符输入流</span>
    InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(inputStream, <span class="hljs-string">"gbk"</span>);

    <span class="hljs-comment">//获取流的数据</span>
    <span class="hljs-keyword">int</span> len = -<span class="hljs-number">1</span>;
    <span class="hljs-comment">//数据缓冲区</span>
    <span class="hljs-keyword">char</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[<span class="hljs-number">1024</span>];
    StringBuffer stringBuffer = <span class="hljs-keyword">new</span> StringBuffer();
    <span class="hljs-keyword">while</span> ((len = inputStreamReader.read(cache)) != -<span class="hljs-number">1</span>) &#123;
        <span class="hljs-comment">//获取缓冲区内的数据</span>
        String outStr = <span class="hljs-keyword">new</span> String(cache, <span class="hljs-number">0</span>, len);
        System.out.println(outStr);
        stringBuffer.append(outStr);
    &#125;
    inputStream.close();
&#125;

<span class="hljs-comment">//测试使用工具类将avi转成mp4</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessMp4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
    ProcessBuilder processBuilder = <span class="hljs-keyword">new</span> ProcessBuilder();
    <span class="hljs-comment">//定义命令内容</span>
    List&lt;String&gt; command = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    command.add(<span class="hljs-string">"D:/soft/ffmpeg-20200315-c467328-win64-static/bin/ffmpeg.exe"</span>);
    command.add(<span class="hljs-string">"-i"</span>);
    command.add(<span class="hljs-string">"E:/temp/1.avi"</span>);
    command.add(<span class="hljs-string">"-y"</span>); <span class="hljs-comment">//覆盖输出文件</span>
    command.add(<span class="hljs-string">"-c:v"</span>);
    command.add(<span class="hljs-string">"libx264"</span>);
    command.add(<span class="hljs-string">"-s"</span>);
    command.add(<span class="hljs-string">"1280x720"</span>);
    command.add(<span class="hljs-string">"-pix_fmt"</span>);
    command.add(<span class="hljs-string">"yuv420p"</span>);
    command.add(<span class="hljs-string">"-b:a"</span>);
    command.add(<span class="hljs-string">"63k"</span>);
    command.add(<span class="hljs-string">"-b:v"</span>);
    command.add(<span class="hljs-string">"753k"</span>);
    command.add(<span class="hljs-string">"-r"</span>);
    command.add(<span class="hljs-string">"18"</span>);
    command.add(<span class="hljs-string">"E:/temp/1.mp4"</span>);
    processBuilder.command(command);
    <span class="hljs-comment">//将标准输入流和错误输入流合并，通过标准输入流读取信息</span>
    processBuilder.redirectErrorStream(<span class="hljs-keyword">true</span>);
    Process start = processBuilder.start();
    InputStream inputStream = start.getInputStream();
    InputStreamReader streamReader = <span class="hljs-keyword">new</span> InputStreamReader(inputStream, <span class="hljs-string">"gbk"</span>);

    <span class="hljs-comment">//获取输入流数据</span>
    <span class="hljs-keyword">int</span> len = -<span class="hljs-number">1</span>;
    <span class="hljs-comment">//数据缓冲区</span>
    <span class="hljs-keyword">char</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[<span class="hljs-number">1024</span>];
    StringBuffer stringBuffer = <span class="hljs-keyword">new</span> StringBuffer();
    <span class="hljs-keyword">while</span> ((len=streamReader.read(cache)) != -<span class="hljs-number">1</span>)&#123;
        <span class="hljs-comment">//从缓冲区获取数据</span>
        String out = <span class="hljs-keyword">new</span> String(cache, <span class="hljs-number">0</span>, len);
        System.out.println(out);
        stringBuffer.append(out);
    &#125;
    inputStream.close();
&#125;</code></pre></div>

<p>上边的代码已经封装成工具类，参见：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image4" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image4.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>上边的工具类中：</p>
<p><code>Mp4VideoUtil.java</code> 完成 <code>avi</code> 转 <code>mp4</code></p>
<p><code>HlsVideoUtil.java</code> 完成 <code>mp4</code> 转 <code>hls</code></p>
<p>分别测试每个工具类的使用方法。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
    String ffmpeg_path = <span class="hljs-string">"D:/soft/ffmpeg-20200315-c467328-win64-static/bin/ffmpeg.exe"</span>;<span class="hljs-comment">//ffmpeg的安装位置</span>
    String video_path = <span class="hljs-string">"E:\\temp\\1.avi"</span>;
    String mp4_name = <span class="hljs-string">"2.mp4"</span>;
    String mp4_path = <span class="hljs-string">"E:\\temp\\"</span>;
    Mp4VideoUtil videoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path,video_path,mp4_name,mp4_path);
    String s = videoUtil.generateMp4();
    System.out.println(s);
&#125;</code></pre></div>

<h3 id="视频处理实现"><a href="#视频处理实现" class="headerlink" title="视频处理实现"></a>视频处理实现</h3><h4 id="1、确定消息格式"><a href="#1、确定消息格式" class="headerlink" title="1、确定消息格式"></a>1、确定消息格式</h4><p><code>MQ</code> 消息统一采用 <code>json</code> 格式，视频处理生产方会向 <code>MQ</code> 发送如下消息，视频处理消费方接收此消息后进行视频处<br>理：</p>
<div class="hljs"><pre><code class="hljs json">&#123;<span class="hljs-attr">"mediaId"</span>:XXX&#125;</code></pre></div>

<h4 id="2、处理流程"><a href="#2、处理流程" class="headerlink" title="2、处理流程"></a>2、处理流程</h4><p>1）接收视频处理消息</p>
<p>2）判断媒体文件是否需要处理（本视频处理程序目前只接收<code>avi</code> 视频的处理）当前只有 <code>avi</code> 文件需要处理，其它文件需要更新处理状态为 “<code>无需处理</code>”。</p>
<p>3）处理前初始化处理状态为 “<code>未处理</code>”</p>
<p>4）处理失败需要在数据库记录处理日志，及处理状态为 “<code>处理失败</code>”</p>
<p>5）处理成功记录处理状态为 “<code>处理成功</code>“</p>
<h4 id="3、数据模型"><a href="#3、数据模型" class="headerlink" title="3、数据模型"></a>3、数据模型</h4><p>在 <code>MediaFile</code> 类中添加 <code>mediaFileProcess_m3u8</code> 属性记录 <code>ts</code> 文件列表，代码如下 ：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//处理状态</span>
<span class="hljs-keyword">private</span> String processStatus;
<span class="hljs-comment">//hls处理</span>
<span class="hljs-keyword">private</span> MediaFileProcess_m3u8 mediaFileProcess_m3u8;</code></pre></div>

<p><code>MediaFileProcess_m3u8</code> 如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaFileProcess_m3u8</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MediaFileProcess</span> </span>&#123;
<span class="hljs-comment">//ts列表</span>
<span class="hljs-keyword">private</span> List&lt;String&gt; tslist;
&#125;</code></pre></div>

<h4 id="4、视频处理生成-MP4"><a href="#4、视频处理生成-MP4" class="headerlink" title="4、视频处理生成 MP4"></a>4、视频处理生成 MP4</h4><p>1）创建 dao</p>
<p>视频处理结果需要保存到媒资数据库，创建 <code>dao</code> 如下：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">MediaFile</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
&#125;</code></pre></div>

<p>2）在 <code>application.yml</code> 中配置 <code>ffmpeg</code> 的位置及视频目录的根目录</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-string">xc‐service‐manage‐media:</span>
  <span class="hljs-string">video‐location:</span> <span class="hljs-string">F:/develop/video/</span>
  <span class="hljs-string">ffmpeg‐path:</span> <span class="hljs-string">D:/Program</span> <span class="hljs-string">Files/ffmpeg‐20180227‐fa0c9d6‐win64‐static/bin/ffmpeg.exe</span></code></pre></div>

<p>3）处理任务类</p>
<p>在 <code>mq</code> 包下创建 <code>MediaProcessTask</code> 类，此类负责监听视频处理队列，并进行视频处理。</p>
<p>整个视频处理内容较多，这里分两部分实现：生成 <code>Mp4</code> 和生成 <code>m3u8</code>，下边代码实现了生成 <code>mp4</code> 。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaProcessTask</span> </span>&#123;
    <span class="hljs-comment">//日志对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MediaProcessTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//ffmpeg绝对路径</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.ffmpeg-path&#125;"</span>)
    String ffmpeg_path;

    <span class="hljs-comment">//上传文件根目录</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.video-location&#125;"</span>)
    String serverPath;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMediaProcessTask</span><span class="hljs-params">(String msg)</span></span>&#123;
        <span class="hljs-comment">//将接收到的消息转换为json数据</span>
        Map msgMap = JSON.parseObject(msg);
        LOGGER.info(<span class="hljs-string">"receive media process task msg :&#123;&#125; "</span>,msgMap);
        <span class="hljs-comment">//解析消息</span>
        <span class="hljs-comment">//媒资文件id</span>
        String mediaId = (String) msgMap.get(<span class="hljs-string">"mediaId"</span>);
        <span class="hljs-comment">//获取媒资文件信息</span>
        Optional&lt;MediaFile&gt; byId = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!byId.isPresent())&#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        MediaFile mediaFile = byId.get();
        <span class="hljs-comment">//媒资文件类型</span>
        String fileType = mediaFile.getFileType();
        <span class="hljs-comment">//目前只处理avi文件</span>
        <span class="hljs-keyword">if</span>(fileType == <span class="hljs-keyword">null</span> || !fileType.equals(<span class="hljs-string">"avi"</span>))&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303004"</span>); <span class="hljs-comment">// 处理状态为无需处理</span>
            mediaFileRepository.save(mediaFile);
        &#125;<span class="hljs-keyword">else</span>&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303001"</span>); <span class="hljs-comment">//处理状态为未处理</span>
        &#125;
        <span class="hljs-comment">//生成MP4</span>
        String videoPath = serverPath + mediaFile.getFilePath() + mediaFile.getFileName();
        String mp4Name = mediaFile.getFileId() + <span class="hljs-string">".mp4"</span>;
        String mp4FloderPath = serverPath  + mediaFile.getFilePath();
        Mp4VideoUtil mp4VideoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path, videoPath, mp4Name, mp4FloderPath);
        String result = mp4VideoUtil.generateMp4();
        <span class="hljs-keyword">if</span>(result == <span class="hljs-keyword">null</span> || !result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//操作失败写入处理日志</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//处理状态为处理失败</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">//生成m3u8...</span>
    &#125;
&#125;</code></pre></div>

<p>说明：</p>
<p>1、原始视频转成 <code>mp4</code> 如何判断转换成功？</p>
<p>根据视频时长来判断，取原视频和转换成功视频的时长（时分秒），如果相等则相同。</p>
<h4 id="5、视频处理生成-m3u8"><a href="#5、视频处理生成-m3u8" class="headerlink" title="5、视频处理生成 m3u8"></a>5、视频处理生成 m3u8</h4><p>下边是完整的视频处理任务类代码，包括了生成 <code>m3u8</code> 及生成 <code>mp4</code> 的代码</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media_process.mq;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFileProcess_m3u8;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.HlsVideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.Mp4VideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media_process.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaProcessTask</span> </span>&#123;
    <span class="hljs-comment">//日志对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MediaProcessTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//ffmpeg绝对路径</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.ffmpeg-path&#125;"</span>)
    String ffmpeg_path;

    <span class="hljs-comment">//上传文件根目录</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.video-location&#125;"</span>)
    String serverPath;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMediaProcessTask</span><span class="hljs-params">(String msg)</span></span>&#123;
        <span class="hljs-comment">//将接收到的消息转换为json数据</span>
        Map msgMap = JSON.parseObject(msg);
        LOGGER.info(<span class="hljs-string">"receive media process task msg :&#123;&#125; "</span>,msgMap);
        <span class="hljs-comment">//解析消息</span>
        <span class="hljs-comment">//媒资文件id</span>
        String mediaId = (String) msgMap.get(<span class="hljs-string">"mediaId"</span>);
        <span class="hljs-comment">//获取媒资文件信息</span>
        Optional&lt;MediaFile&gt; byId = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!byId.isPresent())&#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        MediaFile mediaFile = byId.get();
        <span class="hljs-comment">//媒资文件类型</span>
        String fileType = mediaFile.getFileType();
        <span class="hljs-comment">//目前只处理avi文件</span>
        <span class="hljs-keyword">if</span>(fileType == <span class="hljs-keyword">null</span> || !fileType.equals(<span class="hljs-string">"avi"</span>))&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303004"</span>); <span class="hljs-comment">// 处理状态为无需处理</span>
            mediaFileRepository.save(mediaFile);
        &#125;<span class="hljs-keyword">else</span>&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303001"</span>); <span class="hljs-comment">//处理状态为未处理</span>
        &#125;
        <span class="hljs-comment">//生成MP4</span>
        String videoPath = serverPath + mediaFile.getFilePath() + mediaFile.getFileName();
        String mp4Name = mediaFile.getFileId() + <span class="hljs-string">".mp4"</span>;
        String mp4FloderPath = serverPath  + mediaFile.getFilePath();
        Mp4VideoUtil mp4VideoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path, videoPath, mp4Name, mp4FloderPath);
        String result = mp4VideoUtil.generateMp4();
        <span class="hljs-keyword">if</span>(result == <span class="hljs-keyword">null</span> || !result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//操作失败写入处理日志</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//处理状态为处理失败</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">//生成m3u8列表</span>
        <span class="hljs-comment">//生成m3u8</span>
        String mp4VideoPath = serverPath + mediaFile.getFilePath()+ mp4Name;<span class="hljs-comment">//此地址为mp4的地址</span>
        String m3u8Name = mediaFile.getFileId()+<span class="hljs-string">".m3u8"</span>;
        String m3u8FolderPath = serverPath + mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>;
        <span class="hljs-comment">//调用工具类进行生成m3u8</span>
        HlsVideoUtil hlsVideoUtil = <span class="hljs-keyword">new</span> HlsVideoUtil(ffmpeg_path, mp4VideoPath, m3u8Name, m3u8FolderPath);
        String m3u8Result = hlsVideoUtil.generateM3u8();

        <span class="hljs-keyword">if</span>(m3u8Result==<span class="hljs-keyword">null</span> || !m3u8Result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//操作失败写入处理日志</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//处理状态为处理失败</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(m3u8Result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span> ;
        &#125;

        <span class="hljs-comment">//获取m3u8列表</span>
        List&lt;String&gt; ts_list = hlsVideoUtil.get_ts_list();
        <span class="hljs-comment">//更新处理状态为成功</span>
        mediaFile.setProcessStatus(<span class="hljs-string">"303002"</span>);<span class="hljs-comment">//处理状态为处理成功</span>
        MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
        mediaFileProcess_m3u8.setTslist(ts_list);
        mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
        <span class="hljs-comment">//m3u8文件url</span>
        mediaFile.setFileUrl(mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>+m3u8Name);
        mediaFileRepository.save(mediaFile);
    &#125;
&#125;</code></pre></div>

<h2 id="3-发送视频处理消息"><a href="#3-发送视频处理消息" class="headerlink" title="3. 发送视频处理消息"></a>3. 发送视频处理消息</h2><p>当视频上传成功后向 <code>MQ</code> 发送视频 处理消息。</p>
<p>修改媒资管理服务的文件上传代码，当文件上传成功向 <code>MQ</code> 发送视频处理消息。</p>
<h3 id="配置RabbitMQ"><a href="#配置RabbitMQ" class="headerlink" title="配置RabbitMQ"></a>配置RabbitMQ</h3><p>1、将<code>media-processor</code> 工程下的 <code>RabbitmqConfig</code> 配置类拷贝到 <code>media</code> 工程下。</p>
<p>2、在 <code>media</code> 工程下配置 <code>mq</code> 队列等信息</p>
<p>修改 <code>application.yml</code></p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">xc-service-manage-media:</span>
  <span class="hljs-attr">mq:</span>
    <span class="hljs-attr">queue-media-video-processor:</span> <span class="hljs-string">queue_media_video_processor</span>
    <span class="hljs-attr">routingkey-media-video:</span> <span class="hljs-string">routingkey_media_video</span></code></pre></div>

<h3 id="配置Service"><a href="#配置Service" class="headerlink" title="配置Service"></a>配置Service</h3><p>在文件合并方法中添加向 <code>mq</code> 发送视频处理消息的代码：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//视频处理路由</span>
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.routingkey-media-video&#125;"</span>)
<span class="hljs-keyword">public</span> String routingkey_media_video;

<span class="hljs-meta">@Autowired</span>
RabbitTemplate rabbitTemplate;

<span class="hljs-comment">//向MQ发送视频处理消息</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> ResponseResult <span class="hljs-title">sendProcessVideoMsg</span><span class="hljs-params">(String mediaId)</span></span>&#123;
    Optional&lt;MediaFile&gt; optional = mediaFileRepository.findById(mediaId);
    <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
    &#125;
    MediaFile mediaFile = optional.get();
    <span class="hljs-comment">//发送视频处理消息</span>
    Map&lt;String,String&gt; msgMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    msgMap.put(<span class="hljs-string">"mediaId"</span>,mediaId);
    <span class="hljs-comment">//发送的消息</span>
    String msg = JSON.toJSONString(msgMap);
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-keyword">this</span>.rabbitTemplate.convertAndSend(RabbitMQConfig.EX_MEDIA_PROCESSTASK,routingkey_media_video,msg);
        LOGGER.info(<span class="hljs-string">"send media process task msg:&#123;&#125;"</span>,msg);
    &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
        e.printStackTrace();
        LOGGER.info(<span class="hljs-string">"send media process task error,msg is:&#123;&#125;,error:&#123;&#125;"</span>,msg,e.getMessage());
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
&#125;</code></pre></div>

<p>在 <code>mergechunks</code> 方法最后调用 <code>sendProcessVideo</code> 方法。</p>
<div class="hljs"><pre><code class="hljs java">......
<span class="hljs-comment">//状态为上传成功</span>
mediaFile.setFileStatus(<span class="hljs-string">"301002"</span>);
mediaFileRepository.save(mediaFile);
String mediaId = mediaFile.getFileId();
<span class="hljs-comment">//向MQ发送视频处理消息</span>
sendProcessVideoMsg(mediaId);
......</code></pre></div>

<h2 id="4-视频处理测试"><a href="#4-视频处理测试" class="headerlink" title="4. 视频处理测试"></a>4. 视频处理测试</h2><p>测试流程：</p>
<p>1、上传avi文件</p>
<p>2、观察日志是否发送消息</p>
<p>3、观察视频处理进程是否接收到消息进行处理</p>
<p>4、观察 <code>mp4</code> 文件是否生成</p>
<p>5、观察 <code>m3u8</code> 及 <code>ts</code> 文件是否生成</p>
<h2 id="5-视频处理并发设置"><a href="#5-视频处理并发设置" class="headerlink" title="5. 视频处理并发设置"></a>5. 视频处理并发设置</h2><p>代码中使用 <code>@RabbitListener</code> 注解指定消费方法，默认情况是单线程监听队列，可以观察当队列有多个任务时消费端每次只消费一个消息，单线程处理消息容易引起消息处理缓慢，消息堆积，不能最大利用硬件资源。</p>
<p>可以配置 <code>mq</code> 的容器工厂参数，增加并发处理数量即可实现多线程处理监听队列，实现多线程处理消息。</p>
<p>1、在 <code>RabbitmqConfig.java</code> 中添加容器工厂配置：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 多线程处理消息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> configurer</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connectionFactory</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@Bean</span>(<span class="hljs-string">"customContainerFactory"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title">containerFactory</span><span class="hljs-params">(SimpleRabbitListenerContainerFactoryConfigurer configurer, ConnectionFactory</span></span>
<span class="hljs-function"><span class="hljs-params">                                                             connectionFactory)</span> </span>&#123;
    SimpleRabbitListenerContainerFactory factory = <span class="hljs-keyword">new</span> SimpleRabbitListenerContainerFactory();
    factory.setConcurrentConsumers(DEFAULT_CONCURRENT);
    factory.setMaxConcurrentConsumers(DEFAULT_CONCURRENT);
    configurer.configure(factory,connectionFactory);
    <span class="hljs-keyword">return</span> factory;
&#125;</code></pre></div>

<p>2、在 <code>@RabbitListener</code> 注解中指定容器工厂</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//视频处理方法</span>
<span class="hljs-meta">@RabbitListener</span>(queues = &#123;<span class="hljs-string">"$&#123;xc‐service‐manage‐media.mq.queue‐media‐video‐processor&#125;"</span>&#125;,
containerFactory=<span class="hljs-string">"customContainerFactory"</span>)</code></pre></div>

<p>再次测试当队列有多个任务时消费端的并发处理能力。</p>
<h2 id="6-完整代码"><a href="#6-完整代码" class="headerlink" title="6. 完整代码"></a>6. 完整代码</h2><h3 id="RabbitMQConfig"><a href="#RabbitMQConfig" class="headerlink" title="RabbitMQConfig"></a>RabbitMQConfig</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media_process.config;

<span class="hljs-keyword">import</span> org.springframework.amqp.core.*;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.amqp.SimpleRabbitListenerContainerFactoryConfigurer;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_MEDIA_PROCESSTASK = <span class="hljs-string">"ex_media_processor"</span>;

    <span class="hljs-comment">//视频处理队列</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span>)
    <span class="hljs-keyword">public</span>  String queue_media_video_processtask;

    <span class="hljs-comment">//视频处理路由</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.routingkey-media-video&#125;"</span>)
    <span class="hljs-keyword">public</span>  String routingkey_media_video;

    <span class="hljs-comment">//消费者并发数量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_CONCURRENT = <span class="hljs-number">10</span>;


    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 交换机配置</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the exchange</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(EX_MEDIA_PROCESSTASK)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EX_MEDIA_VIDEOTASK</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_MEDIA_PROCESSTASK).durable(<span class="hljs-keyword">true</span>).build();
    &#125;
    <span class="hljs-comment">//声明队列</span>
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"queue_media_video_processtask"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">QUEUE_PROCESSTASK</span><span class="hljs-params">()</span> </span>&#123;
        Queue queue = <span class="hljs-keyword">new</span> Queue(queue_media_video_processtask,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">return</span> queue;
    &#125;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 绑定队列到交换机 .</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queue    the queue</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exchange the exchange</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the binding</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">binding_queue_media_processtask</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"queue_media_video_processtask"</span>)</span> Queue queue, @<span class="hljs-title">Qualifier</span><span class="hljs-params">(EX_MEDIA_PROCESSTASK)</span> Exchange exchange) </span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(routingkey_media_video).noargs();
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 多线程处理消息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> configurer</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connectionFactory</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"customContainerFactory"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title">containerFactory</span><span class="hljs-params">(SimpleRabbitListenerContainerFactoryConfigurer configurer, ConnectionFactory</span></span>
<span class="hljs-function"><span class="hljs-params">            connectionFactory)</span> </span>&#123;
        SimpleRabbitListenerContainerFactory factory = <span class="hljs-keyword">new</span> SimpleRabbitListenerContainerFactory();
        factory.setConcurrentConsumers(DEFAULT_CONCURRENT);
        factory.setMaxConcurrentConsumers(DEFAULT_CONCURRENT);
        configurer.configure(factory,connectionFactory);
        <span class="hljs-keyword">return</span> factory;
    &#125;
&#125;</code></pre></div>

<h3 id="MediaProcessTask"><a href="#MediaProcessTask" class="headerlink" title="MediaProcessTask"></a>MediaProcessTask</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media_process.mq;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFileProcess_m3u8;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.HlsVideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.Mp4VideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media_process.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaProcessTask</span> </span>&#123;
    <span class="hljs-comment">//日志对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MediaProcessTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//ffmpeg绝对路径</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.ffmpeg-path&#125;"</span>)
    String ffmpeg_path;

    <span class="hljs-comment">//上传文件根目录</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.video-location&#125;"</span>)
    String serverPath;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span> , containerFactory=<span class="hljs-string">"customContainerFactory"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMediaProcessTask</span><span class="hljs-params">(String msg)</span></span>&#123;
        <span class="hljs-comment">//将接收到的消息转换为json数据</span>
        Map msgMap = JSON.parseObject(msg);
        LOGGER.info(<span class="hljs-string">"receive media process task msg :&#123;&#125; "</span>,msgMap);
        <span class="hljs-comment">//解析消息</span>
        <span class="hljs-comment">//媒资文件id</span>
        String mediaId = (String) msgMap.get(<span class="hljs-string">"mediaId"</span>);
        <span class="hljs-comment">//获取媒资文件信息</span>
        Optional&lt;MediaFile&gt; byId = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!byId.isPresent())&#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        MediaFile mediaFile = byId.get();
        <span class="hljs-comment">//媒资文件类型</span>
        String fileType = mediaFile.getFileType();
        <span class="hljs-comment">//目前只处理avi文件</span>
        <span class="hljs-keyword">if</span>(fileType == <span class="hljs-keyword">null</span> || !fileType.equals(<span class="hljs-string">"avi"</span>))&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303004"</span>); <span class="hljs-comment">// 处理状态为无需处理</span>
            mediaFileRepository.save(mediaFile);
        &#125;<span class="hljs-keyword">else</span>&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303001"</span>); <span class="hljs-comment">//处理状态为未处理</span>
        &#125;
        <span class="hljs-comment">//生成MP4</span>
        String videoPath = serverPath + mediaFile.getFilePath() + mediaFile.getFileName();
        String mp4Name = mediaFile.getFileId() + <span class="hljs-string">".mp4"</span>;
        String mp4FloderPath = serverPath  + mediaFile.getFilePath();
        Mp4VideoUtil mp4VideoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path, videoPath, mp4Name, mp4FloderPath);
        String result = mp4VideoUtil.generateMp4();
        <span class="hljs-keyword">if</span>(result == <span class="hljs-keyword">null</span> || !result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//操作失败写入处理日志</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//处理状态为处理失败</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">//生成m3u8列表</span>
        <span class="hljs-comment">//生成m3u8</span>
        String mp4VideoPath = serverPath + mediaFile.getFilePath()+ mp4Name;<span class="hljs-comment">//此地址为mp4的地址</span>
        String m3u8Name = mediaFile.getFileId()+<span class="hljs-string">".m3u8"</span>;
        String m3u8FolderPath = serverPath + mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>;
        <span class="hljs-comment">//调用工具类进行生成m3u8</span>
        HlsVideoUtil hlsVideoUtil = <span class="hljs-keyword">new</span> HlsVideoUtil(ffmpeg_path, mp4VideoPath, m3u8Name, m3u8FolderPath);
        String m3u8Result = hlsVideoUtil.generateM3u8();

        <span class="hljs-keyword">if</span>(m3u8Result==<span class="hljs-keyword">null</span> || !m3u8Result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//操作失败写入处理日志</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//处理状态为处理失败</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(m3u8Result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span> ;
        &#125;

        <span class="hljs-comment">//获取m3u8列表</span>
        List&lt;String&gt; ts_list = hlsVideoUtil.get_ts_list();
        <span class="hljs-comment">//更新处理状态为成功</span>
        mediaFile.setProcessStatus(<span class="hljs-string">"303002"</span>);<span class="hljs-comment">//处理状态为处理成功</span>
        MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
        mediaFileProcess_m3u8.setTslist(ts_list);
        mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
        <span class="hljs-comment">//m3u8文件url</span>
        mediaFile.setFileUrl(mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>+m3u8Name);
        mediaFileRepository.save(mediaFile);
    &#125;
&#125;</code></pre></div>

<h3 id="MediaUploadServiceImpl"><a href="#MediaUploadServiceImpl" class="headerlink" title="MediaUploadServiceImpl"></a>MediaUploadServiceImpl</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media.service.impl;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.netflix.discovery.converters.Auto;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.response.CheckChunkResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.response.MediaCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.ResponseResult;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.config.RabbitMQConfig;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.controller.MediaUploadController;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.service.MediaUploadService;
<span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hljs-keyword">import</span> javax.jws.Oneway;
<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-meta">@Service</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaUploadServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaUploadService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(MediaUploadController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-comment">//上传文件根目录</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.upload-location&#125;"</span>)
    String uploadPath;

   <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 检查文件信息是否已经存在本地以及mongodb内,其中一者不存在则重新注册</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 文件md5值</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileExt 文件扩展名</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 文件路径</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">register</span><span class="hljs-params">(String fileMd5, String fileName, Long fileSize, String mimetype, String fileExt)</span> </span>&#123;
        <span class="hljs-comment">//1.检查文件在磁盘上是否存在</span>
        <span class="hljs-comment">//2.检查文件信息在mongodb上是否存在</span>

        <span class="hljs-comment">//获取文件所属目录以及文件路径</span>
        String fileFloderPath = <span class="hljs-keyword">this</span>.getFileFloderPath(fileMd5);
        String filePath = <span class="hljs-keyword">this</span>.getFileFullPath(fileMd5, fileExt);
        File file = <span class="hljs-keyword">new</span> File(filePath);
        <span class="hljs-keyword">boolean</span> exists = file.exists();

        <span class="hljs-comment">//查询mongodb上的文件信息</span>
        Optional&lt;MediaFile&gt; optional = mediaFileRepository.findById(fileMd5);
        <span class="hljs-keyword">if</span>(exists &amp;&amp; optional.isPresent())&#123;
            ExceptionCast.cast(MediaCode.UPLOAD_FILE_REGISTER_EXIST);
        &#125;
        <span class="hljs-comment">//其中一者不存在则重新注册文件信息</span>
        File fileFloder = <span class="hljs-keyword">new</span> File(fileFloderPath);
        <span class="hljs-keyword">if</span>(!fileFloder.exists())&#123;
            <span class="hljs-comment">//创建文件目录</span>
            fileFloder.mkdirs();
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 检查文件块是否存在</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 文件md5</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chunk 块编号</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chunkSize 块大小</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> CheckChunkResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CheckChunkResult <span class="hljs-title">checkChunk</span><span class="hljs-params">(String fileMd5, Integer chunk, Integer chunkSize)</span> </span>&#123;
        <span class="hljs-comment">//获取文件块路径</span>
        String chunkFloder = <span class="hljs-keyword">this</span>.getChunkFloderPath(fileMd5);
        File chunkFile = <span class="hljs-keyword">new</span> File(chunkFloder + chunk);
        <span class="hljs-keyword">if</span>(chunkFile.exists())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CheckChunkResult(CommonCode.SUCCESS, <span class="hljs-keyword">true</span>);
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CheckChunkResult(CommonCode.SUCCESS, <span class="hljs-keyword">false</span>);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 上传分块文件</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> file 上传的文件</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chunk 分块号</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 文件MD5</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">uploadChunk</span><span class="hljs-params">(MultipartFile file, Integer chunk, String fileMd5)</span> </span>&#123;
        <span class="hljs-comment">//获取分块文件所属目录</span>
        String chunkFloder = <span class="hljs-keyword">this</span>.getChunkFloderPath(fileMd5);
        InputStream inputStream = <span class="hljs-keyword">null</span>;
        FileOutputStream fileOutputStream = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            inputStream = file.getInputStream();
            fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(chunkFloder + chunk);
            IOUtils.copy(inputStream,fileOutputStream);
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            <span class="hljs-comment">//文件保存失败</span>
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"upload chunk file fail:&#123;&#125;"</span>,e.getMessage());
            ExceptionCast.cast(MediaCode.CHUNK_FILE_UPLOAD_FAIL);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 合并文件块信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 文件MD5</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileName 文件名称</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileSize 文件大小</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mimetype 文件类型</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileExt 文件拓展名</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ResponseResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">mergeChunks</span><span class="hljs-params">(String fileMd5, String fileName, Long fileSize, String mimetype, String fileExt)</span> </span>&#123;
        <span class="hljs-comment">//获取文件块路径</span>
        String chunkFloderPath = getChunkFloderPath(fileMd5);
        <span class="hljs-comment">//合并文件路径</span>
        String fileFullPath = <span class="hljs-keyword">this</span>.getFileFullPath(fileMd5, fileExt);
        File mergeFile = <span class="hljs-keyword">new</span> File(fileFullPath);
        <span class="hljs-comment">//创建合并文件,如果存在则先删除再创建</span>
        <span class="hljs-keyword">if</span>(mergeFile.exists())&#123;
            mergeFile.delete();
        &#125;
        <span class="hljs-keyword">boolean</span> newFile = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">try</span> &#123;
            newFile = mergeFile.createNewFile();
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"mergechunks..create mergeFile fail:&#123;&#125;"</span>,e.getMessage());
        &#125;
        <span class="hljs-keyword">if</span>(!newFile)&#123;
            <span class="hljs-comment">//文件创建失败</span>
            ExceptionCast.cast(MediaCode.MERGE_FILE_CREATEFAIL);
        &#125;

        <span class="hljs-comment">//获取块文件列表,此列表是已经排序好的</span>
        List&lt;File&gt; chunkFiles = <span class="hljs-keyword">this</span>.getChunkFiles(chunkFloderPath);

        <span class="hljs-comment">//合并文件</span>
        mergeFile = <span class="hljs-keyword">this</span>.mergeFile(mergeFile, chunkFiles);
        <span class="hljs-keyword">if</span>(mergeFile == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(MediaCode.MERGE_FILE_FAIL);
        &#125;

        <span class="hljs-comment">//校验文件</span>
        <span class="hljs-keyword">boolean</span> checkResult = <span class="hljs-keyword">this</span>.checkFileMd5(mergeFile, fileMd5);
        <span class="hljs-keyword">if</span>(!checkResult)&#123;
            ExceptionCast.cast(MediaCode.MERGE_FILE_CHECKFAIL);
        &#125;

        <span class="hljs-comment">//将文件信息保存到数据库</span>
        MediaFile mediaFile = <span class="hljs-keyword">new</span> MediaFile();
        mediaFile.setFileId(fileMd5);
        mediaFile.setFileName(fileMd5+<span class="hljs-string">"."</span>+fileExt);
        mediaFile.setFileOriginalName(fileName);

        <span class="hljs-comment">//文件路径保存相对路径</span>
        String filePath = <span class="hljs-keyword">this</span>.getFilePath(fileMd5,fileExt);
        mediaFile.setFilePath(<span class="hljs-keyword">this</span>.getFilePath(fileMd5,fileExt));
        mediaFile.setFileUrl(filePath + fileName + <span class="hljs-string">"."</span> + fileExt);
        mediaFile.setFileSize(fileSize);
        mediaFile.setUploadTime(<span class="hljs-keyword">new</span> Date());
        mediaFile.setMimeType(mimetype);
        mediaFile.setFileType(fileExt);

        <span class="hljs-comment">//状态为上传成功</span>
        mediaFile.setFileStatus(<span class="hljs-string">"301002"</span>);
        MediaFile save = mediaFileRepository.save(mediaFile);

        <span class="hljs-comment">//向MQ发送视频处理消息</span>
        <span class="hljs-keyword">this</span>.sendProcessVideoMsg(fileMd5);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);

    &#125;

    <span class="hljs-comment">//视频处理路由</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.routingkey-media-video&#125;"</span>)
    <span class="hljs-keyword">public</span> String routingkey_media_video;

    <span class="hljs-meta">@Autowired</span>
    RabbitTemplate rabbitTemplate;

    <span class="hljs-comment">//向MQ发送视频处理消息</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> ResponseResult <span class="hljs-title">sendProcessVideoMsg</span><span class="hljs-params">(String mediaId)</span></span>&#123;
        Optional&lt;MediaFile&gt; optional = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
        &#125;
        MediaFile mediaFile = optional.get();
        <span class="hljs-comment">//发送视频处理消息</span>
        Map&lt;String,String&gt; msgMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        msgMap.put(<span class="hljs-string">"mediaId"</span>,mediaId);
        <span class="hljs-comment">//发送的消息</span>
        String msg = JSON.toJSONString(msgMap);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">this</span>.rabbitTemplate.convertAndSend(RabbitMQConfig.EX_MEDIA_PROCESSTASK,routingkey_media_video,msg);
            LOGGER.info(<span class="hljs-string">"send media process task msg:&#123;&#125;"</span>,msg);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            e.printStackTrace();
            LOGGER.info(<span class="hljs-string">"send media process task error,msg is:&#123;&#125;,error:&#123;&#125;"</span>,msg,e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">//校验文件MD5</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkFileMd5</span><span class="hljs-params">(File mergeFile, String fileMd5)</span> </span>&#123;
        <span class="hljs-keyword">if</span>(mergeFile == <span class="hljs-keyword">null</span> || StringUtils.isEmpty(fileMd5))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        &#125;
        <span class="hljs-comment">//进行md5校验</span>
        <span class="hljs-keyword">try</span> &#123;
            FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(mergeFile);
            <span class="hljs-comment">//得到文件的MD5</span>
            String md5Hex = DigestUtils.md5Hex(fileInputStream);
            <span class="hljs-comment">//比较两个MD5值</span>
            <span class="hljs-keyword">if</span>(md5Hex.equalsIgnoreCase(fileMd5))&#123;
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            &#125;
        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"未找到该文件 &#123;&#125;"</span>,e.getMessage());
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    &#125;
    <span class="hljs-comment">//合并文件</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> File <span class="hljs-title">mergeFile</span><span class="hljs-params">(File mergeFile, List&lt;File&gt; chunkFiles)</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//创建写文件对象</span>
            RandomAccessFile raf_write = <span class="hljs-keyword">new</span> RandomAccessFile(mergeFile,<span class="hljs-string">"rw"</span>);
            <span class="hljs-comment">//遍历分块文件开始合并</span>
            <span class="hljs-comment">//读取文件缓冲区</span>
            <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];
            <span class="hljs-keyword">for</span>(File chunkFile:chunkFiles)&#123;
                RandomAccessFile raf_read = <span class="hljs-keyword">new</span> RandomAccessFile(chunkFile,<span class="hljs-string">"r"</span>);
                <span class="hljs-keyword">int</span> len = -<span class="hljs-number">1</span>;
                <span class="hljs-comment">//读取分块文件</span>
                <span class="hljs-keyword">while</span>((len = raf_read.read(b))!= -<span class="hljs-number">1</span>)&#123;
                    <span class="hljs-comment">//向合并文件中写数据</span>
                    raf_write.write(b,<span class="hljs-number">0</span>,len);
                &#125; 
                raf_read.close();
            &#125; 
            raf_write.close();
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"merge file error:&#123;&#125;"</span>,e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125; 
        <span class="hljs-keyword">return</span> mergeFile;
    &#125;

    <span class="hljs-comment">//获取块文件列表</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;File&gt; <span class="hljs-title">getChunkFiles</span><span class="hljs-params">(String chunkFloderPath)</span> </span>&#123;
        <span class="hljs-comment">//块文件目录</span>
        File chunkFolder = <span class="hljs-keyword">new</span> File(chunkFloderPath);
        <span class="hljs-comment">//分块文件列表</span>
        File[] fileArray = chunkFolder.listFiles();
        <span class="hljs-comment">//将分块列表转为集合,便于排序</span>
        ArrayList&lt;File&gt; fileList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(fileArray));
        <span class="hljs-comment">//从小到大排序,按名称升序</span>
        Collections.sort(fileList, <span class="hljs-keyword">new</span> Comparator&lt;File&gt;() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(File o1, File o2)</span> </span>&#123;
                <span class="hljs-comment">//比较两个文件的名称</span>
                <span class="hljs-keyword">if</span> (Integer.parseInt(o1.getName()) &lt; Integer.parseInt(o2.getName())) &#123;
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
                &#125;
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            &#125;
        &#125;);
        <span class="hljs-keyword">return</span> fileList;
    &#125;

    <span class="hljs-comment">//获取文件块路径</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getChunkFloderPath</span><span class="hljs-params">(String fileMd5)</span> </span>&#123;
        <span class="hljs-comment">//获取分块文件所属目录</span>
        String fileFloderPath = <span class="hljs-keyword">this</span>.getFileFloderPath(fileMd5);
        String chunkFloder = fileFloderPath + <span class="hljs-string">"chunk/"</span>;
        File fileChunkFloder = <span class="hljs-keyword">new</span> File(chunkFloder);
        <span class="hljs-comment">//如果分块所属目录不存在则创建</span>
        <span class="hljs-keyword">if</span>(!fileChunkFloder.exists())&#123;
            fileChunkFloder.mkdirs();
        &#125;
        <span class="hljs-keyword">return</span> chunkFloder;
    &#125;



    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 根据文件md5得到文件的所属目录</span>
<span class="hljs-comment">     * 规则：</span>
<span class="hljs-comment">     * 一级目录：md5的第一个字符</span>
<span class="hljs-comment">     * 二级目录：md5的第二个字符</span>
<span class="hljs-comment">     * 三级目录：md5</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getFileFloderPath</span><span class="hljs-params">(String fileMd5)</span></span>&#123;
            String floderPath = uploadPath + <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) + <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>) + <span class="hljs-string">"/"</span> +fileMd5  + <span class="hljs-string">"/"</span>;
            <span class="hljs-keyword">return</span> floderPath;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 获取全文件路径</span>
<span class="hljs-comment">     * 文件名：md5+文件扩展名</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getFileFullPath</span><span class="hljs-params">(String fileMd5, String fileExt)</span></span>&#123;
        String floderPath = <span class="hljs-keyword">this</span>.getFileFloderPath(fileMd5);
        String filePath = floderPath + fileMd5 + <span class="hljs-string">"."</span> + fileExt;
        <span class="hljs-keyword">return</span> filePath;
    &#125;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 获取文件路径</span>
<span class="hljs-comment">     * 文件名：md5+文件扩展名</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getFilePath</span><span class="hljs-params">(String fileMd5, String fileExt)</span></span>&#123;
        String filePath = <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) + <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>) + <span class="hljs-string">"/"</span> + fileMd5 + <span class="hljs-string">"/"</span>;
        <span class="hljs-keyword">return</span> filePath;
    &#125;
&#125;</code></pre></div>

<h1 id="二、我的媒资"><a href="#二、我的媒资" class="headerlink" title="二、我的媒资"></a>二、我的媒资</h1><h2 id="1-需求分析-1"><a href="#1-需求分析-1" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>通过我的媒资可以查询本教育机构拥有的媒资文件，进行文件处理、删除文件、修改文件信息等操作，具体需求如<br>下：</p>
<p>1、分页查询我的媒资文件</p>
<p>2、删除媒资文件</p>
<p>3、处理媒资文件</p>
<p>4、修改媒资文件信息</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image5" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image5.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="2-API"><a href="#2-API" class="headerlink" title="2. API"></a>2. API</h2><p>本节讲解我的媒资文件分页查询、处理媒资文件，其它功能请学员自行实现</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(value = <span class="hljs-string">"媒体文件管理"</span>,description = <span class="hljs-string">"媒体文件管理接口"</span>,tags = &#123;<span class="hljs-string">"媒体文件管理接口"</span>&#125;)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileControllerApi</span> </span>&#123;
    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"查询文件列表"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest)</span></span>;
&#125;</code></pre></div>

<h2 id="3-服务端开发"><a href="#3-服务端开发" class="headerlink" title="3. 服务端开发"></a>3. 服务端开发</h2><h3 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">MediaFile</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
&#125;</code></pre></div>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>定义 <code>findList</code> 方法实现媒资文件查询列表</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media.service;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.request.QueryMediaFileRequest;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.QueryResponseResult;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileService</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 查询媒体问价内信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page 页码</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size 每页数量</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queryMediaFileRequest 查询条件</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest)</span></span>;
&#125;</code></pre></div>

<p>实现</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media.service.impl;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.request.QueryMediaFileRequest;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.QueryResponseResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.QueryResult;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.service.MediaFileService;
<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Example;
<span class="hljs-keyword">import</span> org.springframework.data.domain.ExampleMatcher;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Page;
<span class="hljs-keyword">import</span> org.springframework.data.domain.PageRequest;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaFileServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaFileService</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(MediaFileService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 分页查询文件信息</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page 页码</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size 每页数量</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queryMediaFileRequest 查询条件</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest)</span> </span>&#123;
        MediaFile mediaFile = <span class="hljs-keyword">new</span> MediaFile();
        <span class="hljs-comment">//查询条件</span>
        <span class="hljs-keyword">if</span>(queryMediaFileRequest == <span class="hljs-keyword">null</span>)&#123;
            queryMediaFileRequest = <span class="hljs-keyword">new</span> QueryMediaFileRequest();
        &#125;

        <span class="hljs-comment">//查询条件匹配器</span>
        ExampleMatcher exampleMatcher = ExampleMatcher.matching()
                .withMatcher(<span class="hljs-string">"tag"</span>, ExampleMatcher.GenericPropertyMatchers.contains()) <span class="hljs-comment">//模糊匹配</span>
                .withMatcher(<span class="hljs-string">"fileOriginalName"</span>, ExampleMatcher.GenericPropertyMatchers.contains()) <span class="hljs-comment">//模糊匹配文件原始名称</span>
                .withMatcher(<span class="hljs-string">"processStatus"</span>, ExampleMatcher.GenericPropertyMatchers.exact());<span class="hljs-comment">//精确匹配</span>
        <span class="hljs-comment">//设置查询条件对象</span>
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(queryMediaFileRequest.getTag()))&#123;
            <span class="hljs-comment">//设置标签</span>
            mediaFile.setTag(queryMediaFileRequest.getTag());
        &#125;
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(queryMediaFileRequest.getFileOriginalName()))&#123;
            <span class="hljs-comment">//设置文件原始名称</span>
            mediaFile.setFileOriginalName(queryMediaFileRequest.getFileOriginalName());
        &#125;
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(queryMediaFileRequest.getProcessStatus()))&#123;
            <span class="hljs-comment">//设置处理状态</span>
            mediaFile.setProcessStatus(queryMediaFileRequest.getProcessStatus());
        &#125;

        <span class="hljs-comment">//定义Example实例</span>
        Example&lt;MediaFile&gt; example = Example.of(mediaFile, exampleMatcher);

        <span class="hljs-comment">//校验page和size参数的合法性,并设置默认值</span>
        <span class="hljs-keyword">if</span>(page &lt;=<span class="hljs-number">0</span>)&#123;
            page = <span class="hljs-number">0</span>;
        &#125;<span class="hljs-keyword">else</span>&#123;
            page = page -<span class="hljs-number">1</span>;
        &#125;
        <span class="hljs-keyword">if</span>(size &lt;=<span class="hljs-number">0</span>)&#123;
            size = <span class="hljs-number">10</span>;
        &#125;

        <span class="hljs-comment">//分页对象</span>
        PageRequest pageRequest = <span class="hljs-keyword">new</span> PageRequest(page, size);
        <span class="hljs-comment">//分页查询</span>
        Page&lt;MediaFile&gt; all = mediaFileRepository.findAll(example, pageRequest);
        <span class="hljs-comment">//设置响应对象属性</span>
        QueryResult&lt;MediaFile&gt; mediaFileQueryResult = <span class="hljs-keyword">new</span> QueryResult&lt;MediaFile&gt;();
        mediaFileQueryResult.setList(all.getContent());
        mediaFileQueryResult.setTotal(all.getTotalElements());

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResponseResult(CommonCode.SUCCESS,mediaFileQueryResult);
    &#125;
&#125;</code></pre></div>

<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/media/file"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaFileController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaFileControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    MediaFileService mediaFileService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/list/&#123;page&#125;/&#123;size&#125;"</span>)
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,@<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest) </span>&#123;
        <span class="hljs-comment">//媒资文件信息查询</span>
        <span class="hljs-keyword">return</span> mediaFileService.findList(page,size,queryMediaFileRequest);
    &#125;
&#125;</code></pre></div>

<h3 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h3><p>使用 <code>swagger</code> 进行接口测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image6" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image6.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="4-前端开发"><a href="#4-前端开发" class="headerlink" title="4. 前端开发"></a>4. 前端开发</h2><h3 id="API方法"><a href="#API方法" class="headerlink" title="API方法"></a>API方法</h3><p>在 <code>media</code> 模块定义api方法如下：</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'./../../../base/api/public'</span>
<span class="hljs-keyword">import</span> querystring <span class="hljs-keyword">from</span> <span class="hljs-string">'querystring'</span>
<span class="hljs-keyword">let</span> sysConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@/../config/sysConfig'</span>)
<span class="hljs-keyword">let</span> apiUrl = sysConfig.xcApiUrlPre;

<span class="hljs-comment">/*页面列表*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> media_list = <span class="hljs-function">(<span class="hljs-params">page,size,params</span>) =&gt;</span> &#123;
    <span class="hljs-comment">//params为json格式</span>
    <span class="hljs-comment">//使用querystring将json对象转成key/value串</span>
    <span class="hljs-keyword">let</span> querys = querystring.stringify(params)
    <span class="hljs-keyword">return</span> http.requestQuickGet(apiUrl+<span class="hljs-string">'/media/file/list/'</span>+page+<span class="hljs-string">'/'</span>+size+<span class="hljs-string">'/?'</span>+querys)
&#125;

<span class="hljs-comment">/*发送处理消息*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> media_process = <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/media/file/process/'</span>+id)
&#125;</code></pre></div>

<h3 id="页面"><a href="#页面" class="headerlink" title="页面"></a>页面</h3><p>在 <code>media</code> 模块创建 <code>media_list.vue</code>，可参考 <code>cms</code>系统的 <code>page_list.vue</code> 来编写此页面。</p>
<p>1、视图</p>
<div class="hljs"><pre><code class="hljs vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!--查询表单--&gt;
    &lt;el-form :model&#x3D;&quot;params&quot;&gt;
      标签：
      &lt;el-input v-model&#x3D;&quot;params.tag&quot; style&#x3D;&quot;width:160px&quot;&gt;&lt;&#x2F;el-input&gt;
      原始名称：
      &lt;el-input v-model&#x3D;&quot;params.fileOriginalName&quot; style&#x3D;&quot;width:160px&quot;&gt;&lt;&#x2F;el-input&gt;
      处理状态：
      &lt;el-select v-model&#x3D;&quot;params.processStatus&quot; placeholder&#x3D;&quot;请选择处理状态&quot;&gt;
        &lt;el-option
          v-for&#x3D;&quot;item in processStatusList&quot;
          :key&#x3D;&quot;item.id&quot;
          :label&#x3D;&quot;item.name&quot;
          :value&#x3D;&quot;item.id&quot;&gt;
        &lt;&#x2F;el-option&gt;
      &lt;&#x2F;el-select&gt;
      &lt;br&#x2F;&gt;
      &lt;el-button type&#x3D;&quot;primary&quot; v-on:click&#x3D;&quot;query&quot; size&#x3D;&quot;small&quot;&gt;查询&lt;&#x2F;el-button&gt;
      &lt;router-link class&#x3D;&quot;mui-tab-item&quot; :to&#x3D;&quot;&#123;path:&#39;&#x2F;upload&#39;&#125;&quot;&gt;
        &lt;el-button  type&#x3D;&quot;primary&quot; size&#x3D;&quot;small&quot; v-if&#x3D;&quot;ischoose !&#x3D; true&quot;&gt;上传文件&lt;&#x2F;el-button&gt;
      &lt;&#x2F;router-link&gt;
    &lt;&#x2F;el-form&gt;
    &lt;!--列表--&gt;
    &lt;el-table :data&#x3D;&quot;list&quot; highlight-current-row v-loading&#x3D;&quot;listLoading&quot; style&#x3D;&quot;width: 100%;&quot;&gt;
      &lt;el-table-column type&#x3D;&quot;index&quot; width&#x3D;&quot;30&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileOriginalName&quot; label&#x3D;&quot;原始文件名称&quot; width&#x3D;&quot;220&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileName&quot; label&#x3D;&quot;文件名称&quot; width&#x3D;&quot;220&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileUrl&quot; label&#x3D;&quot;访问url&quot; width&#x3D;&quot;260&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;tag&quot; label&#x3D;&quot;标签&quot; width&#x3D;&quot;100&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileSize&quot; label&#x3D;&quot;文件大小&quot; width&#x3D;&quot;120&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;processStatus&quot; label&#x3D;&quot;处理状态&quot; width&#x3D;&quot;100&quot; :formatter&#x3D;&quot;formatProcessStatus&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;uploadTime&quot; label&#x3D;&quot;创建时间&quot; width&#x3D;&quot;110&quot; :formatter&#x3D;&quot;formatCreatetime&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column label&#x3D;&quot;开始处理&quot; width&#x3D;&quot;&quot; v-if&#x3D;&quot;ischoose !&#x3D; true&quot;&gt;
        &lt;template slot-scope&#x3D;&quot;scope&quot;&gt;
          &lt;el-button
            size&#x3D;&quot;small&quot; type&#x3D;&quot;primary&quot; plain @click&#x3D;&quot;process(scope.row.fileId)&quot;&gt;开始处理
          &lt;&#x2F;el-button&gt;
        &lt;&#x2F;template&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column label&#x3D;&quot;选择&quot; width&#x3D;&quot;80&quot; v-if&#x3D;&quot;ischoose &#x3D;&#x3D; true&quot;&gt;
        &lt;template slot-scope&#x3D;&quot;scope&quot;&gt;
        &lt;el-button
          size&#x3D;&quot;small&quot; type&#x3D;&quot;primary&quot; plain @click&#x3D;&quot;choose(scope.row)&quot;&gt;选择&lt;&#x2F;el-button&gt;
        &lt;&#x2F;template&gt;
      &lt;&#x2F;el-table-column&gt;
    &lt;&#x2F;el-table&gt;
    &lt;!--分页--&gt;
    &lt;el-col :span&#x3D;&quot;24&quot; class&#x3D;&quot;toolbar&quot;&gt;

      &lt;el-pagination background layout&#x3D;&quot;prev, pager, next&quot; @current-change&#x3D;&quot;changePage&quot; :page-size&#x3D;&quot;this.params.size&quot;
                     :total&#x3D;&quot;total&quot; :current-page&#x3D;&quot;this.params.page&quot;
                     style&#x3D;&quot;float:right;&quot;&gt;
      &lt;&#x2F;el-pagination&gt;
    &lt;&#x2F;el-col&gt;
  &lt;&#x2F;div&gt;
&lt;&#x2F;template&gt;</code></pre></div>

<p>2、数据对象、方法、钩子函数</p>
<div class="hljs"><pre><code class="hljs vue">&lt;script&gt;
  import * as mediaApi from &#39;..&#x2F;api&#x2F;media&#39;
  import utilApi from &#39;@&#x2F;common&#x2F;utils&#39;;
  export default&#123;
    props: [&#39;ischoose&#39;],
    &#x2F;&#x2F; 页面数据
    data()&#123;
      return &#123;
        params:&#123;
          page:1,&#x2F;&#x2F;页码
          size:10,&#x2F;&#x2F;每页显示个数
          tag:&#39;&#39;,&#x2F;&#x2F;标签
          fileName:&#39;&#39;,&#x2F;&#x2F;文件名称
          processStatus:&#39;&#39;&#x2F;&#x2F;处理状态
        &#125;,
        listLoading:false,
        list:[],
        total:0,
        processStatusList:[]
      &#125;
    &#125;,

    &#x2F;&#x2F;方法
    methods:&#123;
      formatCreatetime(row, column)&#123;
        var createTime &#x3D; new Date(row.uploadTime);
        if (createTime) &#123;
          return utilApi.formatDate(createTime, &#39;yyyy-MM-dd hh:mm:ss&#39;);
        &#125;
      &#125;,
      formatProcessStatus(row,column)&#123;
        var processStatus &#x3D; row.processStatus;
        if (processStatus) &#123;
            if(processStatus &#x3D;&#x3D; &#39;303001&#39;)&#123;
              return &quot;处理中&quot;;
            &#125;else if(processStatus &#x3D;&#x3D; &#39;303002&#39;)&#123;
              return &quot;处理成功&quot;;
            &#125;else if(processStatus &#x3D;&#x3D; &#39;303003&#39;)&#123;
              return &quot;处理失败&quot;;
            &#125;else if(processStatus &#x3D;&#x3D; &#39;303004&#39;)&#123;
              return &quot;无需处理&quot;;
            &#125;
        &#125;
      &#125;,
      choose(mediaFile)&#123;
          if(mediaFile.processStatus !&#x3D;&#39;303002&#39; &amp;&amp; mediaFile.processStatus !&#x3D;&#39;303004&#39;)&#123;
            this.$message.error(&#39;该文件未处理，不允许选择&#39;);
            return ;
          &#125;
        if(!mediaFile.fileUrl)&#123;
          this.$message.error(&#39;该文件的访问url为空，不允许选择&#39;);
          return ;
        &#125;
        &#x2F;&#x2F;调用父组件的choosemedia方法
        this.$emit(&#39;choosemedia&#39;,mediaFile.fileId,mediaFile.fileOriginalName,mediaFile.fileUrl);
      &#125;,
      changePage(page)&#123;
        this.params.page &#x3D; page;
        this.query()
      &#125;,
      process (id) &#123;
&#x2F;&#x2F;        console.log(id)
        mediaApi.media_process(id).then((res)&#x3D;&gt;&#123;
          console.log(res)
         if(res.success)&#123;
           this.$message.success(&#39;开始处理，请稍后查看处理结果&#39;);
         &#125;else&#123;
           this.$message.error(&#39;操作失败，请刷新页面重试&#39;);
         &#125;
        &#125;)
      &#125;,
      query()&#123;
        mediaApi.media_list(this.params.page,this.params.size,this.params).then((res)&#x3D;&gt;&#123;
          console.log(res)
          this.total &#x3D; res.queryResult.total
          this.list &#x3D; res.queryResult.list
        &#125;)
      &#125;
    &#125;,

    &#x2F;&#x2F;页面初始化完成前钩子
    created()&#123;
        &#x2F;&#x2F;默认第一页
      this.params.page &#x3D; Number.parseInt(this.$route.query.page||1);
    &#125;,
    &#x2F;&#x2F;页面初始化加载前的钩子
    mounted() &#123;
      &#x2F;&#x2F;默认查询页面
      this.query()
      &#x2F;&#x2F;初始化处理状态
      this.processStatusList &#x3D; [
        &#123;
          id:&#39;&#39;,
          name:&#39;全部&#39;
        &#125;,
        &#123;
          id:&#39;303001&#39;,
          name:&#39;处理中&#39;
        &#125;,
        &#123;
          id:&#39;303002&#39;,
          name:&#39;处理成功&#39;
        &#125;,
        &#123;
          id:&#39;303003&#39;,
          name:&#39;处理失败&#39;
        &#125;,
        &#123;
          id:&#39;303004&#39;,
          name:&#39;无需处理&#39;
        &#125;
      ]
    &#125;
  &#125;
&lt;&#x2F;script&gt;</code></pre></div>

<h1 id="三、媒资与课程计划关联"><a href="#三、媒资与课程计划关联" class="headerlink" title="三、媒资与课程计划关联"></a>三、媒资与课程计划关联</h1><h2 id="1-需求分析-2"><a href="#1-需求分析-2" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能。其它模块已可以使用媒资管理功<br>能，本节要讲解课程计划在编辑时如何选择媒资文件。</p>
<p>操作的业务流程如下：</p>
<p>1、进入课程计划修改页面</p>
<p>2、选择视频</p>
<p>打开媒资文件查询窗口，找到该课程章节的视频，选择此视频。</p>
<p>点击 “<code>选择媒资文件</code>” 打开媒资文件列表</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image7" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image7.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>3、 选择成功后，将在课程管理数据库保存课程计划对应在的课程视频地址。</p>
<p>在课程管理数据库创建表 <code>teachplan_media</code> 存储课程计划与媒资关联信息，表结构如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image8" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image8.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="2-选择视频"><a href="#2-选择视频" class="headerlink" title="2. 选择视频"></a>2. 选择视频</h2><h3 id="Vue-父子组件通信"><a href="#Vue-父子组件通信" class="headerlink" title="Vue 父子组件通信"></a>Vue 父子组件通信</h3><p>上一章已实现了我的媒资页面，所以媒资查询窗口页面不需要再开发，将 “<code>我的媒资页面</code>” 作为一个组件在修改课程<br>计划页面中引用，如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image9" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image9.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>修改课程计划页面为父组件，我的媒资查询页面为子组件。</p>
<p>问题1：</p>
<p>我的媒资页面在选择媒资文件时不允许显示，比如 <code>视频处理</code> 按钮，该如何控制？</p>
<p>这时就需要父组件（<code>修改课程计划页面</code>）向子组件（<code>我的媒资页面</code>）传入一个变量，使用此变量来控制当前是否进入选择媒资文件业务，从而控制哪些元素不显示，如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image10" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image10.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>问题2：</p>
<p>在我的媒资页面选择了媒资文件，如何将选择的媒资文件信息传到父组件？</p>
<p>这时就需要子组件调用父组件的方法来解决此问题，如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image11" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image11.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="父组件：修改课程计划"><a href="#父组件：修改课程计划" class="headerlink" title="父组件：修改课程计划"></a>父组件：修改课程计划</h3><p>本节实现功能：在课程计划页面打开我的媒资页面。</p>
<p>1、引入子组件</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> mediaList <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/media/page/media_list.vue'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
    components:&#123;
        mediaList
    &#125;,
    data() &#123;
        ....</code></pre></div>

<p>2、使用子组件</p>
<p>在父组件的视图中使用子组件，同时传入变量 <code>ischoose</code>，并指定父组件的方法名为<code>choosemedia</code></p>
<p>这里使用 <code>el-dialog</code> 实现弹出窗口。</p>
<div class="hljs"><pre><code class="hljs vue">&lt;el‐dialog title&#x3D;&quot;选择媒资文件&quot; :visible.sync&#x3D;&quot;mediaFormVisible&quot;&gt;
	&lt;media‐list v‐bind:ischoose&#x3D;&quot;true&quot; @choosemedia&#x3D;&quot;choosemedia&quot;&gt;&lt;&#x2F;media‐list&gt;
&lt;&#x2F;el‐dialog&gt;</code></pre></div>

<p>3、choosemedia 方法</p>
<p>在父组件中定义 <code>choosemedia</code> 方法，接收子组件调用，参数包括：媒资文件 <code>id</code>、媒资文件的原始名称、媒资文件 <code>url</code></p>
<div class="hljs"><pre><code class="hljs js">choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
&#125;</code></pre></div>

<p>4、打开子组件窗口</p>
<p>1）打开子组件窗口按钮定义</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font‐size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on</span>‐<span class="hljs-attr">click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.choosevideo(data.id) &#125;&gt;选择视频<span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span></code></pre></div>

<p>效果如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image12" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image12.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2）打开子组件窗口方法</p>
<p>定义 <code>querymedia</code> 方法：</p>
<div class="hljs"><pre><code class="hljs js">methods: &#123;
    <span class="hljs-comment">//打开查询媒资文件窗口，传入课程计划id</span>
    choosevideo(teachplanId)&#123;
        <span class="hljs-keyword">this</span>.activeTeachplanId = teachplanId;
        <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-literal">true</span>;
    &#125;,
    ...
&#125;</code></pre></div>

<h3 id="子组件：我的媒资查询"><a href="#子组件：我的媒资查询" class="headerlink" title="子组件：我的媒资查询"></a>子组件：我的媒资查询</h3><p>1、定义 <code>ischoose</code> 变量，接收父组件传入的 <code>ischoose</code></p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>&#123;
    props: [<span class="hljs-string">'ischoose'</span>],
    data()&#123;</code></pre></div>

<p>2、父组件传的 <code>ischoose</code> 变量为 <code>true</code> 时表示当前是选择媒资文件业务，需要控制页面元素是否显示</p>
<p>1）<code>ischoose=true</code>，选择按钮显示</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐table‐column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"选择"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"80"</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">if</span>=<span class="hljs-string">"ischoose == true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot</span>‐<span class="hljs-attr">scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"choose(scope.row)"</span>&gt;</span>选择<span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el‐table‐column</span>&gt;</span></code></pre></div>

<p>2）<code>ischoose=false</code>，视频处理按钮显示</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐table‐column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"开始处理"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">if</span>=<span class="hljs-string">"ischoose != true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot</span>‐<span class="hljs-attr">scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span></span>
<span class="hljs-tag">                   <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"process(scope.row.fileId)"</span>&gt;</span>开始处理
            <span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el‐table‐column</span>&gt;</span></code></pre></div>

<p>3）选择媒资文件方法</p>
<p>用户点击“选择”按钮将向父组件传递媒资文件信息</p>
<div class="hljs"><pre><code class="hljs js">choose(mediaFile)&#123;
    <span class="hljs-keyword">if</span>(mediaFile.processStatus !=<span class="hljs-string">'303002'</span> &amp;&amp; mediaFile.processStatus !=<span class="hljs-string">'303004'</span>)&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'该文件未处理，不允许选择'</span>);
        <span class="hljs-keyword">return</span> ;
    &#125;
    <span class="hljs-keyword">if</span>(!mediaFile.fileUrl)&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'该文件的访问url为空，不允许选择'</span>);
        <span class="hljs-keyword">return</span> ;
    &#125; 
    <span class="hljs-comment">//调用父组件的choosemedia方法</span>
    <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'choosemedia'</span>,mediaFile.fileId,mediaFile.fileOriginalName);
&#125;</code></pre></div>

<h3 id="页面效果"><a href="#页面效果" class="headerlink" title="页面效果"></a>页面效果</h3><p><a href="https://qnoss.codeyee.com/20200704_14/image13" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image13.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="全部代码"><a href="#全部代码" class="headerlink" title="全部代码"></a>全部代码</h3><h4 id="course-plan-vue"><a href="#course-plan-vue" class="headerlink" title="course_plan.vue"></a>course_plan.vue</h4><div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"teachplayFormVisible = true"</span>&gt;</span>添加课程计划<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:data</span>=<span class="hljs-string">"teachplanList"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:props</span>=<span class="hljs-string">"defaultProps"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">node-key</span>=<span class="hljs-string">"id"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">default-expand-all</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:expand-on-click-node</span>=<span class="hljs-string">"false"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:render-content</span>=<span class="hljs-string">"renderContent"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-tree</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"添加课程计划"</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"teachplayFormVisible"</span> &gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"teachplanForm"</span>  <span class="hljs-attr">:model</span>=<span class="hljs-string">"teachplanActive"</span> <span class="hljs-attr">label-width</span>=<span class="hljs-string">"140px"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:600px;"</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">"teachplanRules"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"上级结点"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.parentid"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"不填表示根结点"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span></span>
<span class="hljs-tag">              <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in teachplanList"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:label</span>=<span class="hljs-string">"item.pname"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:value</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-option</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"章节/课时名称"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"pname"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.pname"</span> <span class="hljs-attr">auto-complete</span>=<span class="hljs-string">"off"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"课程类型"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-radio-group</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.ptype"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'1'</span>&gt;</span>视频<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'2'</span>&gt;</span>文档<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-radio-group</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"学习时长（分钟）  请输入数字"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.timelength"</span> <span class="hljs-attr">auto-complete</span>=<span class="hljs-string">"off"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"排序字段"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.orderby"</span> <span class="hljs-attr">auto-complete</span>=<span class="hljs-string">"off"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"章节/课时介绍"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"description"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"textarea"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.description"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"状态"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"status"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-radio-group</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.status"</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"0"</span> &gt;</span>未发布<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'1'</span>&gt;</span>已发布<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-radio-group</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span>  &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"addTeachplan"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"resetForm"</span>&gt;</span>重置<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>

      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"选择媒资文件"</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"mediaFormVisible"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">media-list</span> <span class="hljs-attr">v-bind:ischoose</span>=<span class="hljs-string">"true"</span> @<span class="hljs-attr">choosemedia</span>=<span class="hljs-string">"choosemedia"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">media-list</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
<span class="javascript">  <span class="hljs-keyword">let</span> id = <span class="hljs-number">1000</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> courseApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../api/course'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> utilApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../common/utils'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> systemApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../base/api/system'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> mediaList <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/media/page/media_list.vue'</span>;</span>

<span class="javascript">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;</span>
    components:&#123;
      mediaList
    &#125;,
    data() &#123;
<span class="actionscript">      <span class="hljs-keyword">return</span> &#123;</span>
<span class="actionscript">        mediaFormVisible:<span class="hljs-literal">false</span>,</span>
<span class="actionscript">        teachplayFormVisible:<span class="hljs-literal">false</span>,<span class="hljs-comment">//控制添加窗口是否显示</span></span>
        teachplanList : [&#123;
          id: 1,
<span class="actionscript">          pname: <span class="hljs-string">'一级 1'</span>,</span>
          children: [&#123;
            id: 4,
<span class="actionscript">            pname: <span class="hljs-string">'二级 1-1'</span>,</span>
            children: [&#123;
              id: 9,
<span class="actionscript">              pname: <span class="hljs-string">'三级 1-1-1'</span></span>
            &#125;, &#123;
              id: 10,
<span class="actionscript">              pname: <span class="hljs-string">'三级 1-1-2'</span></span>
            &#125;]
          &#125;]
        &#125;],
        defaultProps:&#123;
<span class="actionscript">          children: <span class="hljs-string">'children'</span>,</span>
<span class="actionscript">          label: <span class="hljs-string">'pname'</span></span>
        &#125;,
        teachplanRules: &#123;
          pname: [
<span class="actionscript">            &#123;required: <span class="hljs-literal">true</span>, message: <span class="hljs-string">'请输入课程计划名称'</span>, trigger: <span class="hljs-string">'blur'</span>&#125;</span>
          ],
          status: [
<span class="actionscript">            &#123;required: <span class="hljs-literal">true</span>, message: <span class="hljs-string">'请选择状态'</span>, trigger: <span class="hljs-string">'blur'</span>&#125;</span>
          ]
        &#125;,
        teachplanActive:&#123;&#125;,
<span class="actionscript">        teachplanId:<span class="hljs-string">''</span></span>
      &#125;
    &#125;,
    methods: &#123;
<span class="actionscript">        <span class="hljs-comment">//选择视频，打开窗口</span></span>
      choosevideo(data)&#123;
<span class="actionscript">          <span class="hljs-comment">//得到当前的课程计划</span></span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.teachplanId = data.id</span>
<span class="actionscript"><span class="hljs-comment">//        alert(this.teachplanId)</span></span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-literal">true</span>;<span class="hljs-comment">//打开窗口</span></span>
      &#125;,
<span class="actionscript">      <span class="hljs-comment">//保存选择的视频</span></span>
      choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
<span class="actionscript">        <span class="hljs-comment">//保存视频到课程计划表中</span></span>
<span class="javascript">        <span class="hljs-keyword">let</span> teachplanMedia =&#123;&#125;</span>
        teachplanMedia.mediaId =mediaId;
        teachplanMedia.mediaFileOriginalName =fileOriginalName;
        teachplanMedia.mediaUrl =mediaUrl;
<span class="actionscript">        teachplanMedia.courseId =<span class="hljs-keyword">this</span>.courseid;</span>
<span class="actionscript">        <span class="hljs-comment">//课程计划</span></span>
<span class="actionscript">        teachplanMedia.teachplanId=<span class="hljs-keyword">this</span>.teachplanId</span>

<span class="javascript">        courseApi.savemedia(teachplanMedia).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span>
            if(res.success)&#123;
<span class="actionscript">                <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"选择视频成功"</span>)</span>
<span class="actionscript">              <span class="hljs-comment">//查询课程计划</span></span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.findTeachplan()</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span>&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.$message.error(res.message)</span>
            &#125;
        &#125;)
      &#125;,
<span class="actionscript">      <span class="hljs-comment">//提交课程计划</span></span>
      addTeachplan()&#123;
<span class="actionscript">        <span class="hljs-comment">//校验表单</span></span>
<span class="javascript">        <span class="hljs-keyword">this</span>.$refs.teachplanForm.validate(<span class="hljs-function">(<span class="hljs-params">valid</span>) =&gt;</span> &#123;</span>
            if (valid) &#123;
<span class="actionscript">                <span class="hljs-comment">//调用api方法</span></span>
<span class="actionscript">              <span class="hljs-comment">//将课程id设置到teachplanActive</span></span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.teachplanActive.courseid = <span class="hljs-keyword">this</span>.courseid</span>
<span class="javascript">              courseApi.addTeachplan(<span class="hljs-keyword">this</span>.teachplanActive).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span>
                if(res.success)&#123;
<span class="actionscript">                    <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"添加成功"</span>)</span>
<span class="actionscript">                    <span class="hljs-comment">//刷新树</span></span>
<span class="actionscript">                    <span class="hljs-keyword">this</span>.findTeachplan()</span>
<span class="actionscript">                &#125;<span class="hljs-keyword">else</span>&#123;</span>
<span class="actionscript">                  <span class="hljs-keyword">this</span>.$message.error(res.message)</span>
                &#125;

              &#125;)
            &#125;
        &#125;)
      &#125;,
<span class="actionscript">  <span class="hljs-comment">//重置表单</span></span>
      resetForm()&#123;
<span class="actionscript">        <span class="hljs-keyword">this</span>.teachplanActive = &#123;&#125;</span>
      &#125;,

      append(data) &#123;
<span class="actionscript">        <span class="hljs-keyword">const</span> newChild = &#123; id: id++, label: <span class="hljs-string">'testtest'</span>, children: [] &#125;;</span>
        if (!data.children) &#123;
<span class="actionscript">          <span class="hljs-keyword">this</span>.$<span class="hljs-keyword">set</span>(data, <span class="hljs-string">'children'</span>, []);</span>
        &#125;
        data.children.push(newChild);

      &#125;,
      edit(data)&#123;
<span class="actionscript">        <span class="hljs-comment">//alert(data.id);</span></span>
      &#125;,
      remove(node, data) &#123;
<span class="actionscript">        <span class="hljs-keyword">const</span> parent = node.parent;</span>
<span class="actionscript">        <span class="hljs-keyword">const</span> children = parent.data.children || parent.data;</span>
<span class="javascript">        <span class="hljs-keyword">const</span> index = children.findIndex(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.id === data.id);</span>
        children.splice(index, 1);

      &#125;,
      renderContent(h, &#123; node, data, store &#125;) &#123;
<span class="actionscript">        <span class="hljs-keyword">return</span> (</span>
<span class="handlebars"><span class="xml">          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"flex: 1; display: flex; align-items: center; justify-content: space-between; font-size: 14px; padding-right: 8px;"</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;node.label&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on-click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.choosevideo(data) &#125;&gt;&#123;data.mediaFileOriginalName&#125;<span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span> 选择视频<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on-click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.edit(data) &#125;&gt;修改<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on-click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.remove(node, data) &#125;&gt;删除<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>);</span></span>
      &#125;,
      findTeachplan()&#123;
<span class="actionscript">        <span class="hljs-keyword">this</span>.teachplanList = []</span>
<span class="actionscript">        <span class="hljs-comment">//查询课程计划</span></span>
<span class="javascript">        courseApi.findTeachplanList(<span class="hljs-keyword">this</span>.courseid).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span>
            if(res &amp;&amp; res.children)&#123;
<span class="actionscript">              <span class="hljs-keyword">this</span>.teachplanList = res.children;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> &#123;</span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"课程计划查询失败"</span>)</span>
<span class="javascript">              <span class="hljs-built_in">console</span>.log(res)</span>
            &#125;
        &#125;)
      &#125;
    &#125;,
    mounted()&#123;
<span class="actionscript">      <span class="hljs-comment">//课程id</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.courseid = <span class="hljs-keyword">this</span>.$route.params.courseid;</span>
<span class="actionscript">      <span class="hljs-comment">//查询课程计划</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.findTeachplan()</span>
    &#125;
  &#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></code></pre></div>

<h4 id="media-list-vue"><a href="#media-list-vue" class="headerlink" title="media_list.vue"></a>media_list.vue</h4><div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!--查询表单--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"params"</span>&gt;</span>
      标签：
      <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"params.tag"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:160px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
      原始名称：
      <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"params.fileOriginalName"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:160px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
      处理状态：
      <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"params.processStatus"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请选择处理状态"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span></span>
<span class="hljs-tag">          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in processStatusList"</span></span>
<span class="hljs-tag">          <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span></span>
<span class="hljs-tag">          <span class="hljs-attr">:label</span>=<span class="hljs-string">"item.name"</span></span>
<span class="hljs-tag">          <span class="hljs-attr">:value</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"query"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>&gt;</span>查询<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mui-tab-item"</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">"&#123;path:'/upload'&#125;"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span>  <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ischoose != true"</span>&gt;</span>上传文件<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
    <span class="hljs-comment">&lt;!--列表--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">highlight-current-row</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"listLoading"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%;"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"30"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileOriginalName"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"原始文件名称"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"220"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileName"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"文件名称"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"220"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileUrl"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"访问url"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"260"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"tag"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"标签"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileSize"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"文件大小"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"120"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"processStatus"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"处理状态"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">:formatter</span>=<span class="hljs-string">"formatProcessStatus"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"uploadTime"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"创建时间"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"110"</span> <span class="hljs-attr">:formatter</span>=<span class="hljs-string">"formatCreatetime"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"开始处理"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">""</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ischoose != true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot-scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span>
<span class="hljs-tag">            <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"process(scope.row.fileId)"</span>&gt;</span>开始处理
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"选择"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"80"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ischoose == true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot-scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span>
<span class="hljs-tag">          <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"choose(scope.row)"</span>&gt;</span>选择<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>
    <span class="hljs-comment">&lt;!--分页--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-col</span> <span class="hljs-attr">:span</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"toolbar"</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-pagination</span> <span class="hljs-attr">background</span> <span class="hljs-attr">layout</span>=<span class="hljs-string">"prev, pager, next"</span> @<span class="hljs-attr">current-change</span>=<span class="hljs-string">"changePage"</span> <span class="hljs-attr">:page-size</span>=<span class="hljs-string">"this.params.size"</span></span>
<span class="hljs-tag">                     <span class="hljs-attr">:total</span>=<span class="hljs-string">"total"</span> <span class="hljs-attr">:current-page</span>=<span class="hljs-string">"this.params.page"</span></span>
<span class="hljs-tag">                     <span class="hljs-attr">style</span>=<span class="hljs-string">"float:right;"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-pagination</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-col</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> mediaApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../api/media'</span></span>
<span class="javascript">  <span class="hljs-keyword">import</span> utilApi <span class="hljs-keyword">from</span> <span class="hljs-string">'@/common/utils'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>&#123;</span>
<span class="actionscript">    props: [<span class="hljs-string">'ischoose'</span>],</span>
<span class="actionscript">    <span class="hljs-comment">// 页面数据</span></span>
    data()&#123;
<span class="actionscript">      <span class="hljs-keyword">return</span> &#123;</span>
        params:&#123;
<span class="actionscript">          page:<span class="hljs-number">1</span>,<span class="hljs-comment">//页码</span></span>
<span class="actionscript">          size:<span class="hljs-number">10</span>,<span class="hljs-comment">//每页显示个数</span></span>
<span class="actionscript">          tag:<span class="hljs-string">''</span>,<span class="hljs-comment">//标签</span></span>
<span class="actionscript">          fileName:<span class="hljs-string">''</span>,<span class="hljs-comment">//文件名称</span></span>
<span class="actionscript">          processStatus:<span class="hljs-string">''</span><span class="hljs-comment">//处理状态</span></span>
        &#125;,
<span class="actionscript">        listLoading:<span class="hljs-literal">false</span>,</span>
        list:[],
        total:0,
        processStatusList:[]
      &#125;
    &#125;,

<span class="actionscript">    <span class="hljs-comment">//方法</span></span>
    methods:&#123;
      formatCreatetime(row, column)&#123;
<span class="javascript">        <span class="hljs-keyword">var</span> createTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(row.uploadTime);</span>
        if (createTime) &#123;
<span class="actionscript">          <span class="hljs-keyword">return</span> utilApi.formatDate(createTime, <span class="hljs-string">'yyyy-MM-dd hh:mm:ss'</span>);</span>
        &#125;
      &#125;,
      formatProcessStatus(row,column)&#123;
<span class="actionscript">        <span class="hljs-keyword">var</span> processStatus = row.processStatus;</span>
        if (processStatus) &#123;
<span class="actionscript">            <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303001'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"处理中"</span>;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303002'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"处理成功"</span>;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303003'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"处理失败"</span>;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303004'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"无需处理"</span>;</span>
            &#125;
        &#125;
      &#125;,
      choose(mediaFile)&#123;
<span class="actionscript">          <span class="hljs-keyword">if</span>(mediaFile.processStatus !=<span class="hljs-string">'303002'</span> &amp;&amp; mediaFile.processStatus !=<span class="hljs-string">'303004'</span>)&#123;</span>
<span class="actionscript">            <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'该文件未处理，不允许选择'</span>);</span>
<span class="actionscript">            <span class="hljs-keyword">return</span> ;</span>
          &#125;
        if(!mediaFile.fileUrl)&#123;
<span class="actionscript">          <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'该文件的访问url为空，不允许选择'</span>);</span>
<span class="actionscript">          <span class="hljs-keyword">return</span> ;</span>
        &#125;
<span class="actionscript">        <span class="hljs-comment">//调用父组件的choosemedia方法</span></span>
<span class="actionscript">        <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'choosemedia'</span>,mediaFile.fileId,mediaFile.fileOriginalName,mediaFile.fileUrl);</span>
      &#125;,
      changePage(page)&#123;
<span class="actionscript">        <span class="hljs-keyword">this</span>.params.page = page;</span>
<span class="actionscript">        <span class="hljs-keyword">this</span>.query()</span>
      &#125;,
      process (id) &#123;
<span class="actionscript"><span class="hljs-comment">//        console.log(id)</span></span>
<span class="javascript">        mediaApi.media_process(id).then(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>&#123;</span>
<span class="javascript">          <span class="hljs-built_in">console</span>.log(res)</span>
         if(res.success)&#123;
<span class="actionscript">           <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">'开始处理，请稍后查看处理结果'</span>);</span>
<span class="actionscript">         &#125;<span class="hljs-keyword">else</span>&#123;</span>
<span class="actionscript">           <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'操作失败，请刷新页面重试'</span>);</span>
         &#125;
        &#125;)
      &#125;,
      query()&#123;
<span class="javascript">        mediaApi.media_list(<span class="hljs-keyword">this</span>.params.page,<span class="hljs-keyword">this</span>.params.size,<span class="hljs-keyword">this</span>.params).then(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>&#123;</span>
<span class="javascript">          <span class="hljs-built_in">console</span>.log(res)</span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.total = res.queryResult.total</span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.list = res.queryResult.list</span>
        &#125;)
      &#125;
    &#125;,

<span class="actionscript">    <span class="hljs-comment">//页面初始化完成前钩子</span></span>
    created()&#123;
<span class="actionscript">        <span class="hljs-comment">//默认第一页</span></span>
<span class="javascript">      <span class="hljs-keyword">this</span>.params.page = <span class="hljs-built_in">Number</span>.parseInt(<span class="hljs-keyword">this</span>.$route.query.page||<span class="hljs-number">1</span>);</span>
    &#125;,
<span class="actionscript">    <span class="hljs-comment">//页面初始化加载前的钩子</span></span>
    mounted() &#123;
<span class="actionscript">      <span class="hljs-comment">//默认查询页面</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.query()</span>
<span class="actionscript">      <span class="hljs-comment">//初始化处理状态</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.processStatusList = [</span>
        &#123;
<span class="actionscript">          id:<span class="hljs-string">''</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'全部'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303001'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'处理中'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303002'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'处理成功'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303003'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'处理失败'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303004'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'无需处理'</span></span>
        &#125;
      ]
    &#125;
  &#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></code></pre></div>

<h2 id="3-保存视频信息"><a href="#3-保存视频信息" class="headerlink" title="3. 保存视频信息"></a>3. 保存视频信息</h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h3><p>用户进入课程计划页面，选择视频，将课程计划与视频信息保存在课程管理数据库中。</p>
<p>用户操作流程：</p>
<p>1、进入课程计划，点击”选择视频“，打开我的媒资查询页面</p>
<p>2、为课程计划选择对应的视频，选择“选择”</p>
<p>3、前端请求课程管理服务保存课程计划与视频信息</p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>在课程管理数据库创建表 <code>teachplan_media</code> 存储课程计划与媒资关联信息，如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image14" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image14.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>创建 <code>teachplanMedia</code> 模型类：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table</span>(name=<span class="hljs-string">"teachplan_media"</span>)
<span class="hljs-meta">@GenericGenerator</span>(name = <span class="hljs-string">"jpa‐assigned"</span>, strategy = <span class="hljs-string">"assigned"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TeachplanMedia</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = ‐<span class="hljs-number">916357110051689485L</span>;
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue</span>(generator = <span class="hljs-string">"jpa‐assigned"</span>)
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"teachplan_id"</span>)
    <span class="hljs-keyword">private</span> String teachplanId;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_id"</span>)
    <span class="hljs-keyword">private</span> String mediaId;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_fileoriginalname"</span>)
    <span class="hljs-keyword">private</span> String mediaFileOriginalName;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_url"</span>)
    <span class="hljs-keyword">private</span> String mediaUrl;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"courseid"</span>)
    <span class="hljs-keyword">private</span> String courseId;
&#125;</code></pre></div>

<h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><p>此接口作为前端请求课程管理服务保存课程计划与视频信息的接口：</p>
<p>在 <code>TeachplanControllerApi</code> 增加接口：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"保存媒资信息"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveTeachplanMedia</span><span class="hljs-params">(TeachplanMedia teachplanMedia)</span></span>;</code></pre></div>

<h3 id="服务端开发"><a href="#服务端开发" class="headerlink" title="服务端开发"></a>服务端开发</h3><h4 id="1、Controller"><a href="#1、Controller" class="headerlink" title="1、Controller"></a>1、Controller</h4><p>在 <code>TeachplanController</code> 下添加该方法</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/savemedia"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveTeachplanMedia</span><span class="hljs-params">(@RequestBody TeachplanMedia teachplanMedia)</span> </span>&#123;
    <span class="hljs-keyword">return</span> teachplanService.saveTeachplanMedia(teachplanMedia);
&#125;</code></pre></div>

<h4 id="2、Dao"><a href="#2、Dao" class="headerlink" title="2、Dao"></a>2、Dao</h4><p>创建 <code>TeachplanMediaRepository</code> 用于对 <code>TeachplanMedia</code> 的操作。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TeachplanMediaRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">TeachplanMedia</span>, <span class="hljs-title">String</span>&gt; </span>&#123;&#125;</code></pre></div>

<h4 id="3、Service"><a href="#3、Service" class="headerlink" title="3、Service"></a>3、Service</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//保存媒资信息public ResponseResult saveTeachplanMedia(TeachplanMedia teachplanMedia) &#123;    if(teachplanMedia == null)&#123;        ExceptionCast.cast(CommonCode.INVALIDPARAM);    &#125;     //课程计划        String teachplanId = teachplanMedia.getTeachplanId();    //查询课程计划    Optional&lt;Teachplan&gt; optional = teachplanRepository.findById(teachplanId);    if(!optional.isPresent())&#123;        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_ISNULL);    &#125; Teachplan teachplan = optional.get();    //只允许为叶子结点课程计划选择视频    String grade = teachplan.getGrade();    if(StringUtils.isEmpty(grade) || !grade.equals("3"))&#123;        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_GRADEERROR);    &#125;     TeachplanMedia one = null;    Optional&lt;TeachplanMedia&gt; teachplanMediaOptional =        teachplanMediaRepository.findById(teachplanId);    if(!teachplanMediaOptional.isPresent())&#123;        one = new TeachplanMedia();    &#125;else&#123;        one = teachplanMediaOptional.get();    &#125;     //保存媒资信息与课程计划信息    one.setTeachplanId(teachplanId);    one.setCourseId(teachplanMedia.getCourseId());    one.setMediaFileOriginalName(teachplanMedia.getMediaFileOriginalName());    one.setMediaId(teachplanMedia.getMediaId());    one.setMediaUrl(teachplanMedia.getMediaUrl());    teachplanMediaRepository.save(one);    return new ResponseResult(CommonCode.SUCCESS);&#125;//保存媒资信息</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveTeachplanMedia</span><span class="hljs-params">(TeachplanMedia teachplanMedia)</span> </span>&#123;
    <span class="hljs-keyword">if</span>(teachplanMedia == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CommonCode.INVALIDPARAM);
    &#125; 
    <span class="hljs-comment">//课程计划</span>
        String teachplanId = teachplanMedia.getTeachplanId();
    <span class="hljs-comment">//查询课程计划</span>
    Optional&lt;Teachplan&gt; optional = teachplanRepository.findById(teachplanId);
    <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_ISNULL);
    &#125; Teachplan teachplan = optional.get();
    <span class="hljs-comment">//只允许为叶子结点课程计划选择视频</span>
    String grade = teachplan.getGrade();
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(grade) || !grade.equals(<span class="hljs-string">"3"</span>))&#123;
        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_GRADEERROR);
    &#125; 
    TeachplanMedia one = <span class="hljs-keyword">null</span>;
    Optional&lt;TeachplanMedia&gt; teachplanMediaOptional =
        teachplanMediaRepository.findById(teachplanId);
    <span class="hljs-keyword">if</span>(!teachplanMediaOptional.isPresent())&#123;
        one = <span class="hljs-keyword">new</span> TeachplanMedia();
    &#125;<span class="hljs-keyword">else</span>&#123;
        one = teachplanMediaOptional.get();
    &#125; 
    <span class="hljs-comment">//保存媒资信息与课程计划信息</span>
    one.setTeachplanId(teachplanId);
    one.setCourseId(teachplanMedia.getCourseId());
    one.setMediaFileOriginalName(teachplanMedia.getMediaFileOriginalName());
    one.setMediaId(teachplanMedia.getMediaId());
    one.setMediaUrl(teachplanMedia.getMediaUrl());
    teachplanMediaRepository.save(one);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
&#125;</code></pre></div>

<h3 id="前端开发"><a href="#前端开发" class="headerlink" title="前端开发"></a>前端开发</h3><h4 id="1、API方法"><a href="#1、API方法" class="headerlink" title="1、API方法"></a>1、API方法</h4><div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/*保存媒资信息*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> savemedia = <span class="hljs-function"><span class="hljs-params">teachplanMedia</span> =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/course/savemedia'</span>,teachplanMedia);
&#125;</code></pre></div>

<h4 id="2、API调用"><a href="#2、API调用" class="headerlink" title="2、API调用"></a>2、API调用</h4><p>在课程视频方法中调用 <code>api</code>：</p>
<div class="hljs"><pre><code class="hljs java">choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
    <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-keyword">false</span>;
    <span class="hljs-comment">//保存课程计划与视频对应关系</span>
    let teachplanMedia = &#123;&#125;;
    teachplanMedia.teachplanId = <span class="hljs-keyword">this</span>.activeTeachplanId;
    teachplanMedia.mediaId = mediaId;
    teachplanMedia.mediaFileOriginalName = fileOriginalName;
    teachplanMedia.mediaUrl = mediaUrl;
    teachplanMedia.courseId = <span class="hljs-keyword">this</span>.courseid;
    <span class="hljs-comment">//保存媒资信息到课程数据库</span>
    courseApi.savemedia(teachplanMedia).then(res=&gt;&#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"选择视频成功"</span>)
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.$message.error(res.message)
        &#125;
    &#125;)
&#125;,</code></pre></div>

<h4 id="3、测试"><a href="#3、测试" class="headerlink" title="3、测试"></a>3、测试</h4><p>1、向叶子结点课程计划保存媒资信息</p>
<p>操作结果：保存成功</p>
<p>2、向非叶子结点课程计划保存媒资信息</p>
<p>操作结果：保存失败</p>
<h2 id="4-查询视频信息"><a href="#4-查询视频信息" class="headerlink" title="4. 查询视频信息"></a>4. 查询视频信息</h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p>课程计划的视频信息保存后在页面无法查看，本节解决课程计划页面显示相关联的媒资信息。</p>
<p>解决方案：</p>
<p>在获取课程计划树结点信息时将关联的媒资信息一并查询，并在前端显示，下图说明了课程计划显示的区域。</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image15" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image15.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="Dao-1"><a href="#Dao-1" class="headerlink" title="Dao"></a>Dao</h3><p>修改课程计划查询的 <code>Dao</code>:</p>
<p>1、修改模型</p>
<p>在课程计划结果信息中添加媒资信息</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.course.ext;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.Teachplan;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TeachplanNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Teachplan</span> </span>&#123;

    List&lt;TeachplanNode&gt; children;

    <span class="hljs-comment">//媒资信息</span>
    <span class="hljs-keyword">private</span> String media_id;
    <span class="hljs-keyword">private</span> String media_fileoriginalname;
&#125;</code></pre></div>

<p>2、修改<code>sql</code> 语句，添加关联查询媒资信息</p>
<p>添加 <code>mediaId</code>、<code>mediaFileOriginalName</code></p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.xuecheng.manage_course.dao.TeachplanMapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"teachplanMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
        <span class="hljs-comment">&lt;!--一级节点--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"one_id"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"one_pname"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"children"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
            <span class="hljs-comment">&lt;!--二级节点--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"two_id"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"two_pname"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"children"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
                <span class="hljs-comment">&lt;!--三级节点--&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_id"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_pname"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"media_id"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_fileoriginalname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"media_fileoriginalname"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-comment">&lt;!--三级菜单查询--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectList"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"teachplanMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.String"</span>&gt;</span>
        SELECT
            a.id one_id,
            a.pname one_pname,
            a.courseid one_course,
            b.id two_id,
            b.pname two_pname,
            c.id three_id,
            c.pname three_pname,
            media.media_id media_id,
            media.media_fileoriginalname media_fileoriginalname
        FROM
            teachplan a
        LEFT JOIN teachplan b
            ON b.parentid = a.id
        LEFT JOIN teachplan c
            ON c.parentid = b.id
        LEFT JOIN teachplan_media media
            ON c.id = media.teachplan_id
        WHERE
            a.parentid = '0'
        <span class="hljs-comment">&lt;!--判断参数不为空时才进行参数的匹配--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"_parameter!=null and _parameter!=''"</span>&gt;</span>
            and a.courseid = #&#123;courseId&#125;
        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        ORDER BY a.orderby,
            b.orderby,
            c.orderby
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>

<p>这里的核心代码是使用 <code>LEFT JOIN</code> 关联 <code>teachplan_media</code> 表中的数据，再获取该课程计划下的 <code>mediaId</code> 与 <code>mediaFileOriginalName</code> 代码如下</p>
<div class="hljs"><pre><code class="hljs sql">LEFT JOIN teachplan_media media ON c.id = media.teachplan_id
WHERE</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--三级节点--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_id"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_pname"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"media_id"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_fileoriginalname"</span></span></code></pre></div>

<p>使用swagger进行接口测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image16" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image16.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>从结果中成功的查询到了课程计划所关联的媒资信息。</p>
<h3 id="页面查询视频"><a href="#页面查询视频" class="headerlink" title="页面查询视频"></a>页面查询视频</h3><p>课程计划结点信息已包括媒资信息，可在页面获取信息后显示。</p>
<p>通过 <code>data.media_fileoriginalname</code> 获取媒资视频的原始名称</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font‐size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on</span>‐<span class="hljs-attr">click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.querymedia(data.id) &#125;&gt;
&#123;data.media_fileoriginalname&#125;<span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span>选择视频<span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span></code></pre></div>

<p>效果如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image17" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image17.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>选择视频后立即刷新课程计划树，在提交成功后，添加查询课程计划代码：<code>this.findTeachplan()</code>，完整代码如下：</p>
<div class="hljs"><pre><code class="hljs js">choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
    <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-literal">false</span>;
    <span class="hljs-comment">//保存课程计划与视频对应关系</span>
    <span class="hljs-keyword">let</span> teachplanMedia = &#123;&#125;;
    teachplanMedia.teachplanId = <span class="hljs-keyword">this</span>.activeTeachplanId;
    teachplanMedia.mediaId = mediaId;
    teachplanMedia.mediaFileOriginalName = fileOriginalName;
    teachplanMedia.mediaUrl = mediaUrl;
    teachplanMedia.courseId = <span class="hljs-keyword">this</span>.courseid;

    <span class="hljs-comment">//保存媒资信息到课程数据库</span>
    courseApi.savemedia(teachplanMedia).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"选择视频成功"</span>)
            <span class="hljs-comment">//查询课程计划</span>
            <span class="hljs-keyword">this</span>.findTeachplan()
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.$message.error(res.message)
        &#125;
    &#125;)
&#125;,</code></pre></div>


            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/RabbitMQ/">RabbitMQ</a>
                    
                      <a class="hover-with-bg" href="/tags/FFmpeg/">FFmpeg</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线day15：媒资管理系统集成</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday13/">
                        <span class="hidden-mobile">学成在线day13：使用FFmpeg进行格式转换以及m3u8文件生成、文件分块上传接口实现</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

代码块js 用不到，fulid自带有，添加css样式即可实现
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键字</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "本站已经勉强运行&nbsp"+dnum+"&nbsp天";
      document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证20000725号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20000725"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备20000725号</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "学成在线day14：媒资管理&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
