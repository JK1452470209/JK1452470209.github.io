<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>学成在线day09：Eureka、Feign、课程预览实现 - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>私人博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                主页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-16 21:06">
      2020-08-16
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      102
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="😎知识点概览"><a href="#😎知识点概览" class="headerlink" title="😎知识点概览"></a>😎知识点概览</h1><blockquote>
<p>为了方便后续回顾该项目时能够清晰的知道本章节讲了哪些内容，并且能够从该章节的笔记中得到一些帮助，所以在完成本章节的学习后在此对本章节所涉及到的知识点进行总结概述。</p>
</blockquote>
<p>本章节为【学成在线】项目的 <code>day09</code> 的内容</p>
<ul>
<li>构建基于 <code>Eureka</code> 的服务注册中心</li>
<li><code>Ribbon</code> 的基本使用，以及使用 <code>Ribbon</code> 来进行服务间的负载均衡调用</li>
<li>使用 <code>Feign</code> 实现服务之间的远程调用</li>
<li>课程预览功能开发</li>
</ul>
<h1 id="一、Eureka-注册中心"><a href="#一、Eureka-注册中心" class="headerlink" title="一、Eureka 注册中心"></a>一、Eureka 注册中心</h1><h2 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>在前后端分离架构中，服务层被拆分成了很多的微服务，微服务的信息如何管理？Spring Cloud中提供服务注册中心来管理微服务信息。</p>
<p><strong>为什么 要用注册中心？</strong></p>
<p>1、微服务数量众多，要进行远程调用就需要知道服务端的 <code>ip</code> 地址和端口，注册中心帮助我们管理这些服务的 <code>ip</code> 和端口。</p>
<p>2、微服务会实时上报自己的状态，注册中心统一管理这些微服务的状态，将存在问题的服务踢出服务列表，客户端获取到可用的服务进行调用。</p>
<h2 id="2-Eureka介绍"><a href="#2-Eureka介绍" class="headerlink" title="2. Eureka介绍"></a>2. Eureka介绍</h2><p><code>Spring Cloud Eureka</code> 是对 <code>Netflix</code> 公司的 <code>Eureka</code> 的二次封装，它实现了服务治理的功能，<code>Spring Cloud Eureka</code> 提供服务端与客户端，服务端即是 <code>Eureka</code> 服务注册中心，客户端完成微服务向 <code>Eureka</code> 服务的注册与发现。服务端和客户端均采用Java语言编写。下图显示了 <code>Eureka Server</code> 与 <code>Eureka Client</code> 的关系：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image1" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image1.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>1、<code>Eureka Server</code> 是服务端，负责管理各各微服务结点的信息和状态。</p>
<p>2 、在微服务上部署 <code>Eureka Client</code> 程序，远程访问 <code>Eureka Server</code> 将自己注册在 <code>Eureka Server</code>。</p>
<p>3、微服务需要调用另一个微服务时从 <code>Eureka Server</code> 中获取服务调用地址，进行远程调用。</p>
<h2 id="3-Eureka-Server搭建"><a href="#3-Eureka-Server搭建" class="headerlink" title="3. Eureka Server搭建"></a>3. Eureka Server搭建</h2><h3 id="1、单机环境搭建"><a href="#1、单机环境搭建" class="headerlink" title="1、单机环境搭建"></a>1、单机环境搭建</h3><p><strong>1）创建 xc-govern-center 工程：</strong></p>
<p>包结构：com.xuecheng.govern.center</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image2" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image2.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><strong>2）添加依赖</strong></p>
<p>在父工程添加：（有了则不用重复添加）</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre></div>

<p><strong>3）启动类</strong></p>
<div class="hljs"><pre><code class="hljs javascript">package com.xuecheng.govern.center;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;

@EnableEurekaServer  <span class="hljs-comment">//标识这是一个EurekaServer</span>
@SpringBootApplication
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GorvernCenterApplication</span> </span>&#123;
    public <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-built_in">String</span>[] args) &#123;
        SpringApplication.run(GorvernCenterApplication.class,args);
    &#125;
&#125;</code></pre></div>

<blockquote>
<p>需要在启动类上用 <code>@EnableEurekaServer</code> 标识此服务为Eureka服务</p>
</blockquote>
<p><strong>4）配置文件</strong></p>
<p>从其它服务拷贝 <code>application.yml</code> 和 <code>logback-spring.xml</code>。</p>
<p>application.yml 的配置内容如下：</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
 <span class="hljs-attr">port:</span> <span class="hljs-number">50101</span> <span class="hljs-comment">#服务端口</span>
<span class="hljs-attr">spring:</span>
 <span class="hljs-attr">application:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">xc-govern-center</span> <span class="hljs-comment">#指定服务名</span>
<span class="hljs-attr">eureka:</span>
 <span class="hljs-attr">client:</span>
  <span class="hljs-attr">registerWithEureka:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#服务注册，是否将自己注册到Eureka服务中</span>
  <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#服务发现，是否从Eureka中获取注册信息</span>
  <span class="hljs-attr">serviceUrl:</span> <span class="hljs-comment">#Eureka客户端与Eureka服务端的交互地址，高可用状态配置对方的地址，单机状态配置自己（如果不配置则默认本机8761端口）</span>
   <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:50101/eureka/</span>
 <span class="hljs-attr">server:</span>
  <span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否开启自我保护模式</span>
  <span class="hljs-attr">eviction-interval-timer-in-ms:</span> <span class="hljs-number">60000</span> <span class="hljs-comment">#服务注册表清理间隔（单位毫秒，默认是60*1000）</span></code></pre></div>

<ul>
<li><code>registerWithEureka</code>：被其它服务调用时需向Eureka注册</li>
<li><code>fetchRegistry</code>：需要从Eureka中查找要调用的目标服务时需要设置为true</li>
<li><code>enable-self-preservation</code>：自保护设置，下边有介绍。</li>
<li><code>eviction-interval-timer-in-ms</code>：清理失效结点的间隔，在这个时间段内如果没有收到该结点的上报则将结点从服务列表中剔除。</li>
</ul>
<p><strong>5）启动Eureka Server</strong></p>
<p>启动Eureka Server，浏览50101端口。</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image3" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image3.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>说明：</p>
<p>上图红色提示信息：<br><code>THE SELF PRESERVATION MODE IS TURNED OFF.THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OFNETWORK/OTHER PROBLEMS.</code></p>
<p>自我保护模式被关闭。在网络或其他问题的情况下可能不会保护实例失效。</p>
<p><code>Eureka Server</code> 有一种自我保护模式，当微服务不再向 <code>Eureka Server</code> 上报状态，<code>Eureka Server</code> 会从服务列表将此服务删除，如果出现网络异常情况（微服务正常），此时 <code>Eureka server</code> 进入自保护模式，不再将微服务从服务列表删除。</p>
<p>在开发阶段建议关闭自保护模式。</p>
<p>详细的参考资料：<a href="https://www.cnblogs.com/xishuai/p/spring-cloud-eureka-safe.html" target="_blank" rel="noopener">https://www.cnblogs.com/xishuai/p/spring-cloud-eureka-safe.html</a></p>
<h3 id="2、高可用环境配置"><a href="#2、高可用环境配置" class="headerlink" title="2、高可用环境配置"></a>2、高可用环境配置</h3><p><code>Eureka Server</code> 高可用环境需要部署两个 <code>Eureka server</code>，它们互相向对方注册。如果在本机启动两个 <code>Eureka</code> 需要注意两个 <code>Eureka Server</code> 的端口要设置不一样，这里我们部署一个 <code>Eureka Server</code> 工程，将端口可配置，制作两个 <code>Eureka Server</code> 启动脚本，启动不同的端口，如下图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image4" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image4.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>1、在实际使用时 <code>Eureka Server</code> 至少部署两台服务器，实现高可用。</p>
<p>2、两台 <code>Eureka Server</code> 互相注册。</p>
<p>3、微服务需要连接两台 <code>Eureka Server</code> 注册，当其中一台 <code>Eureka</code> 死掉也不会影响服务的注册与发现。</p>
<p>4、微服务会定时向 <code>Eureka server</code> 发送心跳，报告自己的状态。</p>
<p>5、微服务从注册中心获取服务地址以 <code>RESTful</code> 方式发起远程调用。</p>
<p>配置如下:</p>
<p><strong>1、端口配置加入变量</strong></p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
    <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;PORT:50101&#125;</span> <span class="hljs-comment">#服务端口</span></code></pre></div>

<p><strong>2、在 Eureka 服务端的地址加入变量</strong></p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
      <span class="hljs-attr">registerWithEureka:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务注册，是否将自己注册到Eureka服务中</span>
      <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务发现，是否从Eureka中获取注册信息</span>
      <span class="hljs-attr">serviceUrl:</span> <span class="hljs-comment">#Eureka客户端与Eureka服务端的交互地址，高可用状态配置对方的地址，单机状态配置自己（如果不配置则默认本机8761端口）</span>
        <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">$&#123;EUREKA_SERVER:http://eureka02:50102/eureka/&#125;</span></code></pre></div>

<p><strong>3、 配置 hostname</strong></p>
<p><code>Eureka</code> 组成高可用，两个<code>Eureka</code> 互相向对方注册，这里需要通过域名或主机名访问，这里我们设置两个 <code>Eureka</code> 服务的主机名分别为 <code>eureka01</code>、<code>eureka02</code>。</p>
<p>完整配置如下</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
      <span class="hljs-attr">registerWithEureka:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务注册，是否将自己注册到Eureka服务中</span>
      <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务发现，是否从Eureka中获取注册信息</span>
      <span class="hljs-attr">serviceUrl:</span> <span class="hljs-comment">#Eureka客户端与Eureka服务端的交互地址，高可用状态配置对方的地址，单机状态配置自己（如果不配置则默认本机8761端口）</span>
        <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">$&#123;EUREKA_SERVER:http://eureka02:50102/eureka/&#125;</span>
  <span class="hljs-attr">server:</span>
        <span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否开启自我保护模式</span>
        <span class="hljs-attr">eviction-interval-timer-in-ms:</span> <span class="hljs-number">60000</span> <span class="hljs-comment">#服务注册表清理间隔（单位毫秒，默认是6）0*1000</span>
  <span class="hljs-attr">instance:</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">$&#123;EUREKA_DOMAIN:eureka01&#125;</span></code></pre></div>

<p>注意这里的 <code>eureka01</code>、<code>eureka02</code> 的域名，在开放环境中，我们需要在hosts 文件中增加相应的映射：</p>
<div class="hljs"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span> eureka01
<span class="hljs-number">127.0.0.1</span> eureka02</code></pre></div>

<p><strong>4、在IDEA中制作启动脚本</strong></p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image5" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image5.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>运行两个启动脚本，分别浏览：</p>
<p><a href="http://localhost:50101/" target="_blank" rel="noopener">http://localhost:50101/</a><br><a href="http://localhost:50102/" target="_blank" rel="noopener">http://localhost:50102/</a></p>
<p>Eureka 主画面如下：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image6" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image6.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="0x04-服务注册"><a href="#0x04-服务注册" class="headerlink" title="0x04 服务注册"></a>0x04 服务注册</h2><p><strong>1、将 cms 注册到 Eureka Server</strong></p>
<p>1）在 cms 服务中添加依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 导入Eureka客户端的依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p>2）在 <code>application.yml</code> 中进行配置</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span>
  <span class="hljs-attr">client:</span>
      <span class="hljs-attr">registerWithEureka:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务注册开关</span>
      <span class="hljs-attr">fetchRegistry:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#服务发现开关</span>
      <span class="hljs-attr">serviceUrl:</span> <span class="hljs-comment">#Eureka客户端与Eureka服务端进行交互的地址，多个中间用逗号分隔</span>
        <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">$&#123;EUREKA_SERVER:http://eureka01:50101/eureka/,http://eureka02:50102/eureka/&#125;,</span>
  <span class="hljs-attr">instance:</span>
      <span class="hljs-attr">prefer-ip-address:</span>  <span class="hljs-literal">true</span>  <span class="hljs-comment">#将自己的ip地址注册到Eureka服务中</span>
      <span class="hljs-attr">ip-address:</span> <span class="hljs-string">$&#123;IP_ADDRESS:127.0.0.1&#125;</span>
      <span class="hljs-attr">instance-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;:$&#123;server.port&#125;</span> <span class="hljs-comment">#指定实例id</span></code></pre></div>

<p>3）在启动类上添加注解 <code>@EnableDiscoveryClient</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EntityScan</span>(<span class="hljs-string">"com.xuecheng.framework.domain.cms"</span>) <span class="hljs-comment">//扫描公共的实体类</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages = &#123;<span class="hljs-string">"com.xuecheng.api"</span>&#125;) <span class="hljs-comment">//扫描接口</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages = &#123;<span class="hljs-string">"com.xuecheng.manage_cms"</span>&#125;)  <span class="hljs-comment">// 扫描本项目下的所有类</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages = &#123;<span class="hljs-string">"com.xuecheng.framework"</span>&#125;)  <span class="hljs-comment">// 扫描framework</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ManageCmsApplication</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;
        SpringApplication.run(ManageCmsApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>,<span class="hljs-title">args</span>)</span>;
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate(<span class="hljs-keyword">new</span> OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;</code></pre></div>

<p>4）刷新 Eureka Server 查看注册情况</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image7" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image7.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><strong>2、注册 course 服务</strong></p>
<p>方法同上。</p>
<p>1、在 <code>manage-course</code> 工程中添加 <code>spring-cloud-starter-eureka</code> 依赖：</p>
<p>2、在 <code>application.yml</code> 配置 <code>eureka</code></p>
<p>3、在启动类上添加注解 <code>@EnableDiscoveryClient</code></p>
<h1 id="二、Feign-远程调用"><a href="#二、Feign-远程调用" class="headerlink" title="二、Feign 远程调用"></a>二、Feign 远程调用</h1><p>在前后端分离架构中，服务层被拆分成了很多的微服务，服务与服务之间难免发生交互，比如：</p>
<p>课程发布需要调用 <code>CMS</code> 服务生成课程静态化页面，本节研究微服务远程调用所使用的技术。</p>
<p>下图是课程管理服务远程调用 <code>CMS</code> 服务的流程图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image8" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image8.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>工作流程如下：</p>
<p>1 、<code>cms</code> 服务将自己注册到注册中心。</p>
<p>2、课程管理服务从注册中心获取 <code>cms</code> 服务的地址。</p>
<p>3、课程管理服务远程调用 <code>cms</code> 服务。</p>
<p>Feign的实现是基于 <code>Ribbon</code> 的，所以在介绍 Feign 的使用之前，我们先来了解一下 Ribbon， 以便能更深刻的理解 <code>Feign</code>。</p>
<h2 id="1-Ribbon-简介"><a href="#1-Ribbon-简介" class="headerlink" title="1. Ribbon 简介"></a>1. Ribbon 简介</h2><p><code>Ribbon</code> 是 <code>Netflix</code> 公司开源的一个负载均衡的项目，它是一个基于 HTTP、TCP的 <strong>客户端负载均衡器</strong>。</p>
<p><code>Ribbon</code> 的开源地址：<a href="https://github.com/Netflix/ribbon" target="_blank" rel="noopener">https://github.com/Netflix/ribbon</a></p>
<p><strong>1、什么是负载均衡？</strong></p>
<p>负载均衡是 微服务架构 中必须使用的技术，通过 负载均衡 来实现系统的 高可用、集群扩容 等功能。负载均衡 可通过 硬件设备 及 软件 来实现，硬件比如：<code>F5</code>、<code>Array</code> 等，软件比如：LVS、<code>Nginx</code> 等。</p>
<p>如下图是负载均衡的架构图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image9" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image9.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>用户请求先到达负载均衡器（也相当于一个服务），负载均衡器根据负载均衡算法将请求转发到微服务。负载均衡算法有：<code>轮训</code>、<code>随机</code>、<code>加权轮训</code>、<code>加权随机</code>、<code>地址哈希</code> 等方法，负载均衡器维护一份服务列表，根据负载均衡算法将请求转发到相应的微服务上。所以负载均衡可以为微服务集群分担请求，降低系统的压力。</p>
<p><strong>2、什么是客户端负载均衡？</strong></p>
<p>上图是 <code>服务端 负载均衡</code>，<code>客户端负载均衡</code> 与 <code>服务端负载均衡</code> 的区别在于 <strong>客户端</strong> 要维护一份服务列表，<code>Ribbon</code> 从 <code>Eureka Server</code> 获取服务列表，<code>Ribbon</code> 根据负载均衡算法直接请求到具体的微服务，中间省去了负载均衡服务。如下图是 <code>Ribbon</code> 负载均衡的流程图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image10" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image10.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>1、在消费微服务中使用 <code>Ribbon</code> 实现负载均衡，<code>Ribbon</code> 先从 <code>EurekaServer</code> 中获取服务列表。</p>
<p>2、<code>Ribbon</code> 根据负载均衡的算法去调用微服务。</p>
<h2 id="2-Ribbon-的基本使用"><a href="#2-Ribbon-的基本使用" class="headerlink" title="2. Ribbon 的基本使用"></a>2. Ribbon 的基本使用</h2><p>Spring Cloud 引入<code>Ribbon</code> 配合 <code>restTemplate</code> 实现客户端负载均衡。Java中远程调用的技术有很多，如：webservice、socket、rmi、Apache HttpClient、OkHttp 等，互联网项目使用基于 <code>http</code> 的客户端较多，本项目使用 <code>OkHttp</code>。</p>
<p><strong>1、在客户端添加Ribbon依赖：</strong></p>
<p>这里在 课程管理服务 配置 <code>ribbon</code> 依赖</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--导入ribbon依赖--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p>由于依赖了 <code>spring-cloud-starter-eureka</code>，会自动添加 <code>spring-cloud-starter-ribbon</code> 依赖</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image11" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image11.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><strong>2、配置 Ribbbon 参数</strong></p>
<p>这里在课程管理服务的 <code>application.yml</code> 中配置 <code>ribbon</code> 参数</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">ribbon:</span>
  <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">2</span> <span class="hljs-comment">#最大重试次数，当Eureka中可以找到服务，但是服务连不上时将会重试</span>
  <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">3</span> <span class="hljs-comment">#切换实例的重试次数</span>
  <span class="hljs-attr">OkToRetryOnAllOperations:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">#对所有操作请求都进行重试，如果是get则可以，如果是post，put等操作没有实现幂等的情况下是很危险的,所以设置为false</span>
  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">5000</span>  <span class="hljs-comment">#请求连接的超时时间</span>
  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">6000</span> <span class="hljs-comment">#请求处理的超时时间</span></code></pre></div>

<p><strong>3、负载均衡测试</strong></p>
<p>1）启动两个 <code>cms</code> 服务，注意端口要不一致</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;PORT:31001&#125;</span></code></pre></div>

<p><a href="https://qnoss.codeyee.com/20200704_9/image12" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image12.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>启动完成观察 <code>Eureka Server</code> 的服务列表</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image13" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image13.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2）定义 <code>RestTemplate</code>，使用 <code>@LoadBalanced</code> 注解</p>
<p>在课程管理服务的启动类中定义 <code>RestTemplate</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EntityScan</span>(<span class="hljs-string">"com.xuecheng.framework.domain.course"</span>)<span class="hljs-comment">//扫描实体类</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.api"</span>&#125;)<span class="hljs-comment">//扫描接口</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.manage_course"</span>&#125;)
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.framework"</span>&#125;)<span class="hljs-comment">//扫描common下的所有类</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ManageCourseApplication</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        SpringApplication.run(ManageCourseApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@LoadBalanced</span> <span class="hljs-comment">//开启ribbon负载均衡拦截器</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate(<span class="hljs-keyword">new</span> OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;</code></pre></div>

<p>3 ）测试代码</p>
<p>在课程管理服务工程创建单元测试代码，远程调用cms的查询页面接口：</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@RunWith</span>(SpringRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">TestRibbon</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    RestTemplate restTemplate;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testRibbon</span><span class="hljs-params">()</span></span>&#123;
        String serviceId = <span class="hljs-string">"xc-service-manage-cms"</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;
            ResponseEntity&lt;Map&gt; forEntity = restTemplate.getForEntity(<span class="hljs-string">"http://"</span> + serviceId + <span class="hljs-string">"/cms/page/get/5a795ac7dd573c04508f3a56"</span>, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
            Map body = forEntity.getBody();
            System.out.println(body);
        &#125;
    &#125;
&#125;</code></pre></div>

<p>4）负载均衡测试</p>
<p>添加 <code>@LoadBalanced</code> 注解后，<code>restTemplate</code> 会走 <code>LoadBalancerInterceptor</code> 拦截器，此拦截器中会通过 <code>RibbonLoadBalancerClient</code> 查询服务地址，可以在此类打断点观察每次调用的服务地址和端口，两个 <code>cms</code> 服务会轮流被调用。</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image14" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image14.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-Feign"><a href="#3-Feign" class="headerlink" title="3. Feign"></a>3. Feign</h2><h3 id="1、Fegin-介绍"><a href="#1、Fegin-介绍" class="headerlink" title="1、Fegin 介绍"></a>1、Fegin 介绍</h3><p><code>Feign</code>是 <code>Netflix</code> 公司开源的轻量级 <code>rest</code> <strong>客户端</strong>，使用 <code>Feign</code> 可以非常方便的实现<code>Http</code> 客户端。Spring Cloud 引入 <code>Feign</code> 并且集成了 <code>Ribbon</code> 实现客户端负载均衡调用。</p>
<h3 id="2、Feign-测试"><a href="#2、Feign-测试" class="headerlink" title="2、Feign 测试"></a>2、Feign 测试</h3><p><strong>1 、在客户端添加依赖</strong></p>
<p>在 课程管理服务 添加下边的依赖：</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--feign相关依赖--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.netflix.feign<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>feign-okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<p><strong>2、定义 FeignClient 接口</strong></p>
<p>参考 <code>Swagger</code> 文档定义<code>FeignClient</code>，注意接口的 <code>Url</code>、请求参数类型、返回值类型与<code>Swagger</code> 接口一致。在课程管理服务中创建 <code>client</code>包，定义查询 <code>cms</code> 页面的客户端的接口</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_course.client;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.cms.response.CmsPageResult;
<span class="hljs-keyword">import</span> org.springframework.cloud.openfeign.FeignClient;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;


<span class="hljs-meta">@FeignClient</span>(value = <span class="hljs-string">"XC-SERVICE-MANAGE-CMS"</span>)
<span class="hljs-comment">//这里可以将所有服务做成一个枚举列表</span>
<span class="hljs-comment">//@FeignClient(value = XcServiceList.XC_SERVICE_MANAGE_CMS)</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CmsPageClient</span> </span>&#123;
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/cms/page/get/&#123;id&#125;"</span>)
    <span class="hljs-comment">//这里我在CmsPage接口定义的返回类型为 CmsPageResult 类型,所以远程调用接口这里也要接收 CmsPageResult 类型</span>
    <span class="hljs-function">CmsPageResult <span class="hljs-title">findById</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> String id)</span>;
&#125;</code></pre></div>

<p><strong>3、启动类添加@EnableFeignClients注解</strong></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients</span>  <span class="hljs-comment">//开启Feign远程调用功能</span>
<span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EntityScan</span>(<span class="hljs-string">"com.xuecheng.framework.domain.course"</span>)<span class="hljs-comment">//扫描实体类</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.api"</span>&#125;)<span class="hljs-comment">//扫描接口</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.manage_course"</span>&#125;)
<span class="hljs-meta">@ComponentScan</span>(basePackages=&#123;<span class="hljs-string">"com.xuecheng.framework"</span>&#125;)<span class="hljs-comment">//扫描common下的所有类</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ManageCourseApplication</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        SpringApplication.run(ManageCourseApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;
    &#125;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@LoadBalanced</span> <span class="hljs-comment">//开启ribbon负载均衡拦截器</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title">restTemplate</span><span class="hljs-params">()</span></span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestTemplate(<span class="hljs-keyword">new</span> OkHttp3ClientHttpRequestFactory());
    &#125;
&#125;</code></pre></div>

<p>4、<strong>测试</strong></p>
<p>创建一个单元测试</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@RunWith</span>(SpringRunner<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>
<span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">TestFeign</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    CmsPageClient cmsPageClient;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testFeign</span><span class="hljs-params">()</span></span>&#123;
        CmsPageResult byId = cmsPageClient.findById(<span class="hljs-string">"5a795ac7dd573c04508f3a56"</span>);
        System.out.println(byId.getCmsPage());
    &#125;
&#125;</code></pre></div>

<p>运行测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image15" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image15.png" srcset="/img/loading.gif" alt="img"></a></p>
<p><strong>Feign 工作原理如下：</strong></p>
<p>1、 启动类添加 <code>@EnableFeignClients</code> 注解，<code>Spring</code>会扫描标记了<code>@FeignClient</code> 注解的接口，并生成此接口的代理对象</p>
<p>2、 <code>@FeignClient(value = XcServiceList.XC_SERVICE_MANAGE_CMS)</code> 即指定了 <code>cms</code> 的服务名称，<code>Feign</code> 会从注册中心获取 <code>cms</code> 服务列表，并通过负载均衡算法进行服务调用。</p>
<p>3、在接口方法 中使用注解 <code>@GetMapping(&quot;/cms/page/get/{id}&quot;)</code>，指定调用的<code>url</code>，<code>Feign</code> 将根据 <code>url</code> 进行远程调用。</p>
<h3 id="3、使用-Feign-有哪些需要注意的地方？"><a href="#3、使用-Feign-有哪些需要注意的地方？" class="headerlink" title="3、使用 Feign 有哪些需要注意的地方？"></a>3、使用 Feign 有哪些需要注意的地方？</h3><p>SpringCloud 对 <code>Feign</code> 进行了增强兼容了 <code>SpringMVC</code> 的注解 ，我们在使用 <code>SpringMVC</code> 的注解时需要注意：</p>
<p>1、FeignClient 接口 有参数在参数必须加 <code>@PathVariable(&quot;XXX&quot;)</code> 和 <code>@RequestParam(&quot;XXX&quot;)</code></p>
<p>2、FeignClient 返回值为复杂对象时其类型必须有无参构造函数。</p>
<h1 id="三、课程预览技术方案"><a href="#三、课程预览技术方案" class="headerlink" title="三、课程预览技术方案"></a>三、课程预览技术方案</h1><h2 id="1-需求分析-1"><a href="#1-需求分析-1" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p><strong>课程预览</strong> 是为了保证课程发布后的 <strong>正确性</strong>，通过课程预览可以直观的通过 <strong>课程详情页面</strong> 看到课程的信息是否正确，通过 课程预览 看到的页面内容 和 课程发布后的页面 内容是一致的。</p>
<p>下图是课程详情页面的预览图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image16" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image16.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="2-课程详细页面-技术方案"><a href="#2-课程详细页面-技术方案" class="headerlink" title="2. 课程详细页面 技术方案"></a>2. 课程详细页面 技术方案</h2><h3 id="1、技术需求"><a href="#1、技术需求" class="headerlink" title="1、技术需求"></a>1、技术需求</h3><p>课程详情页面是向用户展示课程信息的窗口，课程相当于网站的 <strong>商品</strong>，本页面的访问量会非常大。此页面的内容设计不仅要展示出课程 <strong>核心重要的内容</strong> 而且用户访问页面的 <strong>速度要有保证</strong>，有统计显示打开一个页面超过4秒用户就走掉了，所以本页面的性能要求是本页面的重要需求。</p>
<p>本页面另一个需求就是 <code>SEO</code>，要非常有利于爬虫抓取页面上信息，并且生成页面快照，利于用户通过搜索引擎搜索课程信息。</p>
<h3 id="2、解决方案"><a href="#2、解决方案" class="headerlink" title="2、解决方案"></a>2、解决方案</h3><p>那么如何在保证 <code>SEO</code> 的前提下提高页面的访问速度？</p>
<p><strong>方案1：</strong></p>
<p>对于信息获取类的需求，要想提高页面速度就要使用 <strong>缓存</strong> 来减少或避免对数据库的访问，从而提高页面的访问速度。下图是使用缓存与不使用缓存的区别</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image17" target="_blank" rel="noopener"><img src="https://qnoss.codeyee.com/20200704_9/image17" srcset="/img/loading.gif" alt="img"></a></p>
<p>此页面为动态页面，会根据课程的不同而不同，方案一采用传统的 <code>JavaEE Servlet/jsp</code> 的方式在 <code>Tomcat</code> 完成页面渲染，相比不加缓存速度会有提升。</p>
<p>优点：使用 <code>redis</code> 作为缓存，速度有提升。</p>
<p>缺点：采用 <code>Servlet/jsp</code> 动态页面渲染技术，服务器使用 <code>Tomcat</code>，面对高并发量的访问存在性能瓶颈。</p>
<p><strong>方案2：</strong></p>
<p>对于不会频繁改变的信息可以采用 <strong>页面静态化</strong> 的技术，提前让页面生成 <code>html</code> 静态页面存储在<code>nginx</code> 服务器，用户直接访问 <code>nginx</code> 即可，对于一些动态信息可以访问服务端获取 <code>json</code>数据在页面渲染。</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image18" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image18.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>优点：使用 <code>Nginx</code> 作为 <code>web</code> 服务器，并且直接访问 <code>html</code> 页面，性能出色。</p>
<p>缺点：需要维护大量的静态页面，增加了维护的难度。</p>
<p>这里我们选择 <strong>方案2</strong> 作为课程详情页面的技术解决方案，将课程详情页面生成 <code>Html</code> 静态化页面，并发布到 <code>Nginx</code> 上。</p>
<h2 id="3-课程预览技术-解决方案"><a href="#3-课程预览技术-解决方案" class="headerlink" title="3. 课程预览技术 解决方案"></a>3. 课程预览技术 解决方案</h2><p>根据要求：课程详情页面采用静态化技术生成 <code>Html</code> 页面，课程预览的效果要与最终静态化的<code>Html</code> 页面内容一致。所以，课程预览功能也采用静态化技术生成 <code>Html</code> 页面，课程预览使用的模板与课程详情页面模板一致，这样就可以保证课程预览的效果与最终课程详情页面的效果一致。</p>
<p><strong>操作流程：</strong></p>
<p>1、制作课程详情页面模板</p>
<p>2、开发课程详情页面数据模型的查询接口（为静态化提供数据）</p>
<p>3、调用cms课程预览接口通过浏览器浏览静态文件</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image19" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image19.png" srcset="/img/loading.gif" alt="img"></a></p>
<h1 id="四、课程详细页面静态化"><a href="#四、课程详细页面静态化" class="headerlink" title="四、课程详细页面静态化"></a>四、课程详细页面静态化</h1><h2 id="1-静态页面测试"><a href="#1-静态页面测试" class="headerlink" title="1. 静态页面测试"></a>1. 静态页面测试</h2><h3 id="1、页面内容组成"><a href="#1、页面内容组成" class="headerlink" title="1、页面内容组成"></a>1、页面内容组成</h3><p>我们在编写一个页面时需要知道哪些信息是静态信息，哪些信息为动态信息，下图是页面的设计图：</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image20" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image20.png" srcset="/img/loading.gif" alt="img"></a></p>
<ul>
<li>打开静态页面，观察每部分的内容。</li>
<li>红色表示动态信息，红色以外表示静态信息。</li>
<li>红色动态信息：表示一个按钮，根据用户的登录状态、课程的购买状态显示按钮的名称及按钮的事件。</li>
</ul>
<p>包括以下信息内容：</p>
<p><strong>1、课程信息</strong><br>课程标题、价格、课程等级、授课模式、课程图片、课程介绍、课程目录。</p>
<p><strong>2、课程统计信息</strong><br>课程时长、评分、收藏人数</p>
<p><strong>3、教育机构信息</strong><br>公司名称、公司简介</p>
<p><strong>4、教育机构统计信息</strong><br>好评数、课程数、学生人数</p>
<p><strong>5、教师信息</strong><br>老师名称、老师介绍</p>
<h3 id="2、页面拆分"><a href="#2、页面拆分" class="headerlink" title="2、页面拆分"></a>2、页面拆分</h3><ol>
<li><p>本页头文件和门户使用的页头为同一个文件。<br>参考：<code>代码\页面与模板\include\header.html</code></p>
</li>
<li><p>页面尾<br>本页尾文件和门户使用的页尾为同一个文件。<br>参考：<code>代码\页面与模板\include\footer.html</code></p>
</li>
<li><p>课程详情主页面<br>每个课程对应一个文件，命名规则为：<code>课程id.html</code>（课程id动态变化）<br>模板页面参考：<code>\代码\页面与模板\course\detail\course_main_template.html</code></p>
</li>
<li><p>教育机构页面<br>每个教育机构对应一个文件，文件的命名规则为：<code>company_info_公司id.html</code>（公司id动态变化）<br>参考：<code>代码\页面与模板\company\company_info_template.html</code></p>
</li>
<li><p>老师信息页面<br>每个教师信息对应一个文件，文件的命名规则为：<code>teacher_info_教师id.html</code>（教师id动态变化）</p>
<p>参考：<code>代码 \页面与模板\teacher\teacher_info_template01.html</code></p>
</li>
<li><p>课程统计页面<br>每个课程对应一个文件，文件的命名规则为：<code>course_stat_课程id.json</code>（课程id动态变化）<br>参考：<code>\代码\页面与模板\stat\course\course_stat_template.json</code></p>
</li>
<li><p>教育机构统计页面<br>每个教育机构对应一个文件，文件的命名规则为：<code>company_stat_公司id.json</code>（公司id动态变化）<br>参考：<code>\代码\页面与模板\stat\company\company_stat_template.json</code></p>
</li>
</ol>
<h3 id="3、页面测试"><a href="#3、页面测试" class="headerlink" title="3、页面测试"></a>3、页面测试</h3><h4 id="1）页面加载思路"><a href="#1）页面加载思路" class="headerlink" title="1）页面加载思路"></a>1）页面加载思路</h4><p>打开课程资料中的 “静态页面目录” 中的课程详情模板页面，研究页面加载的思路。</p>
<p>模板页面路径如下：</p>
<div class="hljs"><pre><code class="hljs html">静态页面目录\static\course\detail\course_main_template.html</code></pre></div>

<ul>
<li><p>主页面</p>
<p>我们需要在主页面中通过SSI加载：页头、页尾、教育机构、教师信息</p>
</li>
<li><p>异步加载课程统计与教育机构统计信息</p>
<p>课程统计信息（json）、教育机构统计信息（json）</p>
</li>
<li><p>马上学习按钮事件</p>
<p>用户点击“马上学习”会根据课程收费情况、课程购买情况执行下一步操作。</p>
</li>
</ul>
<h4 id="2）静态资源虚拟主机"><a href="#2）静态资源虚拟主机" class="headerlink" title="2）静态资源虚拟主机"></a>2）静态资源虚拟主机</h4><p>静态资源虚拟主机负责处理课程详情、公司信息、老师信息、统计信息等页面的请求：</p>
<p>将课程资料中的 “<strong>静态页面目录</strong>” 中的目录拷贝到 <code>F:/develop/xuecheng/static</code> 下</p>
<p>在nginx中配置静态虚拟主机如下：</p>
<div class="hljs"><pre><code class="hljs c">#学成网静态资源
server &#123;
	<span class="hljs-built_in">listen</span>       <span class="hljs-number">91</span>;    
	server_name localhost;    
	#公司信息    
	location /<span class="hljs-keyword">static</span>/company/ &#123;      
		alias  G:/job/code/Project/XueChengOnline/xcEduUI01/xuecheng/<span class="hljs-keyword">static</span>/company/; 
	&#125;
	#老师信息    
	location /<span class="hljs-keyword">static</span>/teacher/ &#123;      
		alias G:/job/code/Project/XueChengOnline/xcEduUI01/xuecheng/<span class="hljs-keyword">static</span>/teacher/;        
	&#125;     
	#统计信息    
	location /<span class="hljs-keyword">static</span>/stat/ &#123;      
		alias G:/job/code/Project/XueChengOnline/xcEduUI01/xuecheng/<span class="hljs-keyword">static</span>/stat/;        
	&#125;     
	location /course/detail/ &#123;      
		alias G:/job/code/Project/XueChengOnline/xcEduUI01/xuecheng/<span class="hljs-keyword">static</span>/course/detail/;        
	&#125;     
&#125;</code></pre></div>

<p><strong>通过 <a href="http://www.xuecheng.com" target="_blank" rel="noopener">www.xuecheng.com</a> 虚拟主机转发到静态资源</strong></p>
<p>由于课程页面需要通过SSI加载页头和页尾所以需要通过 <code>www.xuecheng.com</code> 虚拟主机转发到静态资源<br>在 <code>www.xuecheng.com</code> 虚拟主机加入如下配置：</p>
<div class="hljs"><pre><code class="hljs c">#静态页面资源
location /<span class="hljs-keyword">static</span>/company/ &#123; 
    proxy_pass http:<span class="hljs-comment">//static_server_pool;        </span>
&#125;     
location /<span class="hljs-keyword">static</span>/teacher/ &#123;      
    proxy_pass http:<span class="hljs-comment">//static_server_pool;        </span>
&#125;     
location /<span class="hljs-keyword">static</span>/stat/ &#123;      
    proxy_pass http:<span class="hljs-comment">//static_server_pool;        </span>
&#125;     
location /course/detail/ &#123;      
    proxy_pass http:<span class="hljs-comment">//static_server_pool;        </span>
&#125;</code></pre></div>

<p>配置 <code>upstream</code> 实现请求转发到资源服务虚拟主机：</p>
<div class="hljs"><pre><code class="hljs c">#静态资源服务
upstream static_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">91</span> weight=<span class="hljs-number">10</span>;
&#125;</code></pre></div>

<h4 id="3）门户静态资源路径"><a href="#3）门户静态资源路径" class="headerlink" title="3）门户静态资源路径"></a>3）门户静态资源路径</h4><p>门户中的一些图片、样式等静态资源统一通过 <code>/static</code> 路径对外提供服务，在 <code>www.xuecheng.com</code> 虚拟主机中配置如下：</p>
<div class="hljs"><pre><code class="hljs c">#静态资源，包括系统所需要的图片，js、css等静态资源    
location /<span class="hljs-keyword">static</span>/img/ &#123;      
    alias   G:/job/code/Project/XueChengOnline/xcEduUI01/xc-ui-pc-<span class="hljs-keyword">static</span>-portal/img/;        
&#125;
location /<span class="hljs-keyword">static</span>/css/ &#123;      
    alias   G:/job/code/Project/XueChengOnline/xcEduUI01/xc-ui-pc-<span class="hljs-keyword">static</span>-portal/css/;        
&#125;     
location /<span class="hljs-keyword">static</span>/js/ &#123;      
    alias   G:/job/code/Project/XueChengOnline/xcEduUI01/xc-ui-pc-<span class="hljs-keyword">static</span>-portal/js/;        
&#125;     
location /<span class="hljs-keyword">static</span>/plugins/ &#123;      
    # 跨域参数
    alias   G:/job/code/Project/XueChengOnline/xcEduUI01/xc-ui-pc-<span class="hljs-keyword">static</span>-portal/plugins/;        
    add_header Access-Control-Allow-Origin http:<span class="hljs-comment">//ucenter.xuecheng.com;          </span>
    add_header Access-Control-Allow-Credentials <span class="hljs-literal">true</span>;          
    add_header Access-Control-Allow-Methods GET;        
&#125;</code></pre></div>

<p>cors 跨域参数：</p>
<ul>
<li>Access-Control-Allow-Origin：允许跨域访问的外域地址如果允许任何站点跨域访问则设置为*，通常这是不建议的。</li>
<li>Access-Control-Allow-Credentials： 允许客户端携带证书访问</li>
<li>Access-Control-Allow-Methods：允许客户端跨域访问的方法</li>
</ul>
<h4 id="4）页面测试"><a href="#4）页面测试" class="headerlink" title="4）页面测试"></a>4）页面测试</h4><p>请求：<a href="http://www.xuecheng.com/course/detail/course_main_template.html" target="_blank" rel="noopener">http://www.xuecheng.com/course/detail/course_main_template.html</a> 测试课程详情页面模板是否可以正常浏览。</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image21" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image21.png" srcset="/img/loading.gif" alt="img"></a></p>
<h4 id="5）页面动态脚本"><a href="#5）页面动态脚本" class="headerlink" title="5）页面动态脚本"></a>5）页面动态脚本</h4><p>为了方便日后的维护，我们将 <code>javascript</code> 实现的动态部分单独编写一个 <code>html</code> 文件,在门户的 <code>include</code>目录下定义 <code>course_detail_dynamic.html</code> 文件，此文件通过 <code>ssi</code> 包含在课程详情页面中.</p>
<p>文件地址：<code>资料 \静态页面目录\include\course_detail_dynamic.html</code></p>
<p>所有的课程公用一个 页面动态脚本。</p>
<p>在课程详情主页面下端添加如下代码，通过 <code>SSI</code> 技术包含课程详情页面动态脚本文件：</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript"><span class="hljs-keyword">var</span> courseId = <span class="hljs-string">"template"</span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!--#include virtual="/include/course_detail_dynamic.html"--&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre></div>

<p>本页面使用 <code>vue.js</code> 动态获取信息，使用 vue 的 <code>created</code> 钩子函数在页面初始化前获取动态的数据，详细请阅读该文件。</p>
<h2 id="2-课程数据模型接口"><a href="#2-课程数据模型接口" class="headerlink" title="2. 课程数据模型接口"></a>2. 课程数据模型接口</h2><h3 id="1、API接口定义"><a href="#1、API接口定义" class="headerlink" title="1、API接口定义"></a>1、API接口定义</h3><p>数据模型</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.course.ext;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CourseBase;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CourseMarket;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.CoursePic;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;

<span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-comment">//Serializable ?</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseView</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    CourseBase courseBase; <span class="hljs-comment">//课程基本信息</span>
    CourseMarket courseMarket; <span class="hljs-comment">//课程营销信息</span>
    CoursePic coursePic;  <span class="hljs-comment">//课程图片</span>
    TeachplanNode teachplanNode; <span class="hljs-comment">//课程营销计划</span>
&#125;</code></pre></div>

<p>API 接口，再 <code>CourseControllerApi</code> 下定义</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"课程视图查询"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CourseView <span class="hljs-title">courseView</span><span class="hljs-params">(String courseId)</span></span>;</code></pre></div>

<h3 id="2、Dao"><a href="#2、Dao" class="headerlink" title="2、Dao"></a>2、Dao</h3><p>根据数据模型，dao 层我们可以沿用之前开发中定义的</p>
<ul>
<li><code>CourseBaseRepository</code></li>
<li><code>CourseMarketRepository</code></li>
<li><code>CoursePicRepository</code></li>
<li><code>TeachplanMapper</code></li>
</ul>
<h3 id="3、Service"><a href="#3、Service" class="headerlink" title="3、Service"></a>3、Service</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 获取课程视图数据模型</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> CourseView <span class="hljs-title">getCourseView</span><span class="hljs-params">(String courseId)</span> </span>&#123;
    CourseView courseView = <span class="hljs-keyword">new</span> CourseView();
    <span class="hljs-comment">//获取课程基本信息</span>
    Optional&lt;CourseBase&gt; courseBaseOptional = courseBaseRepository.findById(courseId);
    <span class="hljs-keyword">if</span>(courseBaseOptional.isPresent())&#123;
        CourseBase courseBase = courseBaseOptional.get();
        courseView.setCourseBase(courseBase);
    &#125;

    <span class="hljs-comment">//获取课程营销信息</span>
    CourseMarket courseMarketById = courseMarketService.findCourseMarketById(courseId);
    courseView.setCourseMarket(courseMarketById);

    <span class="hljs-comment">//获取课程图片</span>
    Optional&lt;CoursePic&gt; coursePicOptional = coursePicRepository.findById(courseId);
    <span class="hljs-keyword">if</span>(coursePicOptional.isPresent())&#123;
        CoursePic coursePic = coursePicOptional.get();
        courseView.setCoursePic(coursePic);
    &#125;

    <span class="hljs-comment">//获取课程计划</span>
    TeachplanNode teachplanNode = teachplanMapper.selectList(courseId);
    courseView.setTeachplanNode(teachplanNode);
    <span class="hljs-keyword">return</span> courseView;
&#125;</code></pre></div>

<h3 id="4、Controller"><a href="#4、Controller" class="headerlink" title="4、Controller"></a>4、Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 课程预览数据模型查询</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/Courseview/&#123;id&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CourseView <span class="hljs-title">courseView</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"id"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.getCourseView(courseId);
&#125;</code></pre></div>

<h3 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h3><p>在 Swagger 中测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image22" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image22.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="3-课程信息模板设计"><a href="#3-课程信息模板设计" class="headerlink" title="3. 课程信息模板设计"></a>3. 课程信息模板设计</h2><p>在确定了静态化所需要的数据模型之后，就可以编写页面模板了，课程详情页面由多个静态化页面组成，所以我们<br>需要创建多个页面模板，本章节创建课程详情页面的主模板，即课程信息模板。</p>
<h3 id="1、模板内容"><a href="#1、模板内容" class="headerlink" title="1、模板内容"></a>1、模板内容</h3><p>完整的模板请参考 <code>资料\课程详情页面模板\course.ftl</code> 文件，下边列出模板中核心的内容：</p>
<ul>
<li><p>课程基本信息</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"banner-left"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tit"</span>&gt;</span>$&#123;courseBase.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pic"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"new-pic"</span>&gt;</span>特惠价格￥$&#123;courseMarket.price&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">span</span></span>
<span class="hljs-tag">                                                                                 <span class="hljs-attr">class</span>=<span class="hljs-string">"old-pic"</span>&gt;</span>原价￥$&#123;courseMarket.price_old!&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://ucenter.xuecheng.com/#/learning/$&#123;courseBase.id&#125;/0"</span> </span>
<span class="hljs-tag">           <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"learnstatus == 1"</span> <span class="hljs-attr">v-cloak</span>&gt;</span>马上学习<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>  @<span class="hljs-attr">click</span>=<span class="hljs-string">"addopencourse"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"learnstatus == 2"</span> <span class="hljs-attr">v-cloak</span>&gt;</span>立即报名<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>  @<span class="hljs-attr">click</span>=<span class="hljs-string">"buy"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"learnstatus == 3"</span> <span class="hljs-attr">v-cloak</span>&gt;</span>立即购买<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>难度等级<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">courseBase.grade</span>==<span class="hljs-string">'200001'</span>&gt;</span>        
                低级        
                <span class="hljs-tag">&lt;<span class="hljs-name">#elseif</span> <span class="hljs-attr">courseBase.grade</span>==<span class="hljs-string">'200002'</span>&gt;</span>
                    中级        
                    <span class="hljs-tag">&lt;<span class="hljs-name">#elseif</span> <span class="hljs-attr">courseBase.grade</span>==<span class="hljs-string">'200003'</span>&gt;</span>        
                        高级        
                        <span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span>        
                    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>课程时长<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">stat</span> <span class="hljs-attr">v-text</span>=<span class="hljs-string">"course_stat.s601001"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">stat</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>评分<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">stat</span> <span class="hljs-attr">v-text</span>=<span class="hljs-string">"course_stat.s601002"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">stat</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>授课模式<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">courseBase.studymodel</span>==<span class="hljs-string">'201001'</span>&gt;</span>
                        自由学习        
                        <span class="hljs-tag">&lt;<span class="hljs-name">#elseif</span> <span class="hljs-attr">courseBase.studymodel</span>==<span class="hljs-string">'201002'</span>&gt;</span>
                            任务式学习        
                            <span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span> 
                        <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"banner-rit"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">coursePic.pic</span>??&gt;</span>    
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://img.xuecheng.com/$&#123;coursePic.pic&#125;"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"270"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"156"</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

                    <span class="hljs-tag">&lt;<span class="hljs-name">#else</span>&gt;</span>    
                        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/img/widget-video.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"270"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"156"</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>        
                        <span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span>    

                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vid-act"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-heart"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>收藏 <span class="hljs-tag">&lt;<span class="hljs-name">stat</span> <span class="hljs-attr">v-</span></span>
<span class="hljs-tag">                                                                              <span class="hljs-attr">text</span>=<span class="hljs-string">"course_stat.s601003"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">stat</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>分享 <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-weixin"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-qq"</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre></div>
</li>
<li><p>课程计划</p>
</li>
</ul>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">#if</span> <span class="hljs-attr">teachplanNode.children</span>??&gt;</span>            
        <span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">teachplanNode.children</span> <span class="hljs-attr">as</span> <span class="hljs-attr">firstNode</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title act"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-chevron-top"</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>$&#123;firstNode.pname&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"about"</span>&gt;</span>$&#123;firstNode.description!&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"drop-down"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"height: $&#123;firstNode.children?</span></span>
<span class="hljs-tag"><span class="hljs-string">                                              size * 50&#125;px;"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list-box"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">#list</span> <span class="hljs-attr">firstNode.children</span> <span class="hljs-attr">as</span> <span class="hljs-attr">secondNode</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>$&#123;secondNode.pname&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">#list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">#if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre></div>

<ul>
<li>页头引入</li>
</ul>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">data-spy</span>=<span class="hljs-string">"scroll"</span> <span class="hljs-attr">data-target</span>=<span class="hljs-string">"#articleNavbar"</span> <span class="hljs-attr">data-offset</span>=<span class="hljs-string">"150"</span>&gt;</span> 
<span class="hljs-comment">&lt;!-- 页面头部 --&gt;</span>
<span class="hljs-comment">&lt;!--#include virtual="/include/header.html"--&gt;</span></code></pre></div>

<ul>
<li>页尾引入</li>
</ul>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--  页面底部 --&gt;</span>
<span class="hljs-comment">&lt;!--底部版权--&gt;</span>
<span class="hljs-comment">&lt;!--#include virtual="/include/footer.html"--&gt;</span></code></pre></div>

<ul>
<li>动态脚本文件引入</li>
</ul>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span> 
<span class="actionscript">    <span class="hljs-comment">//课程id</span></span>
<span class="actionscript">    <span class="hljs-keyword">var</span> courseId = <span class="hljs-string">"template"</span></span>
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!--#include virtual="/include/course_detail_dynamic.html"--&gt;</span></code></pre></div>

<ul>
<li><p>教师信息</p>
<p>从课程数据中获取课程所属的教师Id，这里由于教师信息管理功能没有开发我们使用固定的教师信息文件</p>
</li>
</ul>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-com course"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"title"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>课程制作<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!--#include virtual="/teacher/teacher_info_template01.html"--&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre></div>

<ul>
<li><p>教育机构文件</p>
<p>同教师信息一样，由于教育机构功能模块没有开发，这里我们使用固定的教育机构文件</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"about-teach"</span>&gt;</span> 
    <span class="hljs-comment">&lt;!--机构信息--&gt;</span>
    <span class="hljs-comment">&lt;!--#include virtual="/company/company_info_template.html"--&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre></div>

</li>
</ul>
<h3 id="2、模板测试"><a href="#2、模板测试" class="headerlink" title="2、模板测试"></a>2、模板测试</h3><p>使用test-freemarker工程测试模板</p>
<p>编写模板过程采用test-freemarker工程测试模板。</p>
<p>将 <code>course.ftl</code> 拷贝到 <code>test-freemarker</code> 工程的 <code>resources/templates</code> 下，并在 <code>test-freemarker</code> 工程的<code>controller</code> 中加测试方法。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//课程详情页面测试</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/course"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">course</span><span class="hljs-params">(Map&lt;String,Object&gt; map)</span></span>&#123;
    ResponseEntity&lt;Map&gt; forEntity =
restTemplate.getForEntity(<span class="hljs-string">"http://localhost:31200/course/courseview/4028e581617f945f01617f9dabc40000"</span>, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Map body = forEntity.getBody();
    map.put(<span class="hljs-string">"model"</span>,body);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"course"</span>;
&#125;</code></pre></div>

<p>注意：上边的测试页面不显示样式，原因是页面通过 <code>SSI</code> 包含了页面头，而使用 <code>test-freemarker</code> 工程无法加载页头，测试模板主要查看 <code>html</code> 页面内容是否正确，待课程预览时解决样式不显示问题。</p>
<h3 id="3、模板保存"><a href="#3、模板保存" class="headerlink" title="3、模板保存"></a>3、模板保存</h3><p>模板编写并测试通过后要在数据库保存：</p>
<p>1、模板信息保存在 <code>xc_cms</code> 数据库(mongodb)的 <code>cms_template</code>表<br>2、模板文件保存在 <code>mongodb</code> 的 <code>GridFS</code> 中。</p>
<p>这里我们在 <code>cms</code> 服务的单元测试中进行保存。</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//存文件</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGridFs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException </span>&#123;
    <span class="hljs-comment">//要储存的文件</span>
    File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"d:/resources/course.ftl"</span>);
    <span class="hljs-comment">//定义输入流</span>
    FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(file);
    <span class="hljs-comment">//向GridFS存储文件</span>
    ObjectId objectId = gridFsTemplate.store(fileInputStream, <span class="hljs-string">"index-banner"</span>);
    <span class="hljs-comment">//得到文件ID</span>
    String fileId = objectId.toString();
    System.out.println(fileId);

&#125;</code></pre></div>

<p>保存成功需要记录模板文件的id，即上边代码中的fileId。</p>
<p>第二步：向 <code>cms_template</code> 表添加模板记录（请不要重复添加）</p>
<p>使用 <code>Studio 3T</code> 连接<code>mongodb</code>，向 <code>cms_template</code> 添加记录：</p>
<div class="hljs"><pre><code class="hljs json">&#123;
  <span class="hljs-attr">"_class"</span> : <span class="hljs-string">"com.xuecheng.framework.domain.cms.CmsTemplate"</span>,
  <span class="hljs-attr">"siteId"</span> : <span class="hljs-string">"5a751fab6abb5044e0d19ea1"</span>,
  <span class="hljs-attr">"templateName"</span> : <span class="hljs-string">"课程详情页面正式模板"</span>,
  <span class="hljs-attr">"templateFileId"</span> : <span class="hljs-string">"5e93d284cc53e43424beea42"</span>
&#125;</code></pre></div>

<h3 id="4、其他模板"><a href="#4、其他模板" class="headerlink" title="4、其他模板"></a>4、其他模板</h3><p>除了课程详情主页面需要设计模板所有静态化的页面都要设计模板，如下：</p>
<p><code>教育机构页面模板</code>、<code>教师信息页面模板</code>、<code>课程统计信息json模板</code>、<code>教育机构统计信息json模板</code>。</p>
<p>本项目我们实现课程详情主页面模板的制作和测试，其它页面模板的开发参考课程详情页面去实现。</p>
<h1 id="五、课程预览功能开发"><a href="#五、课程预览功能开发" class="headerlink" title="五、课程预览功能开发"></a>五、课程预览功能开发</h1><h2 id="1-需求分析-2"><a href="#1-需求分析-2" class="headerlink" title="1. 需求分析"></a>1. 需求分析</h2><p>课程预览功能将使用 <code>cms</code> 系统提供的页面预览功能，业务流程如下：</p>
<p>1、用户进入课程管理页面，点击课程预览，请求到课程管理服务</p>
<p>2、课程管理服务远程调用 <code>cms</code> 添加页面接口向 <code>cms</code> 添加课程详情页面</p>
<p>3、课程管理服务得到 <code>cms</code> 返回课程详情页面 <code>id</code>，并拼接生成课程预览 <code>Url</code></p>
<p>4、课程管理服务将课程预览 <code>Url</code> 给前端返回</p>
<p>5、用户在前端页面请求课程预览 <code>Url</code> ，打开新窗口显示课程详情内容</p>
<h2 id="2-CMS页面预览测试"><a href="#2-CMS页面预览测试" class="headerlink" title="2. CMS页面预览测试"></a>2. CMS页面预览测试</h2><p><code>CMS</code> 服务已经提供了页面预览功能，课程预览功能要使用 <code>CMS</code> 页面预览接口实现，下边通过 <code>cms</code> 页面预览接口测试课程预览的效果。</p>
<p><strong>1、向 cms_page 表插入一条页面记录或者从 cms_page 找一个页面进行测试。</strong></p>
<p>注意：页面配置一定要正确，需设置正确的模板 <code>id</code> 和 <code>dataUrl</code>。</p>
<p>如下，是一条页面的记录。</p>
<div class="hljs"><pre><code class="hljs json">&#123; 
    <span class="hljs-attr">"_id"</span> : ObjectId(<span class="hljs-string">"5b3469f794db44269cb2bff1"</span>), 
    <span class="hljs-attr">"_class"</span> : <span class="hljs-string">"com.xuecheng.framework.domain.cms.CmsPage"</span>, 
    <span class="hljs-attr">"siteId"</span> : <span class="hljs-string">"5a751fab6abb5044e0d19ea1"</span>, 
    <span class="hljs-attr">"pageName"</span> : <span class="hljs-string">"4028e581617f945f01617f9dabc40000.html"</span>, 
    <span class="hljs-attr">"pageAliase"</span> : <span class="hljs-string">"bootstrip课程详情页面"</span>, 
    <span class="hljs-attr">"pageWebPath"</span> : <span class="hljs-string">"/course/detail/"</span>, 
    <span class="hljs-attr">"pagePhysicalPath"</span> : <span class="hljs-string">"/course/detail/"</span>, 
    <span class="hljs-attr">"pageType"</span> : <span class="hljs-string">"1"</span>, 
    <span class="hljs-attr">"pageCreateTime"</span> : ISODate(<span class="hljs-string">"2018-02-03T05:37:53.256+0000"</span>), 
    <span class="hljs-attr">"templateId"</span> : <span class="hljs-string">"5e93d2e3d79e7d6ed1009b95"</span>, 
    <span class="hljs-attr">"dataUrl"</span> : <span class="hljs-string">"http://localhost:31200/course/courseview/4028e581617f945f01617f9dabc40000"</span>
&#125;</code></pre></div>

<p><strong>2、课程详细页面 使用 ssi 注意</strong></p>
<p>由于 <code>Nginx</code> 先请求 <code>cms</code> 的课程预览功能得到 <code>html</code> 页面，再解析页面中的 <code>ssi</code> 标签，这里必须保证 <code>cms</code> 页面预览返回的页面的 <code>Content-Type</code> 为 <code>text/html;charset=utf-8</code></p>
<p>在 <code>cms</code> 页面预览的 <code>controller</code> 方法中添加：</p>
<div class="hljs"><pre><code class="hljs html">response.setHeader("Content-type","text/html;charset=utf-8");</code></pre></div>

<p><strong>3、测试</strong></p>
<p>请求：<a href="http://www.xuecheng.com/cms/preview/5b3469f794db44269cb2bff1%E4%BC%A0%E5%85%A5%E9%A1%B5%E9%9D%A2" target="_blank" rel="noopener">http://www.xuecheng.com/cms/preview/5b3469f794db44269cb2bff1传入页面</a> Id，测试效果如下:</p>
<h2 id="3-CMS添加页面接口"><a href="#3-CMS添加页面接口" class="headerlink" title="3. CMS添加页面接口"></a>3. CMS添加页面接口</h2><p>在之前进行 <code>cms</code> 服务的开发中，已经开发有页面添加的接口，为什么还要重新写一个？</p>
<p>因为每次进行课程预览都需要进行页面添加的操作，如果页面已经存在则不需要重复添加，只需要执行更新操作即可。</p>
<p>所以这里我们在 cms服务中 实现一个 <code>save</code> 接口：如果不存在页面则添加，否则就更新页面信息。</p>
<h3 id="1、API-接口"><a href="#1、API-接口" class="headerlink" title="1、API 接口"></a>1、API 接口</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 保存页面数据</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"保存页面数据"</span>)
<span class="hljs-meta">@ApiImplicitParams</span>(&#123;
        <span class="hljs-meta">@ApiImplicitParam</span>(name=<span class="hljs-string">"cmsPage"</span>,value = <span class="hljs-string">"请提交json形式的页面数据"</span>,required=<span class="hljs-keyword">true</span>,paramType=<span class="hljs-string">"CmsPage"</span>,dataType=<span class="hljs-string">"CmsPage"</span>),
&#125;)
<span class="hljs-function"><span class="hljs-keyword">public</span> CmsPageResult <span class="hljs-title">saveCmsPage</span><span class="hljs-params">(CmsPage cmsPage)</span></span>;</code></pre></div>

<h3 id="2、Service"><a href="#2、Service" class="headerlink" title="2、Service"></a>2、Service</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 保存页面：如果不存在则添加，存在则更新。</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> cmsPage</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> CmsPageResult <span class="hljs-title">saveCmsPage</span><span class="hljs-params">(CmsPage cmsPage)</span> </span>&#123;
    <span class="hljs-comment">//效验cmsPage是否为空</span>
    <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-comment">//抛出异常，非法参数</span>
        ExceptionCast.cast(CommonCode.INVALID_PARAM);
    &#125;

    <span class="hljs-comment">//验证数据唯一性：sizeId、pageName、pageWebPath</span>
    CmsPage one = cmsPageRepository.findByPageNameAndSiteIdAndPageWebPath(cmsPage.getPageName(), cmsPage.getSiteId(), cmsPage.getPageWebPath());

    <span class="hljs-comment">//如果页面已存在则进行更新操作</span>
    <span class="hljs-keyword">if</span> (cmsPage1 != <span class="hljs-keyword">null</span>) &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.updateCmsPage(one.getPageId(),one);
    &#125;
    <span class="hljs-comment">//不存在则直接添加</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.addCmsPage(cmsPage);
&#125;</code></pre></div>

<h3 id="3、Controller"><a href="#3、Controller" class="headerlink" title="3、Controller"></a>3、Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 保存页面</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> cmsPage</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/save"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CmsPageResult <span class="hljs-title">saveCmsPage</span><span class="hljs-params">(CmsPage cmsPage)</span> </span>&#123;
    <span class="hljs-keyword">return</span> pageService.saveCmsPage(cmsPage);
&#125;</code></pre></div>

<h2 id="4-课程预览服务端"><a href="#4-课程预览服务端" class="headerlink" title="4. 课程预览服务端"></a>4. 课程预览服务端</h2><h3 id="1、API-定义"><a href="#1、API-定义" class="headerlink" title="1、API 定义"></a>1、API 定义</h3><p>此 <code>Api</code> 是课程管理前端请求服务端进行课程预览的Api</p>
<p>请求：课程 <code>Id</code></p>
<p>响应：状态码，课程预览 <code>Url</code></p>
<p>1、定义响应类型</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CoursePublishResult</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResponseResult</span> </span>&#123;
    String previewUrl;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CoursePublishResult</span><span class="hljs-params">(ResultCode resultCode, String previewUrl)</span> </span>&#123;
        <span class="hljs-keyword">super</span>(resultCode);
        <span class="hljs-keyword">this</span>.previewUrl = previewUrl;
    &#125;
&#125;</code></pre></div>

<p>2、接口定义如下</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"课程发布预览"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CoursePublishResult <span class="hljs-title">CoursePublishPreview</span><span class="hljs-params">(String courseId)</span></span>;</code></pre></div>

<h3 id="2、创建-Feign-Client"><a href="#2、创建-Feign-Client" class="headerlink" title="2、创建 Feign Client"></a>2、创建 Feign Client</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/cms/page/save"</span>)
<span class="hljs-function">CmsPageResult <span class="hljs-title">saveCmsPage</span><span class="hljs-params">(@RequestBody CmsPage cmsPage)</span></span>;</code></pre></div>

<h3 id="3、Service-1"><a href="#3、Service-1" class="headerlink" title="3、Service"></a>3、Service</h3><div class="hljs"><pre><code class="hljs java"> <span class="hljs-comment">//从配置文件获取课程发布的基本配置</span>
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;course-publish.dataUrlPre&#125;"</span>)
<span class="hljs-keyword">private</span> String publish_dataUrlPre;
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;course-publish.pagePhysicalPath&#125;"</span>)
<span class="hljs-keyword">private</span> String publish_page_physicalpath;
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;course-publish.pageWebPath&#125;"</span>)
<span class="hljs-keyword">private</span> String publish_page_webpath;
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;course-publish.siteId&#125;"</span>)
<span class="hljs-keyword">private</span> String publish_siteId;
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;course-publish.templateId&#125;"</span>)
<span class="hljs-keyword">private</span> String publish_templateId;
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;course-publish.previewUrl&#125;"</span>)
<span class="hljs-keyword">private</span> String previewUrl;

<span class="hljs-meta">@Autowired</span>
CmsPageClient cmsPageClient;

<span class="hljs-comment">//根据id查询课程基本信息</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> CourseBase <span class="hljs-title">findCourseBaseById</span><span class="hljs-params">(String courseId)</span></span>&#123;
    <span class="hljs-comment">//获取课程信息</span>
    Optional&lt;CourseBase&gt; optionalCourseBase = courseBaseRepository.findById(courseId);
    <span class="hljs-keyword">if</span>(!optionalCourseBase.isPresent())&#123;
        <span class="hljs-comment">//课程不存在抛出异常</span>
        ExceptionCast.cast(CourseCode.COURSE_NOTEXIST);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
    <span class="hljs-keyword">return</span> optionalCourseBase.get();
&#125;
<span class="hljs-comment">/**</span>
<span class="hljs-comment"> * 课程详细页面发布前预览</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment"> */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> CoursePublishResult <span class="hljs-title">coursePublishPreview</span><span class="hljs-params">(String courseId)</span> </span>&#123;
    <span class="hljs-comment">//获取课程信息</span>
    CourseBase courseBaseById = <span class="hljs-keyword">this</span>.findCourseBaseById(courseId);

    <span class="hljs-comment">//拼装页面基本信息</span>
    CmsPage cmsPage = <span class="hljs-keyword">new</span> CmsPage();
    cmsPage.setDataUrl(publish_dataUrlPre + courseId);
    cmsPage.setPagePhysicalPath(publish_page_physicalpath);
    cmsPage.setPageWebPath(publish_page_webpath);
    cmsPage.setSiteId(publish_siteId);
    cmsPage.setTemplateId(publish_templateId);

    <span class="hljs-comment">//页面别名</span>
    cmsPage.setPageAliase(courseBaseById.getName());

    <span class="hljs-comment">//远程调用，保存页面信息</span>
    CmsPageResult cmsPageResult = cmsPageClient.saveCmsPage(cmsPage);
    <span class="hljs-keyword">if</span>(!cmsPageResult.isSuccess())&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CoursePublishResult(CommonCode.FAIL,<span class="hljs-keyword">null</span>);
    &#125;

    <span class="hljs-comment">//页面id</span>
    String cmsPageId = cmsPageResult.getCmsPage().getPageId();
    <span class="hljs-comment">//返回预览url</span>
    String url = previewUrl + cmsPageId;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CoursePublishResult(CommonCode.SUCCESS,url);
&#125;</code></pre></div>

<h3 id="4、Controller-1"><a href="#4、Controller-1" class="headerlink" title="4、Controller"></a>4、Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * 发布页面</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/postPage/&#123;pageId&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">post</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"pageId"</span>)</span> String pageId) </span>&#123;
    <span class="hljs-keyword">return</span> pageService.postPage(pageId);
&#125;</code></pre></div>

<h3 id="5、测试-1"><a href="#5、测试-1" class="headerlink" title="5、测试"></a>5、测试</h3><p>先在 course 服务中的 swagger 进行测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image23" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image23.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>得到预览url，访问测试</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image24" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image24.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>这里实际上只动态渲染了课程部分的数据，例如课程名称，课程介绍等，教师信息和公司介绍等都是静态数据，需要后期进行完善。</p>
<h2 id="5-前端开发"><a href="#5-前端开发" class="headerlink" title="5. 前端开发"></a>5. 前端开发</h2><p>1、API 方法</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/*预览课程*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> preview = <span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> &#123;
  <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/course/preview/'</span>+id);
&#125;</code></pre></div>

<p>2、页面</p>
<p>创建 <code>course_pub.vue</code></p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el‐card</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box‐card"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">slot</span>=<span class="hljs-string">"header"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"clearfix"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>课程预览<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text item"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el‐button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>  @<span class="hljs-attr">click.native</span>=<span class="hljs-string">"preview"</span> &gt;</span>课程预览<span class="hljs-tag">&lt;/<span class="hljs-name">el‐button</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v</span>‐<span class="hljs-attr">if</span>=<span class="hljs-string">"previewurl &amp;&amp; previewurl!=''"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"previewurl"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>点我查看课
程预览页面 <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el‐card</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></code></pre></div>

<p>数据对象：</p>
<div class="hljs"><pre><code class="hljs js">data() &#123; 
  <span class="hljs-keyword">return</span> &#123;
    dotype:<span class="hljs-string">''</span>,
    courseid:<span class="hljs-string">''</span>,
    course: &#123;<span class="hljs-string">"id"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"name"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"status"</span>:<span class="hljs-string">""</span>&#125;,
    previewurl:<span class="hljs-string">''</span>
  &#125;</code></pre></div>

<p>方法 ：</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">// 预览</span>
preview()&#123;
  courseApi.preview(<span class="hljs-keyword">this</span>.courseid).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">if</span>(res.success)&#123;
      <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'预览页面生成成功，请点击下方预览链接'</span>);
           <span class="hljs-keyword">if</span>(res.url)&#123; 
        <span class="hljs-comment">//预览url</span>
        <span class="hljs-keyword">this</span>.previewurl = res.url
      &#125;
    &#125;<span class="hljs-keyword">else</span>&#123;
      <span class="hljs-keyword">this</span>.$message.error(res.message);
    &#125;
  &#125;);
&#125;</code></pre></div>

<p>3、测试</p>
<p>点击预览后成功链接</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image25" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image25.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>访问预览链接</p>
<p><a href="https://qnoss.codeyee.com/20200704_9/image26" target="_blank" rel="noopener"><img src="/2020/08/16/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday09/image26.png" srcset="/img/loading.gif" alt="img"></a></p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">学成在线</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Eureka/">Eureka</a>
                    
                      <a class="hover-with-bg" href="/tags/Feign/">Feign</a>
                    
                      <a class="hover-with-bg" href="/tags/Ribbon/">Ribbon</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/17/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday10/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">学成在线day10：课程发布、ElasticSearch</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/14/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday08/">
                        <span class="hidden-mobile">学成在线day08：FastDFS实现课程图片管理</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

代码块js 用不到，fulid自带有，添加css样式即可实现
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键字</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">载入天数...</span>
  <span id="times">载入时分秒...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "本站勉强运行&nbsp"+dnum+"&nbsp天";
      document.getElementById("times").innerHTML = hnum + "&nbsp小时&nbsp" + mnum + "&nbsp分&nbsp" + snum + "&nbsp秒";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    
  <!-- 备案信息 -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">京ICP证20000725号</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20000725"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>京公网安备20000725号</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "学成在线day09：Eureka、Feign、课程预览实现&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
