<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>å­¦æˆåœ¨çº¿day18ï¼šåŸºäºoauth2å®ç°RBACè®¤è¯æˆæƒã€å¾®æœåŠ¡é—´è®¤è¯å®ç° - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ç§äººåšå®¢</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äºæˆ‘
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-28 15:56">
      2020-08-28
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      9.1k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      118
       åˆ†é’Ÿ
    </span>
  

  
  
    
      <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> æ¬¡
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ"><a href="#ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ" class="headerlink" title="ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ"></a>ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ</h1><blockquote>
<p>ä¸ºäº†æ–¹ä¾¿åç»­å›é¡¾è¯¥é¡¹ç›®æ—¶èƒ½å¤Ÿæ¸…æ™°çš„çŸ¥é“æœ¬ç« èŠ‚è®²äº†å“ªäº›å†…å®¹ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»è¯¥ç« èŠ‚çš„ç¬”è®°ä¸­å¾—åˆ°ä¸€äº›å¸®åŠ©ï¼Œæ‰€ä»¥åœ¨å®Œæˆæœ¬ç« èŠ‚çš„å­¦ä¹ ååœ¨æ­¤å¯¹æœ¬ç« èŠ‚æ‰€æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹è¿›è¡Œæ€»ç»“æ¦‚è¿°ã€‚</p>
</blockquote>
<p>æœ¬ç« èŠ‚ä¸ºã€å­¦æˆåœ¨çº¿ã€‘é¡¹ç›®çš„ <code>day18</code> çš„å†…å®¹</p>
<ul>
<li>åŸºäºæ–¹æ³•çš„æƒé™æ ¡éªŒ</li>
<li>åŸºäº <code>RBAC</code> è¿›è¡Œç”¨æˆ·æƒé™é…ç½®ä»¥åŠåŠ¨æ€æŸ¥è¯¢ã€‚</li>
<li>æ ¹æ®æ•™å¸ˆæ‰€å±çš„å…¬å¸æ¥å®ç°è¯¾ç¨‹ä¿¡æ¯æŸ¥è¯¢çš„ç»†ç²’åº¦æˆæƒã€‚ä¹Ÿå°±æ˜¯ <code>A</code> å…¬å¸çš„è€å¸ˆåªèƒ½æŸ¥è¯¢åˆ° <code>A</code> å…¬å¸ä¸‹çš„è¯¾ç¨‹ã€‚</li>
<li>ä½¿ç”¨ <code>Feign</code> æ‹¦æˆªå™¨å®ç°è·å–å‰ç«¯è¯·æ±‚ä¸­çš„ header ä¿¡æ¯ï¼Œå¹¶å°† <code>header</code> ä¸­å¸¦æœ‰çš„ jwt ä»¤ç‰Œå‘ä¸‹ä¼ é€’ï¼Œå®ç°å¾®æœåŠ¡é—´çš„è¿œç¨‹è°ƒç”¨çš„è®¤è¯æˆæƒã€‚</li>
</ul>
<h1 id="ä¸€ã€ç”¨æˆ·æˆæƒä¸šåŠ¡æµç¨‹"><a href="#ä¸€ã€ç”¨æˆ·æˆæƒä¸šåŠ¡æµç¨‹" class="headerlink" title="ä¸€ã€ç”¨æˆ·æˆæƒä¸šåŠ¡æµç¨‹"></a>ä¸€ã€ç”¨æˆ·æˆæƒä¸šåŠ¡æµç¨‹</h1><p>ç”¨æˆ·æˆæƒçš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image1.png" srcset="/img/loading.gif" alt="image-20200601102646580"></p>
<p>ä¸šåŠ¡æµç¨‹è¯´æ˜å¦‚ä¸‹ï¼š</p>
<p>1ã€ç”¨æˆ·è®¤è¯é€šè¿‡ï¼Œè®¤è¯æœåŠ¡å‘æµè§ˆå™¨ <code>cookie</code> å†™å…¥ <code>token</code>ï¼ˆ èº«ä»½ä»¤ç‰Œï¼‰</p>
<p>2ã€å‰ç«¯æºå¸¦ <code>token</code> è¯·æ±‚ç”¨æˆ·ä¸­å¿ƒæœåŠ¡è·å–jwtä»¤ç‰Œï¼Œå‰ç«¯è·å–åˆ°jwtä»¤ç‰Œè§£æï¼Œå¹¶å­˜å‚¨åœ¨<code>sessionStorage</code></p>
<p>3ã€å‰ç«¯æºå¸¦ <code>cookie</code> ä¸­çš„èº«ä»½ä»¤ç‰ŒåŠjwtä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡</p>
<p>å‰ç«¯è¯·æ±‚èµ„æºæœåŠ¡éœ€è¦æºå¸¦ä¸¤ä¸ª <code>token</code>ï¼Œä¸€ä¸ªæ˜¯ <code>cookie</code> ä¸­çš„èº«ä»½ä»¤ç‰Œï¼Œä¸€ä¸ªæ˜¯ <code>http header</code>ä¸­çš„ <code>jwt</code>ï¼Œå‰ç«¯è¯·æ±‚èµ„æºæœåŠ¡å‰åœ¨ <code>http header</code>ä¸Šæ·»åŠ  <code>jwt</code> è¯·æ±‚èµ„æº</p>
<p>4ã€ç½‘å…³æ ¡éªŒ <code>token</code> çš„åˆæ³•æ€§</p>
<p>ç”¨æˆ·è¯·æ±‚å¿…é¡»æºå¸¦èº«ä»½ä»¤ç‰Œå’Œjwtä»¤ç‰Œã€‚</p>
<p>ç½‘å…³æ ¡éªŒ <code>redis</code> ä¸­ <code>user_token</code> çš„æœ‰æ•ˆæœŸï¼Œå·²è¿‡æœŸåˆ™è¦æ±‚ç”¨æˆ·é‡æ–°ç™»å½•ã€‚</p>
<p>5ã€èµ„æºæœåŠ¡æ ¡éªŒ <code>jwt</code> çš„åˆæ³•æ€§å¹¶è¿›è¡Œæˆæƒ</p>
<p>èµ„æºæœåŠ¡æ ¡éªŒ <code>jwt</code> ä»¤ç‰Œï¼Œå®Œæˆæˆæƒï¼Œæ‹¥æœ‰æƒé™çš„æ–¹æ³•æ­£å¸¸æ‰§è¡Œï¼Œæ²¡æœ‰æƒé™çš„æ–¹æ³•å°†æ‹’ç»è®¿é—®ã€‚</p>
<h1 id="äºŒã€åŸºäºæ–¹æ³•æˆæƒ"><a href="#äºŒã€åŸºäºæ–¹æ³•æˆæƒ" class="headerlink" title="äºŒã€åŸºäºæ–¹æ³•æˆæƒ"></a>äºŒã€åŸºäºæ–¹æ³•æˆæƒ</h1><h2 id="1-éœ€æ±‚åˆ†æ"><a href="#1-éœ€æ±‚åˆ†æ" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>æ–¹æ³•æˆæƒè¦å®Œæˆçš„æ˜¯ <code>èµ„æºæœåŠ¡</code> æ ¹æ® jwt ä»¤ç‰Œå®Œæˆå¯¹æ–¹æ³•çš„æˆæƒï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ã€ç”Ÿæˆ <code>Jwt</code> ä»¤ç‰Œæ—¶åœ¨ä»¤ç‰Œä¸­å†™å…¥ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™</p>
<p>æˆ‘ä»¬ç»™æ¯ä¸ªæƒé™èµ·ä¸ªåå­—ï¼Œä¾‹å¦‚æŸä¸ªç”¨æˆ·æ‹¥æœ‰å¦‚ä¸‹æƒé™ï¼š</p>
<p>course_find_listï¼šè¯¾ç¨‹æŸ¥è¯¢</p>
<p>course_pic_listï¼šè¯¾ç¨‹å›¾ç‰‡æŸ¥è¯¢</p>
<p>2ã€åœ¨èµ„æºæœåŠ¡æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£ <code>@PreAuthorize</code>ï¼Œå¹¶æŒ‡å®šæ­¤æ–¹æ³•æ‰€éœ€è¦çš„æƒé™</p>
<blockquote>
<p>@PreAuthorize æ³¨è§£æ˜¯ç”±Spring Security æä¾›çš„ä¸€ä¸ªæƒé™æ ¡éªŒæ³¨è§£</p>
</blockquote>
<p>ä¾‹å¦‚ä¸‹è¾¹æ˜¯è¯¾ç¨‹ç®¡ç†æ¥å£æ–¹æ³•çš„æˆæƒé…ç½®ï¼Œå®ƒå°±è¡¨ç¤ºè¦æ‰§è¡Œè¿™ä¸ªæ–¹æ³•éœ€è¦æ‹¥æœ‰ <code>course_find_list</code> æƒé™ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_find_list')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResult&lt;CourseInfo&gt; <span class="hljs-title">findCourseList</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,</span>
<span class="hljs-function">                                              @<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size,</span>
<span class="hljs-function">                                              CourseListRequest courseListRequest)</span></code></pre></div>

<p>3ã€å½“è¯·æ±‚æœ‰æƒé™çš„æ–¹æ³•æ—¶æ­£å¸¸è®¿é—®</p>
<p>4ã€å½“è¯·æ±‚æ²¡æœ‰æƒé™çš„æ–¹æ³•æ—¶åˆ™æ‹’ç»è®¿é—®</p>
<h2 id="2-jwtä»¤ç‰ŒåŒ…å«æƒé™"><a href="#2-jwtä»¤ç‰ŒåŒ…å«æƒé™" class="headerlink" title="2. jwtä»¤ç‰ŒåŒ…å«æƒé™"></a>2. jwtä»¤ç‰ŒåŒ…å«æƒé™</h2><p>ä¿®æ”¹è®¤è¯æœåŠ¡çš„ <code>UserDetailServiceImpl</code> ç±»ï¼Œä¸‹è¾¹çš„ä»£ç ä¸­ <code>permissionList</code> åˆ—è¡¨ä¸­å­˜æ”¾äº†ç”¨æˆ·çš„æƒé™ï¼Œå¹¶ä¸”å°†æƒé™æ ‡è¯†æŒ‰ç…§ä¸­é—´ä½¿ç”¨é€—å·åˆ†éš”çš„è¯­æ³•ç»„æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæœ€ç»ˆæä¾›ç»™ <code>Spring security</code></p>
<p>æ ¸å¿ƒçš„ä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//æŒ‡å®šç”¨æˆ·çš„æƒé™ï¼Œè¿™é‡Œæš‚æ—¶ç¡¬ç¼–ç </span>
List&lt;String&gt; permissionList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
permissionList.add(<span class="hljs-string">"course_base_list"</span>);
permissionList.add(<span class="hljs-string">"course_pic_list"</span>);
 
<span class="hljs-comment">//å°†æƒé™ä¸²ä¸­é—´ä»¥é€—å·åˆ†éš”</span>
String user_permission_string = StringUtils.join(permissionList.toArray(), <span class="hljs-string">","</span>);
<span class="hljs-comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°userDetailså¯¹è±¡</span>
UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(
    username,
    password,
    AuthorityUtils.commaSeparatedStringToAuthorityList(user_permission_string));</code></pre></div>

<p>åœ¨ä¸Šè¿°çš„ä»£ç å½“ä¸­ï¼Œé€šè¿‡å‘ <code>permissionList</code> æ·»åŠ æ ‡è¯†æ¥å¯¹ç”¨æˆ·çš„è¿›è¡Œæˆæƒï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶å¯¹ç”¨æˆ·çš„æƒé™çš„å†…å®¹è¿›è¡Œç¡¬ç¼–ç ï¼Œåé¢çš„ç« èŠ‚ä¸­ç”¨æˆ·çš„æƒé™ä¿¡æ¯ä¼šä»æ•°æ®åº“ä¸­è·å–ã€‚</p>
<p>å…¨éƒ¨ä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;
    <span class="hljs-comment">//å–å‡ºèº«ä»½ï¼Œå¦‚æœèº«ä»½ä¸ºç©ºè¯´æ˜æ²¡æœ‰è®¤è¯</span>
    Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
    <span class="hljs-comment">//æ²¡æœ‰è®¤è¯ç»Ÿä¸€é‡‡ç”¨httpbasicè®¤è¯ï¼Œhttpbasicä¸­å­˜å‚¨äº†client_idå’Œclient_secret</span>
    <span class="hljs-comment">//å¼€å§‹è®¤è¯client_idå’Œclient_secret</span>
    <span class="hljs-keyword">if</span>(authentication==<span class="hljs-keyword">null</span>)&#123;
        ClientDetails clientDetails = clientDetailsService.loadClientByClientId(username);
        <span class="hljs-keyword">if</span>(clientDetails!=<span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-comment">//å¯†ç </span>
            String clientSecret = clientDetails.getClientSecret();
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username,clientSecret,AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">""</span>));
        &#125;
    &#125;
    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(username)) &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
 
    <span class="hljs-comment">//è¯·æ±‚ucenteræŸ¥è¯¢ç”¨æˆ·</span>
    XcUserExt userext = userClient.getUserext(username);
    <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>; <span class="hljs-comment">//å¦‚æœè·å–åˆ°çš„ç”¨ä¿¡æ¯ä¸ºç©º,åˆ™è¿”å›null,spring securityåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</span>
 
    <span class="hljs-comment">//è®¾ç½®ç”¨æˆ·çš„è®¤è¯å’Œæƒé™ä¿¡æ¯</span>
    userext.setUsername(<span class="hljs-string">"itcast"</span>);
    userext.setPassword(<span class="hljs-keyword">new</span> BCryptPasswordEncoder().encode(<span class="hljs-string">"123"</span>));
    userext.setPermissions(<span class="hljs-keyword">new</span> ArrayList&lt;XcMenu&gt;());  <span class="hljs-comment">//è¿™é‡Œæˆæƒéƒ¨åˆ†è¿˜æ²¡å®Œæˆ,æ‰€ä»¥å…ˆå¡«å†™é™æ€çš„</span>
 
    <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
 
    <span class="hljs-comment">//ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æ­£ç¡®çš„å¯†ç ï¼ŒSpring Securityä¼šå»æ¯”å¯¹è¾“å…¥å¯†ç çš„æ­£ç¡®æ€§</span>
    String password = userext.getPassword();
 
    <span class="hljs-comment">//æŒ‡å®šç”¨æˆ·çš„æƒé™ï¼Œè¿™é‡Œæš‚æ—¶ç¡¬ç¼–ç </span>
    List&lt;String&gt; permissionList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    permissionList.add(<span class="hljs-string">"course_base_list"</span>);
    permissionList.add(<span class="hljs-string">"course_pic_list"</span>);
 
    <span class="hljs-comment">//å°†æƒé™ä¸²ä¸­é—´ä»¥é€—å·åˆ†éš”</span>
    String user_permission_string = StringUtils.join(permissionList.toArray(), <span class="hljs-string">","</span>);
    <span class="hljs-comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°userDetailså¯¹è±¡</span>
    UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(
        username,
        password,
        AuthorityUtils.commaSeparatedStringToAuthorityList(user_permission_string));
    <span class="hljs-comment">//ç”¨æˆ·id</span>
    userDetails.setId(userext.getId());
    <span class="hljs-comment">//ç”¨æˆ·åç§°</span>
    userDetails.setName(userext.getName());
    <span class="hljs-comment">//ç”¨æˆ·å¤´åƒ</span>
    userDetails.setUserpic(userext.getUserpic());
    <span class="hljs-comment">//ç”¨æˆ·æ‰€å±ä¼ä¸šid</span>
    userDetails.setCompanyId(userext.getCompanyId());
 
    <span class="hljs-comment">//è¿”å›ç”¨ä¿¡æ¯ç»™åˆ°Spring Securityè¿›è¡Œå¤„ç†</span>
    <span class="hljs-keyword">return</span> userDetails;
&#125;</code></pre></div>

<p>é‡å¯è®¤è¯æœåŠ¡å·¥ç¨‹ï¼Œä½¿ç”¨ <code>postman</code> å®Œæˆç™»å½•ï¼Œè·å–åˆ°ç”¨æˆ·ä»¤ç‰Œ</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image2.png" srcset="/img/loading.gif" alt="image-20200601114112301"></p>
<p>ä» <code>redis</code> ä¸­æ‰¾åˆ°è¯¥ç”¨æˆ·ä»¤ç‰Œå¯¹åº”çš„ <code>jwt</code> ä»¤ç‰Œã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image3.png" srcset="/img/loading.gif" alt="image-20200601114257044"></p>
<p>ä½¿ç”¨ <code>jwt</code> çš„æµ‹è¯•ç¨‹åºæŸ¥çœ‹ æ­¤ä»¤ç‰Œçš„å†…å®¹ã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image4.png" srcset="/img/loading.gif" alt="image-20200601114334352"></p>
<p>å¯ä»¥çœ‹åˆ° <code>authorities</code> å±æ€§ä¸­ä¸ºç”¨æˆ·çš„æƒé™ã€‚</p>
<h2 id="3-æ–¹æ³•æˆæƒå®ç°"><a href="#3-æ–¹æ³•æˆæƒå®ç°" class="headerlink" title="3. æ–¹æ³•æˆæƒå®ç°"></a>3. æ–¹æ³•æˆæƒå®ç°</h2><p><strong>1ã€èµ„æºæœåŠ¡æ·»åŠ æƒé™æ§åˆ¶</strong></p>
<p>è¦æƒ³åœ¨èµ„æºæœåŠ¡ä½¿ç”¨æ–¹æ³•æˆæƒï¼Œé¦–å…ˆåœ¨ <code>èµ„æºæœåŠ¡</code> é…ç½®æˆæƒæ§åˆ¶ï¼Œæµç¨‹å¦‚ä¸‹</p>
<p>1ï¼‰æ·»åŠ  <code>spring-cloud-starter-oauth2</code> ä¾èµ–ã€‚</p>
<p>2ï¼‰æ‹·è´æˆæƒé…ç½®ç±» <code>ResourceServerConfig</code>ã€‚</p>
<p>3ï¼‰æ‹·è´å…¬é’¥ã€‚</p>
<p><strong>2ã€æ–¹æ³•ä¸Šæ·»åŠ æ³¨è§£</strong></p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œç¨‹åºå‘˜ç¼–å†™åœ¨èµ„æºæœåŠ¡çš„ <code>controller</code> æ–¹æ³•æ—¶ä¼šä½¿ç”¨æ³¨è§£æŒ‡å®šæ­¤æ–¹æ³•çš„æƒé™æ ‡è¯†ã€‚</p>
<p>ä¸ºä»€ä¹ˆä¸åœ¨ <code>Service</code> æˆ–è€… <code>Dao</code>ä¸Šå®šä¹‰ï¼Ÿå› ä¸º Service å’Œ Daoçš„æ–¹æ³•æœ‰å¯èƒ½æ˜¯å…¬ç”¨çš„ï¼Œè€Œ <code>Controller</code> é€šå¸¸éƒ½æ˜¯æœ€å¤–å±‚çš„ï¼Œæ‰€ä»¥ä¸ä¼šæ¶‰åŠåˆ°è¢«å…¶ä»–æœåŠ¡ä¾èµ–çš„æƒ…å†µã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬åœ¨ <code>è·å–è¯¾ç¨‹çš„å›¾ç‰‡</code> å’Œ <code>åˆ é™¤è¯¾ç¨‹å›¾</code> çš„æ¥å£ä¸­ä½¿ç”¨ <code>@PreAuthorize</code> æ³¨è§£è¿›è¡Œæƒé™çš„è®¾ç½®ï¼Œè¯•ä¸‹ä»¥ä¸‹åŠŸèƒ½</p>
<ul>
<li>è®¿é—® getCoursePic éœ€è¦æˆæƒ course_pic_list æƒé™</li>
<li>è®¿é—® deleteCoursePic éœ€è¦æˆæƒ course_pic_delete æƒé™</li>
</ul>
<p>è€Œæˆ‘ä»¬è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„è®¤è¯å½“ä¸­ï¼Œåªä¸ºç”¨åˆ†é…äº† course_pic_list çš„æƒé™ï¼Œé…ç½®å®Œåæˆ‘ä»¬æ¥è¿›è¡Œæµ‹è¯•ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ ¹æ®è¯¾ç¨‹idè·å–è¯¥è¯¾ç¨‹çš„è¯¾ç¨‹å›¾ç‰‡ä¿¡æ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ç”±äºè¿™é‡Œæ¯ä¸ªè¯¾ç¨‹åªæœ‰ä¸€ä¸ªå›¾ç‰‡ï¼Œæ‰€ä»¥åªè¿”å›ä¸€ä¸ª CoursePic å¯¹è±¡</span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_pic_list')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coursepic/get/&#123;courseId&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> CoursePic <span class="hljs-title">getCoursePic</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.getCoursePic(courseId);
&#125;
 
<span class="hljs-comment">/**</span>
<span class="hljs-comment">     * åˆ é™¤è¯¾ç¨‹å›¾ç‰‡ä¿¡æ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseId</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
 
<span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_pic_delete')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-meta">@DeleteMapping</span>(<span class="hljs-string">"/coursepic/delete"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">deleteCoursePic</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.deleteCoursePic(courseId);
&#125;</code></pre></div>

<p>3ã€åœ¨èµ„æºæœåŠ¡ï¼ˆè¿™é‡Œæ˜¯è¯¾ç¨‹ç®¡ç†ï¼‰çš„ <code>ResourceServerConfig</code> ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼Œæ¿€æ´»æ–¹æ³•ä¸Šæ·»åŠ æˆæƒæ³¨è§£</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//æ¿€æ´»æ–¹æ³•ä¸Šçš„PreAuthorizeæ³¨è§£</span>
<span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>, securedEnabled = <span class="hljs-keyword">true</span>)</code></pre></div>

<h2 id="4-æ–¹æ³•æˆæƒæµ‹è¯•"><a href="#4-æ–¹æ³•æˆæƒæµ‹è¯•" class="headerlink" title="4. æ–¹æ³•æˆæƒæµ‹è¯•"></a>4. æ–¹æ³•æˆæƒæµ‹è¯•</h2><p>é‡å¯è¯¾ç¨‹ç®¡ç†æœåŠ¡ï¼Œæµ‹è¯•ä¸Šè¾¹ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p>ä½¿ç”¨ <code>postman</code> æµ‹è¯•ï¼Œæµ‹è¯•å‰æ‰§è¡Œç™»å½•ï¼Œå¹¶ä¸”å°† <code>jwt</code> ä»¤ç‰Œï¼ˆaccess_tokenï¼‰æ·»åŠ åˆ° <code>header</code>ã€‚</p>
<p>å‘é€GETè¯·æ±‚åˆ°ä»¥ä¸‹é“¾æ¥</p>
<p><a href="http://www.xuecheng.com/api/course/coursepic/get/4028e58161bd22e60161bd23672a0001" target="_blank" rel="noopener">http://www.xuecheng.com/api/course/coursepic/get/4028e58161bd22e60161bd23672a0001</a></p>
<p>1ã€ç”¨æˆ·æ‹¥æœ‰ <code>course_pic_list</code> æƒé™ï¼Œå¯ä»¥æ­£å¸¸è®¿é—®è·å–è¯¾ç¨‹å›¾ç‰‡çš„æ¥å£ ã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image5.png" srcset="/img/loading.gif" alt="image-20200601115936697"></p>
<p>2ã€ä¸‹é¢æˆ‘ä»¬æ¥æµ‹è¯•åˆ é™¤è¯¾ç¨‹å›¾ç‰‡çš„æ¥å£</p>
<p>å‘é€ç»™ <code>DELETE</code> è¯·æ±‚åˆ° <a href="http://www.xuecheng.com/api/course/coursepic/delete?courseId=4028e58161bd22e60161bd23672a0001" target="_blank" rel="noopener">http://www.xuecheng.com/api/course/coursepic/delete?courseId=4028e58161bd22e60161bd23672a0001</a></p>
<p>ç”±äºç”¨æˆ·æ²¡æœ‰æŸ¥è¯¢è¯¾ç¨‹åˆ—è¡¨æ–¹æ³•çš„æƒé™ï¼Œæ‰€ä»¥æ— æ³•æ­£å¸¸è®¿é—®ï¼Œå…¶å®ƒæ–¹æ³•å¯ä»¥æ­£å¸¸è®¿é—®ã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image6.png" srcset="/img/loading.gif" alt="image-20200601133025369"></p>
<p>æ§åˆ¶å°æŠ¥é”™ï¼š</p>
<p><code>org.springframework.security.access.AccessDeniedException: ä¸å…è®¸è®¿é—®</code></p>
<p>è¯´æ˜ï¼šå¦‚æœæ–¹æ³•ä¸Šæ²¡æœ‰æ·»åŠ æˆæƒæ³¨è§£ <code>spring security</code> å°†ä¸è¿›è¡Œæˆæƒæ§åˆ¶ï¼Œåªè¦ <code>jwt</code> ä»¤ç‰Œåˆæ³•åˆ™å¯ä»¥æ­£å¸¸è®¿é—®</p>
<p>3ã€å¼‚å¸¸å¤„ç†</p>
<p>ä¸Šè¾¹å½“æ²¡æœ‰æƒé™è®¿é—®æ—¶èµ„æºæœåŠ¡ï¼Œåº”è¯¥è¿”å›ä¸‹è¾¹çš„é”™è¯¯ä»£ç ï¼š</p>
<div class="hljs"><pre><code class="hljs java">UNAUTHORISE(<span class="hljs-keyword">false</span>,<span class="hljs-number">10002</span>,<span class="hljs-string">"æƒé™ä¸è¶³ï¼Œæ— æƒæ“ä½œï¼"</span>)</code></pre></div>

<p>è¿›å…¥èµ„æºæœåŠ¡ï¼ˆæˆ‘ä»¬æµ‹è¯•çš„æ˜¯è¯¾ç¨‹ç®¡ç†ï¼‰ï¼Œæ–°å»ºä¸€ä¸ª <code>exception</code> åŒ…ï¼Œåœ¨åŒ…ä¸‹åˆ›å»ºä¸€ä¸ª CustomExceptionCatch ï¼Œå¹¶ç»§æ‰¿ <code>common</code> å·¥ç¨‹ä¸­çš„ ExceptionCatch ã€‚</p>
<p>æ·»åŠ å¼‚å¸¸ç±» <code>AccessDeniedException.class</code> ä¸é”™è¯¯ä»£ç  10002 çš„ å¯¹åº”å…³ç³»ï¼Œä½¿ç”¨ <code>@ControllerAdvice</code> æ³¨è§£æ·»åŠ ä¸€ä¸ªå…¨å±€çš„å¼‚å¸¸å¤„ç†ï¼Œå¹¶ç»§æ‰¿æˆ‘ä»¬åœ¨ <code>common</code> å·¥ç¨‹ä¸­å®šä¹‰çš„ <code>ExceptionCatch</code> ï¼Œä½¿ç”¨ static {} å‘ <code>builder</code> é‡Œé¢æ·»åŠ è‡ªå®šä¹‰çš„å¼‚å¸¸å¤„ç†ä»£ç ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_course.exception;
 
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCatch;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> org.springframework.security.access.AccessDeniedException;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;
 
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomExceptionCatch</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ExceptionCatch</span> </span>&#123;
    <span class="hljs-keyword">static</span> &#123;
        <span class="hljs-comment">//é™¤äº†CustomExceptionä»¥å¤–çš„å¼‚å¸¸ç±»å‹åŠå¯¹åº”çš„é”™è¯¯ä»£ç åœ¨è¿™é‡Œå®šä¹‰,ï¼Œå¦‚æœä¸å®šä¹‰åˆ™ç»Ÿä¸€è¿”å›å›ºå®šçš„é”™è¯¯ä¿¡æ¯</span>
        builder.put(AccessDeniedException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">CommonCode</span>.<span class="hljs-title">UNAUTHORISE</span>)</span>;
    &#125;
&#125;</code></pre></div>

<p>å†æ¬¡æµ‹è¯•ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image7.png" srcset="/img/loading.gif" alt="image-20200601134010887"></p>
<h2 id="5-å°ç»“"><a href="#5-å°ç»“" class="headerlink" title="5. å°ç»“"></a>5. å°ç»“</h2><p>åŸºäºæ–¹æ³•æˆæƒæ­¥éª¤ï¼š</p>
<p>1ã€<code>ResourceServerConfig</code> ç±»ä¸Šæ·»åŠ æ³¨è§£ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//æ¿€æ´»æ–¹æ³•ä¸Šçš„PreAuthorizeæ³¨è§£</span>
<span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>, securedEnabled = <span class="hljs-keyword">true</span>)</code></pre></div>

<p>2ã€åœ¨ <code>Controller</code> ä¸ºéœ€è¦æ ¡éªŒæƒé™çš„æ–¹æ³•ä¸Šæ·»åŠ æˆæƒæ³¨è§£</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('æƒé™åç§°')"</span>)</code></pre></div>

<p>3ã€å¦‚æœæ–¹æ³•ä¸Šä¸æ·»åŠ æˆæƒæ³¨è§£åˆ™è¡¨ç¤ºæ­¤æ–¹æ³•ä¸éœ€è¦æƒé™å³å¯è®¿é—®ã€‚</p>
<h1 id="ä¸‰ã€åŠ¨æ€æŸ¥è¯¢ç”¨æˆ·æƒé™"><a href="#ä¸‰ã€åŠ¨æ€æŸ¥è¯¢ç”¨æˆ·æƒé™" class="headerlink" title="ä¸‰ã€åŠ¨æ€æŸ¥è¯¢ç”¨æˆ·æƒé™"></a>ä¸‰ã€åŠ¨æ€æŸ¥è¯¢ç”¨æˆ·æƒé™</h1><h2 id="1-éœ€æ±‚åˆ†æ-1"><a href="#1-éœ€æ±‚åˆ†æ-1" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>æˆªè‡³ç›®å‰åœ¨æµ‹è¯•æˆæƒæ—¶ä½¿ç”¨çš„æƒé™æ•°æ®æ˜¯é™æ€æ•°æ®ï¼Œæ­£å¸¸æƒ…å†µçš„æµç¨‹æ˜¯ï¼š</p>
<p>1ã€ç®¡ç†å‘˜ç»™ç”¨æˆ·åˆ†é…æƒé™ï¼Œæƒé™æ•°æ®å†™åˆ°æ•°æ®åº“ä¸­ã€‚</p>
<p>2ã€è®¤è¯æœåŠ¡åœ¨è¿›è¡Œç”¨æˆ·è®¤è¯æ—¶ä»æ•°æ®åº“è¯»å–ç”¨æˆ·çš„æƒé™æ•°æ®ï¼ˆåŠ¨æ€æ•°æ®ï¼‰<br>æœ¬èŠ‚å®ç°åŠ¨æ€æƒé™æ•°æ®ã€‚</p>
<h2 id="2-æƒé™æ•°æ®æ¨¡å‹"><a href="#2-æƒé™æ•°æ®æ¨¡å‹" class="headerlink" title="2. æƒé™æ•°æ®æ¨¡å‹"></a>2. æƒé™æ•°æ®æ¨¡å‹</h2><h3 id="æ•°æ®æ¨¡å‹ç»“æ„"><a href="#æ•°æ®æ¨¡å‹ç»“æ„" class="headerlink" title="æ•°æ®æ¨¡å‹ç»“æ„"></a>æ•°æ®æ¨¡å‹ç»“æ„</h3><p>æ‰“å¼€ <code>xc_user</code> æ•°æ®åº“ï¼Œæ‰¾åˆ°ä¸‹è¾¹çš„è¡¨ï¼š</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image8.png" srcset="/img/loading.gif" alt="image-20200601141058705"></p>
<p>xc_userï¼šç”¨æˆ·è¡¨ï¼Œå­˜å‚¨äº†ç³»ç»Ÿç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·ç±»å‹åŒ…æ‹¬ï¼šå­¦ç”Ÿã€è€å¸ˆã€ç®¡ç†å‘˜ç­‰</p>
<p>xc_roleï¼šè§’è‰²è¡¨ï¼Œå­˜å‚¨äº†ç³»ç»Ÿçš„è§’è‰²ä¿¡æ¯ï¼Œå­¦ç”Ÿã€è€å¸ˆã€æ•™å­¦ç®¡ç†å‘˜ã€ç³»ç»Ÿç®¡ç†å‘˜ç­‰ã€‚</p>
<p>xc_user_roleï¼šç”¨æˆ·è§’è‰²è¡¨ï¼Œä¸€ä¸ªç”¨æˆ·å¯æ‹¥æœ‰å¤šä¸ªè§’è‰²ï¼Œä¸€ä¸ªè§’è‰²å¯è¢«å¤šä¸ªç”¨æˆ·æ‰€æ‹¥æœ‰</p>
<p>xc_menu: æ¨¡å—è¡¨ï¼Œè®°å½•äº†èœå•åŠèœå•ä¸‹çš„æƒé™</p>
<p>xc_permission: è§’è‰²æƒé™è¡¨ï¼Œä¸€ä¸ªè§’è‰²å¯æ‹¥æœ‰å¤šä¸ªæƒé™ï¼Œä¸€ä¸ªæƒé™å¯è¢«å¤šä¸ªè§’è‰²æ‰€æ‹¥æœ‰</p>
<blockquote>
<p>xc_permission è¡¨å¯ä»¥æ›´åä¸º xc_permission_role æˆ–è€… xc_menu_role ä¼šå®¹æ˜“ç†è§£</p>
</blockquote>
<h3 id="æ•°æ®æ¨¡å‹çš„ä½¿ç”¨"><a href="#æ•°æ®æ¨¡å‹çš„ä½¿ç”¨" class="headerlink" title="æ•°æ®æ¨¡å‹çš„ä½¿ç”¨"></a>æ•°æ®æ¨¡å‹çš„ä½¿ç”¨</h3><p>æœ¬é¡¹ç›®æ•™å­¦é˜¶æ®µä¸å†å®ç°æƒé™å®šä¹‰åŠç”¨æˆ·æƒé™åˆ†é…çš„åŠŸèƒ½ï¼Œä½†æ˜¯åŸºäºæƒé™æ•°æ®æ¨¡å‹ï¼ˆ5å¼ æ•°æ®è¡¨ï¼‰åŠç°æœ‰æ•°æ®ï¼Œè¦æ±‚å­¦ç”Ÿåœ¨æ•°æ®åº“ä¸­æ“ä½œå®Œæˆç»™ç”¨æˆ·åˆ†é…æƒé™ã€æŸ¥è¯¢ç”¨æˆ·æƒé™ç­‰éœ€æ±‚ã€‚</p>
<p>1ã€æŸ¥è¯¢ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™</p>
<p>æ­¥éª¤ï¼š</p>
<ul>
<li>ç¡®å®šç”¨æˆ·çš„id</li>
<li>æŸ¥è¯¢ç”¨æˆ·æ‰€æ‹¥æœ‰çš„è§’è‰²</li>
<li>æŸ¥è¯¢ç”¨æˆ·æ‰€å±çš„ <strong>è§’è‰²</strong> æ‰€æ‹¥æœ‰çš„æƒé™</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-comment"># æ ¹æ®æŸ¥åˆ°çš„æƒé™ID(menu_id)æŸ¥è¯¢æ‰€å¯¹åº”çš„æƒé™çš„è¯¦ç»†ä¿¡æ¯</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> xc_menu <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">IN</span>(
	<span class="hljs-comment"># æ ¹æ®ç”¨æˆ·è§’è‰²IDå–å‡ºè¯¥è§’è‰²æ‰€æ‹¥æœ‰çš„æƒé™</span>
	<span class="hljs-keyword">SELECT</span> menu_id <span class="hljs-keyword">FROM</span> xc_permission <span class="hljs-keyword">WHERE</span> role_id <span class="hljs-keyword">IN</span>(
        	<span class="hljs-comment"># è·å–æŒ‡å®šç”¨æˆ·æ‰€æ‹¥æœ‰è§’è‰²çš„id</span>
			<span class="hljs-keyword">SELECT</span> role_id <span class="hljs-keyword">FROM</span> xc_user_role <span class="hljs-keyword">where</span> user_id = <span class="hljs-number">49</span>
	)
)</code></pre></div>

<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image9.png" srcset="/img/loading.gif" alt="image-20200601144244164"></p>
<p>2ã€å‘å·²æ‹¥æœ‰è§’è‰²åˆ†é…æƒé™</p>
<p>1ï¼‰æ–°å¢ä¸€ä¸ª æƒé™ <code>A</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function">INSERT INTO <span class="hljs-title">xc_menu</span> <span class="hljs-params">(id,code,p_id,menu_name)</span> <span class="hljs-title">VALUES</span> <span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"903459378655395851"</span>, # æƒé™Açš„ID</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"course_pic_list"</span>,</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"903459378655395841"</span>,</span></span>
<span class="hljs-function"><span class="hljs-params">	<span class="hljs-string">"è¯¾ç¨‹å›¾ç‰‡æŸ¥è¯¢"</span></span></span>
<span class="hljs-function"><span class="hljs-params">)</span></span>;</code></pre></div>

<p>2ï¼‰å°†è¯¥ç”¨æˆ·æ‰€å±çš„æŸä¸ªè§’è‰²ä¸æƒé™ <code>A</code> å…³è”èµ·æ¥</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> xc_permission (<span class="hljs-keyword">id</span>,role_id,menu_id) <span class="hljs-keyword">VALUES</span>(
	<span class="hljs-string">"8947692177635409931"</span>,
	<span class="hljs-number">20</span>,
	<span class="hljs-string">"903459378655395851"</span> <span class="hljs-comment"># æƒé™Açš„ID</span>
)</code></pre></div>

<p>3ï¼‰å†æ¬¡æŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹æœ‰çš„æƒé™</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image10.png" srcset="/img/loading.gif" alt="image-20200601144328736"></p>
<p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¸ºç”¨æˆ·æ‰€å±çš„è§’è‰²ä¸‹æ·»åŠ äº†ä¸€ä¸ªè¯¾ç¨‹å›¾ç‰‡æŸ¥è¯¢çš„æƒé™ï¼Œé‚£ä¹ˆç”¨æˆ·ä¹Ÿä¼šåŒæ—¶æ‹¥æœ‰äº†è¯¥æƒé™ã€‚</p>
<h2 id="3-ç”¨æˆ·ä¸­å¿ƒæŸ¥è¯¢ç”¨æˆ·æƒé™"><a href="#3-ç”¨æˆ·ä¸­å¿ƒæŸ¥è¯¢ç”¨æˆ·æƒé™" class="headerlink" title="3. ç”¨æˆ·ä¸­å¿ƒæŸ¥è¯¢ç”¨æˆ·æƒé™"></a>3. ç”¨æˆ·ä¸­å¿ƒæŸ¥è¯¢ç”¨æˆ·æƒé™</h2><h3 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>è®¤è¯æœåŠ¡è¯·æ±‚ç”¨æˆ·ä¸­å¿ƒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·éœ€è¦å°†ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œç”¨æˆ·æƒé™ä¸€åŒè¿”å›ç»™è®¤è¯æœåŠ¡ã€‚</p>
<p>æœ¬å°èŠ‚å®ç°æŸ¥è¯¢ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™ï¼Œå¹¶å°†ç”¨æˆ·æƒé™ä¿¡æ¯æ·»åŠ åˆ°çš„æŒ‡å®šå¯¹è±¡ä¸­è¿”å›ç»™è®¤è¯æœåŠ¡ã€‚</p>
<p>ä»¥ä¸Šéœ€æ±‚éœ€è¦ä¿®æ”¹å¦‚ä¸‹æ¥å£ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/getuserext"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserext</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"username"</span>)</span> String username)</span>;</code></pre></div>

<h3 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h3><p>åœ¨ç”¨æˆ·ä¸­å¿ƒæœåŠ¡ä¸­ç¼–å†™ <code>dao</code>ï¼Œå®ç°æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢æƒé™ã€‚</p>
<p>1ã€å®šä¹‰ XcMenuMapper.java</p>
<p>åœ¨ <code>com.xuecheng.ucenter.dao</code> åŒ…ä¸‹å®šä¹‰ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">XcMenuMapper</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;XcMenu&gt; <span class="hljs-title">selectPermissionByUserId</span><span class="hljs-params">(String userid)</span></span>;
&#125;</code></pre></div>

<p>2ã€XcMenuMapper.xml</p>
<p>åœ¨ <code>resources</code> ä¸‹åˆ›å»º <code>com.xuecheng.ucenter.dao</code> ç„¶åå®šä¹‰ <code>XcMenuMapper.xml</code></p>
<p>è¿™é‡Œè¦æ³¨æ„çš„ä¸€ä¸ªç‚¹å°±æ˜¯ï¼Œåœ¨r esources åˆ›å»º com.xuecheng.ucenter.dao æ—¶éœ€è¦é€ä¸ªåŒ…æ¥åˆ›å»ºï¼Œå¦‚æœç›´æ¥å¤åˆ¶æ•´ä¸²æ¥åˆ›å»ºï¼Œideaä¼šå°†ä»–è¯†åˆ«ä¸ºåŒä¸€ä¸ªç›®å½•ï¼Œå¯¼è‡´mapperxmlæ–‡ä»¶æ— æ³•è¢«æ‰«æåˆ°ï¼Œä¾‹å¦‚ä¸‹å›¾</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image11.png" srcset="/img/loading.gif" alt="image-20200602103546011"></p>
<blockquote>
<p>è¿™é‡Œmapper.xmlæ–‡ä»¶ä¹Ÿå¯ä»¥å­˜æ”¾çš„ä½ç½®ä¹Ÿå¯ä»¥æ˜¯è‡ªå®šä¹‰çš„åŒ…åï¼Œä½†æ˜¯è¦åœ¨å¯åŠ¨ç±»é…ç½®mapperscan</p>
</blockquote>
<div class="hljs"><pre><code class="hljs sql">&lt;?xml version="1.0" encoding="UTFâ€8" ?&gt;
&lt;!DOCTYPE mapper PUBLIC "â€//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatisâ€3â€
mapper.dtd" &gt;
&lt;mapper namespace="com.xuecheng.ucenter.dao.XcMenuMapper" &gt;
    &lt;select id="selectPermissionByUserId"
            resultType="com.xuecheng.framework.domain.ucenter.XcMenu" parameterType="java.lang.String" &gt;
        <span class="hljs-keyword">SELECT</span>
        <span class="hljs-keyword">id</span>,
        CODE,
        p_id pId,
        menu_name menuName,
        <span class="hljs-keyword">url</span>,
        is_menu isMenu,
        <span class="hljs-keyword">LEVEL</span>,
        <span class="hljs-keyword">sort</span>,
        <span class="hljs-keyword">STATUS</span>,
        icon,
        create_time createTime,
        update_time updateTiem
        <span class="hljs-keyword">FROM</span>
        xc_menu
        <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">IN</span>(
        <span class="hljs-keyword">SELECT</span> menu_id <span class="hljs-keyword">FROM</span> xc_permission <span class="hljs-keyword">WHERE</span> role_id <span class="hljs-keyword">IN</span>(
        <span class="hljs-keyword">SELECT</span> role_id <span class="hljs-keyword">FROM</span> xc_user_role <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-comment">#&#123;id&#125;</span>
        )
        )
    &lt;/<span class="hljs-keyword">select</span>&gt;
&lt;/mapper&gt;</code></pre></div>

<p>å…¶å®ƒ Dao é‡‡ç”¨ <code>spring data jpa</code> ç¼–å†™å¦‚ä¸‹ï¼š</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image12.png" srcset="/img/loading.gif" alt="image-20200601144613066"></p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>ä¿®æ”¹ <code>UserService</code> çš„ <code>getUserExt</code> æ–¹æ³•ï¼ŒæŸ¥è¯¢ç”¨æˆ·æƒé™ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿”å›ç”¨æˆ·æ‰©å±•ä¿¡æ¯</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserExt</span><span class="hljs-params">(String username)</span></span>&#123;
    XcUser xcUser = <span class="hljs-keyword">this</span>.findXcUserByUsername(username);
    <span class="hljs-keyword">if</span>(xcUser == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125; 
    <span class="hljs-comment">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ·æƒé™</span>
    String userId = xcUser.getId();
    List&lt;XcMenu&gt; xcMenus = xcMenuMapper.selectPermissionByUserId(userId);
    XcUserExt xcUserExt = <span class="hljs-keyword">new</span> XcUserExt();
    BeanUtils.copyProperties(xcUser,xcUserExt);
    <span class="hljs-comment">//ç”¨æˆ·çš„æƒé™</span>
    xcUserExt.setPermissions(xcMenus);
    <span class="hljs-keyword">return</span> xcUserExt;
&#125;</code></pre></div>

<h2 id="4-è®¤è¯æœåŠ¡æŸ¥è¯¢ç”¨æˆ·æƒé™"><a href="#4-è®¤è¯æœåŠ¡æŸ¥è¯¢ç”¨æˆ·æƒé™" class="headerlink" title="4. è®¤è¯æœåŠ¡æŸ¥è¯¢ç”¨æˆ·æƒé™"></a>4. è®¤è¯æœåŠ¡æŸ¥è¯¢ç”¨æˆ·æƒé™</h2><p>ä¿®æ”¹è®¤è¯æœåŠ¡çš„ <code>UserDetailServiceImpl</code> ï¼ŒæŸ¥è¯¢ç”¨æˆ·çš„æƒé™ï¼Œå¹¶æ‹¼æ¥æƒé™ä¸²ï¼Œå°†åŸæ¥ç¡¬ç¼–ç æƒé™ä»£ç åˆ é™¤ï¼Œä»£ç å¦‚<br>ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDetailsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;
    
    <span class="hljs-meta">@Autowired</span>
    ClientDetailsService clientDetailsService;
 
    <span class="hljs-comment">//ç”¨æˆ·ä¸­å¿ƒæœåŠ¡å®¢æˆ·ç«¯</span>
    <span class="hljs-meta">@Autowired</span>
    UserClient userClient;
 
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;
        <span class="hljs-comment">//å–å‡ºèº«ä»½ï¼Œå¦‚æœèº«ä»½ä¸ºç©ºè¯´æ˜æ²¡æœ‰è®¤è¯</span>
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        <span class="hljs-comment">//æ²¡æœ‰è®¤è¯ç»Ÿä¸€é‡‡ç”¨httpbasicè®¤è¯ï¼Œhttpbasicä¸­å­˜å‚¨äº†client_idå’Œclient_secret</span>
        <span class="hljs-comment">//å¼€å§‹è®¤è¯client_idå’Œclient_secret</span>
        <span class="hljs-keyword">if</span>(authentication==<span class="hljs-keyword">null</span>)&#123;
            ClientDetails clientDetails = clientDetailsService.loadClientByClientId(username);
            <span class="hljs-keyword">if</span>(clientDetails!=<span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//å¯†ç </span>
                String clientSecret = clientDetails.getClientSecret();
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username,clientSecret,AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">""</span>));
            &#125;
        &#125;
        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(username)) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
 
        <span class="hljs-comment">//è¯·æ±‚ucenteræŸ¥è¯¢ç”¨æˆ·</span>
        XcUserExt userext = userClient.getUserext(username);
        <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>; <span class="hljs-comment">//å¦‚æœè·å–åˆ°çš„ç”¨ä¿¡æ¯ä¸ºç©º,åˆ™è¿”å›null,spring securityåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</span>
 
        <span class="hljs-comment">//ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æ­£ç¡®çš„å¯†ç ï¼ŒSpring Securityä¼šå»æ¯”å¯¹è¾“å…¥å¯†ç çš„æ­£ç¡®æ€§</span>
        String password = userext.getPassword();
        <span class="hljs-comment">//æŒ‡å®šç”¨æˆ·çš„æƒé™,ä»æ•°æ®åº“ä¸­è·å–</span>
        List&lt;XcMenu&gt; permissions = userext.getPermissions();
        <span class="hljs-keyword">if</span>(permissions == <span class="hljs-keyword">null</span>) &#123;
            permissions = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        &#125;
 
        List&lt;String&gt; permissionsCode = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-comment">//éå†æƒé™å¯¹è±¡ä¸­çš„codeå­—æ®µ</span>
        permissions.forEach(item -&gt; permissionsCode.add(item.getCode()));
        <span class="hljs-comment">//å°†æƒé™ä¸²ä¸­é—´ä»¥é€—å·åˆ†éš”</span>
        String user_permission_string = StringUtils.join(permissionsCode.toArray(), <span class="hljs-string">","</span>);
 
        <span class="hljs-comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°userDetailså¯¹è±¡</span>
        UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(
            username,
            password,
            AuthorityUtils.commaSeparatedStringToAuthorityList(user_permission_string));
 
        <span class="hljs-comment">//ç”¨æˆ·id</span>
        userDetails.setId(userext.getId());
        <span class="hljs-comment">//ç”¨æˆ·åç§°</span>
        userDetails.setName(userext.getName());
        <span class="hljs-comment">//ç”¨æˆ·å¤´åƒ</span>
        userDetails.setUserpic(userext.getUserpic());
        <span class="hljs-comment">//ç”¨æˆ·æ‰€å±ä¼ä¸šid</span>
        userDetails.setCompanyId(userext.getCompanyId());
 
        <span class="hljs-comment">//è¿”å›ç”¨ä¿¡æ¯ç»™åˆ°Spring Securityè¿›è¡Œå¤„ç†</span>
        <span class="hljs-keyword">return</span> userDetails;
    &#125;
&#125;</code></pre></div>

<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œè®¾ç½®åˆ° <code>userDetails</code> å¯¹è±¡çš„æƒé™ä¿¡æ¯ä¸ºæƒé™çš„ä»£ç æ ‡è¯†ï¼Œä¹Ÿå°±æ˜¯ <code>UserJwt</code> å¯¹è±¡çš„ <code>code</code>å­—æ®µï¼Œéœ€è¦å°†æ‰€æœ‰çš„æƒé™ä»£ç éå†å‡ºæ¥ç„¶åæ‹¼æ¥æˆå­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹ä»£ç </p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//æŒ‡å®šç”¨æˆ·çš„æƒé™,ä»æ•°æ®åº“ä¸­è·å–</span>
List&lt;XcMenu&gt; permissions = userext.getPermissions();
List&lt;String&gt; permissionsCode = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
<span class="hljs-keyword">for</span> (XcMenu xcMenu : permissions )&#123;
    String code = xcMenu.getCode();
    permissionsCode.add(code);
&#125;
<span class="hljs-comment">//å°†æƒé™ä¸²ä¸­é—´ä»¥é€—å·åˆ†éš”</span>
String user_permission_string = StringUtils.join(permissionsCode.toArray(), <span class="hljs-string">","</span>);</code></pre></div>

<h2 id="5-æµ‹è¯•"><a href="#5-æµ‹è¯•" class="headerlink" title="5. æµ‹è¯•"></a>5. æµ‹è¯•</h2><p>1ã€æ‰§è¡Œç™»å½•ï¼Œåœ¨ <code>redis</code> ä¸­æŸ¥çœ‹ <code>jwt</code> ä»¤ç‰Œï¼Œä½¿ç”¨ <code>jwt</code> æµ‹è¯•ç¨‹åºè§£æ <code>jwt</code> ä»¤ç‰Œä¸­æ˜¯å¦åŒ…æ‹¬ç”¨æˆ·çš„æƒé™ ã€‚</p>
<p>æµ‹è¯•ç™»å½•ï¼Œæ‹¿åˆ°ä»¤ç‰Œ</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image13.png" srcset="/img/loading.gif" alt="image-20200602114307895"></p>
<p>æ ¹æ®ä»¤ç‰Œï¼Œæˆ‘ä»¬åˆ°redisé‡Œæ‰¾åˆ°è¯¥ä»¤ç‰Œå¯¹åº”çš„ <code>access_token</code></p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image14.png" srcset="/img/loading.gif" alt="image-20200602114407430"></p>
<p>2ã€ä½¿ç”¨æ–°çš„jwtä»¤ç‰Œæµ‹è¯•æ–¹æ³•æˆæƒ</p>
<p>æˆåŠŸçš„è®¿é—®è¯¾ç¨‹å›¾ç‰‡çš„æ¥å£</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image15.png" srcset="/img/loading.gif" alt="image-20200602121703349"></p>
<h1 id="å››ã€å‰ç«¯é›†æˆè®¤è¯æˆæƒ"><a href="#å››ã€å‰ç«¯é›†æˆè®¤è¯æˆæƒ" class="headerlink" title="å››ã€å‰ç«¯é›†æˆè®¤è¯æˆæƒ"></a>å››ã€å‰ç«¯é›†æˆè®¤è¯æˆæƒ</h1><h2 id="1-éœ€æ±‚åˆ†æ-2"><a href="#1-éœ€æ±‚åˆ†æ-2" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>æˆªè‡³ç›®å‰è®¤è¯æˆæƒæœåŠ¡ç«¯çš„åŠŸèƒ½å·²åŸºæœ¬å®Œæˆï¼Œæœ¬ç« å®ç°å‰ç«¯é›†æˆè®¤è¯æˆæƒåŠŸèƒ½ã€‚</p>
<p>å‰ç«¯é›†æˆè®¤è¯æˆæƒåŠŸèƒ½éœ€è¦ä½œå¦‚ä¸‹å·¥ä½œï¼š</p>
<p>1ã€å‰ç«¯é¡µé¢æ ¡éªŒç”¨æˆ·çš„èº«ä»½ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ç™»å½•åˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢</p>
<p>2ã€å‰ç«¯è¯·æ±‚èµ„æºæœåŠ¡éœ€è¦åœ¨ <code>http header</code> ä¸­æ·»åŠ  <code>jwt</code> ä»¤ç‰Œï¼Œèµ„æºæœåŠ¡æ ¹æ® <code>jwt</code> ä»¤ç‰Œå®Œæˆæˆæƒã€‚</p>
<p>å“ªäº›åŠŸèƒ½éœ€è¦å‰ç«¯è¯·æ±‚æ—¶æºå¸¦ <code>JWT</code> ï¼Ÿ</p>
<p>ç”¨æˆ·ç™»å½•æˆåŠŸè¯·æ±‚èµ„æºæœåŠ¡éƒ½éœ€è¦æºå¸¦ <code>jwt</code> ä»¤ç‰Œï¼Œå› ä¸ºèµ„æºæœåŠ¡å·²ç»å®ç°äº† <code>jwt</code> è®¤è¯ï¼Œå¦‚æœæ ¡éªŒå¤´éƒ¨æ²¡æœ‰ <code>jwt</code> åˆ™ä¼šè®¤ä¸ºèº«ä»½ä¸åˆæ³•ã€‚</p>
<h2 id="2-æ•™å­¦ç®¡ç†ä¸­å¿ƒ"><a href="#2-æ•™å­¦ç®¡ç†ä¸­å¿ƒ" class="headerlink" title="2. æ•™å­¦ç®¡ç†ä¸­å¿ƒ"></a>2. æ•™å­¦ç®¡ç†ä¸­å¿ƒ</h2><p>æœ¬èŠ‚å®ç°æ•™å­¦ç®¡ç†ä¸­å¿ƒï¼ˆxc-ui-pc-teachï¼‰å®ç°èº«ä»½æ ¡éªŒï¼Œå…¶å®ƒå‰ç«¯å‚è€ƒæ•™å­¦ç®¡ç†ä¸­å¿ƒå®ç°</p>
<h3 id="é…ç½®è™šæ‹Ÿä¸»æœº"><a href="#é…ç½®è™šæ‹Ÿä¸»æœº" class="headerlink" title="é…ç½®è™šæ‹Ÿä¸»æœº"></a>é…ç½®è™šæ‹Ÿä¸»æœº</h3><p>æ•™å­¦ç®¡ç†å‰ç«¯è®¿é—®å¾®æœåŠ¡ç»Ÿä¸€åœ¨è®¿é—®åœ°å€å‰æ·»åŠ  <code>/api</code> å‰ç¼€å¹¶ç»è¿‡ç½‘å…³è½¬å‘åˆ°å¾®æœåŠ¡ã€‚</p>
<p>é…ç½® teacher.xuecheng.com è™šæ‹Ÿä¸»æœºã€‚</p>
<div class="hljs"><pre><code class="hljs java">#å‰ç«¯æ•™å­¦ç®¡ç†
upstream teacher_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">12000</span> weight=<span class="hljs-number">10</span>;
&#125; 
#æ–‡ä»¶æœåŠ¡
upstream filesystem_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">22100</span> weight=<span class="hljs-number">10</span>;
&#125; 
#åª’èµ„æœåŠ¡
upstream media_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">31400</span> weight=<span class="hljs-number">10</span>;
&#125;
# å­¦æˆç½‘æ•™å­¦ç®¡ç†ä¸­å¿ƒ
server &#123;
    listen <span class="hljs-number">80</span>;
    server_name teacher.xuecheng.com;
    #ä¸ªäººä¸­å¿ƒ
    location / &#123;
        proxy_pass http:<span class="hljs-comment">//teacher_server_pool;</span>
    &#125; 
    location /api &#123;
        proxy_pass http:<span class="hljs-comment">//api_server_pool;</span>
    &#125; 
    location /filesystem &#123;
        proxy_pass http:<span class="hljs-comment">//filesystem_server_pool;</span>
    &#125;
    #åª’èµ„ç®¡ç†
    location ^~ /api/media/ &#123;
        proxy_pass http:<span class="hljs-comment">//media_server_pool/media/;</span>
    &#125; 
    #è®¤è¯
    location ^~ /openapi/auth/ &#123;
        proxy_pass http:<span class="hljs-comment">//auth_server_pool/auth/;</span>
    &#125;
&#125;</code></pre></div>

<p>ä¿®æ”¹ <code>hosts</code> æ–‡ä»¶ C:\Windows\System32\drivers\etc\hosts</p>
<div class="hljs"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span> teacher.xuecheng.com</code></pre></div>

<h3 id="èº«ä»½æ ¡éªŒ"><a href="#èº«ä»½æ ¡éªŒ" class="headerlink" title="èº«ä»½æ ¡éªŒ"></a>èº«ä»½æ ¡éªŒ</h3><p>æ•™å­¦ç®¡ç†ä¸­å¿ƒï¼ˆxc-ui-pc-teachï¼‰æ˜¯å•é¡µé¢åº”ç”¨ï¼Œæˆ‘ä»¬åœ¨è·¯ç”±å˜åŒ–æ—¶æ ¡éªŒç”¨æˆ·çš„èº«ä»½ï¼Œæ ¡éªŒå¤±è´¥å°†è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚</p>
<p>æ ¡éªŒæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœæˆåŠŸä» sessionStorage å’Œ <code>cookie</code> è·å–å½“å‰ç”¨æˆ·åˆ™ç»§ç»­è®¿é—®</li>
<li>å¦‚æœ sessionStorage ä¸­æ— å½“å‰ç”¨æˆ·ï¼Œcookie ä¸­æœ‰å½“å‰ç”¨æˆ·åˆ™è¯·æ±‚æœåŠ¡ç«¯è·å– <code>jwt</code>ï¼Œå¦‚æœæˆåŠŸåˆ™ç»§ç»­è®¿é—®ã€‚</li>
<li>ä»¥ä¸Šä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³åˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚</li>
</ul>
<p>1ã€åœ¨ <code>main.js</code> ä¸­æ·»åŠ è·¯ç”±ç›‘æ§ä»£ç ï¼Œå¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java">router.beforeEach((to, from, next) =&gt; &#123;
    <span class="hljs-keyword">if</span>(openAuthenticate)&#123;
        <span class="hljs-comment">// console.log(to)</span>
        <span class="hljs-comment">// console.log(from)</span>
        <span class="hljs-comment">//***********èº«ä»½æ ¡éªŒ***************</span>
        let activeUser
        let uid
        <span class="hljs-keyword">try</span>&#123;
            activeUser = utilApi.getActiveUser()
            uid = utilApi.getCookie(<span class="hljs-string">"uid"</span>)
        &#125;<span class="hljs-keyword">catch</span>(e)&#123;
            <span class="hljs-comment">//alert(e)</span>
        &#125; 
        <span class="hljs-keyword">if</span>(activeUser &amp;&amp; uid &amp;&amp; uid == activeUser.uid) &#123;
            next();
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(to.path ==<span class="hljs-string">'/login'</span> || to.path ==<span class="hljs-string">'/logout'</span>)&#123;
            next();
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(uid)&#123;
            <span class="hljs-comment">//è¯·æ±‚è·å–jwt</span>
            systemApi.getjwt().then((res)=&gt;&#123;
                <span class="hljs-keyword">if</span>(res.success)&#123;
                    let jwt = res.jwt;
                    let activeUser = utilApi.getUserInfoFromJwt(jwt)
                    <span class="hljs-keyword">if</span>(activeUser)&#123;
                        utilApi.setUserSession(<span class="hljs-string">"activeUser"</span>,JSON.stringify(activeUser))
                    &#125; 
                    next();
                &#125;<span class="hljs-keyword">else</span>&#123;
                    <span class="hljs-comment">//è·³è½¬åˆ°ç»Ÿä¸€ç™»é™†</span>
                    window.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/login?returnUrl="</span>+Base64.encode(window.location)
                &#125;
            &#125;)
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-comment">//è·³è½¬åˆ°ç»Ÿä¸€ç™»é™†</span>
            window.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/login?returnUrl="</span>+Base64.encode(window.location)
        &#125;
    &#125;<span class="hljs-keyword">else</span>&#123;
        next();
    &#125;
&#125;);</code></pre></div>

<p>é…ç½® xc-ui-pc-teach/config/sysConfig.js å¼€å¯è®¤è¯æˆæƒçš„é…ç½®</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">var</span> sysConfig = &#123;
    openAuthenticate: <span class="hljs-literal">true</span>,
    openAuthorize: <span class="hljs-literal">true</span>
&#125;
 
<span class="hljs-built_in">module</span>.exports = sysConfig</code></pre></div>

<p>2ã€åœ¨ base/api/system.js ä¸­æ·»åŠ  <code>getjwt</code> æ–¹æ³•</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/*è·å–jwtä»¤ç‰Œ*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getjwt= <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestQuickGet(<span class="hljs-string">'/openapi/auth/userjwt'</span>)
&#125;</code></pre></div>

<p>3ã€åœ¨utils.jsä¸­æ·»åŠ  å¦‚ä¸‹æ–¹æ³•</p>
<div class="hljs"><pre><code class="hljs js">getActiveUser: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-keyword">let</span> uid = <span class="hljs-keyword">this</span>.getCookie(<span class="hljs-string">"uid"</span>)
    <span class="hljs-keyword">if</span>(uid)&#123;
        <span class="hljs-keyword">let</span> activeUserStr = <span class="hljs-keyword">this</span>.getUserSession(<span class="hljs-string">"activeUser"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(activeUserStr);
    &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-keyword">this</span>.delUserSession(<span class="hljs-string">"activeUser"</span>)
    &#125;
&#125;,
    <span class="hljs-comment">//è·å–jwtä»¤ç‰Œ</span>
    getJwt : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-keyword">let</span> activeUser = <span class="hljs-keyword">this</span>.getActiveUser()
        <span class="hljs-keyword">if</span>(activeUser)&#123;
            <span class="hljs-keyword">return</span> activeUser.jwt
        &#125;
    &#125;,
        <span class="hljs-comment">//è§£æjwtä»¤ç‰Œï¼Œè·å–ç”¨æˆ·ä¿¡æ¯</span>
        getUserInfoFromJwt : <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">jwt</span>) </span>&#123;
            <span class="hljs-keyword">if</span>(!jwt)&#123;
                <span class="hljs-keyword">return</span> ;
            &#125; 
            <span class="hljs-keyword">var</span> jwtDecodeVal = jwtDecode(jwt);
            <span class="hljs-keyword">if</span> (!jwtDecodeVal) &#123;
                <span class="hljs-keyword">return</span> ;
            &#125; 
            <span class="hljs-keyword">let</span> activeUser=&#123;&#125;
            <span class="hljs-comment">//console.log(jwtDecodeVal)</span>
            activeUser.utype = jwtDecodeVal.utype || <span class="hljs-string">''</span>;
            activeUser.username = jwtDecodeVal.name || <span class="hljs-string">''</span>;
            activeUser.userpic = jwtDecodeVal.userpic || <span class="hljs-string">''</span>;
            activeUser.userid = jwtDecodeVal.userid || <span class="hljs-string">''</span>;
            activeUser.authorities = jwtDecodeVal.authorities || <span class="hljs-string">''</span>;
            activeUser.uid = jwtDecodeVal.jti || <span class="hljs-string">''</span>;
            activeUser.jwt = jwt;
            <span class="hljs-keyword">return</span> activeUser;
        &#125;,</code></pre></div>

<p>4ã€æµ‹è¯•</p>
<p>1ï¼‰å¯åŠ¨å­¦ä¹ ä¸­å¿ƒå‰ç«¯ã€æ•™å­¦ç®¡ç†å‰ç«¯ã€è®¤è¯æœåŠ¡ã€ç”¨æˆ·ä¸­å¿ƒæœåŠ¡ã€ç½‘å…³ã€<code>Eureka</code></p>
<ul>
<li>è¿›å…¥é¦–é¡µ</li>
<li>ç‚¹å‡»â€œæ•™å­¦æä¾›æ–¹â€ï¼Œæ­¤æ—¶ç”±äºæ²¡æœ‰ç™»å½•è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢</li>
</ul>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image16.png" srcset="/img/loading.gif" alt="image-20200603075015366"></p>
<p>2ï¼‰è¾“å…¥è´¦å·å’Œå¯†ç ç™»å½•</p>
<p>ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°æ•™å­¦ç®¡ç†é¡µé¢</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image17.png" srcset="/img/loading.gif" alt="image-20200603075038706"></p>
<h3 id="æºå¸¦JWTæˆæƒ"><a href="#æºå¸¦JWTæˆæƒ" class="headerlink" title="æºå¸¦JWTæˆæƒ"></a>æºå¸¦JWTæˆæƒ</h3><p>1ã€å‰ç«¯æºå¸¦JWTè¯·æ±‚</p>
<p>æ ¹æ®éœ€æ±‚ï¼Œåœ¨ä½¿ç”¨ <code>axios</code> è¿›è¡Œ http è¯·æ±‚å‰å‘ <code>header</code> ä¸­åŠ å…¥ <code>jwt</code> ä»¤ç‰Œ</p>
<p>åœ¨ <code>main.js</code> ä¸­æ·»åŠ </p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>
<span class="hljs-comment">// æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨</span>
axios.interceptors.request.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">config</span>) </span>&#123;
    <span class="hljs-comment">// åœ¨å‘é€è¯·æ±‚å‘headeræ·»åŠ jwt</span>
    <span class="hljs-keyword">let</span> jwt = utilApi.getJwt()
    <span class="hljs-keyword">if</span>(jwt)&#123;
        config.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer '</span>+jwt
    &#125; 
    <span class="hljs-keyword">return</span> config;
&#125;, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(error);
&#125;);</code></pre></div>

<p>2ã€æµ‹è¯• <code>http</code> è¯·æ±‚æ˜¯å¦æºå¸¦jwt</p>
<p>è¿›å…¥æ•™å­¦ç®¡ç†ä¸­å¿ƒï¼Œç‚¹å‡»æˆ‘çš„è¯¾ç¨‹ï¼Œè§‚å¯Ÿ <code>request header</code> ä¸­æ˜¯å¦æœ‰ <code>Authorization</code> ä¿¡æ¯</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image18.png" srcset="/img/loading.gif" alt="image-20200603075158919"></p>
<p>3ã€æµ‹è¯•æˆæƒæ•ˆæœ</p>
<p>å½“è®¿é—®ä¸€ä¸ªæ²¡æœ‰æƒé™çš„æ–¹æ³•æ—¶æ˜¯å¦æŠ¥é”™ï¼Ÿ</p>
<p>æµ‹è¯•æ–¹æ³•ï¼š</p>
<p>åœ¨è¯¾ç¨‹è®¡åˆ’æŸ¥è¯¢æ–¹æ³•ä¸Šæ·»åŠ æˆæƒæ³¨è§£ï¼Œè¡¨ç¤ºå½“å‰ç”¨æˆ·éœ€è¦æ‹¥æœ‰course_teachplan_listæƒé™æ–¹å¯æ­£å¸¸è®¿é—®ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasAuthority('course_teachplan_list')"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> TeachplanNode <span class="hljs-title">findTeachplanList</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"courseId"</span>)</span> String courseId) </span>&#123;
    <span class="hljs-keyword">return</span> courseService.findTeachplanList(courseId);
&#125;</code></pre></div>

<p>è¿›å…¥æˆ‘çš„è¯¾ç¨‹ï¼Œç‚¹å‡»è¯¾ç¨‹è®¡åˆ’ï¼Œè§‚å¯Ÿå“åº”ç»“æœä¸º 10002é”™è¯¯ã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image19.png" srcset="/img/loading.gif" alt="image-20200603075236015"></p>
<p>4ã€æç¤ºæƒé™ä¸è¶³</p>
<p>å½“æƒé™ä¸è¶³é¦–é¡µè¦ç»™å‡ºæç¤ºï¼Œå®ç°æ€è·¯æ˜¯ä½¿ç”¨axiosçš„æ‹¦æˆªï¼Œåœ¨æ‰§è¡Œåæ ¡éªŒå“åº”ç»“æœï¼Œå¦‚æœæ˜¯<code>10002</code> ä»£ç çš„é”™è¯¯åˆ™æç¤ºç”¨æˆ· ```â€œæƒé™ä¸è¶³â€<code>ï¼Œå¦‚æœæ˜¯</code>10001` ä»£ç åˆ™å¼ºåˆ¶ç™»å½•ã€‚</p>
<p>åœ¨ <code>main.js</code> ä¸­æ·»åŠ </p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">// å“åº”æ‹¦æˆª</span>
axios.interceptors.response.use(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"data="</span>,data)
  <span class="hljs-keyword">if</span>(data &amp;&amp; data.data)&#123;
    <span class="hljs-keyword">if</span>(data.data.code &amp;&amp; data.data.code ==<span class="hljs-string">'10001'</span>)&#123;
      <span class="hljs-comment">//éœ€è¦ç™»å½•</span>
      <span class="hljs-comment">// router.push(&#123;</span>
      <span class="hljs-comment">//   path: '/login',</span>
      <span class="hljs-comment">//   query: &#123;returnUrl: Base64.encode(window.location)&#125;</span>
      <span class="hljs-comment">// &#125;)</span>
      <span class="hljs-built_in">window</span>.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/login?returnUrl="</span>+ Base64.encode(<span class="hljs-built_in">window</span>.location)
    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(data.data.code &amp;&amp; data.data.code ==<span class="hljs-string">'10002'</span>)&#123;
      Message.error(<span class="hljs-string">'æ‚¨æ²¡æœ‰æƒé™æ“ä½œè¯¥é€‰é¡¹'</span>);
      <span class="hljs-keyword">return</span>
    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(data.data.code &amp;&amp; data.data.code ==<span class="hljs-string">'10003'</span>)&#123;
      Message.error(<span class="hljs-string">'è®¤è¯è¢«æ‹’ç»ï¼Œè¯·é‡æ–°ç™»å½•é‡è¯•ï¼'</span>);
      <span class="hljs-keyword">return</span>
    &#125;
  &#125;
  <span class="hljs-keyword">return</span> data
&#125;)</code></pre></div>

<p>æµ‹è¯•ï¼š</p>
<p>æ‰§è¡Œä¸€ä¸ªæ²¡æœ‰æƒé™çš„æ“ä½œï¼Œæç¤ºå¦‚ä¸‹</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image20.png" srcset="/img/loading.gif" alt="image-20200603101409637"></p>
<h2 id="3-ä¸€äº›é—®é¢˜"><a href="#3-ä¸€äº›é—®é¢˜" class="headerlink" title="3. ä¸€äº›é—®é¢˜"></a>3. ä¸€äº›é—®é¢˜</h2><p>ç”¨æˆ·å‰ç«¯æ˜¯å¦‚ä½•è§£å¯†JWTä»¤ç‰Œçš„ï¼Ÿ å…¬é’¥æ˜¯å¦ä¼šæš´éœ²åœ¨å‰ç«¯ï¼Ÿ</p>
<h1 id="äº”ã€ç»†ç²’åº¦æˆæƒ"><a href="#äº”ã€ç»†ç²’åº¦æˆæƒ" class="headerlink" title="äº”ã€ç»†ç²’åº¦æˆæƒ"></a>äº”ã€ç»†ç²’åº¦æˆæƒ</h1><h2 id="1-éœ€æ±‚åˆ†æ-3"><a href="#1-éœ€æ±‚åˆ†æ-3" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p><strong>ä»€ä¹ˆæ˜¯ç»†ç²’åº¦æˆæƒï¼Ÿ</strong></p>
<p>ç»†ç²’åº¦æˆæƒä¹Ÿå«æ•°æ®èŒƒå›´æˆæƒï¼Œå³ä¸åŒçš„ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æ“ä½œæƒé™ç›¸åŒï¼Œä½†æ˜¯èƒ½å¤Ÿæ“ä½œçš„æ•°æ®èŒƒå›´æ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<p>ä¸€ä¸ªä¾‹å­ï¼š</p>
<p>ç”¨æˆ· <code>A</code> å’Œ ç”¨æˆ· <code>B</code> éƒ½æ˜¯æ•™å­¦æœºæ„ï¼Œä»–ä»¬éƒ½æ‹¥æœ‰ â€œæˆ‘çš„è¯¾ç¨‹â€ æƒé™ï¼Œä½†æ˜¯ä¸¤ä¸ªç”¨æˆ·æ‰€æŸ¥è¯¢åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ã€‚<br>æœ¬é¡¹ç›®æœ‰å“ªäº›ç»†ç²’åº¦æˆæƒï¼Ÿ</p>
<p>æ¯”å¦‚ï¼š</p>
<p>æˆ‘çš„è¯¾ç¨‹ï¼Œæ•™å­¦æœºæ„åªå…è®¸æŸ¥è¯¢æœ¬æ•™å­¦æœºæ„ä¸‹çš„è¯¾ç¨‹ä¿¡æ¯ã€‚</p>
<p>æˆ‘çš„é€‰è¯¾ï¼Œå­¦ç”Ÿåªå…è®¸æŸ¥è¯¢è‡ªå·±æ‰€é€‰è¯¾ã€‚</p>
<p><strong>å¦‚ä½•å®ç°ç»†ç²’åº¦æˆæƒï¼Ÿ</strong></p>
<p>ç»†ç²’åº¦æˆæƒæ¶‰åŠåˆ°ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼Œé€šå¸¸åœ¨serviceå±‚å®ç°ï¼Œæ ¹æ®ä¸åŒçš„ç”¨æˆ·è¿›è¡Œæ ¡éªŒï¼Œæ ¹æ®ä¸åŒçš„å‚æ•°æŸ¥è¯¢ä¸åŒçš„æ•°æ®æˆ–æ“ä½œä¸åŒçš„æ•°æ®ã€‚</p>
<h2 id="2-æˆ‘çš„è¯¾ç¨‹ç»†ç²’åº¦æˆæƒ"><a href="#2-æˆ‘çš„è¯¾ç¨‹ç»†ç²’åº¦æˆæƒ" class="headerlink" title="2. æˆ‘çš„è¯¾ç¨‹ç»†ç²’åº¦æˆæƒ"></a>2. æˆ‘çš„è¯¾ç¨‹ç»†ç²’åº¦æˆæƒ</h2><h3 id="éœ€æ±‚åˆ†æ-1"><a href="#éœ€æ±‚åˆ†æ-1" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>1ã€æˆ‘çš„è¯¾ç¨‹æŸ¥è¯¢ï¼Œç»†ç²’åº¦æˆæƒè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·Id</li>
<li>å¾—åˆ°ç”¨æˆ·æ‰€å±æ•™è‚²æœºæ„çš„Id</li>
<li>æŸ¥è¯¢è¯¥æ•™å­¦æœºæ„ä¸‹çš„è¯¾ç¨‹ä¿¡æ¯</li>
</ul>
<p>æœ€ç»ˆå®ç°äº†ç”¨æˆ·åªå…è®¸æŸ¥è¯¢è‡ªå·±æœºæ„çš„è¯¾ç¨‹ä¿¡æ¯ã€‚</p>
<p>2ã€ä¿®æ”¹è¯¾ç¨‹ç®¡ç†æœåŠ¡ â€œ<code>æˆ‘çš„è¯¾ç¨‹</code>â€ çš„åŠŸèƒ½ï¼Œæ ¹æ® å…¬å¸ <code>Id</code> æŸ¥è¯¢è¯¾ç¨‹ï¼Œæ€è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¿®æ”¹Daoï¼Œæ”¯æŒæ ¹æ®å…¬å¸Id æŸ¥è¯¢è¯¾ç¨‹ã€‚</li>
<li>ä¿®æ”¹Serviceï¼Œå°†å…¬å¸Idä¼ å…¥Daoã€‚</li>
<li>ä¿®æ”¹Controllerï¼Œè·å–å½“å‰ç”¨æˆ·çš„å…¬å¸Idï¼Œä¼ ç»™Serviceã€‚</li>
</ul>
<p>3ã€æ•°æ®æ¨¡å‹åˆ†æå¦‚ä¸‹ï¼š</p>
<p>1ï¼‰è¯¾ç¨‹è¡¨</p>
<p>åœ¨ <code>xc_course</code> æ•°æ®åº“çš„ <code>course_base</code> è¡¨ä¸­æ·»åŠ  <code>company_id</code> å­—æ®µï¼Œæ¥è¡¨ç¤ºæ­¤è¯¾ç¨‹çš„å½’å±</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image21.png" srcset="/img/loading.gif" alt="image-20200603102939596"></p>
<p>2ï¼‰ç”¨æˆ·ä¼ä¸šè¡¨</p>
<p>åœ¨ <code>xc_user</code> æ•°æ®åº“çš„ <code>xc_company_user</code> è¡¨ä¸­è®°å½•äº†ç”¨æˆ·çš„å½’å±å…¬å¸ä¿¡æ¯</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image22.png" srcset="/img/loading.gif" alt="image-20200603102958164"></p>
<p>é€šè¿‡ xc_company_user è¡¨å¯å¾—åˆ° ç”¨æˆ· çš„æ‰€å±å…¬å¸ Idã€‚</p>
<p>å¦‚ä½•æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„è¯¾ç¨‹ï¼Ÿ</p>
<p>1ã€ç¡®å®šç”¨æˆ·çš„ Id</p>
<p>2ã€æ ¹æ®ç”¨æˆ·çš„ <code>Id</code> æŸ¥è¯¢ç”¨æˆ·å½’å±çš„å…¬å¸ã€‚</p>
<p>3ã€æ ¹æ® <code>å…¬å¸Id</code> æŸ¥è¯¢è¯¥å…¬å¸ä¸‹çš„è¯¾ç¨‹ä¿¡æ¯</p>
<p>ä¸€ä¸ªä¾‹å­ï¼š</p>
<div class="hljs"><pre><code class="hljs sql"><span class="hljs-comment">/*ç¡®å®šç”¨æˆ·çš„idï¼š49*/</span>
<span class="hljs-comment">/*æ ¹æ®ç”¨æˆ·IdæŸ¥æ‰¾æ‰€å±å…¬å¸*/</span>
<span class="hljs-comment">/*æ ¹æ®å…¬å¸æŸ¥è¯¢æ‰€æ‹¥æœ‰çš„è¯¾ç¨‹*/</span>
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> xc_course.course_base <span class="hljs-keyword">WHERE</span> company_id <span class="hljs-keyword">IN</span> (
	<span class="hljs-keyword">SELECT</span> company_id <span class="hljs-keyword">FROM</span> xc_user.xc_company_user <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-string">'49'</span>
)</code></pre></div>

<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>å®šä¹‰æˆ‘çš„è¯¾ç¨‹æŸ¥è¯¢æ¥å£å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"æŸ¥è¯¢æŒ‡å®šå…¬å¸ä¸‹çš„æ‰€æœ‰è¯¾ç¨‹"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult&lt;CourseInfo&gt; <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> page,</span></span>
<span class="hljs-function"><span class="hljs-params">    <span class="hljs-keyword">int</span> size,</span></span>
<span class="hljs-function"><span class="hljs-params">    CourseListRequest courseListRequest</span></span>
<span class="hljs-function"><span class="hljs-params">)</span></span>;</code></pre></div>

<h3 id="DAO-1"><a href="#DAO-1" class="headerlink" title="DAO"></a>DAO</h3><p>åœ¨ CourseMapper ä¸‹æ–°å¢ä¸€ä¸ª <code>findCourseListByCompany</code> æ–¹æ³•</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CourseMapper</span> </span>&#123;
   <span class="hljs-comment">//æ ¹æ®è¯¾ç¨‹idæŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯</span>
   <span class="hljs-function">CourseBase <span class="hljs-title">findCourseBaseById</span><span class="hljs-params">(String id)</span></span>;
 
   <span class="hljs-comment">/**</span>
<span class="hljs-comment">    * åˆ†é¡µæŸ¥è¯¢è¯¾ç¨‹æ•°æ®</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> courseListRequest æŸ¥è¯¢æ¡ä»¶</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">    */</span>
   <span class="hljs-function">Page&lt;CourseBase&gt; <span class="hljs-title">findCourseList</span><span class="hljs-params">(CourseListRequest courseListRequest)</span></span>;
 
   <span class="hljs-comment">/**</span>
<span class="hljs-comment">    * åˆ†é¡µæŸ¥è¯¢æŒ‡å®šå…¬å¸ä¸‹çš„è¯¾ç¨‹æ•°æ®</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@param</span> courseListRequest æŸ¥è¯¢æ¡ä»¶</span>
<span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">    */</span>
   <span class="hljs-function">Page&lt;CourseInfo&gt; <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(CourseListRequest courseListRequest)</span></span>;
 
&#125;</code></pre></div>

<p>ä¿®æ”¹ <code>CourseMapper.xml</code> çš„æŸ¥è¯¢è¯¾ç¨‹åˆ—è¡¨ï¼Œæ·»åŠ  <code>companyId</code> æ¡ä»¶ã€‚</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findCourseListByCompany"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.CourseInfo"</span></span>
<span class="hljs-tag">        <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.request.CourseListRequest"</span>&gt;</span>
    SELECT
    course_base.*,
    (SELECT pic FROM course_pic WHERE courseid = course_base.id) pic
    FROM
    course_base
    where 1=1
    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"companyId!=null and companyId!=''"</span>&gt;</span>
        and course_base.company_id = #&#123;companyId&#125;
    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></code></pre></div>

<h3 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h3><p>ä¿®æ”¹ CourseService çš„ <code>findCourseList</code> æ–¹æ³•ï¼Œæ·»åŠ  <code>companyId</code> å‚æ•°ï¼Œå¹¶ä¸”ä¼ ç»™ dao.</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * åˆ†é¡µæŸ¥è¯¢æŒ‡å®šå…¬å¸ä¸‹çš„è¯¾ç¨‹ä¿¡æ¯</span>
<span class="hljs-comment">     */</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(String companyId ,<span class="hljs-keyword">int</span> pageNum, <span class="hljs-keyword">int</span> size, CourseListRequest courseListRequest)</span></span>&#123;
    <span class="hljs-keyword">if</span>(pageNum&lt;=<span class="hljs-number">0</span>)&#123;
        pageNum = <span class="hljs-number">0</span>;
    &#125;
    <span class="hljs-keyword">if</span>(size&lt;=<span class="hljs-number">0</span>)&#123;
        size = <span class="hljs-number">20</span>;
    &#125;
    PageHelper.startPage(pageNum,size);  <span class="hljs-comment">//è®¾ç½®åˆ†é¡µå‚æ•°</span>
 
    <span class="hljs-comment">//è®¾ç½®å…¬å¸ä¿¡æ¯åˆ°æŸ¥è¯¢æ¡ä»¶å†…</span>
    courseListRequest.setCompanyId(companyId);
    Page&lt;CourseInfo&gt; courseList = courseMapper.findCourseListByCompany(courseListRequest);
    QueryResult queryResult = <span class="hljs-keyword">new</span> QueryResult();
    queryResult.setList(courseList.getResult());
    queryResult.setTotal(courseList.getTotal());
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResponseResult(CommonCode.SUCCESS,queryResult);
&#125;</code></pre></div>

<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>ä¿®æ”¹ CourseController çš„ <code>findCourseList</code>ï¼Œå‘ service ä¼ å…¥ <code>companyId</code></p>
<p>è¿™é‡Œå…ˆä½¿ç”¨é™æ€æ•°æ®æµ‹è¯•ä½¿ç”¨ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æŸ¥è¯¢æŒ‡å®šå…¬å¸ä¸‹çš„æ‰€æœ‰è¯¾ç¨‹</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page é¡µç </span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size æ•°é‡</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseListRequest æŸ¥è¯¢å‚æ•°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coursebase/company/list/&#123;page&#125;/&#123;size&#125;"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    @PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,</span>
<span class="hljs-function">    @<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size,</span>
<span class="hljs-function">    CourseListRequest courseListRequest</span>
<span class="hljs-function">)</span>&#123;
    String companyId = <span class="hljs-string">"1"</span>;
    <span class="hljs-keyword">return</span> courseService.findCourseListByCompany(companyId, page, size, courseListRequest);
&#125;</code></pre></div>

<h3 id="è¯¾ç¨‹æŸ¥è¯¢å‰ç«¯ä¿®æ”¹"><a href="#è¯¾ç¨‹æŸ¥è¯¢å‰ç«¯ä¿®æ”¹" class="headerlink" title="è¯¾ç¨‹æŸ¥è¯¢å‰ç«¯ä¿®æ”¹"></a>è¯¾ç¨‹æŸ¥è¯¢å‰ç«¯ä¿®æ”¹</h3><p>ä¿®æ”¹ <code>xc-ui-pc-teach/src/module/course/api/course.js</code> ä¸­æŸ¥è¯¢è¯¾ç¨‹çš„API ä¸æˆ‘ä»¬å‰é¢æ„å»ºçš„ controller å¯¹åº”</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//æˆ‘çš„è¯¾ç¨‹åˆ—è¡¨</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> findCourseList = <span class="hljs-function">(<span class="hljs-params">page,size,params</span>) =&gt;</span> &#123;
<span class="hljs-comment">//ä½¿ç”¨å·¥å…·ç±»å°†jsonå¯¹è±¡è½¬æˆkey/value</span>
  <span class="hljs-keyword">let</span> queries = querystring.stringify(params)
  <span class="hljs-keyword">return</span> http.requestQuickGet(apiUrl+<span class="hljs-string">"/course/coursebase/company/list/"</span>+page+<span class="hljs-string">"/"</span>+size+<span class="hljs-string">"?"</span>+queries)
&#125;</code></pre></div>

<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>è¿›å…¥æˆ‘çš„è¯¾ç¨‹ï¼ŒæŸ¥çœ‹æ•°æ®æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>ç”±äºæˆ‘ä»¬åœ¨ <code>controller</code> ä¸­æš‚æ—¶å°† <code>company</code> çš„å›ºå®šçš„å†™ä¸ºäº†1ï¼Œæ‰€ä»¥é¢„æœŸçš„ç»“æœåº”è¯¥æ˜¯æŸ¥è¯¢åˆ° company ä¸º1çš„æ‰€æœ‰è¯¾ç¨‹ï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image23.png" srcset="/img/loading.gif" alt="image-20200603141305638"></p>
<p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼Œå¾—åˆ°äº†é¢„æœŸçš„ç»“æœ</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image24.png" srcset="/img/loading.gif" alt="image-20200603141347386"></p>
<h2 id="3-è·å–å½“å‰ä¿¡æ¯"><a href="#3-è·å–å½“å‰ä¿¡æ¯" class="headerlink" title="3. è·å–å½“å‰ä¿¡æ¯"></a>3. è·å–å½“å‰ä¿¡æ¯</h2><p>è¦æƒ³å®ç°åªæŸ¥è¯¢è‡ªå·±çš„è¯¾ç¨‹ä¿¡æ¯ï¼Œåˆ™éœ€è¦è·å–å½“å‰ç”¨æˆ·æ‰€å±çš„ä¼ä¸šidã€‚</p>
<p>1ã€è®¤è¯æœåŠ¡åœ¨ç”¨æˆ·è®¤è¯é€šè¿‡å°†ç”¨æˆ·æ‰€å±å…¬å¸idç­‰ä¿¡æ¯å­˜å‚¨åˆ°jwtä»¤ç‰Œä¸­ã€‚</p>
<p>2ã€ç”¨æˆ·è¯·æ±‚åˆ°è¾¾èµ„æºæœåŠ¡åï¼Œèµ„æºæœåŠ¡éœ€è¦å–å‡ºheaderä¸­çš„jwtä»¤ç‰Œï¼Œå¹¶è§£æå‡ºç”¨æˆ·ä¿¡æ¯ã€‚</p>
<h3 id="JWTä»¤ç‰ŒåŒ…æ‹¬ä¼ä¸šId"><a href="#JWTä»¤ç‰ŒåŒ…æ‹¬ä¼ä¸šId" class="headerlink" title="JWTä»¤ç‰ŒåŒ…æ‹¬ä¼ä¸šId"></a>JWTä»¤ç‰ŒåŒ…æ‹¬ä¼ä¸šId</h3><p>èµ„æºæœåŠ¡åœ¨æˆæƒæ—¶éœ€è¦ç”¨åˆ°ç”¨æˆ·æ‰€å±ä¼ä¸š <code>ID</code>ï¼Œéœ€è¦å®ç°è®¤è¯æœåŠ¡ç”Ÿæˆçš„JWTä»¤ç‰Œä¸­åŒ…æ‹¬ç”¨æˆ·æ‰€å±å…¬å¸ <code>id</code> ä¿¡æ¯ã€‚</p>
<p>æŸ¥çœ‹è®¤è¯æœåŠ¡ <code>UserDetailServiceImpl</code> ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java">......
<span class="hljs-comment">//ç”¨æˆ·id</span>
userDetails.setId(userext.getId());
<span class="hljs-comment">//ç”¨æˆ·åç§°</span>
userDetails.setName(userext.getName());
<span class="hljs-comment">//ç”¨æˆ·å¤´åƒ</span>
userDetails.setUserpic(userext.getUserpic());
<span class="hljs-comment">//ç”¨æˆ·ç±»å‹</span>
userDetails.setUtype(userext.getUtype());
<span class="hljs-comment">//ç”¨æˆ·æ‰€å±ä¼ä¸šid</span>
userDetails.setCompanyId(userext.getCompanyId());
<span class="hljs-keyword">return</span> userDetails;
......</code></pre></div>

<p>é€šè¿‡ä¸Šè¾¹ä»£ç çš„åˆ†æå¾—çŸ¥ï¼Œè®¤è¯æœåŠ¡è°ƒç”¨è¿œç¨‹è°ƒç”¨ ucenter æœåŠ¡çš„ <code>getUserext</code> æ¥å£è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å°† <code>userext</code> ä¸­çš„ä¿¡æ¯å­˜å‚¨åˆ°jwtä»¤ç‰Œä¸­ï¼Œæ‰€ä»¥åœ¨åœ¨ getUserext æ¥å£ä¸­è¿”å›çš„ <code>userext</code> å¯¹è±¡ä¸­éœ€è¦åŒ…æ‹¬äº† <code>companyId</code> å…¬å¸IDç­‰ä¿¡æ¯ ã€‚</p>
<p>getUserExt çš„ä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·æƒé™çš„å®ç°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username ç”¨æˆ·å</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserExt</span><span class="hljs-params">(String username)</span> </span>&#123;
    <span class="hljs-comment">//æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span>
    XcUser xcUser = <span class="hljs-keyword">this</span>.findXcUserByUsername(username);
    <span class="hljs-keyword">if</span>(xcUser ==<span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
 
    XcUserExt xcUserExt = <span class="hljs-keyword">new</span> XcUserExt();
    BeanUtils.copyProperties(xcUser,xcUserExt);
 
    <span class="hljs-comment">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æ‰€å±å…¬å¸</span>
    String xcUserId = xcUser.getId();
    XcCompanyUser xcCompanyUser = xcCompanyUserRepository.findByUserId(xcUserId);
    <span class="hljs-keyword">if</span>(xcCompanyUser!=<span class="hljs-keyword">null</span>)&#123;
        String companyId = xcCompanyUser.getCompanyId();
        xcUserExt.setCompanyId(companyId);
    &#125;
 
    <span class="hljs-comment">//è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™</span>
    List&lt;XcMenu&gt; xcMenus = xcMenuMapper.selectPermissionByUserId(xcUserId);
    xcUserExt.setPermissions(xcMenus);
 
    <span class="hljs-comment">//è¿”å›XcUserExtå¯¹è±¡</span>
    <span class="hljs-keyword">return</span> xcUserExt;
&#125;</code></pre></div>

<p><code>getUserExt</code> æ˜¯åœ¨ç”¨æˆ·è¿›è¡Œè®¤è¯æ—¶è¢«è°ƒç”¨çš„ï¼Œç”± <code>ucenter-auth</code> æœåŠ¡å‘ <code>ucenter</code> æœåŠ¡è°ƒç”¨è¯¥æ¥å£ï¼Œè·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åå°†å¾—åˆ°çš„è¿™äº›ä¿¡æ¯ æ‰“åŒ…ä¸º <code>UserJwt</code> å¯¹è±¡äº¤ç”± Spring Security è¿›è¡Œæ ¡éªŒï¼Œæ ¡éªŒé€šè¿‡åä¼šå°†è¯¥JWTä»¤ç‰Œåˆ°è®¤è¯æœåŠ¡ä¸­ï¼Œæ ¡éªŒ Spring Security è¿”å›çš„ <code>JWT</code>ä»¤ç‰Œå®Œæ•´æ€§åå†™å…¥åˆ° redisã€‚</p>
<h3 id="è§£æä»¤ç‰Œä¸­çš„ä¿¡æ¯"><a href="#è§£æä»¤ç‰Œä¸­çš„ä¿¡æ¯" class="headerlink" title="è§£æä»¤ç‰Œä¸­çš„ä¿¡æ¯"></a>è§£æä»¤ç‰Œä¸­çš„ä¿¡æ¯</h3><h4 id="1ã€JWTè§£æå·¥å…·ç±»"><a href="#1ã€JWTè§£æå·¥å…·ç±»" class="headerlink" title="1ã€JWTè§£æå·¥å…·ç±»"></a>1ã€JWTè§£æå·¥å…·ç±»</h4><p>1ã€åœ¨ <code>Oauth2Util</code> å·¥å…·ç±»ä¸­ï¼Œä» header ä¸­å–å‡ºJWTä»¤ç‰Œï¼Œå¹¶è§£æ <code>JWT</code> ä»¤ç‰Œçš„å†…å®¹ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Oauth2Util</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String,String&gt; <span class="hljs-title">getJwtClaimsFromHeader</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;
        <span class="hljs-keyword">if</span> (request == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        
        <span class="hljs-comment">//å–å‡ºå¤´ä¿¡æ¯</span>
        String authorization = request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(authorization) || authorization.indexOf(<span class="hljs-string">"Bearer"</span>) &lt; <span class="hljs-number">0</span>) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        
        <span class="hljs-comment">//ä»Beareråè¾¹å¼€å§‹å–å‡ºtoken</span>
        String token = authorization.substring(<span class="hljs-number">7</span>);
        Map&lt;String,String&gt; map = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//è§£æjwt</span>
            Jwt decode = JwtHelper.decode(token);
            <span class="hljs-comment">//å¾—åˆ° jwtä¸­çš„ç”¨æˆ·ä¿¡æ¯</span>
            String claims = decode.getClaims();
            <span class="hljs-comment">//å°†jwtè½¬ä¸ºMap</span>
            map = JSON.parseObject(claims, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
        &#125; 
        <span class="hljs-keyword">return</span> map;
    &#125;
&#125;</code></pre></div>

<p>2ã€åœ¨ <code>XcOauth2Util</code> å·¥å…·ç±»ä¸­ï¼Œå°†è§£æçš„ <code>JWT</code> å†…å®¹å°è£…æˆ <code>UserJwt</code> å¯¹è±¡è¿”å›ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XcOauth2Util</span> </span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserJwt <span class="hljs-title">getUserJwtFromHeader</span><span class="hljs-params">(HttpServletRequest request)</span></span>&#123;
        Map&lt;String, String&gt; jwtClaims = Oauth2Util.getJwtClaimsFromHeader(request);
        <span class="hljs-keyword">if</span>(jwtClaims == <span class="hljs-keyword">null</span> || StringUtils.isEmpty(jwtClaims.get(<span class="hljs-string">"id"</span>)))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125; 
        UserJwt userJwt = <span class="hljs-keyword">new</span> UserJwt();
        userJwt.setId(jwtClaims.get(<span class="hljs-string">"id"</span>));
        userJwt.setName(jwtClaims.get(<span class="hljs-string">"name"</span>));
        userJwt.setCompanyId(jwtClaims.get(<span class="hljs-string">"companyId"</span>));
        userJwt.setUtype(jwtClaims.get(<span class="hljs-string">"utype"</span>));
        userJwt.setUserpic(jwtClaims.get(<span class="hljs-string">"userpic"</span>));
        <span class="hljs-keyword">return</span> userJwt;
    &#125; 
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserJwt</span></span>&#123;
        <span class="hljs-keyword">private</span> String id;
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String userpic;
        <span class="hljs-keyword">private</span> String utype;
        <span class="hljs-keyword">private</span> String companyId;
    &#125;
&#125;</code></pre></div>

<h4 id="2ã€è·å–å½“å‰ç”¨æˆ·"><a href="#2ã€è·å–å½“å‰ç”¨æˆ·" class="headerlink" title="2ã€è·å–å½“å‰ç”¨æˆ·"></a>2ã€è·å–å½“å‰ç”¨æˆ·</h4><p>ä¿®æ”¹è¯¾ç¨‹ç®¡ç†çš„ CourseController ç±»ï¼Œå°† <code>companyId</code> çš„é™æ€æ•°æ®æ”¹ä¸ºåŠ¨æ€è·å–ï¼š</p>
<p>é…ç½® <code>CourseController</code> ç»§æ‰¿ <code>BaseController</code> ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªç”¨æˆ·è¯·æ±‚æ—¶çš„ request å¯¹è±¡</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CourseContorller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CourseControllerApi</span> </span>&#123;
	...
&#125;</code></pre></div>

<p>åœ¨ <code>findCourseListByCompany</code> ä¸­è°ƒç”¨å‰é¢æˆ‘ä»¬å®šä¹‰çš„å·¥å…·ç±»ï¼Œä»ç”¨æˆ·çš„ <code>header</code> ä¿¡æ¯ä¸­å–å‡º JWT ä»¤ç‰Œå¹¶ä¸”è§£æå‡ºç”¨æˆ·çš„ä¿¡æ¯ï¼Œæ‹¿åˆ°ç”¨æˆ·æ‰€å±çš„å…¬å¸ <code>ID</code>ï¼Œå®ç°ç»†ç²’åº¦çš„è¯¾ç¨‹ä¿¡æ¯è·å–ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æŸ¥è¯¢æŒ‡å®šå…¬å¸ä¸‹çš„æ‰€æœ‰è¯¾ç¨‹</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page é¡µç </span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size æ•°é‡</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> courseListRequest æŸ¥è¯¢å‚æ•°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/coursebase/company/list/&#123;page&#125;/&#123;size&#125;"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findCourseListByCompany</span><span class="hljs-params">(</span></span>
<span class="hljs-function"><span class="hljs-params">    @PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,</span>
<span class="hljs-function">    @<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size,</span>
<span class="hljs-function">    CourseListRequest courseListRequest</span>
<span class="hljs-function">)</span>&#123;
    <span class="hljs-comment">//è°ƒç”¨å·¥å…·ç±»å–å‡ºç”¨æˆ·ä¿¡æ¯</span>
    XcOauth2Util xcOauth2Util = <span class="hljs-keyword">new</span> XcOauth2Util();
    <span class="hljs-comment">//ä»ç”¨æˆ·headerä¸­é™„å¸¦çš„jwtä»¤ç‰Œå–å‡ºç”¨æˆ·ä¿¡æ¯</span>
    XcOauth2Util.UserJwt userJwt = xcOauth2Util.getUserJwtFromHeader(request);
    <span class="hljs-comment">//ä»ç”¨æˆ·ä¿¡æ¯è·å–è¯¥ç”¨æˆ·æ‰€å±çš„å…¬å¸idï¼Œæ ¹æ®è¯¥å…¬å¸idæŸ¥è¯¢è¯¥å…¬å¸ä¸‹çš„æ‰€æœ‰è¯¾ç¨‹</span>
    String companyId = userJwt.getCompanyId();
    <span class="hljs-keyword">return</span> courseService.findCourseListByCompany(companyId, page, size, courseListRequest);
&#125;</code></pre></div>

<h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ä½¿ç”¨ä¸åŒçš„ç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼Œæµ‹è¯•ç»†ç²’åº¦æƒé™æ§åˆ¶æ•ˆæœã€‚</p>
<p>é¢„æœŸç»“æœï¼šæ¯ä¸ªç”¨æˆ·åªæŸ¥è¯¢è‡ªå·±æ‰€æ‹¥æœ‰çš„è¯¾ç¨‹ã€‚</p>
<p>å…¬å¸1çš„ç”¨æˆ·</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image25.png" srcset="/img/loading.gif" alt="image-20200603150544501"></p>
<p>å…¬å¸2çš„ç”¨æˆ·</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image26.png" srcset="/img/loading.gif" alt="image-20200603150423751"></p>
<h1 id="å…­ã€å¾®æœåŠ¡é—´è®¤è¯"><a href="#å…­ã€å¾®æœåŠ¡é—´è®¤è¯" class="headerlink" title="å…­ã€å¾®æœåŠ¡é—´è®¤è¯"></a>å…­ã€å¾®æœåŠ¡é—´è®¤è¯</h1><h2 id="1-éœ€æ±‚åˆ†æ-4"><a href="#1-éœ€æ±‚åˆ†æ-4" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>å‰è¾¹ç« èŠ‚å·²ç»å®ç°äº†ç”¨æˆ·æºå¸¦èº«ä»½ä»¤ç‰Œï¼ˆJTIï¼‰ å’Œ <code>JWT</code>ï¼ˆaccess_tokenï¼‰ ä»¤ç‰Œè®¿é—®å¾®æœåŠ¡ï¼Œå¾®æœåŠ¡è·å– <code>jwt</code> å¹¶å®Œæˆæˆæƒã€‚å½“å¾®æœåŠ¡è®¿é—®å¾®æœåŠ¡ï¼Œæ­¤æ—¶å¦‚æœæ²¡æœ‰æºå¸¦ <code>JWT</code> åˆ™å¾®æœåŠ¡ä¼šåœ¨æˆæƒæ—¶æŠ¥é”™ã€‚</p>
<p>æµ‹è¯•è¯¾ç¨‹é¢„è§ˆï¼š</p>
<p>1ã€å°†è¯¾ç¨‹ç®¡ç†æœåŠ¡å’ŒCMSå…¨éƒ¨æ·»åŠ æˆæƒé…ç½®</p>
<p>2ã€ç”¨æˆ·ç™»å½•æ•™å­¦ç®¡ç†å‰ç«¯ï¼Œè¿›å…¥è¯¾ç¨‹å‘å¸ƒç•Œé¢ï¼Œç‚¹å‡»è¯¾ç¨‹å‘å¸ƒï¼Œè§‚å¯Ÿè¯¾ç¨‹ç®¡ç†æœåŠ¡ç«¯æŠ¥é”™å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs json">feign.FeignException: status 401 reading CmsPageClient#save(CmsPage); content:
&#123;<span class="hljs-attr">"error"</span>:<span class="hljs-string">"unauthorized"</span>,<span class="hljs-attr">"error_description"</span>:<span class="hljs-string">"Full authentication is required to access thisresource"</span>&#125;</code></pre></div>

<p>åˆ†æåŸå› ï¼š</p>
<p>ç”±äºè¯¾ç¨‹ç®¡ç†è®¿é—® <code>CMS</code> æ—¶æ²¡æœ‰æºå¸¦ <code>JWT</code> ä»¤ç‰Œå¯¼è‡´ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p>å¾®æœåŠ¡ä¹‹é—´è¿›è¡Œè°ƒç”¨æ—¶éœ€æºå¸¦ <code>JWT</code>ã€‚</p>
<h2 id="2-Feign-æ‹¦æˆªå™¨"><a href="#2-Feign-æ‹¦æˆªå™¨" class="headerlink" title="2. Feign æ‹¦æˆªå™¨"></a>2. Feign æ‹¦æˆªå™¨</h2><p>å¾®æœåŠ¡ä¹‹é—´ä½¿ç”¨ <code>feign</code> è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œé‡‡ç”¨ <code>feign</code> æ‹¦æˆªå™¨å®ç°è¿œç¨‹è°ƒç”¨æºå¸¦ JWTã€‚</p>
<p>åœ¨ common å·¥ç¨‹æ·»åŠ ä¾èµ–ï¼š</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springâ€cloudâ€starterâ€openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<h3 id="å®šäºFeignæ‹¦æˆªå™¨"><a href="#å®šäºFeignæ‹¦æˆªå™¨" class="headerlink" title="å®šäºFeignæ‹¦æˆªå™¨"></a>å®šäºFeignæ‹¦æˆªå™¨</h3><p>åœ¨ <code>Common</code> å·¥ç¨‹å®šä¹‰æ‹¦æˆªå™¨å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.interceptor;
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignClientInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RequestInterceptor</span> </span>&#123;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//ä½¿ç”¨RequestContextHolderå·¥å…·è·å–requestç›¸å…³å˜é‡</span>
            ServletRequestAttributes attributes = (ServletRequestAttributes)
                RequestContextHolder.getRequestAttributes();
            <span class="hljs-keyword">if</span>(attributes!=<span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//å–å‡ºrequest</span>
                HttpServletRequest request = attributes.getRequest();
                Enumeration&lt;String&gt; headerNames = request.getHeaderNames();
                <span class="hljs-keyword">if</span> (headerNames != <span class="hljs-keyword">null</span>) &#123;
                    <span class="hljs-keyword">while</span> (headerNames.hasMoreElements()) &#123;
                        String name = headerNames.nextElement();
                        String values = request.getHeader(name);
                        <span class="hljs-keyword">if</span>(name.equals(<span class="hljs-string">"authorization"</span>))&#123;
                            <span class="hljs-comment">//System.out.println("name="+name+"values="+values);</span>
                            requestTemplate.header(name, values);
                        &#125;
                    &#125;
                &#125;
            &#125;
        &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTace();
        &#125;
    &#125;
&#125;</code></pre></div>

<h3 id="ä½¿ç”¨Feignæ‹¦æˆªå™¨"><a href="#ä½¿ç”¨Feignæ‹¦æˆªå™¨" class="headerlink" title="ä½¿ç”¨Feignæ‹¦æˆªå™¨"></a>ä½¿ç”¨Feignæ‹¦æˆªå™¨</h3><p>æœ¬ä¾‹å­ä¸­è¯¾ç¨‹ç®¡ç†è°ƒç”¨ <code>cms</code> éœ€è¦æºå¸¦ <code>jwt</code>ï¼Œæ‰€ä»¥éœ€è¦åœ¨è¯¾ç¨‹ç®¡ç†ä¸­å®šä¹‰ <code>Feign</code> æ‹¦æˆªå™¨ <code>bean</code>ï¼Œåœ¨å¯åŠ¨ç±»ä¸­å®šä¹‰ <code>bean</code> å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> FeignClientInterceptor <span class="hljs-title">feignClientInterceptor</span><span class="hljs-params">()</span></span>&#123;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FeignClientInterceptor();
&#125;</code></pre></div>

<h3 id="ä½¿ç”¨restTemplateè®¿é—®å…¶ä»–æœåŠ¡æ¥å£è¢«æ‹¦æˆªçš„è§£å†³æ–¹æ¡ˆ"><a href="#ä½¿ç”¨restTemplateè®¿é—®å…¶ä»–æœåŠ¡æ¥å£è¢«æ‹¦æˆªçš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä½¿ç”¨restTemplateè®¿é—®å…¶ä»–æœåŠ¡æ¥å£è¢«æ‹¦æˆªçš„è§£å†³æ–¹æ¡ˆ"></a>ä½¿ç”¨restTemplateè®¿é—®å…¶ä»–æœåŠ¡æ¥å£è¢«æ‹¦æˆªçš„è§£å†³æ–¹æ¡ˆ</h3><p>åœ¨å‘å¸ƒè¯¾ç¨‹æ—¶ï¼ŒcmsæœåŠ¡ä½¿ç”¨ restTeamlate å‘æ•°æ®æ¨¡å‹URLå‘é€è¯·æ±‚è·å–æ•°æ®ï¼Œè¯¥æ“ä½œæ¶‰åŠåˆ°è°ƒç”¨è¯¾ç¨‹ç®¡ç†æœåŠ¡çš„æ¥å£ï¼Œç”±äºè¯¾ç¨‹ç®¡ç†æœåŠ¡å¼€å¯äº†æ¥å£è®¤è¯ï¼Œæ‰€æœ‰æ²¡é™„å¸¦ JWT ä»¤ç‰Œçš„è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image27.png" srcset="/img/loading.gif" alt="image-20200603171728929"></p>
<h4 id="æ–¹æ¡ˆ1"><a href="#æ–¹æ¡ˆ1" class="headerlink" title="æ–¹æ¡ˆ1"></a>æ–¹æ¡ˆ1</h4><p>åœ¨è¯¾ç¨‹ç®¡ç†æœåŠ¡ä¸­æ”¾è¡Œè¯¥URLçš„è®¤è¯æ‹¦æˆªï¼Œé€šå¸¸è¯¥æ¥å£æ˜¯å¯ä»¥ä¸éœ€è¦è®¤è¯çš„ã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image28.png" srcset="/img/loading.gif" alt="image-20200603172432245"></p>
<p>åœ¨è¯¾ç¨‹ç®¡ç†æœåŠ¡çš„ <code>ResourceServerConfig</code> ä¸­é…ç½® <code>configure</code> æ–¹æ³•ï¼Œæ”¾è¡Œ <code>/course/preview/model</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oauth2.urlMatchers&#125;"</span>)
String urlMatchers;
 
<span class="hljs-comment">//Httpå®‰å…¨é…ç½®ï¼Œå¯¹æ¯ä¸ªåˆ°è¾¾ç³»ç»Ÿçš„httpè¯·æ±‚é“¾æ¥è¿›è¡Œæ ¡éªŒ</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-keyword">if</span>(urlMatchers.equals(<span class="hljs-string">""</span>))&#123;
        <span class="hljs-comment">//å¦‚æœurlMatchersæœªæŒ‡å®š,åˆ™æ‰€æœ‰urléƒ½éœ€è¦æˆæƒåæ‰èƒ½è¢«è®¿é—®</span>
        http.authorizeRequests().anyRequest().authenticated();
    &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-comment">//æ”¾è¡Œ urlMatchers ä¸­æŒ‡å®šçš„urlæ¡ç›®, æœªæŒ‡å®šçš„urlä»éœ€æˆæƒåæ‰èƒ½è®¿é—®</span>
        <span class="hljs-keyword">if</span>(urlMatchers != <span class="hljs-keyword">null</span>)&#123;
            String[] split = urlMatchers.split(<span class="hljs-string">","</span>);
            http.authorizeRequests()
                <span class="hljs-comment">//ä¸‹è¾¹çš„è·¯å¾„æ”¾è¡Œ</span>
                .antMatchers(split).permitAll()
                .anyRequest().authenticated();
        &#125;
    &#125;
&#125;</code></pre></div>

<p>æˆ‘è¿™é‡Œéœ€è¦æ”¾è¡Œçš„URLæ˜¯ä» appliaction.yml ä¸­å°† <code>oauth2.urlMatchers</code> æ³¨å…¥åˆ°å˜é‡ <code>urlMatchers</code> å†…ï¼Œå†…å®¹å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">oauth2:</span>
  <span class="hljs-attr">urlMatchers:</span> <span class="hljs-string">/v2/api-docs,/swagger-resources/configuration/ui,/swagger-resources,/swagger-resources/configuration/security,/swagger-ui.html,/webjars/**,/course/coursepic/get/*</span></code></pre></div>

<h4 id="æ–¹æ¡ˆ2"><a href="#æ–¹æ¡ˆ2" class="headerlink" title="æ–¹æ¡ˆ2"></a>æ–¹æ¡ˆ2</h4><p>è·å–å½“å‰è¯·æ±‚çš„ <code>request</code> å¯¹è±¡ï¼Œä»è¯¥å¯¹è±¡ä¸­å–å‡ºå½“å‰è¯·æ±‚ä¸­ <code>header</code> ä¿¡æ¯é‡Œé¢åŒ…å«çš„ <code>authorization</code> å­—æ®µï¼Œè¯¥å­—æ®µå†…å¸¦æœ‰äº†æˆ‘ä»¬è®¤è¯éœ€è¦çš„ <code>JWT</code> ä»¤ç‰Œä¿¡æ¯ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//ä»dataUrlä¸­è·å–é¡µé¢æ¨¡å‹æ•°æ®</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> Map <span class="hljs-title">getModelByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
    <span class="hljs-comment">//æŸ¥è¯¢é¡µé¢ä¿¡æ¯</span>
    CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
    CmsPage cmsPage = cmsPageResult.getCmsPage();
    <span class="hljs-comment">//é¡µé¢ä¸å­˜åœ¨</span>
    <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
    &#125;
    <span class="hljs-comment">//å–å‡ºdataUrl</span>
    String dataUrl = cmsPage.getDataUrl();
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(dataUrl))&#123;
        ExceptionCast.cast(CmsCode.CMS_GENRATEHTML_DATAURL_IS_NULL);
    &#125;
    
    <span class="hljs-comment">//é€šè¿‡è·å–å½“å‰è¯·æ±‚çš„requestå¯¹è±¡æ¥å–å‡ºjwtè®¤è¯ä¿¡æ¯,å¹¶ä¸”ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªè¯·æ±‚ä¸­</span>
    ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
    HttpServletRequest request = attributes.getRequest();
    String jwt = request.getHeader(<span class="hljs-string">"authorization"</span>);
    <span class="hljs-comment">//ä½¿ç”¨LinkedMultiValueMapå‚¨å­˜å¤šä¸ªheaderä¿¡æ¯</span>
    LinkedMultiValueMap&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();
    headers.add(<span class="hljs-string">"authorization"</span>,jwt);
    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(headers);
    
    <span class="hljs-comment">//å‘é€è¯·æ±‚è·å–æ¨¡å‹æ•°æ®</span>
    ResponseEntity&lt;Map&gt; forEntity = restTemplate.exchange(dataUrl, HttpMethod.GET,httpEntity,Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    Map body = forEntity.getBody();
    <span class="hljs-keyword">return</span> body;
&#125;</code></pre></div>

<h4 id="æ–¹æ¡ˆ3"><a href="#æ–¹æ¡ˆ3" class="headerlink" title="æ–¹æ¡ˆ3"></a>æ–¹æ¡ˆ3</h4><p>å°† <code>CMS</code> æœåŠ¡ä¸­è°ƒç”¨ <code>è¯¾ç¨‹ç®¡ç†æœåŠ¡</code> çš„æ•°æ®æ¨¡å‹æ¥å£æ›´æ”¹ä¸ºä½¿ç”¨ <code>Feign</code> æ¥è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œå†ç»“åˆå‰é¢é…ç½®çš„ <code>Feign</code> æ‹¦æˆªå™¨å®ç° Header ä¿¡æ¯çš„å‘ä¸‹ä¼ é€’ã€‚</p>
<p>ç”±äºæ•°æ®æ¨¡å‹æ¥å£éœ€è¦çš„å‚æ•°æ˜¯è¯¾ç¨‹IDï¼Œä½†CmsPageå¯¹è±¡ä¸­æ²¡æœ‰æ˜ç¡®çš„ç»™å‡ºè¯¥é¡µé¢å¯¹åº”çš„è¯¾ç¨‹IDï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé¡µé¢çš„åç§°å…¶å®å°±æ˜¯ä»¥è¯¾ç¨‹IDæ‰€å‘½åçš„ï¼Œå¦‚ä¸‹å›¾</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image29.png" srcset="/img/loading.gif" alt="image-20200603182403327"></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä» <code>pageName</code> ä¸­å–å‡ºè¯¾ç¨‹IDè¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java">String[] pageNameSplit = cmsPageName.split(<span class="hljs-string">"\\."</span>);
String courseId = pageNameSplit[<span class="hljs-number">0</span>];</code></pre></div>

<blockquote>
<p>è¿™é‡Œè¦æ³¨æ„å¦‚æœä»¥ <code>.</code> å¯¹å­—ç¬¦ä¸²è¿›è¡Œåˆ†å‰²ï¼Œéœ€è¦åœ¨ç‚¹å·å‰é¢åŠ ä¸¤ä¸ªæ–œæ ï¼Œå¦‚ <code>\\.</code></p>
</blockquote>
<p>åœ¨ä¹‹å‰çš„ä»£ç ä¸­ï¼Œä½¿ç”¨ <code>RestTemplate</code> è®¿é—®çš„æ•°æ®æ¨¡å‹æ¥å£è¿”å›çš„æ˜¯ä¸€ä¸ª <code>map</code> ç±»å‹çš„æ•°æ®ï¼Œè€Œå¦‚æœé‡‡ç”¨è¿œç¨‹è°ƒç”¨çš„æ–¹å¼ï¼Œæ‹¿åˆ°çš„æ˜¯ä¸€ä¸ª <code>CourseView</code> å¯¹è±¡ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>JSONObject.toJSONString</code> å°†å¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå†ä½¿ç”¨ <code>parseObject</code> å°†JSONå½¢å¼çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º <code>Map</code> å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java">JSONObject.parseObject(JSONObject.toJSONString(courseView), Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span></code></pre></div>

<p>ä¿®æ”¹åçš„å…¨éƒ¨ä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//ä»dataUrlä¸­è·å–é¡µé¢æ¨¡å‹æ•°æ®</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> Map <span class="hljs-title">getModelByPageId</span><span class="hljs-params">(String pageId)</span></span>&#123;
    <span class="hljs-comment">//æŸ¥è¯¢é¡µé¢ä¿¡æ¯</span>
    CmsPageResult cmsPageResult = <span class="hljs-keyword">this</span>.cmsPageQueryById(pageId);
    CmsPage cmsPage = cmsPageResult.getCmsPage();
 
    <span class="hljs-comment">//é¡µé¢ä¸å­˜åœ¨</span>
    <span class="hljs-keyword">if</span>(cmsPage == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NOT_EXISTS);
    &#125;
    String cmsPageName = cmsPage.getPageName();
    <span class="hljs-keyword">if</span>(cmsPageName == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CmsCode.CMS_PAGE_NAME_NOT_EXISTS);
    &#125;
    String[] pageNameSplit = cmsPageName.split(<span class="hljs-string">"\\."</span>);
    String courseId = pageNameSplit[<span class="hljs-number">0</span>];
    CourseView courseView = courseManageClient.courseView(courseId);
    Map body = JSONObject.parseObject(JSONObject.toJSONString(courseView), Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-comment">//        ResponseEntity&lt;Map&gt; forEntity = restTemplate.getForEntity(dataUrl,Map.class);</span>
    <span class="hljs-comment">//        Map body = forEntity.getBody();</span>
    <span class="hljs-comment">//        courseManageClient.courseView(cmsPage.)</span>
    <span class="hljs-keyword">return</span> body;
&#125;</code></pre></div>

<h3 id="æµ‹è¯•-2"><a href="#æµ‹è¯•-2" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>æ‰§è¡Œè¯¾ç¨‹å‘å¸ƒï¼Œæç¤ºå‘å¸ƒæˆåŠŸã€‚</p>
<p><img src="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/image30.png" srcset="/img/loading.gif" alt="image-20200603191048332"></p>
<h1 id="ä¸ƒã€æå‡ºä¸€äº›é—®é¢˜"><a href="#ä¸ƒã€æå‡ºä¸€äº›é—®é¢˜" class="headerlink" title="ä¸ƒã€æå‡ºä¸€äº›é—®é¢˜"></a>ä¸ƒã€æå‡ºä¸€äº›é—®é¢˜</h1><p>1ã€JWTæ—¶é—´ç›®å‰æ˜¯ç”± <code>redis</code> æ¥è¿›è¡Œæ§åˆ¶ï¼Œé‚£ä¹ˆ <code>jwt</code>ä»¤ç‰Œçš„å®é™…è¿‡æœŸæ—¶é—´æ˜¯å¤šä¹…ï¼Ÿ å¦‚ä½•è·å–æˆ–è€…è®¾ç½®ï¼Ÿ</p>
<p>2ã€ç”ŸæˆJWTçš„å…¬é’¥å’Œç§é’¥éƒ½æœ‰å“ªäº›ä½œç”¨ï¼Ÿ</p>
<p>å…¬é’¥ï¼šç”¨äºæ ¡éªŒJWTä»¤ç‰Œæ˜¯å¦å®Œæ•´ï¼Œä»¥åŠè§£å¯†JWTä»¤ç‰Œä¸­çš„ç”¨æˆ·ä¿¡æ¯</p>
<p>ç§é’¥ï¼šç”ŸæˆåŠ å¯†åçš„JWTä»¤ç‰Œ</p>
<h1 id="å…«ã€å¾…å®Œå–„çš„ä¸€äº›åŠŸèƒ½"><a href="#å…«ã€å¾…å®Œå–„çš„ä¸€äº›åŠŸèƒ½" class="headerlink" title="å…«ã€å¾…å®Œå–„çš„ä¸€äº›åŠŸèƒ½"></a>å…«ã€å¾…å®Œå–„çš„ä¸€äº›åŠŸèƒ½</h1><ul>
<li>ä¸º swagger-ui é…ç½®è®¤è¯æˆæƒï¼Œä½¿æ¥å£æ–‡æ¡£æš´éœ²åœ¨å¤–éƒ¨æ—¶éœ€è¦è¿›è¡Œç™»å½•è®¤è¯ï¼Œæé«˜å®‰å…¨æ€§ã€‚</li>
</ul>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">å­¦æˆåœ¨çº¿</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Feign/">Feign</a>
                    
                      <a class="hover-with-bg" href="/tags/Spring-Security/">Spring Security</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/">
                        <span class="hidden-mobile">å­¦æˆåœ¨çº¿day17ï¼šåŸºäºZuulç½‘å…³å®ç°è·¯ç”±è½¬å‘ã€è¿‡æ»¤å™¨</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

ä»£ç å—js ç”¨ä¸åˆ°ï¼Œfulidè‡ªå¸¦æœ‰ï¼Œæ·»åŠ cssæ ·å¼å³å¯å®ç°
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®å­—</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "æœ¬ç«™å‹‰å¼ºè¿è¡Œ&nbsp"+dnum+"&nbspå¤©";
      document.getElementById("times").innerHTML = hnum + "&nbspå°æ—¶&nbsp" + mnum + "&nbspåˆ†&nbsp" + snum + "&nbspç§’";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


    
  <!-- å¤‡æ¡ˆä¿¡æ¯ -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">äº¬ICPè¯123456å·</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=12345678"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>äº¬å…¬ç½‘å®‰å¤‡12345678å·</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "å­¦æˆåœ¨çº¿day18ï¼šåŸºäºoauth2å®ç°RBACè®¤è¯æˆæƒã€å¾®æœåŠ¡é—´è®¤è¯å®ç°&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
