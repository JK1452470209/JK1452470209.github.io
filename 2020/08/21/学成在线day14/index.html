<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>å­¦æˆåœ¨çº¿day14ï¼šåª’èµ„ç®¡ç† - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ç§äººåšå®¢</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äºæˆ‘
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-21 18:08">
      2020-08-21
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      12.4k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      162
       åˆ†é’Ÿ
    </span>
  

  
  
    
      <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> æ¬¡
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ"><a href="#ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ" class="headerlink" title="ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ"></a>ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ</h1><blockquote>
<p>ä¸ºäº†æ–¹ä¾¿åç»­å›é¡¾è¯¥é¡¹ç›®æ—¶èƒ½å¤Ÿæ¸…æ™°çš„çŸ¥é“æœ¬ç« èŠ‚è®²äº†å“ªäº›å†…å®¹ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»è¯¥ç« èŠ‚çš„ç¬”è®°ä¸­å¾—åˆ°ä¸€äº›å¸®åŠ©ï¼Œæ‰€ä»¥åœ¨å®Œæˆæœ¬ç« èŠ‚çš„å­¦ä¹ ååœ¨æ­¤å¯¹æœ¬ç« èŠ‚æ‰€æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹è¿›è¡Œæ€»ç»“æ¦‚è¿°ã€‚</p>
</blockquote>
<p>æœ¬ç« èŠ‚ä¸ºã€å­¦æˆåœ¨çº¿ã€‘é¡¹ç›®çš„ <code>day14</code> çš„å†…å®¹</p>
<ul>
<li>è§†é¢‘ä¸Šä¼ æˆåŠŸåé€šè¿‡ <code>RabbitMQ</code> è¿›è¡Œæ¶ˆæ¯å‘é€ï¼Œå†é€šè¿‡ <code>è§†é¢‘å¤„ç†æœåŠ¡</code> å¯¹è§†é¢‘è¿›è¡Œæ ¼å¼è½¬æ¢ï¼Œä»¥åŠ <code>m3u8</code> è§†é¢‘æ–‡ä»¶çš„ç”Ÿæˆã€‚</li>
<li>å®ç°åª’èµ„ä¿¡æ¯çš„æµè§ˆ</li>
<li><code>Vue</code> è·¨ç»„ä»¶é—´çš„é€šè®¯å®æˆ˜ï¼Œå®ç°è¯¾ç¨‹è®¡åˆ’ä¸å·²ä¸Šä¼ çš„åª’èµ„æ–‡ä»¶çš„å…³è”</li>
</ul>
<h1 id="ä¸€ã€è§†é¢‘å¤„ç†"><a href="#ä¸€ã€è§†é¢‘å¤„ç†" class="headerlink" title="ä¸€ã€è§†é¢‘å¤„ç†"></a>ä¸€ã€è§†é¢‘å¤„ç†</h1><h2 id="1-éœ€æ±‚åˆ†æ"><a href="#1-éœ€æ±‚åˆ†æ" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>åŸå§‹è§†é¢‘é€šå¸¸éœ€è¦ç»è¿‡ç¼–ç å¤„ç†ï¼Œç”Ÿæˆ <code>m3u8</code> å’Œ <code>ts</code> æ–‡ä»¶æ–¹å¯åŸºäº <code>HLS</code> åè®®æ’­æ”¾è§†é¢‘ã€‚é€šå¸¸ç”¨æˆ·ä¸Šä¼ åŸå§‹è§†é¢‘ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†æˆæ ‡å‡†æ ¼å¼ï¼Œç³»ç»Ÿå¯¹ç”¨æˆ·ä¸Šä¼ çš„è§†é¢‘è‡ªåŠ¨ç¼–ç ã€è½¬æ¢ï¼Œæœ€ç»ˆç”Ÿæˆ<code>m3u8</code> æ–‡ä»¶å’Œ <code>ts</code> æ–‡ä»¶ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ã€ç”¨æˆ·ä¸Šä¼ è§†é¢‘æˆåŠŸ</p>
<p>2ã€ç³»ç»Ÿå¯¹ä¸Šä¼ æˆåŠŸçš„è§†é¢‘è‡ªåŠ¨å¼€å§‹ç¼–ç å¤„ç†</p>
<p>3ã€ç”¨æˆ·æŸ¥çœ‹è§†é¢‘å¤„ç†ç»“æœï¼Œæ²¡æœ‰å¤„ç†æˆåŠŸçš„è§†é¢‘ç”¨æˆ·å¯åœ¨ç®¡ç†ç•Œé¢å†æ¬¡è§¦å‘å¤„ç†</p>
<p>4ã€è§†é¢‘å¤„ç†å®Œæˆå°†è§†é¢‘åœ°å€åŠå¤„ç†ç»“æœä¿å­˜åˆ°æ•°æ®åº“</p>
<p>è§†é¢‘å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image1" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image1.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>è§†é¢‘å¤„ç†è¿›ç¨‹çš„ä»»åŠ¡æ˜¯æ¥æ”¶è§†é¢‘å¤„ç†æ¶ˆæ¯è¿›è¡Œè§†é¢‘å¤„ç†ï¼Œä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ã€ç›‘å¬ <code>MQ</code>ï¼Œæ¥æ”¶è§†é¢‘å¤„ç†æ¶ˆæ¯ã€‚</p>
<p>2ã€è¿›è¡Œè§†é¢‘å¤„ç†ã€‚</p>
<p>3ã€å‘æ•°æ®åº“å†™å…¥è§†é¢‘å¤„ç†ç»“æœã€‚</p>
<p>è§†é¢‘å¤„ç†è¿›ç¨‹å±äºåª’èµ„ç®¡ç†ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œè€ƒè™‘æé«˜ç³»ç»Ÿçš„æ‰©å±•æ€§ï¼Œå°†è§†é¢‘å¤„ç†å•ç‹¬å®šä¹‰è§†é¢‘å¤„ç†å·¥ç¨‹ã€‚</p>
<h2 id="2-è§†é¢‘å¤„ç†å¼€å‘"><a href="#2-è§†é¢‘å¤„ç†å¼€å‘" class="headerlink" title="2. è§†é¢‘å¤„ç†å¼€å‘"></a>2. è§†é¢‘å¤„ç†å¼€å‘</h2><h3 id="è§†é¢‘å¤„ç†å·¥ç¨‹åˆ›å»º"><a href="#è§†é¢‘å¤„ç†å·¥ç¨‹åˆ›å»º" class="headerlink" title="è§†é¢‘å¤„ç†å·¥ç¨‹åˆ›å»º"></a>è§†é¢‘å¤„ç†å·¥ç¨‹åˆ›å»º</h3><p>1ã€å¯¼å…¥â€œèµ„æ–™â€ ä¸‹çš„è§†é¢‘å¤„ç†å·¥ç¨‹ï¼š<code>xc-service-manage-media-processor</code></p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image2" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image2.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2ã€<code>RabbitMQ</code> é…ç½®</p>
<p>ä½¿ç”¨ <code>rabbitMQ</code> çš„ <code>routing</code> äº¤æ¢æœºæ¨¡å¼ï¼Œè§†é¢‘å¤„ç†ç¨‹åºç›‘å¬è§†é¢‘å¤„ç†é˜Ÿåˆ—ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image3" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image3.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>RabbitMQé…ç½®å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_MEDIA_PROCESSTASK = <span class="hljs-string">"ex_media_processor"</span>;
    <span class="hljs-comment">//è§†é¢‘å¤„ç†é˜Ÿåˆ—</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xcâ€serviceâ€manageâ€media.mq.queueâ€mediaâ€videoâ€processor&#125;"</span>)
    <span class="hljs-keyword">public</span> String queue_media_video_processtask;
    <span class="hljs-comment">//è§†é¢‘å¤„ç†è·¯ç”±</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xcâ€serviceâ€manageâ€media.mq.routingkeyâ€mediaâ€video&#125;"</span>)
    <span class="hljs-keyword">public</span> String routingkey_media_video;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">* äº¤æ¢æœºé…ç½®</span>
<span class="hljs-comment">* <span class="hljs-doctag">@return</span> the exchange</span>
<span class="hljs-comment">*/</span>
    <span class="hljs-meta">@Bean</span>(EX_MEDIA_PROCESSTASK)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EX_MEDIA_VIDEOTASK</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_MEDIA_PROCESSTASK).durable(<span class="hljs-keyword">true</span>).build();
    &#125; 
    <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"queue_media_video_processtask"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">QUEUE_PROCESSTASK</span><span class="hljs-params">()</span> </span>&#123;
        Queue queue = <span class="hljs-keyword">new</span> Queue(queue_media_video_processtask,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">return</span> queue;
    &#125; 
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">* ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº .</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> queue the queue</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> exchange the exchange</span>
<span class="hljs-comment">* <span class="hljs-doctag">@return</span> the binding</span>
<span class="hljs-comment">*/</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">binding_queue_media_processtask</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"queue_media_video_processtask"</span>)</span>Queue queue, @<span class="hljs-title">Qualifier</span><span class="hljs-params">(EX_MEDIA_PROCESSTASK)</span> Exchange exchange) </span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(routingkey_media_video).noargs();
    &#125;
&#125;</code></pre></div>

<p>åœ¨ <code>application.yml</code> ä¸­é…ç½®é˜Ÿåˆ—åç§°åŠ <code>routingkey</code></p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-string">xcâ€serviceâ€manageâ€media:</span>
  <span class="hljs-attr">mq:</span>
    <span class="hljs-string">queueâ€mediaâ€videoâ€processor:</span> <span class="hljs-string">queue_media_video_processor</span>
    <span class="hljs-string">routingkeyâ€mediaâ€video:</span> <span class="hljs-string">routingkey_media_video</span></code></pre></div>

<h3 id="è§†é¢‘å¤„ç†æŠ€æœ¯æ–¹æ¡ˆ"><a href="#è§†é¢‘å¤„ç†æŠ€æœ¯æ–¹æ¡ˆ" class="headerlink" title="è§†é¢‘å¤„ç†æŠ€æœ¯æ–¹æ¡ˆ"></a>è§†é¢‘å¤„ç†æŠ€æœ¯æ–¹æ¡ˆ</h3><p>å¦‚ä½•é€šè¿‡ç¨‹åºè¿›è¡Œè§†é¢‘å¤„ç†ï¼Ÿ</p>
<p><code>ffmpeg</code> æ˜¯ä¸€ä¸ªå¯è¡Œçš„è§†é¢‘å¤„ç†ç¨‹åºï¼Œå¯ä»¥é€šè¿‡ <code>Java</code> è°ƒç”¨ <code>ffmpeg.exe</code> å®Œæˆè§†é¢‘å¤„ç†ã€‚</p>
<p>åœ¨ <code>java</code> ä¸­å¯ä»¥ä½¿ç”¨ <code>Runtime</code> ç±»å’Œ <code>Process Builder</code> ç±»ä¸¤ç§æ–¹å¼æ¥æ‰§è¡Œå¤–éƒ¨ç¨‹åºï¼Œå·¥ä½œä¸­è‡³å°‘æŒæ¡ä¸€ç§ã€‚</p>
<p>æœ¬é¡¹ç›®ä½¿ç”¨ <code>Process Builder</code> çš„æ–¹å¼æ¥è°ƒç”¨ <code>ffmpeg</code> å®Œæˆè§†é¢‘å¤„ç†ã€‚</p>
<p>å…³äº <code>Process Builder</code> çš„æµ‹è¯•å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//æµ‹è¯•pingå‘½ä»¤</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessBuilder</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
    <span class="hljs-comment">//åˆ›å»ºProcessBuilderå¯¹è±¡</span>
    ProcessBuilder processBuilder = <span class="hljs-keyword">new</span> ProcessBuilder();
    <span class="hljs-comment">//è®¾ç½®æ‰§è¡Œçš„ç¬¬ä¸‰æ–¹ç¨‹åº(å‘½ä»¤)</span>
    List&lt;String&gt; cmds = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    cmds.add(<span class="hljs-string">"ping"</span>);
    cmds.add(<span class="hljs-string">"127.0.0.1"</span>);
    processBuilder.command(cmds);
    <span class="hljs-comment">//åˆå¹¶æ ‡å‡†è¾“å…¥æµå’Œé”™è¯¯è¾“å‡º</span>
    processBuilder.redirectErrorStream(<span class="hljs-keyword">true</span>);
    Process start = processBuilder.start();
    <span class="hljs-comment">//è·å–è¾“å…¥æµ</span>
    InputStream inputStream = start.getInputStream();
    <span class="hljs-comment">//å°†è¾“å…¥æµè½¬æ¢ä¸ºå­—ç¬¦è¾“å…¥æµ</span>
    InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(inputStream, <span class="hljs-string">"gbk"</span>);

    <span class="hljs-comment">//è·å–æµçš„æ•°æ®</span>
    <span class="hljs-keyword">int</span> len = -<span class="hljs-number">1</span>;
    <span class="hljs-comment">//æ•°æ®ç¼“å†²åŒº</span>
    <span class="hljs-keyword">char</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[<span class="hljs-number">1024</span>];
    StringBuffer stringBuffer = <span class="hljs-keyword">new</span> StringBuffer();
    <span class="hljs-keyword">while</span> ((len = inputStreamReader.read(cache)) != -<span class="hljs-number">1</span>) &#123;
        <span class="hljs-comment">//è·å–ç¼“å†²åŒºå†…çš„æ•°æ®</span>
        String outStr = <span class="hljs-keyword">new</span> String(cache, <span class="hljs-number">0</span>, len);
        System.out.println(outStr);
        stringBuffer.append(outStr);
    &#125;
    inputStream.close();
&#125;

<span class="hljs-comment">//æµ‹è¯•ä½¿ç”¨å·¥å…·ç±»å°†aviè½¬æˆmp4</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testProcessMp4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
    ProcessBuilder processBuilder = <span class="hljs-keyword">new</span> ProcessBuilder();
    <span class="hljs-comment">//å®šä¹‰å‘½ä»¤å†…å®¹</span>
    List&lt;String&gt; command = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    command.add(<span class="hljs-string">"D:/soft/ffmpeg-20200315-c467328-win64-static/bin/ffmpeg.exe"</span>);
    command.add(<span class="hljs-string">"-i"</span>);
    command.add(<span class="hljs-string">"E:/temp/1.avi"</span>);
    command.add(<span class="hljs-string">"-y"</span>); <span class="hljs-comment">//è¦†ç›–è¾“å‡ºæ–‡ä»¶</span>
    command.add(<span class="hljs-string">"-c:v"</span>);
    command.add(<span class="hljs-string">"libx264"</span>);
    command.add(<span class="hljs-string">"-s"</span>);
    command.add(<span class="hljs-string">"1280x720"</span>);
    command.add(<span class="hljs-string">"-pix_fmt"</span>);
    command.add(<span class="hljs-string">"yuv420p"</span>);
    command.add(<span class="hljs-string">"-b:a"</span>);
    command.add(<span class="hljs-string">"63k"</span>);
    command.add(<span class="hljs-string">"-b:v"</span>);
    command.add(<span class="hljs-string">"753k"</span>);
    command.add(<span class="hljs-string">"-r"</span>);
    command.add(<span class="hljs-string">"18"</span>);
    command.add(<span class="hljs-string">"E:/temp/1.mp4"</span>);
    processBuilder.command(command);
    <span class="hljs-comment">//å°†æ ‡å‡†è¾“å…¥æµå’Œé”™è¯¯è¾“å…¥æµåˆå¹¶ï¼Œé€šè¿‡æ ‡å‡†è¾“å…¥æµè¯»å–ä¿¡æ¯</span>
    processBuilder.redirectErrorStream(<span class="hljs-keyword">true</span>);
    Process start = processBuilder.start();
    InputStream inputStream = start.getInputStream();
    InputStreamReader streamReader = <span class="hljs-keyword">new</span> InputStreamReader(inputStream, <span class="hljs-string">"gbk"</span>);

    <span class="hljs-comment">//è·å–è¾“å…¥æµæ•°æ®</span>
    <span class="hljs-keyword">int</span> len = -<span class="hljs-number">1</span>;
    <span class="hljs-comment">//æ•°æ®ç¼“å†²åŒº</span>
    <span class="hljs-keyword">char</span>[] cache = <span class="hljs-keyword">new</span> <span class="hljs-keyword">char</span>[<span class="hljs-number">1024</span>];
    StringBuffer stringBuffer = <span class="hljs-keyword">new</span> StringBuffer();
    <span class="hljs-keyword">while</span> ((len=streamReader.read(cache)) != -<span class="hljs-number">1</span>)&#123;
        <span class="hljs-comment">//ä»ç¼“å†²åŒºè·å–æ•°æ®</span>
        String out = <span class="hljs-keyword">new</span> String(cache, <span class="hljs-number">0</span>, len);
        System.out.println(out);
        stringBuffer.append(out);
    &#125;
    inputStream.close();
&#125;</code></pre></div>

<p>ä¸Šè¾¹çš„ä»£ç å·²ç»å°è£…æˆå·¥å…·ç±»ï¼Œå‚è§ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image4" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image4.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>ä¸Šè¾¹çš„å·¥å…·ç±»ä¸­ï¼š</p>
<p><code>Mp4VideoUtil.java</code> å®Œæˆ <code>avi</code> è½¬ <code>mp4</code></p>
<p><code>HlsVideoUtil.java</code> å®Œæˆ <code>mp4</code> è½¬ <code>hls</code></p>
<p>åˆ†åˆ«æµ‹è¯•æ¯ä¸ªå·¥å…·ç±»çš„ä½¿ç”¨æ–¹æ³•ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
    String ffmpeg_path = <span class="hljs-string">"D:/soft/ffmpeg-20200315-c467328-win64-static/bin/ffmpeg.exe"</span>;<span class="hljs-comment">//ffmpegçš„å®‰è£…ä½ç½®</span>
    String video_path = <span class="hljs-string">"E:\\temp\\1.avi"</span>;
    String mp4_name = <span class="hljs-string">"2.mp4"</span>;
    String mp4_path = <span class="hljs-string">"E:\\temp\\"</span>;
    Mp4VideoUtil videoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path,video_path,mp4_name,mp4_path);
    String s = videoUtil.generateMp4();
    System.out.println(s);
&#125;</code></pre></div>

<h3 id="è§†é¢‘å¤„ç†å®ç°"><a href="#è§†é¢‘å¤„ç†å®ç°" class="headerlink" title="è§†é¢‘å¤„ç†å®ç°"></a>è§†é¢‘å¤„ç†å®ç°</h3><h4 id="1ã€ç¡®å®šæ¶ˆæ¯æ ¼å¼"><a href="#1ã€ç¡®å®šæ¶ˆæ¯æ ¼å¼" class="headerlink" title="1ã€ç¡®å®šæ¶ˆæ¯æ ¼å¼"></a>1ã€ç¡®å®šæ¶ˆæ¯æ ¼å¼</h4><p><code>MQ</code> æ¶ˆæ¯ç»Ÿä¸€é‡‡ç”¨ <code>json</code> æ ¼å¼ï¼Œè§†é¢‘å¤„ç†ç”Ÿäº§æ–¹ä¼šå‘ <code>MQ</code> å‘é€å¦‚ä¸‹æ¶ˆæ¯ï¼Œè§†é¢‘å¤„ç†æ¶ˆè´¹æ–¹æ¥æ”¶æ­¤æ¶ˆæ¯åè¿›è¡Œè§†é¢‘å¤„<br>ç†ï¼š</p>
<div class="hljs"><pre><code class="hljs json">&#123;<span class="hljs-attr">"mediaId"</span>:XXX&#125;</code></pre></div>

<h4 id="2ã€å¤„ç†æµç¨‹"><a href="#2ã€å¤„ç†æµç¨‹" class="headerlink" title="2ã€å¤„ç†æµç¨‹"></a>2ã€å¤„ç†æµç¨‹</h4><p>1ï¼‰æ¥æ”¶è§†é¢‘å¤„ç†æ¶ˆæ¯</p>
<p>2ï¼‰åˆ¤æ–­åª’ä½“æ–‡ä»¶æ˜¯å¦éœ€è¦å¤„ç†ï¼ˆæœ¬è§†é¢‘å¤„ç†ç¨‹åºç›®å‰åªæ¥æ”¶<code>avi</code> è§†é¢‘çš„å¤„ç†ï¼‰å½“å‰åªæœ‰ <code>avi</code> æ–‡ä»¶éœ€è¦å¤„ç†ï¼Œå…¶å®ƒæ–‡ä»¶éœ€è¦æ›´æ–°å¤„ç†çŠ¶æ€ä¸º â€œ<code>æ— éœ€å¤„ç†</code>â€ã€‚</p>
<p>3ï¼‰å¤„ç†å‰åˆå§‹åŒ–å¤„ç†çŠ¶æ€ä¸º â€œ<code>æœªå¤„ç†</code>â€</p>
<p>4ï¼‰å¤„ç†å¤±è´¥éœ€è¦åœ¨æ•°æ®åº“è®°å½•å¤„ç†æ—¥å¿—ï¼ŒåŠå¤„ç†çŠ¶æ€ä¸º â€œ<code>å¤„ç†å¤±è´¥</code>â€</p>
<p>5ï¼‰å¤„ç†æˆåŠŸè®°å½•å¤„ç†çŠ¶æ€ä¸º â€œ<code>å¤„ç†æˆåŠŸ</code>â€œ</p>
<h4 id="3ã€æ•°æ®æ¨¡å‹"><a href="#3ã€æ•°æ®æ¨¡å‹" class="headerlink" title="3ã€æ•°æ®æ¨¡å‹"></a>3ã€æ•°æ®æ¨¡å‹</h4><p>åœ¨ <code>MediaFile</code> ç±»ä¸­æ·»åŠ  <code>mediaFileProcess_m3u8</code> å±æ€§è®°å½• <code>ts</code> æ–‡ä»¶åˆ—è¡¨ï¼Œä»£ç å¦‚ä¸‹ ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//å¤„ç†çŠ¶æ€</span>
<span class="hljs-keyword">private</span> String processStatus;
<span class="hljs-comment">//hlså¤„ç†</span>
<span class="hljs-keyword">private</span> MediaFileProcess_m3u8 mediaFileProcess_m3u8;</code></pre></div>

<p><code>MediaFileProcess_m3u8</code> å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaFileProcess_m3u8</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MediaFileProcess</span> </span>&#123;
<span class="hljs-comment">//tsåˆ—è¡¨</span>
<span class="hljs-keyword">private</span> List&lt;String&gt; tslist;
&#125;</code></pre></div>

<h4 id="4ã€è§†é¢‘å¤„ç†ç”Ÿæˆ-MP4"><a href="#4ã€è§†é¢‘å¤„ç†ç”Ÿæˆ-MP4" class="headerlink" title="4ã€è§†é¢‘å¤„ç†ç”Ÿæˆ MP4"></a>4ã€è§†é¢‘å¤„ç†ç”Ÿæˆ MP4</h4><p>1ï¼‰åˆ›å»º dao</p>
<p>è§†é¢‘å¤„ç†ç»“æœéœ€è¦ä¿å­˜åˆ°åª’èµ„æ•°æ®åº“ï¼Œåˆ›å»º <code>dao</code> å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">MediaFile</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
&#125;</code></pre></div>

<p>2ï¼‰åœ¨ <code>application.yml</code> ä¸­é…ç½® <code>ffmpeg</code> çš„ä½ç½®åŠè§†é¢‘ç›®å½•çš„æ ¹ç›®å½•</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-string">xcâ€serviceâ€manageâ€media:</span>
  <span class="hljs-string">videoâ€location:</span> <span class="hljs-string">F:/develop/video/</span>
  <span class="hljs-string">ffmpegâ€path:</span> <span class="hljs-string">D:/Program</span> <span class="hljs-string">Files/ffmpegâ€20180227â€fa0c9d6â€win64â€static/bin/ffmpeg.exe</span></code></pre></div>

<p>3ï¼‰å¤„ç†ä»»åŠ¡ç±»</p>
<p>åœ¨ <code>mq</code> åŒ…ä¸‹åˆ›å»º <code>MediaProcessTask</code> ç±»ï¼Œæ­¤ç±»è´Ÿè´£ç›‘å¬è§†é¢‘å¤„ç†é˜Ÿåˆ—ï¼Œå¹¶è¿›è¡Œè§†é¢‘å¤„ç†ã€‚</p>
<p>æ•´ä¸ªè§†é¢‘å¤„ç†å†…å®¹è¾ƒå¤šï¼Œè¿™é‡Œåˆ†ä¸¤éƒ¨åˆ†å®ç°ï¼šç”Ÿæˆ <code>Mp4</code> å’Œç”Ÿæˆ <code>m3u8</code>ï¼Œä¸‹è¾¹ä»£ç å®ç°äº†ç”Ÿæˆ <code>mp4</code> ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaProcessTask</span> </span>&#123;
    <span class="hljs-comment">//æ—¥å¿—å¯¹è±¡</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MediaProcessTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//ffmpegç»å¯¹è·¯å¾„</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.ffmpeg-path&#125;"</span>)
    String ffmpeg_path;

    <span class="hljs-comment">//ä¸Šä¼ æ–‡ä»¶æ ¹ç›®å½•</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.video-location&#125;"</span>)
    String serverPath;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMediaProcessTask</span><span class="hljs-params">(String msg)</span></span>&#123;
        <span class="hljs-comment">//å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯è½¬æ¢ä¸ºjsonæ•°æ®</span>
        Map msgMap = JSON.parseObject(msg);
        LOGGER.info(<span class="hljs-string">"receive media process task msg :&#123;&#125; "</span>,msgMap);
        <span class="hljs-comment">//è§£ææ¶ˆæ¯</span>
        <span class="hljs-comment">//åª’èµ„æ–‡ä»¶id</span>
        String mediaId = (String) msgMap.get(<span class="hljs-string">"mediaId"</span>);
        <span class="hljs-comment">//è·å–åª’èµ„æ–‡ä»¶ä¿¡æ¯</span>
        Optional&lt;MediaFile&gt; byId = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!byId.isPresent())&#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        MediaFile mediaFile = byId.get();
        <span class="hljs-comment">//åª’èµ„æ–‡ä»¶ç±»å‹</span>
        String fileType = mediaFile.getFileType();
        <span class="hljs-comment">//ç›®å‰åªå¤„ç†aviæ–‡ä»¶</span>
        <span class="hljs-keyword">if</span>(fileType == <span class="hljs-keyword">null</span> || !fileType.equals(<span class="hljs-string">"avi"</span>))&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303004"</span>); <span class="hljs-comment">// å¤„ç†çŠ¶æ€ä¸ºæ— éœ€å¤„ç†</span>
            mediaFileRepository.save(mediaFile);
        &#125;<span class="hljs-keyword">else</span>&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303001"</span>); <span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºæœªå¤„ç†</span>
        &#125;
        <span class="hljs-comment">//ç”ŸæˆMP4</span>
        String videoPath = serverPath + mediaFile.getFilePath() + mediaFile.getFileName();
        String mp4Name = mediaFile.getFileId() + <span class="hljs-string">".mp4"</span>;
        String mp4FloderPath = serverPath  + mediaFile.getFilePath();
        Mp4VideoUtil mp4VideoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path, videoPath, mp4Name, mp4FloderPath);
        String result = mp4VideoUtil.generateMp4();
        <span class="hljs-keyword">if</span>(result == <span class="hljs-keyword">null</span> || !result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//æ“ä½œå¤±è´¥å†™å…¥å¤„ç†æ—¥å¿—</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºå¤„ç†å¤±è´¥</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">//ç”Ÿæˆm3u8...</span>
    &#125;
&#125;</code></pre></div>

<p>è¯´æ˜ï¼š</p>
<p>1ã€åŸå§‹è§†é¢‘è½¬æˆ <code>mp4</code> å¦‚ä½•åˆ¤æ–­è½¬æ¢æˆåŠŸï¼Ÿ</p>
<p>æ ¹æ®è§†é¢‘æ—¶é•¿æ¥åˆ¤æ–­ï¼Œå–åŸè§†é¢‘å’Œè½¬æ¢æˆåŠŸè§†é¢‘çš„æ—¶é•¿ï¼ˆæ—¶åˆ†ç§’ï¼‰ï¼Œå¦‚æœç›¸ç­‰åˆ™ç›¸åŒã€‚</p>
<h4 id="5ã€è§†é¢‘å¤„ç†ç”Ÿæˆ-m3u8"><a href="#5ã€è§†é¢‘å¤„ç†ç”Ÿæˆ-m3u8" class="headerlink" title="5ã€è§†é¢‘å¤„ç†ç”Ÿæˆ m3u8"></a>5ã€è§†é¢‘å¤„ç†ç”Ÿæˆ m3u8</h4><p>ä¸‹è¾¹æ˜¯å®Œæ•´çš„è§†é¢‘å¤„ç†ä»»åŠ¡ç±»ä»£ç ï¼ŒåŒ…æ‹¬äº†ç”Ÿæˆ <code>m3u8</code> åŠç”Ÿæˆ <code>mp4</code> çš„ä»£ç </p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media_process.mq;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFileProcess_m3u8;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.HlsVideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.Mp4VideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media_process.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaProcessTask</span> </span>&#123;
    <span class="hljs-comment">//æ—¥å¿—å¯¹è±¡</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MediaProcessTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//ffmpegç»å¯¹è·¯å¾„</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.ffmpeg-path&#125;"</span>)
    String ffmpeg_path;

    <span class="hljs-comment">//ä¸Šä¼ æ–‡ä»¶æ ¹ç›®å½•</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.video-location&#125;"</span>)
    String serverPath;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMediaProcessTask</span><span class="hljs-params">(String msg)</span></span>&#123;
        <span class="hljs-comment">//å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯è½¬æ¢ä¸ºjsonæ•°æ®</span>
        Map msgMap = JSON.parseObject(msg);
        LOGGER.info(<span class="hljs-string">"receive media process task msg :&#123;&#125; "</span>,msgMap);
        <span class="hljs-comment">//è§£ææ¶ˆæ¯</span>
        <span class="hljs-comment">//åª’èµ„æ–‡ä»¶id</span>
        String mediaId = (String) msgMap.get(<span class="hljs-string">"mediaId"</span>);
        <span class="hljs-comment">//è·å–åª’èµ„æ–‡ä»¶ä¿¡æ¯</span>
        Optional&lt;MediaFile&gt; byId = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!byId.isPresent())&#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        MediaFile mediaFile = byId.get();
        <span class="hljs-comment">//åª’èµ„æ–‡ä»¶ç±»å‹</span>
        String fileType = mediaFile.getFileType();
        <span class="hljs-comment">//ç›®å‰åªå¤„ç†aviæ–‡ä»¶</span>
        <span class="hljs-keyword">if</span>(fileType == <span class="hljs-keyword">null</span> || !fileType.equals(<span class="hljs-string">"avi"</span>))&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303004"</span>); <span class="hljs-comment">// å¤„ç†çŠ¶æ€ä¸ºæ— éœ€å¤„ç†</span>
            mediaFileRepository.save(mediaFile);
        &#125;<span class="hljs-keyword">else</span>&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303001"</span>); <span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºæœªå¤„ç†</span>
        &#125;
        <span class="hljs-comment">//ç”ŸæˆMP4</span>
        String videoPath = serverPath + mediaFile.getFilePath() + mediaFile.getFileName();
        String mp4Name = mediaFile.getFileId() + <span class="hljs-string">".mp4"</span>;
        String mp4FloderPath = serverPath  + mediaFile.getFilePath();
        Mp4VideoUtil mp4VideoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path, videoPath, mp4Name, mp4FloderPath);
        String result = mp4VideoUtil.generateMp4();
        <span class="hljs-keyword">if</span>(result == <span class="hljs-keyword">null</span> || !result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//æ“ä½œå¤±è´¥å†™å…¥å¤„ç†æ—¥å¿—</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºå¤„ç†å¤±è´¥</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">//ç”Ÿæˆm3u8åˆ—è¡¨</span>
        <span class="hljs-comment">//ç”Ÿæˆm3u8</span>
        String mp4VideoPath = serverPath + mediaFile.getFilePath()+ mp4Name;<span class="hljs-comment">//æ­¤åœ°å€ä¸ºmp4çš„åœ°å€</span>
        String m3u8Name = mediaFile.getFileId()+<span class="hljs-string">".m3u8"</span>;
        String m3u8FolderPath = serverPath + mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>;
        <span class="hljs-comment">//è°ƒç”¨å·¥å…·ç±»è¿›è¡Œç”Ÿæˆm3u8</span>
        HlsVideoUtil hlsVideoUtil = <span class="hljs-keyword">new</span> HlsVideoUtil(ffmpeg_path, mp4VideoPath, m3u8Name, m3u8FolderPath);
        String m3u8Result = hlsVideoUtil.generateM3u8();

        <span class="hljs-keyword">if</span>(m3u8Result==<span class="hljs-keyword">null</span> || !m3u8Result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//æ“ä½œå¤±è´¥å†™å…¥å¤„ç†æ—¥å¿—</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºå¤„ç†å¤±è´¥</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(m3u8Result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span> ;
        &#125;

        <span class="hljs-comment">//è·å–m3u8åˆ—è¡¨</span>
        List&lt;String&gt; ts_list = hlsVideoUtil.get_ts_list();
        <span class="hljs-comment">//æ›´æ–°å¤„ç†çŠ¶æ€ä¸ºæˆåŠŸ</span>
        mediaFile.setProcessStatus(<span class="hljs-string">"303002"</span>);<span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºå¤„ç†æˆåŠŸ</span>
        MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
        mediaFileProcess_m3u8.setTslist(ts_list);
        mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
        <span class="hljs-comment">//m3u8æ–‡ä»¶url</span>
        mediaFile.setFileUrl(mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>+m3u8Name);
        mediaFileRepository.save(mediaFile);
    &#125;
&#125;</code></pre></div>

<h2 id="3-å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯"><a href="#3-å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯" class="headerlink" title="3. å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯"></a>3. å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯</h2><p>å½“è§†é¢‘ä¸Šä¼ æˆåŠŸåå‘ <code>MQ</code> å‘é€è§†é¢‘ å¤„ç†æ¶ˆæ¯ã€‚</p>
<p>ä¿®æ”¹åª’èµ„ç®¡ç†æœåŠ¡çš„æ–‡ä»¶ä¸Šä¼ ä»£ç ï¼Œå½“æ–‡ä»¶ä¸Šä¼ æˆåŠŸå‘ <code>MQ</code> å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯ã€‚</p>
<h3 id="é…ç½®RabbitMQ"><a href="#é…ç½®RabbitMQ" class="headerlink" title="é…ç½®RabbitMQ"></a>é…ç½®RabbitMQ</h3><p>1ã€å°†<code>media-processor</code> å·¥ç¨‹ä¸‹çš„ <code>RabbitmqConfig</code> é…ç½®ç±»æ‹·è´åˆ° <code>media</code> å·¥ç¨‹ä¸‹ã€‚</p>
<p>2ã€åœ¨ <code>media</code> å·¥ç¨‹ä¸‹é…ç½® <code>mq</code> é˜Ÿåˆ—ç­‰ä¿¡æ¯</p>
<p>ä¿®æ”¹ <code>application.yml</code></p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">xc-service-manage-media:</span>
  <span class="hljs-attr">mq:</span>
    <span class="hljs-attr">queue-media-video-processor:</span> <span class="hljs-string">queue_media_video_processor</span>
    <span class="hljs-attr">routingkey-media-video:</span> <span class="hljs-string">routingkey_media_video</span></code></pre></div>

<h3 id="é…ç½®Service"><a href="#é…ç½®Service" class="headerlink" title="é…ç½®Service"></a>é…ç½®Service</h3><p>åœ¨æ–‡ä»¶åˆå¹¶æ–¹æ³•ä¸­æ·»åŠ å‘ <code>mq</code> å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯çš„ä»£ç ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//è§†é¢‘å¤„ç†è·¯ç”±</span>
<span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.routingkey-media-video&#125;"</span>)
<span class="hljs-keyword">public</span> String routingkey_media_video;

<span class="hljs-meta">@Autowired</span>
RabbitTemplate rabbitTemplate;

<span class="hljs-comment">//å‘MQå‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> ResponseResult <span class="hljs-title">sendProcessVideoMsg</span><span class="hljs-params">(String mediaId)</span></span>&#123;
    Optional&lt;MediaFile&gt; optional = mediaFileRepository.findById(mediaId);
    <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
    &#125;
    MediaFile mediaFile = optional.get();
    <span class="hljs-comment">//å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯</span>
    Map&lt;String,String&gt; msgMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    msgMap.put(<span class="hljs-string">"mediaId"</span>,mediaId);
    <span class="hljs-comment">//å‘é€çš„æ¶ˆæ¯</span>
    String msg = JSON.toJSONString(msgMap);
    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-keyword">this</span>.rabbitTemplate.convertAndSend(RabbitMQConfig.EX_MEDIA_PROCESSTASK,routingkey_media_video,msg);
        LOGGER.info(<span class="hljs-string">"send media process task msg:&#123;&#125;"</span>,msg);
    &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
        e.printStackTrace();
        LOGGER.info(<span class="hljs-string">"send media process task error,msg is:&#123;&#125;,error:&#123;&#125;"</span>,msg,e.getMessage());
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
&#125;</code></pre></div>

<p>åœ¨ <code>mergechunks</code> æ–¹æ³•æœ€åè°ƒç”¨ <code>sendProcessVideo</code> æ–¹æ³•ã€‚</p>
<div class="hljs"><pre><code class="hljs java">......
<span class="hljs-comment">//çŠ¶æ€ä¸ºä¸Šä¼ æˆåŠŸ</span>
mediaFile.setFileStatus(<span class="hljs-string">"301002"</span>);
mediaFileRepository.save(mediaFile);
String mediaId = mediaFile.getFileId();
<span class="hljs-comment">//å‘MQå‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯</span>
sendProcessVideoMsg(mediaId);
......</code></pre></div>

<h2 id="4-è§†é¢‘å¤„ç†æµ‹è¯•"><a href="#4-è§†é¢‘å¤„ç†æµ‹è¯•" class="headerlink" title="4. è§†é¢‘å¤„ç†æµ‹è¯•"></a>4. è§†é¢‘å¤„ç†æµ‹è¯•</h2><p>æµ‹è¯•æµç¨‹ï¼š</p>
<p>1ã€ä¸Šä¼ aviæ–‡ä»¶</p>
<p>2ã€è§‚å¯Ÿæ—¥å¿—æ˜¯å¦å‘é€æ¶ˆæ¯</p>
<p>3ã€è§‚å¯Ÿè§†é¢‘å¤„ç†è¿›ç¨‹æ˜¯å¦æ¥æ”¶åˆ°æ¶ˆæ¯è¿›è¡Œå¤„ç†</p>
<p>4ã€è§‚å¯Ÿ <code>mp4</code> æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ</p>
<p>5ã€è§‚å¯Ÿ <code>m3u8</code> åŠ <code>ts</code> æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ</p>
<h2 id="5-è§†é¢‘å¤„ç†å¹¶å‘è®¾ç½®"><a href="#5-è§†é¢‘å¤„ç†å¹¶å‘è®¾ç½®" class="headerlink" title="5. è§†é¢‘å¤„ç†å¹¶å‘è®¾ç½®"></a>5. è§†é¢‘å¤„ç†å¹¶å‘è®¾ç½®</h2><p>ä»£ç ä¸­ä½¿ç”¨ <code>@RabbitListener</code> æ³¨è§£æŒ‡å®šæ¶ˆè´¹æ–¹æ³•ï¼Œé»˜è®¤æƒ…å†µæ˜¯å•çº¿ç¨‹ç›‘å¬é˜Ÿåˆ—ï¼Œå¯ä»¥è§‚å¯Ÿå½“é˜Ÿåˆ—æœ‰å¤šä¸ªä»»åŠ¡æ—¶æ¶ˆè´¹ç«¯æ¯æ¬¡åªæ¶ˆè´¹ä¸€ä¸ªæ¶ˆæ¯ï¼Œå•çº¿ç¨‹å¤„ç†æ¶ˆæ¯å®¹æ˜“å¼•èµ·æ¶ˆæ¯å¤„ç†ç¼“æ…¢ï¼Œæ¶ˆæ¯å †ç§¯ï¼Œä¸èƒ½æœ€å¤§åˆ©ç”¨ç¡¬ä»¶èµ„æºã€‚</p>
<p>å¯ä»¥é…ç½® <code>mq</code> çš„å®¹å™¨å·¥å‚å‚æ•°ï¼Œå¢åŠ å¹¶å‘å¤„ç†æ•°é‡å³å¯å®ç°å¤šçº¿ç¨‹å¤„ç†ç›‘å¬é˜Ÿåˆ—ï¼Œå®ç°å¤šçº¿ç¨‹å¤„ç†æ¶ˆæ¯ã€‚</p>
<p>1ã€åœ¨ <code>RabbitmqConfig.java</code> ä¸­æ·»åŠ å®¹å™¨å·¥å‚é…ç½®ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å¤šçº¿ç¨‹å¤„ç†æ¶ˆæ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> configurer</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connectionFactory</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@Bean</span>(<span class="hljs-string">"customContainerFactory"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title">containerFactory</span><span class="hljs-params">(SimpleRabbitListenerContainerFactoryConfigurer configurer, ConnectionFactory</span></span>
<span class="hljs-function"><span class="hljs-params">                                                             connectionFactory)</span> </span>&#123;
    SimpleRabbitListenerContainerFactory factory = <span class="hljs-keyword">new</span> SimpleRabbitListenerContainerFactory();
    factory.setConcurrentConsumers(DEFAULT_CONCURRENT);
    factory.setMaxConcurrentConsumers(DEFAULT_CONCURRENT);
    configurer.configure(factory,connectionFactory);
    <span class="hljs-keyword">return</span> factory;
&#125;</code></pre></div>

<p>2ã€åœ¨ <code>@RabbitListener</code> æ³¨è§£ä¸­æŒ‡å®šå®¹å™¨å·¥å‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//è§†é¢‘å¤„ç†æ–¹æ³•</span>
<span class="hljs-meta">@RabbitListener</span>(queues = &#123;<span class="hljs-string">"$&#123;xcâ€serviceâ€manageâ€media.mq.queueâ€mediaâ€videoâ€processor&#125;"</span>&#125;,
containerFactory=<span class="hljs-string">"customContainerFactory"</span>)</code></pre></div>

<p>å†æ¬¡æµ‹è¯•å½“é˜Ÿåˆ—æœ‰å¤šä¸ªä»»åŠ¡æ—¶æ¶ˆè´¹ç«¯çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</p>
<h2 id="6-å®Œæ•´ä»£ç "><a href="#6-å®Œæ•´ä»£ç " class="headerlink" title="6. å®Œæ•´ä»£ç "></a>6. å®Œæ•´ä»£ç </h2><h3 id="RabbitMQConfig"><a href="#RabbitMQConfig" class="headerlink" title="RabbitMQConfig"></a>RabbitMQConfig</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media_process.config;

<span class="hljs-keyword">import</span> org.springframework.amqp.core.*;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.amqp.SimpleRabbitListenerContainerFactoryConfigurer;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_MEDIA_PROCESSTASK = <span class="hljs-string">"ex_media_processor"</span>;

    <span class="hljs-comment">//è§†é¢‘å¤„ç†é˜Ÿåˆ—</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span>)
    <span class="hljs-keyword">public</span>  String queue_media_video_processtask;

    <span class="hljs-comment">//è§†é¢‘å¤„ç†è·¯ç”±</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.routingkey-media-video&#125;"</span>)
    <span class="hljs-keyword">public</span>  String routingkey_media_video;

    <span class="hljs-comment">//æ¶ˆè´¹è€…å¹¶å‘æ•°é‡</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_CONCURRENT = <span class="hljs-number">10</span>;


    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * äº¤æ¢æœºé…ç½®</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the exchange</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(EX_MEDIA_PROCESSTASK)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EX_MEDIA_VIDEOTASK</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_MEDIA_PROCESSTASK).durable(<span class="hljs-keyword">true</span>).build();
    &#125;
    <span class="hljs-comment">//å£°æ˜é˜Ÿåˆ—</span>
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"queue_media_video_processtask"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">QUEUE_PROCESSTASK</span><span class="hljs-params">()</span> </span>&#123;
        Queue queue = <span class="hljs-keyword">new</span> Queue(queue_media_video_processtask,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">true</span>);
        <span class="hljs-keyword">return</span> queue;
    &#125;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº .</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queue    the queue</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exchange the exchange</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the binding</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">binding_queue_media_processtask</span><span class="hljs-params">(@Qualifier(<span class="hljs-string">"queue_media_video_processtask"</span>)</span> Queue queue, @<span class="hljs-title">Qualifier</span><span class="hljs-params">(EX_MEDIA_PROCESSTASK)</span> Exchange exchange) </span>&#123;
        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(routingkey_media_video).noargs();
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * å¤šçº¿ç¨‹å¤„ç†æ¶ˆæ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> configurer</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> connectionFactory</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"customContainerFactory"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title">containerFactory</span><span class="hljs-params">(SimpleRabbitListenerContainerFactoryConfigurer configurer, ConnectionFactory</span></span>
<span class="hljs-function"><span class="hljs-params">            connectionFactory)</span> </span>&#123;
        SimpleRabbitListenerContainerFactory factory = <span class="hljs-keyword">new</span> SimpleRabbitListenerContainerFactory();
        factory.setConcurrentConsumers(DEFAULT_CONCURRENT);
        factory.setMaxConcurrentConsumers(DEFAULT_CONCURRENT);
        configurer.configure(factory,connectionFactory);
        <span class="hljs-keyword">return</span> factory;
    &#125;
&#125;</code></pre></div>

<h3 id="MediaProcessTask"><a href="#MediaProcessTask" class="headerlink" title="MediaProcessTask"></a>MediaProcessTask</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media_process.mq;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFileProcess_m3u8;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.HlsVideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.framework.utils.Mp4VideoUtil;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media_process.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaProcessTask</span> </span>&#123;
    <span class="hljs-comment">//æ—¥å¿—å¯¹è±¡</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MediaProcessTask<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-comment">//ffmpegç»å¯¹è·¯å¾„</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.ffmpeg-path&#125;"</span>)
    String ffmpeg_path;

    <span class="hljs-comment">//ä¸Šä¼ æ–‡ä»¶æ ¹ç›®å½•</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.video-location&#125;"</span>)
    String serverPath;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-meta">@RabbitListener</span>(queues = <span class="hljs-string">"$&#123;xc-service-manage-media.mq.queue-media-video-processor&#125;"</span> , containerFactory=<span class="hljs-string">"customContainerFactory"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMediaProcessTask</span><span class="hljs-params">(String msg)</span></span>&#123;
        <span class="hljs-comment">//å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯è½¬æ¢ä¸ºjsonæ•°æ®</span>
        Map msgMap = JSON.parseObject(msg);
        LOGGER.info(<span class="hljs-string">"receive media process task msg :&#123;&#125; "</span>,msgMap);
        <span class="hljs-comment">//è§£ææ¶ˆæ¯</span>
        <span class="hljs-comment">//åª’èµ„æ–‡ä»¶id</span>
        String mediaId = (String) msgMap.get(<span class="hljs-string">"mediaId"</span>);
        <span class="hljs-comment">//è·å–åª’èµ„æ–‡ä»¶ä¿¡æ¯</span>
        Optional&lt;MediaFile&gt; byId = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!byId.isPresent())&#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        MediaFile mediaFile = byId.get();
        <span class="hljs-comment">//åª’èµ„æ–‡ä»¶ç±»å‹</span>
        String fileType = mediaFile.getFileType();
        <span class="hljs-comment">//ç›®å‰åªå¤„ç†aviæ–‡ä»¶</span>
        <span class="hljs-keyword">if</span>(fileType == <span class="hljs-keyword">null</span> || !fileType.equals(<span class="hljs-string">"avi"</span>))&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303004"</span>); <span class="hljs-comment">// å¤„ç†çŠ¶æ€ä¸ºæ— éœ€å¤„ç†</span>
            mediaFileRepository.save(mediaFile);
        &#125;<span class="hljs-keyword">else</span>&#123;
            mediaFile.setProcessStatus(<span class="hljs-string">"303001"</span>); <span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºæœªå¤„ç†</span>
        &#125;
        <span class="hljs-comment">//ç”ŸæˆMP4</span>
        String videoPath = serverPath + mediaFile.getFilePath() + mediaFile.getFileName();
        String mp4Name = mediaFile.getFileId() + <span class="hljs-string">".mp4"</span>;
        String mp4FloderPath = serverPath  + mediaFile.getFilePath();
        Mp4VideoUtil mp4VideoUtil = <span class="hljs-keyword">new</span> Mp4VideoUtil(ffmpeg_path, videoPath, mp4Name, mp4FloderPath);
        String result = mp4VideoUtil.generateMp4();
        <span class="hljs-keyword">if</span>(result == <span class="hljs-keyword">null</span> || !result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//æ“ä½œå¤±è´¥å†™å…¥å¤„ç†æ—¥å¿—</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºå¤„ç†å¤±è´¥</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span>;
        &#125;

        <span class="hljs-comment">//ç”Ÿæˆm3u8åˆ—è¡¨</span>
        <span class="hljs-comment">//ç”Ÿæˆm3u8</span>
        String mp4VideoPath = serverPath + mediaFile.getFilePath()+ mp4Name;<span class="hljs-comment">//æ­¤åœ°å€ä¸ºmp4çš„åœ°å€</span>
        String m3u8Name = mediaFile.getFileId()+<span class="hljs-string">".m3u8"</span>;
        String m3u8FolderPath = serverPath + mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>;
        <span class="hljs-comment">//è°ƒç”¨å·¥å…·ç±»è¿›è¡Œç”Ÿæˆm3u8</span>
        HlsVideoUtil hlsVideoUtil = <span class="hljs-keyword">new</span> HlsVideoUtil(ffmpeg_path, mp4VideoPath, m3u8Name, m3u8FolderPath);
        String m3u8Result = hlsVideoUtil.generateM3u8();

        <span class="hljs-keyword">if</span>(m3u8Result==<span class="hljs-keyword">null</span> || !m3u8Result.equals(<span class="hljs-string">"success"</span>))&#123;
            <span class="hljs-comment">//æ“ä½œå¤±è´¥å†™å…¥å¤„ç†æ—¥å¿—</span>
            mediaFile.setProcessStatus(<span class="hljs-string">"303003"</span>);<span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºå¤„ç†å¤±è´¥</span>
            MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
            mediaFileProcess_m3u8.setErrormsg(m3u8Result);
            mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
            mediaFileRepository.save(mediaFile);
            <span class="hljs-keyword">return</span> ;
        &#125;

        <span class="hljs-comment">//è·å–m3u8åˆ—è¡¨</span>
        List&lt;String&gt; ts_list = hlsVideoUtil.get_ts_list();
        <span class="hljs-comment">//æ›´æ–°å¤„ç†çŠ¶æ€ä¸ºæˆåŠŸ</span>
        mediaFile.setProcessStatus(<span class="hljs-string">"303002"</span>);<span class="hljs-comment">//å¤„ç†çŠ¶æ€ä¸ºå¤„ç†æˆåŠŸ</span>
        MediaFileProcess_m3u8 mediaFileProcess_m3u8 = <span class="hljs-keyword">new</span> MediaFileProcess_m3u8();
        mediaFileProcess_m3u8.setTslist(ts_list);
        mediaFile.setMediaFileProcess_m3u8(mediaFileProcess_m3u8);
        <span class="hljs-comment">//m3u8æ–‡ä»¶url</span>
        mediaFile.setFileUrl(mediaFile.getFilePath()+<span class="hljs-string">"hls/"</span>+m3u8Name);
        mediaFileRepository.save(mediaFile);
    &#125;
&#125;</code></pre></div>

<h3 id="MediaUploadServiceImpl"><a href="#MediaUploadServiceImpl" class="headerlink" title="MediaUploadServiceImpl"></a>MediaUploadServiceImpl</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media.service.impl;

<span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;
<span class="hljs-keyword">import</span> com.netflix.discovery.converters.Auto;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.response.CheckChunkResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.response.MediaCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.exception.ExceptionCast;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.ResponseResult;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.config.RabbitMQConfig;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.controller.MediaUploadController;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.service.MediaUploadService;
<span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;
<span class="hljs-keyword">import</span> org.apache.commons.io.IOUtils;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hljs-keyword">import</span> javax.jws.Oneway;
<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-meta">@Service</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaUploadServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaUploadService</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Logger LOGGER = LoggerFactory.getLogger(MediaUploadController<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-comment">//ä¸Šä¼ æ–‡ä»¶æ ¹ç›®å½•</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.upload-location&#125;"</span>)
    String uploadPath;

   <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯æ˜¯å¦å·²ç»å­˜åœ¨æœ¬åœ°ä»¥åŠmongodbå†…,å…¶ä¸­ä¸€è€…ä¸å­˜åœ¨åˆ™é‡æ–°æ³¨å†Œ</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 æ–‡ä»¶md5å€¼</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileExt æ–‡ä»¶æ‰©å±•å</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> æ–‡ä»¶è·¯å¾„</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">register</span><span class="hljs-params">(String fileMd5, String fileName, Long fileSize, String mimetype, String fileExt)</span> </span>&#123;
        <span class="hljs-comment">//1.æ£€æŸ¥æ–‡ä»¶åœ¨ç£ç›˜ä¸Šæ˜¯å¦å­˜åœ¨</span>
        <span class="hljs-comment">//2.æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯åœ¨mongodbä¸Šæ˜¯å¦å­˜åœ¨</span>

        <span class="hljs-comment">//è·å–æ–‡ä»¶æ‰€å±ç›®å½•ä»¥åŠæ–‡ä»¶è·¯å¾„</span>
        String fileFloderPath = <span class="hljs-keyword">this</span>.getFileFloderPath(fileMd5);
        String filePath = <span class="hljs-keyword">this</span>.getFileFullPath(fileMd5, fileExt);
        File file = <span class="hljs-keyword">new</span> File(filePath);
        <span class="hljs-keyword">boolean</span> exists = file.exists();

        <span class="hljs-comment">//æŸ¥è¯¢mongodbä¸Šçš„æ–‡ä»¶ä¿¡æ¯</span>
        Optional&lt;MediaFile&gt; optional = mediaFileRepository.findById(fileMd5);
        <span class="hljs-keyword">if</span>(exists &amp;&amp; optional.isPresent())&#123;
            ExceptionCast.cast(MediaCode.UPLOAD_FILE_REGISTER_EXIST);
        &#125;
        <span class="hljs-comment">//å…¶ä¸­ä¸€è€…ä¸å­˜åœ¨åˆ™é‡æ–°æ³¨å†Œæ–‡ä»¶ä¿¡æ¯</span>
        File fileFloder = <span class="hljs-keyword">new</span> File(fileFloderPath);
        <span class="hljs-keyword">if</span>(!fileFloder.exists())&#123;
            <span class="hljs-comment">//åˆ›å»ºæ–‡ä»¶ç›®å½•</span>
            fileFloder.mkdirs();
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ£€æŸ¥æ–‡ä»¶å—æ˜¯å¦å­˜åœ¨</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 æ–‡ä»¶md5</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chunk å—ç¼–å·</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chunkSize å—å¤§å°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> CheckChunkResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> CheckChunkResult <span class="hljs-title">checkChunk</span><span class="hljs-params">(String fileMd5, Integer chunk, Integer chunkSize)</span> </span>&#123;
        <span class="hljs-comment">//è·å–æ–‡ä»¶å—è·¯å¾„</span>
        String chunkFloder = <span class="hljs-keyword">this</span>.getChunkFloderPath(fileMd5);
        File chunkFile = <span class="hljs-keyword">new</span> File(chunkFloder + chunk);
        <span class="hljs-keyword">if</span>(chunkFile.exists())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CheckChunkResult(CommonCode.SUCCESS, <span class="hljs-keyword">true</span>);
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CheckChunkResult(CommonCode.SUCCESS, <span class="hljs-keyword">false</span>);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * ä¸Šä¼ åˆ†å—æ–‡ä»¶</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> file ä¸Šä¼ çš„æ–‡ä»¶</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chunk åˆ†å—å·</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 æ–‡ä»¶MD5</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">uploadChunk</span><span class="hljs-params">(MultipartFile file, Integer chunk, String fileMd5)</span> </span>&#123;
        <span class="hljs-comment">//è·å–åˆ†å—æ–‡ä»¶æ‰€å±ç›®å½•</span>
        String chunkFloder = <span class="hljs-keyword">this</span>.getChunkFloderPath(fileMd5);
        InputStream inputStream = <span class="hljs-keyword">null</span>;
        FileOutputStream fileOutputStream = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            inputStream = file.getInputStream();
            fileOutputStream = <span class="hljs-keyword">new</span> FileOutputStream(chunkFloder + chunk);
            IOUtils.copy(inputStream,fileOutputStream);
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            <span class="hljs-comment">//æ–‡ä»¶ä¿å­˜å¤±è´¥</span>
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"upload chunk file fail:&#123;&#125;"</span>,e.getMessage());
            ExceptionCast.cast(MediaCode.CHUNK_FILE_UPLOAD_FAIL);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * åˆå¹¶æ–‡ä»¶å—ä¿¡æ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileMd5 æ–‡ä»¶MD5</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileName æ–‡ä»¶åç§°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileSize æ–‡ä»¶å¤§å°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mimetype æ–‡ä»¶ç±»å‹</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileExt æ–‡ä»¶æ‹“å±•å</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ResponseResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">mergeChunks</span><span class="hljs-params">(String fileMd5, String fileName, Long fileSize, String mimetype, String fileExt)</span> </span>&#123;
        <span class="hljs-comment">//è·å–æ–‡ä»¶å—è·¯å¾„</span>
        String chunkFloderPath = getChunkFloderPath(fileMd5);
        <span class="hljs-comment">//åˆå¹¶æ–‡ä»¶è·¯å¾„</span>
        String fileFullPath = <span class="hljs-keyword">this</span>.getFileFullPath(fileMd5, fileExt);
        File mergeFile = <span class="hljs-keyword">new</span> File(fileFullPath);
        <span class="hljs-comment">//åˆ›å»ºåˆå¹¶æ–‡ä»¶,å¦‚æœå­˜åœ¨åˆ™å…ˆåˆ é™¤å†åˆ›å»º</span>
        <span class="hljs-keyword">if</span>(mergeFile.exists())&#123;
            mergeFile.delete();
        &#125;
        <span class="hljs-keyword">boolean</span> newFile = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">try</span> &#123;
            newFile = mergeFile.createNewFile();
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"mergechunks..create mergeFile fail:&#123;&#125;"</span>,e.getMessage());
        &#125;
        <span class="hljs-keyword">if</span>(!newFile)&#123;
            <span class="hljs-comment">//æ–‡ä»¶åˆ›å»ºå¤±è´¥</span>
            ExceptionCast.cast(MediaCode.MERGE_FILE_CREATEFAIL);
        &#125;

        <span class="hljs-comment">//è·å–å—æ–‡ä»¶åˆ—è¡¨,æ­¤åˆ—è¡¨æ˜¯å·²ç»æ’åºå¥½çš„</span>
        List&lt;File&gt; chunkFiles = <span class="hljs-keyword">this</span>.getChunkFiles(chunkFloderPath);

        <span class="hljs-comment">//åˆå¹¶æ–‡ä»¶</span>
        mergeFile = <span class="hljs-keyword">this</span>.mergeFile(mergeFile, chunkFiles);
        <span class="hljs-keyword">if</span>(mergeFile == <span class="hljs-keyword">null</span>)&#123;
            ExceptionCast.cast(MediaCode.MERGE_FILE_FAIL);
        &#125;

        <span class="hljs-comment">//æ ¡éªŒæ–‡ä»¶</span>
        <span class="hljs-keyword">boolean</span> checkResult = <span class="hljs-keyword">this</span>.checkFileMd5(mergeFile, fileMd5);
        <span class="hljs-keyword">if</span>(!checkResult)&#123;
            ExceptionCast.cast(MediaCode.MERGE_FILE_CHECKFAIL);
        &#125;

        <span class="hljs-comment">//å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“</span>
        MediaFile mediaFile = <span class="hljs-keyword">new</span> MediaFile();
        mediaFile.setFileId(fileMd5);
        mediaFile.setFileName(fileMd5+<span class="hljs-string">"."</span>+fileExt);
        mediaFile.setFileOriginalName(fileName);

        <span class="hljs-comment">//æ–‡ä»¶è·¯å¾„ä¿å­˜ç›¸å¯¹è·¯å¾„</span>
        String filePath = <span class="hljs-keyword">this</span>.getFilePath(fileMd5,fileExt);
        mediaFile.setFilePath(<span class="hljs-keyword">this</span>.getFilePath(fileMd5,fileExt));
        mediaFile.setFileUrl(filePath + fileName + <span class="hljs-string">"."</span> + fileExt);
        mediaFile.setFileSize(fileSize);
        mediaFile.setUploadTime(<span class="hljs-keyword">new</span> Date());
        mediaFile.setMimeType(mimetype);
        mediaFile.setFileType(fileExt);

        <span class="hljs-comment">//çŠ¶æ€ä¸ºä¸Šä¼ æˆåŠŸ</span>
        mediaFile.setFileStatus(<span class="hljs-string">"301002"</span>);
        MediaFile save = mediaFileRepository.save(mediaFile);

        <span class="hljs-comment">//å‘MQå‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯</span>
        <span class="hljs-keyword">this</span>.sendProcessVideoMsg(fileMd5);

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);

    &#125;

    <span class="hljs-comment">//è§†é¢‘å¤„ç†è·¯ç”±</span>
    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;xc-service-manage-media.mq.routingkey-media-video&#125;"</span>)
    <span class="hljs-keyword">public</span> String routingkey_media_video;

    <span class="hljs-meta">@Autowired</span>
    RabbitTemplate rabbitTemplate;

    <span class="hljs-comment">//å‘MQå‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> ResponseResult <span class="hljs-title">sendProcessVideoMsg</span><span class="hljs-params">(String mediaId)</span></span>&#123;
        Optional&lt;MediaFile&gt; optional = mediaFileRepository.findById(mediaId);
        <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
        &#125;
        MediaFile mediaFile = optional.get();
        <span class="hljs-comment">//å‘é€è§†é¢‘å¤„ç†æ¶ˆæ¯</span>
        Map&lt;String,String&gt; msgMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        msgMap.put(<span class="hljs-string">"mediaId"</span>,mediaId);
        <span class="hljs-comment">//å‘é€çš„æ¶ˆæ¯</span>
        String msg = JSON.toJSONString(msgMap);
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-keyword">this</span>.rabbitTemplate.convertAndSend(RabbitMQConfig.EX_MEDIA_PROCESSTASK,routingkey_media_video,msg);
            LOGGER.info(<span class="hljs-string">"send media process task msg:&#123;&#125;"</span>,msg);
        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;
            e.printStackTrace();
            LOGGER.info(<span class="hljs-string">"send media process task error,msg is:&#123;&#125;,error:&#123;&#125;"</span>,msg,e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;

    <span class="hljs-comment">//æ ¡éªŒæ–‡ä»¶MD5</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkFileMd5</span><span class="hljs-params">(File mergeFile, String fileMd5)</span> </span>&#123;
        <span class="hljs-keyword">if</span>(mergeFile == <span class="hljs-keyword">null</span> || StringUtils.isEmpty(fileMd5))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        &#125;
        <span class="hljs-comment">//è¿›è¡Œmd5æ ¡éªŒ</span>
        <span class="hljs-keyword">try</span> &#123;
            FileInputStream fileInputStream = <span class="hljs-keyword">new</span> FileInputStream(mergeFile);
            <span class="hljs-comment">//å¾—åˆ°æ–‡ä»¶çš„MD5</span>
            String md5Hex = DigestUtils.md5Hex(fileInputStream);
            <span class="hljs-comment">//æ¯”è¾ƒä¸¤ä¸ªMD5å€¼</span>
            <span class="hljs-keyword">if</span>(md5Hex.equalsIgnoreCase(fileMd5))&#123;
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
            &#125;
        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"æœªæ‰¾åˆ°è¯¥æ–‡ä»¶ &#123;&#125;"</span>,e.getMessage());
        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;
            e.printStackTrace();
        &#125;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    &#125;
    <span class="hljs-comment">//åˆå¹¶æ–‡ä»¶</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> File <span class="hljs-title">mergeFile</span><span class="hljs-params">(File mergeFile, List&lt;File&gt; chunkFiles)</span> </span>&#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//åˆ›å»ºå†™æ–‡ä»¶å¯¹è±¡</span>
            RandomAccessFile raf_write = <span class="hljs-keyword">new</span> RandomAccessFile(mergeFile,<span class="hljs-string">"rw"</span>);
            <span class="hljs-comment">//éå†åˆ†å—æ–‡ä»¶å¼€å§‹åˆå¹¶</span>
            <span class="hljs-comment">//è¯»å–æ–‡ä»¶ç¼“å†²åŒº</span>
            <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];
            <span class="hljs-keyword">for</span>(File chunkFile:chunkFiles)&#123;
                RandomAccessFile raf_read = <span class="hljs-keyword">new</span> RandomAccessFile(chunkFile,<span class="hljs-string">"r"</span>);
                <span class="hljs-keyword">int</span> len = -<span class="hljs-number">1</span>;
                <span class="hljs-comment">//è¯»å–åˆ†å—æ–‡ä»¶</span>
                <span class="hljs-keyword">while</span>((len = raf_read.read(b))!= -<span class="hljs-number">1</span>)&#123;
                    <span class="hljs-comment">//å‘åˆå¹¶æ–‡ä»¶ä¸­å†™æ•°æ®</span>
                    raf_write.write(b,<span class="hljs-number">0</span>,len);
                &#125; 
                raf_read.close();
            &#125; 
            raf_write.close();
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            e.printStackTrace();
            LOGGER.error(<span class="hljs-string">"merge file error:&#123;&#125;"</span>,e.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125; 
        <span class="hljs-keyword">return</span> mergeFile;
    &#125;

    <span class="hljs-comment">//è·å–å—æ–‡ä»¶åˆ—è¡¨</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> List&lt;File&gt; <span class="hljs-title">getChunkFiles</span><span class="hljs-params">(String chunkFloderPath)</span> </span>&#123;
        <span class="hljs-comment">//å—æ–‡ä»¶ç›®å½•</span>
        File chunkFolder = <span class="hljs-keyword">new</span> File(chunkFloderPath);
        <span class="hljs-comment">//åˆ†å—æ–‡ä»¶åˆ—è¡¨</span>
        File[] fileArray = chunkFolder.listFiles();
        <span class="hljs-comment">//å°†åˆ†å—åˆ—è¡¨è½¬ä¸ºé›†åˆ,ä¾¿äºæ’åº</span>
        ArrayList&lt;File&gt; fileList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(fileArray));
        <span class="hljs-comment">//ä»å°åˆ°å¤§æ’åº,æŒ‰åç§°å‡åº</span>
        Collections.sort(fileList, <span class="hljs-keyword">new</span> Comparator&lt;File&gt;() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(File o1, File o2)</span> </span>&#123;
                <span class="hljs-comment">//æ¯”è¾ƒä¸¤ä¸ªæ–‡ä»¶çš„åç§°</span>
                <span class="hljs-keyword">if</span> (Integer.parseInt(o1.getName()) &lt; Integer.parseInt(o2.getName())) &#123;
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
                &#125;
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            &#125;
        &#125;);
        <span class="hljs-keyword">return</span> fileList;
    &#125;

    <span class="hljs-comment">//è·å–æ–‡ä»¶å—è·¯å¾„</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getChunkFloderPath</span><span class="hljs-params">(String fileMd5)</span> </span>&#123;
        <span class="hljs-comment">//è·å–åˆ†å—æ–‡ä»¶æ‰€å±ç›®å½•</span>
        String fileFloderPath = <span class="hljs-keyword">this</span>.getFileFloderPath(fileMd5);
        String chunkFloder = fileFloderPath + <span class="hljs-string">"chunk/"</span>;
        File fileChunkFloder = <span class="hljs-keyword">new</span> File(chunkFloder);
        <span class="hljs-comment">//å¦‚æœåˆ†å—æ‰€å±ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º</span>
        <span class="hljs-keyword">if</span>(!fileChunkFloder.exists())&#123;
            fileChunkFloder.mkdirs();
        &#125;
        <span class="hljs-keyword">return</span> chunkFloder;
    &#125;



    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ ¹æ®æ–‡ä»¶md5å¾—åˆ°æ–‡ä»¶çš„æ‰€å±ç›®å½•</span>
<span class="hljs-comment">     * è§„åˆ™ï¼š</span>
<span class="hljs-comment">     * ä¸€çº§ç›®å½•ï¼šmd5çš„ç¬¬ä¸€ä¸ªå­—ç¬¦</span>
<span class="hljs-comment">     * äºŒçº§ç›®å½•ï¼šmd5çš„ç¬¬äºŒä¸ªå­—ç¬¦</span>
<span class="hljs-comment">     * ä¸‰çº§ç›®å½•ï¼šmd5</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getFileFloderPath</span><span class="hljs-params">(String fileMd5)</span></span>&#123;
            String floderPath = uploadPath + <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) + <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>) + <span class="hljs-string">"/"</span> +fileMd5  + <span class="hljs-string">"/"</span>;
            <span class="hljs-keyword">return</span> floderPath;
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * è·å–å…¨æ–‡ä»¶è·¯å¾„</span>
<span class="hljs-comment">     * æ–‡ä»¶åï¼šmd5+æ–‡ä»¶æ‰©å±•å</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getFileFullPath</span><span class="hljs-params">(String fileMd5, String fileExt)</span></span>&#123;
        String floderPath = <span class="hljs-keyword">this</span>.getFileFloderPath(fileMd5);
        String filePath = floderPath + fileMd5 + <span class="hljs-string">"."</span> + fileExt;
        <span class="hljs-keyword">return</span> filePath;
    &#125;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * è·å–æ–‡ä»¶è·¯å¾„</span>
<span class="hljs-comment">     * æ–‡ä»¶åï¼šmd5+æ–‡ä»¶æ‰©å±•å</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getFilePath</span><span class="hljs-params">(String fileMd5, String fileExt)</span></span>&#123;
        String filePath = <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>) + <span class="hljs-string">"/"</span> + fileMd5.substring(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>) + <span class="hljs-string">"/"</span> + fileMd5 + <span class="hljs-string">"/"</span>;
        <span class="hljs-keyword">return</span> filePath;
    &#125;
&#125;</code></pre></div>

<h1 id="äºŒã€æˆ‘çš„åª’èµ„"><a href="#äºŒã€æˆ‘çš„åª’èµ„" class="headerlink" title="äºŒã€æˆ‘çš„åª’èµ„"></a>äºŒã€æˆ‘çš„åª’èµ„</h1><h2 id="1-éœ€æ±‚åˆ†æ-1"><a href="#1-éœ€æ±‚åˆ†æ-1" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>é€šè¿‡æˆ‘çš„åª’èµ„å¯ä»¥æŸ¥è¯¢æœ¬æ•™è‚²æœºæ„æ‹¥æœ‰çš„åª’èµ„æ–‡ä»¶ï¼Œè¿›è¡Œæ–‡ä»¶å¤„ç†ã€åˆ é™¤æ–‡ä»¶ã€ä¿®æ”¹æ–‡ä»¶ä¿¡æ¯ç­‰æ“ä½œï¼Œå…·ä½“éœ€æ±‚å¦‚<br>ä¸‹ï¼š</p>
<p>1ã€åˆ†é¡µæŸ¥è¯¢æˆ‘çš„åª’èµ„æ–‡ä»¶</p>
<p>2ã€åˆ é™¤åª’èµ„æ–‡ä»¶</p>
<p>3ã€å¤„ç†åª’èµ„æ–‡ä»¶</p>
<p>4ã€ä¿®æ”¹åª’èµ„æ–‡ä»¶ä¿¡æ¯</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image5" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image5.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="2-API"><a href="#2-API" class="headerlink" title="2. API"></a>2. API</h2><p>æœ¬èŠ‚è®²è§£æˆ‘çš„åª’èµ„æ–‡ä»¶åˆ†é¡µæŸ¥è¯¢ã€å¤„ç†åª’èµ„æ–‡ä»¶ï¼Œå…¶å®ƒåŠŸèƒ½è¯·å­¦å‘˜è‡ªè¡Œå®ç°</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(value = <span class="hljs-string">"åª’ä½“æ–‡ä»¶ç®¡ç†"</span>,description = <span class="hljs-string">"åª’ä½“æ–‡ä»¶ç®¡ç†æ¥å£"</span>,tags = &#123;<span class="hljs-string">"åª’ä½“æ–‡ä»¶ç®¡ç†æ¥å£"</span>&#125;)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileControllerApi</span> </span>&#123;
    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"æŸ¥è¯¢æ–‡ä»¶åˆ—è¡¨"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest)</span></span>;
&#125;</code></pre></div>

<h2 id="3-æœåŠ¡ç«¯å¼€å‘"><a href="#3-æœåŠ¡ç«¯å¼€å‘" class="headerlink" title="3. æœåŠ¡ç«¯å¼€å‘"></a>3. æœåŠ¡ç«¯å¼€å‘</h2><h3 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MongoRepository</span>&lt;<span class="hljs-title">MediaFile</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
&#125;</code></pre></div>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>å®šä¹‰ <code>findList</code> æ–¹æ³•å®ç°åª’èµ„æ–‡ä»¶æŸ¥è¯¢åˆ—è¡¨</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media.service;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.request.QueryMediaFileRequest;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.QueryResponseResult;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">MediaFileService</span> </span>&#123;
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æŸ¥è¯¢åª’ä½“é—®ä»·å†…ä¿¡æ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page é¡µç </span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size æ¯é¡µæ•°é‡</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queryMediaFileRequest æŸ¥è¯¢æ¡ä»¶</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest)</span></span>;
&#125;</code></pre></div>

<p>å®ç°</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.manage_media.service.impl;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.MediaFile;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.media.request.QueryMediaFileRequest;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.CommonCode;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.QueryResponseResult;
<span class="hljs-keyword">import</span> com.xuecheng.framework.model.response.QueryResult;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.dao.MediaFileRepository;
<span class="hljs-keyword">import</span> com.xuecheng.manage_media.service.MediaFileService;
<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Example;
<span class="hljs-keyword">import</span> org.springframework.data.domain.ExampleMatcher;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Page;
<span class="hljs-keyword">import</span> org.springframework.data.domain.PageRequest;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaFileServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaFileService</span> </span>&#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(MediaFileService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;

    <span class="hljs-meta">@Autowired</span>
    MediaFileRepository mediaFileRepository;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * åˆ†é¡µæŸ¥è¯¢æ–‡ä»¶ä¿¡æ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> page é¡µç </span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> size æ¯é¡µæ•°é‡</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> queryMediaFileRequest æŸ¥è¯¢æ¡ä»¶</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span> QueryResponseResult</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(<span class="hljs-keyword">int</span> page, <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest)</span> </span>&#123;
        MediaFile mediaFile = <span class="hljs-keyword">new</span> MediaFile();
        <span class="hljs-comment">//æŸ¥è¯¢æ¡ä»¶</span>
        <span class="hljs-keyword">if</span>(queryMediaFileRequest == <span class="hljs-keyword">null</span>)&#123;
            queryMediaFileRequest = <span class="hljs-keyword">new</span> QueryMediaFileRequest();
        &#125;

        <span class="hljs-comment">//æŸ¥è¯¢æ¡ä»¶åŒ¹é…å™¨</span>
        ExampleMatcher exampleMatcher = ExampleMatcher.matching()
                .withMatcher(<span class="hljs-string">"tag"</span>, ExampleMatcher.GenericPropertyMatchers.contains()) <span class="hljs-comment">//æ¨¡ç³ŠåŒ¹é…</span>
                .withMatcher(<span class="hljs-string">"fileOriginalName"</span>, ExampleMatcher.GenericPropertyMatchers.contains()) <span class="hljs-comment">//æ¨¡ç³ŠåŒ¹é…æ–‡ä»¶åŸå§‹åç§°</span>
                .withMatcher(<span class="hljs-string">"processStatus"</span>, ExampleMatcher.GenericPropertyMatchers.exact());<span class="hljs-comment">//ç²¾ç¡®åŒ¹é…</span>
        <span class="hljs-comment">//è®¾ç½®æŸ¥è¯¢æ¡ä»¶å¯¹è±¡</span>
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(queryMediaFileRequest.getTag()))&#123;
            <span class="hljs-comment">//è®¾ç½®æ ‡ç­¾</span>
            mediaFile.setTag(queryMediaFileRequest.getTag());
        &#125;
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(queryMediaFileRequest.getFileOriginalName()))&#123;
            <span class="hljs-comment">//è®¾ç½®æ–‡ä»¶åŸå§‹åç§°</span>
            mediaFile.setFileOriginalName(queryMediaFileRequest.getFileOriginalName());
        &#125;
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(queryMediaFileRequest.getProcessStatus()))&#123;
            <span class="hljs-comment">//è®¾ç½®å¤„ç†çŠ¶æ€</span>
            mediaFile.setProcessStatus(queryMediaFileRequest.getProcessStatus());
        &#125;

        <span class="hljs-comment">//å®šä¹‰Exampleå®ä¾‹</span>
        Example&lt;MediaFile&gt; example = Example.of(mediaFile, exampleMatcher);

        <span class="hljs-comment">//æ ¡éªŒpageå’Œsizeå‚æ•°çš„åˆæ³•æ€§,å¹¶è®¾ç½®é»˜è®¤å€¼</span>
        <span class="hljs-keyword">if</span>(page &lt;=<span class="hljs-number">0</span>)&#123;
            page = <span class="hljs-number">0</span>;
        &#125;<span class="hljs-keyword">else</span>&#123;
            page = page -<span class="hljs-number">1</span>;
        &#125;
        <span class="hljs-keyword">if</span>(size &lt;=<span class="hljs-number">0</span>)&#123;
            size = <span class="hljs-number">10</span>;
        &#125;

        <span class="hljs-comment">//åˆ†é¡µå¯¹è±¡</span>
        PageRequest pageRequest = <span class="hljs-keyword">new</span> PageRequest(page, size);
        <span class="hljs-comment">//åˆ†é¡µæŸ¥è¯¢</span>
        Page&lt;MediaFile&gt; all = mediaFileRepository.findAll(example, pageRequest);
        <span class="hljs-comment">//è®¾ç½®å“åº”å¯¹è±¡å±æ€§</span>
        QueryResult&lt;MediaFile&gt; mediaFileQueryResult = <span class="hljs-keyword">new</span> QueryResult&lt;MediaFile&gt;();
        mediaFileQueryResult.setList(all.getContent());
        mediaFileQueryResult.setTotal(all.getTotalElements());

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QueryResponseResult(CommonCode.SUCCESS,mediaFileQueryResult);
    &#125;
&#125;</code></pre></div>

<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/media/file"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MediaFileController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MediaFileControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    MediaFileService mediaFileService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/list/&#123;page&#125;/&#123;size&#125;"</span>)
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> QueryResponseResult <span class="hljs-title">findList</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"page"</span>)</span> <span class="hljs-keyword">int</span> page,@<span class="hljs-title">PathVariable</span><span class="hljs-params">(<span class="hljs-string">"size"</span>)</span> <span class="hljs-keyword">int</span> size, QueryMediaFileRequest queryMediaFileRequest) </span>&#123;
        <span class="hljs-comment">//åª’èµ„æ–‡ä»¶ä¿¡æ¯æŸ¥è¯¢</span>
        <span class="hljs-keyword">return</span> mediaFileService.findList(page,size,queryMediaFileRequest);
    &#125;
&#125;</code></pre></div>

<h3 id="æ¥å£æµ‹è¯•"><a href="#æ¥å£æµ‹è¯•" class="headerlink" title="æ¥å£æµ‹è¯•"></a>æ¥å£æµ‹è¯•</h3><p>ä½¿ç”¨ <code>swagger</code> è¿›è¡Œæ¥å£æµ‹è¯•</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image6" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image6.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="4-å‰ç«¯å¼€å‘"><a href="#4-å‰ç«¯å¼€å‘" class="headerlink" title="4. å‰ç«¯å¼€å‘"></a>4. å‰ç«¯å¼€å‘</h2><h3 id="APIæ–¹æ³•"><a href="#APIæ–¹æ³•" class="headerlink" title="APIæ–¹æ³•"></a>APIæ–¹æ³•</h3><p>åœ¨ <code>media</code> æ¨¡å—å®šä¹‰apiæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'./../../../base/api/public'</span>
<span class="hljs-keyword">import</span> querystring <span class="hljs-keyword">from</span> <span class="hljs-string">'querystring'</span>
<span class="hljs-keyword">let</span> sysConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@/../config/sysConfig'</span>)
<span class="hljs-keyword">let</span> apiUrl = sysConfig.xcApiUrlPre;

<span class="hljs-comment">/*é¡µé¢åˆ—è¡¨*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> media_list = <span class="hljs-function">(<span class="hljs-params">page,size,params</span>) =&gt;</span> &#123;
    <span class="hljs-comment">//paramsä¸ºjsonæ ¼å¼</span>
    <span class="hljs-comment">//ä½¿ç”¨querystringå°†jsonå¯¹è±¡è½¬æˆkey/valueä¸²</span>
    <span class="hljs-keyword">let</span> querys = querystring.stringify(params)
    <span class="hljs-keyword">return</span> http.requestQuickGet(apiUrl+<span class="hljs-string">'/media/file/list/'</span>+page+<span class="hljs-string">'/'</span>+size+<span class="hljs-string">'/?'</span>+querys)
&#125;

<span class="hljs-comment">/*å‘é€å¤„ç†æ¶ˆæ¯*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> media_process = <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/media/file/process/'</span>+id)
&#125;</code></pre></div>

<h3 id="é¡µé¢"><a href="#é¡µé¢" class="headerlink" title="é¡µé¢"></a>é¡µé¢</h3><p>åœ¨ <code>media</code> æ¨¡å—åˆ›å»º <code>media_list.vue</code>ï¼Œå¯å‚è€ƒ <code>cms</code>ç³»ç»Ÿçš„ <code>page_list.vue</code> æ¥ç¼–å†™æ­¤é¡µé¢ã€‚</p>
<p>1ã€è§†å›¾</p>
<div class="hljs"><pre><code class="hljs vue">&lt;template&gt;
  &lt;div&gt;
    &lt;!--æŸ¥è¯¢è¡¨å•--&gt;
    &lt;el-form :model&#x3D;&quot;params&quot;&gt;
      æ ‡ç­¾ï¼š
      &lt;el-input v-model&#x3D;&quot;params.tag&quot; style&#x3D;&quot;width:160px&quot;&gt;&lt;&#x2F;el-input&gt;
      åŸå§‹åç§°ï¼š
      &lt;el-input v-model&#x3D;&quot;params.fileOriginalName&quot; style&#x3D;&quot;width:160px&quot;&gt;&lt;&#x2F;el-input&gt;
      å¤„ç†çŠ¶æ€ï¼š
      &lt;el-select v-model&#x3D;&quot;params.processStatus&quot; placeholder&#x3D;&quot;è¯·é€‰æ‹©å¤„ç†çŠ¶æ€&quot;&gt;
        &lt;el-option
          v-for&#x3D;&quot;item in processStatusList&quot;
          :key&#x3D;&quot;item.id&quot;
          :label&#x3D;&quot;item.name&quot;
          :value&#x3D;&quot;item.id&quot;&gt;
        &lt;&#x2F;el-option&gt;
      &lt;&#x2F;el-select&gt;
      &lt;br&#x2F;&gt;
      &lt;el-button type&#x3D;&quot;primary&quot; v-on:click&#x3D;&quot;query&quot; size&#x3D;&quot;small&quot;&gt;æŸ¥è¯¢&lt;&#x2F;el-button&gt;
      &lt;router-link class&#x3D;&quot;mui-tab-item&quot; :to&#x3D;&quot;&#123;path:&#39;&#x2F;upload&#39;&#125;&quot;&gt;
        &lt;el-button  type&#x3D;&quot;primary&quot; size&#x3D;&quot;small&quot; v-if&#x3D;&quot;ischoose !&#x3D; true&quot;&gt;ä¸Šä¼ æ–‡ä»¶&lt;&#x2F;el-button&gt;
      &lt;&#x2F;router-link&gt;
    &lt;&#x2F;el-form&gt;
    &lt;!--åˆ—è¡¨--&gt;
    &lt;el-table :data&#x3D;&quot;list&quot; highlight-current-row v-loading&#x3D;&quot;listLoading&quot; style&#x3D;&quot;width: 100%;&quot;&gt;
      &lt;el-table-column type&#x3D;&quot;index&quot; width&#x3D;&quot;30&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileOriginalName&quot; label&#x3D;&quot;åŸå§‹æ–‡ä»¶åç§°&quot; width&#x3D;&quot;220&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileName&quot; label&#x3D;&quot;æ–‡ä»¶åç§°&quot; width&#x3D;&quot;220&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileUrl&quot; label&#x3D;&quot;è®¿é—®url&quot; width&#x3D;&quot;260&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;tag&quot; label&#x3D;&quot;æ ‡ç­¾&quot; width&#x3D;&quot;100&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;fileSize&quot; label&#x3D;&quot;æ–‡ä»¶å¤§å°&quot; width&#x3D;&quot;120&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;processStatus&quot; label&#x3D;&quot;å¤„ç†çŠ¶æ€&quot; width&#x3D;&quot;100&quot; :formatter&#x3D;&quot;formatProcessStatus&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column prop&#x3D;&quot;uploadTime&quot; label&#x3D;&quot;åˆ›å»ºæ—¶é—´&quot; width&#x3D;&quot;110&quot; :formatter&#x3D;&quot;formatCreatetime&quot;&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column label&#x3D;&quot;å¼€å§‹å¤„ç†&quot; width&#x3D;&quot;&quot; v-if&#x3D;&quot;ischoose !&#x3D; true&quot;&gt;
        &lt;template slot-scope&#x3D;&quot;scope&quot;&gt;
          &lt;el-button
            size&#x3D;&quot;small&quot; type&#x3D;&quot;primary&quot; plain @click&#x3D;&quot;process(scope.row.fileId)&quot;&gt;å¼€å§‹å¤„ç†
          &lt;&#x2F;el-button&gt;
        &lt;&#x2F;template&gt;
      &lt;&#x2F;el-table-column&gt;
      &lt;el-table-column label&#x3D;&quot;é€‰æ‹©&quot; width&#x3D;&quot;80&quot; v-if&#x3D;&quot;ischoose &#x3D;&#x3D; true&quot;&gt;
        &lt;template slot-scope&#x3D;&quot;scope&quot;&gt;
        &lt;el-button
          size&#x3D;&quot;small&quot; type&#x3D;&quot;primary&quot; plain @click&#x3D;&quot;choose(scope.row)&quot;&gt;é€‰æ‹©&lt;&#x2F;el-button&gt;
        &lt;&#x2F;template&gt;
      &lt;&#x2F;el-table-column&gt;
    &lt;&#x2F;el-table&gt;
    &lt;!--åˆ†é¡µ--&gt;
    &lt;el-col :span&#x3D;&quot;24&quot; class&#x3D;&quot;toolbar&quot;&gt;

      &lt;el-pagination background layout&#x3D;&quot;prev, pager, next&quot; @current-change&#x3D;&quot;changePage&quot; :page-size&#x3D;&quot;this.params.size&quot;
                     :total&#x3D;&quot;total&quot; :current-page&#x3D;&quot;this.params.page&quot;
                     style&#x3D;&quot;float:right;&quot;&gt;
      &lt;&#x2F;el-pagination&gt;
    &lt;&#x2F;el-col&gt;
  &lt;&#x2F;div&gt;
&lt;&#x2F;template&gt;</code></pre></div>

<p>2ã€æ•°æ®å¯¹è±¡ã€æ–¹æ³•ã€é’©å­å‡½æ•°</p>
<div class="hljs"><pre><code class="hljs vue">&lt;script&gt;
  import * as mediaApi from &#39;..&#x2F;api&#x2F;media&#39;
  import utilApi from &#39;@&#x2F;common&#x2F;utils&#39;;
  export default&#123;
    props: [&#39;ischoose&#39;],
    &#x2F;&#x2F; é¡µé¢æ•°æ®
    data()&#123;
      return &#123;
        params:&#123;
          page:1,&#x2F;&#x2F;é¡µç 
          size:10,&#x2F;&#x2F;æ¯é¡µæ˜¾ç¤ºä¸ªæ•°
          tag:&#39;&#39;,&#x2F;&#x2F;æ ‡ç­¾
          fileName:&#39;&#39;,&#x2F;&#x2F;æ–‡ä»¶åç§°
          processStatus:&#39;&#39;&#x2F;&#x2F;å¤„ç†çŠ¶æ€
        &#125;,
        listLoading:false,
        list:[],
        total:0,
        processStatusList:[]
      &#125;
    &#125;,

    &#x2F;&#x2F;æ–¹æ³•
    methods:&#123;
      formatCreatetime(row, column)&#123;
        var createTime &#x3D; new Date(row.uploadTime);
        if (createTime) &#123;
          return utilApi.formatDate(createTime, &#39;yyyy-MM-dd hh:mm:ss&#39;);
        &#125;
      &#125;,
      formatProcessStatus(row,column)&#123;
        var processStatus &#x3D; row.processStatus;
        if (processStatus) &#123;
            if(processStatus &#x3D;&#x3D; &#39;303001&#39;)&#123;
              return &quot;å¤„ç†ä¸­&quot;;
            &#125;else if(processStatus &#x3D;&#x3D; &#39;303002&#39;)&#123;
              return &quot;å¤„ç†æˆåŠŸ&quot;;
            &#125;else if(processStatus &#x3D;&#x3D; &#39;303003&#39;)&#123;
              return &quot;å¤„ç†å¤±è´¥&quot;;
            &#125;else if(processStatus &#x3D;&#x3D; &#39;303004&#39;)&#123;
              return &quot;æ— éœ€å¤„ç†&quot;;
            &#125;
        &#125;
      &#125;,
      choose(mediaFile)&#123;
          if(mediaFile.processStatus !&#x3D;&#39;303002&#39; &amp;&amp; mediaFile.processStatus !&#x3D;&#39;303004&#39;)&#123;
            this.$message.error(&#39;è¯¥æ–‡ä»¶æœªå¤„ç†ï¼Œä¸å…è®¸é€‰æ‹©&#39;);
            return ;
          &#125;
        if(!mediaFile.fileUrl)&#123;
          this.$message.error(&#39;è¯¥æ–‡ä»¶çš„è®¿é—®urlä¸ºç©ºï¼Œä¸å…è®¸é€‰æ‹©&#39;);
          return ;
        &#125;
        &#x2F;&#x2F;è°ƒç”¨çˆ¶ç»„ä»¶çš„choosemediaæ–¹æ³•
        this.$emit(&#39;choosemedia&#39;,mediaFile.fileId,mediaFile.fileOriginalName,mediaFile.fileUrl);
      &#125;,
      changePage(page)&#123;
        this.params.page &#x3D; page;
        this.query()
      &#125;,
      process (id) &#123;
&#x2F;&#x2F;        console.log(id)
        mediaApi.media_process(id).then((res)&#x3D;&gt;&#123;
          console.log(res)
         if(res.success)&#123;
           this.$message.success(&#39;å¼€å§‹å¤„ç†ï¼Œè¯·ç¨åæŸ¥çœ‹å¤„ç†ç»“æœ&#39;);
         &#125;else&#123;
           this.$message.error(&#39;æ“ä½œå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•&#39;);
         &#125;
        &#125;)
      &#125;,
      query()&#123;
        mediaApi.media_list(this.params.page,this.params.size,this.params).then((res)&#x3D;&gt;&#123;
          console.log(res)
          this.total &#x3D; res.queryResult.total
          this.list &#x3D; res.queryResult.list
        &#125;)
      &#125;
    &#125;,

    &#x2F;&#x2F;é¡µé¢åˆå§‹åŒ–å®Œæˆå‰é’©å­
    created()&#123;
        &#x2F;&#x2F;é»˜è®¤ç¬¬ä¸€é¡µ
      this.params.page &#x3D; Number.parseInt(this.$route.query.page||1);
    &#125;,
    &#x2F;&#x2F;é¡µé¢åˆå§‹åŒ–åŠ è½½å‰çš„é’©å­
    mounted() &#123;
      &#x2F;&#x2F;é»˜è®¤æŸ¥è¯¢é¡µé¢
      this.query()
      &#x2F;&#x2F;åˆå§‹åŒ–å¤„ç†çŠ¶æ€
      this.processStatusList &#x3D; [
        &#123;
          id:&#39;&#39;,
          name:&#39;å…¨éƒ¨&#39;
        &#125;,
        &#123;
          id:&#39;303001&#39;,
          name:&#39;å¤„ç†ä¸­&#39;
        &#125;,
        &#123;
          id:&#39;303002&#39;,
          name:&#39;å¤„ç†æˆåŠŸ&#39;
        &#125;,
        &#123;
          id:&#39;303003&#39;,
          name:&#39;å¤„ç†å¤±è´¥&#39;
        &#125;,
        &#123;
          id:&#39;303004&#39;,
          name:&#39;æ— éœ€å¤„ç†&#39;
        &#125;
      ]
    &#125;
  &#125;
&lt;&#x2F;script&gt;</code></pre></div>

<h1 id="ä¸‰ã€åª’èµ„ä¸è¯¾ç¨‹è®¡åˆ’å…³è”"><a href="#ä¸‰ã€åª’èµ„ä¸è¯¾ç¨‹è®¡åˆ’å…³è”" class="headerlink" title="ä¸‰ã€åª’èµ„ä¸è¯¾ç¨‹è®¡åˆ’å…³è”"></a>ä¸‰ã€åª’èµ„ä¸è¯¾ç¨‹è®¡åˆ’å…³è”</h1><h2 id="1-éœ€æ±‚åˆ†æ-2"><a href="#1-éœ€æ±‚åˆ†æ-2" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåª’èµ„ç®¡ç†å·²å®Œæˆæ–‡ä»¶ä¸Šä¼ ã€è§†é¢‘å¤„ç†ã€æˆ‘çš„åª’èµ„åŠŸèƒ½ç­‰åŸºæœ¬åŠŸèƒ½ã€‚å…¶å®ƒæ¨¡å—å·²å¯ä»¥ä½¿ç”¨åª’èµ„ç®¡ç†åŠŸ<br>èƒ½ï¼Œæœ¬èŠ‚è¦è®²è§£è¯¾ç¨‹è®¡åˆ’åœ¨ç¼–è¾‘æ—¶å¦‚ä½•é€‰æ‹©åª’èµ„æ–‡ä»¶ã€‚</p>
<p>æ“ä½œçš„ä¸šåŠ¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ã€è¿›å…¥è¯¾ç¨‹è®¡åˆ’ä¿®æ”¹é¡µé¢</p>
<p>2ã€é€‰æ‹©è§†é¢‘</p>
<p>æ‰“å¼€åª’èµ„æ–‡ä»¶æŸ¥è¯¢çª—å£ï¼Œæ‰¾åˆ°è¯¥è¯¾ç¨‹ç« èŠ‚çš„è§†é¢‘ï¼Œé€‰æ‹©æ­¤è§†é¢‘ã€‚</p>
<p>ç‚¹å‡» â€œ<code>é€‰æ‹©åª’èµ„æ–‡ä»¶</code>â€ æ‰“å¼€åª’èµ„æ–‡ä»¶åˆ—è¡¨</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image7" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image7.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>3ã€ é€‰æ‹©æˆåŠŸåï¼Œå°†åœ¨è¯¾ç¨‹ç®¡ç†æ•°æ®åº“ä¿å­˜è¯¾ç¨‹è®¡åˆ’å¯¹åº”åœ¨çš„è¯¾ç¨‹è§†é¢‘åœ°å€ã€‚</p>
<p>åœ¨è¯¾ç¨‹ç®¡ç†æ•°æ®åº“åˆ›å»ºè¡¨ <code>teachplan_media</code> å­˜å‚¨è¯¾ç¨‹è®¡åˆ’ä¸åª’èµ„å…³è”ä¿¡æ¯ï¼Œè¡¨ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image8" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image8.png" srcset="/img/loading.gif" alt="img"></a></p>
<h2 id="2-é€‰æ‹©è§†é¢‘"><a href="#2-é€‰æ‹©è§†é¢‘" class="headerlink" title="2. é€‰æ‹©è§†é¢‘"></a>2. é€‰æ‹©è§†é¢‘</h2><h3 id="Vue-çˆ¶å­ç»„ä»¶é€šä¿¡"><a href="#Vue-çˆ¶å­ç»„ä»¶é€šä¿¡" class="headerlink" title="Vue çˆ¶å­ç»„ä»¶é€šä¿¡"></a>Vue çˆ¶å­ç»„ä»¶é€šä¿¡</h3><p>ä¸Šä¸€ç« å·²å®ç°äº†æˆ‘çš„åª’èµ„é¡µé¢ï¼Œæ‰€ä»¥åª’èµ„æŸ¥è¯¢çª—å£é¡µé¢ä¸éœ€è¦å†å¼€å‘ï¼Œå°† â€œ<code>æˆ‘çš„åª’èµ„é¡µé¢</code>â€ ä½œä¸ºä¸€ä¸ªç»„ä»¶åœ¨ä¿®æ”¹è¯¾ç¨‹<br>è®¡åˆ’é¡µé¢ä¸­å¼•ç”¨ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image9" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image9.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>ä¿®æ”¹è¯¾ç¨‹è®¡åˆ’é¡µé¢ä¸ºçˆ¶ç»„ä»¶ï¼Œæˆ‘çš„åª’èµ„æŸ¥è¯¢é¡µé¢ä¸ºå­ç»„ä»¶ã€‚</p>
<p>é—®é¢˜1ï¼š</p>
<p>æˆ‘çš„åª’èµ„é¡µé¢åœ¨é€‰æ‹©åª’èµ„æ–‡ä»¶æ—¶ä¸å…è®¸æ˜¾ç¤ºï¼Œæ¯”å¦‚ <code>è§†é¢‘å¤„ç†</code> æŒ‰é’®ï¼Œè¯¥å¦‚ä½•æ§åˆ¶ï¼Ÿ</p>
<p>è¿™æ—¶å°±éœ€è¦çˆ¶ç»„ä»¶ï¼ˆ<code>ä¿®æ”¹è¯¾ç¨‹è®¡åˆ’é¡µé¢</code>ï¼‰å‘å­ç»„ä»¶ï¼ˆ<code>æˆ‘çš„åª’èµ„é¡µé¢</code>ï¼‰ä¼ å…¥ä¸€ä¸ªå˜é‡ï¼Œä½¿ç”¨æ­¤å˜é‡æ¥æ§åˆ¶å½“å‰æ˜¯å¦è¿›å…¥é€‰æ‹©åª’èµ„æ–‡ä»¶ä¸šåŠ¡ï¼Œä»è€Œæ§åˆ¶å“ªäº›å…ƒç´ ä¸æ˜¾ç¤ºï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image10" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image10.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>é—®é¢˜2ï¼š</p>
<p>åœ¨æˆ‘çš„åª’èµ„é¡µé¢é€‰æ‹©äº†åª’èµ„æ–‡ä»¶ï¼Œå¦‚ä½•å°†é€‰æ‹©çš„åª’èµ„æ–‡ä»¶ä¿¡æ¯ä¼ åˆ°çˆ¶ç»„ä»¶ï¼Ÿ</p>
<p>è¿™æ—¶å°±éœ€è¦å­ç»„ä»¶è°ƒç”¨çˆ¶ç»„ä»¶çš„æ–¹æ³•æ¥è§£å†³æ­¤é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image11" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image11.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="çˆ¶ç»„ä»¶ï¼šä¿®æ”¹è¯¾ç¨‹è®¡åˆ’"><a href="#çˆ¶ç»„ä»¶ï¼šä¿®æ”¹è¯¾ç¨‹è®¡åˆ’" class="headerlink" title="çˆ¶ç»„ä»¶ï¼šä¿®æ”¹è¯¾ç¨‹è®¡åˆ’"></a>çˆ¶ç»„ä»¶ï¼šä¿®æ”¹è¯¾ç¨‹è®¡åˆ’</h3><p>æœ¬èŠ‚å®ç°åŠŸèƒ½ï¼šåœ¨è¯¾ç¨‹è®¡åˆ’é¡µé¢æ‰“å¼€æˆ‘çš„åª’èµ„é¡µé¢ã€‚</p>
<p>1ã€å¼•å…¥å­ç»„ä»¶</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> mediaList <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/media/page/media_list.vue'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;
    components:&#123;
        mediaList
    &#125;,
    data() &#123;
        ....</code></pre></div>

<p>2ã€ä½¿ç”¨å­ç»„ä»¶</p>
<p>åœ¨çˆ¶ç»„ä»¶çš„è§†å›¾ä¸­ä½¿ç”¨å­ç»„ä»¶ï¼ŒåŒæ—¶ä¼ å…¥å˜é‡ <code>ischoose</code>ï¼Œå¹¶æŒ‡å®šçˆ¶ç»„ä»¶çš„æ–¹æ³•åä¸º<code>choosemedia</code></p>
<p>è¿™é‡Œä½¿ç”¨ <code>el-dialog</code> å®ç°å¼¹å‡ºçª—å£ã€‚</p>
<div class="hljs"><pre><code class="hljs vue">&lt;elâ€dialog title&#x3D;&quot;é€‰æ‹©åª’èµ„æ–‡ä»¶&quot; :visible.sync&#x3D;&quot;mediaFormVisible&quot;&gt;
	&lt;mediaâ€list vâ€bind:ischoose&#x3D;&quot;true&quot; @choosemedia&#x3D;&quot;choosemedia&quot;&gt;&lt;&#x2F;mediaâ€list&gt;
&lt;&#x2F;elâ€dialog&gt;</code></pre></div>

<p>3ã€choosemedia æ–¹æ³•</p>
<p>åœ¨çˆ¶ç»„ä»¶ä¸­å®šä¹‰ <code>choosemedia</code> æ–¹æ³•ï¼Œæ¥æ”¶å­ç»„ä»¶è°ƒç”¨ï¼Œå‚æ•°åŒ…æ‹¬ï¼šåª’èµ„æ–‡ä»¶ <code>id</code>ã€åª’èµ„æ–‡ä»¶çš„åŸå§‹åç§°ã€åª’èµ„æ–‡ä»¶ <code>url</code></p>
<div class="hljs"><pre><code class="hljs js">choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
&#125;</code></pre></div>

<p>4ã€æ‰“å¼€å­ç»„ä»¶çª—å£</p>
<p>1ï¼‰æ‰“å¼€å­ç»„ä»¶çª—å£æŒ‰é’®å®šä¹‰</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">elâ€button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"fontâ€size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on</span>â€<span class="hljs-attr">click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.choosevideo(data.id) &#125;&gt;é€‰æ‹©è§†é¢‘<span class="hljs-tag">&lt;/<span class="hljs-name">elâ€button</span>&gt;</span></code></pre></div>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image12" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image12.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>2ï¼‰æ‰“å¼€å­ç»„ä»¶çª—å£æ–¹æ³•</p>
<p>å®šä¹‰ <code>querymedia</code> æ–¹æ³•ï¼š</p>
<div class="hljs"><pre><code class="hljs js">methods: &#123;
    <span class="hljs-comment">//æ‰“å¼€æŸ¥è¯¢åª’èµ„æ–‡ä»¶çª—å£ï¼Œä¼ å…¥è¯¾ç¨‹è®¡åˆ’id</span>
    choosevideo(teachplanId)&#123;
        <span class="hljs-keyword">this</span>.activeTeachplanId = teachplanId;
        <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-literal">true</span>;
    &#125;,
    ...
&#125;</code></pre></div>

<h3 id="å­ç»„ä»¶ï¼šæˆ‘çš„åª’èµ„æŸ¥è¯¢"><a href="#å­ç»„ä»¶ï¼šæˆ‘çš„åª’èµ„æŸ¥è¯¢" class="headerlink" title="å­ç»„ä»¶ï¼šæˆ‘çš„åª’èµ„æŸ¥è¯¢"></a>å­ç»„ä»¶ï¼šæˆ‘çš„åª’èµ„æŸ¥è¯¢</h3><p>1ã€å®šä¹‰ <code>ischoose</code> å˜é‡ï¼Œæ¥æ”¶çˆ¶ç»„ä»¶ä¼ å…¥çš„ <code>ischoose</code></p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>&#123;
    props: [<span class="hljs-string">'ischoose'</span>],
    data()&#123;</code></pre></div>

<p>2ã€çˆ¶ç»„ä»¶ä¼ çš„ <code>ischoose</code> å˜é‡ä¸º <code>true</code> æ—¶è¡¨ç¤ºå½“å‰æ˜¯é€‰æ‹©åª’èµ„æ–‡ä»¶ä¸šåŠ¡ï¼Œéœ€è¦æ§åˆ¶é¡µé¢å…ƒç´ æ˜¯å¦æ˜¾ç¤º</p>
<p>1ï¼‰<code>ischoose=true</code>ï¼Œé€‰æ‹©æŒ‰é’®æ˜¾ç¤º</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">elâ€tableâ€column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"é€‰æ‹©"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"80"</span> <span class="hljs-attr">v</span>â€<span class="hljs-attr">if</span>=<span class="hljs-string">"ischoose == true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot</span>â€<span class="hljs-attr">scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">elâ€button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"choose(scope.row)"</span>&gt;</span>é€‰æ‹©<span class="hljs-tag">&lt;/<span class="hljs-name">elâ€button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">elâ€tableâ€column</span>&gt;</span></code></pre></div>

<p>2ï¼‰<code>ischoose=false</code>ï¼Œè§†é¢‘å¤„ç†æŒ‰é’®æ˜¾ç¤º</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">elâ€tableâ€column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"å¼€å§‹å¤„ç†"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">v</span>â€<span class="hljs-attr">if</span>=<span class="hljs-string">"ischoose != true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot</span>â€<span class="hljs-attr">scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">elâ€button</span></span>
<span class="hljs-tag">                   <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"process(scope.row.fileId)"</span>&gt;</span>å¼€å§‹å¤„ç†
            <span class="hljs-tag">&lt;/<span class="hljs-name">elâ€button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">elâ€tableâ€column</span>&gt;</span></code></pre></div>

<p>3ï¼‰é€‰æ‹©åª’èµ„æ–‡ä»¶æ–¹æ³•</p>
<p>ç”¨æˆ·ç‚¹å‡»â€œé€‰æ‹©â€æŒ‰é’®å°†å‘çˆ¶ç»„ä»¶ä¼ é€’åª’èµ„æ–‡ä»¶ä¿¡æ¯</p>
<div class="hljs"><pre><code class="hljs js">choose(mediaFile)&#123;
    <span class="hljs-keyword">if</span>(mediaFile.processStatus !=<span class="hljs-string">'303002'</span> &amp;&amp; mediaFile.processStatus !=<span class="hljs-string">'303004'</span>)&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'è¯¥æ–‡ä»¶æœªå¤„ç†ï¼Œä¸å…è®¸é€‰æ‹©'</span>);
        <span class="hljs-keyword">return</span> ;
    &#125;
    <span class="hljs-keyword">if</span>(!mediaFile.fileUrl)&#123;
        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'è¯¥æ–‡ä»¶çš„è®¿é—®urlä¸ºç©ºï¼Œä¸å…è®¸é€‰æ‹©'</span>);
        <span class="hljs-keyword">return</span> ;
    &#125; 
    <span class="hljs-comment">//è°ƒç”¨çˆ¶ç»„ä»¶çš„choosemediaæ–¹æ³•</span>
    <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'choosemedia'</span>,mediaFile.fileId,mediaFile.fileOriginalName);
&#125;</code></pre></div>

<h3 id="é¡µé¢æ•ˆæœ"><a href="#é¡µé¢æ•ˆæœ" class="headerlink" title="é¡µé¢æ•ˆæœ"></a>é¡µé¢æ•ˆæœ</h3><p><a href="https://qnoss.codeyee.com/20200704_14/image13" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image13.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="å…¨éƒ¨ä»£ç "><a href="#å…¨éƒ¨ä»£ç " class="headerlink" title="å…¨éƒ¨ä»£ç "></a>å…¨éƒ¨ä»£ç </h3><h4 id="course-plan-vue"><a href="#course-plan-vue" class="headerlink" title="course_plan.vue"></a>course_plan.vue</h4><div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"teachplayFormVisible = true"</span>&gt;</span>æ·»åŠ è¯¾ç¨‹è®¡åˆ’<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:data</span>=<span class="hljs-string">"teachplanList"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:props</span>=<span class="hljs-string">"defaultProps"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">node-key</span>=<span class="hljs-string">"id"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">default-expand-all</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:expand-on-click-node</span>=<span class="hljs-string">"false"</span></span>
<span class="hljs-tag">      <span class="hljs-attr">:render-content</span>=<span class="hljs-string">"renderContent"</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-tree</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"æ·»åŠ è¯¾ç¨‹è®¡åˆ’"</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"teachplayFormVisible"</span> &gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"teachplanForm"</span>  <span class="hljs-attr">:model</span>=<span class="hljs-string">"teachplanActive"</span> <span class="hljs-attr">label-width</span>=<span class="hljs-string">"140px"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:600px;"</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">"teachplanRules"</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"ä¸Šçº§ç»“ç‚¹"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.parentid"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"ä¸å¡«è¡¨ç¤ºæ ¹ç»“ç‚¹"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span></span>
<span class="hljs-tag">              <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in teachplanList"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:label</span>=<span class="hljs-string">"item.pname"</span></span>
<span class="hljs-tag">              <span class="hljs-attr">:value</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-option</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"ç« èŠ‚/è¯¾æ—¶åç§°"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"pname"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.pname"</span> <span class="hljs-attr">auto-complete</span>=<span class="hljs-string">"off"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"è¯¾ç¨‹ç±»å‹"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-radio-group</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.ptype"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'1'</span>&gt;</span>è§†é¢‘<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'2'</span>&gt;</span>æ–‡æ¡£<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-radio-group</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰  è¯·è¾“å…¥æ•°å­—"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.timelength"</span> <span class="hljs-attr">auto-complete</span>=<span class="hljs-string">"off"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"æ’åºå­—æ®µ"</span> &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.orderby"</span> <span class="hljs-attr">auto-complete</span>=<span class="hljs-string">"off"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"ç« èŠ‚/è¯¾æ—¶ä»‹ç»"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"description"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"textarea"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.description"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"çŠ¶æ€"</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"status"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-radio-group</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"teachplanActive.status"</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"0"</span> &gt;</span>æœªå‘å¸ƒ<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-radio</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"radio"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">'1'</span>&gt;</span>å·²å‘å¸ƒ<span class="hljs-tag">&lt;/<span class="hljs-name">el-radio</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-radio-group</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span>  &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"addTeachplan"</span>&gt;</span>æäº¤<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"resetForm"</span>&gt;</span>é‡ç½®<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>

      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"é€‰æ‹©åª’èµ„æ–‡ä»¶"</span> <span class="hljs-attr">:visible.sync</span>=<span class="hljs-string">"mediaFormVisible"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">media-list</span> <span class="hljs-attr">v-bind:ischoose</span>=<span class="hljs-string">"true"</span> @<span class="hljs-attr">choosemedia</span>=<span class="hljs-string">"choosemedia"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">media-list</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
<span class="javascript">  <span class="hljs-keyword">let</span> id = <span class="hljs-number">1000</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> courseApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../api/course'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> utilApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../common/utils'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> systemApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../../../../base/api/system'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> mediaList <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/media/page/media_list.vue'</span>;</span>

<span class="javascript">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;</span>
    components:&#123;
      mediaList
    &#125;,
    data() &#123;
<span class="actionscript">      <span class="hljs-keyword">return</span> &#123;</span>
<span class="actionscript">        mediaFormVisible:<span class="hljs-literal">false</span>,</span>
<span class="actionscript">        teachplayFormVisible:<span class="hljs-literal">false</span>,<span class="hljs-comment">//æ§åˆ¶æ·»åŠ çª—å£æ˜¯å¦æ˜¾ç¤º</span></span>
        teachplanList : [&#123;
          id: 1,
<span class="actionscript">          pname: <span class="hljs-string">'ä¸€çº§ 1'</span>,</span>
          children: [&#123;
            id: 4,
<span class="actionscript">            pname: <span class="hljs-string">'äºŒçº§ 1-1'</span>,</span>
            children: [&#123;
              id: 9,
<span class="actionscript">              pname: <span class="hljs-string">'ä¸‰çº§ 1-1-1'</span></span>
            &#125;, &#123;
              id: 10,
<span class="actionscript">              pname: <span class="hljs-string">'ä¸‰çº§ 1-1-2'</span></span>
            &#125;]
          &#125;]
        &#125;],
        defaultProps:&#123;
<span class="actionscript">          children: <span class="hljs-string">'children'</span>,</span>
<span class="actionscript">          label: <span class="hljs-string">'pname'</span></span>
        &#125;,
        teachplanRules: &#123;
          pname: [
<span class="actionscript">            &#123;required: <span class="hljs-literal">true</span>, message: <span class="hljs-string">'è¯·è¾“å…¥è¯¾ç¨‹è®¡åˆ’åç§°'</span>, trigger: <span class="hljs-string">'blur'</span>&#125;</span>
          ],
          status: [
<span class="actionscript">            &#123;required: <span class="hljs-literal">true</span>, message: <span class="hljs-string">'è¯·é€‰æ‹©çŠ¶æ€'</span>, trigger: <span class="hljs-string">'blur'</span>&#125;</span>
          ]
        &#125;,
        teachplanActive:&#123;&#125;,
<span class="actionscript">        teachplanId:<span class="hljs-string">''</span></span>
      &#125;
    &#125;,
    methods: &#123;
<span class="actionscript">        <span class="hljs-comment">//é€‰æ‹©è§†é¢‘ï¼Œæ‰“å¼€çª—å£</span></span>
      choosevideo(data)&#123;
<span class="actionscript">          <span class="hljs-comment">//å¾—åˆ°å½“å‰çš„è¯¾ç¨‹è®¡åˆ’</span></span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.teachplanId = data.id</span>
<span class="actionscript"><span class="hljs-comment">//        alert(this.teachplanId)</span></span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-literal">true</span>;<span class="hljs-comment">//æ‰“å¼€çª—å£</span></span>
      &#125;,
<span class="actionscript">      <span class="hljs-comment">//ä¿å­˜é€‰æ‹©çš„è§†é¢‘</span></span>
      choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
<span class="actionscript">        <span class="hljs-comment">//ä¿å­˜è§†é¢‘åˆ°è¯¾ç¨‹è®¡åˆ’è¡¨ä¸­</span></span>
<span class="javascript">        <span class="hljs-keyword">let</span> teachplanMedia =&#123;&#125;</span>
        teachplanMedia.mediaId =mediaId;
        teachplanMedia.mediaFileOriginalName =fileOriginalName;
        teachplanMedia.mediaUrl =mediaUrl;
<span class="actionscript">        teachplanMedia.courseId =<span class="hljs-keyword">this</span>.courseid;</span>
<span class="actionscript">        <span class="hljs-comment">//è¯¾ç¨‹è®¡åˆ’</span></span>
<span class="actionscript">        teachplanMedia.teachplanId=<span class="hljs-keyword">this</span>.teachplanId</span>

<span class="javascript">        courseApi.savemedia(teachplanMedia).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span>
            if(res.success)&#123;
<span class="actionscript">                <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"é€‰æ‹©è§†é¢‘æˆåŠŸ"</span>)</span>
<span class="actionscript">              <span class="hljs-comment">//æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’</span></span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.findTeachplan()</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span>&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.$message.error(res.message)</span>
            &#125;
        &#125;)
      &#125;,
<span class="actionscript">      <span class="hljs-comment">//æäº¤è¯¾ç¨‹è®¡åˆ’</span></span>
      addTeachplan()&#123;
<span class="actionscript">        <span class="hljs-comment">//æ ¡éªŒè¡¨å•</span></span>
<span class="javascript">        <span class="hljs-keyword">this</span>.$refs.teachplanForm.validate(<span class="hljs-function">(<span class="hljs-params">valid</span>) =&gt;</span> &#123;</span>
            if (valid) &#123;
<span class="actionscript">                <span class="hljs-comment">//è°ƒç”¨apiæ–¹æ³•</span></span>
<span class="actionscript">              <span class="hljs-comment">//å°†è¯¾ç¨‹idè®¾ç½®åˆ°teachplanActive</span></span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.teachplanActive.courseid = <span class="hljs-keyword">this</span>.courseid</span>
<span class="javascript">              courseApi.addTeachplan(<span class="hljs-keyword">this</span>.teachplanActive).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span>
                if(res.success)&#123;
<span class="actionscript">                    <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"æ·»åŠ æˆåŠŸ"</span>)</span>
<span class="actionscript">                    <span class="hljs-comment">//åˆ·æ–°æ ‘</span></span>
<span class="actionscript">                    <span class="hljs-keyword">this</span>.findTeachplan()</span>
<span class="actionscript">                &#125;<span class="hljs-keyword">else</span>&#123;</span>
<span class="actionscript">                  <span class="hljs-keyword">this</span>.$message.error(res.message)</span>
                &#125;

              &#125;)
            &#125;
        &#125;)
      &#125;,
<span class="actionscript">  <span class="hljs-comment">//é‡ç½®è¡¨å•</span></span>
      resetForm()&#123;
<span class="actionscript">        <span class="hljs-keyword">this</span>.teachplanActive = &#123;&#125;</span>
      &#125;,

      append(data) &#123;
<span class="actionscript">        <span class="hljs-keyword">const</span> newChild = &#123; id: id++, label: <span class="hljs-string">'testtest'</span>, children: [] &#125;;</span>
        if (!data.children) &#123;
<span class="actionscript">          <span class="hljs-keyword">this</span>.$<span class="hljs-keyword">set</span>(data, <span class="hljs-string">'children'</span>, []);</span>
        &#125;
        data.children.push(newChild);

      &#125;,
      edit(data)&#123;
<span class="actionscript">        <span class="hljs-comment">//alert(data.id);</span></span>
      &#125;,
      remove(node, data) &#123;
<span class="actionscript">        <span class="hljs-keyword">const</span> parent = node.parent;</span>
<span class="actionscript">        <span class="hljs-keyword">const</span> children = parent.data.children || parent.data;</span>
<span class="javascript">        <span class="hljs-keyword">const</span> index = children.findIndex(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.id === data.id);</span>
        children.splice(index, 1);

      &#125;,
      renderContent(h, &#123; node, data, store &#125;) &#123;
<span class="actionscript">        <span class="hljs-keyword">return</span> (</span>
<span class="handlebars"><span class="xml">          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"flex: 1; display: flex; align-items: center; justify-content: space-between; font-size: 14px; padding-right: 8px;"</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;node.label&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on-click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.choosevideo(data) &#125;&gt;&#123;data.mediaFileOriginalName&#125;<span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span> é€‰æ‹©è§†é¢‘<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on-click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.edit(data) &#125;&gt;ä¿®æ”¹<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">              <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on-click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.remove(node, data) &#125;&gt;åˆ é™¤<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span></span>
<span class="handlebars"><span class="xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>);</span></span>
      &#125;,
      findTeachplan()&#123;
<span class="actionscript">        <span class="hljs-keyword">this</span>.teachplanList = []</span>
<span class="actionscript">        <span class="hljs-comment">//æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’</span></span>
<span class="javascript">        courseApi.findTeachplanList(<span class="hljs-keyword">this</span>.courseid).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;</span>
            if(res &amp;&amp; res.children)&#123;
<span class="actionscript">              <span class="hljs-keyword">this</span>.teachplanList = res.children;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> &#123;</span>
<span class="actionscript">              <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">"è¯¾ç¨‹è®¡åˆ’æŸ¥è¯¢å¤±è´¥"</span>)</span>
<span class="javascript">              <span class="hljs-built_in">console</span>.log(res)</span>
            &#125;
        &#125;)
      &#125;
    &#125;,
    mounted()&#123;
<span class="actionscript">      <span class="hljs-comment">//è¯¾ç¨‹id</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.courseid = <span class="hljs-keyword">this</span>.$route.params.courseid;</span>
<span class="actionscript">      <span class="hljs-comment">//æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.findTeachplan()</span>
    &#125;
  &#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></code></pre></div>

<h4 id="media-list-vue"><a href="#media-list-vue" class="headerlink" title="media_list.vue"></a>media_list.vue</h4><div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!--æŸ¥è¯¢è¡¨å•--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"params"</span>&gt;</span>
      æ ‡ç­¾ï¼š
      <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"params.tag"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:160px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
      åŸå§‹åç§°ï¼š
      <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"params.fileOriginalName"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:160px"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
      å¤„ç†çŠ¶æ€ï¼š
      <span class="hljs-tag">&lt;<span class="hljs-name">el-select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"params.processStatus"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"è¯·é€‰æ‹©å¤„ç†çŠ¶æ€"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-option</span></span>
<span class="hljs-tag">          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in processStatusList"</span></span>
<span class="hljs-tag">          <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span></span>
<span class="hljs-tag">          <span class="hljs-attr">:label</span>=<span class="hljs-string">"item.name"</span></span>
<span class="hljs-tag">          <span class="hljs-attr">:value</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-select</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"query"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>&gt;</span>æŸ¥è¯¢<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-link</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"mui-tab-item"</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">"&#123;path:'/upload'&#125;"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span>  <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ischoose != true"</span>&gt;</span>ä¸Šä¼ æ–‡ä»¶<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">router-link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>
    <span class="hljs-comment">&lt;!--åˆ—è¡¨--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-table</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">highlight-current-row</span> <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"listLoading"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%;"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"30"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileOriginalName"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"åŸå§‹æ–‡ä»¶åç§°"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"220"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileName"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"æ–‡ä»¶åç§°"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"220"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileUrl"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"è®¿é—®url"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"260"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"tag"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"æ ‡ç­¾"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"fileSize"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"æ–‡ä»¶å¤§å°"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"120"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"processStatus"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"å¤„ç†çŠ¶æ€"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">:formatter</span>=<span class="hljs-string">"formatProcessStatus"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"uploadTime"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"åˆ›å»ºæ—¶é—´"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"110"</span> <span class="hljs-attr">:formatter</span>=<span class="hljs-string">"formatCreatetime"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"å¼€å§‹å¤„ç†"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">""</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ischoose != true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot-scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span>
<span class="hljs-tag">            <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"process(scope.row.fileId)"</span>&gt;</span>å¼€å§‹å¤„ç†
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"é€‰æ‹©"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"80"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"ischoose == true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot-scope</span>=<span class="hljs-string">"scope"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span></span>
<span class="hljs-tag">          <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"choose(scope.row)"</span>&gt;</span>é€‰æ‹©<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-table</span>&gt;</span>
    <span class="hljs-comment">&lt;!--åˆ†é¡µ--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-col</span> <span class="hljs-attr">:span</span>=<span class="hljs-string">"24"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"toolbar"</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-pagination</span> <span class="hljs-attr">background</span> <span class="hljs-attr">layout</span>=<span class="hljs-string">"prev, pager, next"</span> @<span class="hljs-attr">current-change</span>=<span class="hljs-string">"changePage"</span> <span class="hljs-attr">:page-size</span>=<span class="hljs-string">"this.params.size"</span></span>
<span class="hljs-tag">                     <span class="hljs-attr">:total</span>=<span class="hljs-string">"total"</span> <span class="hljs-attr">:current-page</span>=<span class="hljs-string">"this.params.page"</span></span>
<span class="hljs-tag">                     <span class="hljs-attr">style</span>=<span class="hljs-string">"float:right;"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-pagination</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-col</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
<span class="javascript">  <span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> mediaApi <span class="hljs-keyword">from</span> <span class="hljs-string">'../api/media'</span></span>
<span class="javascript">  <span class="hljs-keyword">import</span> utilApi <span class="hljs-keyword">from</span> <span class="hljs-string">'@/common/utils'</span>;</span>
<span class="javascript">  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>&#123;</span>
<span class="actionscript">    props: [<span class="hljs-string">'ischoose'</span>],</span>
<span class="actionscript">    <span class="hljs-comment">// é¡µé¢æ•°æ®</span></span>
    data()&#123;
<span class="actionscript">      <span class="hljs-keyword">return</span> &#123;</span>
        params:&#123;
<span class="actionscript">          page:<span class="hljs-number">1</span>,<span class="hljs-comment">//é¡µç </span></span>
<span class="actionscript">          size:<span class="hljs-number">10</span>,<span class="hljs-comment">//æ¯é¡µæ˜¾ç¤ºä¸ªæ•°</span></span>
<span class="actionscript">          tag:<span class="hljs-string">''</span>,<span class="hljs-comment">//æ ‡ç­¾</span></span>
<span class="actionscript">          fileName:<span class="hljs-string">''</span>,<span class="hljs-comment">//æ–‡ä»¶åç§°</span></span>
<span class="actionscript">          processStatus:<span class="hljs-string">''</span><span class="hljs-comment">//å¤„ç†çŠ¶æ€</span></span>
        &#125;,
<span class="actionscript">        listLoading:<span class="hljs-literal">false</span>,</span>
        list:[],
        total:0,
        processStatusList:[]
      &#125;
    &#125;,

<span class="actionscript">    <span class="hljs-comment">//æ–¹æ³•</span></span>
    methods:&#123;
      formatCreatetime(row, column)&#123;
<span class="javascript">        <span class="hljs-keyword">var</span> createTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(row.uploadTime);</span>
        if (createTime) &#123;
<span class="actionscript">          <span class="hljs-keyword">return</span> utilApi.formatDate(createTime, <span class="hljs-string">'yyyy-MM-dd hh:mm:ss'</span>);</span>
        &#125;
      &#125;,
      formatProcessStatus(row,column)&#123;
<span class="actionscript">        <span class="hljs-keyword">var</span> processStatus = row.processStatus;</span>
        if (processStatus) &#123;
<span class="actionscript">            <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303001'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"å¤„ç†ä¸­"</span>;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303002'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"å¤„ç†æˆåŠŸ"</span>;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303003'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"å¤„ç†å¤±è´¥"</span>;</span>
<span class="actionscript">            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(processStatus == <span class="hljs-string">'303004'</span>)&#123;</span>
<span class="actionscript">              <span class="hljs-keyword">return</span> <span class="hljs-string">"æ— éœ€å¤„ç†"</span>;</span>
            &#125;
        &#125;
      &#125;,
      choose(mediaFile)&#123;
<span class="actionscript">          <span class="hljs-keyword">if</span>(mediaFile.processStatus !=<span class="hljs-string">'303002'</span> &amp;&amp; mediaFile.processStatus !=<span class="hljs-string">'303004'</span>)&#123;</span>
<span class="actionscript">            <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'è¯¥æ–‡ä»¶æœªå¤„ç†ï¼Œä¸å…è®¸é€‰æ‹©'</span>);</span>
<span class="actionscript">            <span class="hljs-keyword">return</span> ;</span>
          &#125;
        if(!mediaFile.fileUrl)&#123;
<span class="actionscript">          <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'è¯¥æ–‡ä»¶çš„è®¿é—®urlä¸ºç©ºï¼Œä¸å…è®¸é€‰æ‹©'</span>);</span>
<span class="actionscript">          <span class="hljs-keyword">return</span> ;</span>
        &#125;
<span class="actionscript">        <span class="hljs-comment">//è°ƒç”¨çˆ¶ç»„ä»¶çš„choosemediaæ–¹æ³•</span></span>
<span class="actionscript">        <span class="hljs-keyword">this</span>.$emit(<span class="hljs-string">'choosemedia'</span>,mediaFile.fileId,mediaFile.fileOriginalName,mediaFile.fileUrl);</span>
      &#125;,
      changePage(page)&#123;
<span class="actionscript">        <span class="hljs-keyword">this</span>.params.page = page;</span>
<span class="actionscript">        <span class="hljs-keyword">this</span>.query()</span>
      &#125;,
      process (id) &#123;
<span class="actionscript"><span class="hljs-comment">//        console.log(id)</span></span>
<span class="javascript">        mediaApi.media_process(id).then(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>&#123;</span>
<span class="javascript">          <span class="hljs-built_in">console</span>.log(res)</span>
         if(res.success)&#123;
<span class="actionscript">           <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">'å¼€å§‹å¤„ç†ï¼Œè¯·ç¨åæŸ¥çœ‹å¤„ç†ç»“æœ'</span>);</span>
<span class="actionscript">         &#125;<span class="hljs-keyword">else</span>&#123;</span>
<span class="actionscript">           <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'æ“ä½œå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•'</span>);</span>
         &#125;
        &#125;)
      &#125;,
      query()&#123;
<span class="javascript">        mediaApi.media_list(<span class="hljs-keyword">this</span>.params.page,<span class="hljs-keyword">this</span>.params.size,<span class="hljs-keyword">this</span>.params).then(<span class="hljs-function">(<span class="hljs-params">res</span>)=&gt;</span>&#123;</span>
<span class="javascript">          <span class="hljs-built_in">console</span>.log(res)</span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.total = res.queryResult.total</span>
<span class="actionscript">          <span class="hljs-keyword">this</span>.list = res.queryResult.list</span>
        &#125;)
      &#125;
    &#125;,

<span class="actionscript">    <span class="hljs-comment">//é¡µé¢åˆå§‹åŒ–å®Œæˆå‰é’©å­</span></span>
    created()&#123;
<span class="actionscript">        <span class="hljs-comment">//é»˜è®¤ç¬¬ä¸€é¡µ</span></span>
<span class="javascript">      <span class="hljs-keyword">this</span>.params.page = <span class="hljs-built_in">Number</span>.parseInt(<span class="hljs-keyword">this</span>.$route.query.page||<span class="hljs-number">1</span>);</span>
    &#125;,
<span class="actionscript">    <span class="hljs-comment">//é¡µé¢åˆå§‹åŒ–åŠ è½½å‰çš„é’©å­</span></span>
    mounted() &#123;
<span class="actionscript">      <span class="hljs-comment">//é»˜è®¤æŸ¥è¯¢é¡µé¢</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.query()</span>
<span class="actionscript">      <span class="hljs-comment">//åˆå§‹åŒ–å¤„ç†çŠ¶æ€</span></span>
<span class="actionscript">      <span class="hljs-keyword">this</span>.processStatusList = [</span>
        &#123;
<span class="actionscript">          id:<span class="hljs-string">''</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'å…¨éƒ¨'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303001'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'å¤„ç†ä¸­'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303002'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'å¤„ç†æˆåŠŸ'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303003'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'å¤„ç†å¤±è´¥'</span></span>
        &#125;,
        &#123;
<span class="actionscript">          id:<span class="hljs-string">'303004'</span>,</span>
<span class="actionscript">          name:<span class="hljs-string">'æ— éœ€å¤„ç†'</span></span>
        &#125;
      ]
    &#125;
  &#125;
<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></code></pre></div>

<h2 id="3-ä¿å­˜è§†é¢‘ä¿¡æ¯"><a href="#3-ä¿å­˜è§†é¢‘ä¿¡æ¯" class="headerlink" title="3. ä¿å­˜è§†é¢‘ä¿¡æ¯"></a>3. ä¿å­˜è§†é¢‘ä¿¡æ¯</h2><h3 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>ç”¨æˆ·è¿›å…¥è¯¾ç¨‹è®¡åˆ’é¡µé¢ï¼Œé€‰æ‹©è§†é¢‘ï¼Œå°†è¯¾ç¨‹è®¡åˆ’ä¸è§†é¢‘ä¿¡æ¯ä¿å­˜åœ¨è¯¾ç¨‹ç®¡ç†æ•°æ®åº“ä¸­ã€‚</p>
<p>ç”¨æˆ·æ“ä½œæµç¨‹ï¼š</p>
<p>1ã€è¿›å…¥è¯¾ç¨‹è®¡åˆ’ï¼Œç‚¹å‡»â€é€‰æ‹©è§†é¢‘â€œï¼Œæ‰“å¼€æˆ‘çš„åª’èµ„æŸ¥è¯¢é¡µé¢</p>
<p>2ã€ä¸ºè¯¾ç¨‹è®¡åˆ’é€‰æ‹©å¯¹åº”çš„è§†é¢‘ï¼Œé€‰æ‹©â€œé€‰æ‹©â€</p>
<p>3ã€å‰ç«¯è¯·æ±‚è¯¾ç¨‹ç®¡ç†æœåŠ¡ä¿å­˜è¯¾ç¨‹è®¡åˆ’ä¸è§†é¢‘ä¿¡æ¯</p>
<h3 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h3><p>åœ¨è¯¾ç¨‹ç®¡ç†æ•°æ®åº“åˆ›å»ºè¡¨ <code>teachplan_media</code> å­˜å‚¨è¯¾ç¨‹è®¡åˆ’ä¸åª’èµ„å…³è”ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image14" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image14.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>åˆ›å»º <code>teachplanMedia</code> æ¨¡å‹ç±»ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table</span>(name=<span class="hljs-string">"teachplan_media"</span>)
<span class="hljs-meta">@GenericGenerator</span>(name = <span class="hljs-string">"jpaâ€assigned"</span>, strategy = <span class="hljs-string">"assigned"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TeachplanMedia</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = â€<span class="hljs-number">916357110051689485L</span>;
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue</span>(generator = <span class="hljs-string">"jpaâ€assigned"</span>)
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"teachplan_id"</span>)
    <span class="hljs-keyword">private</span> String teachplanId;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_id"</span>)
    <span class="hljs-keyword">private</span> String mediaId;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_fileoriginalname"</span>)
    <span class="hljs-keyword">private</span> String mediaFileOriginalName;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"media_url"</span>)
    <span class="hljs-keyword">private</span> String mediaUrl;
    <span class="hljs-meta">@Column</span>(name=<span class="hljs-string">"courseid"</span>)
    <span class="hljs-keyword">private</span> String courseId;
&#125;</code></pre></div>

<h3 id="APIæ¥å£"><a href="#APIæ¥å£" class="headerlink" title="APIæ¥å£"></a>APIæ¥å£</h3><p>æ­¤æ¥å£ä½œä¸ºå‰ç«¯è¯·æ±‚è¯¾ç¨‹ç®¡ç†æœåŠ¡ä¿å­˜è¯¾ç¨‹è®¡åˆ’ä¸è§†é¢‘ä¿¡æ¯çš„æ¥å£ï¼š</p>
<p>åœ¨ <code>TeachplanControllerApi</code> å¢åŠ æ¥å£ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"ä¿å­˜åª’èµ„ä¿¡æ¯"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveTeachplanMedia</span><span class="hljs-params">(TeachplanMedia teachplanMedia)</span></span>;</code></pre></div>

<h3 id="æœåŠ¡ç«¯å¼€å‘"><a href="#æœåŠ¡ç«¯å¼€å‘" class="headerlink" title="æœåŠ¡ç«¯å¼€å‘"></a>æœåŠ¡ç«¯å¼€å‘</h3><h4 id="1ã€Controller"><a href="#1ã€Controller" class="headerlink" title="1ã€Controller"></a>1ã€Controller</h4><p>åœ¨ <code>TeachplanController</code> ä¸‹æ·»åŠ è¯¥æ–¹æ³•</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/savemedia"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveTeachplanMedia</span><span class="hljs-params">(@RequestBody TeachplanMedia teachplanMedia)</span> </span>&#123;
    <span class="hljs-keyword">return</span> teachplanService.saveTeachplanMedia(teachplanMedia);
&#125;</code></pre></div>

<h4 id="2ã€Dao"><a href="#2ã€Dao" class="headerlink" title="2ã€Dao"></a>2ã€Dao</h4><p>åˆ›å»º <code>TeachplanMediaRepository</code> ç”¨äºå¯¹ <code>TeachplanMedia</code> çš„æ“ä½œã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TeachplanMediaRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">TeachplanMedia</span>, <span class="hljs-title">String</span>&gt; </span>&#123;&#125;</code></pre></div>

<h4 id="3ã€Service"><a href="#3ã€Service" class="headerlink" title="3ã€Service"></a>3ã€Service</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//ä¿å­˜åª’èµ„ä¿¡æ¯public ResponseResult saveTeachplanMedia(TeachplanMedia teachplanMedia) &#123;    if(teachplanMedia == null)&#123;        ExceptionCast.cast(CommonCode.INVALIDPARAM);    &#125;     //è¯¾ç¨‹è®¡åˆ’        String teachplanId = teachplanMedia.getTeachplanId();    //æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’    Optional&lt;Teachplan&gt; optional = teachplanRepository.findById(teachplanId);    if(!optional.isPresent())&#123;        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_ISNULL);    &#125; Teachplan teachplan = optional.get();    //åªå…è®¸ä¸ºå¶å­ç»“ç‚¹è¯¾ç¨‹è®¡åˆ’é€‰æ‹©è§†é¢‘    String grade = teachplan.getGrade();    if(StringUtils.isEmpty(grade) || !grade.equals("3"))&#123;        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_GRADEERROR);    &#125;     TeachplanMedia one = null;    Optional&lt;TeachplanMedia&gt; teachplanMediaOptional =        teachplanMediaRepository.findById(teachplanId);    if(!teachplanMediaOptional.isPresent())&#123;        one = new TeachplanMedia();    &#125;else&#123;        one = teachplanMediaOptional.get();    &#125;     //ä¿å­˜åª’èµ„ä¿¡æ¯ä¸è¯¾ç¨‹è®¡åˆ’ä¿¡æ¯    one.setTeachplanId(teachplanId);    one.setCourseId(teachplanMedia.getCourseId());    one.setMediaFileOriginalName(teachplanMedia.getMediaFileOriginalName());    one.setMediaId(teachplanMedia.getMediaId());    one.setMediaUrl(teachplanMedia.getMediaUrl());    teachplanMediaRepository.save(one);    return new ResponseResult(CommonCode.SUCCESS);&#125;//ä¿å­˜åª’èµ„ä¿¡æ¯</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">saveTeachplanMedia</span><span class="hljs-params">(TeachplanMedia teachplanMedia)</span> </span>&#123;
    <span class="hljs-keyword">if</span>(teachplanMedia == <span class="hljs-keyword">null</span>)&#123;
        ExceptionCast.cast(CommonCode.INVALIDPARAM);
    &#125; 
    <span class="hljs-comment">//è¯¾ç¨‹è®¡åˆ’</span>
        String teachplanId = teachplanMedia.getTeachplanId();
    <span class="hljs-comment">//æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’</span>
    Optional&lt;Teachplan&gt; optional = teachplanRepository.findById(teachplanId);
    <span class="hljs-keyword">if</span>(!optional.isPresent())&#123;
        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_ISNULL);
    &#125; Teachplan teachplan = optional.get();
    <span class="hljs-comment">//åªå…è®¸ä¸ºå¶å­ç»“ç‚¹è¯¾ç¨‹è®¡åˆ’é€‰æ‹©è§†é¢‘</span>
    String grade = teachplan.getGrade();
    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(grade) || !grade.equals(<span class="hljs-string">"3"</span>))&#123;
        ExceptionCast.cast(CourseCode.COURSE_MEDIA_TEACHPLAN_GRADEERROR);
    &#125; 
    TeachplanMedia one = <span class="hljs-keyword">null</span>;
    Optional&lt;TeachplanMedia&gt; teachplanMediaOptional =
        teachplanMediaRepository.findById(teachplanId);
    <span class="hljs-keyword">if</span>(!teachplanMediaOptional.isPresent())&#123;
        one = <span class="hljs-keyword">new</span> TeachplanMedia();
    &#125;<span class="hljs-keyword">else</span>&#123;
        one = teachplanMediaOptional.get();
    &#125; 
    <span class="hljs-comment">//ä¿å­˜åª’èµ„ä¿¡æ¯ä¸è¯¾ç¨‹è®¡åˆ’ä¿¡æ¯</span>
    one.setTeachplanId(teachplanId);
    one.setCourseId(teachplanMedia.getCourseId());
    one.setMediaFileOriginalName(teachplanMedia.getMediaFileOriginalName());
    one.setMediaId(teachplanMedia.getMediaId());
    one.setMediaUrl(teachplanMedia.getMediaUrl());
    teachplanMediaRepository.save(one);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
&#125;</code></pre></div>

<h3 id="å‰ç«¯å¼€å‘"><a href="#å‰ç«¯å¼€å‘" class="headerlink" title="å‰ç«¯å¼€å‘"></a>å‰ç«¯å¼€å‘</h3><h4 id="1ã€APIæ–¹æ³•"><a href="#1ã€APIæ–¹æ³•" class="headerlink" title="1ã€APIæ–¹æ³•"></a>1ã€APIæ–¹æ³•</h4><div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/*ä¿å­˜åª’èµ„ä¿¡æ¯*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> savemedia = <span class="hljs-function"><span class="hljs-params">teachplanMedia</span> =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestPost(apiUrl+<span class="hljs-string">'/course/savemedia'</span>,teachplanMedia);
&#125;</code></pre></div>

<h4 id="2ã€APIè°ƒç”¨"><a href="#2ã€APIè°ƒç”¨" class="headerlink" title="2ã€APIè°ƒç”¨"></a>2ã€APIè°ƒç”¨</h4><p>åœ¨è¯¾ç¨‹è§†é¢‘æ–¹æ³•ä¸­è°ƒç”¨ <code>api</code>ï¼š</p>
<div class="hljs"><pre><code class="hljs java">choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
    <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-keyword">false</span>;
    <span class="hljs-comment">//ä¿å­˜è¯¾ç¨‹è®¡åˆ’ä¸è§†é¢‘å¯¹åº”å…³ç³»</span>
    let teachplanMedia = &#123;&#125;;
    teachplanMedia.teachplanId = <span class="hljs-keyword">this</span>.activeTeachplanId;
    teachplanMedia.mediaId = mediaId;
    teachplanMedia.mediaFileOriginalName = fileOriginalName;
    teachplanMedia.mediaUrl = mediaUrl;
    teachplanMedia.courseId = <span class="hljs-keyword">this</span>.courseid;
    <span class="hljs-comment">//ä¿å­˜åª’èµ„ä¿¡æ¯åˆ°è¯¾ç¨‹æ•°æ®åº“</span>
    courseApi.savemedia(teachplanMedia).then(res=&gt;&#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"é€‰æ‹©è§†é¢‘æˆåŠŸ"</span>)
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.$message.error(res.message)
        &#125;
    &#125;)
&#125;,</code></pre></div>

<h4 id="3ã€æµ‹è¯•"><a href="#3ã€æµ‹è¯•" class="headerlink" title="3ã€æµ‹è¯•"></a>3ã€æµ‹è¯•</h4><p>1ã€å‘å¶å­ç»“ç‚¹è¯¾ç¨‹è®¡åˆ’ä¿å­˜åª’èµ„ä¿¡æ¯</p>
<p>æ“ä½œç»“æœï¼šä¿å­˜æˆåŠŸ</p>
<p>2ã€å‘éå¶å­ç»“ç‚¹è¯¾ç¨‹è®¡åˆ’ä¿å­˜åª’èµ„ä¿¡æ¯</p>
<p>æ“ä½œç»“æœï¼šä¿å­˜å¤±è´¥</p>
<h2 id="4-æŸ¥è¯¢è§†é¢‘ä¿¡æ¯"><a href="#4-æŸ¥è¯¢è§†é¢‘ä¿¡æ¯" class="headerlink" title="4. æŸ¥è¯¢è§†é¢‘ä¿¡æ¯"></a>4. æŸ¥è¯¢è§†é¢‘ä¿¡æ¯</h2><h3 id="éœ€æ±‚åˆ†æ-1"><a href="#éœ€æ±‚åˆ†æ-1" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>è¯¾ç¨‹è®¡åˆ’çš„è§†é¢‘ä¿¡æ¯ä¿å­˜ååœ¨é¡µé¢æ— æ³•æŸ¥çœ‹ï¼Œæœ¬èŠ‚è§£å†³è¯¾ç¨‹è®¡åˆ’é¡µé¢æ˜¾ç¤ºç›¸å…³è”çš„åª’èµ„ä¿¡æ¯ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p>åœ¨è·å–è¯¾ç¨‹è®¡åˆ’æ ‘ç»“ç‚¹ä¿¡æ¯æ—¶å°†å…³è”çš„åª’èµ„ä¿¡æ¯ä¸€å¹¶æŸ¥è¯¢ï¼Œå¹¶åœ¨å‰ç«¯æ˜¾ç¤ºï¼Œä¸‹å›¾è¯´æ˜äº†è¯¾ç¨‹è®¡åˆ’æ˜¾ç¤ºçš„åŒºåŸŸã€‚</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image15" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image15.png" srcset="/img/loading.gif" alt="img"></a></p>
<h3 id="Dao-1"><a href="#Dao-1" class="headerlink" title="Dao"></a>Dao</h3><p>ä¿®æ”¹è¯¾ç¨‹è®¡åˆ’æŸ¥è¯¢çš„ <code>Dao</code>:</p>
<p>1ã€ä¿®æ”¹æ¨¡å‹</p>
<p>åœ¨è¯¾ç¨‹è®¡åˆ’ç»“æœä¿¡æ¯ä¸­æ·»åŠ åª’èµ„ä¿¡æ¯</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.course.ext;

<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.course.Teachplan;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TeachplanNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Teachplan</span> </span>&#123;

    List&lt;TeachplanNode&gt; children;

    <span class="hljs-comment">//åª’èµ„ä¿¡æ¯</span>
    <span class="hljs-keyword">private</span> String media_id;
    <span class="hljs-keyword">private</span> String media_fileoriginalname;
&#125;</code></pre></div>

<p>2ã€ä¿®æ”¹<code>sql</code> è¯­å¥ï¼Œæ·»åŠ å…³è”æŸ¥è¯¢åª’èµ„ä¿¡æ¯</p>
<p>æ·»åŠ  <code>mediaId</code>ã€<code>mediaFileOriginalName</code></p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> &gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.xuecheng.manage_course.dao.TeachplanMapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"teachplanMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
        <span class="hljs-comment">&lt;!--ä¸€çº§èŠ‚ç‚¹--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"one_id"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"one_pname"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"children"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
            <span class="hljs-comment">&lt;!--äºŒçº§èŠ‚ç‚¹--&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"two_id"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"two_pname"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"children"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.xuecheng.framework.domain.course.ext.TeachplanNode"</span>&gt;</span>
                <span class="hljs-comment">&lt;!--ä¸‰çº§èŠ‚ç‚¹--&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_id"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_pname"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"media_id"</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_fileoriginalname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"media_fileoriginalname"</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-comment">&lt;!--ä¸‰çº§èœå•æŸ¥è¯¢--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectList"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"teachplanMap"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"java.lang.String"</span>&gt;</span>
        SELECT
            a.id one_id,
            a.pname one_pname,
            a.courseid one_course,
            b.id two_id,
            b.pname two_pname,
            c.id three_id,
            c.pname three_pname,
            media.media_id media_id,
            media.media_fileoriginalname media_fileoriginalname
        FROM
            teachplan a
        LEFT JOIN teachplan b
            ON b.parentid = a.id
        LEFT JOIN teachplan c
            ON c.parentid = b.id
        LEFT JOIN teachplan_media media
            ON c.id = media.teachplan_id
        WHERE
            a.parentid = '0'
        <span class="hljs-comment">&lt;!--åˆ¤æ–­å‚æ•°ä¸ä¸ºç©ºæ—¶æ‰è¿›è¡Œå‚æ•°çš„åŒ¹é…--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"_parameter!=null and _parameter!=''"</span>&gt;</span>
            and a.courseid = #&#123;courseId&#125;
        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span>
        ORDER BY a.orderby,
            b.orderby,
            c.orderby
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span></code></pre></div>

<p>è¿™é‡Œçš„æ ¸å¿ƒä»£ç æ˜¯ä½¿ç”¨ <code>LEFT JOIN</code> å…³è” <code>teachplan_media</code> è¡¨ä¸­çš„æ•°æ®ï¼Œå†è·å–è¯¥è¯¾ç¨‹è®¡åˆ’ä¸‹çš„ <code>mediaId</code> ä¸ <code>mediaFileOriginalName</code> ä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs sql">LEFT JOIN teachplan_media media ON c.id = media.teachplan_id
WHERE</code></pre></div>

<div class="hljs"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--ä¸‰çº§èŠ‚ç‚¹--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_id"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"pname"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"three_pname"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"media_id"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"media_fileoriginalname"</span></span></code></pre></div>

<p>ä½¿ç”¨swaggerè¿›è¡Œæ¥å£æµ‹è¯•</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image16" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image16.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>ä»ç»“æœä¸­æˆåŠŸçš„æŸ¥è¯¢åˆ°äº†è¯¾ç¨‹è®¡åˆ’æ‰€å…³è”çš„åª’èµ„ä¿¡æ¯ã€‚</p>
<h3 id="é¡µé¢æŸ¥è¯¢è§†é¢‘"><a href="#é¡µé¢æŸ¥è¯¢è§†é¢‘" class="headerlink" title="é¡µé¢æŸ¥è¯¢è§†é¢‘"></a>é¡µé¢æŸ¥è¯¢è§†é¢‘</h3><p>è¯¾ç¨‹è®¡åˆ’ç»“ç‚¹ä¿¡æ¯å·²åŒ…æ‹¬åª’èµ„ä¿¡æ¯ï¼Œå¯åœ¨é¡µé¢è·å–ä¿¡æ¯åæ˜¾ç¤ºã€‚</p>
<p>é€šè¿‡ <code>data.media_fileoriginalname</code> è·å–åª’èµ„è§†é¢‘çš„åŸå§‹åç§°</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">elâ€button</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"fontâ€size: 12px;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">on</span>â€<span class="hljs-attr">click</span>=<span class="hljs-string">&#123;</span> () =&gt;</span> this.querymedia(data.id) &#125;&gt;
&#123;data.media_fileoriginalname&#125;<span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-symbol">&amp;nbsp;</span>é€‰æ‹©è§†é¢‘<span class="hljs-tag">&lt;/<span class="hljs-name">elâ€button</span>&gt;</span></code></pre></div>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><a href="https://qnoss.codeyee.com/20200704_14/image17" target="_blank" rel="noopener"><img src="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday14/image17.png" srcset="/img/loading.gif" alt="img"></a></p>
<p>é€‰æ‹©è§†é¢‘åç«‹å³åˆ·æ–°è¯¾ç¨‹è®¡åˆ’æ ‘ï¼Œåœ¨æäº¤æˆåŠŸåï¼Œæ·»åŠ æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’ä»£ç ï¼š<code>this.findTeachplan()</code>ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs js">choosemedia(mediaId,fileOriginalName,mediaUrl)&#123;
    <span class="hljs-keyword">this</span>.mediaFormVisible = <span class="hljs-literal">false</span>;
    <span class="hljs-comment">//ä¿å­˜è¯¾ç¨‹è®¡åˆ’ä¸è§†é¢‘å¯¹åº”å…³ç³»</span>
    <span class="hljs-keyword">let</span> teachplanMedia = &#123;&#125;;
    teachplanMedia.teachplanId = <span class="hljs-keyword">this</span>.activeTeachplanId;
    teachplanMedia.mediaId = mediaId;
    teachplanMedia.mediaFileOriginalName = fileOriginalName;
    teachplanMedia.mediaUrl = mediaUrl;
    teachplanMedia.courseId = <span class="hljs-keyword">this</span>.courseid;

    <span class="hljs-comment">//ä¿å­˜åª’èµ„ä¿¡æ¯åˆ°è¯¾ç¨‹æ•°æ®åº“</span>
    courseApi.savemedia(teachplanMedia).then(<span class="hljs-function"><span class="hljs-params">res</span>=&gt;</span>&#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            <span class="hljs-keyword">this</span>.$message.success(<span class="hljs-string">"é€‰æ‹©è§†é¢‘æˆåŠŸ"</span>)
            <span class="hljs-comment">//æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’</span>
            <span class="hljs-keyword">this</span>.findTeachplan()
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.$message.error(res.message)
        &#125;
    &#125;)
&#125;,</code></pre></div>


            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">å­¦æˆåœ¨çº¿</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/RabbitMQ/">RabbitMQ</a>
                    
                      <a class="hover-with-bg" href="/tags/FFmpeg/">FFmpeg</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/23/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday15/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">å­¦æˆåœ¨çº¿day15ï¼šåª’èµ„ç®¡ç†ç³»ç»Ÿé›†æˆ</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/21/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday13/">
                        <span class="hidden-mobile">å­¦æˆåœ¨çº¿day13ï¼šä½¿ç”¨FFmpegè¿›è¡Œæ ¼å¼è½¬æ¢ä»¥åŠm3u8æ–‡ä»¶ç”Ÿæˆã€æ–‡ä»¶åˆ†å—ä¸Šä¼ æ¥å£å®ç°</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

ä»£ç å—js ç”¨ä¸åˆ°ï¼Œfulidè‡ªå¸¦æœ‰ï¼Œæ·»åŠ cssæ ·å¼å³å¯å®ç°
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®å­—</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "æœ¬ç«™å·²ç»å‹‰å¼ºè¿è¡Œ&nbsp"+dnum+"&nbspå¤©";
      document.getElementById("times").innerHTML = hnum + "&nbspå°æ—¶&nbsp" + mnum + "&nbspåˆ†&nbsp" + snum + "&nbspç§’";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


    
  <!-- å¤‡æ¡ˆä¿¡æ¯ -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">äº¬ICPè¯20000725å·</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20000725"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>äº¬å…¬ç½‘å®‰å¤‡20000725å·</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "å­¦æˆåœ¨çº¿day14ï¼šåª’èµ„ç®¡ç†&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
