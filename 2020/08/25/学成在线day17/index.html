<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Mr.JK">
  <meta name="keywords" content="">
  <title>å­¦æˆåœ¨çº¿day17ï¼šåŸºäºZuulç½‘å…³å®ç°è·¯ç”±è½¬å‘ã€è¿‡æ»¤å™¨ - Mr.JK</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/darcula.min.css" />
  

  


<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_yg9cfy8wd6.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script  src="/js/utils.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>





<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>ç§äººåšå®¢</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                ä¸»é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äºæˆ‘
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/banner.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
  <div class="mt-3 post-meta">
    <i class="iconfont icon-date-fill" aria-hidden="true"></i>
    <time datetime="2020-08-25 11:24">
      2020-08-25
    </time>
  </div>


<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      8.8k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      100
       åˆ†é’Ÿ
    </span>
  

  
  
    
      <!-- ä¸è’œå­ç»Ÿè®¡æ–‡ç« PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> æ¬¡
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
	
   
	
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div id="tocbot"></div>
</div>

      </div>
    
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <h1 id="ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ"><a href="#ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ" class="headerlink" title="ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ"></a>ğŸ˜çŸ¥è¯†ç‚¹æ¦‚è§ˆ</h1><blockquote>
<p>ä¸ºäº†æ–¹ä¾¿åç»­å›é¡¾è¯¥é¡¹ç›®æ—¶èƒ½å¤Ÿæ¸…æ™°çš„çŸ¥é“æœ¬ç« èŠ‚è®²äº†å“ªäº›å†…å®¹ï¼Œå¹¶ä¸”èƒ½å¤Ÿä»è¯¥ç« èŠ‚çš„ç¬”è®°ä¸­å¾—åˆ°ä¸€äº›å¸®åŠ©ï¼Œæ‰€ä»¥åœ¨å®Œæˆæœ¬ç« èŠ‚çš„å­¦ä¹ ååœ¨æ­¤å¯¹æœ¬ç« èŠ‚æ‰€æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹è¿›è¡Œæ€»ç»“æ¦‚è¿°ã€‚</p>
</blockquote>
<p>æœ¬ç« èŠ‚ä¸ºã€å­¦æˆåœ¨çº¿ã€‘é¡¹ç›®çš„ <code>day17</code> çš„å†…å®¹</p>
<ul>
<li>æ„å»ºç”¨æˆ·ä¸­å¿ƒæœåŠ¡ï¼Œå¹¶åŸºäº <code>Spring Security Oauth2</code> ä»¥åŠ <code>jwt</code> ä»¤ç‰Œå®ç°ç”¨æˆ·è®¤è¯çš„å®Œæ•´æµç¨‹ã€‚</li>
<li>å®Œæˆé—¨æˆ·ç½‘ç«™çš„ç”¨æˆ·ç™»å…¥ã€ç™»å‡ºæ¥å£ã€å‰ç«¯é¡µé¢çš„å¼€å‘ä»¥åŠè°ƒè¯•ã€‚</li>
<li>åŸºäº Zuul æ„å»ºç½‘å…³æœåŠ¡ï¼Œä»¥åŠä½¿ç”¨ Zuul ç½‘å…³å®ç°åŸºæœ¬çš„è·¯ç”±è½¬å‘ã€è¿‡æ»¤å™¨ã€èº«ä»½æ ¡éªŒç­‰åŠŸèƒ½</li>
</ul>
<h1 id="ä¸€ã€ç”¨æˆ·è®¤è¯"><a href="#ä¸€ã€ç”¨æˆ·è®¤è¯" class="headerlink" title="ä¸€ã€ç”¨æˆ·è®¤è¯"></a>ä¸€ã€ç”¨æˆ·è®¤è¯</h1><h2 id="1-ç”¨æˆ·è®¤è¯æµç¨‹åˆ†æ"><a href="#1-ç”¨æˆ·è®¤è¯æµç¨‹åˆ†æ" class="headerlink" title="1. ç”¨æˆ·è®¤è¯æµç¨‹åˆ†æ"></a>1. ç”¨æˆ·è®¤è¯æµç¨‹åˆ†æ</h2><p>ç”¨æˆ·è®¤è¯æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image1.png" srcset="/img/loading.gif" alt="image-20200527083511311"></p>
<p>ä¸šåŠ¡æµç¨‹è¯´æ˜å¦‚ä¸‹ï¼š</p>
<p><strong>1ã€å®¢æˆ·ç«¯è¯·æ±‚è®¤è¯æœåŠ¡è¿›è¡Œè®¤è¯ã€‚</strong></p>
<p><strong>2ã€è®¤è¯æœåŠ¡è®¤è¯é€šè¿‡å‘æµè§ˆå™¨ cookie å†™å…¥ token (èº«ä»½ä»¤ç‰Œ)</strong></p>
<p>è®¤è¯æœåŠ¡è¯·æ±‚ç”¨æˆ·ä¸­å¿ƒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>è®¤è¯æœåŠ¡è¯·æ±‚ <code>Spring Security</code> ç”³è¯·ä»¤ç‰Œã€‚</p>
<p>è®¤è¯æœåŠ¡å°† <code>token</code> (èº«ä»½ä»¤ç‰Œ)å’Œ <code>jwt</code> ä»¤ç‰Œå­˜å‚¨è‡³ <code>redis</code> ä¸­ã€‚</p>
<p>è®¤è¯æœåŠ¡å‘cookieå†™å…¥ <code>token</code> (èº«ä»½ä»¤ç‰Œ)ã€‚</p>
<p>3<strong>ã€å‰ç«¯æºå¸¦</strong>token<strong>è¯·æ±‚è®¤è¯æœåŠ¡è·å–</strong>jwtä»¤ç‰Œ</p>
<p>å‰ç«¯è·å–åˆ° <code>jwt</code> ä»¤ç‰Œå¹¶å­˜å‚¨åœ¨ <code>sessionStorage</code>ã€‚</p>
<p>å‰ç«¯ä»jwtä»¤ç‰Œä¸­è§£æä¸­ç”¨æˆ·ä¿¡æ¯å¹¶æ˜¾ç¤ºåœ¨é¡µé¢ã€‚</p>
<blockquote>
<p>å‰ç«¯å¦‚ä½•è§£æï¼Ÿè¿˜æ˜¯è®¤è¯æœåŠ¡è¿”å›æ˜æ–‡æ•°æ®</p>
</blockquote>
<p>4<strong>ã€å‰ç«¯æºå¸¦</strong>cookie<strong>ä¸­çš„</strong>token<strong>èº«ä»½ä»¤ç‰ŒåŠ</strong>jwt<strong>ä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡</strong></p>
<p>å‰ç«¯è¯·æ±‚èµ„æºæœåŠ¡éœ€è¦æºå¸¦ä¸¤ä¸ªtokenï¼Œä¸€ä¸ªæ˜¯cookieä¸­çš„èº«ä»½ä»¤ç‰Œï¼Œä¸€ä¸ªæ˜¯http headerä¸­çš„jwtä»¤ç‰Œ</p>
<p>å‰ç«¯è¯·æ±‚èµ„æºæœåŠ¡å‰åœ¨http headerä¸Šæ·»åŠ jwtè¯·æ±‚èµ„æº</p>
<p><strong>5ã€ç½‘å…³æ ¡éªŒ tokençš„åˆæ³•æ€§</strong></p>
<p>ç”¨æˆ·è¯·æ±‚å¿…é¡»æºå¸¦ <code>token</code> èº«ä»½ä»¤ç‰Œå’Œjwtä»¤ç‰Œ</p>
<p>ç½‘å…³æ ¡éªŒredisä¸­ <code>token</code> æ˜¯å¦åˆæ³•ï¼Œå·²è¿‡æœŸåˆ™è¦æ±‚ç”¨æˆ·é‡æ–°ç™»å½•</p>
<p><strong>6ã€èµ„æºæœåŠ¡æ ¡éªŒjwtçš„åˆæ³•æ€§å¹¶å®Œæˆæˆæƒ</strong></p>
<p>èµ„æºæœåŠ¡æ ¡éªŒjwtä»¤ç‰Œï¼Œå®Œæˆæˆæƒï¼Œæ‹¥æœ‰æƒé™çš„æ–¹æ³•æ­£å¸¸æ‰§è¡Œï¼Œæ²¡æœ‰æƒé™çš„æ–¹æ³•å°†æ‹’ç»è®¿é—®ã€‚</p>
<h2 id="2-è®¤è¯æœåŠ¡æŸ¥è¯¢æ•°æ®åº“"><a href="#2-è®¤è¯æœåŠ¡æŸ¥è¯¢æ•°æ®åº“" class="headerlink" title="2. è®¤è¯æœåŠ¡æŸ¥è¯¢æ•°æ®åº“"></a>2. è®¤è¯æœåŠ¡æŸ¥è¯¢æ•°æ®åº“</h2><h3 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><ul>
<li>è®¤è¯æœåŠ¡æ ¹æ®æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯å»æ ¡éªŒç”¨æˆ·çš„èº«ä»½ï¼Œå³æ ¡éªŒè´¦å·å’Œå¯†ç æ˜¯å¦åŒ¹é…ã€‚</li>
<li>è®¤è¯æœåŠ¡ä¸ç›´æ¥è¿æ¥æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡ç”¨æˆ·ä¸­å¿ƒæœåŠ¡å»æŸ¥è¯¢ç”¨æˆ·ä¸­å¿ƒæ•°æ®åº“ã€‚</li>
</ul>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image2.png" srcset="/img/loading.gif" alt="image-20200527083511311"></p>
<p>å®Œæ•´çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image3.png" srcset="/img/loading.gif" alt="image-20200527084051627"></p>
<h3 id="æ­å»ºç¯å¢ƒ"><a href="#æ­å»ºç¯å¢ƒ" class="headerlink" title="æ­å»ºç¯å¢ƒ"></a>æ­å»ºç¯å¢ƒ</h3><p>1ã€åˆ›å»ºç”¨æˆ·ä¸­å¿ƒæ•°æ®åº“</p>
<p>ç”¨æˆ·ä¸­å¿ƒè´Ÿè´£ç”¨æˆ·ç®¡ç†ï¼ŒåŒ…æ‹¬ï¼šç”¨æˆ·ä¿¡æ¯ç®¡ç†ã€è§’è‰²ç®¡ç†ã€æƒé™ç®¡ç†ç­‰ã€‚</p>
<p>åˆ›å»º <code>xc_user</code> æ•°æ®åº“ï¼ˆMySQLï¼‰</p>
<p>å¯¼å…¥ <code>xc_user.sql</code> (å·²å¯¼å…¥ä¸ç”¨é‡å¤å¯¼å…¥)</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image4.png" srcset="/img/loading.gif" alt="image-20200527084200019"></p>
<p>2ã€åˆ›å»ºç”¨æˆ·ä¸­å¿ƒå·¥ç¨‹</p>
<p>å¯¼å…¥â€œèµ„æ–™â€-ã€‹xc-service-ucenter.zip</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image5.png" srcset="/img/loading.gif" alt="image-20200527084302385"></p>
<p>å®Œæˆç”¨æˆ·ä¸­å¿ƒæ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ¥å£åŠŸèƒ½ã€‚</p>
<h3 id="æŸ¥è¯¢ç”¨æˆ·æ¥å£å¼€å‘"><a href="#æŸ¥è¯¢ç”¨æˆ·æ¥å£å¼€å‘" class="headerlink" title="æŸ¥è¯¢ç”¨æˆ·æ¥å£å¼€å‘"></a>æŸ¥è¯¢ç”¨æˆ·æ¥å£å¼€å‘</h3><h4 id="1ã€Apiæ¥å£"><a href="#1ã€Apiæ¥å£" class="headerlink" title="1ã€Apiæ¥å£"></a>1ã€Apiæ¥å£</h4><p>ç”¨æˆ·ä¸­å¿ƒå¯¹å¤–æä¾›å¦‚ä¸‹æ¥å£</p>
<p>1ï¼‰å“åº”æ•°æ®ç±»å‹</p>
<p>æ­¤æ¥å£å°†æ¥è¢«ç”¨æ¥æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯åŠç”¨æˆ·æƒé™ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™é‡Œå®šä¹‰æ‰©å±•ç±»å‹</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.framework.domain.ucenter.response.ext;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.ucenter.XcMenu;
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.ucenter.XcUser;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.ToString;
 
<span class="hljs-keyword">import</span> java.util.List;
 
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@ToString</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XcUserExt</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XcUser</span> </span>&#123;
    <span class="hljs-comment">//æƒé™ä¿¡æ¯</span>
    <span class="hljs-keyword">private</span> List&lt;XcMenu&gt; permissions;
    <span class="hljs-comment">//ä¼ä¸šä¿¡æ¯</span>
    <span class="hljs-keyword">private</span> String companyId;
&#125;</code></pre></div>

<p>2ï¼‰æ ¹æ®è´¦å·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xuecheng.api.ucenter;
 
<span class="hljs-keyword">import</span> com.xuecheng.framework.domain.ucenter.response.ext.XcUserExt;
<span class="hljs-keyword">import</span> io.swagger.annotations.Api;
<span class="hljs-keyword">import</span> io.swagger.annotations.ApiOperation;
 
<span class="hljs-meta">@Api</span>(value = <span class="hljs-string">"ç”¨æˆ·ä¸­å¿ƒ"</span>,description = <span class="hljs-string">"ç”¨æˆ·ä¸­å¿ƒç®¡ç†"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UcenterControllerApi</span> </span>&#123;
    
    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"è·å–ç”¨æˆ·ä¿¡æ¯"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserext</span><span class="hljs-params">(String username)</span></span>;
&#125;</code></pre></div>

<h4 id="2ã€DAO"><a href="#2ã€DAO" class="headerlink" title="2ã€DAO"></a>2ã€DAO</h4><p>æ·»åŠ  <code>XcUser</code>ã€<code>XcCompantUser</code> ä¸¤ä¸ªè¡¨çš„Dao ï¼Œå¯¹äºä¸€äº›ç®€å•çš„sqlæ“ä½œï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring Data JPA å®ç°</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">XcUserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">XcUser</span>, <span class="hljs-title">String</span>&gt; </span>&#123;
    <span class="hljs-function">XcUser <span class="hljs-title">findXcUserByUsername</span><span class="hljs-params">(String username)</span></span>;
&#125;</code></pre></div>

<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">XcCompanyUserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JpaRepository</span>&lt;<span class="hljs-title">XcCompanyUser</span>,<span class="hljs-title">String</span>&gt; </span>&#123;
    <span class="hljs-comment">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢æ‰€å±ä¼ä¸šid</span>
    <span class="hljs-function">XcCompanyUser <span class="hljs-title">findByUserId</span><span class="hljs-params">(String userId)</span></span>;
&#125;</code></pre></div>

<h4 id="3ã€Service"><a href="#3ã€Service" class="headerlink" title="3ã€Service"></a>3ã€Service</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;
 
    <span class="hljs-comment">//å¯¹xc_userè¡¨çš„ç›¸å…³æ“ä½œ</span>
    <span class="hljs-meta">@Autowired</span>
    XcUserRepository xcUserRepository;
 
    <span class="hljs-comment">//å¯¹xc_company_userè¡¨çš„ç›¸å…³æ“ä½œ</span>
    <span class="hljs-meta">@Autowired</span>
    XcCompanyUserRepository xcCompanyUserRepository;
 
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯çš„å®ç°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> XcUser <span class="hljs-title">findXcUserByUsername</span><span class="hljs-params">(String username)</span> </span>&#123;
        <span class="hljs-keyword">return</span> xcUserRepository.findXcUserByUsername(username);
    &#125;
 
    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·æƒé™çš„å®ç°</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username ç”¨æˆ·å</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserExt</span><span class="hljs-params">(String username)</span> </span>&#123;
        <span class="hljs-comment">//æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span>
        XcUser xcUser = <span class="hljs-keyword">this</span>.findXcUserByUsername(username);
        <span class="hljs-keyword">if</span>(xcUser ==<span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
 
        XcUserExt xcUserExt = <span class="hljs-keyword">new</span> XcUserExt();
        BeanUtils.copyProperties(xcUser,xcUserExt);
 
        <span class="hljs-comment">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æ‰€å±å…¬å¸</span>
        String xcUserId = xcUser.getId();
        XcCompanyUser xcCompanyUser = xcCompanyUserRepository.findByUserId(xcUserId);
        <span class="hljs-keyword">if</span>(xcCompanyUser!=<span class="hljs-keyword">null</span>)&#123;
            String companyId = xcCompanyUser.getCompanyId();
            xcUserExt.setCompanyId(companyId);
        &#125;
 
        <span class="hljs-comment">//è¿”å›XcUserExtå¯¹è±¡</span>
        <span class="hljs-keyword">return</span> xcUserExt;
    &#125;
&#125;</code></pre></div>

<h4 id="4ã€Controller"><a href="#4ã€Controller" class="headerlink" title="4ã€Controller"></a>4ã€Controller</h4><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/ucenter"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UcenterController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UcenterControllerApi</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    UserService userService;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/getuserext"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserext</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"username"</span>)</span> String username) </span>&#123;
        XcUserExt xcUser = userService.getUserExt(username);
        <span class="hljs-keyword">return</span> xcUser;
    &#125;
&#125;</code></pre></div>

<h4 id="5ã€å¯èƒ½å‡ºç°çš„ä¸€äº›é—®é¢˜"><a href="#5ã€å¯èƒ½å‡ºç°çš„ä¸€äº›é—®é¢˜" class="headerlink" title="5ã€å¯èƒ½å‡ºç°çš„ä¸€äº›é—®é¢˜"></a>5ã€å¯èƒ½å‡ºç°çš„ä¸€äº›é—®é¢˜</h4><p>å¦‚æœ <code>ucenter</code> æœåŠ¡å‡ºç°æ¥å£éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®çš„æƒ…å†µï¼Œè€ƒè™‘å¯èƒ½æ˜¯ç»§æ‰¿äº† <code>model</code> å·¥ç¨‹çš„ <code>oauth2</code> ä¾èµ–å¯¼è‡´å¼€å¯äº†è®¤è¯æ‹¦æˆªã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼šåœ¨ model å·¥ç¨‹ä¸‹çš„ <code>oauth2</code> ä¾èµ–åŠ ä¸Š <code>&lt;optional&gt;true&lt;/optional&gt;</code> æ ‡ç­¾ï¼Œè¯¥æ ‡ç­¾å¯ä»¥é˜²æ­¢æœ¬å·¥ç¨‹ä¸‹çš„ä¾èµ–åŒ…ä¼ é€’åˆ°å…¶ä»–å·¥ç¨‹ã€‚</p>
<div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre></div>

<h4 id="6ã€æµ‹è¯•"><a href="#6ã€æµ‹è¯•" class="headerlink" title="6ã€æµ‹è¯•"></a>6ã€æµ‹è¯•</h4><p>ä½¿ç”¨ <code>Swagger-ui</code> æˆ– <code>postman</code> æµ‹è¯•ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æ¥å£</p>
<p>GET <a href="http://localhost:40300/ucenter/getuserext" target="_blank" rel="noopener">http://localhost:40300/ucenter/getuserext</a></p>
<p>å‚æ•°ä¸º username</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image6.png" srcset="/img/loading.gif" alt="img"></p>
<h4 id="7ã€æ€è€ƒä¸€äº›é—®é¢˜"><a href="#7ã€æ€è€ƒä¸€äº›é—®é¢˜" class="headerlink" title="7ã€æ€è€ƒä¸€äº›é—®é¢˜"></a>7ã€æ€è€ƒä¸€äº›é—®é¢˜</h4><p>åœ¨ä¸Šè¿°æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ GET è¯·æ±‚è°ƒç”¨ <a href="http://localhost:40300/ucenter/getuserext" target="_blank" rel="noopener">http://localhost:40300/ucenter/getuserext</a> æ¥å£å¯ä»¥è·å–åˆ°ä¸€ä¸ªç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œä½†æ˜¯è€ƒè™‘åˆ°ç”¨æˆ·æ•°æ®çš„å®‰å…¨é—®é¢˜ï¼Œè¿™ä¸ªæ¥å£ä¸åº”è¯¥ç›´æ¥æš´éœ²ç»™æ™®é€šçš„ç”¨æˆ·ï¼Œåªé€‚åˆæœåŠ¡é—´çš„è°ƒç”¨ï¼Œå¹¶éœ€è¦ç»è¿‡æˆæƒçš„æœåŠ¡æ‰å¯ä»¥è°ƒç”¨ã€‚</p>
<p>ç­”ï¼šåæœŸé…ç½®å¾®æœåŠ¡é—´è®¤è¯åå¯ä»¥è§£å†³ä¸Šè¿°çš„é—®é¢˜ã€‚</p>
<h3 id="è°ƒç”¨æŸ¥è¯¢ç”¨æˆ·çš„æ¥å£"><a href="#è°ƒç”¨æŸ¥è¯¢ç”¨æˆ·çš„æ¥å£" class="headerlink" title="è°ƒç”¨æŸ¥è¯¢ç”¨æˆ·çš„æ¥å£"></a>è°ƒç”¨æŸ¥è¯¢ç”¨æˆ·çš„æ¥å£</h3><h4 id="1ã€åˆ›å»º-client"><a href="#1ã€åˆ›å»º-client" class="headerlink" title="1ã€åˆ›å»º client"></a>1ã€åˆ›å»º client</h4><p>è®¤è¯æœåŠ¡éœ€è¦è¿œç¨‹è°ƒç”¨ç”¨æˆ·ä¸­å¿ƒæœåŠ¡æŸ¥è¯¢ç”¨æˆ·ï¼Œåœ¨ <code>è®¤è¯æœåŠ¡</code> ä¸­åˆ›å»ºFeignå®¢æˆ·ç«¯</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient</span>(value = XcServiceList.XC_SERVICE_UCENTER)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserClient</span> </span>&#123;
    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/ucenter/getuserext"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> XcUserExt <span class="hljs-title">getUserext</span><span class="hljs-params">(@RequestParam(<span class="hljs-string">"username"</span>)</span> String username)</span>
<span class="hljs-function">&#125;</span></code></pre></div>

<h4 id="2ã€UserDetailsService"><a href="#2ã€UserDetailsService" class="headerlink" title="2ã€UserDetailsService"></a>2ã€UserDetailsService</h4><p>è®¤è¯æœåŠ¡è°ƒç”¨ <code>spring security</code> æ¥å£ç”³è¯·ä»¤ç‰Œï¼Œ<code>spring security</code> æ¥å£ä¼šè°ƒç”¨ <code>UserDetailsServiceImpl</code> ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ï¼Œå¦‚æœæŸ¥è¯¢ä¸åˆ°åˆ™è¿”å› <code>NULL</code>ï¼Œè¡¨ç¤ºä¸å­˜åœ¨ï¼›åœ¨<code>UserDetailsServiceImpl</code> ä¸­å°†æ­£ç¡®çš„å¯†ç è¿”å›ï¼Œ <code>spring security</code> ä¼šè‡ªåŠ¨å»æ¯”å¯¹è¾“å…¥å¯†ç çš„æ­£ç¡®æ€§ã€‚</p>
<p>ä¿®æ”¹ UserDetailsServiceImpl çš„ <code>loadUserByUsername</code> æ–¹æ³•ï¼Œè°ƒç”¨ UcenteræœåŠ¡çš„æŸ¥è¯¢ç”¨æˆ·æ¥å£</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDetailsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;
 
    <span class="hljs-meta">@Autowired</span>
    ClientDetailsService clientDetailsService;
 
    <span class="hljs-comment">//ç”¨æˆ·ä¸­å¿ƒæœåŠ¡å®¢æˆ·ç«¯</span>
    <span class="hljs-meta">@Autowired</span>
    UserClient userClient;
 
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;
        <span class="hljs-comment">//å–å‡ºèº«ä»½ï¼Œå¦‚æœèº«ä»½ä¸ºç©ºè¯´æ˜æ²¡æœ‰è®¤è¯</span>
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        <span class="hljs-comment">//æ²¡æœ‰è®¤è¯ç»Ÿä¸€é‡‡ç”¨httpbasicè®¤è¯ï¼Œhttpbasicä¸­å­˜å‚¨äº†client_idå’Œclient_secret</span>
        <span class="hljs-comment">//å¼€å§‹è®¤è¯client_idå’Œclient_secret</span>
        <span class="hljs-keyword">if</span>(authentication==<span class="hljs-keyword">null</span>)&#123;
            ClientDetails clientDetails = clientDetailsService.loadClientByClientId(username);
            <span class="hljs-keyword">if</span>(clientDetails!=<span class="hljs-keyword">null</span>)&#123;
                <span class="hljs-comment">//å¯†ç </span>
                String clientSecret = clientDetails.getClientSecret();
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username,clientSecret,AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">""</span>));
            &#125;
        &#125;
        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(username)) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
 
        <span class="hljs-comment">//è¯·æ±‚ucenteræŸ¥è¯¢ç”¨æˆ·</span>
        XcUserExt userext = userClient.getUserext(username);
        <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>; <span class="hljs-comment">//å¦‚æœè·å–åˆ°çš„ç”¨ä¿¡æ¯ä¸ºç©º,åˆ™è¿”å›null,spring securityåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</span>
 
        <span class="hljs-comment">//è®¾ç½®ç”¨æˆ·çš„è®¤è¯å’Œæƒé™ä¿¡æ¯</span>
        userext.setUsername(<span class="hljs-string">"itcast"</span>);
        userext.setPassword(<span class="hljs-keyword">new</span> BCryptPasswordEncoder().encode(<span class="hljs-string">"123"</span>));
        userext.setPermissions(<span class="hljs-keyword">new</span> ArrayList&lt;XcMenu&gt;());  <span class="hljs-comment">//è¿™é‡Œæˆæƒéƒ¨åˆ†è¿˜æ²¡å®Œæˆ,æ‰€ä»¥å…ˆå¡«å†™é™æ€çš„</span>
        <span class="hljs-keyword">if</span>(userext == <span class="hljs-keyword">null</span>)&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
 
        <span class="hljs-comment">//ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æ­£ç¡®çš„å¯†ç ï¼ŒSpring Securityä¼šå»æ¯”å¯¹è¾“å…¥å¯†ç çš„æ­£ç¡®æ€§</span>
        String password = userext.getPassword();
        String user_permission_string = <span class="hljs-string">""</span>;
 
        <span class="hljs-comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°userDetailså¯¹è±¡</span>
        UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(
                username,
                password,
                AuthorityUtils.commaSeparatedStringToAuthorityList(user_permission_string));
        <span class="hljs-comment">//ç”¨æˆ·id</span>
        userDetails.setId(userext.getId());
        <span class="hljs-comment">//ç”¨æˆ·åç§°</span>
        userDetails.setName(userext.getName());
        <span class="hljs-comment">//ç”¨æˆ·å¤´åƒ</span>
        userDetails.setUserpic(userext.getUserpic());
        <span class="hljs-comment">//ç”¨æˆ·æ‰€å±ä¼ä¸šid</span>
        userDetails.setCompanyId(userext.getCompanyId());
 
        <span class="hljs-comment">//è¿”å›ç”¨ä¿¡æ¯ç»™åˆ°Spring Securityè¿›è¡Œå¤„ç†</span>
        <span class="hljs-keyword">return</span> userDetails;
    &#125;
&#125;</code></pre></div>

<h4 id="3ã€BCryptPaswordEncoder"><a href="#3ã€BCryptPaswordEncoder" class="headerlink" title="3ã€BCryptPaswordEncoder"></a>3ã€BCryptPaswordEncoder</h4><p>æ—©æœŸä½¿ç”¨md5å¯¹å¯†ç è¿›è¡Œç¼–ç ï¼Œæ¯æ¬¡ç®—å‡ºçš„md5å€¼éƒ½ä¸€æ ·ï¼Œè¿™æ ·éå¸¸ä¸å®‰å…¨ï¼ŒSpring Securityæ¨èä½¿ç”¨<br>BCryptPasswordEncoderå¯¹å¯†ç åŠ éšæœºç›ï¼Œæ¯æ¬¡çš„Hashå€¼éƒ½ä¸ä¸€æ ·ï¼Œå®‰å…¨æ€§é«˜ ã€‚</p>
<p>1ï¼‰BCryptPasswordEncoderæµ‹è¯•ç¨‹åºå¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testPasswrodEncoder</span><span class="hljs-params">()</span></span>&#123;
    String password = <span class="hljs-string">"111111"</span>;
    PasswordEncoder passwordEncoder = <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++) &#123;
        <span class="hljs-comment">//æ¯ä¸ªè®¡ç®—å‡ºçš„Hashå€¼éƒ½ä¸ä¸€æ ·</span>
        String hashPass = passwordEncoder.encode(password);
        System.out.println(hashPass);
        <span class="hljs-comment">//è™½ç„¶æ¯æ¬¡è®¡ç®—çš„å¯†ç Hashå€¼ä¸ä¸€æ ·ä½†æ˜¯æ ¡éªŒæ˜¯é€šè¿‡çš„</span>
        <span class="hljs-keyword">boolean</span> f = passwordEncoder.matches(password, hashPass);
        System.out.println(f);
    &#125;
&#125;</code></pre></div>

<p>2ï¼‰åœ¨ <code>AuthorizationServerConfig</code> é…ç½®ç±»ä¸­é…ç½® BCryptPasswordEncoder</p>
<blockquote>
<p>åŸæ•™ç¨‹ä¸­å·²ç»åœ¨ WebSecurityConfig ä¸­è¿›è¡Œäº†é…ç½®ï¼Œè¿™ä¸ªåœ¨å“ªé‡Œé…ç½®éƒ½æ— æ‰€è°“ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯å‘springæ³¨å…¥ä¸€ä¸ªbean</p>
</blockquote>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//é‡‡ç”¨bcryptå¯¹å¯†ç è¿›è¡ŒHash</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();
&#125;</code></pre></div>

<p>3ï¼‰æµ‹è¯•</p>
<p>è¯·æ±‚ <a href="http://localhost:40400/auth/userlogin%EF%BC%8C%E8%BE%93%E5%85%A5%E6%AD%A3%E5%B8%B8%E7%9A%84%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%AF%86%E7%A0%81%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95" target="_blank" rel="noopener">http://localhost:40400/auth/userloginï¼Œè¾“å…¥æ­£å¸¸çš„è´¦å·å’Œå¯†ç è¿›è¡Œæµ‹è¯•</a></p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image7.png" srcset="/img/loading.gif" alt="image-20200529102941282"></p>
<h4 id="4ã€è§£æç”³è¯·ä»¤ç‰Œé”™è¯¯ä¿¡æ¯"><a href="#4ã€è§£æç”³è¯·ä»¤ç‰Œé”™è¯¯ä¿¡æ¯" class="headerlink" title="4ã€è§£æç”³è¯·ä»¤ç‰Œé”™è¯¯ä¿¡æ¯"></a>4ã€è§£æç”³è¯·ä»¤ç‰Œé”™è¯¯ä¿¡æ¯</h4><p>å½“è´¦å·è¾“å…¥é”™è¯¯åº”è¯¥è¿”å›ç”¨æˆ·ä¸å­˜åœ¨çš„ä¿¡æ¯ï¼Œå½“å¯†ç é”™è¯¯è¦è¿”å›ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ä¿¡æ¯ï¼Œä¸šåŠ¡æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image8.png" srcset="/img/loading.gif" alt="image-20200527103015749"></p>
<p>ä¿®æ”¹ç”³è¯·ä»¤ç‰Œçš„ç¨‹åºè§£æè¿”å›çš„é”™è¯¯:</p>
<p>ç”±äº <code>restTemplate</code> æ”¶åˆ°400æˆ–401çš„é”™è¯¯ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œ <code>spring security</code> é’ˆå¯¹è´¦å·ä¸å­˜åœ¨åŠå¯†ç é”™è¯¯ä¼šè¿”å› <code>400</code> åŠ <code>401</code>ï¼Œæ‰€ä»¥åœ¨ä»£ç ä¸­æ§åˆ¶é’ˆå¯¹ <code>400</code> æˆ– <code>401</code> çš„å“åº”ä¸è¦æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>ä¿®æ”¹ <code>AuthServiceImpl</code> çš„ appleToken æ–¹æ³•</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//å‘Oauth2æœåŠ¡ç”³è¯·ä»¤ç‰Œ</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> AuthToken <span class="hljs-title">appleToken</span><span class="hljs-params">(String username, String password, String clientId, String clientSecret)</span></span>&#123;
    <span class="hljs-comment">//é‡‡ç”¨å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„æ–¹å¼ä»eurekaè·å–è®¤è¯æœåŠ¡çš„ipå’Œç«¯å£</span>
    ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="hljs-string">"XC-SERVICE-UCENTER-AUTH"</span>);
    URI uri = serviceInstance.getUri();
    String authUrl = uri + <span class="hljs-string">"/auth/oauth/token"</span>;
 
    <span class="hljs-comment">//ä½¿ç”¨LinkedMultiValueMapå‚¨å­˜å¤šä¸ªheaderä¿¡æ¯</span>
    LinkedMultiValueMap&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();
    <span class="hljs-comment">//è®¾ç½®basicè®¤è¯ä¿¡æ¯</span>
    String basicAuth = <span class="hljs-keyword">this</span>.getHttpBasic(clientId, clientSecret);
    headers.add(<span class="hljs-string">"Authorization"</span>,basicAuth);
 
    <span class="hljs-comment">//è®¾ç½®è¯·æ±‚ä¸­çš„bodyä¿¡æ¯</span>
    LinkedMultiValueMap&lt;String, String&gt; body = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();
    body.add(<span class="hljs-string">"grant_type"</span>,<span class="hljs-string">"password"</span>);
    body.add(<span class="hljs-string">"username"</span>,username);
    body.add(<span class="hljs-string">"password"</span>,password);
    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; httpEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(body, headers);
 
    <span class="hljs-comment">//å‡­è¯ä¿¡æ¯é”™è¯¯æ—¶å€™, æŒ‡å®šrestTemplateå½“é‡åˆ°400æˆ–401å“åº”æ—¶å€™ä¹Ÿä¸è¦æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿè¦æ­£å¸¸è¿”å›å€¼</span>
    restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> DefaultResponseErrorHandler()&#123;
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(ClientHttpResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
            <span class="hljs-comment">//å½“å“åº”çš„å€¼ä¸º400æˆ–è€…401æ—¶ä¹Ÿè¦æ­£å¸¸å“åº”,ä¸è¦æŠ›å‡ºå¼‚å¸¸</span>
            <span class="hljs-keyword">if</span>(response.getRawStatusCode()!=<span class="hljs-number">400</span> &amp;&amp; response.getRawStatusCode()!=<span class="hljs-number">401</span>)&#123;
                <span class="hljs-keyword">super</span>.handleError(response);
            &#125;
        &#125;
    &#125;);
 
    Map map = <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">try</span> &#123;
        ((RestTemplate) restTemplate).setErrorHandler(<span class="hljs-keyword">new</span> DefaultResponseErrorHandler() &#123;
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(ClientHttpResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
                <span class="hljs-comment">// è®¾ç½® å½“å“åº”400å’Œ401æ—¶ç…§å¸¸å“åº”æ•°æ®ï¼Œä¸è¦æŠ¥é”™</span>
                <span class="hljs-keyword">if</span> (response.getRawStatusCode() != <span class="hljs-number">400</span> &amp;&amp; response.getRawStatusCode() != <span class="hljs-number">401</span> ) &#123;
                    <span class="hljs-keyword">super</span>.handleError(response);
                &#125;
            &#125;
        &#125;);
 
        <span class="hljs-comment">//httpè¯·æ±‚spring securityçš„ç”³è¯·ä»¤ç‰Œæ¥å£</span>
        ResponseEntity&lt;Map&gt; mapResponseEntity = restTemplate.exchange(authUrl, HttpMethod.POST, <span class="hljs-keyword">new</span>
                                                                      HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt;(body, headers), Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        map = mapResponseEntity.getBody();
    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
        e.printStackTrace();
        LOGGER.error(<span class="hljs-string">"request oauth_token_password error: &#123;&#125;"</span>,e.getMessage());
        e.printStackTrace();
        ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLYTOKEN_FAIL);
    &#125;
    <span class="hljs-keyword">if</span>(map == <span class="hljs-keyword">null</span> ||map.get(<span class="hljs-string">"access_token"</span>) == <span class="hljs-keyword">null</span> ||
       map.get(<span class="hljs-string">"refresh_token"</span>) == <span class="hljs-keyword">null</span> ||
       map.get(<span class="hljs-string">"jti"</span>) == <span class="hljs-keyword">null</span>)&#123;<span class="hljs-comment">//jtiæ˜¯jwtä»¤ç‰Œçš„å”¯ä¸€æ ‡è¯†ä½œä¸ºç”¨æˆ·èº«ä»½ä»¤ç‰Œ</span>
        <span class="hljs-comment">//è·å–spring securityè¿”å›çš„é”™è¯¯ä¿¡æ¯</span>
        String error_description = (String) map.get(<span class="hljs-string">"error_description"</span>);
        <span class="hljs-keyword">if</span>(StringUtils.isNotEmpty(error_description))&#123;
            <span class="hljs-keyword">if</span>(error_description.equals(<span class="hljs-string">"åçš„å‡­è¯"</span>))&#123;
                ExceptionCast.cast(AuthCode.AUTH_CREDENTIAL_ERROR);
            &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(error_description.indexOf(<span class="hljs-string">"UserDetailsService returned null"</span>)&gt;=<span class="hljs-number">0</span>)&#123;
                ExceptionCast.cast(AuthCode.AUTH_ACCOUNT_NOTEXISTS);
            &#125;
        &#125; ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLYTOKEN_FAIL);
    &#125;
 
    <span class="hljs-comment">//æ‹¼è£…authTokenå¹¶è¿”å›</span>
    AuthToken authToken = <span class="hljs-keyword">new</span> AuthToken();
    <span class="hljs-comment">//è®¿é—®ä»¤ç‰Œ(jwt)</span>
    String access_token = (String) map.get(<span class="hljs-string">"access_token"</span>);
    <span class="hljs-comment">//åˆ·æ–°ä»¤ç‰Œ(jwt)</span>
    String refresh_token = (String) map.get(<span class="hljs-string">"refresh_token"</span>);
    <span class="hljs-comment">//jtiï¼Œä½œä¸ºç”¨æˆ·çš„èº«ä»½æ ‡è¯†,ä¹Ÿå°±æ˜¯åé¢æˆ‘ä»¬ç”¨äºè¿”å›ç»™åˆ°ç”¨æˆ·å‰ç«¯çš„å‡­è¯</span>
    String jwt_token = (String) map.get(<span class="hljs-string">"jti"</span>);
 
    authToken.setAccess_token(access_token);
    authToken.setRefresh_token(refresh_token);
    authToken.setJwt_token(jwt_token);
    <span class="hljs-keyword">return</span> authToken;
&#125;</code></pre></div>

<p>ç”¨æˆ·ä¸å­˜åœ¨ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image9.png" srcset="/img/loading.gif" alt="image-20200527103916066"></p>
<p>å¯†ç é”™è¯¯ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image10.png" srcset="/img/loading.gif" alt="image-20200527103926094"></p>
<h4 id="5ã€æµ‹è¯•"><a href="#5ã€æµ‹è¯•" class="headerlink" title="5ã€æµ‹è¯•"></a><strong>5ã€æµ‹è¯•</strong></h4><p>ä½¿ç”¨postmanè¯·æ±‚<a href="http://localhost:40400/auth/userlogin" target="_blank" rel="noopener">http://localhost:40400/auth/userlogin</a></p>
<p>1ã€è¾“å…¥æ­£ç¡®çš„è´¦å·å’Œå¯†ç è¿›è¡Œæµ‹è¯•</p>
<p>ä»æ•°æ®åº“æ‰¾åˆ°æµ‹è¯•è´¦å·ï¼Œæœ¬è¯¾ç¨‹æ‰€æä¾›çš„ç”¨æˆ·ä¿¡æ¯åˆå§‹å¯†ç ç»Ÿä¸€ä¸º123</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image11.png" srcset="/img/loading.gif" alt="image-20200529104816836"></p>
<p>2ã€è¾“å…¥é”™è¯¯çš„è´¦å·å’Œå¯†ç è¿›è¡Œæµ‹è¯•</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image12.png" srcset="/img/loading.gif" alt="image-20200529104802458"></p>
<h2 id="3-ç”¨æˆ·ç™»å½•å‰ç«¯"><a href="#3-ç”¨æˆ·ç™»å½•å‰ç«¯" class="headerlink" title="3. ç”¨æˆ·ç™»å½•å‰ç«¯"></a>3. ç”¨æˆ·ç™»å½•å‰ç«¯</h2><h3 id="éœ€æ±‚åˆ†æ-1"><a href="#éœ€æ±‚åˆ†æ-1" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>ç‚¹å‡»ç”¨æˆ·ç™»å½•å›ºå®šè·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒå‰ç«¯çš„ç™»å½•é¡µé¢ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image13.png" srcset="/img/loading.gif" alt="image-20200527085248145"></p>
<p>è¾“å…¥è´¦å·å’Œå¯†ç ï¼Œç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µã€‚</p>
<p>ç”¨æˆ·ä¸­å¿ƒå‰ç«¯ï¼ˆ<code>xc-ui-pc-learning</code>å·¥ç¨‹ï¼‰æä¾›ç™»å½•é¡µé¢ï¼Œæ‰€æœ‰å­ç³»ç»Ÿè¿æ¥åˆ°æ­¤é¡µé¢ã€‚</p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>é¡µé¢æœ‰ â€œç™»å½•|æ³¨å†Œâ€ é“¾æ¥çš„å‰ç«¯ç³»ç»Ÿæœ‰ï¼šé—¨æˆ·ç³»ç»Ÿã€æœç´¢ç³»ç»Ÿã€ç”¨æˆ·ä¸­å¿ƒã€‚</li>
<li>æœ¬å°èŠ‚ä¿®æ”¹é—¨æˆ·ç³»ç»Ÿçš„é¡µå¤´ï¼Œå…¶å®ƒä¸‰å¤„å¯å‚è€ƒé—¨æˆ·ä¿®æ”¹ã€‚</li>
</ul>
<h3 id="Apiæ–¹æ³•"><a href="#Apiæ–¹æ³•" class="headerlink" title="Apiæ–¹æ³•"></a>Apiæ–¹æ³•</h3><p>åœ¨ <code>xc-ui-pc-leanring/src/base/api/login.js</code> ä¸‹é…ç½®è¯¥apiæ–¹æ³•ï¼Œç”¨äºè¯·æ±‚åç«¯ç™»å½•æ¥å£</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/*ç™»é™†*/</span>
export <span class="hljs-keyword">const</span> login = params =&gt; &#123;
    <span class="hljs-comment">//let loginRequest = querystring.stringify(params)</span>
    let loginRequest = qs.stringify(params);
    <span class="hljs-keyword">return</span> http.requestPostForm(<span class="hljs-string">'/openapi/auth/userlogin'</span>,loginRequest);
&#125;</code></pre></div>

<h3 id="é¡µé¢"><a href="#é¡µé¢" class="headerlink" title="é¡µé¢"></a>é¡µé¢</h3><p><strong>1ã€ç™»å½•é¡µé¢</strong></p>
<p>è¿›å…¥ç”¨æˆ·ä¸­å¿ƒå‰ç«¯ <code>xc-ui-pc-leanring/src/module/home/page/</code>ï¼Œæ‰¾åˆ°ç™»å½•é¡µé¢ <code>loginpage.vue</code>ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image14.png" srcset="/img/loading.gif" alt="image-20200527085434263"></p>
<p>loginpage.vue å¯¼å…¥äº† <code>loginForm.vue</code> ç»„ä»¶ï¼Œ<code>loginForm.vue</code> é¡µé¢åŒ…æ‹¬äº†ç™»å½•è¡¨å•</p>
<div class="hljs"><pre><code class="hljs js">&lt;template&gt;
  &lt;div&gt;
    &lt;p-head&gt;&lt;<span class="hljs-regexp">/p-head&gt;</span>
<span class="hljs-regexp"> </span>
<span class="hljs-regexp">    &lt;login-form&gt;&lt;/</span>login-form&gt;
 
    &lt;p-foot&gt;&lt;<span class="hljs-regexp">/p-foot&gt;</span>
<span class="hljs-regexp">  &lt;/</span>div&gt;
&lt;<span class="hljs-regexp">/template&gt;</span>
<span class="hljs-regexp">&lt;script&gt;</span>
<span class="hljs-regexp">import PHead from '@/</span>base/components/head.vue<span class="hljs-string">';</span>
<span class="hljs-string">import PFoot from '</span>@/base/components/foot.vue<span class="hljs-string">';</span>
<span class="hljs-string">import loginForm from '</span>@/base/components/loginForm.vue<span class="hljs-string">';</span>
<span class="hljs-string">...</span></code></pre></div>

<p>åœ¨ <code>xc-ui-pc-leanring/src/base/components</code> ä¸‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code>loginForm.vue</code> çš„é¡µé¢æ–‡ä»¶ï¼Œä¸»è¦ä¸ºç™»å½•è¡¨å•çš„é¡µé¢å®ç°ï¼Œéƒ¨åˆ†é¡µé¢ä»£ç å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs js">&lt;template&gt;
  &lt;div&gt;
        &lt;el-row <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"container"</span> style=<span class="hljs-string">"width: 470px"</span>&gt;
          &lt;div id=<span class="hljs-string">"body"</span>&gt;
            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"g-center login-page"</span> @keyup.enter=<span class="hljs-string">"login"</span>&gt;
              &lt;el-tabs v-model=<span class="hljs-string">"activeName"</span> &gt;
                &lt;el-tab-pane label=<span class="hljs-string">"ç”¨æˆ·ç™»é™†"</span> name=<span class="hljs-string">"login"</span>&gt;
              &lt;el-form :model=<span class="hljs-string">"loginForm"</span> label-width=<span class="hljs-string">"80px"</span> :rules=<span class="hljs-string">"loginRules"</span> ref=<span class="hljs-string">"loginForm"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"login-form"</span>&gt;
                &lt;el-form-item label=<span class="hljs-string">"è´¦å·"</span> prop=<span class="hljs-string">"username"</span>&gt;
                  &lt;el-input v-model=<span class="hljs-string">"loginForm.username"</span> auto-complete=<span class="hljs-string">"off"</span> &gt;&lt;<span class="hljs-regexp">/el-input&gt;</span>
<span class="hljs-regexp">                &lt;/</span>el-form-item&gt;
                &lt;el-form-item label=<span class="hljs-string">"å¯†ç "</span> prop=<span class="hljs-string">"password"</span>&gt;
                  &lt;el-input v-model=<span class="hljs-string">"loginForm.password"</span> auto-complete=<span class="hljs-string">"off"</span> &gt;&lt;<span class="hljs-regexp">/el-input&gt;</span>
<span class="hljs-regexp">                &lt;/</span>el-form-item&gt;
                &lt;el-form-item &gt;
                  &lt;el-button type=<span class="hljs-string">"primary"</span>  @click.native=<span class="hljs-string">"login"</span> :loading=<span class="hljs-string">"editLoading"</span>&gt;ç™»é™†&lt;<span class="hljs-regexp">/el-button&gt;</span>
<span class="hljs-regexp">                  &lt;el-button type="primary"  @click="resetForm('loginForm')"&gt;é‡ç½®&lt;/</span>el-button&gt;
                &lt;<span class="hljs-regexp">/el-form-item&gt;</span>
<span class="hljs-regexp">              &lt;/</span>el-form&gt;
                &lt;<span class="hljs-regexp">/el-tab-pane&gt;</span>
<span class="hljs-regexp">                &lt;el-tab-pane label="ç”¨æˆ·æ³¨å†Œ" name="register"&gt;</span>
<span class="hljs-regexp">                  å»ºè®¾ä¸­..</span>
<span class="hljs-regexp">                &lt;/</span>el-tab-pane&gt;
              &lt;<span class="hljs-regexp">/el-tabs&gt;</span>
<span class="hljs-regexp">            &lt;/</span>div&gt;

        &lt;<span class="hljs-regexp">/div&gt;</span>
<span class="hljs-regexp">        &lt;/</span>el-row&gt;
  &lt;<span class="hljs-regexp">/div&gt;</span>
<span class="hljs-regexp">&lt;/</span>template&gt;</code></pre></div>

<p><strong>2ã€è·¯ç”±é…ç½®</strong></p>
<p>æ¥åˆ° <code>xc-ui-pc-leanring/src/module/home/router</code> ä¸‹é…ç½®homeæ¨¡å—çš„è·¯ç”±ï¼š</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> Home <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/home/page/home.vue'</span>;
<span class="hljs-keyword">import</span> Login <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/home/page/loginpage.vue'</span>;
<span class="hljs-keyword">import</span> Denied <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/home/page/denied.vue'</span>;
<span class="hljs-keyword">import</span> Logout <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/home/page/logout.vue'</span>;
<span class="hljs-keyword">import</span> order_pay <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/order/page/order_pay.vue'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [&#123;
    path: <span class="hljs-string">'/'</span>,
    component: Home,
    name: <span class="hljs-string">'ä¸ªäººä¸­å¿ƒ'</span>,
    hidden: <span class="hljs-literal">true</span>
&#125;,
&#123;
	path: <span class="hljs-string">'/login'</span>,
	component: Login,
	name: <span class="hljs-string">'Login'</span>,
 	hidden: <span class="hljs-literal">true</span>
&#125;,
   .....</code></pre></div>

<p><strong>3ã€ç™»å½•åè·³è½¬</strong></p>
<p>è¯·æ±‚ç™»å½•é¡µé¢éœ€æºå¸¦ <code>returnUrl</code> å‚æ•°ï¼Œè¦æ±‚æ­¤å‚æ•°ä½¿ç”¨ <code>Base64</code> ç¼–ç ã€‚</p>
<p>ç™»å½•æˆåŠŸåå°†è·³è½¬åˆ° <code>returnUrl</code>ï¼Œ<code>loginForm.vue</code> ç»„ä»¶çš„ç™»å½•æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs js">login: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">this</span>.$refs.loginForm.validate(<span class="hljs-function">(<span class="hljs-params">valid</span>) =&gt;</span> &#123;
        <span class="hljs-keyword">if</span> (valid) &#123;
            <span class="hljs-keyword">this</span>.editLoading = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">let</span> para = <span class="hljs-built_in">Object</span>.assign(&#123;&#125;, <span class="hljs-keyword">this</span>.loginForm);
            loginApi.login(para).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
                <span class="hljs-keyword">this</span>.editLoading = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span>(res.success)&#123;
                    <span class="hljs-keyword">this</span>.$message(<span class="hljs-string">'ç™»é™†æˆåŠŸ'</span>);
                    <span class="hljs-comment">//åˆ·æ–° å½“å‰é¡µé¢</span>
                    <span class="hljs-comment">// alert(this.returnUrl)</span>
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.returnUrl)
                    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.returnUrl!=<span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">this</span>.returnUrl!=<span class="hljs-string">''</span>
                       &amp;&amp; !<span class="hljs-keyword">this</span>.returnUrl.includes(<span class="hljs-string">"/userlogout"</span>)
                       &amp;&amp; !<span class="hljs-keyword">this</span>.returnUrl.includes(<span class="hljs-string">"/userlogin"</span>))&#123;
                        <span class="hljs-built_in">window</span>.location.href = <span class="hljs-keyword">this</span>.returnUrl;
                    &#125;<span class="hljs-keyword">else</span>&#123;
                        <span class="hljs-comment">//è·³è½¬åˆ°é¦–é¡µ</span>
                        <span class="hljs-built_in">window</span>.location.href = <span class="hljs-string">'http://www.xuecheng.com/'</span>
                    &#125;
                &#125;<span class="hljs-keyword">else</span>&#123;
                    <span class="hljs-keyword">if</span>(res.message)&#123;
                        <span class="hljs-keyword">this</span>.$message.error(res.message);
                    &#125;<span class="hljs-keyword">else</span>&#123;
                        <span class="hljs-keyword">this</span>.$message.error(<span class="hljs-string">'ç™»é™†å¤±è´¥'</span>);
                    &#125;
                &#125;
            &#125;,
                                      (res) =&gt; &#123;
                <span class="hljs-keyword">this</span>.editLoading = <span class="hljs-literal">false</span>;
            &#125;);
        &#125;
    &#125;);
&#125;,</code></pre></div>

<h3 id="ç‚¹å‡»ç™»å½•é¡µé¢"><a href="#ç‚¹å‡»ç™»å½•é¡µé¢" class="headerlink" title="ç‚¹å‡»ç™»å½•é¡µé¢"></a>ç‚¹å‡»ç™»å½•é¡µé¢</h3><p>åœ¨é—¨æˆ·çš„é¡µå¤´ç‚¹å‡»â€œç™»å½•|æ³¨å†Œâ€è¿æ¥åˆ°ç”¨æˆ·ä¸­å¿ƒçš„ç™»å½•é¡µé¢ï¼Œå¹¶ä¸”æºå¸¦ <code>returnUrl</code>ã€‚<br>ä¿®æ”¹é—¨æˆ·çš„ <code>header.html</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs js">&lt;a href=<span class="hljs-string">"javascript:;"</span> @click=<span class="hljs-string">"showlogin"</span> v-<span class="hljs-keyword">if</span>=<span class="hljs-string">"logined == false"</span>&gt;ç™»é™†&amp;nbsp;|&amp;nbsp;æ³¨å†Œ&lt;<span class="hljs-regexp">/a&gt;</span></code></pre></div>

<p>é…ç½® showlogin æ–¹æ³•</p>
<div class="hljs"><pre><code class="hljs js">showlogin: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-comment">//this.loginFormVisible = true;</span>
    <span class="hljs-built_in">window</span>.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/login?returnUrl="</span>+
        Base64.encode(<span class="hljs-built_in">window</span>.location)
&#125;</code></pre></div>

<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>æµ‹è¯•ä¹‹å‰ä¿®æ”¹è®¤è¯æœåŠ¡çš„é…ç½®ï¼š</p>
<p>ä¿®æ”¹ <code>application.yml</code> ä¸­ cookie åŸŸå</p>
<div class="hljs"><pre><code class="hljs c">cookieDomain: xuecheng.com</code></pre></div>

<p>æµ‹è¯•æµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ã€è¾“å…¥<a href="http://www.xuecheng.xn--com%28hosts%29-9m4pn7u58t0o1c6r8djlgzpcd80fthza2bger7a/" target="_blank" rel="noopener">www.xuecheng.comè¿›å…¥ç³»ç»Ÿï¼ˆéœ€è¦åœ¨hostsæ–‡ä»¶é…ç½®ï¼‰</a></p>
<p>2ã€è¾“å…¥æ­£ç¡®çš„è´¦å·å’Œå¯†ç ï¼Œæäº¤</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image15.png" srcset="/img/loading.gif" alt="image-20200529111655698"></p>
<p>3ã€è¾“å…¥é”™è¯¯çš„è´¦å·å’Œå¯†ç ï¼Œæäº¤</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image16.png" srcset="/img/loading.gif" alt="image-20200529111704463"></p>
<p>ç™»å½•æˆåŠŸï¼Œè§‚å¯Ÿ <code>cookie</code> æ˜¯å¦å­˜å‚¨æˆåŠŸï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image17.png" srcset="/img/loading.gif" alt="image-20200527085814933"></p>
<h1 id="äºŒã€å‰ç«¯æ˜¾ç¤ºå½“å‰ç”¨æˆ·"><a href="#äºŒã€å‰ç«¯æ˜¾ç¤ºå½“å‰ç”¨æˆ·" class="headerlink" title="äºŒã€å‰ç«¯æ˜¾ç¤ºå½“å‰ç”¨æˆ·"></a>äºŒã€å‰ç«¯æ˜¾ç¤ºå½“å‰ç”¨æˆ·</h1><h2 id="1-éœ€æ±‚åˆ†æ"><a href="#1-éœ€æ±‚åˆ†æ" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>ç”¨æˆ·ç™»å½•æˆåŠŸåœ¨é¡µå¤´æ˜¾ç¤ºå½“å‰ç™»å½•çš„ç”¨æˆ·åç§°ã€‚</p>
<p>æ•°æ®æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image18.png" srcset="/img/loading.gif" alt="image-20200529113051020"></p>
<p>1ã€ç”¨æˆ·è¯·æ±‚è®¤è¯æœåŠ¡ï¼Œç™»å½•æˆåŠŸã€‚</p>
<p>2ã€ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œè®¤è¯æœåŠ¡å‘ <code>cookie</code> å†™å…¥èº«ä»½ä»¤ç‰Œï¼Œå‘ <code>redis</code> å†™å…¥ <code>user_token</code>ï¼ˆèº«ä»½ä»¤ç‰ŒåŠæˆæƒjwtæˆæƒä»¤ç‰Œï¼‰</p>
<p>3ã€å®¢æˆ·ç«¯æºå¸¦ <code>cookie</code> ä¸­çš„èº«ä»½ä»¤ç‰Œè¯·æ±‚è®¤è¯æœåŠ¡è·å– <code>jwt</code> ä»¤ç‰Œã€‚</p>
<p>4ã€å®¢æˆ·ç«¯è§£æ <code>jwt</code> ä»¤ç‰Œï¼Œå¹¶å°†è§£æçš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° <code>sessionStorage</code> ä¸­ã€‚jwtä»¤ç‰Œä¸­åŒ…æ‹¬äº†ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯è§£æjwtä»¤ç‰Œå³å¯è·å–ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>5ã€å®¢æˆ·ç«¯ä»<code>sessionStorage</code>ä¸­è¯»å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶åœ¨é¡µå¤´æ˜¾ç¤ºã€‚</p>
<blockquote>
<p>sessionStorage æ˜¯H5çš„ä¸€ä¸ªä¼šè¯å­˜å‚¨å¯¹è±¡ï¼Œåœ¨ SessionStorageä¸­ä¿å­˜çš„æ•°æ®åªåœ¨åŒä¸€çª—å£æˆ–åŒä¸€æ ‡ç­¾é¡µä¸­æœ‰æ•ˆï¼Œåœ¨å…³é—­çª—å£ä¹‹åå°†ä¼šåˆ é™¤SessionStorageä¸­çš„æ•°æ®ã€‚seesionStorage çš„å­˜å‚¨æ–¹å¼é‡‡ç”¨key/valueçš„æ–¹å¼ï¼Œå¯ä¿å­˜5Må·¦å³çš„æ•°æ®ï¼ˆä¸åŒçš„æµè§ˆå™¨ä¼šæœ‰åŒºåˆ«ï¼‰</p>
</blockquote>
<p>sessionStorage æ˜¯H5çš„ä¸€ä¸ªä¼šè¯å­˜å‚¨å¯¹è±¡ï¼Œåœ¨ SessionStorageä¸­ä¿å­˜çš„æ•°æ®åªåœ¨åŒä¸€çª—å£æˆ–åŒä¸€æ ‡ç­¾é¡µä¸­æœ‰æ•ˆï¼Œ<br>åœ¨å…³é—­çª—å£ä¹‹åå°†ä¼šåˆ é™¤SessionStorageä¸­çš„æ•°æ®ã€‚</p>
<p>seesionStorageçš„å­˜å‚¨æ–¹å¼é‡‡ç”¨key/valueçš„æ–¹å¼ï¼Œå¯ä¿å­˜5Må·¦å³çš„æ•°æ®ï¼ˆä¸åŒçš„æµè§ˆå™¨ä¼šæœ‰åŒºåˆ«ï¼‰</p>
<h2 id="2-jwtæŸ¥è¯¢æ¥å£"><a href="#2-jwtæŸ¥è¯¢æ¥å£" class="headerlink" title="2. jwtæŸ¥è¯¢æ¥å£"></a>2. jwtæŸ¥è¯¢æ¥å£</h2><p>è¯¥æ¥å£æˆ‘ä»¬åœ¨ <code>ucenter-auth</code> æœåŠ¡ä¸‹è¿›è¡Œå¼€å‘</p>
<h3 id="éœ€æ±‚åˆ†æ-2"><a href="#éœ€æ±‚åˆ†æ-2" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>è®¤è¯æœåŠ¡å¯¹å¤–æä¾›jwtæŸ¥è¯¢æ¥å£ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ã€å®¢æˆ·ç«¯æºå¸¦ <code>cookie</code> ä¸­çš„èº«ä»½ä»¤ç‰Œè¯·æ±‚è®¤è¯æœåŠ¡è·å– <code>jwt</code></p>
<p>2ã€è®¤è¯æœåŠ¡æ ¹æ®èº«ä»½ä»¤ç‰Œä» <code>redis</code> ä¸­æŸ¥è¯¢ <code>jwt</code> ä»¤ç‰Œå¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>åœ¨è®¤è¯æ¨¡å—å®šä¹‰ <code>jwt</code> æŸ¥è¯¢æ¥å£ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Api</span>(value = <span class="hljs-string">"jwtæŸ¥è¯¢æ¥å£"</span>,description = <span class="hljs-string">"å®¢æˆ·ç«¯æŸ¥è¯¢jwtä»¤ç‰Œå†…å®¹"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthControllerApi</span> </span>&#123;
    <span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"æŸ¥è¯¢userjwtä»¤ç‰Œ"</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> JwtResult <span class="hljs-title">userjwt</span><span class="hljs-params">()</span></span>;
    ....</code></pre></div>

<h3 id="Dao"><a href="#Dao" class="headerlink" title="Dao"></a>Dao</h3><p>æ— </p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>åœ¨AuthServiceä¸­å®šä¹‰æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//ä»redisæŸ¥è¯¢ä»¤ç‰Œ</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> AuthToken <span class="hljs-title">getUserToken</span><span class="hljs-params">(String token)</span></span>&#123;
    String userToken = <span class="hljs-string">"user_token:"</span>+token;
    String userTokenString = stringRedisTemplate.opsForValue().get(userToken);
    <span class="hljs-keyword">if</span>(userToken!=<span class="hljs-keyword">null</span>)&#123;
        AuthToken authToken = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">try</span> &#123;
            authToken = JSON.parseObject(userTokenString, AuthToken<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;
            LOGGER.error(<span class="hljs-string">"getUserToken from redis and execute JSON.parseObject error&#123;&#125;"</span>,e.getMessage());
            e.printStackTrace();
        &#125; 
        <span class="hljs-keyword">return</span> authToken;
    &#125; 
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
&#125;</code></pre></div>

<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/userjwt"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> JwtResult <span class="hljs-title">userjwt</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-comment">//è·å–cookieä¸­çš„ä»¤ç‰Œ</span>
    String access_token = getTokenFormCookie();
    <span class="hljs-comment">//æ ¹æ®ä»¤ç‰Œä»redisæŸ¥è¯¢jwt</span>
    AuthToken authToken = authService.getUserToken(access_token);
    <span class="hljs-keyword">if</span>(authToken == <span class="hljs-keyword">null</span>)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtResult(CommonCode.FAIL,<span class="hljs-keyword">null</span>);
    &#125; 
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtResult(CommonCode.SUCCESS,authToken.getJwt_token());
&#125; 
<span class="hljs-comment">//ä»cookieä¸­è¯»å–è®¿é—®ä»¤ç‰Œ</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getTokenFormCookie</span><span class="hljs-params">()</span></span>&#123;
    Map&lt;String, String&gt; cookieMap = CookieUtil.readCookie(request, <span class="hljs-string">"uid"</span>);
    String access_token = cookieMap.get(<span class="hljs-string">"uid"</span>);
    <span class="hljs-keyword">return</span> access_token;
&#125;</code></pre></div>

<p>WebSecurityConfig é…ç½®æ”¾è¡Œ <code>userjwt</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;
 
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
        web.ignoring().antMatchers(<span class="hljs-string">"/userlogin"</span>,<span class="hljs-string">"/userlogout"</span>,<span class="hljs-string">"/getjwt"</span>,<span class="hljs-string">"/swagger-ui.html"</span>);
    &#125;</code></pre></div>

<h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ä½¿ç”¨ <code>postman</code> æµ‹è¯•</p>
<p>1ã€è¯·æ±‚ /auth/userlogin</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image19.png" srcset="/img/loading.gif" alt="image-20200530091705402"></p>
<p>è§‚å¯Ÿ <code>cookie</code> æ˜¯å¦å·²å­˜å…¥ç”¨æˆ·èº«ä»½ä»¤ç‰Œ</p>
<p>2ã€getè¯·æ±‚jwt</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image20.png" srcset="/img/loading.gif" alt="image-20200529114126146"></p>
<h2 id="3-å‰ç«¯è¯·æ±‚jwt"><a href="#3-å‰ç«¯è¯·æ±‚jwt" class="headerlink" title="3. å‰ç«¯è¯·æ±‚jwt"></a>3. å‰ç«¯è¯·æ±‚jwt</h2><h3 id="éœ€æ±‚åˆ†æ-3"><a href="#éœ€æ±‚åˆ†æ-3" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>å‰ç«¯éœ€æ±‚å¦‚ä¸‹ï¼š</p>
<p>ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œå‰ç«¯è¯·æ±‚è®¤è¯æœåŠ¡è·å–jwtä»¤ç‰Œã€‚</p>
<p>å‰ç«¯è§£æjwtä»¤ç‰Œçš„å†…å®¹ï¼Œå¾—åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° sessionStorageã€‚</p>
<p>ä» sessionStorage å–å‡ºç”¨æˆ·ä¿¡æ¯åœ¨é¡µå¤´æ˜¾ç¤ºç”¨æˆ·åç§°ã€‚</p>
<p>ä»¥ä¸‹æ“ä½œæˆ‘ä»¬åœ¨é—¨æˆ·å·¥ç¨‹è¿›è¡Œ</p>
<h3 id="APIæ–¹æ³•"><a href="#APIæ–¹æ³•" class="headerlink" title="APIæ–¹æ³•"></a>APIæ–¹æ³•</h3><p>åœ¨login.jsä¸­å®šä¹‰getjwtæ–¹æ³•ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/*è·å–jwtä»¤ç‰Œ*/</span>
<span class="hljs-keyword">const</span> getjwt = () =&gt; &#123;
	<span class="hljs-keyword">return</span> requestGet(<span class="hljs-string">'/openapi/auth/userjwt'</span>);
&#125;</code></pre></div>

<h3 id="é¡µé¢-1"><a href="#é¡µé¢-1" class="headerlink" title="é¡µé¢"></a>é¡µé¢</h3><p>ä¿®æ”¹ <code>include/header.html</code></p>
<p>1ã€é¡µé¢è§†å›¾</p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"logined == true"</span>&gt;</span>æ¬¢è¿&#123;&#123;this.user.username&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"logout"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"logined == true"</span>&gt;</span>é€€å‡º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://ucenter.xuecheng.com/"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"personal"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>æˆ‘çš„å­¦ä¹ <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showlogin"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"logined == false"</span>&gt;</span>ç™»é™†<span class="hljs-symbol">&amp;nbsp;</span>|<span class="hljs-symbol">&amp;nbsp;</span>æ³¨å†Œ<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://teacher.xuecheng.com/"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"personal"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>æ•™å­¦æä¾›æ–¹<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://system.xuecheng.com/"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"personal"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>ç³»ç»Ÿåå°<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></code></pre></div>

<p>ç”¨æˆ·ç™»å½•æˆåŠŸè®¾ç½®æ•°æ®å¯¹è±¡ <code>logined</code> ä¸º <code>true</code>ï¼Œè®¾ç½®æ•°æ®å¯¹è±¡ <code>user</code> ä¸ºå½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>æ•°æ®å¯¹è±¡å®šä¹‰å¦‚ä¸‹</p>
<div class="hljs"><pre><code class="hljs js">user:&#123;
    userid:<span class="hljs-string">''</span>,
    username: <span class="hljs-string">''</span>,
    userpic: <span class="hljs-string">''</span>
&#125;,
logined:<span class="hljs-literal">false</span></code></pre></div>

<p>2ã€è§£æjwtä»¤ç‰Œ</p>
<p>åœ¨ <code>util.js</code> ä¸­å®šä¹‰è§£æjwtä»¤ç‰Œæ–¹æ³•ï¼š</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">//è§£æjwtä»¤ç‰Œï¼Œè·å–ç”¨æˆ·ä¿¡æ¯</span>
<span class="hljs-keyword">var</span> getUserInfoFromJwt = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">jwt</span>) </span>&#123;
    <span class="hljs-keyword">if</span>(!jwt)&#123;
        <span class="hljs-keyword">return</span> ;
    &#125; 
    <span class="hljs-keyword">var</span> jwtDecodeVal = jwt_decode(jwt);
    <span class="hljs-keyword">if</span> (!jwtDecodeVal) &#123;
        <span class="hljs-keyword">return</span> ;
    &#125; 
    <span class="hljs-keyword">let</span> activeUser=&#123;&#125;
    <span class="hljs-comment">//console.log(jwtDecodeVal)</span>
    activeUser.utype = jwtDecodeVal.utype || <span class="hljs-string">''</span>;
    activeUser.username = jwtDecodeVal.name || <span class="hljs-string">''</span>;
    activeUser.userpic = jwtDecodeVal.userpic || <span class="hljs-string">''</span>;
    activeUser.userid = jwtDecodeVal.userid || <span class="hljs-string">''</span>;
    activeUser.authorities = jwtDecodeVal.authorities || <span class="hljs-string">''</span>;
    activeUser.uid = jwtDecodeVal.jti || <span class="hljs-string">''</span>;
    activeUser.jwt = jwt;
    <span class="hljs-keyword">return</span> activeUser;
&#125;</code></pre></div>

<p>3ã€refresh_user()</p>
<p>åœ¨ <code>mounted</code> é’©å­æ–¹æ³•ä¸­è°ƒç”¨ <code>refresh_user</code> è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° <code>sessionStorage</code></p>
<div class="hljs"><pre><code class="hljs js">mounted()&#123;
<span class="hljs-comment">//åˆ·æ–°å½“å‰ç”¨æˆ·</span>
<span class="hljs-keyword">this</span>.refresh_user()
&#125;</code></pre></div>

<p>refresh_user() æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs js">refresh_user:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;
    <span class="hljs-comment">//ä»sessionStorageä¸­å–å‡ºå½“å‰ç”¨æˆ·</span>
    <span class="hljs-keyword">let</span> activeUser= getActiveUser();
    <span class="hljs-comment">//å–å‡ºcookieä¸­çš„ä»¤ç‰Œ</span>
    <span class="hljs-keyword">let</span> uid = getCookie(<span class="hljs-string">"uid"</span>)
        <span class="hljs-comment">//console.log(activeUser)</span>
        <span class="hljs-keyword">if</span>(activeUser &amp;&amp; uid &amp;&amp; uid == activeUser.uid)&#123;
            <span class="hljs-keyword">this</span>.logined = <span class="hljs-literal">true</span>
                <span class="hljs-keyword">this</span>.user = activeUser;
        &#125;<span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">if</span>(!uid)&#123;
                <span class="hljs-keyword">return</span> ;
            &#125; 
            <span class="hljs-comment">//è¯·æ±‚æŸ¥è¯¢jwt</span>
            getjwt().then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
                <span class="hljs-keyword">if</span>(res.success)&#123;
                    <span class="hljs-keyword">let</span> jwt = res.jwt;
                    <span class="hljs-keyword">let</span> activeUser = getUserInfoFromJwt(jwt)
                        <span class="hljs-keyword">if</span>(activeUser)&#123;
                            <span class="hljs-keyword">this</span>.logined = <span class="hljs-literal">true</span>
                                <span class="hljs-keyword">this</span>.user = activeUser;
                            setUserSession(<span class="hljs-string">"activeUser"</span>,<span class="hljs-built_in">JSON</span>.stringify(activeUser))
                        &#125;
                &#125;
            &#125;)
        &#125;
&#125;</code></pre></div>

<h3 id="é…ç½®ä»£ç†è½¬å‘"><a href="#é…ç½®ä»£ç†è½¬å‘" class="headerlink" title="é…ç½®ä»£ç†è½¬å‘"></a>é…ç½®ä»£ç†è½¬å‘</h3><p>ä¸Šè¾¹å®ç°åœ¨é¦–é¡µæ˜¾ç¤ºå½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œé¦–é¡µéœ€è¦é€šè¿‡ <code>Nginx</code> ä»£ç†è¯·æ±‚è®¤è¯æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦åœ¨ <code>www</code> åŸŸä¸‹çš„è™šæ‹Ÿä¸»æœºä¸Šé…ç½®ä»£ç†è·¯å¾„ï¼š</p>
<div class="hljs"><pre><code class="hljs c">#è®¤è¯
location ^~ /openapi/auth/ &#123;
	proxy_pass http:<span class="hljs-comment">//auth_server_pool/auth/;</span>
&#125;</code></pre></div>

<p>æ³¨æ„ï¼šå…¶å®ƒå‰ç«¯ç³»ç»Ÿè¦æ¥å…¥è®¤è¯è¦è¯·æ±‚è®¤è¯æœåŠ¡ä¹Ÿéœ€è¦é…ç½®ä¸Šè¾¹çš„ä»£ç†è·¯å¾„ã€‚</p>
<h3 id="æµ‹è¯•-2"><a href="#æµ‹è¯•-2" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>ç™»å½•æˆåŠŸåè‡ªåŠ¨è·³è½¬å›åˆ°é—¨æˆ·ä¸»ç«™ï¼Œå¹¶æ˜¾ç¤ºç”¨æˆ·çš„ä¿¡æ¯</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image21.png" srcset="/img/loading.gif" alt="img"></p>
<h1 id="ä¸‰ã€ç”¨æˆ·é€€å‡º"><a href="#ä¸‰ã€ç”¨æˆ·é€€å‡º" class="headerlink" title="ä¸‰ã€ç”¨æˆ·é€€å‡º"></a>ä¸‰ã€ç”¨æˆ·é€€å‡º</h1><h2 id="1-éœ€æ±‚åˆ†æ-1"><a href="#1-éœ€æ±‚åˆ†æ-1" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p>1ã€ç”¨æˆ·ç‚¹å‡»é€€å‡ºï¼Œå¼¹å‡ºé€€å‡ºç¡®è®¤çª—å£ï¼Œç‚¹å‡»ç¡®å®š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image22.png" srcset="/img/loading.gif" alt="image-20200530095137916"></p>
<p>2ã€é€€å‡ºæˆåŠŸ</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image23.png" srcset="/img/loading.gif" alt="image-20200530095144891"></p>
<p>ç”¨æˆ·é€€å‡ºè¦å®Œæˆä»¥ä¸‹åŠ¨ä½œï¼š</p>
<p>1ã€åˆ é™¤ <code>redis</code> ä¸­çš„ <code>token</code></p>
<p>2ã€åˆ é™¤ <code>cookie</code> ä¸­çš„ <code>token</code></p>
<h2 id="2-API"><a href="#2-API" class="headerlink" title="2. API"></a>2. API</h2><p>è®¤è¯æœåŠ¡å¯¹å¤–æä¾›é€€å‡ºæ¥å£ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@ApiOperation</span>(<span class="hljs-string">"é€€å‡º"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">logout</span><span class="hljs-params">()</span></span>;</code></pre></div>

<h2 id="3-æœåŠ¡ç«¯"><a href="#3-æœåŠ¡ç«¯" class="headerlink" title="3. æœåŠ¡ç«¯"></a>3. æœåŠ¡ç«¯</h2><p>è®¤è¯æœåŠ¡æä¾›é€€å‡ºæ¥å£ã€‚</p>
<h3 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h3><p>æ— </p>
<h3 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment">     * åˆ é™¤æŒ‡å®šusertokenåœ¨redisä¸­çš„jwtä¿¡æ¯</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uid usertoken</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span>
<span class="hljs-comment">     */</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">delToken</span><span class="hljs-params">(String uid)</span> </span>&#123;
    String key = <span class="hljs-string">"user_token:"</span> + uid;
    Boolean delete = stringRedisTemplate.delete(key);
    <span class="hljs-keyword">return</span> delete;
&#125;</code></pre></div>

<h3 id="Controller-1"><a href="#Controller-1" class="headerlink" title="Controller"></a>Controller</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/userlogout"</span>)
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title">logout</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-comment">// å–å‡ºç”¨æˆ·èº«ä»½ä»¤ç‰Œ</span>
    String uid = getTokenFormCookie();
    <span class="hljs-comment">//åˆ é™¤ç”¨æˆ·åœ¨redisä¸­çš„èº«ä»½ä¿¡æ¯</span>
    Boolean delToken = authService.delToken(uid);
    <span class="hljs-comment">//é€šè¿‡ä¿®æ”¹è¿”å›çš„responseæ¥å®ç°ç”¨æˆ·å‰ç«¯æ”¶åˆ°å“åº”ååˆ é™¤æµè§ˆå™¨çš„cookieä¿¡æ¯</span>
    clearCookie(uid);
    <span class="hljs-keyword">if</span>(delToken)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.SUCCESS);
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseResult(CommonCode.FAIL);
&#125;
 
<span class="hljs-comment">//æ¸…é™¤cookie</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clearCookie</span><span class="hljs-params">(String token)</span></span>&#123;
    HttpServletResponse response = ((ServletRequestAttributes)
                                    RequestContextHolder.getRequestAttributes()).getResponse();
    <span class="hljs-comment">// è®¾ç½®maxAgeä¸ºå®ç°åˆ é™¤cookie</span>
    CookieUtil.addCookie(response, cookieDomain, <span class="hljs-string">"/"</span>, <span class="hljs-string">"uid"</span>, token, <span class="hljs-number">0</span>, <span class="hljs-keyword">false</span>);
&#125;</code></pre></div>

<h3 id="é€€å‡ºURLæ”¾è¡Œ"><a href="#é€€å‡ºURLæ”¾è¡Œ" class="headerlink" title="é€€å‡ºURLæ”¾è¡Œ"></a>é€€å‡ºURLæ”¾è¡Œ</h3><p>è®¤è¯æœåŠ¡é»˜è®¤éƒ½è¦æ ¡éªŒç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œè¿™é‡Œéœ€è¦å°†é€€å‡ºurlæ”¾è¡Œã€‚</p>
<p>åœ¨ <code>WebSecurityConfig</code> ç±»ä¸­é‡å†™ <code>configure</code> (WebSecurity web)æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    web.ignoring().antMatchers(<span class="hljs-string">"/userlogin"</span>,<span class="hljs-string">"/userlogout"</span>,<span class="hljs-string">"/userjwt"</span>,<span class="hljs-string">"/swagger-ui.html"</span>);
&#125;</code></pre></div>

<h2 id="4-å‰ç«¯"><a href="#4-å‰ç«¯" class="headerlink" title="4. å‰ç«¯"></a>4. å‰ç«¯</h2><h3 id="éœ€æ±‚åˆ†æ-4"><a href="#éœ€æ±‚åˆ†æ-4" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>åœ¨ç”¨æˆ·ä¸­å¿ƒå‰ç«¯å·¥ç¨‹ï¼ˆxc-ui-pc-learningï¼‰å¼€å‘é€€å‡ºé¡µé¢ã€‚</p>
<h3 id="Apiæ–¹æ³•å®šä¹‰"><a href="#Apiæ–¹æ³•å®šä¹‰" class="headerlink" title="Apiæ–¹æ³•å®šä¹‰"></a>Apiæ–¹æ³•å®šä¹‰</h3><p>åœ¨ç”¨æˆ·ä¸­å¿ƒå·¥ç¨‹å¢åŠ é€€å‡ºçš„ <code>api</code> æ–¹æ³•</p>
<p>åœ¨ <code>base</code> æ¨¡å—çš„ <code>login.js</code> å¢åŠ æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-comment">/*é€€å‡º*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> logout = <span class="hljs-function"><span class="hljs-params">params</span> =&gt;</span> &#123;
    <span class="hljs-keyword">return</span> http.requestPost(<span class="hljs-string">'/openapi/auth/userlogout'</span>);
&#125;</code></pre></div>

<h3 id="é€€å‡ºé¡µé¢"><a href="#é€€å‡ºé¡µé¢" class="headerlink" title="é€€å‡ºé¡µé¢"></a>é€€å‡ºé¡µé¢</h3><p>1ã€åœ¨ç”¨æˆ·ä¸­å¿ƒå·¥ç¨‹åˆ›å»ºé€€å‡ºé¡µé¢</p>
<p>å‚è€ƒï¼š <code>xc-ui-pc-leanring/src/module/home/page/logout.vue</code></p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image24.png" srcset="/img/loading.gif" alt="image-20200530095510125"></p>
<p>2ã€è·¯ç”±é…ç½®</p>
<div class="hljs"><pre><code class="hljs js"><span class="hljs-keyword">import</span> Logout <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/home/page/logout.vue'</span>;
<span class="hljs-keyword">import</span> order_pay <span class="hljs-keyword">from</span> <span class="hljs-string">'@/module/order/page/order_pay.vue'</span>;
<span class="hljs-comment">// import LoginMini from '@/module/home/page/login_mini.vue';</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [&#123;
    path: <span class="hljs-string">'/'</span>,
    component: Home,
    name: <span class="hljs-string">'ä¸ªäººä¸­å¿ƒ'</span>,
    hidden: <span class="hljs-literal">true</span>
&#125;,
&#123;
    path: <span class="hljs-string">'/login'</span>,
    component: Login,
    name: <span class="hljs-string">'Login'</span>,
    hidden: <span class="hljs-literal">true</span>
&#125;,
&#123;
    path: <span class="hljs-string">'/logout'</span>,
    component: Logout,
    name: <span class="hljs-string">'Logout'</span>,
    hidden: <span class="hljs-literal">true</span>
&#125;,
....</code></pre></div>

<p>3ã€é€€å‡ºæ–¹æ³•</p>
<p>é€€å‡ºæˆåŠŸæ¸…é™¤é¡µé¢çš„ <code>sessionStorage</code></p>
<p>å‚è€ƒ <code>logout.vue</code></p>
<p>åœ¨ <code>created</code> é’©å­æ–¹æ³•è¯·æ±‚é€€å‡ºæ–¹æ³•</p>
<div class="hljs"><pre><code class="hljs js">created()&#123;
    loginApi.logout(&#123;&#125;).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            sessionStorage.removeItem(<span class="hljs-string">'activeUser'</span>);
            <span class="hljs-keyword">this</span>.$message(<span class="hljs-string">'é€€å‡ºæˆåŠŸ'</span>);
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">true</span>
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(res.code == <span class="hljs-number">11111</span>)&#123;
            <span class="hljs-comment">// ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯å·²åœ¨redisè¿‡æœŸ</span>
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">this</span>.$message(<span class="hljs-string">'ç”¨æˆ·å‡­è¯è¿‡æœŸ, åœ¨è¿™ä¹‹å‰å·²ç»é€€å‡ºç™»é™†'</span>);
        &#125; <span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
        &#125;
        <span class="hljs-comment">//æ¸…ç©ºç”¨æˆ·çš„ç¼“å­˜ä¿¡æ¯</span>
        sessionStorage.clear()
    &#125;,
                             (res) =&gt; &#123;
        <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
    &#125;);
&#125;,</code></pre></div>

<h3 id="é“¾æ¥åˆ°é€€å‡ºé¡µé¢"><a href="#é“¾æ¥åˆ°é€€å‡ºé¡µé¢" class="headerlink" title="é“¾æ¥åˆ°é€€å‡ºé¡µé¢"></a>é“¾æ¥åˆ°é€€å‡ºé¡µé¢</h3><p>ä¿®æ”¹é—¨æˆ·ä¸»ç«™ xc-ui-pc-static-portal çš„ <code>include/header.html</code></p>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:;"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"logout"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"logined == true"</span>&gt;</span>é€€å‡º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></code></pre></div>

<p>åœ¨ <code>include/header.html</code> ä¸­æ·»åŠ  <code>element-ui</code> åº“ï¼Œå°†æ­¤jsåŠ åˆ° <code>head</code> çš„æœ€ä¸‹è¾¹</p>
<blockquote>
<p>å¦åˆ™å¯èƒ½ä¼šå‡ºç°æ— æ³•åŠ è½½element-uiç»„ä»¶çš„é—®é¢˜</p>
</blockquote>
<div class="hljs"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/css/el/index.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre></div>

<p><code>logout</code> æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs js">logout: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">this</span>.$confirm(<span class="hljs-string">'ç¡®è®¤é€€å‡ºå—?'</span>, <span class="hljs-string">'æç¤º'</span>, &#123;
    &#125;).then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
        <span class="hljs-comment">//è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒçš„ç™»å‡ºé¡µé¢</span>
        <span class="hljs-built_in">window</span>.location = <span class="hljs-string">"http://ucenter.xuecheng.com/#/logout"</span>
    &#125;).catch(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
        
    &#125;);
&#125;,</code></pre></div>

<h3 id="æµ‹è¯•æ•ˆæœ"><a href="#æµ‹è¯•æ•ˆæœ" class="headerlink" title="æµ‹è¯•æ•ˆæœ"></a>æµ‹è¯•æ•ˆæœ</h3><p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image25.png" srcset="/img/loading.gif" alt="image-20200530111647702"></p>
<h3 id="ä¸€äº›é—®é¢˜"><a href="#ä¸€äº›é—®é¢˜" class="headerlink" title="ä¸€äº›é—®é¢˜"></a>ä¸€äº›é—®é¢˜</h3><blockquote>
<p>ä¸‹è¿°çš„ä¸€äº›é—®é¢˜åœ¨æˆ‘ä¸Šé¢çš„ä»£ç ä¸­å…¶å®å·²ç»ä¿®å¤ï¼Œä½†éƒ¨åˆ†è¯»è€…å¯èƒ½è·³è¿‡äº†ä¸Šè¿°çš„æ­¥éª¤ï¼Œä»ç„¶ä½¿ç”¨çš„æ˜¯åŸæ•™ç¨‹ä¸­æ‰€ç»™åˆ°çš„ä»£ç æ¡ˆä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„ä¸€äº›é—®é¢˜æˆ‘å•ç‹¬åˆ—å‡ºæ¥ã€‚</p>
</blockquote>
<p>1ã€ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯å·²åœ¨redisè¿‡æœŸï¼Œè¿”å›æ“ä½œçš„çŠ¶æ€ç ï¼Œå‰ç«¯æ²¡æœ‰è¯†åˆ«ä¸ºå·²ç™»å‡ºçš„çŠ¶æ€</p>
<p>å¢åŠ å¯¹ <code>11111</code> çŠ¶æ€ç çš„åˆ¤æ–­</p>
<div class="hljs"><pre><code class="hljs js">created()&#123;
    loginApi.logout(&#123;&#125;).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            sessionStorage.removeItem(<span class="hljs-string">'activeUser'</span>);
            <span class="hljs-keyword">this</span>.$message(<span class="hljs-string">'é€€å‡ºæˆåŠŸ'</span>);
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">true</span>
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(res.code == <span class="hljs-number">11111</span>)&#123;
            <span class="hljs-comment">// ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯å·²åœ¨redisè¿‡æœŸ</span>
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">this</span>.$message(<span class="hljs-string">'ç”¨æˆ·å‡­è¯è¿‡æœŸ, åœ¨è¿™ä¹‹å‰å·²ç»é€€å‡ºç™»é™†'</span>);
        &#125; <span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
        &#125;
    &#125;,
                             (res) =&gt; &#123;
        <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
    &#125;);
&#125;,</code></pre></div>

<p>2ã€ç™»å‡ºæˆåŠŸåï¼Œè¿”å›ä¸»é¡µåä»ç„¶æ˜¾ç¤ºç”¨æˆ·çš„ä¿¡æ¯</p>
<p>åœ¨å‘é€ç™»å‡ºè¯·æ±‚åï¼Œä½¿ç”¨ <code>sessionStorage.clear()</code> æ¸…ç©ºç”¨æˆ·çš„ç¼“å­˜ä¿¡æ¯</p>
<div class="hljs"><pre><code class="hljs js">created()&#123;
    loginApi.logout(&#123;&#125;).then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
        <span class="hljs-keyword">if</span>(res.success)&#123;
            sessionStorage.removeItem(<span class="hljs-string">'activeUser'</span>);
            <span class="hljs-keyword">this</span>.$message(<span class="hljs-string">'é€€å‡ºæˆåŠŸ'</span>);
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">true</span>
        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(res.code == <span class="hljs-number">11111</span>)&#123;
            <span class="hljs-comment">// ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯å·²åœ¨redisè¿‡æœŸ</span>
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
            <span class="hljs-keyword">this</span>.$message(<span class="hljs-string">'ç”¨æˆ·å‡­è¯è¿‡æœŸ, åœ¨è¿™ä¹‹å‰å·²ç»é€€å‡ºç™»é™†'</span>);
        &#125; <span class="hljs-keyword">else</span>&#123;
            <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
        &#125;
        <span class="hljs-comment">//æ¸…ç©ºç”¨æˆ·çš„ç¼“å­˜ä¿¡æ¯</span>
        sessionStorage.clear()
    &#125;,
                             (res) =&gt; &#123;
        <span class="hljs-keyword">this</span>.logoutsuccess = <span class="hljs-literal">false</span>
    &#125;);
&#125;,</code></pre></div>

<h1 id="å››ã€Zuul-ç½‘å…³"><a href="#å››ã€Zuul-ç½‘å…³" class="headerlink" title="å››ã€Zuul ç½‘å…³"></a>å››ã€Zuul ç½‘å…³</h1><h2 id="1-éœ€æ±‚åˆ†æ-2"><a href="#1-éœ€æ±‚åˆ†æ-2" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>ç½‘å…³çš„ä½œç”¨ç›¸å½“äºä¸€ä¸ªè¿‡è™‘å™¨ã€æ‹¦æˆªå™¨ï¼Œå®ƒå¯ä»¥æ‹¦æˆªå¤šä¸ªç³»ç»Ÿçš„è¯·æ±‚ã€‚</p>
<p>æœ¬ç« èŠ‚è¦ä½¿ç”¨ç½‘å…³æ ¡éªŒç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•ã€‚</p>
<h2 id="2-Zuul-ä»‹ç»"><a href="#2-Zuul-ä»‹ç»" class="headerlink" title="2. Zuul ä»‹ç»"></a>2. Zuul ä»‹ç»</h2><p>ä»€ä¹ˆæ˜¯Zuulï¼Ÿ</p>
<p>Spring Cloud Zuul æ˜¯æ•´åˆ <code>Netflix</code> å…¬å¸çš„ <code>Zuul</code> å¼€æºé¡¹ç›®å®ç°çš„å¾®æœåŠ¡ç½‘å…³ï¼Œå®ƒå®ç°äº† <code>è¯·æ±‚è·¯ç”±</code>ã€<code>è´Ÿè½½å‡è¡¡</code>ã€<code>æ ¡éªŒè¿‡è™‘</code> ç­‰åŠŸèƒ½ã€‚</p>
<p>å®˜æ–¹ï¼š<a href="https://github.com/Netflix/zuul" target="_blank" rel="noopener">https://github.com/Netflix/zuul</a></p>
<p>ä»€ä¹ˆæ˜¯ç½‘å…³ï¼Ÿ</p>
<p>æœåŠ¡ç½‘å…³æ˜¯åœ¨å¾®æœåŠ¡å‰è¾¹è®¾ç½®ä¸€é“å±éšœï¼Œè¯·æ±‚å…ˆåˆ°æœåŠ¡ç½‘å…³ï¼Œç½‘å…³ä¼šå¯¹è¯·æ±‚è¿›è¡Œ <code>è¿‡è™‘</code>ã€<code>æ ¡éªŒ</code>ã€<code>è·¯ç”±</code> ç­‰å¤„ç†ã€‚æœ‰äº†æœåŠ¡ç½‘å…³å¯ä»¥æé«˜å¾®æœåŠ¡çš„å®‰å…¨æ€§ï¼Œç½‘å…³æ ¡éªŒè¯·æ±‚çš„åˆæ³•æ€§ï¼Œè¯·æ±‚ä¸åˆæ³•å°†è¢«æ‹¦æˆªï¼Œæ‹’ç»è®¿é—®ã€‚</p>
<p>Zuul ä¸ <code>Nginx</code> æ€ä¹ˆé…åˆä½¿ç”¨ï¼Ÿ</p>
<p>Zuulä¸ <code>Nginx</code> åœ¨å®é™…é¡¹ç›®ä¸­éœ€è¦é…åˆä½¿ç”¨ï¼Œå¦‚ä¸‹å›¾ï¼Œ<code>Nginx</code> çš„ä½œç”¨æ˜¯åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ï¼Œ<code>Zuul</code> çš„ä½œç”¨æ˜¯ä¿éšœå¾®æœåŠ¡çš„å®‰å…¨è®¿é—®ï¼Œæ‹¦æˆªå¾®æœåŠ¡è¯·æ±‚ï¼Œæ ¡éªŒåˆæ³•æ€§åŠè´Ÿè½½å‡è¡¡ã€‚</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image26.png" srcset="/img/loading.gif" alt="image-20200531170255074"></p>
<h2 id="3-æ­å»ºç½‘å…³å·¥ç¨‹"><a href="#3-æ­å»ºç½‘å…³å·¥ç¨‹" class="headerlink" title="3.æ­å»ºç½‘å…³å·¥ç¨‹"></a>3.æ­å»ºç½‘å…³å·¥ç¨‹</h2><p>åˆ›å»ºç½‘å…³å·¥ç¨‹ï¼ˆxc-govern-gatewayï¼‰ï¼š</p>
<p><strong>1ã€åˆ›å»º xc-govern-gateway å·¥ç¨‹</strong></p>
<p>å¯¼å…¥ <code>èµ„æ–™/xc-govern-gateway.zip</code></p>
<p><strong>2ã€@EnableZulProxy</strong></p>
<p>æ³¨æ„åœ¨å¯åŠ¨ç±»ä¸Šä½¿ç”¨ <code>@EnableZuulProxy</code> æ³¨è§£æ ‡è¯†æ­¤å·¥ç¨‹ä¸º <code>Zuul</code> ç½‘å…³ï¼Œå¯åŠ¨ç±»ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableZuulProxy</span>
public class GatewayApplication &#123;
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) &#123;
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(GatewayApplication.class, args);
    &#125;
&#125;</code></pre></div>

<h2 id="4-è·¯ç”±é…ç½®"><a href="#4-è·¯ç”±é…ç½®" class="headerlink" title="4. è·¯ç”±é…ç½®"></a>4. è·¯ç”±é…ç½®</h2><h3 id="éœ€æ±‚åˆ†æ-5"><a href="#éœ€æ±‚åˆ†æ-5" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h3><p>Zuul ç½‘å…³å…·æœ‰ä»£ç†çš„åŠŸèƒ½ï¼Œæ ¹æ®è¯·æ±‚çš„urlè½¬å‘åˆ°å¾®æœåŠ¡ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image27.png" srcset="/img/loading.gif" alt="image-20200531170704355"></p>
<ul>
<li>å®¢æˆ·ç«¯è¯·æ±‚ç½‘å…³ <code>/api/learning</code>ï¼Œé€šè¿‡è·¯ç”±è½¬å‘åˆ° <code>/learning</code></li>
<li>å®¢æˆ·ç«¯è¯·æ±‚ç½‘å…³ <code>/api/course</code>ï¼Œé€šè¿‡è·¯ç”±è½¬å‘åˆ° <code>/course</code></li>
</ul>
<h3 id="è·¯ç”±é…ç½®"><a href="#è·¯ç”±é…ç½®" class="headerlink" title="è·¯ç”±é…ç½®"></a>è·¯ç”±é…ç½®</h3><p>åœ¨ <code>appcation.yml</code> ä¸­é…ç½®ï¼š</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">zuul:</span>
  <span class="hljs-attr">routes:</span>
	<span class="hljs-attr">manage-course:</span> <span class="hljs-comment">#è·¯ç”±åç§°ï¼Œåç§°ä»»æ„ï¼Œä¿æŒæ‰€æœ‰è·¯ç”±åç§°å”¯ä¸€</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/course/**</span>
      <span class="hljs-attr">serviceId:</span> <span class="hljs-string">xc-service-manage-course</span> <span class="hljs-comment">#æŒ‡å®šæœåŠ¡idï¼Œä»Eurekaä¸­æ‰¾åˆ°æœåŠ¡çš„ipå’Œç«¯å£</span>
      <span class="hljs-comment">#url: http://localhost:31200 #ä¹Ÿå¯æŒ‡å®šurl</span>
      <span class="hljs-attr">strip-prefix:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#trueï¼šä»£ç†è½¬å‘æ—¶å»æ‰å‰ç¼€ï¼Œfalse:ä»£ç†è½¬å‘æ—¶ä¸å»æ‰å‰ç¼€</span>
      <span class="hljs-attr">sensitiveHeaders:</span> <span class="hljs-comment">#é»˜è®¤zuulä¼šå±è”½cookieï¼Œcookieä¸ä¼šä¼ åˆ°ä¸‹æ¸¸æœåŠ¡ï¼Œè¿™é‡Œè®¾ç½®ä¸ºç©ºåˆ™å–æ¶ˆé»˜è®¤çš„é»‘åå•ï¼Œå¦‚æœè®¾ç½®äº†å…·ä½“çš„å¤´ä¿¡æ¯åˆ™ä¸ä¼šä¼ åˆ°ä¸‹æ¸¸æœåŠ¡</span>
	  <span class="hljs-comment"># ignoredHeaders: Authorization</span></code></pre></div>

<ul>
<li><p><strong>serviceId</strong>ï¼šæ¨èä½¿ç”¨ <code>serviceId</code>ï¼Œzuulä¼šä» <code>Eureka</code> ä¸­æ‰¾åˆ°æœåŠ¡ <code>id</code> å¯¹åº”çš„ <code>ip</code> å’Œç«¯å£ã€‚</p>
</li>
<li><p><strong>strip-prefix</strong>: falseæˆ–è€…trueï¼Œè®¾ç½®ä¸º <code>true</code> æ—¶ä»£ç†è½¬å‘æ—¶å»æ‰å‰ç¼€ï¼Œ<code>false</code> åˆ™ä»£ç†è½¬å‘æ—¶ä¸å»æ‰å‰ç¼€</p>
<p>ä¾‹å¦‚ï¼Œè®¾ç½®ä¸º <code>true</code> è¯·æ±‚ <code>/course/coursebase/get/..</code> ï¼Œä»£ç†è½¬å‘åˆ° <code>/coursebase/get/</code>ï¼Œå¦‚æœä¸ºfalseåˆ™ä»£ç†ç›´æ¥è½¬å‘åˆ°åŸæ¥çš„url</p>
</li>
<li><p><strong>sensitiveHeaders</strong>ï¼šæ•æ„Ÿå¤´è®¾ç½®ï¼Œé»˜è®¤ä¼šè¿‡è™‘æ‰cookieï¼Œè¿™é‡Œè®¾ç½®ä¸ºç©ºè¡¨ç¤ºä¸è¿‡è™‘</p>
</li>
<li><p><strong>ignoredHeaders</strong>ï¼šå¯ä»¥è®¾ç½®è¿‡è™‘çš„å¤´ä¿¡æ¯ï¼Œé»˜è®¤ä¸ºç©ºè¡¨ç¤ºä¸è¿‡è™‘ä»»ä½•å¤´</p>
</li>
</ul>
<h3 id="æµ‹è¯•-3"><a href="#æµ‹è¯•-3" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p><a href="http://localhost:50201/api" target="_blank" rel="noopener">http://localhost:50201/api</a> æ˜¯ç½‘å…³åœ°å€ï¼Œé€šè¿‡è·¯ç”±è½¬å‘åˆ° <code>xc-service-manage-course</code> æœåŠ¡ã€‚</p>
<p>æ‰“ç®—ä½¿ç”¨è¯¾ç¨‹å›¾ç‰‡ä¿¡æ¯è·å–çš„ API è¿›è¡Œæµ‹è¯•æˆ‘ï¼Œè¿™é‡Œçš„è¯¾ç¨‹å›¾ç‰‡ä¿¡æ¯è·å–çš„URLä¸º <code>/course/coursepic/get</code> ï¼Œæ‰€ä»¥ç”±äºè¯¾ç¨‹ç®¡ç†å·²ç»æ·»åŠ äº†æˆè¯¾æ‹¦æˆªï¼Œè¿™é‡Œä¸ºäº†æµ‹è¯•ç½‘å…³åŠŸèƒ½æš‚æ—¶å°† url <code>/course/coursepic/get</code>æ’é™¤è®¤è¯ã€‚åœ¨è¯¾ç¨‹ç®¡ç†æœåŠ¡çš„ <code>ResourceServerConfig</code> ç±»ä¸­æ·»åŠ  <code>&quot;/course/coursepic/get/*&quot;</code> ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-comment">//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡</span>
    http.authorizeRequests()
        <span class="hljs-comment">//ä¸‹è¾¹çš„è·¯å¾„æ”¾è¡Œ</span>
        .antMatchers(<span class="hljs-string">"/v2/api-docs"</span>, <span class="hljs-string">"/swagger-resources/configuration/ui"</span>,
                     <span class="hljs-string">"/swagger-resources"</span>,<span class="hljs-string">"/swagger-resources/configuration/security"</span>,
                     <span class="hljs-string">"/swagger-ui.html"</span>,<span class="hljs-string">"/course/coursepic/list/*"</span>)
        .permitAll()
        .anyRequest().authenticated();
&#125;</code></pre></div>

<p>è€Œæˆ‘ä¹‹å‰çš„è¯¾ç¨‹ä¸­å°†éœ€è¦æ’é™¤çš„ <code>url</code> æ”¹å†™æˆäº†ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ï¼Œå¦‚ä¸‹ä»£ç ï¼Œå¦‚æœæ˜¯æŒ‰åŸæ•™ç¨‹çš„é…ç½®çš„ï¼Œå¯ä»¥å¿½ç•¥ä¸‹è¿°çš„ä»£ç ï¼Œ ç›´æ¥é˜…è¯»æµ‹è¯•çš„ç¯èŠ‚ã€‚</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;oauth2.urlMatchers&#125;"</span>)
String urlMatchers;
 
<span class="hljs-comment">//Httpå®‰å…¨é…ç½®ï¼Œå¯¹æ¯ä¸ªåˆ°è¾¾ç³»ç»Ÿçš„httpè¯·æ±‚é“¾æ¥è¿›è¡Œæ ¡éªŒ</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-keyword">if</span>(urlMatchers.equals(<span class="hljs-string">""</span>))&#123;
        <span class="hljs-comment">//å¦‚æœurlMatchersæœªæŒ‡å®š,åˆ™æ‰€æœ‰urléƒ½éœ€è¦æˆæƒåæ‰èƒ½è¢«è®¿é—®</span>
        http.authorizeRequests().anyRequest().authenticated();
    &#125;<span class="hljs-keyword">else</span>&#123;
        <span class="hljs-comment">//æ”¾è¡Œ urlMatchers ä¸­æŒ‡å®šçš„urlæ¡ç›®, æœªæŒ‡å®šçš„urlä»éœ€æˆæƒåæ‰èƒ½è®¿é—®</span>
        String[] split = urlMatchers.split(<span class="hljs-string">","</span>);
        http.authorizeRequests()
            <span class="hljs-comment">//ä¸‹è¾¹çš„è·¯å¾„æ”¾è¡Œ</span>
            .antMatchers(split).permitAll()
            .anyRequest().authenticated();
    &#125;
&#125;</code></pre></div>

<p>åœ¨ <code>appliaction.yml</code> ä¸­é…ç½® oauth2.urlMatchers</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">oauth2:</span>
  <span class="hljs-attr">urlMatchers:</span> <span class="hljs-string">/v2/api-docs,/swagger-resources/configuration/ui,/swagger-resources,/swagger-resources/configuration/security,/swagger-ui.html,/webjars/**,"/course/coursepic/get/*"</span></code></pre></div>

<p>è¯·æ±‚è¯·æ±‚åˆ°å¦‚ä¸‹è¿æ¥ï¼Œè¿›è¡Œ æŸ¥è¯¢è¯¾ç¨‹å›¾ç‰‡ä¿¡æ¯</p>
<p>GETï¼š<a href="http://localhost:50201/api/course/coursepic/list/4028e58161bd22e60161bd23672a0001" target="_blank" rel="noopener">http://localhost:50201/api/course/coursepic/list/4028e58161bd22e60161bd23672a0001</a></p>
<p>æµ‹è¯•ç»“æœå¦‚ä¸‹</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image28.png" srcset="/img/loading.gif" alt="image-20200531175205607"></p>
<h3 id="å®Œæ•´çš„è·¯ç”±é…ç½®"><a href="#å®Œæ•´çš„è·¯ç”±é…ç½®" class="headerlink" title="å®Œæ•´çš„è·¯ç”±é…ç½®"></a>å®Œæ•´çš„è·¯ç”±é…ç½®</h3><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">zuul:</span>
  <span class="hljs-attr">routes:</span>
    <span class="hljs-attr">xc-service-learning:</span> <span class="hljs-comment">#è·¯ç”±åç§°ï¼Œåç§°ä»»æ„ï¼Œä¿æŒæ‰€æœ‰è·¯ç”±åç§°å”¯ä¸€</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/learning/**</span>
      <span class="hljs-attr">serviceId:</span> <span class="hljs-string">xc-service-learning</span> <span class="hljs-comment">#æŒ‡å®šæœåŠ¡idï¼Œä»Eurekaä¸­æ‰¾åˆ°æœåŠ¡çš„ipå’Œç«¯å£</span>
      <span class="hljs-attr">strip-prefix:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">sensitiveHeaders:</span>
    <span class="hljs-attr">manage-course:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/course/**</span>
      <span class="hljs-attr">serviceId:</span> <span class="hljs-string">xc-service-manage-course</span>
      <span class="hljs-attr">strip-prefix:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">sensitiveHeaders:</span>
    <span class="hljs-attr">manage-cms:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/cms/**</span>
      <span class="hljs-attr">serviceId:</span> <span class="hljs-string">xc-service-manage-cms</span>
      <span class="hljs-attr">strip-prefix:</span> <span class="hljs-literal">false</span>
    	<span class="hljs-attr">sensitiveHeaders:</span>
    <span class="hljs-attr">manage-sys:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/sys/**</span>
      <span class="hljs-attr">serviceId:</span> <span class="hljs-string">xc-service-manage-cms</span>
      <span class="hljs-attr">strip-prefix:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">sensitiveHeaders:</span>
    <span class="hljs-attr">service-ucenter:</span>
    	<span class="hljs-attr">path:</span> <span class="hljs-string">/ucenter/**</span>
      <span class="hljs-attr">serviceId:</span> <span class="hljs-string">xc-service-ucenter</span>
      <span class="hljs-attr">sensitiveHeaders:</span>
      <span class="hljs-attr">strip-prefix:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">xc-service-manage-order:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/order/**</span>
      <span class="hljs-attr">serviceId:</span> <span class="hljs-string">xc-service-manage-order</span>
      <span class="hljs-attr">sensitiveHeaders:</span>
      <span class="hljs-attr">strip-prefix:</span> <span class="hljs-literal">false</span></code></pre></div>

<h2 id="5-è¿‡æ»¤å™¨"><a href="#5-è¿‡æ»¤å™¨" class="headerlink" title="5. è¿‡æ»¤å™¨"></a>5. è¿‡æ»¤å™¨</h2><p>Zuulçš„æ ¸å¿ƒå°±æ˜¯è¿‡è™‘å™¨ï¼Œé€šè¿‡è¿‡è™‘å™¨å®ç°è¯·æ±‚è¿‡è™‘ï¼Œèº«ä»½æ ¡éªŒç­‰</p>
<h3 id="é…ç½®ZuulFilter"><a href="#é…ç½®ZuulFilter" class="headerlink" title="é…ç½®ZuulFilter"></a>é…ç½®ZuulFilter</h3><p>è‡ªå®šä¹‰è¿‡è™‘å™¨éœ€è¦ç»§æ‰¿ <code>ZuulFilter</code>ï¼ŒZuulFilter æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œéœ€è¦è¦†ç›–å®ƒçš„å››ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<ul>
<li>shouldFilterï¼šè¿”å›ä¸€ä¸ª Boolean å€¼ï¼Œåˆ¤æ–­è¯¥è¿‡æ»¤å™¨æ˜¯å¦éœ€è¦æ‰§è¡Œã€‚è¿”å›trueè¡¨ç¤ºè¦æ‰§è¡Œæ­¤è¿‡è™‘å™¨ï¼Œå¦åˆ™ä¸æ‰§<br>è¡Œã€‚</li>
<li>runï¼šè¿‡æ»¤å™¨çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
<li>filterTypeï¼šè¿”å›å­—ç¬¦ä¸²ä»£è¡¨è¿‡æ»¤å™¨çš„ç±»å‹ï¼Œå¦‚ä¸‹<ul>
<li><code>pre</code>ï¼šè¯·æ±‚åœ¨è¢«è·¯ç”±ä¹‹å‰æ‰§è¡Œ</li>
<li><code>routing</code>ï¼šåœ¨è·¯ç”±è¯·æ±‚æ—¶è°ƒç”¨</li>
<li><code>post</code>ï¼šåœ¨ routing å’Œ errror è¿‡æ»¤å™¨ä¹‹åè°ƒç”¨</li>
<li><code>error</code>ï¼šå¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯è°ƒç”¨</li>
</ul>
</li>
<li>filterOrderï¼šæ­¤æ–¹æ³•è¿”å›æ•´å‹æ•°å€¼ï¼Œé€šè¿‡æ­¤æ•°å€¼æ¥å®šä¹‰è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
<h3 id="æµ‹è¯•-4"><a href="#æµ‹è¯•-4" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>è¿‡è™‘æ‰€æœ‰è¯·æ±‚ï¼Œåˆ¤æ–­å¤´éƒ¨ä¿¡æ¯æ˜¯å¦æœ‰ <code>Authorization</code>ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‹’ç»è®¿é—®ï¼Œå¦åˆ™è½¬å‘åˆ°å¾®æœåŠ¡ã€‚</p>
<p>å®šä¹‰è¿‡è™‘å™¨ï¼Œä½¿ç”¨ <code>@Component</code> æ ‡è¯†ä¸º beanã€‚</p>
<p>åœ¨ç½‘å…³å·¥ç¨‹ä¸‹æ„å»ºä¸€ä¸ª <code>filter</code> åŒ…ï¼Œåˆ›å»ºä¸€ä¸ª LoginFilterTest å¹¶ç»§æ‰¿äº <code>ZuulFilter</code></p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginFilterTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ZuulFilter</span> </span>&#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOG = LoggerFactory.getLogger(LoginFilterTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">filterType</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"pre"</span>;
    &#125;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">filterOrder</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<span class="hljs-comment">//intå€¼æ¥å®šä¹‰è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span>
    &#125;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">shouldFilter</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-comment">// è¯¥è¿‡æ»¤å™¨éœ€è¦æ‰§è¡Œ</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;
        RequestContext requestContext = RequestContext.getCurrentContext();
        HttpServletResponse response = requestContext.getResponse();         <span class="hljs-comment">//è·å–å“åº”å¯¹è±¡</span>
        HttpServletRequest request = requestContext.getRequest();           <span class="hljs-comment">//è·å–è¯·æ±‚å¯¹è±¡</span>
        <span class="hljs-comment">//å–å‡ºå¤´éƒ¨ä¿¡æ¯Authorization</span>
        String authorization = request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-comment">//åˆ¤æ–­ç”¨æˆ·çš„è¯·æ±‚ä¸­æ˜¯å¦å¸¦æœ‰ Authorization å­—æ®µ,å¦‚æœæ²¡æœ‰åˆ™è¡¨ç¤ºæœªè®¤è¯ç”¨æˆ·</span>
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(authorization))&#123;
            requestContext.setSendZuulResponse(<span class="hljs-keyword">false</span>);<span class="hljs-comment">// æ‹’ç»è®¿é—®</span>
            requestContext.setResponseStatusCode(<span class="hljs-number">200</span>);<span class="hljs-comment">// è®¾ç½®å“åº”çŠ¶æ€ç </span>
            ResponseResult unauthenticated = <span class="hljs-keyword">new</span> ResponseResult(CommonCode.UNAUTHENTICATED);
            String jsonString = JSON.toJSONString(unauthenticated);
            requestContext.setResponseBody(jsonString);
            requestContext.getResponse().setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;
&#125;</code></pre></div>

<p>æµ‹è¯•è¯·æ±‚ï¼š</p>
<p><a href="http://localhost:50201/api/course/coursebase/get/4028e581617f945f01617f9dabc40000" target="_blank" rel="noopener">http://localhost:50201/api/course/coursebase/get/4028e581617f945f01617f9dabc40000</a> æŸ¥è¯¢è¯¾ç¨‹ä¿¡æ¯</p>
<p>1ã€Header ä¸­ä¸è®¾ç½® Authorization</p>
<p>å“åº”ç»“æœï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image29.png" srcset="/img/loading.gif" alt="image-20200531184006794"></p>
<p>2ã€Header ä¸­è®¾ç½® <code>Authorization</code></p>
<p>æˆåŠŸå“åº”è¯¾ç¨‹ä¿¡æ¯ã€‚</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image30.png" srcset="/img/loading.gif" alt="image-20200531183942639"></p>
<h1 id="äº”ã€èº«ä»½æ ¡éªŒ"><a href="#äº”ã€èº«ä»½æ ¡éªŒ" class="headerlink" title="äº”ã€èº«ä»½æ ¡éªŒ"></a>äº”ã€èº«ä»½æ ¡éªŒ</h1><h2 id="1-éœ€æ±‚åˆ†æ-3"><a href="#1-éœ€æ±‚åˆ†æ-3" class="headerlink" title="1. éœ€æ±‚åˆ†æ"></a>1. éœ€æ±‚åˆ†æ</h2><p>æœ¬å°èŠ‚å®ç°ç½‘å…³è¿æ¥ <code>Redis</code> æ ¡éªŒä»¤ç‰Œï¼š</p>
<p>1ã€ä» <code>cookie</code> æŸ¥è¯¢ç”¨æˆ·èº«ä»½ä»¤ç‰Œæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ‹’ç»è®¿é—®</p>
<p>2ã€ä» <code>http header</code> æŸ¥è¯¢jwtä»¤ç‰Œæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ‹’ç»è®¿é—®</p>
<p>3ã€ä» <code>Redis</code> æŸ¥è¯¢ <code>user_token</code> ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œè¿‡æœŸåˆ™æ‹’ç»è®¿é—®</p>
<h2 id="2-ä¸šåŠ¡å®ç°"><a href="#2-ä¸šåŠ¡å®ç°" class="headerlink" title="2. ä¸šåŠ¡å®ç°"></a>2. ä¸šåŠ¡å®ç°</h2><p>1ã€é…ç½® application.yml</p>
<p>é…ç½® redisé“¾æ¥å‚æ•°ï¼š</p>
<div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">xcâ€governâ€gateway</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">$&#123;REDIS_HOST:127.0.0.1&#125;</span>
    <span class="hljs-attr">port:</span> <span class="hljs-string">$&#123;REDIS_PORT:6379&#125;</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">5000</span> <span class="hljs-comment">#è¿æ¥è¶…æ—¶ æ¯«ç§’</span>
    <span class="hljs-attr">jedis:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">maxActive:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">maxIdle:</span> <span class="hljs-number">3</span>
        <span class="hljs-attr">minIdle:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">maxWait:</span> <span class="hljs-string">â€1</span>  <span class="hljs-comment">#è¿æ¥æ± æœ€å¤§ç­‰è¡Œæ—¶é—´ â€1æ²¡æœ‰é™åˆ¶</span></code></pre></div>

<p>2ã€ä½¿ç”¨ StringRedisTemplate æŸ¥è¯¢ <code>key</code> çš„æœ‰æ•ˆæœŸ</p>
<p>åœ¨ <code>service</code> åŒ…ä¸‹å®šä¹‰ <code>AuthService</code> ç±»ï¼š</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthService</span> </span>&#123;
    <span class="hljs-meta">@Autowired</span>
    StringRedisTemplate stringRedisTemplate;
    <span class="hljs-comment">//æŸ¥è¯¢èº«ä»½ä»¤ç‰Œ</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getTokenFromCookie</span><span class="hljs-params">(HttpServletRequest request)</span></span>&#123;
        Map&lt;String, String&gt; cookieMap = CookieUtil.readCookie(request, <span class="hljs-string">"uid"</span>);
        String access_token = cookieMap.get(<span class="hljs-string">"uid"</span>);
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(access_token))&#123;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125; 
        <span class="hljs-keyword">return</span> access_token;
    &#125; 
    <span class="hljs-comment">//ä»headerä¸­æŸ¥è¯¢jwtä»¤ç‰Œ</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getJwtFromHeader</span><span class="hljs-params">(HttpServletRequest request)</span></span>&#123;
        String authorization = request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(authorization))&#123;
            <span class="hljs-comment">//æ‹’ç»è®¿é—®</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125;
        <span class="hljs-keyword">if</span>(!authorization.startsWith(<span class="hljs-string">"Bearer "</span>))&#123;
            <span class="hljs-comment">//æ‹’ç»è®¿é—®</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
        &#125; 
        <span class="hljs-keyword">return</span> authorization;
    &#125; 
    <span class="hljs-comment">//æŸ¥è¯¢ä»¤ç‰Œçš„æœ‰æ•ˆæœŸ</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getExpire</span><span class="hljs-params">(String access_token)</span> </span>&#123;
        <span class="hljs-comment">//tokenåœ¨redisä¸­çš„key</span>
        String key = <span class="hljs-string">"user_token:"</span>+access_token;
        Long expire = stringRedisTemplate.getExpire(key);
        <span class="hljs-keyword">return</span> expire;
    &#125;
&#125;</code></pre></div>

<p>3ã€å®šä¹‰LoginFilter</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span>
<span class="hljs-comment"> * èº«ä»½æ ¡éªŒå™¨</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mr.JK</span>
<span class="hljs-comment"> * <span class="hljs-doctag">@create</span> 2020-08-28  13:14</span>
<span class="hljs-comment"> */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ZuulFilter</span> </span>&#123;

    <span class="hljs-meta">@Autowired</span>
    AuthService authService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">filterType</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-string">"pre"</span>;
    &#125;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">filterOrder</span><span class="hljs-params">()</span> </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<span class="hljs-comment">//intå€¼æ¥å®šä¹‰è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span>
    &#125;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">shouldFilter</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-comment">// è¯¥è¿‡æ»¤å™¨éœ€è¦æ‰§è¡Œ</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    &#125;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ZuulException </span>&#123;
        RequestContext requestContext = RequestContext.getCurrentContext();
        HttpServletResponse response = requestContext.getResponse();         <span class="hljs-comment">//è·å–å“åº”å¯¹è±¡</span>
        HttpServletRequest request = requestContext.getRequest();           <span class="hljs-comment">//è·å–è¯·æ±‚å¯¹è±¡</span>
        <span class="hljs-comment">//å–cookieä¸­çš„èº«ä»½ä»¤ç‰Œ</span>
        String tokenFromCookie = authService.getTokenFromCookie(request);
        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(tokenFromCookie))&#123;
            <span class="hljs-comment">//æ‹’ç»è®¿é—®</span>
            <span class="hljs-keyword">this</span>.access_denied();
        &#125;
        <span class="hljs-comment">//ä»headerä¸­å–jwt</span>
        String jwtFromHeader = authService.getJwtFromHeader(request);
        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jwtFromHeader))&#123;
            <span class="hljs-comment">//æ‹’ç»è®¿é—®</span>
            <span class="hljs-keyword">this</span>.access_denied();
        &#125;
        <span class="hljs-comment">//ä»rediså–å‡ºjwtçš„è¿‡æœŸæ—¶é—´</span>
        <span class="hljs-keyword">long</span> expire = authService.getExpire(tokenFromCookie);
        <span class="hljs-keyword">if</span> (expire &lt; <span class="hljs-number">0</span>)&#123;
            <span class="hljs-comment">//æ‹’ç»è®¿é—®</span>
            <span class="hljs-keyword">this</span>.access_denied();
        &#125;


        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
    &#125;

    <span class="hljs-comment">//æ‹’ç»è®¿é—®</span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">access_denied</span><span class="hljs-params">()</span></span>&#123;
        RequestContext requestContext = RequestContext.getCurrentContext();

        requestContext.setSendZuulResponse(<span class="hljs-keyword">false</span>);<span class="hljs-comment">// æ‹’ç»è®¿é—®</span>
        requestContext.setResponseStatusCode(<span class="hljs-number">200</span>);<span class="hljs-comment">// è®¾ç½®å“åº”çŠ¶æ€ç </span>
        ResponseResult unauthenticated = <span class="hljs-keyword">new</span> ResponseResult(CommonCode.UNAUTHENTICATED);
        String jsonString = JSON.toJSONString(unauthenticated);
        requestContext.setResponseBody(jsonString);
        requestContext.getResponse().setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);
    &#125;
&#125;</code></pre></div>



<h2 id="3-æµ‹è¯•"><a href="#3-æµ‹è¯•" class="headerlink" title="3. æµ‹è¯•"></a>3. æµ‹è¯•</h2><p>1ã€é…ç½®ä»£ç†</p>
<p>é€šè¿‡ <code>nginx</code> è½¬å‘åˆ° <code>gateway</code>ï¼Œåœ¨ <a href="http://www.xuecheng.com/" target="_blank" rel="noopener">www.xuecheng.com</a> è™šæ‹Ÿä¸»æœºæ¥é…ç½®</p>
<div class="hljs"><pre><code class="hljs c">#å¾®æœåŠ¡ç½‘å…³
upstream api_server_pool&#123;
	server <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">50201</span> weight=<span class="hljs-number">10</span>;
&#125; 
#å¾®æœåŠ¡ç½‘å…³
location /api &#123;
	proxy_pass http:<span class="hljs-comment">//api_server_pool;</span>
&#125;</code></pre></div>

<p>ä½¿ç”¨ <code>postman</code> æµ‹è¯•ï¼š</p>
<p>GET è¯·æ±‚ï¼š<a href="http://www.xuecheng.com/api/course/coursepic/get/4028e581617f945f01617f9dabc40000" target="_blank" rel="noopener">http://www.xuecheng.com/api/course/coursepic/get/4028e581617f945f01617f9dabc40000</a></p>
<p>æ³¨æ„ï¼šè¿™é‡Œé€šè¿‡ç½‘å…³è¯·æ±‚äº† <code>course/coursepic/get</code> åœ°å€ï¼Œè¯¾ç¨‹ç®¡ç† <code>url</code> æ ¹æ®è‡ªå·±çš„å¼€å‘æƒ…å†µå»é…ç½®æ”¾è¡Œã€‚</p>
<h3 id="æ­£å¸¸æµç¨‹æµ‹è¯•"><a href="#æ­£å¸¸æµç¨‹æµ‹è¯•" class="headerlink" title="æ­£å¸¸æµç¨‹æµ‹è¯•"></a>æ­£å¸¸æµç¨‹æµ‹è¯•</h3><p>1ã€æ‰§è¡Œç™»å½•ä½¿ä¹‹å‘ <code>cookie</code> å†™å…¥èº«ä»½ä»¤ç‰Œ <code>uid</code></p>
<p>Postè¯·æ±‚ï¼š<a href="http://ucenter.xuecheng.com/openapi/auth/userlogin" target="_blank" rel="noopener">http://ucenter.xuecheng.com/openapi/auth/userlogin</a></p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image31.png" srcset="/img/loading.gif" alt="image-20200531190540813"></p>
<p>å¹¶ä»redisè·å–jwtä»¤ç‰Œçš„å†…å®¹</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image32.png" srcset="/img/loading.gif" alt="image-20200531182147472"></p>
<p>2ã€æ‰‹åŠ¨åœ¨postmanæ·»åŠ header</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image33.png" srcset="/img/loading.gif" alt="image-20200531201049165"></p>
<p>æˆåŠŸæŸ¥è¯¢ï¼š</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image34.png" srcset="/img/loading.gif" alt="image-20200531201107131"></p>
<blockquote>
<p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¿™é‡Œå‡ºç° tokenéªŒè¯å¤±è´¥ï¼Œé‚£å°±æ˜¯ä½ çš„è¯¾ç¨‹ç®¡ç†ç®¡ç†æœåŠ¡çš„ resources ä¸‹çš„å…¬é’¥æ–‡ä»¶äºè®¤è¯æœåŠ¡çš„ç§é’¥ä¸åŒ¹é…</p>
</blockquote>
<h3 id="å¼‚å¸¸æµç¨‹æµ‹è¯•"><a href="#å¼‚å¸¸æµç¨‹æµ‹è¯•" class="headerlink" title="å¼‚å¸¸æµç¨‹æµ‹è¯•"></a>å¼‚å¸¸æµç¨‹æµ‹è¯•</h3><p>æ‰‹åŠ¨åˆ é™¤ <code>header</code> æˆ–æ¸…é™¤ <code>cookie</code> è§‚å¯Ÿæµ‹è¯•ç»“æœã€‚</p>
<p><img src="/2020/08/25/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday17/image35.png" srcset="/img/loading.gif" alt="image-20200531201145872"></p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF/">å­¦æˆåœ¨çº¿</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Spring-Security/">Spring Security</a>
                    
                      <a class="hover-with-bg" href="/tags/Oauth2/">Oauth2</a>
                    
                      <a class="hover-with-bg" href="/tags/Zuul/">Zuul</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/08/28/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday18/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">å­¦æˆåœ¨çº¿day18ï¼šåŸºäºoauth2å®ç°RBACè®¤è¯æˆæƒã€å¾®æœåŠ¡é—´è®¤è¯å®ç°</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/08/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BFday16/">
                        <span class="hidden-mobile">å­¦æˆåœ¨çº¿day16ï¼šåŸºäºSpring Security Oauth2å¼€å‘è®¤è¯æœåŠ¡</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>
<!--

ä»£ç å—js ç”¨ä¸åˆ°ï¼Œfulidè‡ªå¸¦æœ‰ï¼Œæ·»åŠ cssæ ·å¼å³å¯å®ç°
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 

<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

-->




<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">å…³é”®å­—</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
	<div>
  <span id="timeDate">è½½å…¥å¤©æ•°...</span>
  <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span>
  <script>
  var now = new Date();
  function createtime(){
      var grt= new Date("06/20/2020 00:00:00");//æ­¤å¤„ä¿®æ”¹ä½ çš„å»ºç«™æ—¶é—´æˆ–è€…ç½‘ç«™ä¸Šçº¿æ—¶é—´
      now.setTime(now.getTime()+250);
      days = (now - grt ) / 1000 / 60 / 60 / 24;
      dnum = Math.floor(days);
      hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum);
      hnum = Math.floor(hours);
      if(String(hnum).length ==1 ){
          hnum = "0" + hnum;
      }
      minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
      mnum = Math.floor(minutes);
      if(String(mnum).length ==1 ){
                mnum = "0" + mnum;
      }
      seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
      snum = Math.round(seconds);
      if(String(snum).length ==1 ){
                snum = "0" + snum;
      }
      document.getElementById("timeDate").innerHTML = "æœ¬ç«™å‹‰å¼ºè¿è¡Œ&nbsp"+dnum+"&nbspå¤©";
      document.getElementById("times").innerHTML = hnum + "&nbspå°æ—¶&nbsp" + mnum + "&nbspåˆ†&nbsp" + snum + "&nbspç§’";
  }
  setInterval("createtime()",250);
  </script>
</div>
    
  <div class="statistics">
    
    

    
      
        <!-- ä¸è’œå­ç»Ÿè®¡PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            æ€»è®¿é—®é‡ 
            <span id="busuanzi_value_site_pv"></span>
             æ¬¡
          </span>
      
      
        <!-- ä¸è’œå­ç»Ÿè®¡UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            æ€»è®¿å®¢æ•° 
            <span id="busuanzi_value_site_uv"></span>
             äºº
          </span>
      
    
  </div>


    
  <!-- å¤‡æ¡ˆä¿¡æ¯ -->
  <div class="beian">
    <a href="http://beian.miit.gov.cn/" target="_blank"
       rel="nofollow noopener">äº¬ICPè¯20000725å·</a>
    
      <a
        href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=20000725"
        rel="nofollow noopener"
        class="beian-police"
        target="_blank"
      >
        <span class="beian-police-sep">&nbsp;|&nbsp;</span>
        
          <img src="/img/police_beian.png" srcset="/img/loading.gif" alt="police-icon" />
        
        <span>äº¬å…¬ç½‘å®‰å¤‡20000725å·</span>
      </a>
     
  </div>


    
	
  </div>
  

</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>



  
<script src="/js/custom.js"></script>




  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: 'article.markdown-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "å­¦æˆåœ¨çº¿day17ï¼šåŸºäºZuulç½‘å…³å®ç°è·¯ç”±è½¬å‘ã€è¿‡æ»¤å™¨&nbsp;",
      ],
      cursorChar: "|",
      typeSpeed: 65,
      loop: true,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
      icon: "<"
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  
















<script type="text/javascript"
color="107,160,220" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
